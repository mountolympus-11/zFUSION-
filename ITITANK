ITITANK  TITLE '- PREPARE ROW / COL DATA FOR TRANSMISSION'              00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: ITITANK - PREPARE COLUMN DATA FOR TRANSMISSION               00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THIS ROUTINE FORMATS A TABLE ROW FOR TRANSMISSION TO COOP.         00080000
*    THE CALLER PROVIDES THE ADDRESS OF A ROW IN SOURCE FORMAT,         00090000
*    A TIB CONTAINING A TABLE DESCRIPTION (TBDESC OUTPUT AREA),         00100000
*    AND A COLUMN MASK, WHERE THE NTH BIT OF THE MASK CORRESPONDS       00110000
*    TO THE NTH COLUMN ENTRY DESCRIBED.                                 00120000
*                                                                       00130000
*                                                                       00140000
* ON ENTRY:                                                             00150000
*                                                                       00160000
*    R1 POINTS TO A PARAMETER LIST OF THE FORMAT DESCRIBED BY           00170000
*       THE @TITANK REQUEST BLOCK MAP                                   00180000
*                                                                       00190000
*                                                                       00200000
* ON EXIT:                                                              00210000
*                                                                       00220000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES                     00230000
*                                                                       00240000
*           RC00 - ROW ACCEPTED                                         00250000
*           RC04 - RETURN AREA SPACE EXHAUSTED                          00260000
*           RC08 - SERVICE ROUTINE FAILURE                              00270000
*                                                                       00280000
*    R1  CONTAINS THE SIZE OF THE RESPONSE AREA CONSUMED BY             00290000
*        THE REFORMATTED SOURCE ROW                                     00300000
*                                                                       00310000
**<DOC-OFF>****************************************************         00320000
                                                                        00330000
         EJECT                                                          00340000
***************************************************************         00350000
*                                                                       00360000
* MAINTENANCE:                                                          00370000
*                                                                       00380000
*   08/XX/92  R. TURGEON                                                00390000
*             INITIAL VERSION                                           00400000
*                                                                       00410000
*   08/05/93  RON COLMONE                                               00420000
*             CONVERTED TO STDENV                                       00430000
*                                                                       00440000
*   08/03/94  R. TURGEON          PAR#  135096                   135096 00450000
*             ACCEPT VERSION 1 TIREAD PLIST EXTENDING THE        135096 00460000
*             NUMBER OF TABLE COLUMNS FROM 64 TO 512.            135096 00470000
*                                                                       00480000
*   08/13/94  R. TURGEON          PAR#  137148                   137148 00490000
*             RETURN DITTO INDICATOR RATHER THAN COLUMN VALUE    137148 00500000
*             WHEN THE VALUE OF A COLUMN IS THE SAME AS THAT IN  137148 00510000
*             THE IMMEDIATELY PRECEEDING ROW.                    137148 00520000
*                                                                       00530000
*   10/12/94  R. TURGEON                                                00540000
*             OPTIONALLY, ALLOW TXP BUFFER EXPANSION UNDER              00550000
*             CONTROL OF @TITANK.TITXPAND                               00560000
*                                                                       00570000
*   02/25/95  R. TURGEON          ODBC                                  00580000
*             IMPLEMENT NULL COLUMNS                                    00590000
*                                                                       00600000
*   07/20/95  R. TURGEON          PAR# 200946                    200946 00610000
*             ENSURE THAT AT LEAST ONE, POSSIBLY NULL, COLUMN    200946 00620000
*             ENTRY IS RETURNED FOR EVERY ROW RETRIEVED.         200946 00630000
*                                                                       00640000
***************************************************************         00650000
                                                                        00660000
         EJECT                                                          00670000
         #WORK LENGTH=512    READ / WRITE WORKAREA                      00680000
                                                                        00690000
BYTE     DS    X             SINGLE BYTE WORKAREA                137148 00700000
$DATATYP DS    X             COL TYPE: 0-CHAR, /0-NONCHAR        137148 00710000
$FORMAT  DS    X             COL FORM: 0-FIX, 4-VAR, 8-VARX      137148 00720000
$CFLAGS  DS    X             COL FLAGS IN TIRDRET.TIRDCFLG FORM  137148 00730000
                                                                        00740000
PLISTVER DS    X             IMAGE OF TIREAD PLIST VERSION ID           00750000
                                                                        00760000
COLMASK  DS    A             ADDRESS OF COLUMN SELECTION MASK    135096 00770000
COLCOUNT DS    F             COLUMN COUNT (# SET BITS IN MASK)   135096 00780000
                                                                        00790000
#COLS    DS    F             TOTAL NUMBER OF COLS IN SOURCE TABLE       00800000
COLID    DS    F             ID (INDEX) OF CURRENT COLUMN               00810000
ROWORG   DS    A             SOURCE ROW ORIGIN                          00820000
BUFRUSED DS    F             AMOUNT OF RESPONSE BUFFER CONSUMED         00830000
                                                                        00840000
XCOLPOS  DS    A             NXTCOL RTN - CURRENT COLMASK POS    135096 00850000
XNULPOS  DS    A             NXTCOL RTN - CURRENT NULLIND POS           00860000
XCOLBIT  DS    X             NXTCOL RTN - CURRENT COLMASK/NULLIND BIT   00870000
                                                                        00880000
REGSAVE  DS    16F           LOCAL REGISTER SAVEAREA                    00890000
                                                                        00900000
         #ENDWORK ,                                                     00910000
                                                                        00920000
         EJECT ,                                                 137148 00930000
         @TITANK ,           REQUEST BLOCK FORMAT                137148 00940000
                                                                        00950000
         EJECT                                                          00960000
         TIBLOCK ,           TABLE INTERFACE BLOCK          (TIB)       00970000
                                                                        00980000
         EJECT                                                          00990000
         @TBFMT ,            TABLE DESCRIPTION (TBDESC RESULT)          01000000
                                                                        01010000
         EJECT                                                          01020000
         TIRDRET ,           MULTIROW READ RETURN AREA                  01030000
                                                                        01040000
         EJECT                                                          01050000
         @TBCOLDF            COLUMN DEFINITION FORMAT                   01060000
                                                                        01070000
         EJECT                                                          01080000
         EQUS  ,             GENERAL EQUATES                            01090000
                                                                        01100000
         EJECT                                                          01110000
ITITANK  #ENTER BASE=R12,WAPASS=YES,PREG=R9                      135096 01120000
                                                                        01130000
         USING ITASK,R10          STDENV                                01140000
                                                                        01150000
         EJECT                                                          01160000
***************************************************************         01170000
*                                                                       01180000
*   FETCH PASSED PARAMETERS                                             01190000
*                                                                       01200000
***************************************************************         01210000
                                                                        01220000
         USING TITANK,R9          REQUEST BLOCK FORMAT           137148 01230000
         L     R5,TITIB           TIB                            137148 01240000
         USING TIBLOCK,R5                                        137148 01250000
                                                                        01260000
         MVC   PLISTVER,TITVER+3  EXTRACT REQUESTER VERSION ID          01270000
         MVC   ROWORG,TITROW      CURRENT ROW ORIGIN             137148 01280000
         MVC   COLMASK,TITCMASK   ORIGIN OF COLUMN MASK          137148 01290000
         MVC   COLCOUNT,TITCOLS   # COLUMNS SELECTED IN MASK     137148 01300000
                                                                        01310000
***************************************************************         01320000
*                                                                       01330000
*   PROCESS ALL COLUMNS SELECTED VIA COLUMN MASK                        01340000
*                                                                       01350000
***************************************************************         01360000
                                                                        01370000
         L     R4,TIBDESC         LOCATE TABLE FORMAT DESCRIPTION       01380000
         USING TBFMT,R4           DESCRIPTION PREFIX                    01390000
         LH    R0,TBF#COLS        NUMBER OF COLUMNS TO CHOOSE           01400000
         ST    R0,#COLS           SAVE AS FULLWORD (COMPATIBILITY)      01410000
                                                                        01420000
         L     R4,TBFCOFF         LOCATE FIRST COLUMN DESCRIPTION       01430000
         USING TBCOLDEF,R4        COLDESC FORMAT                        01440000
         SR    R6,R6              INITIALIZE CURRENT COLUMN IDENTIFIER  01450000
                                                                        01460000
*--------------------------------------------------------------         01470000
*   DETERMINE WHETHER COLUMN IS SELECTED                                01480000
*--------------------------------------------------------------         01490000
                                                                        01500000
COL_SCAN DS    0H                 SCAN FOR COLUMN                       01510000
         C     R6,#COLS           LAST DEFINED COLUMN PROCESSED?        01520000
         BNL   COMPLETE           COMPLETED IF SO                       01530000
         ST    R6,COLID           ESTABLISH CURRENT COLUMN ID           01540000
                                                                        01550000
         BAS   R14,NXTCOL         DETERMINE WHETHER NEXT COL SELECTED   01560000
                                                                        01570000
         BP    COL_SKIP           COLUMN NOT SELECTED                   01580000
         LA    R0,RSN04           ASSUME SELECTED COLUMN NOT NULLED     01590000
         BZ    COL_SEL                                                  01600000
         LA    R0,RSN00           SELECTED COLUMN NULLED                01610000
                                                                        01620000
*--------------------------------------------------------------         01630000
*   CONVERT SELECTED COLUMN NULL OR VALUE TO TRANSMISSION FMT           01640000
*--------------------------------------------------------------         01650000
                                                                        01660000
COL_SEL  DS    0H                 R0 <== NULL / NOT NULL QUALIFIER      01670000
         BAS   R14,SELECT         CURRENT COLUMN SELECTED               01680000
                                                                        01690000
         B     *+4(R15)           TEST COMPLETION STATUS                01700000
         B     COL_NEXT           COLUMN ACCEPTED WITHOUT ERROR         01710000
         B     NOSPACE            RETURN AREA IS FULL                   01720000
         B     FAILURE            FAILURE                               01730000
                                                                        01740000
COL_NEXT DS    0H                                                       01750000
         L     R0,BUFRUSED        RESPONSE BUFFER SPACE CONSUMED        01760000
         AR    R0,R1              ACCOUNT FOR THIS ENTRY                01770000
         ST    R0,BUFRUSED        SAVE UPDATED VALUE                    01780000
                                                                        01790000
*--------------------------------------------------------------         01800000
*   ADVANCE TO NEXT COLUMN DEFINITION                                   01810000
*--------------------------------------------------------------         01820000
                                                                        01830000
COL_SKIP DS    0H                                                       01840000
         LA    R4,TBCOLEND        ELSE ADVANCE TO NEXT COLDEF           01850000
         LA    R6,1(,R6)          INCR COLUMN IDENTIFER                 01860000
         B     COL_SCAN           ROW PROCESSING COMPLETED              01870000
                                                                        01880000
         EJECT                                                          01890000
***************************************************************  200946 01900000
*                                                                200946 01910000
*   IF THE ENTIRE ROW CONTAINED BLANKS/NULLS AS INDICATED BY     200946 01920000
*   BUFRUSED = 0, INSERT A NULL COLUMN ENTRY TO SERVE AS A       200946 01930000
*   PLACEHOLDER FOR THE ROW.                                     200946 01940000
*                                                                200946 01950000
***************************************************************  200946 01960000
                                                                        01970000
COMPLETE DS    0H                 ROW FORMATTED FOR RETURN       200946 01980000
         ICM   R0,15,BUFRUSED     COLUMN ENTRIES ADDED?          200946 01990000
         BNZ   COMEXIT            DONE HERE IF SO                200946 02000000
                                                                        02010000
         LA    R2,TIRDCLN         LENGTH OF ROW PLACEHOLDER      200946 02020000
         ICM   R0,15,TITXPAND     TXP BUFFER EXPANSION ALLOWED?  200946 02030000
         BNZ   COMXPYES           SKIP IF SO                     200946 02040000
                                                                        02050000
COMXPNO  DS    0H                                                200946 02060000
         $XPBUFR ISRT,            ALLOC RESPONSE BUFFER SLOT     200946X02070000
               DATA=0,            WILL FORMAT IN AREA RETURNED   200946X02080000
               DATALEN=(R2),      COLUMN HEADER PLUST DATA AREA  200946X02090000
               MF=(E,MFE_LIST)                                   200946 02100000
         B     COMXPCMN                                          200946 02110000
                                                                        02120000
COMXPYES DS    0H                                                200946 02130000
         $XPBUFR ISRT,            ALLOC RESPONSE BUFFER SLOT     200946X02140000
               DATA=0,            WILL FORMAT IN AREA RETURNED   200946X02150000
               DATALEN=(R2),      COLUMN HEADER PLUST DATA AREA  200946X02160000
               EXPAND=YES,        EXPAND TXP BUFFER IF NECESSARY 200946X02170000
               MF=(E,MFE_LIST)                                   200946 02180000
                                                                        02190000
COMXPCMN DS    0H                                                200946 02200000
         CH    R15,=AL2(RC04)     STORAGE RETURNED APPROPRIATELY?200946 02210000
         BL    COMFIN             STORAGE ALLOCATED AND ZEROED   200946 02220000
         BE    NOSPACE            INSUFFICIENT SPACE             200946 02230000
         B     FAILURE            DONE                           200946 02240000
                                                                        02250000
COMFIN   DS    0H                                                200946 02260000
         ST    R2,BUFRUSED        SAVE UPDATED VALUE             200946 02270000
                                                                        02280000
COMEXIT  DS    0H                                                200946 02290000
                                                                        02300000
         EJECT                                                          02310000
***************************************************************         02320000
*                                                                       02330000
*   POST COMPLETION STATUS AND RETURN TO CALLER                         02340000
*                                                                       02350000
***************************************************************         02360000
                                                                        02370000
         SR    R0,R0              REASON CODES NOT DEFINED              02380000
         LA    R15,RC00           SUCCESS                               02390000
         B     EXIT               DONE                                  02400000
                                                                        02410000
FAILURE  DS    0H                 SERVICE FAILURE                       02420000
         SR    R0,R0              REASON CODES NOT DEFINED              02430000
         LA    R15,RC08           UGLY ERROR                            02440000
         B     EXIT                                                     02450000
                                                                        02460000
*--------------------------------------------------------------         02470000
*   TXP BUFFER SPACE EXHAUSTED - RETRACT PARTIALS FROM TXP BUFR         02480000
*--------------------------------------------------------------         02490000
                                                                        02500000
NOSPACE  DS    0H                 RETURN AREA SPACE EXHAUSTED           02510000
         $XPBUFR RETRACT,                                              X02520000
               DATALEN=*BUFRUSED,                                      X02530000
               MF=(E,MFE_LIST)                                          02540000
                                                                        02550000
         SR    R0,R0              REASON CODES NOT DEFINED              02560000
         ST    R0,BUFRUSED        SPACE RELEASE                         02570000
                                                                        02580000
         LA    R15,RC04           INDICATE OVERFLOW                     02590000
         B     EXIT                                                     02600000
                                                                        02610000
*--------------------------------------------------------------         02620000
*   RETURN BUFFER CONSUMPTION VALUE TO REQUESTER                        02630000
*--------------------------------------------------------------         02640000
                                                                        02650000
EXIT     DS    0H                                                       02660000
         L     R1,BUFRUSED        AMOUNT OF TXP BUFFER CONSUMED         02670000
                                                                        02680000
         #EXIT ,                  RETURN                                02690000
                                                                        02700000
         EJECT                                                   135096 02710000
***************************************************************  135096 02720000
*                                                                135096 02730000
* ROUTINE: NXTCOL - IDENTIFY COLUMNS ELIGIBLE FOR RETURN         135096 02740000
*                                                                135096 02750000
* DESCRIPTION:                                                   135096 02760000
*                                                                135096 02770000
*    THE CURRENT BIT POSITION IN THE COLUMN SELECTION MASK IS    135096 02780000
*    TESTED TO DETERMINE WHETHER THE COLUMN HAS BEEN SELECTED           02790000
*    FOR RETURN.  IF SO, THE NULL INDICATOR MASK, IF PROVIDED,          02800000
*    IS TESTED TO DETERMINE WHETHER THE COLUMN HAS BEEN NULLED.         02810000
*                                                                       02820000
*    EACH CALL ADVANCES CURRENT POSITION BY ONE COLUMN IN BOTH          02830000
*    THE COLUMN SELECTION AND NULL INDICATOR MASKS.                     02840000
*                                                                135096 02850000
*                                                                135096 02860000
* NOTES:                                                         135096 02870000
*                                                                135096 02880000
*    THIS ROUTINE MAINTAINS CURRENT POSITION IN THE SELECTED            02890000
*    COLUMN MASK IN XCOLPOS AND THE NULL INDICATOR MASK IN              02900000
*    XNULPOS.  XCOLBIT IDENTIFIES THE CURRENT BIT POSITION IN           02910000
*    BOTH MASKS.                                                        02920000
*                                                                135096 02930000
*                                                                135096 02940000
* ON ENTRY:                                                             02950000
*                                                                       02960000
*    COLMASK  - ORIGIN OF COLUMN SELECTION BIT MASK                     02970000
*    COLCOUNT - NUMBER OF COLUMNS SELETED IN SELECTION MASK             02980000
*    TITNULLS - ORIGIN OF NULL INDICATOR BIT MASK OR ZERO               02990000
*                                                                       03000000
*                                                                       03010000
* ON EXIT:                                                              03020000
*                                                                       03030000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES AND THE             03040000
*        CONDITION CODE IS SET ACCORDINGLY                              03050000
*                                                                       03060000
*          -RC04 - COLUMN SELECTED BUT IS NULL                          03070000
*           RC00 - COLUMN SELECTED                                      03080000
*           RC04 - COLUMN NOT SELECTED                                  03090000
*                                                                       03100000
***************************************************************         03110000
                                                                        03120000
NXTCOL   DS    0H                                                135096 03130000
         STM   R0,R15,REGSAVE     SAVE MAINLINE REGS             135096 03140000
                                                                        03150000
*--------------------------------------------------------------         03160000
*   INIT SELECTION MASK / NULL INDICATOR MASK ON FIRST CALL             03170000
*--------------------------------------------------------------         03180000
                                                                        03190000
         L     R4,XNULPOS         CURR POS IN NULL INDICATOR MASK       03200000
         ICM   R2,15,XCOLPOS      LOCATE CURR POSITION IN MASK   135096 03210000
         BNZ   NXBYTE             SCAN PREVIOUSLY INITIALIZED    135096 03220000
                                                                        03230000
         L     R2,COLMASK         ORIGIN OF COLMASK              135096 03240000
         BCTR  R2,0               INIT SCAN AT ORIGIN - 1        135096 03250000
         ST    R2,XCOLPOS         SAVE INITIALIZED PTR           135096 03260000
                                                                        03270000
         ICM   R4,15,TITNULLS     ORIGIN OF NULL MASK                   03280000
         BZ    NXBYTE             NOT DEFINED                           03290000
         BCTR  R4,0               INIT SCAN AT ORIGIN - 1               03300000
         ST    R4,XNULPOS         SAVE INITIALIZED PTR                  03310000
                                                                        03320000
NXBYTE   DS    0H                                                       03330000
                                                                        03340000
*--------------------------------------------------------------  135096 03350000
*   SELECT UNEXAMINED BIT IN THIS OR SUBSEQUENT MASK BYTE        135096 03360000
*--------------------------------------------------------------  135096 03370000
                                                                        03380000
         SR    R3,R3              PREPARE FOR INSERT             135096 03390000
         ICM   R3,1,XCOLBIT       CURRENT POSITION IN BITMASK    135096 03400000
         BNZ   NXTEST             WORK PENDING OR ZERO           135096 03410000
                                                                        03420000
         LA    R2,1(,R2)          ADVANCE TO NEXT MASK BYTE      135096 03430000
         ST    R2,XCOLPOS         SAVE FOR SUBSEQUENT CALLS      135096 03440000
         ICM   R3,1,=X'80'        BIT WALKS FROM LEFT TO RIGHT   135096 03450000
                                                                        03460000
         LTR   R4,R4              NULL INDICATOR MASK DEFINED?          03470000
         BZ    NXTEST             SKIP IF NOT                           03480000
         LA    R4,1(,R4)          ADVANCE TO NEXT MASK BYTE             03490000
         ST    R4,XNULPOS         SAVE FOR SUBSEQUENT CALLS             03500000
                                                                        03510000
NXTEST   DS    0H                                                       03520000
         LR    R0,R3              PREPARE MASK FOR NEXT PASS            03530000
         SRL   R0,1               BY WALKING BIT ONE STEP RIGHT         03540000
         STC   R0,XCOLBIT         SAVE FOR NEXT REQUEST                 03550000
                                                                        03560000
*--------------------------------------------------------------  135096 03570000
*   DETERMINE ELIGIBILITY OF CURRENT COLUMN                      135096 03580000
*--------------------------------------------------------------  135096 03590000
                                                                        03600000
         CLC   #COLS,COLCOUNT     ALL COLUMNS REQUESTED?                03610000
         BE    NXSELECT           MASK TEST NOT REQUIRED IF SO          03620000
         EX    R3,NXSELTM         DETERMINE IF COLUMN SELECTED          03630000
         BNO   NXREJECT           DONE IF NOT                           03640000
                                                                        03650000
NXSELECT DS    0H                                                       03660000
         LTR   R4,R4              NULL INDICATORS IN USE?               03670000
         BZ    NXACCEPT           COLUMN SELECTED AND NOT NULL          03680000
                                                                        03690000
         EX    R3,NXNULTM         COLUMN NULLED?                        03700000
         BNO   NXACCEPT           COLUMN SELECTED AND NOT NULL          03710000
                                                                        03720000
*--------------------------------------------------------------         03730000
*   RETURN COLUMN STATUS TO MAINLINE                                    03740000
*--------------------------------------------------------------         03750000
                                                                        03760000
NXNULLED DS    0H                 COLUMN SELECTED BUT IS NULL           03770000
         LA    R15,RC04                                                 03780000
         LNR   R15,R15                                                  03790000
         B     NXEXIT                                                   03800000
                                                                        03810000
NXACCEPT DS    0H                 COLUMN SELECTED AND IS NOT NULL       03820000
         LA    R15,RC00                                                 03830000
         B     NXEXIT                                                   03840000
                                                                        03850000
NXREJECT DS    0H                 COLUMN NOT SELECTED                   03860000
         LA    R15,RC04                                                 03870000
                                                                        03880000
NXEXIT   DS    0H                                                       03890000
         LM    R0,R14,REGSAVE     RESTORE REGS                          03900000
         LTR   R15,R15            SET CC REFLECTING COMPLETION STATUS   03910000
         BR    R14                RETURN                                03920000
                                                                        03930000
*--------------------------------------------------------------         03940000
                                                                        03950000
NXSELTM  TM    0(R2),*-*          SELECTED COLUMN MASK                  03960000
NXNULTM  TM    0(R4),*-*          NULL INDICATOR MASK                   03970000
                                                                        03980000
         EJECT                                                          03990000
***************************************************************         04000000
*                                                                       04010000
* ROUTINE: SELECT - PREPARE COLUMN DATA FOR RETURN                      04020000
*                                                                       04030000
* DESCRIPTION:                                                          04040000
*                                                                       04050000
*    FIXED LENGTH DATA ITEMS ARE TRIMMED BY REMOVING TRAILING           04060000
*    BLANKS ($CHAR TYPES) OR TRAILING ZEROS (ALL OTHER TYPES).          04070000
*                                                                       04080000
*    IN VERSION 1+ REQUEST FORMATS, A DITTO INDICATOR IS POSTED  137148 04090000
*    IF THE COLUMN CONTAINS THE SAME VALUE AS POSTED IN THE      137148 04100000
*    IMMEDIATELY PRIOR ROW.                                      137148 04110000
*                                                                       04120000
*    IN VERSION 2+ REQUEST FORMATS, THE CALLER MAY INDICATE             04130000
*    THAT THE COLUMN HAS BEEN NULLED.                                   04140000
*                                                                       04150000
*                                                                       04160000
* ON ENTRY:                                                             04170000
*                                                                       04180000
*    R0  CONTAINS A DATA TYPE QUALIFIER AS FOLLOWS                      04190000
*                                                                       04200000
*        00 - COLUMN IS NULL                                            04210000
*        04 - SOURCE ROW CONTAINS COLUMN VALUE                          04220000
*                                                                       04230000
*    THE TBCOLDEF DESCRIBING THE CURRENT COLUMN IS ADDRESSABLE          04240000
*                                                                       04250000
*                                                                       04260000
* ON EXIT:                                                              04270000
*                                                                       04280000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES                     04290000
*                                                                       04300000
*        RC00 - COLUMN PREPARED FOR RETURN                              04310000
*                                                                       04320000
*               R1 CONTAINS THE AMOUNT OF SPACE CONSUMED BY THE         04330000
*                  COLUMN REPRESENTATION AND MAY BE ZERO                04340000
*                                                                       04350000
*        RC04 - SPACE EXHAUSTED                                         04360000
*                                                                       04370000
*        RC08 - TXP BUFFER MANAGEMENT FAILURE                           04380000
*                                                                       04390000
***************************************************************         04400000
                                                                        04410000
SELECT   DS    0H                                                       04420000
         STM   R0,R15,REGSAVE     SAVE MAINLINE REGS                    04430000
                                                                        04440000
         MVI   $CFLAGS,0          INIT COLUMN FLAGS FOR TIRDCFLG 137148 04450000
         LTR   R0,R0              COLUMN NULLED?                        04460000
         BNZ   SELNONUL           SKIP IF NOT                           04470000
                                                                        04480000
         OI    $CFLAGS,TIRDCNUL   NULL INDICATOR IN LIEU OF VALUE       04490000
         SR    R7,R7              COLUMN DATA LENGTH                    04500000
         B     SELXPFMT           NULL INDICATOR TELLS IT ALL           04510000
                                                                        04520000
*--------------------------------------------------------------         04530000
*   NON-NULL COLUMN VALUE AVAILABLE                                     04540000
*--------------------------------------------------------------         04550000
                                                                        04560000
SELNONUL DS    0H                                                       04570000
         L     R6,ROWORG          ROW DATA ORIGIN                       04580000
         A     R6,TBCDISPL        COLUMN ORIGIN                         04590000
         L     R7,TBCLENG         COLUMN LENGTH, FIXED FORMATS          04600000
                                                                        04610000
         SR    R1,R1              PREPARE FOR INSERT             137148 04620000
         IC    R1,TBCDTYPE        FETCH PRIMARY DATA TYPE        137148 04630000
         IC    R1,DATATYPE(R1)    IDENTIFY DATA TYPE             137148 04640000
         STC   R1,$DATATYP        RETAIN: 0 - NONCHAR, /0 - CHAR 137148 04650000
                                                                        04660000
*--------------------------------------------------------------         04670000
*   DETERMINE COLUMN FORMAT - LOCATE ORIGIN, LENGTH, AND EOD            04680000
*--------------------------------------------------------------         04690000
                                                                        04700000
         SR    R2,R2              PREPARE FOR INSERT                    04710000
         IC    R2,TBCDTYPE        FETCH PRIMARY DATA TYPE               04720000
         IC    R2,DFORMAT(R2)     DETERMINE REPRESENTATIONAL FMT        04730000
         STC   R2,$FORMAT         SAVE FORMAT CODE               137148 04740000
         B     *+4(R2)            DATA FORMAT AS FOLLOWS                04750000
         B     SELFIXD               FIXED LENGTH, NO WRINKLES          04760000
         B     SELVAR                VARDATA                            04770000
         B     SELVARX               VARDATAX                           04780000
                                                                        04790000
SELVAR   DS    0H                 STANDARD VARYING (VAR) FORMATS        04800000
         L     R7,0(,R6)          FETCH DATA PTR IN LENGTH REG          04810000
         LTR   R6,R7              TRAVERSE PTR TO DATA ORIGIN           04820000
         BZ    SELALL             NOTHING HERE                          04830000
         LH    R7,0(,R6)          FETCH LENGTH                          04840000
         LA    R6,2(,R6)          ADDRESS DATA PROPER                   04850000
         B     SELVAL                                                   04860000
                                                                        04870000
SELVARX  DS    0H                 EXTENDED VARYING (VARX) FORMATS       04880000
         L     R7,0(,R6)          FETCH LENGTH                          04890000
         L     R6,4(,R6)          TRAVERSE PTR TO DATA ORIGIN           04900000
         B     SELVAL                                                   04910000
                                                                        04920000
*--------------------------------------------------------------         04930000
*   IDENTIFY NULL/PAD BYTE - PREPARE AND EXECUTE COLUMN TRIM            04940000
*--------------------------------------------------------------         04950000
                                                                        04960000
SELFIXD  DS    0H                 IDENTIFY LAST BYTE OF VALUE           04970000
         LTR   R7,R7              TRIVIAL VALUE?                 137148 04980000
         BNP   SELALL             DONE HERE IF SO                137148 04990000
                                                                        05000000
         LA    R15,0(R7,R6)       LOCATE END OF COLUMN                  05010000
         BCTR  R15,0              IDENTIFY LAST BYTE                    05020000
         MVI   BYTE,0             ASSUME NON-CHAR DATA TYPE             05030000
         CLI   $DATATYP,0         ASSUMPTION CORRECT?                   05040000
         BE    SELTRIM            READY FOR TRIM IF SO                  05050000
         MVC   BYTE,0(R15)        CAPTURE LAST BYTE OF CHAR DATA        05060000
         NI    BYTE,C' '          ALLOW BLANK OR ZERO FILL              05070000
                                                                        05080000
SELTRIM  DS    0H                 TRIM THE VALUE                        05090000
         CLC   BYTE,0(R15)        PAD CHARACTER?                        05100000
         BNE   SELVAL             ELSE NON-NULL VALUE IDENTIFIED        05110000
         BCTR  R15,0              BACKUP ONE CHAR                       05120000
         BCT   R7,SELTRIM         DROP ALL ELIGIBLE POSITIONS           05130000
         B     SELALL             NULL VALUE                            05140000
                                                                        05150000
*--------------------------------------------------------------  137148 05160000
*   VALUE LOCATED, BYPASS DITTO LOGIC WHEN NOT APPLICABLE        137148 05170000
*--------------------------------------------------------------  137148 05180000
                                                                        05190000
SELVAL   DS    0H                                                137148 05200000
         CLI   PLISTVER,0         DITTO SUPPORTED BY COOP?       137148 05210000
         BE    SELALL             SKIP IF NOT                    137148 05220000
                                                                        05230000
         L     R14,COLID          COLUMN NUMBER INDEX                   05240000
         LA    R14,1(,R14)        CONVERT TO COLUMN NUMBER              05250000
                                                                        05260000
         TESTBIT *TITNULLP,(R14)  DETERMINE IF PREDECESSOR WAS NULL     05270000
                                                                        05280000
         BO    SELALL             DITTO NOT APPLICABLE IF SO            05290000
                                                                        05300000
*--------------------------------------------------------------  137148 05310000
*   DETERMINE WHETHER COLUMN VALUE REPEATS PRIOR VALUE           137148 05320000
*--------------------------------------------------------------  137148 05330000
                                                                        05340000
         ICM   R14,15,TITPREV     PREVIOUS ROW, SAME FORMAT      137148 05350000
         BZ    SELALL             NOT PROVIDED                   137148 05360000
         A     R14,TBCDISPL       COLUMN ORIGIN                  137148 05370000
         L     R15,TBCLENG        COLUMN LENGTH, FIXED FORMATS   137148 05380000
                                                                        05390000
         SR    R2,R2              PREPARE FOR INSERT             137148 05400000
         IC    R2,$FORMAT         COLUMN DATA FORMAT             137148 05410000
         B     *+4(R2)            DATA FORMAT AS FOLLOWS         137148 05420000
         B     SELCOMP               FIXED LENGTH, NO WRINKLES   137148 05430000
         B     SELAGEV               VARDATA                     137148 05440000
         B     SELAGEVX              VARDATAX                    137148 05450000
                                                                        05460000
SELAGEVX DS    0H                 EXTENDED VARYING (VARX) FMTS   137148 05470000
         L     R15,0(,R14)        FETCH LENGTH                   137148 05480000
         L     R14,4(,R14)        TRAVERSE PTR TO DATA ORIGIN    137148 05490000
         B     SELCOMP                                           137148 05500000
                                                                        05510000
SELAGEV  DS    0H                 STANDARD VARYING (VAR) FORMATS 137148 05520000
         L     R15,0(,R14)        FETCH DATA PTR IN LENGTH REG   137148 05530000
         LTR   R14,R15            TRAVERSE PTR TO DATA ORIGIN    137148 05540000
         BZ    SELCOMP            NOTHING HERE                   137148 05550000
         LH    R15,0(,R14)        FETCH LENGTH                   137148 05560000
         LA    R14,2(,R14)        ADDRESS DATA PROPER            137148 05570000
                                                                        05580000
SELCOMP  DS    0H                                                137148 05590000
         LR    R0,R6              CURRENT ROW COLUMN ORIGIN      137148 05600000
         LR    R1,R7              CURRENT ROW TRIMMED COLUMN LEN 137148 05610000
         ICM   R15,8,BYTE         PAD/NULL VALUE BYTE            137148 05620000
         CLCL  R0,R14             MATCHING VALUES?               137148 05630000
         BNE   SELALL             SKIP IF NOT                    137148 05640000
                                                                        05650000
         OI    $CFLAGS,TIRDCDTO   ATTACH DITTO INDICATOR         137148 05660000
                                                                        05670000
*--------------------------------------------------------------  137148 05680000
*   FINALIZE REPRESENTATIONAL FORMAT FOR COLUMN                  137148 05690000
*--------------------------------------------------------------  137148 05700000
                                                                        05710000
SELALL   DS    0H                                                137148 05720000
         CLI   PLISTVER,0         OMITTING ZERO LENGTH VALUES?   137148 05730000
         BE    SELCOL             SKIP IF NOT                    137148 05740000
         LTR   R1,R7              DATA TO POST?                  137148 05750000
         BZ    SELFIN             NO REPRESENTATION REQUIRED     137148 05760000
                                                                        05770000
SELCOL   DS    0H                                                137148 05780000
         TM    $CFLAGS,TIRDCDTO   DATA VALUE CONVEYED BY DITTO?  137148 05790000
         BNO   *+6                SKIP IF NOT                    137148 05800000
         SR    R7,R7              ELSE RECONSTRUCABLE EXTERNALLY 137148 05810000
                                                                        05820000
*--------------------------------------------------------------  137148 05830000
*   ACQUIRE STORAGE FROM TXP BUFFER AND FORMAT FOR COL RETURN    137148 05840000
*--------------------------------------------------------------  137148 05850000
                                                                        05860000
SELXPFMT DS    0H                                                       05870000
         LA    R2,TIRDCLN(,R7)    TOTAL COLUMN STORAGE RQMT             05880000
         ICM   R0,15,TITXPAND     TXP BUFFER EXPANSION ALLOWED?         05890000
         BNZ   SELXPYES           SKIP IF SO                            05900000
                                                                        05910000
SELXPNO  DS    0H                                                       05920000
         $XPBUFR ISRT,            ALLOC RESPONSE BUFFER SLOT           X05930000
               DATA=0,            WILL FORMAT IN AREA RETURNED         X05940000
               DATALEN=(R2),      COLUMN HEADER PLUST DATA AREA        X05950000
               MF=(E,MFE_LIST)                                          05960000
         B     SELXPCMN                                                 05970000
                                                                        05980000
SELXPYES DS    0H                                                       05990000
         $XPBUFR ISRT,            ALLOC RESPONSE BUFFER SLOT           X06000000
               DATA=0,            WILL FORMAT IN AREA RETURNED         X06010000
               DATALEN=(R2),      COLUMN HEADER PLUST DATA AREA        X06020000
               EXPAND=YES,        EXPAND TXP BUFFER IF NECESSARY       X06030000
               MF=(E,MFE_LIST)                                          06040000
                                                                        06050000
SELXPCMN DS    0H                                                       06060000
         CH    R15,=AL2(RC04)     STORAGE RETURNED APPROPRIATELY?       06070000
         BL    SELCOPY            STORAGE AVAILABLE                     06080000
         BE    SELEXIT            INSUFFICIENT SPACE                    06090000
         LA    R15,RC08           INDICATE SERVICE RTN FAILURE          06100000
         B     SELEXIT            DONE                                  06110000
                                                                        06120000
*--------------------------------------------------------------  137148 06130000
*   CONSTRUCT COLUMN RETURN ENTRY                                137148 06140000
*--------------------------------------------------------------  137148 06150000
                                                                        06160000
SELCOPY  DS    0H                 SPACE ACQUIRED FOR COLUMN             06170000
         LR    R3,R1                                                    06180000
         USING TIRDCOLE,R3        CAST ASSIGNED STG AS COLUMN ENTRY     06190000
         MVC   TIRDCNDX,COLID+3   COLUMN ID                             06200000
         MVC   TIRDCFLG,$CFLAGS   COLUMN VALUE DESCRIPTOR FLAGS  137148 06210000
         STCM  R7,3,TIRDCLEN      DATA LENGTH                           06220000
                                                                        06230000
         LA    R0,TIRDDATA        DATA INSERTION AREA                   06240000
         LR    R1,R7              LENGTH IF DATA SURVIVED COMPRESS      06250000
         MVCL  R0,R6              INSERT COLUMN IN TIRDRET FORMAT       06260000
                                                                        06270000
         LR    R1,R2              RETURN RESPONSE AREA CONSUMED         06280000
         DROP  R3                 TIRDCOLE - COLUMN ENTRY               06290000
                                                                        06300000
*--------------------------------------------------------------         06310000
*   RETURN COMPLETION STATUS TO CALLER                                  06320000
*--------------------------------------------------------------         06330000
                                                                        06340000
SELFIN   DS    0H                 R1 <== TXP STORAGE CONSUMED    137148 06350000
         LA    R15,RC00           NORMAL COMPLETION                     06360000
                                                                        06370000
SELEXIT  DS    0H                                                       06380000
         LM    R2,R14,REGSAVE+8   RESTORE MAINLINE REGS                 06390000
         BR    R14                RETURN                                06400000
                                                                        06410000
         EJECT                                                          06420000
***************************************************************         06430000
*                                                                       06440000
*   LOCAL READ ONLY STORAGE                                             06450000
*                                                                       06460000
***************************************************************         06470000
                                                                        06480000
DFORMAT  DC    0F'0',XL16'00'     DATA REPRESENTATIONS                  06490000
         ORG   DFORMAT+$VCHAR                                           06500000
         DC    AL1(4)                                                   06510000
         ORG   DFORMAT+$VBIN                                            06520000
         DC    AL1(4)                                                   06530000
         ORG   DFORMAT+$VCHARX                                          06540000
         DC    AL1(8)                                                   06550000
         ORG   DFORMAT+$VBINX                                           06560000
         DC    AL1(8)                                                   06570000
         ORG   ,                                                        06580000
                                                                        06590000
DATATYPE DC    0F'0',XL16'00'     CHAR / NON-CHAR DATA TYPES            06600000
         ORG   DATATYPE+$CHAR                                           06610000
         DC    AL1(4)                                                   06620000
         ORG   DATATYPE+$VCHAR                                          06630000
         DC    AL1(4)                                                   06640000
         ORG   DATATYPE+$VCHARX                                         06650000
         DC    AL1(4)                                                   06660000
         ORG   ,                                                        06670000
                                                                        06680000
*--------------------------------------------------------------         06690000
                                                                        06700000
         LTORG ,                                                        06710000
                                                                        06720000
         PRINT NOGEN                                                    06730000
         ICVT  ,                                                        06740000
         ITASK ,                                                        06750000
         END   ,                                                        06760000

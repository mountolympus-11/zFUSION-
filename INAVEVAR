INAVEVAR TITLE '- RETURN FORMATTED SQL ERROR VARIABLES'                 00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: INAVEVAR - Return formatted SQL error variables              00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine extracts SQL ERROR variables from the given           00080000
*    variable pool and enqueues a message contining a header            00090000
*    and the text of each variable for return to the SQL                00100000
*    requester.                                                         00110000
*                                                                       00120000
*                                                                       00130000
* ON ENTRY:                                                             00140000
*                                                                       00150000
*    R1  contains the address of a parameter list described by          00160000
*        the EVRLOADP mapping macro.                                    00170000
*                                                                       00180000
*                                                                       00190000
* ON EXIT:                                                              00200000
*                                                                       00210000
*    N/A                                                                00220000
*                                                                       00230000
**<DOC-OFF>****************************************************         00240000
                                                                        00250000
         EJECT                                                          00260000
***************************************************************         00270000
*                                                                       00280000
* MAINTENANCE:                                                          00290000
*                                                                       00300000
*    07/07/95 R. Turgeon                                                00310000
*             Formalize $VARMGR class code values                       00320000
*                                                                       00330000
***************************************************************         00340000
                                                                        00350000
         EJECT                                                          00360000
         EVRLOADP ,               ERROR VARIABLE LOAD REQUEST           00370000
                                                                        00380000
         EJECT ,                                                        00390000
         VARCONST ,               SQL VARIABLE MANAGEMENT CONSTANTS     00400000
                                                                        00410000
         EJECT                                                          00420000
         $VARMGR DSECT=YES        VAR MANAGER MAPPINGS                  00430000
                                                                        00440000
         EJECT                                                          00450000
         $ENTITY DSECT=ALL        ENTITY REGISTRATION STRUCTURES        00460000
                                                                        00470000
         EJECT                                                          00480000
         EQUS  ,                                                        00490000
                                                                        00500000
         $MSGDFT PREFIX=ICTPID,COMPID='SQL',TABLE=*#MSGS,              X00510000
               CONID=*ICTCONID,CONNAME=ICTCONNM,                       X00520000
               DEST=$IMSGQ,                                            X00530000
               MSGQA=*EVRMSGQ,STGQH=*EVRQH,                            X00540000
               PRINT=NOGEN,MF=(E,MSGLIST)                               00550000
                                                                        00560000
         EJECT                                                          00570000
         #WORK ,                                                        00580000
                                                                        00590000
FLAGS    DS    X                  FLAG BYTE                             00600000
F$EVAR   EQU   X'80'                 ERROR VARIABLES PRESENTED          00610000
                                                                        00620000
REGSAVE  DS    16F                LOCAL REGISTER SAVEAREA               00630000
                                                                        00640000
MSGLIST  $MSG  FIELDS=(,,,,),MF=(L,*)                                   00650000
                                                                        00660000
         #ENDWORK ,                                                     00670000
                                                                        00680000
         EJECT                                                          00690000
INAVEVAR #ENTER PREG=(R8)                                               00700000
                                                                        00710000
         USING ITASK,R10          STDENV                                00720000
                                                                        00730000
***************************************************************         00740000
*                                                                       00750000
*   Run variable pool extracting and converting SQLERROR entries        00760000
*                                                                       00770000
***************************************************************         00780000
                                                                        00790000
         USING EVRLOADP,R8        PARAMETER                             00800000
                                                                        00810000
         ICM   R6,15,EVRVMP       VARIABLE POOL BLOCK                   00820000
         BZ    NOVARS             NOT PROVIDED                          00830000
         USING VMPOOL,R6          FORMATTED AREA                        00840000
                                                                        00850000
         ICM   R5,15,VMPENT@      ASSOCIATED $ENTITY STRUCTURE          00860000
         BZ    NOVARS             NOT INITIALIZED                       00870000
         USING ENTCNTL,R5         FORMAT                                00880000
                                                                        00890000
*--------------------------------------------------------------         00900000
*   EXTRACT ALL ERROR VARIABLES                                         00910000
*--------------------------------------------------------------         00920000
                                                                        00930000
         L     R4,ENTQ            SEQUENTIAL ORDERING OF VARS           00940000
         USING ENENTRY,R4         ENTRY FORMAT                          00950000
                                                                        00960000
SCANENT  DS    0H                                                       00970000
         LTR   R4,R4              ENTRIES REMAIN?                       00980000
         BZ    ENDSCAN            DONE IF NOT                           00990000
         LA    R3,ENEUSER         USERAREA                              01000000
         USING VMVAR,R3           FORMAT OF VARIABLE DESCRIPTOR         01010000
                                                                        01020000
         TM    VMVCLASS,VARCSQL_ERROR                                   01030000
         BNO   SCANADV            SKIP IF NOT A SQL ERROR VARIABLE      01040000
                                                                        01050000
         TM    FLAGS,F$EVAR       FIRST ERROR VARIABLE?                 01060000
         BO    SCANMSG            SKIP IF NOT                           01070000
         OI    FLAGS,F$EVAR       CONSTRUCTING HEADER                   01080000
         BAS   R14,EVARHDR        INSERT HEADER LINE                    01090000
                                                                        01100000
SCANMSG  DS    0H                                                       01110000
         L     R1,VMVXVAR         VARIABLE TEXT ORIGIN                  01120000
         LH    R0,VMVLENG         VARIABLE TEXT LENGTH                  01130000
         BAS   R14,XTRVAR         EXTRACT THE VARIABLE                  01140000
                                                                        01150000
SCANADV  DS    0H                                                       01160000
         L     R4,ENEQFWD         ADVANCE TO NEXT VARIABLE              01170000
         B     SCANENT            AGAIN                                 01180000
         DROP  R3,R4              VMVAR, ENENTRY                        01190000
                                                                        01200000
*--------------------------------------------------------------         01210000
*   EXTRACT ALL ERROR VARIABLES                                         01220000
*--------------------------------------------------------------         01230000
                                                                        01240000
ENDSCAN  DS    0H                                                       01250000
         LA    R15,RC00           INDICATE COMPLETE                     01260000
         B     RETURN                                                   01270000
                                                                        01280000
NOVARS   DS    0H                                                       01290000
         LA    R15,RC04           NO VARS AVAIL                         01300000
                                                                        01310000
RETURN   DS    0H                                                       01320000
         #EXIT ,                                                        01330000
                                                                        01340000
         EJECT                                                          01350000
***************************************************************         01360000
*                                                                       01370000
* ROUTINE: XTRVAR - Format SQLERROR variable for return                 01380000
*                                                                       01390000
* ON ENTRY:                                                             01400000
*                                                                       01410000
*    R1 - text origin                                                   01420000
*    R0 - text length                                                   01430000
*                                                                       01440000
***************************************************************         01450000
                                                                        01460000
XTRVAR   DS    0H                                                       01470000
         STM   R0,R15,REGSAVE     PRESERVE MAINLINE REGS                01480000
                                                                        01490000
         LR    R2,R1              TEXT ORIGIN                           01500000
         LTR   R3,R0              TEXT LENGTH                           01510000
         BNP   XTRRET             SKIP                                  01520000
                                                                        01530000
         LR    R4,R3              LENGTH OF MESSAGE                     01540000
         BCTR  R4,0               PREPARE FOR EXEC                      01550000
         TR    0(*-*,R2),TRTABLE  *** EX OBJECT ***                     01560000
         EX    R4,*-6             CONVERT ZEROS TO BLANKS               01570000
                                                                        01580000
         $MSG  401,FIELDS=(((R2),(R3)))                                 01590000
                                                                        01600000
XTRRET   DS    0H                                                       01610000
         LM    R0,R14,REGSAVE     RESTORE MAINLINE REGS                 01620000
         BR    R14                RETURN                                01630000
                                                                        01640000
         EJECT                                                          01650000
***************************************************************         01660000
*                                                                       01670000
* ROUTINE: EVARHDR - SQLERROR variable list header msg                  01680000
*                                                                       01690000
***************************************************************         01700000
                                                                        01710000
EVARHDR  DS    0H                                                       01720000
         ST    R14,FWORD          PRESERVE RETURN ADDR                  01730000
                                                                        01740000
         $MSG  400                                                      01750000
                                                                        01760000
         L     R14,FWORD          RESTORE RETURN ADDR                   01770000
         BR    R14                RETURN                                01780000
                                                                        01790000
***************************************************************         01800000
*                                                                       01810000
*   Local read only data areas                                          01820000
*                                                                       01830000
***************************************************************         01840000
                                                                        01850000
         LTORG ,                                                        01860000
                                                                        01870000
TRTABLE  DC    256AL1(*-TRTABLE)                                        01880000
         ORG   TRTABLE                                                  01890000
         DC    C' '                                                     01900000
         ORG   ,                                                        01910000
                                                                        01920000
         EJECT ,                                                        01930000
         PRINT NOGEN                                                    01940000
         ICVT  ,                                                        01950000
         ITASK ,                                                        01960000
         IPCB  ,                                                        01970000
         END   ,                                                        01980000

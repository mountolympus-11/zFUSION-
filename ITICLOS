ITICLOS  TITLE 'ITICLOS - TABLE INTERFACE CLOSE PROCESSOR'              00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: ITICLOS - TABLE INTERFACE CLOSE PROCESSOR                    00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THIS ROUTINE ALLOWS A COOPERATIVE PROJECT TO TERMINATE ITS         00080000
*    ASSOCIATION WITH A HOST TABLE PREVIOUSLY ACQUIRED VIA              00090000
*    TIOPEN.  THE TABLE TOKEN AND OTHER WORKING STORAGE AREAS           00100000
*    ACQUIRED BY THE OPEN PROCESS AND OTHER (TI) SERVICES ARE           00110000
*    RELEASED (VIA ITICLN).  REFER TO ITIOPEN FOR ADDITIONAL            00120000
*    DETAIL.                                                            00130000
*                                                                       00140000
*    THE COOPERATIVE PROCESS IS REFERRED TO AS "COOP" IN THE            00150000
*    DOC TO FOLLOW.                                                     00160000
*                                                                       00170000
*                                                                       00180000
* ON ENTRY:                                                             00190000
*                                                                       00200000
*    R1  POINTS TO A PARAMETER LIST DESCRIBED BY THE @TICLOSE           00210000
*        MAPPING.                                                       00220000
*                                                                       00230000
*    R0  CONTAINS THE ADDRESS OF A WORKAREA NO SMALLER THAN             00240000
*        THE LENGTH DEFINED BY LENGTH= OPERAND ON THE #WORK             00250000
*        MACRO.                                                         00260000
*                                                                       00270000
*                                                                       00280000
* ON EXIT:                                                              00290000
*                                                                       00300000
*    A RESPONSE BLOCK IS CONSTRUCTED TO CONVEY THE RESULTS OF           00310000
*    THE OPEN REQUEST.  WHEN THE RETURN CODE IS NON-ZERO, THE           00320000
*    RESPONSE STRING CONTAINS AN APPROPRIATE ERROR MESSAGE.             00330000
*                                                                       00340000
*    THE RESPONSE AREA WILL CONTAIN ONE OF THE FOLLOWING                00350000
*    RETURN/REASON CODE PAIRS WHICH ARE ALSO REFLECTED TO THE           00360000
*    CALLER VIA R15 AND R0.  R1 CONTAINS A DIAGNOSTIC IN SOME           00370000
*    CASES.                                                             00380000
*                                                                       00390000
*       RC00 - CLOSE COMPLETE, TABLE TOKEN INVALIDATED                  00400000
*                                                                       00410000
*       RC04 - INSUFFICIENT RESPONSE BUFFER ALLOCATION                  00420000
*                                                                       00430000
*       RC12 - REQUEST IN ERROR                                         00440000
*                                                                       00450000
*              RSN04 - TABLE TOKEN DOES NOT MATCH OPEN TABLE            00460000
*                                                                       00470000
*       RC16 - TABLE SERVICES ERROR                                     00480000
*                                                                       00490000
*              RSN04 - TBCLOSE FAILURE                                  00500000
*                                                                       00510000
*       RC20 - RESPONSE SERVICE FAILURE                                 00520000
*                                                                       00530000
**<DOC-OFF>****************************************************         00540000
                                                                        00550000
         EJECT ,                                                        00560000
***************************************************************         00570000
*                                                                       00580000
* MAINTENANCE:                                                          00590000
*                                                                       00600000
*   08/XX/92  R. TURGEON                                                00610000
*             INITIAL VERSION                                           00620000
*                                                                       00630000
*   08/05/93  RON COLMONE                                               00640000
*             CONVERTED TO NEW ENVIRONMENT                              00650000
*                                                                       00660000
***************************************************************         00670000
                                                                        00680000
         EJECT ,                                                        00690000
         #WORK LENGTH=512    READ / WRITE WORKAREA                      00700000
                                                                        00710000
CLOSERET DS    F             TBCLOSE RETURN CODE                        00720000
#RESPHDR DS    0F,XL(TMRESPLN)                                          00730000
                                                                        00740000
         #ENDWORK ,          END OF WORKAREA                            00750000
                                                                        00760000
         EJECT ,                                                        00770000
         @TICLOSE ,          REQUEST BLOCK FORMAT                       00780000
                                                                        00790000
         EJECT ,                                                        00800000
         TIBLOCK ,           TABLE INTERFACE BLOCK          (TIB)       00810000
                                                                        00820000
         EJECT ,                                                        00830000
         TMRESP  ,           RESPONSE HEADER                            00840000
                                                                        00850000
         EJECT ,                                                        00860000
         REQHDR  ,           REQUEST  HEADER                            00870000
                                                                        00880000
         EJECT ,                                                        00890000
         EQUS  ,             GENERAL EQUATES                            00900000
                                                                        00910000
         EJECT ,                                                        00920000
ITICLOS  #ENTER WAPASS=YES,BASE=R12,PREG=R8                             00930000
                                                                        00940000
         USING ITASK,R10          ITASK ADDRESSABILITY                  00950000
         L     R9,TSKPCBC         ADDRESS OF CURRENT PCB                00960000
         USING IPCB,R9            ADDRESSABILTY                         00970000
                                                                        00980000
*--------------------------------------------------------------         00990000
*   GENERAL INITIALIZATION AND VALIDATION                               01000000
*--------------------------------------------------------------         01010000
         USING TICLOSE,R8         LIFE OF FUNCTION                      01020000
         L     R7,PCBUSER         ADDRESS OF IUSER BLOCK                01030000
         USING IUSER,R7           ADDRESSABILITY                        01040000
         L     R7,USRPROJ         PROJECT CONTROL AREA                  01050000
         USING IPROJ,R7           LIFE OF FUNCTION                      01060000
                                                                        01070000
         LA    R4,#RESPHDR        LOCATE RESPONSE HEADER                01080000
         USING TMRESP,R4          FORMAT                                01090000
         XC    TMRESP(TMRESPLN),TMRESP                                  01100000
                                                                        01110000
         $XPBUFR ISRT,            ADD RESPONSE BLOCK                   +01120000
               NEWFUNC=(TBSV,TI$CLOS),                                 +01130000
               DATA=TMRESP,                                            +01140000
               DATALEN=TMRESPLN,                                       +01150000
               MF=(E,MFE_LIST)                                          01160000
         LTR   R15,R15                                                  01170000
         BNZ   ERR_ITXP           ERROR IF NOT                          01180000
         LR    R4,R1              REFRESH RESPONSE BUFFER PTR           01190000
                                                                        01200000
*--------------------------------------------------------------         01210000
*   IDENTIFY THE APPROPRIATE TIB AND DECHAIN IT                         01220000
*--------------------------------------------------------------         01230000
         LA    R1,TICLSTKN        R0 <== TABLE TOKEN ADDR               01240000
         BAS   R14,LOCTIB         TEST WHETHER TABLE ALREADY OPENED     01250000
         LTR   R15,R15            TIB CHAIN SEGMENT RETURNED?           01260000
         BNZ   ENOTIB             ERROR                                 01270000
                                                                        01280000
         LR    R5,R0              MATCHING TIB                          01290000
         USING TIBLOCK,R5         DECHAIN THE TIB FROM LIST             01300000
         MVC   TIBNEXT-TIBLOCK(,R1),TIBNEXT                             01310000
                                                                        01320000
*--------------------------------------------------------------         01330000
*   CLOSE OR DROP THE TABLE VIA TIB RESOURCE MANAGER                    01340000
*--------------------------------------------------------------         01350000
         CLI   TICLSDRP,0         TABLE DROP IS EXPLICIT                01360000
         BE    *+8                SKIP IF NOT                           01370000
         OI    TIBFLAGS,TIB$DROP  TABLE TO BE DROPPED                   01380000
                                                                        01390000
         LA    R1,TIBLOCK         R1 <== RESOURCE MGR PARM              01400000
         @CALL ITICLN,CTYPE=STD   DELETE TIB AND ASSOC RESOURCES        01410000
                                                                        01420000
         ST    R0,CLOSERET        RETAIN TABLE SERVICE RETCODE          01430000
                                                                        01440000
         EJECT                                                          01450000
***************************************************************         01460000
*                                                                       01470000
*   POST COMPLETION STATUS                                              01480000
*                                                                       01490000
***************************************************************         01500000
         ICM   R1,15,CLOSERET     FETCH RETURN CODE FROM CLOSE          01510000
         BNZ   ETBSRV             DELAYED REPORT OF ERROR               01520000
                                                                        01530000
         LA    R15,RC00           COMPLETION CODE                       01540000
         SR    R0,R0              NO REASON CODES DEFINED               01550000
         SR    R1,R1              NO DIAGNOSTICS                        01560000
         SR    R2,R2              NO RESPONSE DATA                      01570000
         SR    R3,R3                                                    01580000
         B     RESPOND            RESPOND TO COOP                       01590000
                                                                        01600000
ENOTIB   DS    0H                 TIB NOT FOUND                         01610000
         LA    R15,RC12           FAIL THE REQUEST                      01620000
         LA    R0,RSN04           POSSIBLE INVALID TABLE TOKEN          01630000
         LA    R2,MSGNOTIB                                              01640000
         LA    R3,L'MSGNOTIB                                            01650000
         B     RESPOND                                                  01660000
                                                                        01670000
ETBSRV   DS    0H                 TBCLOSE FAILURE                       01680000
         LA    R15,RC16           TABLE SERVICES FAILURE                01690000
         LA    R0,RSN04           TBCLOSE, DIAGNOSTICS IN R1            01700000
         LA    R2,MSGCLOS                                               01710000
         LA    R3,L'MSGCLOS                                             01720000
         B     RESPOND                                                  01730000
                                                                        01740000
         EJECT ,                                                        01750000
***************************************************************         01760000
*                                                                       01770000
*   CONSTRUCT RESPONSE - THE DATA PORTION OF THE RESPONSE               01780000
*   BLOCK CONSISTS OF A RESPONSE HEADER FOLLOWED BY AN ERROR            01790000
*   MESSAGE IF THE REQUEST FAILS.                                       01800000
*                                                                       01810000
***************************************************************         01820000
RESPOND  DS    0H                                                       01830000
         MVC   TMRSTTKN,TICLSTKN                                        01840000
         ST    R15,TMRSRC                                               01850000
         ST    R15,TMRSUPRC                                             01860000
         ST    R0,TMRSRSN                                               01870000
         ST    R1,TMRSINFO                                              01880000
                                                                        01890000
         $XPBUFR ISRT,            ADD MESSAGE TO RESPONSE BUFR         +01900000
               DATA=(R2),                                              +01910000
               DATALEN=(R3),                                           +01920000
               MF=(E,MFE_LIST)                                          01930000
                                                                        01940000
         LTR   R15,R15                                                  01950000
         BNZ   ERR_ITXP                                                 01960000
         STH   R3,TMRSDATL        POST RET LENGTH IN RESPONSE HDR       01970000
         B     RETURN                                                   01980000
                                                                        01990000
         EJECT ,                                                        02000000
***************************************************************         02010000
*                                                                       02020000
*   ERRORS USUALLY PRECLUDING RESPONSE TO COOPERATIVE PROCESS           02030000
*                                                                       02040000
***************************************************************         02050000
ERR_ITXP DS    0H                                                       02060000
         LR    R1,R15             TXP SERVICE RETURN CODE               02070000
         LA    R15,RC04           ASSUME OUT-OF-SPACE                   02080000
         CR    R1,R15             CORRECT?                              02090000
         BE    *+8                TERMINATE WITH WARNING                02100000
         LA    R15,RC20           ELSE MORE SERIOUS PROBLEM             02110000
                                                                        02120000
         ST    R15,TMRSUPRC       LOCAL RETCODE                         02130000
         ST    R0,TMRSRSN         TXP REASON                            02140000
         ST    R1,TMRSINFO        TXP INFO CODE                         02150000
         B     RETURN                                                   02160000
                                                                        02170000
         EJECT ,                                                        02180000
***************************************************************         02190000
*                                                                       02200000
*   RETURN TO CALLER                                                    02210000
*                                                                       02220000
***************************************************************         02230000
RETURN   DS    0H                                                       02240000
         L     R15,TMRSRC         RETURN CODE                           02250000
         L     R0,TMRSRSN         REASON CODE                           02260000
         L     R1,TMRSINFO        INFO / DIAGNOSTIC CODE                02270000
                                                                        02280000
         #EXIT ,                  RETURN                                02290000
         DROP  R4                 TMRESP                                02300000
         EJECT ,                                                        02310000
***************************************************************         02320000
*                                                                       02330000
* ROUTINE: LOCTIB - LOCATE TIB BY TABLE TOKEN                           02340000
*                                                                       02350000
* ON ENTRY:                                                             02360000
*                                                                       02370000
*    R1  - ADDRESS OF TABLE TOKEN                                       02380000
*                                                                       02390000
* ON EXIT:                                                              02400000
*                                                                       02410000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES                     02420000
*                                                                       02430000
*        RC00 - TIB LOCATED                                             02440000
*                                                                       02450000
*               R0 - MATCHING TIB                                       02460000
*               R1 - PREDECESSOR OF MATCHING TIB ON CHAIN               02470000
*                                                                       02480000
*        RC04 - NO CORRESPONDING TIB FOUND                              02490000
*                                                                       02500000
***************************************************************         02510000
LOCTIB   DS    0H                                                       02520000
         BAKR  R14,0              PRESERVE MAINLINE ENVIRONMENT         02530000
                                                                        02540000
         L     R2,PCBUSER         ADDRESS OF IUSER BLOCK                02550000
         USING IUSER,R2           ADDRESSABILITY                        02560000
                                                                        02570000
         LA    R15,RC04           ASSUME TABLE IS NOT ACTIVE            02580000
         LA    R5,USRTIBS-(TIBNEXT-TIBLOCK)                             02590000
         USING TIBLOCK,R5         PREPARE FOR TIB TRAVERSAL             02600000
                                                                        02610000
LTIBNXT  DS    0H                                                       02620000
         LR    R6,R5              SAVE BACKLINK PTR                     02630000
         ICM   R5,15,TIBNEXT      ADVANCE TO NEXT TIB                   02640000
         BZ    LTIBEXIT           END OF CHAIN                          02650000
         CLC   TIBTOKN,0(R1)      MATCHING TABLE TOKEN?                 02660000
         BNE   LTIBNXT            CONTINUE SCAN IF NOT                  02670000
                                                                        02680000
         LA    R0,TIBLOCK         MATCHING TIB                          02690000
         LR    R1,R6              LIST PREDECESSOR TIB                  02700000
         LA    R15,RC00           INDICATE SUCCESS                      02710000
                                                                        02720000
LTIBEXIT NOP   0                  RETURN                                02730000
         PR    ,                                                        02740000
         DROP  R2,R5              IUSER, TIB                            02750000
                                                                        02760000
         EJECT ,                                                        02770000
***************************************************************         02780000
*                                                                       02790000
*   LOCAL READ ONLY STORAGE                                             02800000
*                                                                       02810000
***************************************************************         02820000
MSGCLOS  DC    C'TBCLOSE OPERATION FAILED'                              02830000
MSGNOTIB DC    C'INVALID TABLE REFERENCE'                               02840000
                                                                        02850000
         LTORG ,                                                        02860000
                                                                        02870000
         PRINT NOGEN                                                    02880000
         ICVT  ,                                                        02890000
         ITASK ,                                                        02900000
         IPCB  ,                                                        02910000
         IUSER ,                                                        02920000
         IPROJ ,                                                        02930000
         PRINT GEN                                                      02940000
                                                                        02950000
         END   ,                                                        02960000

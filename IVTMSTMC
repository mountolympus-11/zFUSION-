IVTMSTMC TITLE 'INTEGRATOR - SESSION $TIMER CANCEL'                     00010000
                                                                        00020000
**<DOC-ON>************************************************************* 00030000
*                                                                       00040000
* ROUTINE: IVTMSTMC - INTEGRATOR SESSION $TIMER CANCEL                  00050000
*                                                                       00060000
* DESCRIPTION: CANCEL AN OUTSTANDING SESSION $TIMER                     00070000
*                                                                       00080000
* ON ENTRY:                                                             00090000
*                                                                       00100000
*    R15 = ENTRY POINT ADDRESS                                          00110000
*    R14 = RETURN ADDRESS                                               00120000
*    R13 = AVAILABLE SAVE AREA                                          00130000
*    R11 = ICVT ADDRESS                                                 00140000
*    R10 = ITASK ADDRESS                                                00150000
*    R01 = STMLIST PARAMETER LIST ADDRESS                               00160000
*                                                                       00170000
* ON EXIT:                                                              00180000
*                                                                       00190000
*    R15 = 0 SUCCESSFUL                                                 00200000
*        =!0 UNSUCCESSFUL                                               00210000
*    R00 = REASON CODE                                                  00220000
*    R01 = STMLIST ADDRESS                                              00230000
*                                                                       00240000
*    ALL OTHER REGISTERS ARE RESTORED                                   00250000
*                                                                       00260000
*                                                                       00270000
**<DOC-OFF>************************************************************ 00280000
                                                                        00290000
         EJECT ,                                                        00300000
*********************************************************************** 00310000
*                                                                       00320000
* MAINTENANCE:                                                          00330000
*                                                                       00340000
*   10/01/93 RANDY WITEK                                                00350000
*   08/18/95 RANDY WITEK - REWORKED TO USE $TIMER SERVICE               00360000
*                                                                       00370000
*********************************************************************** 00380000
                                                                        00390000
         EQUS  ,                  GENERAL EQUATES                       00400000
                                                                        00410000
RICVT    EQU   R11                                                      00420000
RITASK   EQU   R10                                                      00430000
RIVTAM   EQU   R9                                                       00440000
RISESS   EQU   R8                                                       00450000
RSTMLIST EQU   R7                                                       00460000
                                                                        00470000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00480000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00490000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00500000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00510000
         USING STMLIST,RSTMLIST   ESTABLISH ADDRESSABILITY              00520000
                                                                        00530000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00540000
                                                                        00550000
TIMERMFL $TIMER TERM,MF=L         $TIMER PLIST CONSTRUCTION             00560000
                                                                        00570000
$SESSMFL $SESS MF=L               $SESS   PLIST CONSTRUCTION            00580000
                                                                        00590000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00600000
                                                                        00610000
WRK256   DS    XL256              GENERAL WORKAREA                      00620000
SAVEID   DS    XL8                                                      00630000
                                                                        00640000
RETR15   DS    F                  RETURN CODE VALUE                     00650000
RETR0    DS    F                  RETURN REGISTER 0                     00660000
RETR1    DS    F                  RETURN REGISTER 1                     00670000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00680000
                                                                        00690000
FLAG     DS    X                                                        00700000
FLAGLOCK EQU   X'80'              VTAM LOCK IS HELD                     00710000
FLAGLCKD EQU   X'40'              VTAM LOCK WAS HELD ON ENTRY           00720000
                                                                        00730000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00740000
                                                                        00750000
         $MSGDFT PREFIX=ICTPID,                                        +00760000
               COMPID='VTM',                                           +00770000
               TABLE=*#MSGS,                                           +00780000
               WORKA=0,                                                +00790000
               MF=(E,WRK256),                                          +00800000
               PRINT=NOGEN                                              00810000
                                                                        00820000
IVTMSTMC #ENTER BASE=R12,         ENTRY LINKAGE                        +00830000
               PREG=RSTMLIST,     R1 --> RSTMLIST                      +00840000
               AMODE=31,                                               +00850000
               RMODE=ANY                                                00860000
                                                                        00870000
*---------------------------------------------------------------------- 00880000
* INITIALIZATION                                                        00890000
*---------------------------------------------------------------------- 00900000
                                                                        00910000
         L     RIVTAM,ICTVTCVT     IVTAMCVT ADDRESS                     00920000
                                                                        00930000
         ST    RSTMLIST,RETR1      RETURN PLIST IN R1                   00940000
                                                                        00950000
         ICM   R3,15,STMCLASS      TIMER CLASS                          00960000
         BNP   RSNCLASS            BRANCH IF NOT VALID                  00970000
         C     R3,=A($SESSTMR_CLASS_MAXIMUM)                            00980000
         BH    RSNCLASS            BRANCH IF NOT VALID                  00990000
         BCTR  R3,0                                                     01000000
         SLL   R3,3                SLOT OFFSET ((CLASS-1) * 8)          01010000
                                                                        01020000
         ICM   RISESS,15,STMISESS  ISESS ADDRESS PROVIDED?              01030000
         BNZ   INITDONE            BRANCH IF YES                        01040000
         ICM   RISESS,15,STMTOKEN  TOKEN ADDRESS PROVIDED?              01050000
         BZ    RSNSESS             BRANCH IF NOT                        01060000
         OC    0(L'ISETK,RISESS),0(RISESS) IS THERE A TOKEN?            01070000
         BZ    RSNSESS             BRANCH IF NOT                        01080000
                                                                        01090000
         BAS   R14,VTAMLOCK                                             01100000
                                                                        01110000
         $SESS $SESS_FIND_SESSION,                                     +01120000
               SESSION=(RISESS),                                       +01130000
               ERRET=RSNSESS,                                          +01140000
               MF=(E,$SESSMFL)     LOCATE ASSOCIATED ISESS, IF ANY      01150000
                                                                        01160000
X        USING SPLIST,$SESSMFL                                          01170000
         L     RISESS,X.SPLAREA    ADDRESS OF ASSOCIATED ISESS BLOCK    01180000
         DROP  X                                                        01190000
                                                                        01200000
INITDONE DS    0H                                                       01210000
                                                                        01220000
*---------------------------------------------------------------------- 01230000
* CANCEL ANY ACTIVE SESSION TIMER                                       01240000
*---------------------------------------------------------------------- 01250000
                                                                        01260000
         LA    R4,ISETID01(R3)     ADDRESS OF SPECIFIED CLASS SLOT      01270000
         OC    0(8,R4),0(R4)       TIMER ID OF SPECIFIED CLASS SLOT     01280000
         BZ    RSNTIMER            BRANCH IF NO ID                      01290000
                                                                        01300000
         $TIMER CANCEL,                                                +01310000
               TID=(R4),                                               +01320000
               MF=(E,TIMERMFL)     CANCEL THE $TIMER                    01330000
                                                                        01340000
TIMRCAND DS    0H                                                       01350000
                                                                        01360000
         ST    R15,STMRETCD              SAVE RETURN CODE               01370000
         MVC   SAVEID,0(R4)              SAVE TIMER ID FOR TRACE        01380000
         XC    0(8,R4),0(R4)             CLEAR TIMER ID                 01390000
                                                                        01400000
         $TRACE *=A(TRC_ISESS_TIMERCAN),32 TRACE ENTRY W/32 USER BYTES  01410000
                                                                        01420000
         BNZ   RETURN                    BRANCH IF NOT TRACING          01430000
                                                                        01440000
         ST    RISESS,0(,R1)             TRACE ISESS ADDRESS            01450000
         MVC   4(4,R1),ISECID            TRACE VTAM CID                 01460000
         MVC   8(8,R1),ISETK             TRACE SESSION TOKEN            01470000
         MVC   16(8,R1),SAVEID           TRACE $TIMER TIMER ID          01480000
         MVC   24(4,R1),STMCLASS         TRACE TIMER CLASS              01490000
         MVC   28(4,R1),STMRETCD         TRACE $TIMER RETURN CODE       01500000
                                                                        01510000
         OC    STMRETCD,STMRETCD         SUCCESSFUL $TIMER CALL?        01520000
         BZ    RETURN                    BRANCH IF YES                  01530000
         B     RSNCALL                   BRANCH IF NOT                  01540000
                                                                        01550000
*---------------------------------------------------------------------- 01560000
* $TIMER CALL HAD A PROBLEM                                             01570000
*---------------------------------------------------------------------- 01580000
                                                                        01590000
RSNCALL  DS    0H                                                       01600000
                                                                        01610000
         MVC   STMRSNCD,=A($SESSTMR_RSN_$TIMER_SERVICE)                 01620000
         B     RETURN                                                   01630000
                                                                        01640000
*---------------------------------------------------------------------- 01650000
* THE TIMER CLASS PARAMETER WAS INVALID                                 01660000
*---------------------------------------------------------------------- 01670000
                                                                        01680000
RSNCLASS DS    0H                                                       01690000
                                                                        01700000
         MVC   STMRETCD,=A($SESSTMR_RC_UNSUCCESSFUL)                    01710000
         MVC   STMRSNCD,=A($SESSTMR_RSN_BAD_CLASS)                      01720000
         B     RETURN                                                   01730000
                                                                        01740000
*---------------------------------------------------------------------- 01750000
* NO TARGET SESSION COULD BE FOUND                                      01760000
*---------------------------------------------------------------------- 01770000
                                                                        01780000
RSNSESS  DS    0H                                                       01790000
                                                                        01800000
         MVC   STMRETCD,=A($SESSTMR_RC_UNSUCCESSFUL)                    01810000
         MVC   STMRSNCD,=A($SESSTMR_RSN_NO_SESSION)                     01820000
         B     RETURN                                                   01830000
                                                                        01840000
*---------------------------------------------------------------------- 01850000
* CANCEL ISSUED AND NO TIMER WAS ACTIVE                                 01860000
*---------------------------------------------------------------------- 01870000
                                                                        01880000
RSNTIMER DS    0H                                                       01890000
                                                                        01900000
         MVC   STMRETCD,=A($SESSTMR_RC_UNSUCCESSFUL)                    01910000
         MVC   STMRSNCD,=A($SESSTMR_RSN_TIMER_INACTIVE)                 01920000
         B     RETURN                                                   01930000
                                                                        01940000
*---------------------------------------------------------------------- 01950000
* RETURN TO CALLER                                                      01960000
*---------------------------------------------------------------------- 01970000
                                                                        01980000
RETURN   DS    0H                                                       01990000
                                                                        02000000
         BAS   R14,VTAMUNLK                                             02010000
                                                                        02020000
         MVC   RETR15,STMRETCD    RETURN CODE IN R15                    02030000
         MVC   RETR0,STMRSNCD     REASON CODE IN R0                     02040000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 02050000
                                                                        02060000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    02070000
                                                                        02080000
*---------------------------------------------------------------------- 02090000
* SUBROUTINE VTAMLOCK - OBTAIN VTAM GLOBAL LOCK                         02100000
*---------------------------------------------------------------------- 02110000
                                                                        02120000
VTAMLOCK DS    0H                                                       02130000
                                                                        02140000
         TM    FLAG,FLAGLOCK        HAVE WE ALREADY OBTAINED THE LOCK?  02150000
         BOR   R14                  RETURN IF YES                       02160000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             02170000
                                                                        02180000
         $SER  OBTAIN,                                                 +02190000
               VTAM                                                     02200000
                                                                        02210000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              02220000
         BNE   VTAMLOEX             BRANCH IF NOT                       02230000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         02240000
                                                                        02250000
VTAMLOEX DS    0H                                                       02260000
                                                                        02270000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               02280000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          02290000
         BR    R14                  RETURN                              02300000
                                                                        02310000
*---------------------------------------------------------------------- 02320000
* SUBROUTINE VTAMUNLK - RELEASE VTAM GLOBAL LOCK                        02330000
*---------------------------------------------------------------------- 02340000
                                                                        02350000
VTAMUNLK DS    0H                                                       02360000
                                                                        02370000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       02380000
         BNOR  R14                  BRANCH IF NOT                       02390000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             02400000
         BOR   R14                  DON'T RELEASE IF IT WAS             02410000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             02420000
                                                                        02430000
         $SER  RELEASE,                                                +02440000
               VTAM                                                     02450000
                                                                        02460000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  02470000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          02480000
         BR    R14                  RETURN                              02490000
                                                                        02500000
*---------------------------------------------------------------------- 02510000
*  CONSTANTS AND LITERALS                                               02520000
*---------------------------------------------------------------------- 02530000
                                                                        02540000
         LTORG ,                                                        02550000
         PRINT NOGEN                                                    02560000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                02570000
         ISTDBIND ,               VTAM BIND IMAGE                       02580000
         ISTRH ,                  VTAM SNA REQUEST HEADER               02590000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         02600000
         ICVT  ,                  INTEGRATOR CVT                        02610000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   02620000
         IRPL ,                   INTEGRATOR VTAM RPL+                  02630000
         IACB ,                   INTEGRATOR VTAM ACB+                  02640000
         INIB ,                   INTEGRATOR VTAM NIB+                  02650000
         ISESS ,                  INTEGRATOR SESSION BLOCK              02660000
         IRQE ,                   INTEGRATOR RECEIVE QUEUE ELEMENT      02670000
         ISQE ,                   INTEGRATOR SESS INIT QUEUE ELEMENT    02680000
         IBQE ,                   INTEGRATOR BIND QUEUE ELEMENT         02690000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            02700000
         ITASK ,                  INTEGRATOR TASK BLOCK                 02710000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          02720000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       02730000
         EVCODES ,                INTEGRATOR EVENT CODES                02740000
         ABCODES ,                INTEGRATOR $ABEND CODES               02750000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     02760000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        02770000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             02780000
         $PROC DSECT=YES          INTEGRATOR $PROC SERVICES             02790000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             02800000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             02810000
         $SESSTMR DSECT=YES       INTEGRATOR $SESSTMR SERVICES          02820000
         $TIMER DSECT=YES         INTEGRATOR $TIMER SERVICES            02830000
         IFGEXLST ,               VTAM EXIT LIST                        02840000
         END   ,                                                        02850000

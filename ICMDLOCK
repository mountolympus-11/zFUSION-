         TITLE 'ICMDLOCK - LOCK STATISTICS'                             00010000
         #WORK ,                                                        00020000
*                                                                       00030000
REQFLAG  DS    X             REQUEST TYPE                               00040000
REQDISP  EQU   X'80'            DISPLAY                                 00050000
REQRESET EQU   X'40'            RESET                                   00060000
                                                                        00070000
RESERVED DS    XL3           RESERVED                                   00080000
                                                                        00090000
TOTAL#   DS    F             NUMBER OF LOCK BIDS                        00100000
WAITS    DS    F             NUMBER OF BIDS DEFERRED                    00110000
MAXQ     DS    F             LONGEST LOCK QUEUE OBSERVED                00120000
PCT      DS    F             PCT OF BIDS THAT REQUIRE DEFERAL           00130000
                                                                        00140000
WK256    DS    XL256         LARGE PLIST CONSTRUCTION, ETC.             00150000
         #ENDWORK ,          END WORKAREA                               00160000
                                                                        00170000
         EJECT                                                          00180000
         CMDREQ  ,           COMMAND REQUEST BLOCK                      00190000
         EJECT                                                          00200000
         CCSUMRY ,           COMMAND OPERAND PREPARSE SUMMARY           00210000
         EJECT                                                          00220000
         $LOCK   ,           LOCK                                       00230000
         EJECT                                                          00240000
         KEYCODES COMMANDSET=LOCK                                       00250000
*                                                                       00260000
         CMDCODES ,                                                     00270000
*                                                                       00280000
         EQUS  ,                                                        00290000
                                                                        00300000
         $MSGDFT PREFIX=ICTPID,COMPID='CMD',TABLE=*#MSGS,              X00310000
               CONID=*CMRQCNID,CONNAME=CMRQCNAM,CART=CMRQCART,         X00320000
               DESTADD=*CMRQDMSK,                                      X00330000
               MSGQA=*CMRQMQA,STGQH=*CMRQSTGQ,                         X00340000
               MF=(E,WK256),                                           X00350000
               PRINT=NOGEN                                              00360000
         EJECT                                                          00370000
                                                                        00380000
**<DOC-ON>*****************************************************         00390000
*                                                                       00400000
* ROUTINE: ICMDLOCK - LOCK STATISTICS                                   00410000
*                                                                       00420000
* DESCRIPTION:                                                          00430000
*                                                                       00440000
*                                                                       00450000
* SYNTAX:                                                               00460000
*                                                                       00470000
*    LOCK   DISPLAY /, RESET                                            00480000
*              D         E                                              00490000
*                                                                       00500000
*                                                                       00510000
* ON ENTRY:                                                             00520000
*                                                                       00530000
*    R1  ADDR OF COMMAND REQUEST BLOCK (CMDREQ) IN LOCAL                00540000
*        CMDPROC FORMAT                                                 00550000
*                                                                       00560000
**<DOC-OFF>****************************************************         00570000
                                                                        00580000
                                                                        00590000
***************************************************************         00600000
*                                                                       00610000
* MAINTENANCE:                                                          00620000
*                                                                       00630000
*    06/15/93 R. TURGEON                                                00640000
*             INITIAL VERSION                                           00650000
*                                                                       00660000
***************************************************************         00670000
                                                                        00680000
         EJECT ,                                                        00690000
ICMDLOCK #ENTER PREG=R8                                                 00700000
                                                                        00710000
         USING ICVT,R11                                                 00720000
         USING ITASK,R10                                                00730000
                                                                        00740000
*--------------------------------------------------------------         00750000
*    LOCATE COMMAND REQUEST BLOCK, COMMAND SUMMARY, AND OPS             00760000
*--------------------------------------------------------------         00770000
         USING CMDREQ,R8          COMMAND REQUEST BLOCK                 00780000
         ICM   R7,15,CMRQSMRY     ASSOC COMMAND SUMMARY                 00790000
         BZ    SCANEND            OPERANDS PROVIDED                     00800000
                                                                        00810000
         USING CCSUMRY,R7         COMMAND OPERAND SUMMARY FORMAT        00820000
         ICM   R5,15,CMRQSMR#     TOTAL NUMBER OF OPERAND ENTRIES       00830000
         BZ    SCANEND            TAKE DEFAULTS IF NOTE PROVIDED        00840000
         L     R6,CMRQOPST        OPERAND STRING ORIGIN                 00850000
                                                                        00860000
*--------------------------------------------------------------         00870000
*   IDENTIFY THE OPERANDS PROVIDED AND VALIDATE                         00880000
*--------------------------------------------------------------         00890000
PARSENXT DS    0H                                                       00900000
         CLC   CCSID,=AL2(LOCK_DISPLAY)                                 00910000
         BNE   *+8                                                      00920000
         OI    REQFLAG,REQDISP                                          00930000
                                                                        00940000
         CLC   CCSID,=AL2(LOCK_RESET)                                   00950000
         BNE   *+8                                                      00960000
         OI    REQFLAG,REQRESET                                         00970000
                                                                        00980000
         LA    R15,CCSVSLN        LENGTH OF EACH VALUE ENTRY            00990000
         MH    R15,CCSVALCT       TOTAL SIZE CONSUMED BY VALUES         01000000
         LA    R7,CCSUMRY+CCSPFXL(R15)                                  01010000
         BCT   R5,PARSENXT        EXAMINE ALL OPERANDS                  01020000
         DROP  R7                 CCSUMRY                               01030000
                                                                        01040000
*--------------------------------------------------------------         01050000
*   PARSE COMPLETE, ASSIGN DEFAULTS IF NECESSARY                        01060000
*--------------------------------------------------------------         01070000
SCANEND  DS    0H                                                       01080000
         CLI   REQFLAG,0          OPERANDS PROVIDED?                    01090000
         BNE   *+8                SKIP IF SO                            01100000
         OI    REQFLAG,REQDISP    DISPLAY                               01110000
                                                                        01120000
         EJECT ,                                                        01130000
***************************************************************         01140000
*                                                                       01150000
*   LOCK DISPLAY                                                        01160000
*                                                                       01170000
***************************************************************         01180000
         TM    REQFLAG,REQDISP    DISPLAY REQUEST?                      01190000
         BNO   DISPFIN            SKIP IF NOT                           01200000
                                                                        01210000
         L     R7,ICTLK@          LOCK LIST                             01220000
         USING LOCK,R7                                                  01230000
                                                                        01240000
*--------------------------------------------------------------         01250000
*   EXTRACT VOLITILE LOCK COUNTERS IN SAFE SEQUENCE                     01260000
*--------------------------------------------------------------         01270000
DISPNEXT DS    0H                                                       01280000
         ICM   R0,15,LOCKREQS     LOCK BID COUNT                        01290000
         BM    DISPRSET           FORCE RESET WHEN APPROACHING OVFLW    01300000
         ST    R0,TOTAL#          LOCAL COPY                            01310000
                                                                        01320000
         ICM   R0,15,LOCKDEFS     LOCK BID DEFERRALS                    01330000
         BM    DISPRSET           FORCE RESET WHEN APPROACHING OVFLW    01340000
         ST    R0,WAITS           LOCAL COPY                            01350000
                                                                        01360000
         L     R0,LOCKMAXQ        MAX QUEUE DEPTH                       01370000
         ST    R0,MAXQ            LOCAL COPY                            01380000
                                                                        01390000
*--------------------------------------------------------------         01400000
*   FORMAT DISPLAY LINE FOR CURRENT LOCK                                01410000
*--------------------------------------------------------------         01420000
         ICM   R2,15,TOTAL#       TOTAL BIDS FOR LOCK                   01430000
         ST    R2,PCT             CLEAR PCT IF ZERO                     01440000
         BZ    DISPNPCT           AVOID ZERO DIVIDE                     01450000
         L     R1,WAITS           TOTAL DEFERALS                        01460000
         M     R0,=F'100'         CONVERT TO PERCENT                    01470000
         DR    R0,R2              COMPUTE                               01480000
         ST    R1,PCT             SAVE RESULT                           01490000
                                                                        01500000
DISPNPCT DS    0H                                                       01510000
         $MSG  250,FIELDS=((LOCKNAME,4),PCT,MAXQ,TOTAL#)                01520000
                                                                        01530000
*--------------------------------------------------------------         01540000
*   ADVANCE TO NEXT LOCK                                                01550000
*--------------------------------------------------------------         01560000
         ICM   R7,15,LOCKLINK     ADVANCE TO NEXT LOCK                  01570000
         BNZ   DISPNEXT           AGAIN                                 01580000
         B     DISPFIN                                                  01590000
                                                                        01600000
DISPRSET DS    0H                 FORCE LOCK RESET                      01610000
         OI    REQFLAG,REQRESET                                         01620000
                                                                        01630000
DISPFIN  DS    0H                 LOCK DISPLAY COMPLETE                 01640000
         DROP  R7                 LOCK                                  01650000
                                                                        01660000
         EJECT ,                                                        01670000
***************************************************************         01680000
*                                                                       01690000
*   LOCK RESET                                                          01700000
*                                                                       01710000
***************************************************************         01720000
         TM    REQFLAG,REQRESET   RESET REQUEST?                        01730000
         BNO   RESETFIN           SKIP IF NOT                           01740000
                                                                        01750000
         L     R7,ICTLK@          LOCK LIST                             01760000
         USING LOCK,R7                                                  01770000
                                                                        01780000
RESETNXT DS    0H                                                       01790000
         SR    R0,R0              PREPARE FOR RX RESET                  01800000
         ST    R0,LOCKREQS                                              01810000
         ST    R0,LOCKDEFS                                              01820000
         ST    R0,LOCKMAXQ                                              01830000
                                                                        01840000
         ICM   R7,15,LOCKLINK     ADVANCE TO NEXT LOCK                  01850000
         BNZ   RESETNXT           AGAIN                                 01860000
                                                                        01870000
         $MSG  251                                                      01880000
                                                                        01890000
RESETFIN DS    0H                 LOCK DISPLAY COMPLETE                 01900000
         DROP  R7                 LOCK                                  01910000
                                                                        01920000
         EJECT ,                                                        01930000
***************************************************************         01940000
*                                                                       01950000
*   RETURN COMPLETION STATUS TO REQUESTOR                               01960000
*                                                                       01970000
***************************************************************         01980000
         LA    R15,CCODE_NORESP   NO ADDITIONAL RESPONSE REQUIRED       01990000
         ST    R15,CMRQCOMP       POST COMPLETION CODE PER CONVENTION   02000000
                                                                        02010000
         #EXIT ,                                                        02020000
                                                                        02030000
         EJECT ,                                                        02040000
***************************************************************         02050000
*                                                                       02060000
*   LOCAL READ/ONLY DATA AREAS, ETC.                                    02070000
*                                                                       02080000
***************************************************************         02090000
         LTORG ,                                                        02100000
                                                                        02110000
         PRINT NOGEN                                                    02120000
         ICVT  ,                                                        02130000
         ITASK ,                                                        02140000
         END   ,                                                        02150000

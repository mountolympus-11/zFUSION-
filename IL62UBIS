IL62UBIS TITLE 'INTEGRATOR - IVUSER LU6.2 BIS PROCESSING'               00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: IL62UBIS - IVUSER LU6.2 BIS PROCESSING                       00100000
*                                                                       00110000
* DESCRIPTION:                                                          00120000
*                                                                       00130000
* ON ENTRY:                                                             00140000
*                                                                       00150000
*    R15 = ENTRY POINT ADDRESS                                          00160000
*    R14 = RETURN ADDRESS                                               00170000
*    R13 = AVAILABLE SAVE AREA                                          00180000
*    R11 = ICVT ADDRESS                                                 00190000
*    R10 = ITASK ADDRESS                                                00200000
*    R09 = IVTAMCVT ADDRESS                                             00210000
*    R08 = IVUSER ADDRESS                                               00220000
*    R01 = ADDRESS OF LU6.2 BIS REQ/RSP WORK ELEMENT                    00230000
*                                                                       00240000
* ON EXIT:                                                              00250000
*                                                                       00260000
*    R15 = 0                                                            00270000
*    R00 = 0                                                            00280000
*    R01 = 0                                                            00290000
*                                                                       00300000
*    ALL OTHER REGISTERS ARE RESTORED.                                  00310000
*                                                                       00320000
**<DOC-OFF>************************************************************ 00330000
                                                                        00340000
         EJECT ,                                                        00350000
*********************************************************************** 00360000
*                                                                       00370000
* MAINTENANCE:                                                          00380000
*                                                                       00390000
*   09/01/94 RANDY WITEK - LU6.2 SUPPORT                                00400000
*                                                                       00410000
*********************************************************************** 00420000
                                                                        00430000
         EQUS  ,                  GENERAL EQUATES                       00440000
                                                                        00450000
RICVT    EQU   R11                                                      00460000
RITASK   EQU   R10                                                      00470000
RIVTAM   EQU   R9                                                       00480000
RIVUSER  EQU   R8                                                       00490000
RIWE     EQU   R7                                                       00500000
RISESS   EQU   R6                                                       00510000
RMDE     EQU   R5                                                       00520000
                                                                        00530000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00540000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00550000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00560000
         USING IVUSER,RIVUSER     ESTABLISH ADDRESSABILITY              00570000
         USING IWEVTAM,RIWE       ESTABLISH ADDRESSABILITY              00580000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00590000
         USING MDE,RMDE           ESTABLISH ADDRESSABILITY              00600000
                                                                        00610000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00620000
WRK256   DS    XL256              GENERAL WORKAREA                      00630000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00640000
$SESSMFL $SESS MF=L               PLIST CONSTRUCTION                    00650000
$WUMFL   $WULOC MF=L              PLIST CONSTRUCTION                    00660000
L62MFL   L62POST MF=L             PLIST CONSTRUCTION                    00670000
L62RETRC DS    F                  LU6.2 RETURN CODE RETURN AREA         00680000
WUDATA   DS    XL16               WULOC RETURN AREA                     00690000
RETR15   DS    F                                                        00700000
RETR0    DS    F                                                        00710000
RETR1    DS    F                                                        00720000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00730000
FLAG     DS    X                                                        00740000
FLAGLOCK EQU   X'80'                                                    00750000
FLAGLCKD EQU   X'40'                                                    00760000
FLAGDLCK EQU   X'20'              DISP LOCK HELD                        00770000
FLAGDLKD EQU   X'10'              DISP LOCK HELD ON ENTRY               00780000
                                                                        00790000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00800000
                                                                        00810000
         $MSGDFT PREFIX=ICTPID,                                        +00820000
               COMPID='L62',                                           +00830000
               TABLE=*#MSGS,                                           +00840000
               WORKA=0,                                                +00850000
               MF=(E,WRK256),                                          +00860000
               PRINT=NOGEN                                              00870000
                                                                        00880000
IL62UBIS #ENTER BASE=R12,         ENTRY LINKAGE                        +00890000
               PREG=RIWE,                                              +00900000
               AMODE=31,                                               +00910000
               RMODE=ANY                                                00920000
                                                                        00930000
*---------------------------------------------------------------------- 00940000
* ESTABLISH ENVIRONMENT                                                 00950000
*---------------------------------------------------------------------- 00960000
                                                                        00970000
         BAS   R14,VTAMLOCK       SERIALIZE                             00980000
                                                                        00990000
         L     RMDE,IWEY3MDE      ASSOCIATED MDE ADDRESS                01000000
         CLC   MDEID,=CL8'MDE'    DOES IT LOOK RIGHT?                   01010000
         BNE   ERRENVIR           BRANCH IF NOT                         01020000
                                                                        01030000
         $SESS $SESS_FIND_SESSION,                                     +01040000
               SESSION=IWEY3TKN,                                       +01050000
               ERRET=NOSESS,                                           +01060000
               MF=(E,$SESSMFL)    LOCATE ASSOCIATED ISESS               01070000
                                                                        01080000
X        USING SPLIST,$SESSMFL                                          01090000
         L     RISESS,X.SPLAREA   ADDRESS OF ASSOCIATED ISESS BLOCK     01100000
         DROP  X                                                        01110000
                                                                        01120000
         C     RMDE,ISE62MDE      IS MDE LINKED TO ISESS?               01130000
         BNE   ERRENVIR           BRANCH IF NOT                         01140000
                                                                        01150000
*---------------------------------------------------------------------- 01160000
* DETERMINE IF REQUEST/RESPONSE WAS SENT/RECEIVED                       01170000
*---------------------------------------------------------------------- 01180000
                                                                        01190000
         TM    IY3F1,IY3F1RSP     IS THIS A RSP OR REQ?                 01200000
         BO    RSP                BRANCH IF RSP                         01210000
         TM    IY3F1,IY3F1SNT     WAS REQ SENT?                         01220000
         BO    BIQSENT            BRANCH IF SENT                        01230000
         B     BIQRCVD            BRANCH IF RECEIVED                    01240000
                                                                        01250000
RSP      DS    0H                                                       01260000
                                                                        01270000
         TM    IY3F1,IY3F1SNT     WAS RSP SENT?                         01280000
         BO    BIRSENT            BRANCH IF SENT                        01290000
         B     BIRRCVD            BRANCH IF RECEIVED                    01300000
                                                                        01310000
*---------------------------------------------------------------------- 01320000
* BIS REQUEST RECEIVED                                                  01330000
*---------------------------------------------------------------------- 01340000
                                                                        01350000
BIQRCVD  DS    0H                                                       01360000
                                                                        01370000
         OI    ISE62FL3,ISE62BQR  BIS REQUEST RECEIVED                  01380000
                                                                        01390000
         TM    ISE62FL3,ISE62TRM  IS TERMINATION ALREADY PENDING?       01400000
         BO    BIQRNOUP           BRANCH YES TO SKIP COUNT UPDATES      01410000
         OI    ISE62FL3,ISE62TRM  SESSION IS PENDING TERMINATION        01420000
         LA    R15,MDEPTCW        PENDING TERM CONWINNER COUNT          01430000
         TM    ISEF2,ISEF2WIN     IS THIS A CONWINNER?                  01440000
         BO    *+8                BRANCH IF YES                         01450000
         LA    R15,MDEPTCL        PENDING TERM CONLOSER COUNT           01460000
         L     R14,0(,R15)        CURRENT WIN/LOSE PEND TERM COUNT      01470000
         A     R14,=F'1'          ADD ONE                               01480000
         BNP   ERRENVIR           BRANCH IF COUNT IS BAD                01490000
         ST    R14,0(,R15)        SET UPDATED PENDING TERM WIN/LOSE CNT 01500000
                                                                        01510000
BIQRNOUP DS    0H                                                       01520000
                                                                        01530000
         TM    ISE62FL3,ISE62BQS  WAS A BIS REQUEST SENT? (RACE)        01540000
         BO    ENDSESS            BRANCH IF YES, ALL DONE               01550000
         ICM   R1,15,ISE62FSN     IS IT ON THE FREE QUEUE?              01560000
         BZ    RETURN             EXIT IF NOT                           01570000
         TM    ISE62FL2,ISE62BID  IS A BID IN PROGRESS?                 01580000
         BO    RETURN             EXIT IF YES                           01590000
                                                                        01600000
         $VTAMWE L'IWEY3,         LENGTH                               +01610000
               IWECBISR           CODE                                  01620000
                                                                        01630000
X        USING IWEVTAM,R1                                               01640000
         OI    X.IY3F1,IY3F1RSP   SEND BIS RESPONSE                     01650000
         OI    X.IY3F1,IY3F1SNT   SEND BIS RESPONSE                     01660000
         ST    RMDE,X.IWEY3MDE    PASS THE MDE ADDRESS                  01670000
         MVC   X.IWEY3NME,MDENAME PASS THE MODE NAME                    01680000
         MVC   X.IWEY3TKN,ISETK   PASS THE SESSION TOKEN                01690000
         DROP  X                                                        01700000
                                                                        01710000
         LA    R0,ISEWEQ          QUEUE ADDRESS                         01720000
         BAS   R14,QWE            QUEUE THE WORK ELEMENT                01730000
         B     RETURN                                                   01740000
                                                                        01750000
*---------------------------------------------------------------------- 01760000
* BIS RESPONSE RECEIVED                                                 01770000
*---------------------------------------------------------------------- 01780000
                                                                        01790000
BIRRCVD  DS    0H                                                       01800000
                                                                        01810000
         OI    ISE62FL3,ISE62BRR  BIS RESPONSE RECEIVED                 01820000
         B     ENDSESS            ALL DONE                              01830000
                                                                        01840000
*---------------------------------------------------------------------- 01850000
* BIS REQUEST SENT                                                      01860000
*---------------------------------------------------------------------- 01870000
                                                                        01880000
BIQSENT  DS    0H                                                       01890000
                                                                        01900000
         OI    ISE62FL3,ISE62BQS  BIS REQUEST SENT                      01910000
         TM    ISE62FL3,ISE62BRR  WAS A BID RESPONSE RECEIVED ALREADY?  01920000
         BO    ENDSESS            BRANCH IF YES, ALL DONE               01930000
         B     RETURN                                                   01940000
                                                                        01950000
*---------------------------------------------------------------------- 01960000
* BIS RESPONSE SENT                                                     01970000
*---------------------------------------------------------------------- 01980000
                                                                        01990000
BIRSENT  DS    0H                                                       02000000
                                                                        02010000
         OI    ISE62FL3,ISE62BRS  BIS RESPONSE SENT                     02020000
         B     RETURN                                                   02030000
                                                                        02040000
*---------------------------------------------------------------------- 02050000
* END THE SESSION                                                       02060000
*---------------------------------------------------------------------- 02070000
                                                                        02080000
ENDSESS  DS    0H                                                       02090000
                                                                        02100000
         $VTAMWE L'IWEXH,         LENGTH                               +02110000
               IWECENDS           CODE                                  02120000
                                                                        02130000
         LA    R0,ISEWEQ          QUEUE ADDRESS                         02140000
         BAS   R14,QWE            QUEUE THE WORK ELEMENT                02150000
         B     RETURN                                                   02160000
                                                                        02170000
*---------------------------------------------------------------------- 02180000
* SESSION ASSOCIATED WITH REQUEST COULD NOT BE FOUND                    02190000
*---------------------------------------------------------------------- 02200000
                                                                        02210000
NOSESS   DS    0H                                                       02220000
                                                                        02230000
         $MSG  979,                     "BIS-REQ/RESP IGNORED..."      +02240000
               FIELDS=((REQTEXT,L'REQTEXT),                            +02250000
               (IWEY3TKN,4),            SESSION TOKEN                  +02260000
               (IWEY3TKN+4,4))          SESSION TOKEN                   02270000
                                                                        02280000
         B      RETURN                                                  02290000
                                                                        02300000
*---------------------------------------------------------------------- 02310000
* RETURN TO CALLER                                                      02320000
*---------------------------------------------------------------------- 02330000
                                                                        02340000
RETURN   DS    0H                                                       02350000
                                                                        02360000
         BAS   R14,VTAMUNLK       SERIALIZE                             02370000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 02380000
                                                                        02390000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    02400000
                                                                        02410000
*---------------------------------------------------------------------- 02420000
* SUBROUTINE QWE - QUEUE A WORK ELEMENT TO A GIVEN WORK QUEUE           02430000
*                                                                       02440000
* ENTRY            R14 = RETURN ADDRESS                                 02450000
*                  R1  = WORK ELEMENT ADDRESS                           02460000
*                  R0  = QUEUE ADDRESS                                  02470000
*                                                                       02480000
* RETURNS          R15 = 0 --> QUEUEING WAS SUCCESSFUL                  02490000
*                      = 4 --> QUEUEING FAILED, WORK ELEMENT RELEASED   02500000
*---------------------------------------------------------------------- 02510000
                                                                        02520000
QWE      DS    0H                                                       02530000
                                                                        02540000
         STM   R14,R4,SUB0SAVE    SAVE REGISTERS                        02550000
         LR    R3,R0              SAVE QUEUE ADDRESS                    02560000
         LR    R4,R1              SAVE WORK ELEMENT ADDRESS             02570000
                                                                        02580000
         $VTAMQ (R4),             WORK ELEMENT                         +02590000
               (R3)               QUEUE                                 02600000
                                                                        02610000
         L     R14,SUB0SAVE       RESTORE REGISTERS                     02620000
         LM    R0,R4,SUB0SAVE+8   RESTORE REGISTERS                     02630000
         BR    R14                AND RETURN TO CALLER W/R15            02640000
                                                                        02650000
*---------------------------------------------------------------------- 02660000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 02670000
*---------------------------------------------------------------------- 02680000
                                                                        02690000
VTAMLOCK DS    0H                                                       02700000
                                                                        02710000
         TM    FLAG,FLAGLOCK        WAS THE LOCK ALREADY OBTAINED?      02720000
         BOR   R14                  RETURN IF YES                       02730000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             02740000
                                                                        02750000
         $SER  OBTAIN,                                                 +02760000
               VTAM                                                     02770000
                                                                        02780000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              02790000
         BNE   VTAMLOEX             BRANCH IF NOT                       02800000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         02810000
                                                                        02820000
VTAMLOEX DS    0H                                                       02830000
                                                                        02840000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               02850000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          02860000
         BR    R14                  RETURN                              02870000
                                                                        02880000
*---------------------------------------------------------------------- 02890000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                02900000
*---------------------------------------------------------------------- 02910000
                                                                        02920000
VTAMUNLK DS    0H                                                       02930000
                                                                        02940000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       02950000
         BNOR  R14                  BRANCH IF NOT                       02960000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             02970000
         BOR   R14                  DON'T RELEASE IF IT WAS             02980000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             02990000
                                                                        03000000
         $SER  RELEASE,                                                +03010000
               VTAM                                                     03020000
                                                                        03030000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  03040000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          03050000
         BR    R14                  RETURN                              03060000
                                                                        03070000
*---------------------------------------------------------------------- 03080000
* ERROR ROUTINES                                                        03090000
*---------------------------------------------------------------------- 03100000
                                                                        03110000
ERRENVIR DS    0H                                                       03120000
                                                                        03130000
         $ABEND ABE_VTDIAG,                                            +03140000
               SCOPE=PCB,                                              +03150000
               TITLE='ENVIRONMENT ERROR'                                03160000
                                                                        03170000
*---------------------------------------------------------------------- 03180000
*  CONSTANTS AND LITERALS                                               03190000
*---------------------------------------------------------------------- 03200000
                                                                        03210000
REQTEXT  DC     C'BIS-REQ/RESP'                                         03220000
                                                                        03230000
         LTORG ,                                                        03240000
         PRINT NOGEN                                                    03250000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                03260000
         ISTDBIND ,               VTAM BIND IMAGE                       03270000
         TRACODES ,               INTEGRATOR TRACE CODES                03280000
         ICVT  ,                  INTEGRATOR CVT                        03290000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   03300000
         IRPL ,                   INTEGRATOR VTAM RPL+                  03310000
         IACB ,                   INTEGRATOR VTAM ACB+                  03320000
         INIB ,                   INTEGRATOR VTAM NIB+                  03330000
         ISESS ,                  INTEGRATOR SESSION BLOCK              03340000
         IRQE ,                   INTEGRATOR RECEIVE QUEUE ELEMENT      03350000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            03360000
         ITASK ,                  INTEGRATOR TASK BLOCK                 03370000
         IPCB ,                   INTEGRATOR PROCESS BLOCK              03380000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          03390000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       03400000
         EVCODES ,                INTEGRATOR EVENT CODES                03410000
         ABCODES ,                INTEGRATOR $ABEND CODES               03420000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     03430000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        03440000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             03450000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             03460000
         $WULOC DSECT=YES         INTEGRATOR $WULOC SERVICES            03470000
         IFGEXLST ,               VTAM EXIT LIST                        03480000
         END   ,                                                        03490000

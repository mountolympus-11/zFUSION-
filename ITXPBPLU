ITXPBPLU TITLE '- BOUND POINTER LIST ADD / REMOVE'                      00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: ITXPBPLU - BOUND POINTER LIST ADD / REMOVE                   00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THIS ROUTINE IS USED TO MANAGE THE "BOUND POINTER LIST"            00080000
*    USED TO PROVIDE POINTER RELOCATION WHEN A TXP BUFFER               00090000
*    IS EXPANDED.  THE USER ADDS AND REMOVES THE POINTERS               00100000
*    USING $XPBUFR ADDPTR/REMPTR REQUESTS.                              00110000
*                                                                       00120000
*    NOTE THAT NO ATTEMPT IS MADE TO PREVENT THE ADDITION OF            00130000
*    DUPLICATE PTRS.  THIS ALLOWS SUBROUTINES TO ADD AND                00140000
*    REMOVE PTRS MAINTAINED IN COMMON STORAGE REGARDLESS                00150000
*    OF PTR SHARING.                                                    00160000
*                                                                       00170000
* FUTURE:                                                               00180000
*                                                                       00190000
*    THE BPL IS LIMITTED TO FOUR ENTRIES CURRENTLY MAINTAINED           00200000
*    IN THE TXP PREFIX (TXPHDR).  FUTURE VERSIONS CAN EXPAND            00210000
*    THE BPL TO A VARIABLE LENGTH LIST EXTENDED WITH THE                00220000
*    ASSISTANCE OF $REALLOC.                                            00230000
*                                                                       00240000
*                                                                       00250000
* ON ENTRY:                                                             00260000
*                                                                       00270000
*    R1  CONTAINS THE ADDR OF A PARAMETER LIST CONSTRUCTED AS           00280000
*        FOLLOWS:                                                       00290000
*                                                                       00300000
*        +00 - POINTER DECLARATION SUBFUNCTION CODE                     00310000
*                                                                       00320000
*              ZERO    - ADD                                            00330000
*              NONZERO - REMOVE                                         00340000
*                                                                       00350000
*        +04 - PTR COUNT OR ZERO IF 'REMOVE ALL'                        00360000
*        +08 - PTR LIST ORIGIN, OCCURS DEPENDING ON COUNT               00370000
*                                                                       00380000
*                                                                       00390000
* ON EXIT:                                                              00400000
*                                                                       00410000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES                     00420000
*                                                                       00430000
*        RC00 - REQUEST COMPLETED WITHOUT ERROR                         00440000
*                                                                       00450000
*        RC08 - A REMOVE OPERATION WAS REQUESTED, BUT AT LEAST          00460000
*               ONE OF THE PTRS PROVIDED WAS NOT FOUND ON THE           00470000
*               BOUND PTR LIST, OR                                      00480000
*                                                                       00490000
*               AN ADD OPERATION WAS REQUESTED, BUT THE NUMBER          00500000
*               OF PTRS PROVIDED EXCEEDS THE (REMAINING) CAPACITY       00510000
*               OF THE BOUND PTR LIST                                   00520000
*                                                                       00530000
*        RC12 - IMPROPER REQUEST                                        00540000
*                                                                       00550000
**<DOC-OFF>****************************************************         00560000
                                                                        00570000
         EJECT                                                          00580000
         TXPHDR ,                 TXP BUFFER / FUNCTION ARRAY FORMAT    00590000
                                                                        00600000
         EJECT                                                          00610000
         EQUS  ,                                                        00620000
                                                                        00630000
         EJECT                                                          00640000
ITXPBPLU #ENTER PREG=R8,SAVE=NO                                         00650000
                                                                        00660000
         USING ITASK,R10          STDENV                                00670000
         USING IPCB,R9                                                  00680000
                                                                        00690000
         L     R9,TSKPCBC         PROCESS MODE                          00700000
                                                                        00710000
*--------------------------------------------------------------         00720000
*   ACCEPT PASSED PARAMETERS, DETERMINE REQUEST TYPE                    00730000
*--------------------------------------------------------------         00740000
         USING TXPHDR,R7          TXP BUFFER PREFIX                     00750000
                                                                        00760000
         ICM   R7,15,PCBXPBUF     TXB BUFFER ANCHOR                     00770000
         BNZ   BPL_CONT           LOCATED IN CURRENT PCB                00780000
         ICM   R9,15,PCBMPCB      ELSE EXAMINE PARENT PCB               00790000
         BZ    ERR_REQ            INVALID REQUEST IF NOT AVAILABLE      00800000
         ICM   R7,15,PCBXPBUF     TXB BUFFER ANCHOR IN PARENT PCB       00810000
         BZ    ERR_REQ            INVALID REQUEST                       00820000
                                                                        00830000
BPL_CONT DS    0H                                                       00840000
         L     R6,4(,R8)          R6 <== PTR REFERENCE COUNT            00850000
         LA    R5,8(,R8)          R5 <== PTR REFERENCE LIST ORIGIN      00860000
                                                                        00870000
         ICM   R0,15,0(R8)        DETERMINE SUBFUNCTION (ADD,REMOVE)    00880000
         BNZ   REMOVE             REMOVE PERFORMED ELSEWHERE            00890000
         DROP  R9                 IPCB                                  00900000
                                                                        00910000
         EJECT                                                          00920000
***************************************************************         00930000
*                                                                       00940000
*   ADD TO BOUND POINTER LIST                                           00950000
*                                                                       00960000
***************************************************************         00970000
         LTR   R6,R6              POINTERS PROVIDED?                    00980000
         BNP   ERR_REQ            INVALID REQUEST IF NOT                00990000
         C     R6,TXPRESL#        SUFFICIENT FREE SLOTS IN BPL?         01000000
         BH    ERR_OVFL           ERROR IF NOT                          01010000
                                                                        01020000
         L     R3,TXPREPTR        LOCATE BPL LIST ORIGIN                01030000
                                                                        01040000
*--------------------------------------------------------------         01050000
*   LOAD BOUND PTR INTO BPL SLOT ARRAY                                  01060000
*--------------------------------------------------------------         01070000
ADDSLOT  DS    0H                 LOCATE VACANT SLOT                    01080000
         ICM   R0,15,0(R3)        SLOT IS OPEN?                         01090000
         BZ    ADDFILL            INSERT ENTRY IF SO                    01100000
         LA    R3,4(,R3)          ELSE TRY NEXT SLOT                    01110000
         B     ADDSLOT            AGAIN                                 01120000
                                                                        01130000
ADDFILL  DS    0H                 CONSTRUCT BPL ENTRY                   01140000
         L     R1,0(,R5)          FETCH PTR                             01150000
         LA    R1,0(,R1)          SANITIZE                              01160000
         LTR   R1,R1              VALID PTR PROVIDED?                   01170000
         BZ    ADDADV             SKIP IF NOT                           01180000
         ST    R1,0(,R3)          SAVE PTR PTR                          01190000
                                                                        01200000
         L     R2,TXPRESL#        AVAILABLE SLOT COUNT                  01210000
         BCTR  R2,0               ACCOUNT FOR THIS ENTRY                01220000
         ST    R2,TXPRESL#        SAVE UPDATED VALUE                    01230000
                                                                        01240000
ADDADV   DS    0H                                                       01250000
         LA    R5,4(,R5)          ADVANCE TO NEXT CANDIDATE PTR         01260000
         BCT   R6,ADDSLOT         PROCESS NEXT PTR                      01270000
         LA    R15,RC00           INDICATE SUCCESS                      01280000
         B     STDRET             DONE                                  01290000
                                                                        01300000
         EJECT                                                          01310000
***************************************************************         01320000
*                                                                       01330000
*   REMOVE FROM BOUND POINTER LIST                                      01340000
*                                                                       01350000
***************************************************************         01360000
REMOVE   DS    0H                                                       01370000
         LTR   R6,R6              POINTERS PROVIDED?                    01380000
         BP    REMPTRS            SKIP TO DELETE INDIVIDUAL PTRS        01390000
                                                                        01400000
         L     R0,TXPREPTR        BPL ORIGIN                            01410000
         L     R1,TXPRELEN        BPL LENGTH IN BYTES                   01420000
         SR    R15,R15            PREPARE FOR CLEAR                     01430000
         MVCL  R0,R14             CLEAR                                 01440000
                                                                        01450000
         L     R2,TXPRELEN        LENGTH OF BPL                         01460000
         SRL   R2,2               TOTAL NUMBER OF SLOTS                 01470000
         ST    R2,TXPRESL#        RESET SLOT COUNT                      01480000
         LA    R15,RC00           INDICATE SUCCESS                      01490000
         B     STDRET             DONE                                  01500000
                                                                        01510000
*--------------------------------------------------------------         01520000
*   REMOVE PTRS IDENTIFIED IN PASSED LIST                               01530000
*--------------------------------------------------------------         01540000
REMPTRS  DS    0H                 LOCATE VACANT SLOT                    01550000
         LA    R15,RC00           ASSUME ALL PTRS WILL BE FOUND         01560000
                                                                        01570000
REMNEXT  DS    0H                                                       01580000
         L     R1,0(,R5)          FETCH PTR                             01590000
         LA    R1,0(,R1)          SANITIZE                              01600000
         LTR   R1,R1              VALID PTR PROVIDED?                   01610000
         BZ    REMADV             SKIP IF NOT                           01620000
                                                                        01630000
         L     R3,TXPREPTR        LOCATE BPL LIST ORIGIN                01640000
         L     R4,TXPRELEN        LENGTH OF LIST                        01650000
         SRL   R4,2               NUMBER OF SLOTS                       01660000
                                                                        01670000
REMSCAN  DS    0H                                                       01680000
         C     R1,0(,R3)          MATCHING ENTRY?                       01690000
         BE    REMCLR             REMOVE IT IF SO                       01700000
         LA    R3,4(,R3)          ELSE ADVANCE TO NEXT BPL ENTRY        01710000
         BCT   R4,REMSCAN         CONTINUE SCAN                         01720000
         LA    R15,RC04           GIVEN PTR HAS NO BPL EQUIVALENT       01730000
         B     REMADV             TRY NEXT ENTRY                        01740000
                                                                        01750000
REMCLR   DS    0H                                                       01760000
         XC    0(4,R3),0(R3)      CLEAR BPL ENTRY                       01770000
         L     R2,TXPRESL#        NUMBER OF FREE SLOTS                  01780000
         LA    R2,1(,R2)          GREW                                  01790000
         ST    R2,TXPRESL#                                              01800000
                                                                        01810000
REMADV   DS    0H                 ADVANCE TO NEXT REMOVABLE PTR         01820000
         LA    R5,4(,R5)          NEXT SLOT                             01830000
         BCT   R6,REMNEXT         PROCESS NEXT PTR                      01840000
         B     STDRET                                                   01850000
                                                                        01860000
         EJECT                                                          01870000
***************************************************************         01880000
*                                                                       01890000
*   RETURN COMPLETION STATUS TO REQUESTOR                               01900000
*                                                                       01910000
***************************************************************         01920000
ERR_REQ  DS    0H                 IMPROPER REQUEST                      01930000
         LA    R15,RC12           ERROR                                 01940000
         B     STDRET                                                   01950000
                                                                        01960000
ERR_OVFL DS    0H                 ADD - BPL OVERFLOW                    01970000
         LA    R15,RC08                                                 01980000
                                                                        01990000
STDRET   DS    0H                                                       02000000
         #EXIT ,                  REQUEST COMPLETE                      02010000
                                                                        02020000
         EJECT                                                          02030000
***************************************************************         02040000
*                                                                       02050000
*   LOCAL READ/ONLY STORAGE AREAS                                       02060000
*                                                                       02070000
***************************************************************         02080000
         LTORG ,                                                        02090000
                                                                        02100000
         PRINT NOGEN                                                    02110000
         ICVT  ,                                                        02120000
         ITASK ,                                                        02130000
         IPCB  ,                                                        02140000
         END   ,                                                        02150000

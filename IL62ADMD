IL62ADMD TITLE 'INTEGRATOR - LU6.2 DEFINE MODE'                         00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: IL62ADMD - LU6.2 DEFINE MODE                                 00100000
*                                                                       00110000
* DESCRIPTION:                                                          00120000
*                                                                       00130000
*    THIS ROUTINE IS CALLED TO CREATE A MODE BLOCK AND ADD IT TO THE    00140000
*    MODE_LIST OF A SPECIFIC PARTNER_LU (I.E. IVUSER).                  00150000
*                                                                       00160000
* ON ENTRY:                                                             00170000
*                                                                       00180000
*    R15 = ENTRY POINT ADDRESS                                          00190000
*    R14 = RETURN      ADDRESS                                          00200000
*    R13 = SAVE AREA   ADDRESS                                          00210000
*    R01 = PARM LIST   ADDRESS                                          00220000
*                                                                       00230000
*          +00 = ADDRESS OF PLB (IVUSER)                                00240000
*          +04 = ADDRESS OF MODE NAME (MAX LENGTH 8 CHARACTERS)         00250000
*          +08 = ADDRESS OF MODE NAME LENGTH                            00260000
*          +0C = ADDRESS OF MDE RETURN AREA                             00270000
*          +10 = ADDRESS OF RETURN CODE AREA                            00280000
*                                                                       00290000
* ON EXIT:                                                              00300000
*                                                                       00310000
*    R15 = 0                                                            00320000
*                                                                       00330000
*    RETURN_CODE = LU62_OK --> MDE SUCCESSFULLY DEFINED                 00340000
*                                                                       00350000
*                = LU62_PARAMETER_ERROR --> IVUSER/MODE NAME ERROR      00360000
*                = LU62_PRODUCT_SPECIFIC_ERROR --> MDE ALREADY EXISTS   00370000
*                                                                       00380000
**<DOC-OFF>************************************************************ 00390000
         EJECT ,                                                        00400000
*********************************************************************** 00410000
*                                                                       00420000
* MAINTENANCE:                                                          00430000
*                                                                       00440000
*   07/01/94 RANDY WITEK                                                00450000
*                                                                       00460000
*********************************************************************** 00470000
                                                                        00480000
         EQUS  ,                  GENERAL EQUATES                       00490000
                                                                        00500000
RICVT    EQU   R11                                                      00510000
RITASK   EQU   R10                                                      00520000
RBASE    EQU   R9                                                       00530000
RIVTAM   EQU   R8                                                       00540000
RIVUSER  EQU   R7                                                       00550000
RMDE     EQU   R6                                                       00560000
RPLIST   EQU   R5                                                       00570000
                                                                        00580000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00590000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00600000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00610000
         USING IVUSER,RIVUSER     ESTABLISH ADDRESSABILITY              00620000
         USING MDE,RMDE           ESTABLISH ADDRESSABILITY              00630000
         USING L62LIST,RPLIST     ESTABLISH ADDRESSABILITY              00640000
                                                                        00650000
         COPY  CRAB               "C" RUNTIME ANCHOR BLOCK              00660000
         USING CRAB,R12           ADDRESSABILITY                        00670000
                                                                        00680000
         COPY  DSA                DYNAMIC SAVE AREA                     00690000
WORKAREA DS    0H                 READ/WRITE WORKAREA                   00700000
WRK256   DS    XL256              GENERAL WORKAREA                      00710000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00720000
MODENM@  DS    A                  ADDRESS OF MODE NAME                  00730000
MODENMLN DS    F                  LENGTH OF MODE NAME                   00740000
WRKLOCAL DS    CL8                WORKING COPY OF MODE NAME             00750000
RETCODE  DS    F                  TEMPORARY RETURN CODE AREA            00760000
FLAG     DS    X                                                        00770000
FLAGLOCK EQU   X'80'                                                    00780000
FLAGLCKD EQU   X'40'                                                    00790000
FLAGFMDE EQU   X'20'              THIS IS THE FIRST MODE                00800000
WORKLEN  EQU   *-WORKAREA         LENGTH OF USER DSA AREA               00810000
DSALEN   EQU   *-DSA              LENGTH OF DSA                         00820000
                                                                        00830000
         $MSGDFT PREFIX=ICTPID,                                        +00840000
               COMPID='L62',                                           +00850000
               TABLE=*#MSGS,                                           +00860000
               WORKA=0,                                                +00870000
               MF=(E,WRK256),                                          +00880000
               PRINT=NOGEN                                              00890000
                                                                        00900000
IL6ADMD@ CSECT ,                                                        00910000
IL62ADMD CENTRY DSA=DSALEN,BASE=R9,INDEP=YES                            00920000
                                                                        00930000
         USING DSA,R13            ADDRESSABILITY                        00940000
         LR    RPLIST,R1          SAVE ADDRESS OF PLIST                 00950000
                                                                        00960000
         LA    R0,WORKAREA        ADDRESS OF USER DSA SECTION           00970000
         LA    R1,WORKLEN         LENGTH  OF USER DSA SECTION           00980000
         SR    R15,R15            PREPARE FOR CLEAR                     00990000
         MVCL  R0,R14             CLEAR USER DSA SECTION                01000000
                                                                        01010000
*---------------------------------------------------------------------- 01020000
* INITIALIZATION                                                        01030000
*---------------------------------------------------------------------- 01040000
                                                                        01050000
         @RESTENV ,               ENSURE ENVIRONMENT                    01060000
                                                                        01070000
         L     RIVTAM,ICTVTCVT    ESTABLISH IVTAMCVT POINTER            01080000
         USING IVTAMCVT,RIVTAM    ADDRESSABILITY                        01090000
         L     RIVUSER,L62PARM1   IVUSER/PLB ADDRESS                    01100000
         SR    RMDE,RMDE          NO MDE YET                            01110000
         L     R2,L62PARM2        MODE NAME ADDRESS                     01120000
         L     R3,L62PARM3        MODE NAME LENGTH ADDRESS              01130000
         L     R3,0(,R3)          MODE NAME LENGTH                      01140000
         ST    R2,MODENM@         SAVE THE ADDRESS                      01150000
         ST    R3,MODENMLN        SAVE THE LENGTH                       01160000
         MVC   WRKLOCAL,=CL8' '   BLANK WORKING COPY OF MODE NAME       01170000
         LTR   R14,R2             MODE NAME                             01180000
         BNP   INITEND            BRANCH IF NOT OK                      01190000
         LTR   R15,R3             MODE NAME LENGTH                      01200000
         BNP   INITEND            BRANCH IF NOT OK                      01210000
         ICM   R15,B'1000',=C' '  PAD WITH A BLANK IF NECESSARY         01220000
         LA    R2,WRKLOCAL        COPY-TO ADDRESS                       01230000
         LA    R3,8               COPY-TO LENGTH                        01240000
         MVCL  R2,R14             COPY MODE NAME                        01250000
                                                                        01260000
INITEND  DS    0H                                                       01270000
                                                                        01280000
*---------------------------------------------------------------------- 01290000
* ENTRY TRACE                                                           01300000
*---------------------------------------------------------------------- 01310000
                                                                        01320000
         $TRACE *=A(TRC_LU62_IL62ADMD),48 TRACE ENTRY W/ 48 USER BYTES  01330000
         BNZ   NOETRACE                   BRANCH IF NOT TRACING         01340000
         $APITRC IL62ADMD                 TRACE COMMON STUFF            01350000
         ST    RPLIST,24(,R1)             TRACE PARMLIST ADDRESS        01360000
         ST    RIVUSER,28(,R1)            TRACE IVUSER/PLB ADDRESS      01370000
         LTR   RIVUSER,RIVUSER            IS IVUSER POINTER OK?         01380000
         BZ    *+10                       BRANCH IF NOT                 01390000
         MVC   32(8,R1),IVULOCAL          TRACE PARTNER LU NAME         01400000
         MVC   40(8,R1),WRKLOCAL          TRACE MODE       NAME         01410000
NOETRACE DS    0H                                                       01420000
                                                                        01430000
*---------------------------------------------------------------------- 01440000
* SEE IF THE REQUESTED MODE ALREADY EXISTS                              01450000
*---------------------------------------------------------------------- 01460000
                                                                        01470000
         LTR   RIVUSER,RIVUSER    DO WE HAVE AN IVUSER POINTER?         01480000
         BNP   ERRPARM            BRANCH IF NOT                         01490000
         CLC   IVUID,=CL8'IVUSER' IS THE ID CORRECT?                    01500000
         BNE   ERRPARM            BRANCH IF NOT                         01510000
         ICM   R1,15,MODENM@      WAS A NAME POINTER PROVIDED?          01520000
         BNP   ERRPARM            BRANCH IF NOT                         01530000
         ICM   R1,15,MODENMLN     WAS A VALID LENGTH PROVIDED?          01540000
         BNP   ERRPARM            BRANCH IF NOT                         01550000
         C     R1,=F'8'           WAS A VALID LENGTH PROVIDED?          01560000
         BH    ERRPARM            BRANCH IF NOT                         01570000
                                                                        01580000
         BAS   R14,VTAMLOCK       SERIALIZE                             01590000
                                                                        01600000
         LA    R4,IVUMD1ST        GET SET TO RUN MODE_LIST              01610000
         S     R4,=A(MDENEXT-MDE)                                       01620000
         ICM   R1,15,IVUMD1ST     IS FIRST MODE BEING DEFINED?          01630000
         BP    MDERUN             BRANCH IF NOT                         01640000
         OI    FLAG,FLAGFMDE      REMEMBER FIRST MODE                   01650000
                                                                        01660000
MDERUN   DS    0H                                                       01670000
                                                                        01680000
         ICM   R4,15,MDENEXT-MDE(R4) LINK TO THE NEXT MDE               01690000
         BM    NEWMDE             BRANCH IF NOT FOUND                   01700000
         CLC   WRKLOCAL,MDENAME-MDE(R4) COMPARE THE NAMES               01710000
         BH    MDERUN             BRANCH IF NEW NAME IS HIGH            01720000
         BL    NEWMDE             BRANCH IF NOT FOUND                   01730000
         B     ERRPROD            BRANCH IF MODE ALREADY DEFINED        01740000
                                                                        01750000
*---------------------------------------------------------------------- 01760000
* CREATE A NEW MODE FOR THIS LU6.2 PARTNER                              01770000
*---------------------------------------------------------------------- 01780000
                                                                        01790000
NEWMDE   DS    0H                                                       01800000
                                                                        01810000
*                                                                       01820000
* ALLOCATE A MDE BLOCK                                                  01830000
*---------------------------------------------------------------------- 01840000
                                                                        01850000
         LA    R3,L'MDEMAX        ALLOCATE A MDE BLOCK                  01860000
                                                                        01870000
         $GETSTOR (R3),                                                +01880000
               LOC=ANY,                                                +01890000
               OWNER=*IVUITASK                                          01900000
                                                                        01910000
         LR    RMDE,R1            REFERENCE TO MDE BLOCK                01920000
         MVC   MDEID,=CL8'MDE'    SET EYECATCHER                        01930000
         ST    R3,MDELEN          SET THE LENGTH                        01940000
                                                                        01950000
*                                                                       01960000
* INITIALIZE THE MDE FIELDS                                             01970000
*---------------------------------------------------------------------- 01980000
                                                                        01990000
         MVC   MDENAME,WRKLOCAL         SET THE MODE NAME               02000000
         ST    RIVUSER,MDEPLB           LINK TO OWNING IVUSER           02010000
                                                                        02020000
         LA    R1,MDEWR1ST              INITIALIZE WAITING-REQUEST LIST 02030000
         S     R1,=A(AQENEXT-AQE)       INITIALIZE WAITING-REQUEST LIST 02040000
         O     R1,=X'80000000'          INITIALIZE WAITING-REQUEST LIST 02050000
         ST    R1,MDEWR1ST              INITIALIZE WAITING-REQUEST LIST 02060000
         ST    R1,MDEWRLST              INITIALIZE WAITING-REQUEST LIST 02070000
                                                                        02080000
         LA    R1,MDEFS1ST              INITIALIZE FREE-SESSION LIST    02090000
         S     R1,=A(ISE62FSN-ISE)      INITIALIZE FREE-SESSION LIST    02100000
         O     R1,=X'80000000'          INITIALIZE FREE-SESSION LIST    02110000
         ST    R1,MDEFS1ST              INITIALIZE FREE-SESSION LIST    02120000
         ST    R1,MDEFSLST              INITIALIZE FREE-SESSION LIST    02130000
                                                                        02140000
         LR    R14,R4                   FOLLOWING MDE                   02150000
         L     R15,MDEPREV-MDE(,R14)    PRECEDING MDE                   02160000
         ST    RMDE,MDENEXT-MDE(,R15)   LINK NEW MDE TO PRECEDING       02170000
         ST    RMDE,MDEPREV-MDE(,R14)   LINK NEW MDE TO FOLLOWING       02180000
         STM   R14,R15,MDENEXT          SET NEXT/PREV IN NEW MDE        02190000
                                                                        02200000
*                                                                       02210000
* IF THIS IS FIRST MDE AND IT IS "SNASVCMG" ...PARALLEL SESSIONS ARE OK 02220000
* SET SESSION LIMITS.                                                   02230000
*---------------------------------------------------------------------- 02240000
                                                                        02250000
         TM    FLAG,FLAGFMDE            IS THIS THE FIRST MDE?          02260000
         BNO   RETURN                   BRANCH IF NOT                   02270000
         CLC   MDENAME,=CL8'SNASVCMG'   IS IT THE RESERVED MODE NAME?   02280000
         BNE   NOTSVCMG                 BRANCH IF NOT, SINGLE SESSION   02290000
         OI    IVUF1,IVUF1PSC           WE ARE PARALLEL SESSION CAPABLE 02300000
         MVC   MDESESSL,=F'2'           TWO SESSIONS CAN BE RUNNING     02310000
         MVC   MDEMINCW,=F'1'           WE GET A WINNER                 02320000
         MVC   MDEMINCL,=F'1'           THEY GET A WINNER               02330000
         B     RETURN                                                   02340000
                                                                        02350000
*                                                                       02360000
* A SINGLE SESSION MODE IS BEING ACTIVATED.                             02370000
* SET SESSION LIMITS.                                                   02380000
*---------------------------------------------------------------------- 02390000
                                                                        02400000
NOTSVCMG DS    0H                                                       02410000
         MVC   MDESESSL,=F'1'           ONLY ONE SESSION WILL RUN       02420000
         MVC   MDEMINCW,=F'0'           WE CAN HAVE A WINNER            02430000
         MVC   MDEMINCL,=F'0'           -OR- THEY CAN HAVE A WINNER     02440000
         B     RETURN                                                   02450000
                                                                        02460000
*---------------------------------------------------------------------- 02470000
* EXCEPTION ROUTINES                                                    02480000
*---------------------------------------------------------------------- 02490000
                                                                        02500000
ERRPARM  DS    0H                                                       02510000
                                                                        02520000
         MVC   RETCODE,=A(LU62_PARAMETER_ERROR)                         02530000
         B     ERRCOMM                                                  02540000
                                                                        02550000
ERRPROD  DS    0H                                                       02560000
                                                                        02570000
         MVC   RETCODE,=A(LU62_PRODUCT_SPECIFIC_ERROR)                  02580000
         B     ERRCOMM                                                  02590000
                                                                        02600000
ERRCOMM  DS    0H                                                       02610000
                                                                        02620000
         SR    RMDE,RMDE          ENSURE NO MDE POINTER                 02630000
         B     RETURN                                                   02640000
                                                                        02650000
*---------------------------------------------------------------------- 02660000
* EXIT TRACE AND RETURN TO CALLER                                       02670000
*---------------------------------------------------------------------- 02680000
                                                                        02690000
RETURN   DS    0H                                                       02700000
                                                                        02710000
         BAS   R14,VTAMUNLK           RELEASE THE LOCK IF NECESSARY     02720000
                                                                        02730000
         $TRACE *=A(TRC_LU62_EXIT),16 TRACE ENTRY W/ 16 USER BYTES      02740000
         BNZ   NOXTRACE               BRANCH IF TRACING NOT AVAILABLE   02750000
         MVC   0(8,R1),=CL8'IL62ADMD' MODULE NAME                       02760000
         MVC   8(4,R1),RETCODE        RETURN_CODE VALUE                 02770000
         ST    RMDE,12(,R1)           MDE ADDRESS                       02780000
NOXTRACE DS    0H                                                       02790000
                                                                        02800000
         L     R1,L62PARM4        ADDRESS OF MDE RETURN AREA            02810000
         ST    RMDE,0(,R1)        RETURN THE MDE ADDRESS                02820000
                                                                        02830000
         L     R1,L62PARM5        ADDRESS OF RETURN_CODE AREA           02840000
         MVC   0(4,R1),RETCODE    SET RETURN_CODE VARIABLE              02850000
                                                                        02860000
         SR    R15,R15            FUNCTION RETURN CODE = 0              02870000
         CEXIT RC=(R15),INDEP=YES RETURN                                02880000
                                                                        02890000
*---------------------------------------------------------------------- 02900000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 02910000
*---------------------------------------------------------------------- 02920000
                                                                        02930000
VTAMLOCK DS    0H                                                       02940000
                                                                        02950000
         TM    FLAG,FLAGLOCK        WAS THE LOCK ALREADY OBTAINED?      02960000
         BOR   R14                  RETURN IF YES                       02970000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             02980000
                                                                        02990000
         $SER  OBTAIN,                                                 +03000000
               VTAM                                                     03010000
                                                                        03020000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              03030000
         BNE   VTAMLOEX             BRANCH IF NOT                       03040000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         03050000
                                                                        03060000
VTAMLOEX DS    0H                                                       03070000
                                                                        03080000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               03090000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          03100000
         BR    R14                  RETURN                              03110000
                                                                        03120000
*---------------------------------------------------------------------- 03130000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                03140000
*---------------------------------------------------------------------- 03150000
                                                                        03160000
VTAMUNLK DS    0H                                                       03170000
                                                                        03180000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       03190000
         BNOR  R14                  BRANCH IF NOT                       03200000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             03210000
         BOR   R14                  DON'T RELEASE IF IT WAS             03220000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             03230000
                                                                        03240000
         $SER  RELEASE,                                                +03250000
               VTAM                                                     03260000
                                                                        03270000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  03280000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          03290000
         BR    R14                  RETURN                              03300000
                                                                        03310000
*---------------------------------------------------------------------- 03320000
* LITERALS AND CONSTANTS                                                03330000
*---------------------------------------------------------------------- 03340000
                                                                        03350000
         LTORG ,                                                        03360000
                                                                        03370000
         PRINT NOGEN                                                    03380000
         ISTDBIND ,               VTAM BIND IMAGE                       03390000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                03400000
         IKJTCB ,                 MVS TASK CONTROL BLOCK                03410000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         03420000
         ICVT  ,                  INTEGRATOR CVT                        03430000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   03440000
         ITASK ,                  INTEGRATOR TASK BLOCK                 03450000
         IPCB ,                   INTEGRATOR PROCESS BLOCK              03460000
         ABCODES ,                INTEGRATOR $ABEND CODES               03470000
         EVCODES ,                INTEGRATOR EVENT CODES                03480000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            03490000
         ISESS ,                  INTEGRATOR SESSION BLOCK              03500000
         END   ,                                                        03510000

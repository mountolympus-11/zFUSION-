IL62DRU TITLE 'INTEGRATOR - LU6.2 RECEIVED RU PROCESSOR'                00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: IL62DRU - INTEGRATOR LU6.2 RECEIVED RU PROCESSOR             00100000
*                                                                       00110000
* DESCRIPTION: THIS ROUTINE IS CALLED TO PROCESS AN LU6.2 SNA RU.       00120000
*              IT IS CALLED BY ILL2RECV AFTER THE RECEIVE SPLIST        00130000
*              HAS BEEN ANALYZED.                                       00140000
*                                                                       00150000
* ON ENTRY:                                                             00160000
*                                                                       00170000
*    R15 = ENTRY POINT ADDRESS                                          00180000
*    R14 = RETURN      ADDRESS                                          00190000
*    R13 = SAVE AREA   ADDRESS                                          00200000
*    R11 = ICVT        ADDRESS                                          00210000
*    R10 = ITASK       ADDRESS                                          00220000
*    R09 = IVTAMCVT    ADDRESS                                          00230000
*    R08 = ISESS       ADDRESS                                          00240000
*    R01 = SPLIST      ADDRESS                                          00250000
*                                                                       00260000
* ON EXIT:                                                              00270000
*                                                                       00280000
*    R15 = AS PASSED BY IL62DREC/IL62DREX                               00290000
*    R00 = AS PASSED BY IL62DREC/IL62DREX                               00300000
*    R01 = AS PASSED BY IL62DREC/IL62DREX                               00310000
*                                                                       00320000
*    ALL OTHER REGISTERS ARE RESTORED.                                  00330000
*                                                                       00340000
**<DOC-OFF>************************************************************ 00350000
                                                                        00360000
*********************************************************************** 00370000
*                                                                       00380000
* MAINTENANCE:                                                          00390000
*                                                                       00400000
*   07/01/94 RANDY WITEK                                                00410000
*                                                                       00420000
*********************************************************************** 00430000
                                                                        00440000
         EQUS  ,                  GENERAL EQUATES                       00450000
                                                                        00460000
RICVT    EQU   R11                                                      00470000
RITASK   EQU   R10                                                      00480000
RIVTAM   EQU   R9                                                       00490000
RISESS   EQU   R8                                                       00500000
RSPLIST  EQU   R7                                                       00510000
RRCB     EQU   R6                                                       00520000
                                                                        00530000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00540000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00550000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00560000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00570000
         USING SPLIST,RSPLIST     ESTABLISH ADDRESSABILITY              00580000
         USING RCB,RRCB           ESTABLISH ADDRESSABILITY              00590000
                                                                        00600000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00610000
WRK256   DS    XL256              GENERAL WORKAREA                      00620000
L62MFL   L62TRCS MF=L             PLIST CONSTRUCTION                    00630000
$WUMFL   $WULOC MF=L              PLIST CONSTRUCTION                    00640000
WUDATA   DS    XL16               WULOC RETURN AREA                     00650000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00660000
L62RETCD DS    F                                                        00670000
RETR15   DS    F                                                        00680000
RETR0    DS    F                                                        00690000
RETR1    DS    F                                                        00700000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00710000
FLAG     DS    X                                                        00720000
FLAGDLCK EQU   X'80'                                                    00730000
FLAGDLKD EQU   X'40'                                                    00740000
                                                                        00750000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00760000
                                                                        00770000
         $MSGDFT PREFIX=ICTPID,                                        +00780000
               COMPID='L62',                                           +00790000
               TABLE=*#MSGS,                                           +00800000
               WORKA=0,                                                +00810000
               MF=(E,WRK256),                                          +00820000
               PRINT=NOGEN                                              00830000
                                                                        00840000
IL62DRU #ENTER BASE=R12,                                               +00850000
               PREG=RSPLIST,            R1->RSPLIST                    +00860000
               AMODE=31,                                               +00870000
               RMODE=ANY                                                00880000
                                                                        00890000
*---------------------------------------------------------------------- 00900000
* CAPTURE DIAGNOSTIC TRACE INFORMATION                                  00910000
*---------------------------------------------------------------------- 00920000
                                                                        00930000
         L62TRCS (RSPLIST),                    @ SPLIST                +00940000
               (RISESS),                       @ ISESS                 +00950000
               =CL10'SPLIST Q''D',             @ DESCRIPTION           +00960000
               =F'10',                         @ DESCRIPTION LEN       +00970000
               0,                              @ ADDITIONAL DATA       +00980000
               =F'0',                          @ ADDITIONAL DATA LEN   +00990000
               L62RETCD,                       @ RETURN CODE AREA      +01000000
               MF=(E,L62MFL)                                            01010000
                                                                        01020000
*---------------------------------------------------------------------- 01030000
* RESET THE CURRENT OFFSET                                              01040000
*---------------------------------------------------------------------- 01050000
                                                                        01060000
         XC    SPL62OFF,SPL62OFF             RESET THE OFFSET           01070000
                                                                        01080000
*---------------------------------------------------------------------- 01090000
* QUEUE THE DATA                                                        01100000
*---------------------------------------------------------------------- 01110000
                                                                        01120000
         L     R15,ISE62RBL                  THIS WILL BE THE PREVIOUS  01130000
         L     R14,SPL62RBN-SPLIST(,R15)     THIS WILL BE THE NEXT      01140000
         STM   R14,R15,SPL62RBN              LINK NEW BUFFER TO QUEUE   01150000
         ST    RSPLIST,SPL62RBN-SPLIST(,R15) LINK NEW BUFFER TO PREV    01160000
         ST    RSPLIST,SPL62RBP-SPLIST(,R14) LINK NEW BUFFER TO NEXT    01170000
                                                                        01180000
*---------------------------------------------------------------------- 01190000
* IF RECEIVE NOTIFICATION IS ACTIVE...POST THE USER                     01200000
*---------------------------------------------------------------------- 01210000
                                                                        01220000
         TM    ISE62FL1,ISE62NOT  RECEIVE NOTIFICATION ACTIVE?          01230000
         BNO   NOTIFIED           BRANCH IF NOT                         01240000
                                                                        01250000
         BAS   R14,DISPLOCK       SERIALIZE                             01260000
                                                                        01270000
         $WULOC LOCATE,           FIND THE WORK UNIT                   +01280000
               TOKEN=ISE62ENT,    WORK UNIT TOKEN ADDRESS              +01290000
               USERDATA=WUDATA,   XL16 AREA TO RECEIVE USER DATA       +01300000
               LOCKED=YES,        DISP LOCK LOCALLY ACQUIRED           +01310000
               MF=(E,$WUMFL)      VALIDATE WORK UNIT                    01320000
                                                                        01330000
         LTR   R15,R15            LOCATE SUCCESS?                       01340000
         BNZ   NOTIFIED           BRANCH IF NOT, SKIP THE NOTIFICATION  01350000
         L     RRCB,ISE62RCB      RCB SHOULD BE VALID                   01360000
         CLC   RCBID,=CL8'RCB'    IS THE ID CORRECT?                    01370000
         BNE   NOTIFIED           BRANCH IF NOT                         01380000
         ICM   R2,15,RCBNEPB      NOTIFY EPB ADDRESS                    01390000
         BZ    NOTIFIED           BRANCH IF NO EPB                      01400000
         XC    RCBNEPB,RCBNEPB    CLEAR THE NOTIFY EPB ADDRESS          01410000
                                                                        01420000
         L62POST (R2),            ADDRESS OF EPB TO POST               +01430000
               =F'0',             ADDRESS OF POST CODE                 +01440000
               ISE62ENT,          ADDRESS OF ENTITY TOKEN              +01450000
               L62RETCD,          ADDRESS OF RETURN CODE AREA          +01460000
               MF=(E,L62MFL)                                            01470000
                                                                        01480000
NOTIFIED DS    0H                                                       01490000
                                                                        01500000
         BAS   R14,DISPUNLK                                             01510000
                                                                        01520000
         NI    ISE62FL1,255-ISE62NOT                                    01530000
                                                                        01540000
*---------------------------------------------------------------------- 01550000
* CALL THE RECEIVE COMPLETION ROUTINE                                   01560000
*---------------------------------------------------------------------- 01570000
                                                                        01580000
         L     R15,IL6@DREC       RECEIVE COMPLETION ROUTINE            01590000
         BASR  R14,R15            LINK TO ROUTINE                       01600000
         STM   R15,R1,RETREGS     SAVE RETURN VALUES                    01610000
                                                                        01620000
*---------------------------------------------------------------------- 01630000
* RETURN TO CALLER                                                      01640000
*---------------------------------------------------------------------- 01650000
                                                                        01660000
         LM    R15,R1,RETREGS     LOAD RETURN VALUES                    01670000
                                                                        01680000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    01690000
                                                                        01700000
*---------------------------------------------------------------------- 01710000
*   SUBROUTINE: OBTAIN DISP GLOBAL LOCK                                 01720000
*---------------------------------------------------------------------- 01730000
                                                                        01740000
DISPLOCK DS    0H                                                       01750000
                                                                        01760000
         TM    FLAG,FLAGDLCK        WAS THE LOCK ALREADY OBTAINED?      01770000
         BOR   R14                  RETURN IF YES                       01780000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             01790000
                                                                        01800000
         $SER  OBTAIN,                                                 +01810000
               DISP                                                     01820000
                                                                        01830000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              01840000
         BNE   DISPLOEX             BRANCH IF NOT                       01850000
         OI    FLAG,FLAGDLKD        REMEMBER LOCK HELD ON ENTRY         01860000
                                                                        01870000
DISPLOEX DS    0H                                                       01880000
                                                                        01890000
         OI    FLAG,FLAGDLCK        REMEMBER LOCK IS HELD               01900000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          01910000
         BR    R14                  RETURN                              01920000
                                                                        01930000
*---------------------------------------------------------------------- 01940000
*   SUBROUTINE: RELEASE DISP GLOBAL LOCK                                01950000
*---------------------------------------------------------------------- 01960000
                                                                        01970000
DISPUNLK DS    0H                                                       01980000
                                                                        01990000
         TM    FLAG,FLAGDLCK        IS LOCK HELD?                       02000000
         BNOR  R14                  BRANCH IF NOT                       02010000
         TM    FLAG,FLAGDLKD        WAS LOCK HELD ON ENTRY?             02020000
         BOR   R14                  DON'T RELEASE IF IT WAS             02030000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             02040000
                                                                        02050000
         $SER  RELEASE,                                                +02060000
               DISP                                                     02070000
                                                                        02080000
         NI    FLAG,255-FLAGDLCK    SHOW LOCK NOT HELD                  02090000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          02100000
         BR    R14                  RETURN                              02110000
                                                                        02120000
*---------------------------------------------------------------------- 02130000
*  CONSTANTS AND LITERALS                                               02140000
*---------------------------------------------------------------------- 02150000
                                                                        02160000
         LTORG ,                                                        02170000
         PRINT NOGEN                                                    02180000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                02190000
         ISTRH ,                  VTAM REQUEST HEADER                   02200000
         ISTDBIND ,               VTAM BIND IMAGE                       02210000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         02220000
         ICVT  ,                  INTEGRATOR CVT                        02230000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   02240000
         ITASK ,                  INTEGRATOR TASK BLOCK                 02250000
         ISESS ,                  INTEGRATOR ISESS BLOCK                02260000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       02270000
         EVCODES ,                INTEGRATOR EVENT CODES                02280000
         ABCODES ,                INTEGRATOR $ABEND CODES               02290000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     02300000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        02310000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             02320000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             02330000
         $WULOC DSECT=YES         INTEGRATOR $WULOC SERVICES            02340000
         END   ,                                                        02350000

ITBDROP TITLE 'TABLE SERVICES - TABLE DROP'                             00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE:  ITBDROP - Table services, table drop                        00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine implements the facilities described by the            00080000
*    TBDROP macro, which is used to delete a base table                 00090000
*    object and all of its component objects (row locator               00100000
*    and indecies).                                                     00110000
*                                                                       00120000
*                                                                       00130000
* NOTES:                                                                00140000
*                                                                       00150000
*    The return and reason code actually reflected back to the          00160000
*    caller identify the most serious error encountered while           00170000
*    locating and deleting the table and its associated                 00180000
*    objects.  Generally, $OBJECT errors are ignored in flight          00190000
*    ensuring that as much of the object storage that can be            00200000
*    recovered is.                                                      00210000
*                                                                       00220000
*                                                                       00230000
* ON ENTRY:                                                             00240000
*                                                                       00250000
*    R1  contains the address of a parameter list described             00260000
*        by the @TBDROP mapping                                         00270000
*                                                                       00280000
*                                                                       00290000
* ON EXIT:                                                              00300000
*                                                                       00310000
*    R15 contains one of the following return codes                     00320000
*    R0  may contain an associated reason code or other data            00330000
*                                                                       00340000
*        RC00 - drop completed                                          00350000
*                                                                       00360000
*        RC12 - request in error                                        00370000
*                                                                       00380000
*               RSN04 - invalid table token supplied                    00390000
*               RSN16 - invalid index name provided (future)            00400000
*                                                                       00410000
*        RC16 - object management error encountered                     00420000
*                                                                       00430000
*               R1 - @PUSHERR summary of service rtn failure            00440000
*                                                                       00450000
*               RSN12 - base table not accessable                       00460000
*                                                                       00470000
*        RC20 - object space storage management failure                 00480000
*                                                                       00490000
**<DOC-OFF>****************************************************         00500000
                                                                        00510000
         EJECT                                                          00520000
***************************************************************         00530000
*                                                                       00540000
* MAINTENANCE:                                                          00550000
*                                                                       00560000
*    10/23/95 R. Turgeon                                                00570000
*             Implement the NOLOCATOR property.  Allow tables           00580000
*             to omit the row locator object.                           00590000
*                                                                       00600000
***************************************************************         00610000
                                                                        00620000
         EJECT                                                          00630000
***************************************************************         00640000
*                                                                       00650000
*   Working storage area                                                00660000
*                                                                       00670000
***************************************************************         00680000
                                                                        00690000
WORKAREA DSECT                                                          00700000
                                                                        00710000
         @WORK ,                  STANDARD WORKAREA                     00720000
                                                                        00730000
WORKFREE DS    0D                 AVAILABLE TO SERVICE ROUTINES         00740000
WORKLEN  EQU   *-WORKAREA         LENGTH OF WORKAREA                    00750000
                                                                        00760000
         EJECT                                                          00770000
         @TBDROP ,                PARAMETER LIST FORMAT                 00780000
                                                                        00790000
         EJECT                                                          00800000
         $TOKEN ,                 SPACE OR OBJECT TOKEN                 00810000
                                                                        00820000
         EJECT                                                          00830000
         TBTOKEN ,                TABLE TOKEN                           00840000
                                                                        00850000
         EJECT                                                          00860000
         $STG  TYPE=DSECT         TABLE STORAGE MGMT MAPPINGS           00870000
                                                                        00880000
         EJECT                                                          00890000
         @TABLE ,                 TABLE OBJECT PREFIX                   00900000
                                                                        00910000
         EJECT                                                          00920000
         @TBKEYDF ,               KEY DEFINITION ENTRY                  00930000
                                                                        00940000
         EJECT                                                          00950000
         DICPARMS ,               DATA DICTIONARY INTERFACE PARMS       00960000
                                                                        00970000
         EJECT                                                          00980000
         OIE   ,                  OBJECT INDEX ENTRY ($OBJECT INLINE)   00990000
                                                                        01000000
         EJECT                                                          01010000
         SPCBLOCK ,               OBJECT SPACE BLOCK ($OBJECT INLINE)   01020000
                                                                        01030000
         EJECT                                                          01040000
         EQUS  LINKAGE=VCON                                             01050000
                                                                        01060000
         EJECT                                                          01070000
ITBDROP  @ENTER WORKA=(WORKAREA,WORKLEN),ASC=AR                         01080000
                                                                        01090000
         LAM   R1,R7,MFE_LIST     PRIMARY SPACE ADDRESSING              01100000
                                                                        01110000
         LR    R7,R1              PARAMETER LIST                        01120000
         USING TBDROP,R7          TBDROP SERVICE                        01130000
                                                                        01140000
         L     R6,TBDRTOKN        LOCATE TABLE TOKEN                    01150000
         L     R6,0(,R6)          TOKEN IS A PTR                        01160000
         USING TBTOKEN,R6         TABLE TOKEN ADDRESSABILITY LOF        01170000
                                                                        01180000
         CLC   TTOKTAG,=CL8'TBTOKEN'                                    01190000
         BNE   ETBTOKEN                                                 01200000
                                                                        01210000
*--------------------------------------------------------------         01220000
*   Acquire access to base table                                        01230000
*--------------------------------------------------------------         01240000
                                                                        01250000
         $OBJECT ACCESS,INTENT=QUERY,OTOKEN=TTOKTABL,                  X01260000
               INLINE=YES                                               01270000
                                                                        01280000
         BZ    TBLOBJOK           FAIL IF NOT                           01290000
                                                                        01300000
         $OBJECT ACCESS,INTENT=QUERY,OTOKEN=TTOKTABL,                  X01310000
               SHRPAGE=WORKFREE,MF=(E,MFE_LIST)                         01320000
                                                                        01330000
         BNZ   ETABLOBJ           FAIL IF NOT                           01340000
                                                                        01350000
*--------------------------------------------------------------         01360000
*   Table object successfully located                                   01370000
*--------------------------------------------------------------         01380000
                                                                        01390000
TBLOBJOK DS    0H                                                       01400000
         LAE   R11,0(,R1)         OBJECT ADDRESS                        01410000
         USING TABLE,R11          TABLE BASE                            01420000
         CLC   TBLTAG,=CL8'TBTABLE'                                     01430000
         BNE   ETABLOBJ                                                 01440000
                                                                        01450000
*--------------------------------------------------------------         01460000
*   Process drop index / table request                                  01470000
*--------------------------------------------------------------         01480000
                                                                        01490000
         ICM   R1,15,TBDRNDX      INDEX NAMED                           01500000
         BNZ   DROPNDX            DROP SINGLE INDEX                     01510000
         B     DROPTAB            DROP ENTIRE TABLE                     01520000
                                                                        01530000
         EJECT                                                          01540000
***************************************************************         01550000
*                                                                       01560000
*   Index drop - locate and then remove the named index                 01570000
*                                                                       01580000
***************************************************************         01590000
                                                                        01600000
DROPNDX  DS    0H                                                       01610000
         L     R2,TBDRNDX         R1 <== INDEX NAME                     01620000
         LA    R0,TABLE           R0 <== TABLE OBJECT BASE              01630000
         BAS   R14,FKEYDEF        FIND KEY DEFINITION                   01640000
         LTR   R15,R15            SUCCESSFUL?                           01650000
         BNZ   EKEYNAME           ERROR IF NOT                          01660000
                                                                        01670000
         LR    R2,R0              INDEX SEQUENCE NUMBER                 01680000
         BCTR  R2,0               CONVERT TO OFFSET                     01690000
         MH    R2,=AL2($TOKLN)    OFFSET TO NTH TOKEN                   01700000
         LA    R3,TTOKNDX(R2)     LOCATE INDEX TOKEN WITHIN TABLE TOKEN 01710000
                                                                        01720000
         $OBJECT DESTROY,OTOKEN=(R3),                                  X01730000
               SHRPAGE=WORKFREE,MF=(E,MFE_LIST)                         01740000
                                                                        01750000
*--------------------------------------------------------------         01760000
*   Invalidate the index                                                01770000
*--------------------------------------------------------------         01780000
                                                                        01790000
*        ???                                                            01800000
*        ???                                                            01810000
*        ???                                                            01820000
                                                                        01830000
         B     DROP_RET           PASS THRU OBJECT OPERATION RETCODE    01840000
                                                                        01850000
         EJECT                                                          01860000
***************************************************************         01870000
*                                                                       01880000
*   Drop (delete) all objects comprising the designated table.          01890000
*   Perform appropriate data dictionary updates if dictionary           01900000
*   support is present.                                                 01910000
*                                                                       01920000
***************************************************************         01930000
                                                                        01940000
DROPTAB  DS    0H                                                       01950000
         WXTRN IDDMNGR            DATA DICTIONARY MANAGER               01960000
         ICM   R2,15,=V(IDDMNGR)  DATA DICTIONARY IN USE?               01970000
         BZ    DROPINIT           SKIP IF NOT                           01980000
                                                                        01990000
         LA    R4,MFE_LIST        PLIST CONSTRUCTION AREA               02000000
         USING DICPARMS,R4        INTERFACE FORMAT                      02010000
                                                                        02020000
         XC    DICPARMS(DICPLN),DICPARMS                                02030000
         LA    R0,DICFDRO         TABLE DROP                            02040000
         ST    R0,DICFUNC         INFORM DICTIONARY MGR                 02050000
         LA    R0,TBTOKEN         TABLE TOKEN                           02060000
         ST    R0,DICTTOKN        INFORM DICTIONARY MGR                 02070000
         ST    R11,DICTBORG       BASE TABLE ORIGIN                     02080000
         STAM  AR11,AR11,DICALET  ALET OF TABLE SPACE                   02090000
                                                                        02100000
         @CALL IDDMNGR,MF=(E,DICPARMS)                                  02110000
                                                                        02120000
         DROP  R4                 DICPARMS                              02130000
                                                                        02140000
*--------------------------------------------------------------         02150000
*   Table component scan init                                           02160000
*--------------------------------------------------------------         02170000
                                                                        02180000
DROPINIT DS    0H                                                       02190000
         SR    R8,R8              RETAIN HIGHEST RETURN CODE            02200000
         SR    R5,R5              FUNCTION SPECIFIC RETURN INFO         02210000
         SR    R4,R4              REASON CODE                           02220000
                                                                        02230000
         LA    R2,2               TABLE AND LOCATOR OBJECTS             02240000
         AH    R2,TTOK#NDX        PLUS NUMBER OF INDEX OBJECTS          02250000
         LA    R3,TTOKOBJS        ORIGIN OF OBJECT TOKENS               02260000
         USING $TOKEN,R3          OBJECT/SPACE TOKEN FORMAT             02270000
                                                                        02280000
*--------------------------------------------------------------         02290000
*   Delete table component object                                       02300000
*--------------------------------------------------------------         02310000
                                                                        02320000
DROPOBJ  DS    0H                                                       02330000
         ICM   R0,15,$OBJID       OBJECT ACTUALLY CREATED?              02340000
         BZ    DROPNXT            SKIP OTHERWISE                        02350000
                                                                        02360000
         $OBJECT DESTROY,OTOKEN=(R3),                                  X02370000
               SHRPAGE=WORKFREE,MF=(E,MFE_LIST)                         02380000
                                                                        02390000
         CR    R15,R8             MORE SERIOUS ERROR ENCOUNTERED?       02400000
         BNH   DROPNXT            SKIP IF NOT                           02410000
                                                                        02420000
         LR    R8,R15             RETAIN MOST SEVERE ERROR RETCODE      02430000
         LR    R5,R1              RETURN DATA                           02440000
         LR    R4,R0              REASON CODE                           02450000
                                                                        02460000
DROPNXT  DS    0H                                                       02470000
         LA    R3,$TOKLN(,R3)     ADVANCE TO NEXT OBJECT TOKEN          02480000
         BCT   R2,DROPOBJ         PROCESS ALL OBJECTS                   02490000
         DROP  R3                 $TOKEN                                02500000
                                                                        02510000
*--------------------------------------------------------------         02520000
*   Free the table token - reset users ptr                              02530000
*--------------------------------------------------------------         02540000
                                                                        02550000
         LH    R2,TTOKSIZE        SIZE OF TABLE TOKEN                   02560000
                                                                        02570000
         $STORAGE RELEASE,LENGTH=(R2),ADDR=(R6)                         02580000
                                                                        02590000
         L     R6,TBDRTOKN        USERS TOKEN PTR                       02600000
         XC    0(4,R6),0(R6)      CLEAR                                 02610000
         DROP  R6                 TABLE TOKEN                           02620000
                                                                        02630000
*--------------------------------------------------------------         02640000
*   Return highest completion codes encountered                         02650000
*--------------------------------------------------------------         02660000
                                                                        02670000
         LR    R15,R8             RETAIN HIGHEST ERROR                  02680000
         LR    R1,R5              RETURN DATA                           02690000
         LR    R0,R4              REASON CODE                           02700000
         B     DROP_RET           DONE                                  02710000
                                                                        02720000
         EJECT                                                          02730000
***************************************************************         02740000
*                                                                       02750000
*   Return completion status to requestor                               02760000
*                                                                       02770000
***************************************************************         02780000
                                                                        02790000
                                                                        02800000
*------- logical request errors -------------------------------         02810000
                                                                        02820000
ETBTOKEN DS    0H                 INVALID TABLE TOKEN SUPPLIED          02830000
         LA    R0,RSN04                                                 02840000
         LA    R15,RC12                                                 02850000
         B     DROP_RET                                                 02860000
                                                                        02870000
EKEYNAME DS    0H                 NAMED KEY / INDEX DOES NOT EXIST      02880000
         LA    R0,RSN16                                                 02890000
         LA    R15,RC12                                                 02900000
         B     DROP_RET                                                 02910000
                                                                        02920000
                                                                        02930000
*------- object management / storage management errors --------         02940000
                                                                        02950000
ETABLOBJ DS    0H                 COULD NOT ACCESS BASE TABLE           02960000
         CH    R15,=AL2(RC12)     SPACE STORAGE OVERCOMMITTED?          02970000
         BE    ERR_STG            DISTINCT NOTIFICATION IF SO           02980000
                                                                        02990000
         @PUSHERR ,               PRESERVE SERVICE ROUTINE FDBK         03000000
                                                                        03010000
         LA    R0,RSN12                                                 03020000
         LA    R15,RC16                                                 03030000
         B     DROP_RET                                                 03040000
                                                                        03050000
ERR_STG  DS    0H                 OBJECT SPACE STORAGE NOT AVAILABLE    03060000
         LA    R15,RC20                                                 03070000
         B     DROP_RET                                                 03080000
                                                                        03090000
*--------------------------------------------------------------         03100000
*   Return to caller                                                    03110000
*--------------------------------------------------------------         03120000
                                                                        03130000
DROP_RET DS    0H                                                       03140000
         NOP   0                                                        03150000
         @EXIT ,                                                        03160000
                                                                        03170000
         EJECT                                                          03180000
***************************************************************         03190000
*                                                                       03200000
* ROUTINE: FKEYDEF - Locate key definition by key name                  03210000
*                                                                       03220000
* ON ENTRY:                                                             03230000
*                                                                       03240000
*    R1   - addr of index name (CL8)                                    03250000
*    R0   - addr of base table                                          03260000
*                                                                       03270000
* ON EXIT:                                                              03280000
*                                                                       03290000
*    R15 contains one of the following return codes                     03300000
*                                                                       03310000
*        RC00 - key definition matched                                  03320000
*                                                                       03330000
*               R1 - unqualified in-queue key entry ptr                 03340000
*               R0 - key entry sequence number (1-n)                    03350000
*                                                                       03360000
*        RC04 - key definition not matched                              03370000
*                                                                       03380000
***************************************************************         03390000
                                                                        03400000
FKEYDEF  DS    0H                                                       03410000
         BAKR  R14,0              SAVE MAINLINE REGS                    03420000
         LA    R15,RC04           ASSUME NO MATCH WILL BE FOUND         03430000
         SR    R2,R2              KEY ENTRY COUNTER                     03440000
                                                                        03450000
         LAE   R10,TBLKYLST       KEY LIST ORIGIN                       03460000
         USING TBKEYDEF,R10                                             03470000
                                                                        03480000
FKEYNXT  DS    0H                                                       03490000
         LA    R2,1(,R2)          UPDATE KEY SEQUENCE NUMBER            03500000
         ICM   R10,15,TBKLINK     ADVANCE TO NEXT Q KEY                 03510000
         BZ    FKEYRET            UNABLE TO MATCH CANDIDATE             03520000
         AR    R10,R0             CONVERT OFFSET TO ADDRESS             03530000
         CLC   TBKEYNAM,0(R1)     MATCHING KEY NAMES?                   03540000
         BNE   FKEYNXT            AGAIN IF NOT                          03550000
         LA    R1,TBKEYDEF        RETURN INQUEUE ADDRESS                03560000
         LA    R15,RC00           INDICATE SUCCESS                      03570000
                                                                        03580000
FKEYRET  DS    0H                                                       03590000
         NOP   0                                                        03600000
         PR    ,                                                        03610000
         DROP  R10                IN-QUEUE AND CANDIDATE KEY DEFS       03620000
                                                                        03630000
         EJECT                                                          03640000
***************************************************************         03650000
*                                                                       03660000
*   Local read-only data areas, etc.                                    03670000
*                                                                       03680000
***************************************************************         03690000
                                                                        03700000
         LTORG ,                                                        03710000
         END   ,                                                        03720000

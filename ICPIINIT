ICPIINIT TITLE 'INTEGRATOR - CPIC CMINIT API - INITIALIZE CONV'         00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: ICPIINIT - CPIC CMINIT API                                   00100000
*                                                                       00110000
* DESCRIPTION:                                                          00120000
*                                                                       00130000
*    THIS ROUTINE IS CALLED TO PROCESS THE CMINIT VERB.                 00140000
*                                                                       00150000
* ON ENTRY:                                                             00160000
*                                                                       00170000
*    R15 = ENTRY POINT ADDRESS                                          00180000
*    R14 = RETURN      ADDRESS                                          00190000
*    R13 = SAVE AREA   ADDRESS                                          00200000
*    R01 = PARM LIST   ADDRESS                                          00210000
*                                                                       00220000
*          +00 = ADDRESS OF CONVERSATION_ID (RETURN AREA)               00230000
*          +04 = ADDRESS OF SYM_DEST_NAME                               00240000
*          +08 = ADDRESS OF RETURN_CODE     (RETURN AREA)               00250000
*                                                                       00260000
* ON EXIT:                                                              00270000
*                                                                       00280000
*    R15 = 0                                                            00290000
*                                                                       00300000
*    RETURN_CODE = CM_OK                     --> SUCCESSFUL CALL        00310000
*                = CM_PARAMETER_ERROR        --> N/A                    00320000
*                = CM_PRODUCT_SPECIFIC_ERROR --> L62DFRC FAIL/BAD PARM  00330000
*                                                                       00340000
**<DOC-OFF>************************************************************ 00350000
         EJECT ,                                                        00360000
*********************************************************************** 00370000
*                                                                       00380000
* MAINTENANCE:                                                          00390000
*                                                                       00400000
*   07/01/94 RANDY WITEK                                                00410000
*                                                                       00420000
*********************************************************************** 00430000
                                                                        00440000
         EQUS  ,                  GENERAL EQUATES                       00450000
                                                                        00460000
RICVT    EQU   R11                                                      00470000
RITASK   EQU   R10                                                      00480000
RBASE    EQU   R9                                                       00490000
RIVTAM   EQU   R8                                                       00500000
RCMLIST  EQU   R7                                                       00510000
RRCB     EQU   R6                                                       00520000
                                                                        00530000
         USING DSA,R13            ESTABLISH ADDRESSABILITY              00540000
         USING CRAB,R12           ESTABLISH ADDRESSABILITY              00550000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00560000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00570000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00580000
         USING CMLIST,RCMLIST     ESTABLISH ADDRESSABILITY              00590000
         USING RCB,RRCB           ESTABLISH ADDRESSABILITY              00600000
                                                                        00610000
         COPY  CRAB               "C" RUNTIME ANCHOR BLOCK              00620000
         COPY  DSA                DYNAMIC SAVE AREA                     00630000
WORKAREA DS    0H                 READ/WRITE WORKAREA                   00640000
WRK256   DS    XL256              GENERAL WORKAREA                      00650000
L62PLIST L62DFRC MF=L             PARM LIST AREA                        00660000
LSYMDEST DS    CL8                WORKING COPY OF SYMDEST NAME          00670000
CONVID   DS    XL8                TEMPORARY CONVERSATION ID AREA        00680000
RETCODE  DS    F                  TEMPORARY RETURN CODE     AREA        00690000
CONVS    DS    F                  TEMPORARY CONV STATE      AREA        00700000
L62RCB   DS    A                  L62DFRC RCB RETURN        AREA        00710000
L62RC    DS    F                  L62DFRC RETURN CODE       AREA        00720000
                                                                        00730000
FLAG     DS    X                                                        00740000
FLAGIERR EQU   X'80'                                                    00750000
WORKLEN  EQU   *-WORKAREA         LENGTH OF USER DSA AREA               00760000
DSALEN   EQU   *-DSA              LENGTH OF DSA                         00770000
                                                                        00780000
         $MSGDFT PREFIX=ICTPID,                                        +00790000
               COMPID='CPI',                                           +00800000
               TABLE=*#MSGS,                                           +00810000
               WORKA=0,                                                +00820000
               MF=(E,WRK256),                                          +00830000
               PRINT=NOGEN                                              00840000
                                                                        00850000
ICPINIT@ CSECT ,                                                        00860000
ICPIINIT CENTRY DSA=DSALEN,BASE=RBASE,INDEP=YES                         00870000
                                                                        00880000
*---------------------------------------------------------------------- 00890000
* ENTRY                                                                 00900000
*---------------------------------------------------------------------- 00910000
                                                                        00920000
         LR    RCMLIST,R1         SAVE ADDRESS OF PLIST                 00930000
                                                                        00940000
         LA    R0,WORKAREA        ADDRESS OF USER DSA SECTION           00950000
         LA    R1,WORKLEN         LENGTH  OF USER DSA SECTION           00960000
         SR    R15,R15            PREPARE FOR CLEAR                     00970000
         MVCL  R0,R14             CLEAR USER DSA SECTION                00980000
                                                                        00990000
*---------------------------------------------------------------------- 01000000
* INITIALIZATION                                                        01010000
*---------------------------------------------------------------------- 01020000
                                                                        01030000
         @RESTENV ,               ENSURE ENVIRONMENT                    01040000
                                                                        01050000
         L     RIVTAM,ICTVTCVT    ESTABLISH IVTAMCVT POINTER            01060000
                                                                        01070000
         MVC   CONVID,=XL8'55AA55AA55AA55AA'                            01080000
         MVC   CONVS,=XL4'55AA55AA'                                     01090000
                                                                        01100000
         L     R1,CMLPARM3        ADDRESS OF RETURN_CODE AREA           01110000
         MVC   0(4,R1),0(R1)      TEST MOVEMENT                         01120000
                                                                        01130000
         ICM   R1,15,CMLPARM1     ADDRESS OF CONVERSATION ID            01140000
         BNP   INITERR            BRANCH IF BAD                         01150000
         MVC   CONVID,0(R1)       COPY CONVID                           01160000
                                                                        01170000
         MVC   LSYMDEST,=CL8' '   BLANK WORKING COPY OF SYMDEST NAME    01180000
         ICM   R1,15,CMLPARM2     SYMDEST NAME ADDRESS                  01190000
         BNP   INITERR            BRANCH IF NOT OK                      01200000
         MVC   LSYMDEST,0(R1)     COPY SYMDEST NAME                     01210000
         B     INITEND                                                  01220000
                                                                        01230000
INITERR  DS    0H                                                       01240000
                                                                        01250000
         OI    FLAG,FLAGIERR      REMEMBER ERROR DETECTED               01260000
                                                                        01270000
INITEND  DS    0H                                                       01280000
                                                                        01290000
*---------------------------------------------------------------------- 01300000
* ENTRY TRACE                                                           01310000
*---------------------------------------------------------------------- 01320000
                                                                        01330000
         $TRACE *=A(TRC_CPIC_ICPIINIT),48 TRACE ENTRY W/ 48 USER BYTES  01340000
         BNZ   NOETRACE                   BRANCH IF NOT TRACING         01350000
         $APITRC ICPIINIT                 TRACE COMMON STUFF            01360000
         ST    RCMLIST,24(,R1)            TRACE PARMLIST ADDRESS        01370000
         MVC   32(8,R1),CONVID            TRACE CONVERSATION ID         01380000
         MVC   40(8,R1),LSYMDEST          TRACE SYMDEST                 01390000
NOETRACE DS    0H                                                       01400000
                                                                        01410000
*---------------------------------------------------------------------- 01420000
* ALLOCATE A RESOURCE_CONTROL_BLOCK                                     01430000
*---------------------------------------------------------------------- 01440000
                                                                        01450000
         TM    FLAG,FLAGIERR      ERROR DETECTED ALREADY?               01460000
         BO    ERRPROD            BRANCH IF YES                         01470000
                                                                        01480000
         L62DFRC L62RCB,          RCB RETURN AREA                      +01490000
               L62RC,             RETURN CODE RETURN AREA              +01500000
               MF=(E,L62PLIST)                                          01510000
                                                                        01520000
         ICM   R15,15,L62RC       SUCCESSFUL CALL?                      01530000
         BNZ   ERRPROD            BRANCH IF NOT                         01540000
         ICM   RRCB,15,L62RCB     ACCESS THE RCB                        01550000
         BNP   ERRPROD            BRANCH IF IT IS NOT THERE!!!          01560000
         MVC   CONVID,RCBCNVID    LOCAL COPY OF CONVERSATION ID         01570000
                                                                        01580000
*---------------------------------------------------------------------- 01590000
* RESOLVE LU/MODE/TPN FROM THE SYMDEST NAME                             01600000
*---------------------------------------------------------------------- 01610000
                                                                        01620000
         MVC   RCBSYMD,LSYMDEST   SET THE SYMDEST                       01630000
                                                                        01640000
         LA    R0,RCBTPNM         TPN                                   01650000
         LA    R1,L'RCBTPNM       TPN MAX LENGTH                        01660000
         ICM   R15,15,=X'40000000' SET TO BLANK FILL                    01670000
         MVCL  R0,R14             SET TPN TO BLANKS                     01680000
         MVC   RCBTPNML,=F'1'     SET TPN LENGTH TO ONE                 01690000
                                                                        01700000
         LA    R0,RCBMDNM         MODE_NAME                             01710000
         LA    R1,L'RCBMDNM       MODE_NAME MAX LENGTH                  01720000
         ICM   R15,15,=X'40000000' SET TO BLANK FILL                    01730000
         MVCL  R0,R14             SET MODE_NAME TO BLANKS               01740000
         XC    RCBMDNML,RCBMDNML  SET MODE_NAME LENGTH TO ZERO          01750000
                                                                        01760000
         LA    R0,RCBLUNM         PARTNER_LU_NAME                       01770000
         LA    R1,L'RCBLUNM       PARTNER_LU_NAME MAX LENGTH            01780000
         LA    R14,LSYMDEST       USE SYMDEST AS PARTNER_LU_NAME        01790000
         LA    R15,8              SYMDEST IS EIGHT BYTES                01800000
         ICM   R15,B'1000',=C' '  SET TO BLANK FILL                     01810000
         MVCL  R0,R14             SET PARTNER_LU_NAME TO BLANKS         01820000
         SR    R15,R15            R15 COUNTS LENGTH                     01830000
         LA    R1,RCBLUNM         PARTNER_LU_NAME                       01840000
         LA    R2,17              MAX OF 17 CHARACTERS                  01850000
PLNLOOP  DS    0H                                                       01860000
         CLI   0(R1),C' '         IS THERE A NAME CHARACTER?            01870000
         BNH   PLNLOOPX           BRANCH IF NOT                         01880000
         LA    R15,1(,R15)        BUMP COUNT                            01890000
         LA    R1,1(,R1)          BUMP POINTER                          01900000
         BCT   R2,PLNLOOP         DETERMINE TRUE LENGTH OF NAME         01910000
PLNLOOPX DS    0H                                                       01920000
         ST    R15,RCBLUNML       SET PARTNER_LU_NAME LENGTH            01930000
         LTR   R15,R15            WAS THERE ANY NAME?                   01940000
         BNZ   RESOLVED           BRANCH IF YES                         01950000
         MVC   RCBLUNML,=F'1'     SET LENGTH TO ONE                     01960000
RESOLVED DS    0H                                                       01970000
                                                                        01980000
*---------------------------------------------------------------------- 01990000
* INITIALIZE THE CPI-C RCB FIELDS                                       02000000
*---------------------------------------------------------------------- 02010000
                                                                        02020000
         MVC   RCBCONVS,=A(CM_INITIALIZE_STATE)                         02030000
         MVC   CONVS,RCBCONVS                                           02040000
         MVC   RCBCTYPE,=A(CM_MAPPED_CONVERSATION)                      02050000
         MVC   RCBDEAL,=A(CM_DEALLOCATE_SYNC_LEVEL)                     02060000
         MVC   RCBERRD,=A(CM_RECEIVE_ERROR)                             02070000
         MVC   RCBFILL,=A(CM_FILL_LL)                                   02080000
         MVC   RCBPTR,=A(CM_PREP_TO_RECEIVE_SYNC_LEVEL)                 02090000
         MVC   RCBRTYPE,=A(CM_RECEIVE_AND_WAIT)                         02100000
         MVC   RCBRCTRL,=A(CM_WHEN_SESSION_ALLOCATED)                   02110000
         MVC   RCBSTYPE,=A(CM_BUFFER_DATA)                              02120000
         MVC   RCBSYNCL,=A(CM_NONE)                                     02130000
         XC    RCBLOGDL,RCBLOGDL                                        02140000
         XC    RCBLOGD(256),RCBLOGD                                     02150000
         XC    RCBLOGD+256(256),RCBLOGD+256                             02160000
                                                                        02170000
         B     RETURN                                                   02180000
                                                                        02190000
*---------------------------------------------------------------------- 02200000
* EXCEPTION ROUTINES                                                    02210000
*---------------------------------------------------------------------- 02220000
                                                                        02230000
ERRPROD  DS    0H                                                       02240000
                                                                        02250000
         MVC   RETCODE,=A(CM_PRODUCT_SPECIFIC_ERROR)                    02260000
         B     RETURN                                                   02270000
                                                                        02280000
*---------------------------------------------------------------------- 02290000
* EXIT TRACE AND RETURN TO CALLER                                       02300000
*---------------------------------------------------------------------- 02310000
                                                                        02320000
RETURN   DS    0H                                                       02330000
                                                                        02340000
         $TRACE *=A(TRC_CPIC_EXIT),48 TRACE ENTRY                       02350000
         BNZ   NOXTRACE               BRANCH IF TRACING NOT AVAILABLE   02360000
         MVC   0(8,R1),=CL8'ICPIINIT' MODULE NAME                       02370000
         MVC   8(4,R1),RETCODE        RETURN_CODE VALUE                 02380000
         MVC   12(8,R1),CONVID        CONVERSATION ID                   02390000
         MVC   20(4,R1),CONVS         CONVERSATION STATE                02400000
NOXTRACE DS    0H                                                       02410000
                                                                        02420000
         L     R1,CMLPARM3        ADDRESS OF RETURN_CODE AREA           02430000
         MVC   0(4,R1),RETCODE    SET RETURN_CODE VARIABLE              02440000
         CLC   RETCODE,=A(CM_OK)  GOOD RC?                              02450000
         BNE   EXIT               BRANCH IF NOT                         02460000
                                                                        02470000
         L     R1,CMLPARM1        ADDRESS OF RETURN AREA                02480000
         MVC   0(8,R1),CONVID     SET CONVERSATION_ID VARIABLE          02490000
                                                                        02500000
EXIT     DS    0H                                                       02510000
                                                                        02520000
         SR    R15,R15            FUNCTION RETURN CODE = 0              02530000
         CEXIT RC=(R15),INDEP=YES RETURN                                02540000
                                                                        02550000
*---------------------------------------------------------------------- 02560000
* LITERALS AND CONSTANTS                                                02570000
*---------------------------------------------------------------------- 02580000
                                                                        02590000
         LTORG ,                                                        02600000
                                                                        02610000
         PRINT NOGEN                                                    02620000
         ISTDBIND ,               VTAM BIND IMAGE                       02630000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                02640000
         IKJTCB ,                 MVS TASK CONTROL BLOCK                02650000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         02660000
         ICVT  ,                  INTEGRATOR CVT                        02670000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   02680000
         ITASK ,                  INTEGRATOR TASK BLOCK                 02690000
         IPCB ,                   INTEGRATOR PROCESS BLOCK              02700000
         ABCODES ,                INTEGRATOR $ABEND CODES               02710000
         EVCODES ,                INTEGRATOR EVENT CODES                02720000
         END   ,                                                        02730000

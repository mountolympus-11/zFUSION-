ITRESARG TITLE '- CONVERT PREDICATE TREE TO SARG FORM'                  00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: ITRESARG - CONVERT PREDICATE TREE TO SARG FORM               00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THIS ROUTINE CONVERTS A SQL STATEMENT PREDEICATE TREE OF           00080000
*    THE FORM GENERATED BY ISQSITRE INTO AN EXECUTION READY             00090000
*    TABLE SERVICES PSARG STRUCTURE MAPPED BY TBBNODES.                 00100000
*    PREDETERMINED TRUTH VALUES, IF ANY, POSTED IN THE INPUT            00110000
*    TREE (PREDENT, PRBCON, AND SPBTERM) ARE INHERITTED IN              00120000
*    THE REFORMATTED PSARG.                                             00130000
*                                                                       00140000
*                                                                       00150000
* ON ENTRY:                                                             00160000
*    R1  CONTAINS THE ADDRESS OF A PARAMETER LIST CONSTRUCTED           00170000
*        AS FOLLOWS:                                                    00180000
*                                                                       00190000
*        +00 - ADDRESS OF PREDICATE LIST (REF PREDENT)                  00200000
*        +04 - ADDRESS OF STGMGR QHDR                                   00210000
*                                                                       00220000
* ON EXIT:                                                              00230000
*                                                                       00240000
*     R15 CONTAINS A RETURN CODE THAT INDICATES SUCCESS OR FAILURE      00250000
*     AT BUILDING THE EXECUTABLE READY TREE.                            00260000
*                                                                       00270000
*         RC00 - BUILD COMPLETE                                         00280000
*                R1 = ADDRESS OF TOP OF SARG                            00290000
*                                                                       00300000
*         RCNN - BUILD FAILED                                           00310000
*                R1 - ADDRESS OF IN PROGRESS TREE NODE                  00320000
*                                                                       00330000
*         RC16 - INSUFFICIENT STORAGE                                   00340000
*                                                                       00350000
**<DOC-OFF>****************************************************         00360000
                                                                        00370000
         EJECT                                                          00380000
         #WORK ,                                                        00390000
                                                                        00400000
WRKSARG  DS    A                  TEMPORARY SARG ADDRESS STORAGE        00410000
                                                                        00420000
         #ENDWORK ,               END OF WORKAREA                       00430000
                                                                        00440000
         EJECT                                                          00450000
         SQLSEMAL ,               SQL SEMANTIC SUMMARY                  00460000
                                                                        00470000
         EJECT                                                          00480000
         TBBNODES ,               TREE NODE DSECTS                      00490000
                                                                        00500000
         EJECT                                                          00510000
         EQUS  ,                                                        00520000
                                                                        00530000
         EJECT                                                          00540000
ITRESARG #ENTER BASE=R12,PREG=R5                                        00550000
                                                                        00560000
         EJECT                                                          00570000
***************************************************************         00580000
*                                                                       00590000
*   INITIALIZE THE SARG HEADER                                          00600000
*                                                                       00610000
***************************************************************         00620000
SARGHDR  DS    0H                                                       00630000
         L     R8,4(,R5)         GET ADDRESS OF STORAGE TO USE          00640000
                                                                        00650000
         STGGET TBS1LEN,QH=(R8)                                         00660000
         BNZ   ERR_HDR                                                  00670000
                                                                        00680000
         MVI   TBS1VER-TBSARG1(R1),TBS1SAV1 LEVEL1 FORMAT               00690000
         ST    R1,WRKSARG         SAVE ADDRESS FOR LATER                00700000
                                                                        00710000
         SR    R0,R0              CLEAR ERROR RETURN REGISTER           00720000
         L     R1,0(,R5)          ADDRESS OF TREE TO BE COPIED          00730000
         BAS   R14,COPYTREE       GO PROCESS THE ENTIRE TREE            00740000
         LTR   R0,R0              SUCCESSFUL PROCESS?                   00750000
         BNZ   ERR_CHN            NO - LET REQUESTOR KNOW               00760000
                                                                        00770000
         L     R2,WRKSARG         GET OUR SARG ADDRESS                  00780000
         ST    R1,TBS1NODE-TBSARG1(R2)  NEW TREE IN SARG                00790000
         LR    R1,R2              RETURN THE SARG HDR POINTER           00800000
                                                                        00810000
***************************************************************         00820000
*                                                                       00830000
*   NORMAL / ABNORMAL COMPLETION                                        00840000
*                                                                       00850000
***************************************************************         00860000
         LA    R0,RSN00           NORMAL COMPLETION                     00870000
         LA    R15,RC00                                                 00880000
         B     EXIT               RETURN                                00890000
                                                                        00900000
ERR_CHN  DS    0H                 COPY FAILED                           00910000
         LA    R15,RC08           SET RETURN CODE , R0 = REASON         00920000
         B     EXIT               RETURN                                00930000
                                                                        00940000
ERR_HDR  DS    0H                                                       00950000
         LA    R0,RSN00                                                 00960000
         LA    R15,RC16                                                 00970000
         SR    R1,R1                                                    00980000
         B     EXIT               RETURN                                00990000
                                                                        01000000
EXIT     DS    0H                                                       01010000
         #EXIT ,                  RETURN                                01020000
                                                                        01030000
         EJECT                                                          01040000
***************************************************************         01050000
*                                                                       01060000
* ROUTINE: COPYTREE - TREE COPY PROCESSING                              01070000
*                                                                       01080000
* ON EXIT:                                                              01090000
*                                                                       01100000
*    R0  CONTAINS EITHER                                                01110000
*                                                                       01120000
*        RSN00 - COPY COMPLETED WITHOUT ERROR                           01130000
*        RSN04 - PREDICATE STORAGE FAILURE                              01140000
*        RSN08 - CONNECTOR STORAGE FAILURE                              01150000
*                                                                       01160000
***************************************************************         01170000
         USING PRBCON,R3           OLD CONNECTOR NODE                   01180000
         USING SBPTERM,R4          OLD PREDICATE NODE                   01190000
         USING TBBPRED,R6          NEW PREDICATE FORM                   01200000
         USING TBCONN,R7           NEW CONNECTOR FORM                   01210000
                                                                        01220000
COPYTREE DS    0H                                                       01230000
         BAKR  R14,0               STACK EVERYTHING ANOTHER LEVEL       01240000
         LTR   R0,R0               CHECK FOR ANY ERROR RETURNS          01250000
         BNZ   COPYEND             IF SET THEN GET OUT AS IS            01260000
         CLI   PRBTYPE-PRBCON(R1),PRB$CON   IS THIS A CONNECTOR?        01270000
         BE    COPYCON             YES - GO PROCESS A CONNECTOR TYPE    01280000
                                                                        01290000
*--------------------------------------------------------------         01300000
*   PROCESS PREDICATE ENTRIES                                           01310000
*--------------------------------------------------------------         01320000
COPYPRED DS    0H                                                       01330000
         LR    R5,R0               RETAIN OLD RETURN FLAG               01340000
         LR    R4,R1               RETAIN OLD PREDICATE ADDRESS         01350000
                                                                        01360000
         STGGET TBPRLEN,QH=(R8)                                         01370000
         BNZ   PRED_ERR                                                 01380000
                                                                        01390000
         LR    R6,R1               POINT TO NEW PREDICATE NODE          01400000
         MVC   TBPRTYPE,SBPNTYPE   PREDICATE TYPE INDICATOR             01410000
         MVC   TBPRTV,SBPTTV       PREDETERMINED TRUTH VALUE            01420000
         MVC   TBPRVTYP,SBPVTYPE   VALUE TYPE                           01430000
         MVC   TBPROPR,SBPCOMP     OPERATOR                             01440000
         MVC   TBPRUWD1,SBPVAL@C   VALUE #CLEX PTR                      01450000
         MVC   TBPRUWD2,SBPCOL@C   COLUMN #CLEX PTR                     01460000
         L     R1,SBPACOL          COLUMN REFERENCE                     01470000
         LH    R2,SQCOLNML-SQCOLREF(R1)   GET INPUT NAME LENGTH         01480000
                                                                        01490000
         STGGET (R2),QH=(R8)                                            01500000
         BNZ   PRED_ERR                                                 01510000
                                                                        01520000
         ST    R1,TBPRCOL          POINTER IN NEW NODE                  01530000
         L     R2,SBPACOL          GET ADDRESS OF OLD COLUMN NAME       01540000
         LH    R9,SQCOLNML-SQCOLREF(R2)   GET INPUT NAME LENGTH         01550000
         STH   R9,TBPRCOLL         AND STORE IT IN THE NEW NODE         01560000
         LA    R2,SQCOLNM-SQCOLREF(R2)  POINT TO COLUMN NAME            01570000
         BCTR  R9,0                PREPARE FOR EX                       01580000
         EX    R9,PREDMOVE         INSERT VALUE                         01590000
         MVC   TBPRVALL,SBPLVAL    VALUE LENGTH                         01600000
                                                                        01610000
         LH    R2,SBPLVAL          ACQUIRE STORAGE FOR VALUE            01620000
         LTR   R2,R2                                                    01630000
         BZ    PREDRTN                                                  01640000
                                                                        01650000
         STGGET (R2),QH=(R8)                                            01660000
         BNZ   PRED_ERR                                                 01670000
                                                                        01680000
         L     R2,SBPAVAL          ADDRESS OF OLD VALUE                 01690000
         LH    R9,SBPLVAL          GET LENGTH OF VALUE                  01700000
         BCTR  R9,0                PREPARE FOR EX                       01710000
         EX    R9,PREDMOVE         MOVE THE VALUE TO ITS FIELD          01720000
         ST    R1,TBPRVAL          SAVE POINTER IN NEW NODE             01730000
                                                                        01740000
PREDRTN  DS    0H                                                       01750000
         LR    R0,R5               RESET RETURN FLAG REGISTER           01760000
         LR    R1,R6               NODE ADDRESS IN REG ONE              01770000
         B     COPYEND             DONE WITH THIS PREDICATE             01780000
                                                                        01790000
PREDMOVE MVC   0(*-*,R1),0(R2)     MOVE THE VALUE INTO NEW NODE         01800000
                                                                        01810000
*--------------------------------------------------------------         01820000
*   PROCESS CONNECTOR ENTRIES                                           01830000
*--------------------------------------------------------------         01840000
COPYCON  DS    0H                                                       01850000
         LR    R5,R0               RETAIN OLD RETURN FLAG               01860000
         LR    R3,R1               RETAIN OLD CONNECTOR ADDRESS         01870000
                                                                        01880000
         STGGET TBCOLEN,QH=(R8)                                         01890000
         BNZ   CONN_ERR                                                 01900000
                                                                        01910000
         LR    R7,R1               SET ADDRESSIBILITY                   01920000
         MVI   TBCOTYPE,TBCO$CON   INDICATE IT IS A CONNECTOR NODE      01930000
         MVC   TBCOCTYP,PRBCONTP   COPY TYPE OF CONNECTOR (AND/OR)      01940000
         MVC   TBCOTV,PRBCTV       PREASSIGNED TRUTH VALUE              01950000
                                                                        01960000
         LR    R0,R5               RESET RETURN FLAG REGISTER           01970000
         L     R1,PRBLEFT          GET LEFT NODE ADDRESS                01980000
         BAS   R14,COPYTREE        GO PROCESS LEFT NODE                 01990000
         LTR   R0,R0               WAS IT SUCCESSFUL?                   02000000
         BNZ   COPYEND             FORGET THE UPDATE - KEEP GOING       02010000
         ST    R1,TBCOLEFT         LEFT PTR IN NEW CONNECTOR NODE       02020000
                                                                        02030000
         LR    R0,R5               RESET RETURN FLAG REGISTER           02040000
         L     R1,PRBRIGHT         GET RIGHT NODE ADDRESS               02050000
         BAS   R14,COPYTREE        GO PROCESS RIGHT NODE                02060000
         LTR   R0,R0               WAS IT SUCCESSFUL?                   02070000
         BNZ   COPYEND             FORGET THE UPDATE - KEEP GOING       02080000
         ST    R1,TBCORGHT         RIGHT PTR IN NEW CONNECTOR NODE      02090000
                                                                        02100000
         LR    R0,R5               RESET RETURN FLAG REGISTER           02110000
         LR    R1,R7               RESET NEW NODE ADDRESS FOR RETURN    02120000
         B     COPYEND             GO CONTINUE PROCESSING ALL NODES     02130000
                                                                        02140000
PRED_ERR DS    0H                                                       02150000
         LA    R0,RC04             ERR GETTING STG FOR A NEW PREDICATE  02160000
         LR    R1,R4               OLD PREDICATE NODE ADDRESS           02170000
                                                                        02180000
CONN_ERR DS    0H                                                       02190000
         LA    R0,RC08             ERR GETTING STG FOR A NEW CONNECTOR  02200000
         LR    R1,R3               OLD CONNECTOR NODE ADDRESS           02210000
                                                                        02220000
COPYEND  DS    0H                                                       02230000
         PR    ,                   UNSTACK ONE LEVEL                    02240000
                                                                        02250000
         EJECT                                                          02260000
***************************************************************         02270000
*                                                                       02280000
*  LITERALS, CONSTANTS AND MAPPINGS                                     02290000
*                                                                       02300000
***************************************************************         02310000
         LTORG ,                                                        02320000
                                                                        02330000
         PRINT NOGEN                                                    02340000
         ICVT  ,                                                        02350000
         ITASK ,                                                        02360000
         END   ,                                                        02370000

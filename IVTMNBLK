IVTMNBLK TITLE 'INTEGRATOR - VTAM SERVICES CREATE MODEL BLOCKS'         00010000
**<DOC-ON>************************************************************* 00020000
*                                                                       00030000
* ROUTINE: IVTMNBLK - INTEGRATOR VTAM SERVICES CREATE MODEL BLKS        00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THIS ROUTINE RUNS ONCE DURING INTEGRATOR INITIALIZATION TO         00080000
*    DYNAMICALLY CREATE MODEL VTAM CONTROL BLOCKS APPROPRIATE           00090000
*    FOR THE SYSTEM INTEGRATOR IS EXECUTING ON.  THE MODEL              00100000
*    CONTROL BLOCKS ARE ANCHORED IN THE IVTAMCVT.                       00110000
*                                                                       00120000
*                                                                       00130000
* ON ENTRY:                                                             00140000
*                                                                       00150000
*    R15 = ENTRY POINT ADDRESS                                          00160000
*    R14 = RETURN ADDRESS                                               00170000
*    R13 = AVAILABLE SAVE AREA                                          00180000
*    R11 = ICVT ADDRESS                                                 00190000
*    R10 = ITASK ADDRESS                                                00200000
*    R09 = IVTAMCVT ADDRESS                                             00210000
*                                                                       00220000
* ON EXIT:                                                              00230000
*                                                                       00240000
*    R15 = 0                                                            00250000
*    R00 = 0                                                            00260000
*    R01 = 0                                                            00270000
*                                                                       00280000
*    ALL OTHER REGISTERS ARE RESTORED                                   00290000
*                                                                       00300000
**<DOC-OFF>************************************************************ 00310000
                                                                        00320000
         EJECT ,                                                        00330000
*********************************************************************** 00340000
*                                                                       00350000
* MAINTENANCE:                                                          00360000
*                                                                       00370000
*   08/01/93 RANDY WITEK                                                00380000
*                                                                       00390000
*********************************************************************** 00400000
         EQUS  ,                  GENERAL EQUATES                       00410000
                                                                        00420000
RICVT    EQU   R11                                                      00430000
RITASK   EQU   R10                                                      00440000
RIVTAM   EQU   R9                                                       00450000
RIACB    EQU   R8                                                       00460000
RIRPL    EQU   R7                                                       00470000
RINIB    EQU   R6                                                       00480000
                                                                        00490000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00500000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00510000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00520000
         USING IACB,RIACB         ESTABLISH ADDRESSABILITY              00530000
         USING IRPL,RIRPL         ESTABLISH ADDRESSABILITY              00540000
         USING ISTDNIB,RINIB      ESTABLISH ADDRESSABILITY              00550000
                                                                        00560000
*---------------------------------------------------------------------- 00570000
*   S A V E   A N D   W O R K I N G   S T O R A G E                     00580000
*---------------------------------------------------------------------- 00590000
                                                                        00600000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00610000
WRK256   DS    XL256              GENERAL WORKAREA                      00620000
RETR15   DS    F                  RETURN CODE VALUE                     00630000
RETR0    DS    F                  RETURN REGISTER 0                     00640000
RETR1    DS    F                  RETURN REGISTER 1                     00650000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00660000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00670000
                                                                        00680000
*---------------------------------------------------------------------- 00690000
*   M E S S A G E   D E F A U L T S                                     00700000
*---------------------------------------------------------------------- 00710000
                                                                        00720000
         $MSGDFT PREFIX=ICTPID,COMPID='VTM',TABLE=*#MSGS,              +00730000
               PRINT=NOGEN,WORKA=0,MF=(E,WRK256)                        00740000
                                                                        00750000
*---------------------------------------------------------------------- 00760000
*   M O D U L E   E N T R Y                                             00770000
*---------------------------------------------------------------------- 00780000
                                                                        00790000
IVTMNBLK #ENTER BASE=R12,         R12 IS BASE REGISTER                 +00800000
               AMODE=31,                                               +00810000
               RMODE=ANY,                                              +00820000
               SAVE=YES,          ALLOCATE SAVE/WORK AREA              +00830000
               PREG=R2,           SAVE R1 PARM IN R2                   +00840000
               RESTENV=NO,        ICVT AND ITASK POINTERS ARE OK       +00850000
               WAPASS=NO,         NO WORK AREA PASSED IN R0            +00860000
               LINKAGE=STD        CALLED BY BAS/BASR                    00870000
                                                                        00880000
*---------------------------------------------------------------------- 00890000
* GENCB MODEL ACB EXIT LIST                                             00900000
*---------------------------------------------------------------------- 00910000
                                                                        00920000
         GENCB AM=VTAM,MF=(G,WRK256,SIZGACBX),                         +00930000
               BLK=EXLST,                                              +00940000
               SCIP=(*,IVT@XSCP),                                      +00950000
               RESP=(*,IVT@XRSP),                                      +00960000
               DFASY=(*,IVT@XDFA),                                     +00970000
               SYNAD=(*,IVT@XSYN),                                     +00980000
               LERAD=(*,IVT@XLER),                                     +00990000
               TPEND=(*,IVT@XTPN),                                     +01000000
               LOGON=(*,IVT@XLOG),                                     +01010000
               NSEXIT=(*,IVT@XNSX),                                    +01020000
               RELREQ=(*,IVT@XREL),                                    +01030000
               LOSTERM=(*,IVT@XLOS)                                     01040000
                                                                        01050000
         LTR   R15,R15            GENCB OK?                             01060000
         BNZ   ERRGENCB           BRANCH IF NOT                         01070000
         STM   R0,R1,IVT_ACBX     SET MODEL ADDRESS IN IVTAMCVT         01080000
                                                                        01090000
*---------------------------------------------------------------------- 01100000
* GENCB MODEL ACB                                                       01110000
*---------------------------------------------------------------------- 01120000
                                                                        01130000
         GENCB AM=VTAM,MF=(G,WRK256,SIZGACB),                          +01140000
               BLK=ACB,                                                +01150000
               MACRF=LOGON,                                            +01160000
               EXLST=(*,IVT_ACXA)                                       01170000
                                                                        01180000
         LTR   R15,R15            GENCB OK?                             01190000
         BNZ   ERRGENCB           BRANCH IF NOT                         01200000
         STM   R0,R1,IVT_ACB      SET MODEL ADDR/LENG IN IVTAMCVT       01210000
         C     R0,=A(IVTACBSZ)    DOES ACB FIT IN IACB RESERVED SPACE?  01220000
         BH    ERRGENSZ           BRANCH IF NOT                         01230000
                                                                        01240000
         TM    ICTSTAT2,ICT2$APF  ARE WE APF AUTHORIZED?                01250000
         BNO   GENDACB            BRANCH IF NOT                         01260000
X        USING IACB,R1                                                  01270000
         OI    X.ACBOPT1,ACBSRBEX REQUEST SRBEXITS                      01280000
         OI    X.ACBOPT1,ACBSRBEX REQUEST SRBEXITS                      01290000
         OI    X.ACBOPT1,ACBKPFRR REQUEST TO KEEP FRR STACK             01300000
         DROP  X                                                        01310000
                                                                        01320000
GENDACB  DS    0H                                                       01330000
                                                                        01340000
*---------------------------------------------------------------------- 01350000
* GENCB MODEL NIB                                                       01360000
*---------------------------------------------------------------------- 01370000
                                                                        01380000
         GENCB AM=VTAM,MF=(G,WRK256,SIZGNIB),                          +01390000
               BLK=NIB,                                                +01400000
               SDT=SYSTEM,                                             +01410000
               LISTEND=YES,                                            +01420000
               MODE=RECORD,                                            +01430000
               PROC=(RESPX,ORDRESP,DFASYX,SYSRESP)                      01440000
                                                                        01450000
         LTR   R15,R15            GENCB OK?                             01460000
         BNZ   ERRGENCB           BRANCH IF NOT                         01470000
         STM   R0,R1,IVT_NIB      SET MODEL ADDR/LENG IN IVTAMCVT       01480000
         C     R0,=A(IVTNIBSZ)    DOES NIB FIT IN INIB RESERVED SPACE?  01490000
         BH    ERRGENSZ           BRANCH IF NOT                         01500000
                                                                        01510000
*---------------------------------------------------------------------- 01520000
* GENCB MODEL RPL                                                       01530000
*---------------------------------------------------------------------- 01540000
                                                                        01550000
         L     R2,IVT@XRPL        RPL EXIT ROUTINE ADDRESS              01560000
                                                                        01570000
         GENCB AM=VTAM,MF=(G,WRK256,SIZGRPL),                          +01580000
               BLK=RPL,                                                +01590000
               ARG=0,                                                  +01600000
               EXIT=(R2),                                              +01610000
               CHAIN=ONLY,                                             +01620000
               POST=SCHED,                                             +01630000
               OPTCD=(ASY,KEEP),                                       +01640000
               RTYPE=(NDFSYN,NDFASY,NRESP),                            +01650000
               RESPOND=(NEX,FME,NRRN,NQRESP)                            01660000
                                                                        01670000
         LTR   R15,R15            GENCB OK?                             01680000
         BNZ   ERRGENCB           BRANCH IF NOT                         01690000
         STM   R0,R1,IVT_RPL      SET MODEL ADDR/LENG IN IVTAMCVT       01700000
         C     R0,=A(IVTRPLSZ)    DOES RPL FIT IN IRPL RESERVED SPACE?  01710000
         BH    ERRGENSZ           BRANCH IF NOT                         01720000
                                                                        01730000
*---------------------------------------------------------------------- 01740000
* MODCB THE MODEL RPL FOR FASTPATH BRANCH ENTRY IF MVS AUTHORIZED       01750000
*---------------------------------------------------------------------- 01760000
                                                                        01770000
         TM    ICTSTAT2,ICT2$APF  ARE WE APF AUTHORIZED?                01780000
                                                                        01790000
         BNO   GETMODEL           BRANCH IF NOT                         01800000
                                                                        01810000
         MODCB AM=VTAM,MF=(G,WRK256,SIZGRPLM),                         +01820000
               RPL=(*,IVT_RPLA),                                       +01830000
               BRANCH=YES         ENABLE FASTPATH IF MVS AUTHORIZED     01840000
                                                                        01850000
*---------------------------------------------------------------------- 01860000
* CREATE A COMPLETE MODEL OF THE IACB                                   01870000
*---------------------------------------------------------------------- 01880000
                                                                        01890000
GETMODEL DS    0H                                                       01900000
                                                                        01910000
         LA    R3,L'IAC           LENGTH OF AN IACB                     01920000
         ST    R3,IVT_IACL        SET LENGTH OF MODEL IN IVTAMCVT       01930000
                                                                        01940000
         $GETSTOR (R3),                                                +01950000
               LOC=ANY,                                                +01960000
               OWNER=(RITASK)     ALLOCATE MODEL IACB                   01970000
                                                                        01980000
         LR    RIACB,R1           ESTABLISH ADDESSIBILITY               01990000
         ST    RIACB,IVT_IACA     SET MODEL ADDRESS IN IVTAMCVT         02000000
         MVC   IACID,=CL8'IACB'   SET THE CBID                          02010000
         ST    RICVT,IACICVT      SET INTEGRATOR CVT ADDRESS IN MODEL   02020000
         ST    R3,IACLEN          SET THE IMBEDDED LENGTH CONSTANT      02030000
         L     R4,IVT_ACBA        MVCL ORIGIN (VTAM ACB)                02040000
         L     R5,IVT_ACBL        MVCL ORIGIN LENGTH (VTAM ACB LENGTH)  02050000
         LR    R2,RIACB           MVCL DESTINATION                      02060000
         LR    R3,R5              MVCL DESTINATION LENGTH               02070000
         MVCL  R2,R4              COPY ACB INTO IACB MODEL              02080000
         MVC   IACRECSZ(4),=A(IVTRECSZ) SET INITIAL RECEIVE-ANY SIZE    02090000
                                                                        02100000
*---------------------------------------------------------------------- 02110000
* CREATE A COMPLETE MODEL OF THE IRPL                                   02120000
*---------------------------------------------------------------------- 02130000
                                                                        02140000
         LA    R3,L'IRP           LENGTH OF AN IRPL                     02150000
         ST    R3,IVT_IRPS        SET LENGTH OF MODEL IN IVTAMCVT       02160000
                                                                        02170000
         $GETSTOR (R3),                                                +02180000
               LOC=ANY,                                                +02190000
               OWNER=(RITASK)     ALLOCATE MODEL IRPL                   02200000
                                                                        02210000
         LR    RIRPL,R1           ESTABLISH ADDESSIBILITY               02220000
         ST    RIRPL,IVT_IRPA     SET MODEL ADDRESS IN IVTAMCVT         02230000
         MVC   IRPID,=CL8'IRPL'   SET THE CBID                          02240000
         ST    R3,IRPLEN          SET THE IMBEDDED LENGTH CONSTANT      02250000
         L     R4,IVT_RPLA        MVCL ORIGIN (VTAM RPL)                02260000
         L     R5,IVT_RPLL        MVCL ORIGIN LENGTH (VTAM RPL LENGTH)  02270000
         LR    R2,RIRPL           MVCL DESTINATION                      02280000
         LR    R3,R5              MVCL DESTINATION LENGTH               02290000
         MVCL  R2,R4              COPY RPL INTO IRPL MODEL              02300000
                                                                        02310000
*---------------------------------------------------------------------- 02320000
* CREATE A COMPLETE MODEL OF THE INIB                                   02330000
*---------------------------------------------------------------------- 02340000
                                                                        02350000
         LA    R3,L'INI           LENGTH OF AN INIB                     02360000
         ST    R3,IVT_INIL        SET LENGTH OF MODEL IN IVTAMCVT       02370000
                                                                        02380000
         $GETSTOR (R3),                                                +02390000
               LOC=ANY,                                                +02400000
               OWNER=(RITASK)     ALLOCATE MODEL INIB                   02410000
                                                                        02420000
         LR    RINIB,R1           ESTABLISH ADDESSIBILITY               02430000
         ST    RINIB,IVT_INIA     SET MODEL ADDRESS IN IVTAMCVT         02440000
         MVC   INIID,=CL8'INIB'   SET THE CBID                          02450000
         ST    R3,INILEN          SET THE IMBEDDED LENGTH CONSTANT      02460000
         L     R4,IVT_NIBA        MVCL ORIGIN (VTAM NIB)                02470000
         L     R5,IVT_NIBL        MVCL ORIGIN LENGTH (VTAM NIB LENGTH)  02480000
         LR    R2,RINIB           MVCL DESTINATION                      02490000
         LR    R3,R5              MVCL DESTINATION LENGTH               02500000
         MVCL  R2,R4              COPY NIB INTO INIB MODEL              02510000
                                                                        02520000
*---------------------------------------------------------------------- 02530000
*   R E T U R N   T O   C A L L E R                                     02540000
*---------------------------------------------------------------------- 02550000
                                                                        02560000
RETURN   DS    0H                                                       02570000
                                                                        02580000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 02590000
                                                                        02600000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    02610000
                                                                        02620000
*---------------------------------------------------------------------- 02630000
* ERROR ROUTINES                                                        02640000
*---------------------------------------------------------------------- 02650000
                                                                        02660000
ERRGENSZ DS    0H                                                       02670000
                                                                        02680000
         $ABEND ABE_VTGENSZ,                                           +02690000
               SCOPE=PCB,                                              +02700000
               TITLE='VTAM - UNEXPECTED SIZE FOR GENCB''D BLOCK'        02710000
                                                                        02720000
ERRGENCB DS    0H                                                       02730000
                                                                        02740000
         $ABEND ABE_VTGENCB,                                           +02750000
               SCOPE=PCB,                                              +02760000
               TITLE='VTAM - GENCB FAILED DURING INITIALIZATION'        02770000
                                                                        02780000
*---------------------------------------------------------------------- 02790000
* CAUSE ASSEMBLY ERRORS IF GENERATE-TYPE PLISTS EXCEED THE WORK AREA    02800000
*---------------------------------------------------------------------- 02810000
                                                                        02820000
         DS    0XL(L'WRK256-SIZGACBX)  GENCB ACB EXLIST PLIST CHECK     02830000
         DS    0XL(L'WRK256-SIZGACB)   GENCB ACB PLIST CHECK            02840000
         DS    0XL(L'WRK256-SIZGNIB)   GENCB NIB PLIST CHECK            02850000
         DS    0XL(L'WRK256-SIZGRPL)   GENCB RPL PLIST CHECK            02860000
         DS    0XL(L'WRK256-SIZGRPLM)  MODCB RPL PLIST CHECK            02870000
                                                                        02880000
*---------------------------------------------------------------------- 02890000
*   C O N S T A N T S   A N D   L I T E R A L S                         02900000
*---------------------------------------------------------------------- 02910000
                                                                        02920000
         LTORG ,                                                        02930000
                                                                        02940000
*---------------------------------------------------------------------- 02950000
*   D S E C T S                                                         02960000
*---------------------------------------------------------------------- 02970000
                                                                        02980000
         PRINT NOGEN                                                    02990000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                03000000
         ISTDBIND ,               VTAM BIND IMAGE                       03010000
         ICVT  ,                  INTEGRATOR CVT                        03020000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   03030000
         ITASK ,                  INTEGRATOR TASK BLOCK                 03040000
         IVUSER ,                 INTEGRATOR VTAM TASK BLOCK            03050000
         IACB ,                   INTEGRATOR VTAM ACB+                  03060000
         IRPL ,                   INTEGRATOR VTAM RPL+                  03070000
         INIB ,                   INTEGRATOR VTAM NIB+                  03080000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       03090000
         EVCODES ,                INTEGRATOR EVENT CODES                03100000
         ABCODES ,                INTEGRATOR $ABEND CODES               03110000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     03120000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             03130000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             03140000
         IFGEXLST ,               VTAM EXIT LIST                        03150000
         END   ,                                                        03160000

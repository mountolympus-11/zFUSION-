IRCVRTRY TITLE '- ESTAE WORKUNIT TERMINATION / RETRY INTERFACE'         00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: IRCVRTRY - ESTAE TERMINATION / RETRY INTERFACE               00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine is a continuation of the ESTAE recovery               00080000
*    logic initially scheduled under an IRB.  Because the retry         00090000
*    routine runs under the PRB, STDENV facilities are available        00100000
*    to it.                                                             00110000
*                                                                       00120000
*    This routine constructs and journals messages describing           00130000
*    the failure and the work unit affected.  If retry is               00140000
*    requested, registers are reloaded accordingly and the retry        00150000
*    routine is branch entered via R15.                                 00160000
*                                                                       00170000
*    If retry is not requested or permitted, control is passed          00180000
*    to the process or ITASK epilog as dictated by the execution        00190000
*    environment at time of failure.                                    00200000
*                                                                       00210000
*                                                                       00220000
* NOTES:                                                                00230000
*                                                                       00240000
*    Control is passed to this routine via SETRP by the IRCVESTA        00250000
*    ESTAE exit routine.  This routine is a continuation of that        00260000
*    logic.                                                             00270000
*                                                                       00280000
*    $FRAME RECOVER is issued if RETRY is scheduled at the PROCess      00290000
*    level.  In all other cases, we exit to PROCess or ITASK            00300000
*    termination which is responsible for performing the                00310000
*    appropriate cleanup.  This ensures that resource management        00320000
*    (RMX) routines will have a chance to inspect the working           00330000
*    storage associated with the failing workunit.                      00340000
*                                                                       00350000
*                                                                       00360000
* ON ENTRY:                                                             00370000
*                                                                       00380000
*    R15 - EPA                                                          00390000
*    R14 - N/A                                                          00400000
*    R13 - Workarea acquired by the recovery routine                    00410000
*    R11 - ICVT ADDRESS                                                 00420000
*    R10 - ITASK ADDRESS                                                00430000
*    R1  - SDWA address                                                 00440000
*                                                                       00450000
*                                                                       00460000
* ON EXIT:                                                              00470000
*                                                                       00480000
*    If a retry has been requested, control is passed to the            00490000
*    retry routine with the registers established by the                00500000
*    recovery routine.                                                  00510000
*                                                                       00520000
*    If the PROCess is to terminate, control is returned to             00530000
*    the process epilog.                                                00540000
*                                                                       00550000
*    If the ITASK is to terminate, control is returned to the           00560000
*    ITASK epilog                                                       00570000
*                                                                       00580000
**<DOC-OFF>****************************************************         00590000
                                                                        00600000
         EJECT                                                          00610000
**<DOC-ON>*****************************************************         00620000
*                                                                       00630000
* MAINTENANCE:                                                          00640000
*                                                                       00650000
*    06/03/94 T. WELTZER                                                00660000
*             Added logic to clean-up C environment and refresh it.     00670000
*                                                                       00680000
*    06/15/94 T. WELTZER                                                00690000
*             Added message logic for SVC dumps.                        00700000
*                                                                       00710000
*    12/12/94 R. Turgeon                                                00720000
*             Added FORCE=YES to all ABEND class $TRACE requests        00730000
*             ensuring that these diagnostic entries are always         00740000
*             generated.                                                00750000
*                                                                       00760000
*    12/12/94 T. WELTZER                                                00770000
*             Switch SAS/C clean-up to frame recovery mechanism         00780000
*                                                                       00790000
**<DOC-OFF>****************************************************         00800000
                                                                        00810000
         EJECT                                                          00820000
         $SDUMP DSECT=YES                                               00830000
                                                                        00840000
         RCVYWORK ,               RECOVERY ROUTINE WORKING STORAGE      00850000
                                                                        00860000
         EJECT                                                          00870000
         ITASK ,                                                        00880000
                                                                        00890000
         EJECT                                                          00900000
         IPCB  ,                                                        00910000
                                                                        00920000
         EJECT                                                          00930000
         $TASK DSECT=YES          $TASK SERVICES                        00940000
                                                                        00950000
         EJECT                                                          00960000
         FRCA ,                   SAVEAREA FRAME CONTROL AREA           00970000
                                                                        00980000
         EJECT                                                          00990000
         @CB  WORKUNIT=YES        workunit prefix                       01000000
                                                                        01010000
         EJECT                                                          01020000
         TRTABLE ,                TRACE TABLE MAINTENANCE MAPS          01030000
                                                                        01040000
         EJECT                                                          01050000
         TRACODES ,               TRACE TABLE ENTRY CODES               01060000
                                                                        01070000
         ABCODES ,                $ABEND CODES                          01080000
                                                                        01090000
         EQUS  ,                                                        01100000
                                                                        01110000
         $MSGDFT PREFIX=ICTPID,COMPID='RCV',TABLE=*#MSGS,              X01120000
               CONID=*ICTCONID,CONNAME=ICTCONNM,                       X01130000
               PRINT=NOGEN,MF=(E,WK256)                                 01140000
                                                                        01150000
         EJECT ,                                                        01160000
IRCVRTRY CSECT                                                          01170000
IRCVRTRY AMODE 31                                                       01180000
IRCVRTRY RMODE ANY                                                      01190000
                                                                        01200000
         LR    R12,R15            PROGRAM BASE                          01210000
         USING IRCVRTRY,R12       LOCAL ADDRESSABILITY                  01220000
                                                                        01230000
         @CPYRYT ,                                                      01240000
                                                                        01250000
         USING WORKAREA,R13       WORKAREA PROVIDED BY RECOVERY RTN     01260000
         USING ICVT,R11           STDENV                                01270000
         USING ITASK,R10          STDENV                                01280000
                                                                        01290000
         LR    R8,R1              SDWA                                  01300000
         USING SDWA,R8            NOW OUR RESPONSIBILITY                01310000
         L     R7,SDWAXPAD        SDWA EXTENSION AREA PTRS              01320000
         USING SDWAPTRS,R7        PTR EXTENSION IS ALWAYS PRESENT       01330000
                                                                        01340000
         L     R9,TSK@ERR         ADDRESSABILITY                        01350000
         USING TSKERR,R9          TO ITASK ERROR / RECOVERY SEG         01360000
                                                                        01370000
         NI    TSKFLGS,FF-TSK$ABE ESTAE EXIT NO LONGER IN CONTROL       01380000
         OI    TSKFLGS2,TSK$RCVY  ESTAE RECOVERY ROUTINE IN CONTROL     01390000
                                                                        01400000
         EJECT ,                                                        01410000
***************************************************************         01420000
*                                                                       01430000
*   CONSTRUCT FAILURE LOG ENTRY                                         01440000
*                                                                       01450000
***************************************************************         01460000
         MVI   LOGDEST,$LOGFILE+$JOBLOG                                 01470000
         TM    ICTSTAT3,ICT3$STC  OPR HAS RESPONSIBILITIES?             01480000
         BZ    *+8                SKIP IF NOT                           01490000
         OI    LOGDEST,$CONSOLE   INFORM CONSOLE OPERATOR AS WELL       01500000
                                                                        01510000
         MVI   DUMPDEST,$JOBLOG   ASSUME PRODUCT LOG NOT AVAIL          01520000
         ICM   R0,15,ICTTSKLG     PRODUCT LOG AVAILABLE?                01530000
         BZ    PLOGFAIL           SKIP IF NOT                           01540000
         CLC   TSKNAME,=CL8'$LOGTASK'                                   01550000
         BE    PLOGFAIL           LOGTASK IS FAILING                    01560000
         MVI   DUMPDEST,$LOGFILE  ELSE SWITCH TO PREFERRED DEST         01570000
PLOGFAIL DS    0H                                                       01580000
                                                                        01590000
*--------------------------------------------------------------         01600000
*   ROUTE FAILURE LOG AND INDICATIVE DUMP TO SELECTED DESTS             01610000
*--------------------------------------------------------------         01620000
         TM    TSKELOGF,TSKELG_LOG                                      01630000
         BNO   NOLOG1                                                   01640000
                                                                        01650000
         $MSG  001,DEST=LOGDEST,  TITLE                                X01660000
               FIELDS=((*TSKELAB@,*TSKELABL))                           01670000
                                                                        01680000
NOLOG1   DS    0H                                                       01690000
         TM    STATFLGS,STAT_DMP  SVC DUMP ATTEMPTED ?                  01700000
         BNO   NOSVCDMP           NO, NO SVC DUMP                       01710000
         ICM   R14,15,SDUMPRC     DUMP RETURN CODE                      01720000
         BM    IDMPERR            DUMP PROBLEM ? YES, REPORT IT         01730000
*                                 NO, REPORT SVC DUMP RESULT            01740000
                                                                        01750000
         $MSG  009,DEST=LOGDEST,FIELDS=(SDUMPRC,SDUMPRSN)               01760000
         B     NOSVCDMP                                                 01770000
                                                                        01780000
IDMPERR  DS    0H                 SVC DUMP SUPRESSED                    01790000
         LA    R2,$NOTAPF         ASSUME NOT APF AUTHORIZED             01800000
         LA    R3,L'$NOTAPF                                             01810000
         C     R14,=F'-4'         EXCUSE: "NOT APF AUTHORIZED" ?        01820000
         B     NOSVCDMP             YES, DON'T REPORT IT                01830000
*        BE    DMPMSG               YES, REPORT IT                      01840000
         LA    R2,$SDMPLMT          NO, DUMP LIMIT EXCEEDED             01850000
         LA    R3,L'$SDMPLMT                                            01860000
DMPMSG   DS 0H                                                          01870000
                                                                        01880000
         $MSG  008,DEST=LOGDEST,FIELDS=(((R2),(R3)))                    01890000
                                                                        01900000
NOSVCDMP DS 0H                                                          01910000
                                                                        01920000
*------- FAILING PSW, COMPLETION CODES, ADDRESSES -------------         01930000
                                                                        01940000
         TM    TSKEABFL,TSKEAB_DUMP                                     01950000
         BNO   NOIDUMP                                                  01960000
                                                                        01970000
         $MSG  011,DEST=DUMPDEST, LMOD, PROCESS, CSECT NAMES           X01980000
               FIELDS=(TSKELMOD,TSKECSEC,TSKNAME,TSKEPCBN,             X01990000
               TSKELORG,TSKECORG,OFFTYPE,OFFSET)                        02000000
                                                                        02010000
         $MSG  012,DEST=DUMPDEST, PSW AND ABEND CODE/REASON            X02020000
               FIELDS=((SDWAEC1+0,4),(SDWAEC1+4,4),                    X02030000
               ABETYPE,TSKERC,TSKERSN,SDWAICD1,SDWAILC1)                02040000
                                                                        02050000
         CLC   SDWAICD1,=X'0010'  TRANSLATION EXCEPTION                 02060000
         BL    NPAGEX             SKIP IF NOT                           02070000
         CLC   SDWAICD1,=X'0012'  TRANSLATION EXCEPTION                 02080000
         BH    NPAGEX             SKIP IF NOT                           02090000
                                                                        02100000
         $MSG  013,DEST=DUMPDEST, TRANSLATION ADDRESS INFO             X02110000
               FIELDS=(TSKETRAN,TSKETEAR)                               02120000
NPAGEX   DS    0H                                                       02130000
                                                                        02140000
                                                                        02150000
*------- ENVIRONMENTAL DATA -----------------------------------         02160000
                                                                        02170000
         $MSG  014,DEST=DUMPDEST, ENVIRONMENTAL INFORMATION            X02180000
               FIELDS=(ENVIRON,ASCMODE)                                 02190000
                                                                        02200000
                                                                        02210000
*------- GENERAL PURPOSE REGISTERS ----------------------------         02220000
                                                                        02230000
         $MSG  018,DEST=DUMPDEST, GENERAL REGISTERS                    X02240000
               FIELDS=(TSKEGR0,TSKEGR1,TSKEGR2,TSKEGR3,                X02250000
               TSKEGR4,TSKEGR5,TSKEGR6,TSKEGR7,                        X02260000
               TSKEGR8,TSKEGR9,TSKEGRA,TSKEGRB,                        X02270000
               TSKEGRC,TSKEGRD,TSKEGRE,TSKEGRF)                         02280000
                                                                        02290000
                                                                        02300000
*------- ACCESS REGISTERS -------------------------------------         02310000
                                                                        02320000
         TM    STATFLGS,STAT_AR   ACCESS REGISTER MODE AT ABEND TIME    02330000
         BNO   NOAREGS            SKIP USELESS INFO                     02340000
         ICM   R6,15,SDWASRVP     RECORDABLE EXTENSION PROVIDED?        02350000
         BZ    NOAREGS            SKIP IF NOT                           02360000
         USING SDWARC1,R6         TEMP ADDRESSABILITY TO EXTENSION      02370000
                                                                        02380000
         $MSG  019,DEST=DUMPDEST, ACCESS REGISTERS                     X02390000
               FIELDS=(SDWAARE0,SDWAARE1,SDWAARE2,SDWAARE3,            X02400000
               SDWAARE4,SDWAARE5,SDWAARE6,SDWAARE7,                    X02410000
               SDWAARE8,SDWAARE9,SDWAAREA,SDWAAREB,                    X02420000
               SDWAAREC,SDWAARED,SDWAAREE,SDWAAREF)                     02430000
         DROP  R6                 SDWARC1 - RECORDABLE EXTENSION        02440000
                                                                        02450000
NOAREGS  DS    0H                                                       02460000
                                                                        02470000
*--------------------------------------------------------------         02480000
*   TRACE FORMATTER                                                     02490000
*--------------------------------------------------------------         02500000
         TM    STATFLGS,STAT_SWI  INDICATE TRACE TABLE SWITCHED?        02510000
         BNO   INDICEND           DONE IF NOT                           02520000
                                                                        02530000
         L     R2,ICTRTPTR        LOCATE TRACE TABLE HEADER             02540000
         USING TRTHDR,R2          MAP                                   02550000
                                                                        02560000
         @CALL ITRCLOG,(*TRTHVECT,*ICTRCLOG),                          X02570000
               CTYPE=CVT,MF=(E,WK256)                                   02580000
                                                                        02590000
         DROP  R2                 TRTHDR                                02600000
                                                                        02610000
*--------------------------------------------------------------         02620000
*   CAPTURE OF ENVIRONMENT COMPLETE - REACTIVATE TRACE TABLE            02630000
*--------------------------------------------------------------         02640000
INDICEND DS    0H                                                       02650000
         $MSG  010,DEST=LOGDEST   INDICATIVE DUMP LOGGED                02660000
                                                                        02670000
NOIDUMP  DS    0H                                                       02680000
         TM    STATFLGS,STAT_SWI  INDICATE TRACE TABLE SWITCHED?        02690000
         BNO   ACTIVTRC           SKIP REACTIVATION IF NOT              02700000
                                                                        02710000
         $TRACE TYPE=POP,         RESUME RECORDING IN MAIN TABLE       X02720000
               TASK=*PTRITASK,    ASSOCIATED TASK                      X02730000
               PCB=*PTRIPCB,      ASSOCIATED PROCESS                   X02740000
               MF=(E,WK256)                                             02750000
                                                                        02760000
ACTIVTRC DS    0H                                                       02770000
                                                                        02780000
         EJECT ,                                                        02790000
***************************************************************         02800000
*                                                                       02810000
*   RELEASE THE SDWA                                                    02820000
*                                                                       02830000
***************************************************************         02840000
         SR    R2,R2              PREPARE FOR INSERT                    02850000
         SR    R3,R3              PREPARE FOR INSERT                    02860000
         IC    R3,SDWASPID        SUPBOOL                               02870000
         ICM   R2,7,SDWALNTH      LENGTH                                02880000
                                                                        02890000
         STORAGE RELEASE,ADDR=(R8),LENGTH=(R2),SP=(R3)                  02900000
                                                                        02910000
         DROP  R8,R7              WORKAREA, SDWA AND EXTENSIONS         02920000
                                                                        02930000
***************************************************************         02940000
*                                                                       02950000
*  ITASK TERMINATION                                                    02960000
*                                                                       02970000
***************************************************************         02980000
         TM    TSKEABFL,TSKEAB_ITASK                                    02990000
         BNO   RTRYPCB            ITASK TERMINATION NOT SCHEDULED       03000000
         TM    TSKELOGF,TSKELG_LOG                                      03010000
         BNO   RTRYTASK           SUPPRESS TERMINATION MSGS IF NO LOG   03020000
                                                                        03030000
         $MSG  020,DEST=LOGDEST,                                       X03040000
               FIELDS=(TSKNAME)                                         03050000
                                                                        03060000
RTRYTASK DS    0H                                                       03070000
         $TRACE *=A(TRC_ABENDTASK),16,FORCE=YES                         03080000
         BNZ   *+10               TRACE INACTIVE                        03090000
         MVC   0(L'TSKNAME,R1),TSKNAME                                  03100000
                                                                        03110000
*--------------------------------------------------------------         03120000
*  RELEASE SAVE AREA AND ABEND TASK                                     03130000
*--------------------------------------------------------------         03140000
         STORAGE RELEASE,ADDR=(R13),LENGTH=WORKLEN                      03150000
                                                                        03160000
         ICM   R13,15,TSKSAVE@    RESTORE ORIGINAL SAVEAREA ADDR        03170000
         BNZ   RTRYEPLG           STANDARD $TASK ENVIRONMENT            03180000
                                                                        03190000
         ABEND SYSABE_NTEPLG      UNRECOVERABLE TASK                    03200000
                                                                        03210000
RTRYEPLG DS    0H                                                       03220000
         NI    TSKFLGS2,FF-TSK$RCVY   RECOVERY ROUTINE COMPLETE         03230000
         L     R14,12(,R13)       RETURN ADDRESS                        03240000
         L     R15,#TSKEPLG       EPILOG ENTRY ADDRESS                  03250000
         BR    R15                SCHEDULE TASKMGR EPILOG               03260000
                                                                        03270000
***************************************************************         03280000
*                                                                       03290000
*   PROCESS RECOVERY                                                    03300000
*                                                                       03310000
***************************************************************         03320000
RTRYPCB  DS    0H                 TERMINATE PROCESS                     03330000
         ICM   R0,15,TSKERCVP     RECOVERY ROUTINE DEFINED?             03340000
         BZ    RTRYPERC           CANT RECOVER WITHOUT ONE              03350000
                                                                        03360000
         $TRACE *=A(TRC_ABENDRETRY),16,FORCE=YES                        03370000
         BNZ   *+10               TRACE INACTIVE                        03380000
         MVC   0(4,R1),TSKERCVP   RETRY ROUTINE EPA                     03390000
                                                                        03400000
*--------------------------------------------------------------         03410000
*   REPAIR AND/OR RELEASE SAVEAREA STACK FRAMES                         03420000
*--------------------------------------------------------------         03430000
         $FRAME RECOVER,RETRYSA=*TSKERCVR+(4*R13),WORKUNIT=*TSKPCBC     03440000
                                                                        03450000
*--------------------------------------------------------------         03460000
*   RELEASE WORKAREAS AND RESTART THE RECOVERED PROCESS                 03470000
*--------------------------------------------------------------         03480000
NOSAVE   DS    0H                                                       03490000
         STORAGE RELEASE,ADDR=(R13),LENGTH=WORKLEN                      03500000
                                                                        03510000
         NI    TSKFLGS2,FF-TSK$RCVY   RECOVERY ROUTINE COMPLETE         03520000
         L     R15,TSKERCVP       RESUMPTION ROUTINE ADDR               03530000
         LM    R0,R14,TSKERCVR    ESTABLISH RESUMPTION REGS             03540000
         BR    R15                RESTART RECOVERED PROCESS             03550000
                                                                        03560000
***************************************************************         03570000
*                                                                       03580000
*   PROCESS TERMINATION                                                 03590000
*                                                                       03600000
***************************************************************         03610000
RTRYPERC DS    0H                 TERMINATE PROCESS                     03620000
         L     R6,TSKPCBC         LOCATE CURRENT PCB                    03630000
         USING IPCB,R6            TEMPORARY BASE                        03640000
                                                                        03650000
         TM    TSKELOGF,TSKELG_LOG                                      03660000
         BNO   RTRYLPCB           SUPPRESS RECOVERY MSGS IF NOT LOGGING 03670000
         LA    R2,021             PRESUME PERCOLATE                     03680000
         ICM   R0,15,TSKERCVP     RETRY / RESUME ADDR?                  03690000
         BZ    *+8                ATTEMPT RETRY IF SO                   03700000
         LA    R2,022             ATTEMPTING RETRY                      03710000
                                                                        03720000
         $MSG  (R2),DEST=LOGDEST,                                      X03730000
               FIELDS=(TSKNAME,PCBNAME)                                 03740000
                                                                        03750000
RTRYLPCB DS    0H                                                       03760000
         $TRACE *=A(TRC_ABENDPCB),16,FORCE=YES                          03770000
         BNZ   NPCBTRC            TRACE INACTIVE                        03780000
         MVC   0(8,R1),TSKNAME                                          03790000
         MVC   8(8,R1),PCBNAME                                          03800000
                                                                        03810000
NPCBTRC  DS    0H                                                       03820000
         STORAGE RELEASE,ADDR=(R13),LENGTH=WORKLEN                      03830000
                                                                        03840000
         NI    TSKFLGS2,FF-TSK$RCVY   RECOVERY ROUTINE COMPLETE         03850000
         OI    PCBFLGS,PCB$ABE    TERM VIA ABEND PERCOLATION            03860000
         LA    R13,PCBFSA         LOCATE FSA                            03870000
         L     R14,12(,R13)       RESTORE RETURN ADDRESS                03880000
         L     R15,TSKERC         FAILURE CODE                          03890000
         LM    R0,R12,20(R13)     RESTORE PROCESS MGR REGS              03900000
         BR    R14                TERMINATE THE PCB                     03910000
         DROP  R6                 IPCB                                  03920000
                                                                        03930000
         EJECT ,                                                        03940000
***************************************************************         03950000
*                                                                       03960000
*   LOCAL READ-ONLY STORAGE, ETC.                                       03970000
*                                                                       03980000
***************************************************************         03990000
$SDMPLMT DC    C'SDUMP limit would be exceeded'                         04000000
$NOTAPF  DC    C'Not APF authorized'                                    04010000
         LTORG ,                                                        04020000
                                                                        04030000
         EJECT ,                                                        04040000
         PRINT NOGEN                                                    04050000
         ICVT  ,                                                        04060000
                                                                        04070000
         IHASDWA ,                                                      04080000
         END   ,                                                        04090000

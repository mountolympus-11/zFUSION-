ITSKDPNQ TITLE '- Add Workunit to Dispatch Queue'                       00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* Routine: ITSKDPNQ - Add Workunit to dispatch Queue                    00040000
*                                                                       00050000
* Description:                                                          00060000
*                                                                       00070000
*    This routine will add a workunit to the specified                  00080000
*    dispatch queue in priority sequence order.  If                     00090000
*    the workunit is currently marked dispatchable,                     00100000
*    a return code of 4 is returned.                                    00110000
*                                                                       00120000
* On Entry:                                                             00130000
*                                                                       00140000
*    R1 Contains Addr of the parameter list as follows:                 00150000
*                                                                       00160000
*        +0 - Address of dispatch queue header                          00170000
*        +4 - Address of workunit                                       00180000
*                                                                       00190000
* On Exit:                                                              00200000
*                                                                       00210000
*    R15 Contains one of the following return codes:                    00220000
*                                                                       00230000
*        RC00 - Normal Completion                                       00240000
*        RC04 - Workunit already in dispatch queue                      00250000
*                                                                       00260000
**<DOC-OFF>*****************************************************        00270000
                                                                        00280000
         EJECT ,                                                        00290000
****************************************************************        00300000
*                                                                       00310000
* Maintenance:                                                          00320000
*                                                                       00330000
*   01/03/95 Ron Colmone          Par# 159456                           00340000
*            Initial Version                                            00350000
*                                                                       00360000
*   09/12/95 Ron Colmone          Par# 214761                           00370000
*            Added support to queue workunits to a segmented            00380000
*            dispatch queue.  The segmented queues enables a            00390000
*            rapid method of posting the workunit to the dispq          00400000
*            by priority sequence.                                      00410000
*                                                                       00420000
****************************************************************        00430000
                                                                        00440000
         EJECT ,                                                        00450000
         @CB   TYPE=DSECT,WORKUNIT=YES                                  00460000
                                                                        00470000
         EJECT ,                                                        00480000
         DISPQSEG ,               SEGMENTED DISPATCH QUEUE BLOCK 214761 00490000
                                                                        00500000
         EJECT ,                                                        00510000
         EQUS  ,                  GENERAL EQUATES                       00520000
                                                                        00530000
         EJECT ,                                                        00540000
ITSKDPNQ #ENTER BASE=R12,PREG=R8,LINKAGE=BAKR,SAVE=NO                   00550000
                                                                        00560000
         LM    R6,R7,0(R8)        RETRIEVE PASSED PARAMETERS            00570000
         USING @CB,R7             WORKUNIT ADDRESSABILITY               00580000
                                                                        00590000
         EJECT ,                                                        00600000
****************************************************************        00610000
*                                                                       00620000
*  Add workunit to dispatch queue in priority sequence                  00630000
*                                                                       00640000
****************************************************************        00650000
                                                                        00660000
         TM    @CBDPFLG,@CBDPFLG_READY  ALREADY IN DISPATCH QUEUE       00670000
         BO    WARN_INQ           YES, RETURN WARNING                   00680000
         OI    @CBDPFLG,@CBDPFLG_READY  INDICATE WORKUNIT READY         00690000
                                                                        00700000
         ICM   R0,15,4(R6)        SEGMENTED DISPATCH QUEUE HDR   214761 00710000
         BM    DPNQ_SEG           YES, PERFORM SEQMENT INSERTION 214761 00720000
                                                                        00730000
*---------------------------------------------------------------        00740000
*  Perform standard dispatch queue insertion (prior sequence)           00750000
*---------------------------------------------------------------        00760000
DPNQ_STD DS    0H                                                214761 00770000
         LR    R3,R6              ADDRESS OF DISPATCH QUEUE             00780000
         SH    R3,=AL2(@CBDNEXT-@CB) BACKUP FOR OFFSET TO NEXT PTR      00790000
P        USING @CB,R3             WORKUNIT ADDRESSABILITY               00800000
N        USING @CB,R4             WORKUNIT ADDRESSABILITY               00810000
                                                                        00820000
*---------------------------------------------------------------        00830000
*  Add workunit to dispatch queue in priority sequence                  00840000
*---------------------------------------------------------------        00850000
DPNQ_NXT DS    0H                                                       00860000
         ICM   R4,15,P.@CBDNEXT   ADDRESS OF NEXT DISPATCHABLE WU       00870000
         BZ    DPNQ_ADD           END OF DISPATCH QUEUE                 00880000
         CLC   N.@CBPRTY,@CBPRTY  SEARCH FOR PRIORITY SEQUENCE          00890000
         BH    DPNQ_ADD           PRIORITY SLOT FOUND                   00900000
         LR    R3,R4              ADVANCE TO NEXT WORKUNIT              00910000
         B     DPNQ_NXT           CONTINUE SEARCH                       00920000
                                                                        00930000
DPNQ_ADD DS    0H                                                       00940000
         ST    R4,@CBDNEXT        ADDRESS OF NEXT DISPATCHABLE WU       00950000
         ST    R3,@CBDPREV        ADDRESS OF PREV DISPATCHABLE WU       00960000
         ST    R7,P.@CBDNEXT      UPDATE PREV WORKUNIT NEXT PTR         00970000
                                                                        00980000
         LTR   R4,R4              END OF DISPATCH QUEUE DETECTED        00990000
         BZ    DPNQ_END           YES,  CONTINUE                 214761 01000000
         ST    R7,N.@CBDPREV      UPDATE NEXT WORKUNIT PREV PTR         01010000
         B     RET_NORM           RETURN                         214761 01020000
                                                                        01030000
DPNQ_END DS    0H                                                214761 01040000
         ST    R7,4(,R6)          UPDATE END OF LIST ADDRESS     214761 01050000
         B     RET_NORM           RETURN                         214761 01060000
                                                                        01070000
         DROP  P,N                @CB (PREV,NEXT)                       01080000
                                                                        01090000
         EJECT ,                                                        01100000
****************************************************************        01110000
*                                                                       01120000
*  Segmented dispatch queue,  Locate queue header associated            01130000
*  with dispatching priority and add workunit at end of queue.          01140000
*  Also, the associated index entry is set to TRUE to indicate          01150000
*  entries exist at that priority.                                      01160000
*                                                                       01170000
****************************************************************        01180000
DPNQ_SEG DS    0H                                                214761 01190000
         L     R6,0(,R6)          ADDRESS OF SEGMENTED DPQ BLOCK 214761 01200000
         USING DISPQSEG,R6        ADDRESSABILITY                 214761 01210000
                                                                        01220000
         SR    R2,R2              PREPARE FOR INSERT             214761 01230000
         IC    R2,@CBPRTY         RETRIEVE CURRENT PRIORITY      214761 01240000
         STC   R2,@CBPRTYL        SAVE AS LAST QUEUED PRIORITY   214761 01250000
         LA    R1,DQSSLOTS-1      MAXIMUM NUMBER OF SLOTS -1     214761 01260000
         SR    R1,R2              CALC OFFSET TO PRIORITY INDEX  214761 01270000
         LA    R2,DQSINDEX(R1)    ADDRESS OF DISPQ INDEX         214761 01280000
         MVI   0(R2),TRUE         INDICATE ACTIVE PRIORITY INDEX 214761 01290000
                                                                        01300000
         SLL   R1,3               CALC INDEX INTO QUEUE HEADERS  214761 01310000
         LA    R2,DQSPRIOQ(R1)    ADDRESS OF PRIORITY QUEUE HDR  214761 01320000
                                                                        01330000
         L     R3,4(,R2)          ADDR OF LAST WORKUNIT IN DISPQ 214761 01340000
L        USING @CB,R3             WORKUNIT ADDRESSABILITY        214761 01350000
                                                                        01360000
         XC    @CBDNEXT,@CBDNEXT  INDICATE END OF DISPATCH QUEUE 214761 01370000
         ST    R3,@CBDPREV        ADDRESS OF PREV DISPATCHABLE WU214761 01380000
         ST    R7,L.@CBDNEXT      ADD WORKUNIT TO END OF LIST    214761 01390000
         ST    R7,4(,R2)          LAST WORKUNIT IN QUEUE         214761 01400000
                                                                        01410000
         DROP  L,R6               @CB, DISPQSEG                  214761 01420000
                                                                        01430000
         EJECT ,                                                        01440000
****************************************************************        01450000
*                                                                       01460000
*   RETURN                                                              01470000
*                                                                       01480000
****************************************************************        01490000
                                                                        01500000
RET_NORM DS    0H                                                       01510000
         LA    R15,RC00           NORMAL COMPLETION                     01520000
         B     RETURN             RETURN                                01530000
                                                                        01540000
WARN_INQ DS    0H                                                       01550000
         LA    R15,RC04           ALREADY IN DISPATCH QUEUE             01560000
                                                                        01570000
RETURN   DS    0H                                                       01580000
         #EXIT ,                  RETURN                                01590000
                                                                        01600000
         EJECT ,                                                        01610000
****************************************************************        01620000
*                                                                       01630000
*  CONSTANTS AND LITERALS                                               01640000
*                                                                       01650000
****************************************************************        01660000
                                                                        01670000
         LTORG ,                                                        01680000
                                                                        01690000
         PRINT NOGEN                                                    01700000
         ICVT  ,                                                        01710000
         PRINT GEN                                                      01720000
                                                                        01730000
         END   ,                                                        01740000

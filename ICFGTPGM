ICFGTPGM TITLE '- GENERATE LU6.2 TRANSACTION PROGRAM DEFINITIONS'       00010000
                                                                        00020000
         CMINCL ,                                                       00030000
         L62INCL ,                                                      00040000
                                                                        00050000
**<DOC-ON>************************************************************* 00060000
*                                                                       00070000
* ROUTINE: ICFGTPGM - GENERATE LU6.2 TRANSACTION PROGRAM DEFINITIONS    00080000
*                                                                       00090000
* DESCRIPTION:                                                          00100000
*                                                                       00110000
*   This routine is called during VTAM task initialization to           00120000
*   build transaction program definitions for transaction programs      00130000
*   that require something other than an MVS LOAD during initiation     00140000
*   (for example, REXX procedures).                                     00150000
*   It is also called when updates occur to the SYSTEMS global table.   00160000
*                                                                       00170000
*   The TPROGRAM table is retrieved and a TPB control block             00180000
*   is created for each row of the table.                               00190000
*                                                                       00200000
*                                                                       00210000
* ON ENTRY:                                                             00220000
*                                                                       00230000
*    R15 = ENTRY POINT ADDRESS                                          00240000
*    R14 = RETURN      ADDRESS                                          00250000
*    R13 = SAVE AREA   ADDRESS                                          00260000
*    R11 = ICVT        ADDRESS                                          00270000
*    R10 = ITASK       ADDRESS                                          00280000
*                                                                       00290000
* ON EXIT:                                                              00300000
*                                                                       00310000
*    R15 = GENERAL RETURN CODE                                          00320000
*                                                                       00330000
*        = 0 --> TRANSACTION PROGRAMS SUCCESSFULLY CONFIGURED           00340000
*                                                                       00350000
*                R00 = 0                                                00360000
*                R01 = 0                                                00370000
*                                                                       00380000
*        = 8 --> TABLE OPEN FAILURE                                     00390000
*                                                                       00400000
*                R00 = TBOPEN RETURN CODE                               00410000
*                R01 = TBOPEN REASON CODE                               00420000
*                                                                       00430000
*        =12 --> SERVICE FAILURE                                        00440000
*                                                                       00450000
*                R00 = 4 --> TBSET ERROR                                00460000
*                    = 8 --> L62LDTP FAILED                             00470000
*                R01 = 0                                                00480000
*                                                                       00490000
*    ALL OTHER REGISTERS ARE RESTORED.                                  00500000
*                                                                       00510000
**<DOC-OFF>*****************************************************        00520000
                                                                        00530000
****************************************************************        00540000
*                                                                       00550000
* MAINTENANCE:                                                          00560000
*                                                                       00570000
*    07/01/94 RANDY WITEK                                               00580000
*                                                                       00590000
*    12/06/94 R. Turgeon                                                00600000
*             Removed PAGE= / SHRPAGE= for $SPACE, $OBJECT,             00610000
*             and TB* service requests                                  00620000
*    12/31/95 RANDY WITEK - 2.1 TRANSACTION PROGRAM VTAM WU SUPPORT     00630000
*                                                                       00640000
****************************************************************        00650000
                                                                        00660000
         EQUS  ,                                                        00670000
                                                                        00680000
RICVT    EQU   R11                                                      00690000
RITASK   EQU   R10                                                      00700000
RIVTAM   EQU   R9                                                       00710000
RTPB     EQU   R8                                                       00720000
                                                                        00730000
         PRINT NOGEN                                                    00740000
         TBSERVIS OPEN,SET,GET                                          00750000
         PRINT GEN                                                      00760000
                                                                        00770000
         #WORK ,                                                        00780000
WRK256   DS    XL256              GENERAL WORKAREA                      00790000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00800000
SUB1SAVE DS    18F                SUBROUTINE SAVE AREA                  00810000
                                                                        00820000
L62MFL   L62LDTP MF=L             PLIST CONSTRUCTION                    00830000
L62RETRC DS    F                  RETURN CODE RETURN AREA               00840000
L62RETWU DS    CL4                WU TYPE     RETURN AREA               00850000
L62RETEP DS    A                  ENTRY POINT ADDRESS RETURN AREA       00860000
                                                                        00870000
TPGMREC  DS    XL(TPGML)          TRANSACTION PROGRAM RECORD            00880000
                                                                        00890000
RETR15   DS    F                                                        00900000
RETR0    DS    F                                                        00910000
RETR1    DS    F                                                        00920000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00930000
                                                                        00940000
FLAG     DS    X                                                        00950000
FLAGLOCK EQU   X'80'                                                    00960000
FLAGLCKD EQU   X'40'                                                    00970000
         #ENDWORK ,                                                     00980000
                                                                        00990000
         $MSGDFT PREFIX=ICTPID,                                        +01000000
               COMPID='L62',                                           +01010000
               TABLE=*#MSGS,                                           +01020000
               WORKA=0,                                                +01030000
               MF=(E,WRK256),                                          +01040000
               PRINT=NOGEN                                              01050000
                                                                        01060000
ICFGTPGM #ENTER BASE=R12,                                              +01070000
               AMODE=31,                                               +01080000
               RMODE=ANY                                                01090000
                                                                        01100000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              01110000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              01120000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              01130000
         USING TPB,RTPB           ESTABLISH ADDRESSABILITY              01140000
X        USING TPROGRAM,TPGMREC   ESTABLISH ADDRESSABILITY              01150000
                                                                        01160000
*---------------------------------------------------------------        01170000
*  OPEN TABLE ON INITIAL CONFIGURATION REQUEST                          01180000
*---------------------------------------------------------------        01190000
                                                                        01200000
         ICM   R0,15,ICTTPGM      TPROGRAM TABLE AREADY OPEN?           01210000
         BNZ   SET_TOP            YES,  POSITION TO TOP OF TABLE        01220000
                                                                        01230000
         TBOPEN 'TPROGRAM',       OPEN TPROGRAM CATALOG TABLE          +01240000
               STOKEN=*ICTSYSP@,                                       +01250000
               TTOKEN=ICTTPGM,                                         +01260000
               MF=(E,MFE_LIST)                                          01270000
                                                                        01280000
         LTR   R15,R15            SUCCESSFUL COMPLETION?                01290000
         BNZ   ERR_OPEN           BRANCH IF NOT                         01300000
                                                                        01310000
*---------------------------------------------------------------        01320000
*  POSITIION TABLE TO TOP                                               01330000
*---------------------------------------------------------------        01340000
                                                                        01350000
SET_TOP  DS    0H                                                       01360000
                                                                        01370000
         TBSET TTOKEN=ICTTPGM,                                         +01380000
               POS=TOP,                                                +01390000
               MF=(E,MFE_LIST)    POSITION AT TOP OF TABLE              01400000
                                                                        01410000
         LTR   R15,R15            SUCCESSFUL COMPLETION?                01420000
         BNZ   ERR_SET            BRANCH IF NOT                         01430000
                                                                        01440000
*---------------------------------------------------------------        01450000
*  RETRIEVE NEXT TABLE ROW                                              01460000
*---------------------------------------------------------------        01470000
                                                                        01480000
GET_TPGM DS    0H                                                       01490000
                                                                        01500000
         TBGET TPGMREC,                                                +01510000
               LENGTH=L'TPGMREC,                                       +01520000
               TTOKEN=ICTTPGM,                                         +01530000
               POS=NEXT,                                               +01540000
               MF=(E,MFE_LIST)    RETRIEVE NEXT TABLE ROW               01550000
                                                                        01560000
         LTR   R15,R15            SUCCESSFUL COMPLETION?                01570000
         BNZ   RETURN             END OF TABLE                          01580000
                                                                        01590000
*---------------------------------------------------------------        01600000
*  DEFINE THE TRANSACTION PROGRAM                                       01610000
*---------------------------------------------------------------        01620000
                                                                        01630000
         TM    X.TPGF1,TPGF1REX     IS IT A REXX EXEC?                  01640000
         BNO   LOADIT               BRANCH IF NOT                       01650000
         BAS   R14,BUILDTPB                                             01660000
         LTR   RTPB,R1              WAS A TPB CREATED?                  01670000
         BNP   GET_TPGM             BRANCH IF NOT                       01680000
         OI    TPBF1,TPBF1REX       SHOW IT IS A REXX PROCEDURE         01690000
         B     GET_TPGM             GO READ THE NEXT ROW                01700000
                                                                        01710000
LOADIT   DS    0H                                                       01720000
                                                                        01730000
         L62LDTP X.TPGNAME,       TRANSACTION PROGRAM NAME             +01740000
               L62RETEP,          EP ADDRESS RETURN AREA               +01750000
               L62RETWU,          WU TYPE    RETURN AREA               +01760000
               L62RETRC,          RETURN CODE AREA                     +01770000
               MF=(E,L62MFL)                                            01780000
                                                                        01790000
         ICM   R1,15,L62RETRC     LOAD SUCCESSFUL?                      01800000
         BZ    GET_TPGM           BRANCH IF YES                         01810000
         BAS   R14,ERR_LDTP       SET CURRENT RETURN/REASON CODE        01820000
         B     GET_TPGM           GO READ THE NEXT ROW                  01830000
                                                                        01840000
*---------------------------------------------------------------        01850000
*  EXCEPTION ROUTINES                                                   01860000
*---------------------------------------------------------------        01870000
                                                                        01880000
ERR_OPEN DS    0H                                                       01890000
                                                                        01900000
         MVI   RETR15+(L'RETR15-1),8   SYSTEMS FAILED TO OPEN           01910000
         ST    R15,RETR0               TBOPEN RETURN CODE               01920000
         ST    R0,RETR1                TBOPEN REASON CODE               01930000
         B     RETURN                                                   01940000
                                                                        01950000
ERR_SET  DS    0H                                                       01960000
                                                                        01970000
         MVI   RETR15+(L'RETR15-1),12  SERVICE FAILURE                  01980000
         MVI   RETR0+(L'RETR0-1),4     TBSET FAILURE                    01990000
         B     RETURN                                                   02000000
                                                                        02010000
ERR_LDTP DS    0H                                                       02020000
                                                                        02030000
         MVI   RETR15+(L'RETR15-1),12  SERVICE FAILURE                  02040000
         MVI   RETR0+(L'RETR0-1),8     L62LDTP FAILED                   02050000
         BR    R14                                                      02060000
                                                                        02070000
*---------------------------------------------------------------        02080000
*  RETURN                                                               02090000
*---------------------------------------------------------------        02100000
                                                                        02110000
RETURN   DS    0H                                                       02120000
         LM    R15,R1,RETREGS     LOAD RETURN VALUES                    02130000
                                                                        02140000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    02150000
                                                                        02160000
*---------------------------------------------------------------------- 02170000
*   SUBROUTINE: BUILD A NEW TPB FOR A REXX EXEC                         02180000
*       RETURN: R1 = TPB ADDRESS - OR ZERO (IF DUPLICATE NAME)          02190000
*---------------------------------------------------------------------- 02200000
                                                                        02210000
*                                                                       02220000
* SEE IF THE REQUESTED TRANSACTION PROGRAM IS ALREADY KNOWN             02230000
*---------------------------------------------------------------------- 02240000
                                                                        02250000
BUILDTPB DS    0H                                                       02260000
                                                                        02270000
         STM   R14,R12,SUB0SAVE                                         02280000
                                                                        02290000
         BAS   R14,VTAMLOCK           SERIALIZE                         02300000
                                                                        02310000
         SR    RTPB,RTPB              NO TPB YET                        02320000
         LA    R4,IVTTP1ST            GET SET TO RUN TPB CHAIN          02330000
         S     R4,=A(TPBNEXT-TPB)                                       02340000
                                                                        02350000
BTPBRUN  DS    0H                                                       02360000
                                                                        02370000
         ICM   R4,15,TPBNEXT-TPB(R4)     LINK TO THE NEXT TPB           02380000
         BM    BTPBNEW                   BRANCH IF NOT FOUND            02390000
         CLC   X.TPGNAME,TPBNAME-TPB(R4) COMPARE THE NAMES              02400000
         BH    BTPBRUN                   BRANCH IF NEW NAME IS HIGH     02410000
         BL    BTPBNEW                   BRANCH IF NOT FOUND            02420000
         B     BTPBEXIT                  BRANCH IF DUPLICATE NAME       02430000
                                                                        02440000
*                                                                       02450000
* CREATE A NEW TPB                                                      02460000
*---------------------------------------------------------------------- 02470000
                                                                        02480000
BTPBNEW  DS    0H                                                       02490000
                                                                        02500000
         $GETSTOR L'TPBMAX,                                            +02510000
               LOC=ANY,                                                +02520000
               OWNER=*IVTITASK        ALLOCATE A TPB                    02530000
                                                                        02540000
         LR    RTPB,R1                REFERENCE TO BLOCK                02550000
         MVC   TPBID,=CL8'TPB'        SET EYECATCHER                    02560000
         MVC   TPBLEN,=A(L'TPBMAX)    SET THE LENGTH                    02570000
         MVC   TPBNAME,X.TPGNAME      SET THE NAME                      02580000
         MVC   TPBLOAD,X.TPGLOAD      SET THE INTERNAL NAME             02590000
         MVC   TPBWUTYP,=CL4'PROC'    SET WORK UNIT ENVIRONMENT         02600000
         MVC   TPBUSE,=F'1'           SET INITIAL USE COUNT             02610000
                                                                        02620000
         LR    R14,R4                 FOLLOWING TPB                     02630000
         L     R15,TPBPREV-TPB(,R14)  PRECEDING TPB                     02640000
         ST    RTPB,TPBNEXT-TPB(,R15) LINK NEW TPB TO PRECEDING         02650000
         ST    RTPB,TPBPREV-TPB(,R14) LINK NEW TPB TO FOLLOWING         02660000
         STM   R14,R15,TPBNEXT        SET NEXT/PREV IN NEW TPB          02670000
                                                                        02680000
BTPBEXIT DS    0H                                                       02690000
                                                                        02700000
         BAS   R14,VTAMUNLK           RELEASE SERIALIZATION             02710000
                                                                        02720000
         ST    RTPB,SUB0SAVE+12       SET RETURN VALUE                  02730000
         LM    R14,R12,SUB0SAVE       RESTORE REGISTERS                 02740000
         BR    R14                    RETURN                            02750000
                                                                        02760000
*---------------------------------------------------------------------- 02770000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 02780000
*---------------------------------------------------------------------- 02790000
                                                                        02800000
VTAMLOCK DS    0H                                                       02810000
                                                                        02820000
         TM    FLAG,FLAGLOCK        WAS THE LOCK ALREADY OBTAINED?      02830000
         BOR   R14                  RETURN IF YES                       02840000
         STM   R14,R2,SUB1SAVE      SAVE CALLER'S REGISTERS             02850000
                                                                        02860000
         $SER  OBTAIN,                                                 +02870000
               VTAM                                                     02880000
                                                                        02890000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              02900000
         BNE   VTAMLOEX             BRANCH IF NOT                       02910000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         02920000
                                                                        02930000
VTAMLOEX DS    0H                                                       02940000
                                                                        02950000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               02960000
         LM    R14,R2,SUB1SAVE      RESTORE CALLER'S REGISTERS          02970000
         BR    R14                  RETURN                              02980000
                                                                        02990000
*---------------------------------------------------------------------- 03000000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                03010000
*---------------------------------------------------------------------- 03020000
                                                                        03030000
VTAMUNLK DS    0H                                                       03040000
                                                                        03050000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       03060000
         BNOR  R14                  BRANCH IF NOT                       03070000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             03080000
         BOR   R14                  DON'T RELEASE IF IT WAS             03090000
         STM   R14,R2,SUB1SAVE      SAVE CALLER'S REGISTERS             03100000
                                                                        03110000
         $SER  RELEASE,                                                +03120000
               VTAM                                                     03130000
                                                                        03140000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  03150000
         LM    R14,R2,SUB1SAVE      RESTORE CALLER'S REGISTERS          03160000
         BR    R14                  RETURN                              03170000
                                                                        03180000
*---------------------------------------------------------------------- 03190000
* LITERALS AND CONSTANTS                                                03200000
*---------------------------------------------------------------------- 03210000
                                                                        03220000
         LTORG ,                                                        03230000
         PRINT NOGEN                                                    03240000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                03250000
         ISTRH ,                  VTAM REQUEST HEADER                   03260000
         ISTDBIND ,               VTAM BIND IMAGE                       03270000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         03280000
         ICVT  ,                  INTEGRATOR CVT                        03290000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   03300000
         ISESS ,                  INTEGRATOR ISESS BLOCK                03310000
         ITASK ,                  INTEGRATOR TASK BLOCK                 03320000
         IRPL ,                   INTEGRATOR IRPL  BLOCK                03330000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       03340000
         EVCODES ,                INTEGRATOR EVENT CODES                03350000
         ABCODES ,                INTEGRATOR $ABEND CODES               03360000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     03370000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        03380000
         ICATALOG TPROGRAM                                              03390000
         END   ,                                                        03400000

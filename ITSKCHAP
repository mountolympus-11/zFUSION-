ITSKCHAP TITLE '- Change ITASK Dispatching Priority'                    00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE: ITSKCHAP - Change ITASK Dispatching Priority                 00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine provides a facility to change the dispatching         00080000
*    priority of an ITASK.  If the task was created with                00090000
*    TCBAFF=YES, an MVS CHAP macro is executed to change the            00100000
*    MVS dispatch priority.   If the ITASK is running under             00110000
*    a server task,  the dispatching priority is adjusted               00120000
*    in the workunit header to allow proper dispatch queue              00130000
*    priority assignment.                                               00140000
*                                                                       00150000
* ON ENTRY:                                                             00160000
*                                                                       00170000
*    R1 contains the addres of the parameter list mapped by             00180000
*    the TASKPL dsect generated by $TASK DSECT=YES.                     00190000
*                                                                       00200000
* ON EXIT:                                                              00210000
*                                                                       00220000
*    Upon completion of this routine R15 will contain one               00230000
*    of the following return codes:                                     00240000
*                                                                       00250000
*        R15 = RC00 - Normal Completion                                 00260000
*                                                                       00270000
* MODE:                                                                 00280000
*                                                                       00290000
*    TASK                                                               00300000
*    APF/NON-APF                                                        00310000
*    SUP/PROB                                                           00320000
*    AMODE 31, RMODE ANY                                                00330000
*                                                                       00340000
**<DOC-OFF>*****************************************************        00350000
                                                                        00360000
         EJECT ,                                                        00370000
****************************************************************        00380000
*                                                                       00390000
* MAINTENANCE:                                                          00400000
*                                                                       00410000
*   01/17/95 Ron Colmone          Par# 159456                           00420000
*            Initial Version                                            00430000
*                                                                       00440000
*   09/12/95 Ron Colmone          Par# 214761                           00450000
*            Control dispatch priority limited from 0-255.              00460000
*                                                                       00470000
****************************************************************        00480000
                                                                        00490000
         EJECT ,                                                        00500000
         $TASK   DSECT=YES        TASKMGR PLIST                         00510000
                                                                        00520000
         EJECT ,                                                        00530000
         EQUS  ,                  GENERAL EQUATES                       00540000
                                                                        00550000
         EJECT ,                                                        00560000
         #WORK LENGTH=512         READ/WRITE WORKAREA                   00570000
         #ENDWORK                 END OF WORKAREA                       00580000
                                                                        00590000
         EJECT ,                                                        00600000
ITSKCHAP #ENTER BASE=R12,         ENTRY LINKAGE                        +00610000
               PREG=R8,                                                +00620000
               WAPASS=YES                                               00630000
                                                                        00640000
         USING TASKPL,R8          ESTABLISH ADDRESSABILITY              00650000
         USING ITASK,R10          ESTAB ADDR TO ITASK                   00660000
                                                                        00670000
         EJECT ,                                                        00680000
****************************************************************        00690000
*                                                                       00700000
*  Change ITASK dispatching priority                                    00710000
*                                                                       00720000
****************************************************************        00730000
                                                                        00740000
         ICM   R5,15,TPLTASK      ADDRESS OF ITASK SPECIFIED            00750000
         BNZ   *+6                SKIP IF SPECIFIED                     00760000
         LR    R5,R10             CURRENT TASK REQUESTED                00770000
T        USING ITASK,R5           ADDRESSABILITY                        00780000
                                                                        00790000
         ICM   R3,15,TPLDPRTY     ASSUME PRIORITY SPECIFIED             00800000
         BNZ   CHAP_MOD           CONVERT TO DPMOD                      00810000
         ICM   R3,15,TPLDPMOD     PRIORITY ADJUSTMENT                   00820000
         BZ    CHAP_RET           NO ADJUSTMENT REQUIRED                00830000
         B     CHAP_SET           SET NEW DISPATCH PRIORITY             00840000
                                                                        00850000
CHAP_MOD DS    0H                                                       00860000
         SR    R2,R2              PREPARE FOR INSERT             214761 00870000
         IC    R2,T.TSKPRTY       RETRIEVE CURRENT PRIORITY      214761 00880000
         SR    R3,R2              CONVERT TO DPMOD VALUE         214761 00890000
                                                                        00900000
*---------------------------------------------------------------        00910000
*  Set the updated dispatching priority and issue MVS CHAP              00920000
*  macro if specified ITASK has its own TCB.                            00930000
*---------------------------------------------------------------        00940000
CHAP_SET DS    0H                                                       00950000
         SR    R2,R2              PREPARE FOR INSERT             214761 00960000
         IC    R2,T.TSKPRTY       RETRIEVE CURRENT PRIORITY      214761 00970000
         AR    R2,R3              ADD DISPATCH PROIRITY MODIFIER 214761 00980000
         BM    CHAP_DP0           NEGATIVE, RESET PRIO TO ZERO   214761 00990000
         C     R2,=A(255)         EXCEEDED LIMIT?                214761 01000000
         BNH   CHAP_DP            NO, CONTINUE WITH PRIORITY SET 214761 01010000
         LA    R2,255             RESET TO LIMIT                 214761 01020000
         B     CHAP_DP            CONTINUE WITH PRIORITY SET     214761 01030000
                                                                        01040000
CHAP_DP0 DS    0H                                                214761 01050000
         SR    R2,R2              RESET PRIOR TO ZERO            214761 01060000
                                                                        01070000
CHAP_DP  DS    0H                                                214761 01080000
         STC   R2,T.TSKPRTY       SAVE UPDATED PRIORITY          214761 01090000
                                                                        01100000
         TM    T.TSKFLGS3,TSK3$AFF  TCB AFFINITY                        01110000
         BZ    CHAP_RET                                                 01120000
                                                                        01130000
         CHAP  (R3),T.TSKTCB@     CHANGE TASK DISPATCH PRIO             01140000
                                                                        01150000
CHAP_RET DS    0H                                                       01160000
         LA    R15,RC00           ASSUME NORMAL COMPLETION              01170000
         B     RETURN             NORMAL COMPLETION                     01180000
                                                                        01190000
         EJECT ,                                                        01200000
****************************************************************        01210000
*                                                                       01220000
*  ERROR RETURN                                                         01230000
*                                                                       01240000
****************************************************************        01250000
                                                                        01260000
RETURN   DS    0H                                                       01270000
         #EXIT ,                  RETURN                                01280000
                                                                        01290000
         EJECT ,                                                        01300000
****************************************************************        01310000
*                                                                       01320000
*  CONSTANTS AND LITERALS                                               01330000
*                                                                       01340000
****************************************************************        01350000
                                                                        01360000
         LTORG ,                                                        01370000
                                                                        01380000
         PRINT NOGEN                                                    01390000
         ICVT  ,                                                        01400000
         ITASK ,                                                        01410000
         CVT   DSECT=YES,LIST=NO                                        01420000
                                                                        01430000
         PRINT GEN                                                      01440000
                                                                        01450000
         END   ,                                                        01460000

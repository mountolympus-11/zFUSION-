ISQLMSG  TITLE '- ADD MESSAGE TO SQL RESPONSE'                          00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: ISQLMSG - Add message to SQL response                        00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine implments the SQLRESP service allowing SQL            00080000
*    processors to conveniently post one or more message lines          00090000
*    for return via the standard SQL response buffer and                00100000
*    DSQLRESP response block.                                           00110000
*                                                                       00120000
*    Messages are inserted using $XPBUFR ISRT,EXPAND=YES. The           00130000
*    caller is responsible for ensuring that movement of the            00140000
*    TXP buffer is reflected back by issuing the appropriate            00150000
*    $XPBUFR ADDPTR request before invoking this service.               00160000
*                                                                       00170000
*                                                                       00180000
* ON ENTRY:                                                             00190000
*                                                                       00200000
*    R1  contains the address of a parameter list constructed           00210000
*        as follows:                                                    00220000
*                                                                       00230000
*           +00 - Message origin address                                00240000
*           +04 - Message length                                        00250000
*           +08 - Address of a pointer to the DSQLRESP response         00260000
*                                                                       00270000
*                                                                       00280000
* ON EXIT:                                                              00290000
*                                                                       00300000
*    R15 contains the return code set by $XPBUFR ISRT or zero           00310000
*                                                                       00320000
**<DOC-OFF>****************************************************         00330000
                                                                        00340000
         EJECT                                                          00350000
***************************************************************         00360000
*                                                                       00370000
* MAINTENANCE:                                                          00380000
*                                                                       00390000
*    12/29/94 R. Turgeon                                                00400000
*             Initial version, SQL restructuring                        00410000
*                                                                       00420000
***************************************************************         00430000
                                                                        00440000
         EJECT                                                          00450000
         #WORK LENGTH=256                                               00460000
         #ENDWORK                                                       00470000
                                                                        00480000
         EJECT                                                          00490000
         DSQLRESP ,               SQL RESPONSE BLOCK                    00500000
                                                                        00510000
         EJECT                                                          00520000
         EQUS ,                                                         00530000
                                                                        00540000
         EJECT                                                          00550000
ISQLMSG  #ENTER WAPASS=YES,PREG=R8                                      00560000
                                                                        00570000
         EJECT                                                          00580000
***************************************************************         00590000
*                                                                       00600000
*   FETCH PASSED PARAMETERS                                             00610000
*                                                                       00620000
***************************************************************         00630000
                                                                        00640000
         LM    R5,R7,0(R8)        FETCH PARMS                           00650000
*                                 R5 <== MESSAGE ORIGIN                 00660000
*                                 R6 <== MESSAGE LENGTH                 00670000
*                                 R7 <== DSQLRESP ANCHOR WORD           00680000
                                                                        00690000
*--------------------------------------------------------------         00700000
*   TRIM TRAILING WHITE SPACE, TRUNCATE THE RESULT                      00710000
*--------------------------------------------------------------         00720000
         C     R6,=F'256'         TRUNCATE LENGTHY MESSAGES             00730000
         BNH   *+8                                                      00740000
         LA    R6,256                                                   00750000
                                                                        00760000
         @TRIM (R5),(R6),CHAR=NULL                                      00770000
                                                                        00780000
         LA    R15,RC00           PREPARE FOR LENGTH TEST               00790000
         LTR   R6,R1              TRIMMED LENGTH                        00800000
         BNP   RESPMSGX           DISCARD                               00810000
                                                                        00820000
*---------------------------------------------------------------        00830000
*   MESSAGE RETURN VIA APPEND TO TXP BUFFER                             00840000
*---------------------------------------------------------------        00850000
         $XPBUFR ISRT,DATALEN=2(R6),  SLOT RETURNED VIA R1             X00860000
               EXPAND=YES                                               00870000
                                                                        00880000
         BNZ   RESPMSGX           UNANTICIPATED FAILURE                 00890000
                                                                        00900000
*---------------------------------------------------------------        00910000
*   INSERT MESSAGE IN ASSIGNED SLOT (R1)                                00920000
*---------------------------------------------------------------        00930000
         LR    R0,R6              PRESERVE MESSAGE LENGTH               00940000
         BCTR  R6,0               PREPARE FOR EX                        00950000
         EX    R6,*+4             INSERT MESSAGE TEXT IN SLOT           00960000
         MVC   2(*-*,R1),0(R5)    EX OBJECT                             00970000
         STCM  R0,3,0(R1)         AFFIX THE TEXT LENGTH                 00980000
                                                                        00990000
*---------------------------------------------------------------        01000000
*   UPDATE SQL RESPONSE BLOCK ACCORDINGLY                               01010000
*---------------------------------------------------------------        01020000
         L     R4,0(,R7)          SQL RESPONSE HEADER                   01030000
         USING DSQLRESP,R4        PREPARE FOR UPDATE                    01040000
         MVI   DSQLEINF,TRUE      MSGS RETURNED                         01050000
                                                                        01060000
         LH    R14,DSQLMSGC       PREVIOUS MESSAGE COUNT                01070000
         LA    R14,1(,R14)        ACCOUNT FOR NEW MESSAGES              01080000
         STH   R14,DSQLMSGC       UPDATE MSG COUNT IN RESP BLOCK        01090000
                                                                        01100000
         ICM   R0,3,DSQLMSG@      MESSAGES PREVIOUSLY POSTED?           01110000
         BNZ   RESPMSGX           NEW MSGS WERE APPENDED IF SO          01120000
         SR    R1,R4              OFFSET TO MSG ARRAY ORIGIN            01130000
         STH   R1,DSQLMSG@        RETAIN IN RESPONSE HDR                01140000
                                                                        01150000
*---------------------------------------------------------------        01160000
*   RETURN TO REQUESTER                                                 01170000
*---------------------------------------------------------------        01180000
RESPMSGX DS    0H                 R15 CONTAINS RETURN CODE              01190000
         #EXIT ,                                                        01200000
                                                                        01210000
         EJECT ,                                                        01220000
***************************************************************         01230000
*                                                                       01240000
*   LOCAL READ ONLY STORAGE                                             01250000
*                                                                       01260000
***************************************************************         01270000
         LTORG ,                                                        01280000
                                                                        01290000
         EJECT                                                          01300000
         PRINT NOGEN                                                    01310000
         ICVT  ,                                                        01320000
         END   ,                                                        01330000

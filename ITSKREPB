ITSKREPB TITLE '- REMOVE EPB FROM EVENTS TABLE'                         00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE: ITSKREPB - Remove EPB from Events Table                      00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine provides a facility to withdraw an EPB                00080000
*    from the Task Manager/Dispatcher which is no longer                00090000
*    desired as an event to be notified on behalf of its                00100000
*    completion.  If the EPB specified is an XEPB,  the                 00110000
*    XEPB will be marked for deletion.                                  00120000
*                                                                       00130000
* METHOD:                                                               00140000
*                                                                       00150000
*    The EPB requested to be removed is posted with the                 00160000
*    cancel post completion code.  If the request is for                00170000
*    the current task's events table or for the server of               00180000
*    the current task, then an MVS EVENTS request is                    00190000
*    issued to enabled the event to be removed without                  00200000
*    a pass through the task manager dispatcher.  Any                   00210000
*    other events which have also completed are posted to               00220000
*    their respective PCBs.  The events request is issued               00230000
*    with WAIT=NO to prevent an OS wait from occurring if               00240000
*    the requested EPB is not in the task's events table.               00250000
*    If this condition occurs,  the appropriate status                  00260000
*    is returned.                                                       00270000
*                                                                       00280000
* ON ENTRY:                                                             00290000
*                                                                       00300000
*    R1 contains the addres of the parameter list mapped by             00310000
*    the TASKPL dsect generated by $TASK DSECT=YES.                     00320000
*                                                                       00330000
* ON EXIT:                                                              00340000
*                                                                       00350000
*    Upon completion of this routine R15 will contain one               00360000
*    of the following return codes:                                     00370000
*                                                                       00380000
*        R15 = RC00 - Normal Completion                                 00390000
*                                                                       00400000
*              RC12 - Service Error                                     00410000
*                     R0 = RSN04 - EPB specified not in events table    00420000
*                          RSN08 - Remote EPB not available in list     00430000
*                                                                       00440000
*              RC20 - Request Error                                     00450000
*                     R0 = RSN04 - EPB Required for request             00460000
*                                                                       00470000
* MODE:                                                                 00480000
*                                                                       00490000
*    TASK                                                               00500000
*    APF/NON-APF                                                        00510000
*    SUP/PROB                                                           00520000
*    AMODE 31, RMODE ANY                                                00530000
*                                                                       00540000
**<DOC-OFF>*****************************************************        00550000
                                                                        00560000
         EJECT ,                                                        00570000
****************************************************************        00580000
*                                                                       00590000
* MAINTENANCE:                                                          00600000
*                                                                       00610000
*   06/09/93 Ron Colmone                                                00620000
*            Initial Version                                            00630000
*                                                                       00640000
*   12/17/94 Ron Colmone                Par# 159456                     00650000
*            Added support for SERVER task.                             00660000
*                                                                       00670000
****************************************************************        00680000
                                                                        00690000
         EJECT ,                                                        00700000
         $TASK   DSECT=YES        TASKMGR PLIST                         00710000
         EJECT ,                                                        00720000
         $SERVER DSECT=YES        TASK SERVER PLIST                     00730000
         EJECT ,                                                        00740000
         @EPB    TYPE=DSECT       EVENT PROCESS BLOCK                   00750000
         EJECT ,                                                        00760000
         XEPB  ,                  EXTENDED EPB                          00770000
         EJECT ,                                                        00780000
         EVCODES ,                EVENT CODES                           00790000
                                                                        00800000
         EJECT ,                                                        00810000
         EQUS  ,                  GENERAL EQUATES                       00820000
                                                                        00830000
         EJECT ,                                                        00840000
         #WORK LENGTH=512         READ/WRITE WORKAREA                   00850000
WRK256   DS    XL256              GENERAL WORKAREA                      00860000
                                                                        00870000
FLAGS    DS    X                  FLAGS                                 00880000
F$CANCEL EQU   X'80'                 EVENT CANCELLED                    00890000
F$LLCL   EQU   X'40'                 LOCAL LOCK ACQUIRED                00900000
                                                                        00910000
SAVEECB  DS    A                  ADDRESS OF EVENT ECB                  00920000
EVENTLST DS    A                  ADDRESS OF COMPLETED EVENTS           00930000
                                                                        00940000
$TSK_MFL $TASK   MF=(L,*)         $TASK   PLIST AREA                    00950000
$SRV_MFL $SERVER MF=(L,*)         $SERVER PLIST AREA                    00960000
         #ENDWORK                 END OF WORKAREA                       00970000
                                                                        00980000
         EJECT ,                                                        00990000
ITSKREPB #ENTER BASE=R12,         ENTRY LINKAGE                        +01000000
               PREG=R8,                                                +01010000
               WAPASS=YES                                               01020000
                                                                        01030000
         USING TASKPL,R8          ESTABLISH ADDRESSABILITY              01040000
         USING ITASK,R10          ESTAB ADDR TO ITASK                   01050000
                                                                        01060000
         EJECT ,                                                        01070000
****************************************************************        01080000
*                                                                       01090000
*  Remove EPB from Events Table                                         01100000
*                                                                       01110000
****************************************************************        01120000
         ICM   R5,15,TPLTASK      TASK SPECIFIED?                       01130000
         BNZ   *+6                YES, CONTINUE                         01140000
         LR    R5,R10             USE CURRENT TASK                      01150000
T        USING ITASK,R5           ESTAB ADDR TO ITASK                   01160000
                                                                        01170000
         TM    T.TSKFLGS3,TSK3$AFF  RUNNING UNDER SERVER ITASK   159456 01180000
         BO    *+8                NO, CONTINUE                   159456 01190000
         L     R5,T.TSKSVTSK      ADDRESS OF SERVER ITASK        159456 01200000
                                                                        01210000
         ICM   R6,15,TPLEPB       GET EPB TO CANCEL                     01220000
         BZ    ERR_EPB            ERROR, EPB REQUIRED FOR REQUEST       01230000
         N     R6,=F'-2'          OBTAIN ADDRESS OF EPB IF TOKEN        01240000
         USING EPB,R6             ADDRESSABILITY                        01250000
                                                                        01260000
         EJECT ,                                                        01270000
*---------------------------------------------------------------        01280000
*  RETRIEVE ADDRESS OF ASSOCIATED ECB                                   01290000
*---------------------------------------------------------------        01300000
         OI    EPBFLGS,EPB$FLSH   INDICATE EVENT FLUSHED                01310000
         LA    R1,EPBECB          ASSUME INTERNAL                       01320000
         ST    R1,SAVEECB         SAVE ADDRESS OF CANCEL ECB            01330000
                                                                        01340000
*---------------------------------------------------------------        01350000
*  IF REMOTE ECB ATTEMPT TO LOCATE ECB ON TASK EPB LIST                 01360000
*---------------------------------------------------------------        01370000
         TM    EPBFLGS,EPB$RMT    REMOTE EPB?                           01380000
         BZ    REPB_PST           NO, CONTINUE WITH POST                01390000
         L     R1,EPBECB          ADDRESS OF REMOTE EPB                 01400000
         ST    R1,SAVEECB         SAVE ADDRESS OF CANCEL ECB            01410000
                                                                        01420000
         LA    R1,T.TSKEPBS       ADDRESS OF TASK REMOTE EPB LIST       01430000
         SH    R1,=AL2(EPBNEXT-EPB) SUBTRACT OFFSET TO LINK ADDR        01440000
RMT      USING EPB,R1             TEMP ADDRESSABILITY FOR RMT EPB       01450000
                                                                        01460000
RMT_NEXT DS    0H                                                       01470000
         ICM   R1,15,RMT.EPBNEXT  RETRIEVE NEXT EPB ADDRESS             01480000
         BZ    ERR_RMTE           INVALID REMOTE EPB ADDRESS            01490000
         CR    R1,R6              EPB FOUND ON REMOTE LIST              01500000
         BNE   RMT_NEXT           NO,  CHECK NEXT EPB                   01510000
         DROP  RMT                REMOTE EPB                            01520000
                                                                        01530000
         EJECT ,                                                        01540000
*---------------------------------------------------------------        01550000
*  POST EVENT COMPLETION    (CANCEL)                                    01560000
*---------------------------------------------------------------        01570000
REPB_PST DS    0H                                                       01580000
         $TASK POST,              POST EVENT CANCELLED                 +01590000
               EPB=EPB,                                                +01600000
               PCODE=$$CNCL,                                           +01610000
               WORKA=0,                                                +01620000
               MF=(E,$TSK_MFL)                                          01630000
                                                                        01640000
         EJECT ,                                                        01650000
*--------------------------------------------------------------- 159456 01660000
*  Determine if event is associated with current tcb. If so,     159456 01670000
*  continue with events wait=no to allow ECB to be syncronously  159456 01680000
*  removed from events table.                                    159456 01690000
*--------------------------------------------------------------- 159456 01700000
REPB_EVN DS    0H                                                159456 01710000
         CR    R5,R10             REQUEST FOR CURRENT TASK?      159456 01720000
         BE    REPB_EVL           YES, CONTINUE WITH EVENTS REQ  159456 01730000
         C     R5,TSKSVTSK        REQUEST ASSOC WITH SERVER TASK 159456 01740000
         BNE   REPB_RET           CAN'T SYNC REMOVE EPB FROM TASK159456 01750000
                                                                        01760000
*---------------------------------------------------------------        01770000
*  WAIT FOR COMPLETION OF EVENT (PROB STATE)                            01780000
*---------------------------------------------------------------        01790000
REPB_EVL DS    0H                                                159456 01800000
         L     R3,T.TSKEVNTL      ADDR OF LAST EVENT PROCESSED   159456 01810000
         TM    ICTSTAT2,ICT2$SUP  RUNNING SUPERVISOR STATE?             01820000
         BO    REPB_SUP           YES, TEST BRANCH ENTRY                01830000
                                                                        01840000
         EVENTS TABLE=T.TSKEVNT,  TEST FOR EVENT COMPLETION            +01850000
               WAIT=NO,                                                +01860000
               LAST=(R3)                                                01870000
                                                                        01880000
         ST    R1,EVENTLST        SAVE ADDR OF COMPLETED EVENTS  159456 01890000
         B     REPB_PRC           PROCESS COMPLETED EVENTS              01900000
                                                                        01910000
*---------------------------------------------------------------        01920000
* CHECK FOR COMPLETION OF EVENT (SUPV STATE)                            01930000
*---------------------------------------------------------------        01940000
REPB_SUP DS    0H                                                       01950000
         TM    TPLCFLGS,TPLC$LLH  LOCAL LOCK HELD BY CALLER?     159456 01960000
         BO    LOCK_HAV           LOCK ALREADY HELD              159456 01970000
                                                                        01980000
         $SER  OBTAIN,LOCAL       OBTAIN MVS LOCAL LOCK          159456 01990000
         B     *+4(R15)           BRANCH ON RETURN CODE          159456 02000000
         B     LOCK_ACQ           LOCK ACQUIRED                  159456 02010000
         B     LOCK_HAV           LOCK ALREADY OWNED             159456 02020000
         EX    0,*                SHOULD NOT OCCUR FOR MVSLCL    159456 02030000
                                                                        02040000
LOCK_ACQ DS    0H                                                159456 02050000
         OI    FLAGS,F$LLCL       INDICATE LOCAL LOCK ACQUIRED   159456 02060000
                                                                        02070000
LOCK_HAV DS    0H                                                159456 02080000
         MODESET EXTKEY=ZERO,     SWITCH TO KEY ZERO                   +02090000
               SAVEKEY=(2)                                              02100000
                                                                        02110000
         EVENTS TABLE=T.TSKEVNT,  TEST FOR EVENT COMPLETION      159456+02120000
               WAIT=NO,                                                +02130000
               LAST=(R3),                                              +02140000
               BRANCH=YES                                               02150000
                                                                        02160000
         ST    R1,EVENTLST        SAVE ADDR OF COMPLETED EVENTS  159456 02170000
                                                                        02180000
         MODESET KEYADDR=(2)      RESTORE CALLERS KEY                   02190000
                                                                        02200000
         TM    FLAGS,F$LLCL        LOCAL LOCK ACQUIRED?          159456 02210000
         BZ    REPB_PRC           NO,  SKIP RELEASE              159456 02220000
         $SER  RELEASE,LOCAL      RELEASE MVS LOCAL LOCK         159456 02230000
                                                                        02240000
         EJECT ,                                                        02250000
*---------------------------------------------------------------        02260000
* PROCESS COMPLETED EVENTS.  DISCARD ECB IF IT MATCHES                  02270000
* SPECIFIED ECB TO BE CANCELLED, ELSE CALL ITSKREDY TO                  02280000
* POST EVENT TO ASSOCIATED PCB.                                         02290000
*---------------------------------------------------------------        02300000
REPB_PRC DS    0H                                                       02310000
         XC    T.TSKEVNTL,T.TSKEVNTL  CLEAR LAST EVENT PROCESSED        02320000
         ICM   R3,15,EVENTLST     ADDR OF EVENT PLIST                   02330000
         BZ    REPB_PNQ           NO EVENTS, CHECK IF PENDING NFY       02340000
                                                                        02350000
REPB_ECB DS    0H                                                       02360000
         ST    R3,T.TSKEVNTL      SAVE ADDR OF LAST EVENT ENTRY  159456 02370000
                                                                        02380000
         L     R2,0(,R3)          ADDR OF COMPLETED ECB                 02390000
         N     R2,=X'7FFFFFFF'    RESET LIST OF LIST INDICATOR          02400000
         C     R2,SAVEECB         CANCEL ECB ADDRESS?                   02410000
         BNE   REPB_RDY           NO, ATTACH EPB TO PCB EVENT QUEUE     02420000
         OI    FLAGS,F$CANCEL     INDICATE EVENT DISCARDED              02430000
                                                                        02440000
REPB_RDY DS    0H                                                       02450000
         @CALL ITSKREDY,((R2),0), ATTACH EPB AND MARK PCB READY        +02460000
               WKA=WRK256,MF=(E,MFE_LIST)                               02470000
                                                                        02480000
REPB_NXT DS    0H                                                       02490000
         TM    0(R3),X'80'        LAST ECB IN EVENTS PLIST?             02500000
         BO    REPB_PNQ           YES, CHECK PENDING EVENTS QUEUE       02510000
         LA    R3,4(,R3)          ADDR OF NEXT ECB IN EVENTS LIST       02520000
         B     REPB_ECB           PROCESS NEXT COMPLETED EVENT          02530000
                                                                        02540000
         EJECT ,                                                        02550000
*--------------------------------------------------------------         02560000
* EVENTS LIST PROCESSED,  DETERMINE IF OUR ECB WAS IN THE LIST.         02570000
* IF NOT SCAN THE PENDING EVENTS QUEUE FOR THE PCB WORKUNIT             02580000
* AND REMOVE THE EPB FROM THE LIST IF SUCCESSFULLY LOCATED.             02590000
*--------------------------------------------------------------         02600000
REPB_PNQ DS    0H                                                       02610000
         TM    FLAGS,F$CANCEL     EVENT CANCEL SUCCESSFUL?              02620000
         BO    REPB_XND           YES, MARK DELETED IF XEPB             02630000
         TM    EPBFLGS,EPB$TASK   EPB ASSSOCIATED WITH ITASK WU         02640000
         BO    ERR_CNCL           ERROR, EPB NOT LOCATED                02650000
                                                                        02660000
         ICM   R9,15,EPBWU@       ADDRESS OF PCB                        02670000
         BZ    ERR_CNCL           NO WORKUNIT,  ERROR NOT FOUND         02680000
         C     R9,TSKPCBC         CURRENT WORKUNIT?                     02690000
         BNE   ERR_CNCL           NO, EPB NOT LOCATED                   02700000
         USING IPCB,R9            ADDRESSABILITY                        02710000
                                                                        02720000
         LA    R3,PCBEPB          ADDRESS OF READY EPB LIST             02730000
         SH    R3,=AL2(EPBNEXT-EPB)  BACKUP OFFSET TO LIST ADDR         02740000
Q        USING EPB,R3             TEMP ADDRESSABILITY                   02750000
                                                                        02760000
REPB_LOC DS    0H                                                       02770000
         C     R6,Q.EPBNEXT       IS EPB ALREADY ON COMPLETED LIST      02780000
         BE    REPB_REM           YES, REMOVE EPB FROM LIST             02790000
         ICM   R3,15,Q.EPBNEXT    CHECK NEXT EVENT ON EPB QUEUE         02800000
         BNZ   REPB_LOC           CHECK NEXT READY EPB                  02810000
         B     ERR_CNCL           ERROR, EPB NOT FOUND                  02820000
                                                                        02830000
REPB_REM DS    0H                                                       02840000
         MVC   Q.EPBNEXT,EPBNEXT  REMOVE EPB FROM READY QUEUE           02850000
         OI    FLAGS,F$CANCEL     INDICATE EPB CANCELLED                02860000
         DROP  Q,R9               EPB, IPCB                             02870000
                                                                        02880000
*--------------------------------------------------------------         02890000
* IF EPB IS AN XEPB, THEN INDICATE THAT THE EPB HAS BEEN DELETED        02900000
*--------------------------------------------------------------         02910000
REPB_XND DS    0H                                                       02920000
         TM    EPBFLGS,EPB$XND    EXTENDED EPB SPECIFIED                02930000
         BZ    REPB_RET           NO, RETURN NORMAL                     02940000
         $XEPB LDELETE,XEPB=(R6)  MARK XEPB AS DELETED                  02950000
                                                                        02960000
REPB_RET DS    0H                                                       02970000
         LA    R15,RC00           ASSUME NORMAL COMPLETION              02980000
         B     RETURN             NORMAL COMPLETION                     02990000
                                                                        03000000
         EJECT ,                                                        03010000
****************************************************************        03020000
*                                                                       03030000
*  ERROR RETURN                                                         03040000
*                                                                       03050000
****************************************************************        03060000
ERR_EPB  DS    0H                                                       03070000
         LA    R0,RSN04           EPB REQUIRED FOR EVENT                03080000
         LA    R15,RC20           REQUEST ERROR                         03090000
         B     RETURN             RETURN                                03100000
                                                                        03110000
ERR_CNCL DS    0H                                                       03120000
         LA    R0,RSN04           EPB NOT IN EVENTS TABLE               03130000
         LA    R15,RC12           SERVICE FAILURE                       03140000
         B     RETURN             RETURN                                03150000
                                                                        03160000
ERR_RMTE DS    0H                                                       03170000
         LA    R0,RSN08           REMOTE EPB NOT IN LIST                03180000
         LA    R15,RC12           SERVICE FAILURE                       03190000
         B     RETURN             RETURN                                03200000
                                                                        03210000
RETURN   DS    0H                                                       03220000
         #EXIT ,                  RETURN                                03230000
                                                                        03240000
         EJECT ,                                                        03250000
****************************************************************        03260000
*                                                                       03270000
*  CONSTANTS AND LITERALS                                               03280000
*                                                                       03290000
****************************************************************        03300000
                                                                        03310000
         LTORG ,                                                        03320000
                                                                        03330000
         PRINT NOGEN                                                    03340000
         ICVT  ,                                                        03350000
         ITASK ,                                                        03360000
         IPCB  ,                                                        03370000
         CVT   DSECT=YES,LIST=NO                                        03380000
                                                                        03390000
         PRINT GEN                                                      03400000
                                                                        03410000
         END   ,                                                        03420000

ICPIRCV TITLE 'INTEGRATOR - CPIC CMRCV API - RECEIVE'                   00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: ICPIRCV - CPIC CMRCV API                                     00100000
*                                                                       00110000
* DESCRIPTION:                                                          00120000
*                                                                       00130000
*    THIS ROUTINE IS CALLED TO PROCESS THE CMRCV VERB.                  00140000
*                                                                       00150000
* ON ENTRY:                                                             00160000
*                                                                       00170000
*    R15 = ENTRY POINT ADDRESS                                          00180000
*    R14 = RETURN      ADDRESS                                          00190000
*    R13 = SAVE AREA   ADDRESS                                          00200000
*    R01 = PARM LIST   ADDRESS                                          00210000
*                                                                       00220000
*          +00 = ADDRESS OF CONVERSATION_ID                             00230000
*          +04 = ADDRESS OF BUFFER                                      00240000
*          +08 = ADDRESS OF REQUESTED_LENGTH                            00250000
*          +0C = ADDRESS OF DATA_RECEIVED RETURN AREA                   00260000
*          +10 = ADDRESS OF RECEIVED_LENGTH RETURN AREA                 00270000
*          +14 = ADDRESS OF STATUS_RECEIVED RETURN AREA                 00280000
*          +18 = ADDRESS OF REQUEST_TO_SEND_RECEIVED RETURN AREA        00290000
*          +1C = ADDRESS OF RETURN_CODE RETURN AREA                     00300000
*                                                                       00310000
* ON EXIT:                                                              00320000
*                                                                       00330000
*    R15 = 0                                                            00340000
*                                                                       00350000
*    RETURN_CODE = CM_OK                        --> CMRCV SUCCESSFUL    00360000
*                = CM_PROGRAM_PARAMETER_CHECK   --> INVALID CONV_ID     00370000
*                = CM_PROGRAM_STATE_CHECK       --> INVALID CONV STATE  00380000
*                = CM_RESOURCE_FAILURE_NO_RETRY --> SEND/$SESS FAILED   00390000
*                = CM_PRODUCT_SPECIFIC_ERROR    --> BAD PARM            00400000
*                = CM_OPERATION_NOT_ACCEPTED    --> N/A                 00410000
*                                                                       00420000
**<DOC-OFF>************************************************************ 00430000
         EJECT ,                                                        00440000
*********************************************************************** 00450000
*                                                                       00460000
* MAINTENANCE:                                                          00470000
*                                                                       00480000
*   07/01/94 RANDY WITEK                                                00490000
*                                                                       00500000
*********************************************************************** 00510000
                                                                        00520000
         EQUS  ,                  GENERAL EQUATES                       00530000
                                                                        00540000
RICVT    EQU   R11                                                      00550000
RITASK   EQU   R10                                                      00560000
RBASE    EQU   R9                                                       00570000
RIVTAM   EQU   R8                                                       00580000
RCMLIST  EQU   R7                                                       00590000
RTKB     EQU   R6                                                       00600000
RRCB     EQU   R5                                                       00610000
RISESS   EQU   R4                                                       00620000
                                                                        00630000
         USING DSA,R13            ESTABLISH ADDRESSABILITY              00640000
         USING CRAB,R12           ESTABLISH ADDRESSABILITY              00650000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00660000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00670000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00680000
         USING CMLIST,RCMLIST     ESTABLISH ADDRESSABILITY              00690000
         USING TKB,RTKB           ESTABLISH ADDRESSABILITY              00700000
         USING RCB,RRCB           ESTABLISH ADDRESSABILITY              00710000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00720000
                                                                        00730000
         COPY  CRAB               "C" RUNTIME ANCHOR BLOCK              00740000
         COPY  DSA                DYNAMIC SAVE AREA                     00750000
WORKAREA DS    0H                 READ/WRITE WORKAREA                   00760000
WRK256   DS    XL256              GENERAL WORKAREA                      00770000
$SESSMFL $SESS MF=L               PLIST CONSTRUCTION                    00780000
$TASKMFL $TASK MF=L               PLIST CONSTRUCTION                    00790000
L62MFL   L62DLRC MF=L             PLIST CONSTRUCTION                    00800000
L62RETRC DS    F                  LU6.2 SERVICE RETURN CODE AREA        00810000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00820000
SUB1SAVE DS    18F                SUBROUTINE SAVE AREA                  00830000
SAVEEPB  DS    A                  XEPB ADDRESS                          00840000
CONVID   DS    XL8                TEMPORARY CONVERSATION_ID  AREA       00850000
RETCODE  DS    F                  TEMPORARY RETURN_CODE      AREA       00860000
RETRTSR  DS    F                  TEMPORARY RTS_RECEIVED     AREA       00870000
RETSTAT  DS    F                  TEMPORARY STATUS_RECEIVED  AREA       00880000
RETDATAR DS    F                  TEMPORARY DATA_RECEIVED    AREA       00890000
BUFFER   DS    A                  TEMPORARY BUFFER ADDRESS   AREA       00900000
REQLENG  DS    F                  TEMPORARY REQUESTED_LENGTH AREA       00910000
RCVLENG  DS    F                  TEMPORARY RECEIVED_LENGTH  AREA       00920000
CONVS    DS    F                  TEMPORARY CONV STATE       AREA       00930000
FLAG     DS    X                                                        00940000
FLAGIERR EQU   X'80'                                                    00950000
FLAGLOCK EQU   X'40'                                                    00960000
FLAGLCKD EQU   X'20'                                                    00970000
FLAGFREE EQU   X'10'              RELEASE SESSION FOR RESET STATE       00980000
WORKLEN  EQU   *-WORKAREA         LENGTH OF USER DSA AREA               00990000
DSALEN   EQU   *-DSA              LENGTH OF DSA                         01000000
                                                                        01010000
         $MSGDFT PREFIX=ICTPID,                                        +01020000
               COMPID='CPI',                                           +01030000
               TABLE=*#MSGS,                                           +01040000
               WORKA=0,                                                +01050000
               MF=(E,WRK256),                                          +01060000
               PRINT=NOGEN                                              01070000
                                                                        01080000
ICPRCV@  CSECT ,                                                        01090000
ICPIRCV  CENTRY DSA=DSALEN,BASE=RBASE,INDEP=YES                         01100000
                                                                        01110000
*---------------------------------------------------------------------- 01120000
* ENTRY                                                                 01130000
*---------------------------------------------------------------------- 01140000
                                                                        01150000
         LR    RCMLIST,R1         SAVE ADDRESS OF PLIST                 01160000
                                                                        01170000
         LA    R0,WORKAREA        ADDRESS OF USER DSA SECTION           01180000
         LA    R1,WORKLEN         LENGTH  OF USER DSA SECTION           01190000
         SR    R15,R15            PREPARE FOR CLEAR                     01200000
         MVCL  R0,R14             CLEAR USER DSA SECTION                01210000
                                                                        01220000
*---------------------------------------------------------------------- 01230000
* INITIALIZATION                                                        01240000
*---------------------------------------------------------------------- 01250000
                                                                        01260000
         @RESTENV ,               ENSURE ENVIRONMENT                    01270000
                                                                        01280000
         L     RIVTAM,ICTVTCVT    ESTABLISH IVTAMCVT POINTER            01290000
                                                                        01300000
         MVC   CONVID,=XL8'AA55AA55AA55AA55'                            01310000
         MVC   BUFFER,=XL4'AA55AA55'                                    01320000
         MVC   REQLENG,=XL4'AA55AA55'                                   01330000
         MVC   RCVLENG,=XL4'AA55AA55'                                   01340000
         MVC   CONVS,=XL4'AA55AA55'                                     01350000
                                                                        01360000
         L     R1,CMLPARM8        ADDRESS OF RETURN_CODE                01370000
         MVC   0(4,R1),=A(CM_OK)                                        01380000
                                                                        01390000
         ICM   R1,15,CMLPARM1     ADDRESS OF CONVERSATION ID            01400000
         BNP   INITERR            BRANCH IF BAD                         01410000
         MVC   CONVID,0(R1)       COPY CONVERSATION ID                  01420000
                                                                        01430000
         ICM   R3,15,CMLPARM2     ADDRESS OF BUFFER                     01440000
         BNP   INITERR            BRANCH IF BAD                         01450000
         ST    R3,BUFFER          SAVE LOCAL COPY OF BUFFER ADDRESS     01460000
                                                                        01470000
         ICM   R1,15,CMLPARM3     ADDRESS OF REQUESTED LENGTH           01480000
         BNP   INITERR            BRANCH IF BAD                         01490000
         ICM   R2,15,0(R1)        REQUESTED LENGTH                      01500000
         ST    R2,REQLENG         SAVE REQUESTED LENGTH                 01510000
         BM    INITERR            BRANCH IF BAD                         01520000
         BZ    NOLENG             BRANCH IF ZERO                        01530000
         MVC   0(1,R3),0(R3)      TEST MOVEMENT (START OF BUFFER)       01540000
         LA    R3,0(R2,R3)        END OF BUFFER                         01550000
         BCTR  R3,0               ADDRESS OF LAST BYTE                  01560000
         MVC   0(1,R3),0(R3)      TEST MOVEMENT (END   OF BUFFER)       01570000
NOLENG   DS    0H                                                       01580000
                                                                        01590000
         ICM   R1,15,CMLPARM4     ADDRESS OF DATA_RECEIVED              01600000
         BNP   INITERR            BRANCH IF BAD                         01610000
         MVC   0(4,R1),=A(CM_NO_DATA_RECEIVED)                          01620000
                                                                        01630000
         ICM   R1,15,CMLPARM5     ADDRESS OF RECEIVED_LENGTH            01640000
         BNP   INITERR            BRANCH IF BAD                         01650000
         MVC   0(4,R1),=A(0)                                            01660000
                                                                        01670000
         ICM   R1,15,CMLPARM6     ADDRESS OF STATUS_RECEIVED            01680000
         BNP   INITERR            BRANCH IF BAD                         01690000
         MVC   0(4,R1),=A(CM_NO_STATUS_RECEIVED)                        01700000
                                                                        01710000
         ICM   R1,15,CMLPARM7     ADDRESS OF REQUEST_TO_SEND_RECEIVED   01720000
         BNP   INITERR            BRANCH IF BAD                         01730000
         MVC   0(4,R1),=A(CM_REQUEST_TO_SEND_NOT_RECEIVED)              01740000
                                                                        01750000
         B     INITEND                                                  01760000
                                                                        01770000
INITERR  DS    0H                                                       01780000
                                                                        01790000
         OI    FLAG,FLAGIERR      REMEMBER ERROR DETECTED               01800000
                                                                        01810000
INITEND  DS    0H                                                       01820000
                                                                        01830000
*---------------------------------------------------------------------- 01840000
* ENTRY TRACE                                                           01850000
*---------------------------------------------------------------------- 01860000
                                                                        01870000
         $TRACE *=A(TRC_CPIC_ICPIRCV),48 TRACE ENTRY W/ 48 USER BYTES   01880000
         BNZ   NOETRACE                  BRANCH IF NOT TRACING          01890000
         $APITRC ICPIRCV                 TRACE COMMON STUFF             01900000
         ST    RCMLIST,24(,R1)           TRACE PARMLIST ADDRESS         01910000
         MVC   32(8,R1),CONVID           TRACE CONVERSATION ID          01920000
         MVC   40(4,R1),BUFFER           TRACE BUFFER ADDRESS           01930000
         MVC   44(4,R1),REQLENG          TRACE REQUESTED LENGTH         01940000
NOETRACE DS    0H                                                       01950000
                                                                        01960000
*---------------------------------------------------------------------- 01970000
* LOCATE SPECIFIED CONVERSATION                                         01980000
*---------------------------------------------------------------------- 01990000
                                                                        02000000
         TM    FLAG,FLAGIERR             ERROR DETECTED ALREADY?        02010000
         BO    ERRPROD                   BRANCH IF YES                  02020000
                                                                        02030000
         LA    R1,CONVID                 ADDRESS OF CONVERSATION ID     02040000
         L     R15,ICP@LOC               ENTRY POINT OF TKB/RCB LOCATE  02050000
         BASR  R14,R15                   LOCATE THE TKB/RCB             02060000
         LTR   RTKB,R1                   TKB ADDRESS                    02070000
         BNP   ERRPARM                   BRANCH IF BAD                  02080000
         LTR   RRCB,R0                   RCB ADDRESS                    02090000
         BNP   ERRPARM                   BRANCH IF BAD                  02100000
                                                                        02110000
         MVC   CONVS,RCBCONVS            LOCAL COPY OF CONV STATE       02120000
                                                                        02130000
*---------------------------------------------------------------------- 02140000
* STATE CHECK                                                           02150000
*---------------------------------------------------------------------- 02160000
                                                                        02170000
         CLC   CONVS,=A(CM_RECEIVE_STATE)                               02180000
         BE    RECEIVE                                                  02190000
                                                                        02200000
         CLC   RCBRTYPE,=A(CM_RECEIVE_AND_WAIT)                         02210000
         BNE   ERRSTATE                                                 02220000
         CLC   CONVS,=A(CM_SEND_STATE)                                  02230000
         BE    RCVSEND                                                  02240000
         CLC   CONVS,=A(CM_SEND_PENDING_STATE)                          02250000
         BE    RCVSENDP                                                 02260000
         B     ERRSTATE                                                 02270000
                                                                        02280000
*---------------------------------------------------------------------- 02290000
* MOVE THE CONVERSATION FROM SEND/SEND_PENDING TO RECEIVE STATE         02300000
*---------------------------------------------------------------------- 02310000
                                                                        02320000
RCVSEND  DS    0H                                                       02330000
RCVSENDP DS    0H                                                       02340000
                                                                        02350000
*                                                                       02360000
* RESERVE THE SESSION                                                   02370000
*---------------------------------------------------------------------- 02380000
                                                                        02390000
         BAS   R14,VTAMLOCK                                             02400000
                                                                        02410000
         $SESS $SESS_FIND_SESSION,                                     +02420000
               SESSION=RCBHSID,                                        +02430000
               ERRET=ERRSESS,                                          +02440000
               MF=(E,$SESSMFL)    LOCATE ASSOCIATED ISESS, IF ANY       02450000
                                                                        02460000
X        USING SPLIST,$SESSMFL                                          02470000
         L     RISESS,X.SPLAREA   ADDRESS OF ASSOCIATED ISESS BLOCK     02480000
         DROP  X                                                        02490000
                                                                        02500000
         TM    ISEF1,ISEF1TRM     SESS TERM STARTED?                    02510000
         BO    ERRSESS            BRANCH IF YES                         02520000
         TM    ISE62FL2,ISE62DRD  IS DRIVER DOWN?                       02530000
         BO    ERRSESS            BRANCH IF YES                         02540000
                                                                        02550000
*                                                                       02560000
* LOCATE THE SBUF                                                       02570000
*---------------------------------------------------------------------- 02580000
                                                                        02590000
         ST    RISESS,SUB0SAVE    MAKE A PLIST                          02600000
         LA    R1,SUB0SAVE        PASS ADDRESS OF PLIST                 02610000
         L     R15,ICP@SBUF       CALL THE SBUF SERVICE                 02620000
         BASR  R14,R15            LINK TO SERVICE                       02630000
                                                                        02640000
*                                                                       02650000
* VALIDATE BASIC CONVERSATION LOGICAL RECORD LENGTH                     02660000
*---------------------------------------------------------------------- 02670000
                                                                        02680000
         CLC   RCBCTYPE,=A(CM_MAPPED_CONVERSATION)                      02690000
         BE    FLUSH              BRANCH IF MAPPED CONVERSATION         02700000
         OC    RCBSLLRM,RCBSLLRM  IS LAST LOGICAL RECORD COMPLETE?      02710000
         BNZ   ERRSTATE           BRANCH IF NOT                         02720000
                                                                        02730000
*                                                                       02740000
* ADD APPROPRIATE RH BITS TO SEND RH BUILD AREA                         02750000
*---------------------------------------------------------------------- 02760000
                                                                        02770000
FLUSH    DS    0H                                                       02780000
                                                                        02790000
         CLI   ISE62FSC,ISE62FSC_BETC ARE WE IN-CHAIN?                  02800000
         BNE   SENDNOBC               BRANCH IF YES                     02810000
         OI    ISE62RH0,RHBCI         SET BEGIN CHAIN                   02820000
                                                                        02830000
         CLI   ISE62FBR,ISE62FBR_BETB ARE WE IN-BRACKETS?               02840000
         BNE   SENDNOBC               BRANCH IF YES                     02850000
         OI    ISE62RH2,RHBBI         SET BEGIN BRACKET                 02860000
                                                                        02870000
SENDNOBC DS    0H                                                       02880000
                                                                        02890000
         OI    ISE62RH0,RHECI       SET END CHAIN                       02900000
         OI    ISE62RH2,RHCDI       PASS THE CD BIT                     02910000
         OI    ISE62RH1,RHDR1+RHERI ASK FOR ER1                         02920000
         NI    ISE62RH1,255-RHDR2   ASK FOR ER1                         02930000
                                                                        02940000
*                                                                       02950000
* ALLOCATE A CPIC REQUEST WORK ELEMENT                                  02960000
*---------------------------------------------------------------------- 02970000
                                                                        02980000
         $VTAMWE L'IWEXX,         SIZE                                 +02990000
               IWECSHIP           CODE                                  03000000
                                                                        03010000
         LR    R3,R1              ESTABLISH ADDRESSABILITY              03020000
                                                                        03030000
*                                                                       03040000
* ALLOCATE AN XEPB                                                      03050000
*---------------------------------------------------------------------- 03060000
                                                                        03070000
         $TASK SETEPB,            INITIALIZE EPB FOR SYNCH REQUEST     +03080000
               ECODE=EC$SHIP,     EVENT CODE                           +03090000
               ERRET=ERR$TASK,                                         +03100000
               MF=(E,$TASKMFL)                                          03110000
                                                                        03120000
         ST    R1,SAVEEPB         SAVE THE XEPB ADDRESS                 03130000
                                                                        03140000
*                                                                       03150000
* FILL IN THE CPIC SHIP REQUEST WORK ELEMENT                            03160000
*---------------------------------------------------------------------- 03170000
                                                                        03180000
         USING IWEVTAM,R3                                               03190000
         MVC   IWEXXENT,TKBTCBID  ENTITY TOKEN                          03200000
         MVC   IWEXXEPB,SAVEEPB   EPB ADDRESS                           03210000
         ST    RRCB,IWEXXRCB      RCB ADDRESS                           03220000
         DROP  R3                                                       03230000
                                                                        03240000
*                                                                       03250000
* QUEUE THE CPIC SHIP REQUEST WORK ELEMENT TO THE SESSION QUEUE         03260000
*---------------------------------------------------------------------- 03270000
                                                                        03280000
         $VTAMQ (R3),             WORK ELEMENT                         +03290000
               ISEWEQ             QUEUE                                 03300000
                                                                        03310000
*                                                                       03320000
* RELEASE SERIALIZATION & WAIT FOR POSTING OF THE CPIC SHIP REQUEST     03330000
*---------------------------------------------------------------------- 03340000
                                                                        03350000
         BAS   R14,VTAMUNLK       RELEASE LOCK                          03360000
         SR    RISESS,RISESS      CAN'T GUARANTEE THE ISESS RIGHT NOW   03370000
                                                                        03380000
         $TASK WAIT,              WAIT FOR REQUEST COMPLETION          +03390000
               EPB=*SAVEEPB,      XEPB ADDRESS                         +03400000
               MF=(E,$TASKMFL)                                          03410000
                                                                        03420000
*                                                                       03430000
* CHECK IF SHIP COMPLETED SUCCESSFULLY                                  03440000
*---------------------------------------------------------------------- 03450000
                                                                        03460000
         LTR   R15,R0               POST CODE RETURNED IN R0            03470000
         ST    R15,RETCODE          SAVE THE RETURN CODE                03480000
         BNZ   ERRSHIP              BRANCH IF SHIP FAILED               03490000
                                                                        03500000
*                                                                       03510000
* CONVERSATION IS NOW OFFICIALLY IN RECEIVE STATE                       03520000
*---------------------------------------------------------------------- 03530000
                                                                        03540000
         MVC   RCBCONVS,=A(CM_RECEIVE_STATE)                            03550000
         B     RECEIVE              AND CONTINUE WITH THE RECEIVE       03560000
                                                                        03570000
*---------------------------------------------------------------------- 03580000
* PERFORM RECEIVE OPERATION                                             03590000
*---------------------------------------------------------------------- 03600000
                                                                        03610000
RECEIVE  DS    0H                                                       03620000
                                                                        03630000
*                                                                       03640000
* VALIDATE LENGTH                                                       03650000
*---------------------------------------------------------------------- 03660000
                                                                        03670000
         ICM   R1,15,REQLENG      REQUESTED LENGTH                      03680000
         BM    ERRPARM            ERROR IF NOT POSITIVE                 03690000
         C     R1,=A(CM_MAXIMUM_RECEIVE_LENGTH)                         03700000
         BH    ERRPARM            ERROR IF TOO LONG                     03710000
                                                                        03720000
*                                                                       03730000
* RESERVE THE SESSION                                                   03740000
*---------------------------------------------------------------------- 03750000
                                                                        03760000
         BAS   R14,VTAMLOCK                                             03770000
                                                                        03780000
         $SESS $SESS_FIND_SESSION,                                     +03790000
               SESSION=RCBHSID,                                        +03800000
               ERRET=ERRSESS,                                          +03810000
               MF=(E,$SESSMFL)    LOCATE ASSOCIATED ISESS, IF ANY       03820000
                                                                        03830000
X        USING SPLIST,$SESSMFL                                          03840000
         L     RISESS,X.SPLAREA   ADDRESS OF ASSOCIATED ISESS BLOCK     03850000
         DROP  X                                                        03860000
                                                                        03870000
         TM    ISEF1,ISEF1TRM     SESS TERM STARTED?                    03880000
         BO    ERRSESS            BRANCH IF YES                         03890000
         TM    ISE62FL2,ISE62DRD  IS DRIVER DOWN?                       03900000
         BO    ERRSESS            BRANCH IF YES                         03910000
                                                                        03920000
*                                                                       03930000
* ALLOCATE A CPIC RECEIVE REQUEST WORK ELEMENT                          03940000
*---------------------------------------------------------------------- 03950000
                                                                        03960000
         $VTAMWE L'IWEY1,         SIZE                                 +03970000
               IWECRECV           CODE                                  03980000
                                                                        03990000
         LR    R3,R1              ESTABLISH ADDRESSABILITY              04000000
                                                                        04010000
*                                                                       04020000
* ALLOCATE AN XEPB                                                      04030000
*---------------------------------------------------------------------- 04040000
                                                                        04050000
         $TASK SETEPB,            INITIALIZE EPB FOR SYNCH REQUEST     +04060000
               ECODE=EC$RECV,     EVENT CODE                           +04070000
               ERRET=ERR$TASK,                                         +04080000
               MF=(E,$TASKMFL)                                          04090000
                                                                        04100000
         ST    R1,SAVEEPB         SAVE THE XEPB ADDRESS                 04110000
                                                                        04120000
*                                                                       04130000
* FILL IN THE CPIC RECEIVE REQUEST WORK ELEMENT                         04140000
*---------------------------------------------------------------------- 04150000
                                                                        04160000
         USING IWEVTAM,R3                                               04170000
         MVC   IWEY1ENT,TKBTCBID  ENTITY TOKEN                          04180000
         MVC   IWEY1EPB,SAVEEPB   EPB ADDRESS                           04190000
         ST    RRCB,IWEY1RCB      RCB ADDRESS                           04200000
         ST    RCMLIST,IWEY1PLA   CPIC RECEIVE PARM LIST ADDRESS        04210000
         DROP  R3                                                       04220000
                                                                        04230000
*                                                                       04240000
* QUEUE THE CPIC RECEIVE REQUEST WORK ELEMENT TO THE SESSION QUEUE      04250000
*---------------------------------------------------------------------- 04260000
                                                                        04270000
         $VTAMQ (R3),             WORK ELEMENT                         +04280000
               ISEWEQ             QUEUE                                 04290000
                                                                        04300000
*                                                                       04310000
* RELEASE SERIALIZATION & WAIT FOR POSTING OF THE CPIC RECEIVE REQUEST  04320000
*---------------------------------------------------------------------- 04330000
                                                                        04340000
         BAS   R14,VTAMUNLK       RELEASE LOCK                          04350000
         SR    RISESS,RISESS      CAN'T GUARANTEE THE ISESS RIGHT NOW   04360000
                                                                        04370000
         $TASK WAIT,              WAIT FOR REQUEST COMPLETION          +04380000
               EPB=*SAVEEPB,      XEPB ADDRESS                         +04390000
               MF=(E,$TASKMFL)                                          04400000
                                                                        04410000
*                                                                       04420000
* MAP CMRCV RETURN VALUES BACK INTO LOCAL VARIABLES                     04430000
*---------------------------------------------------------------------- 04440000
                                                                        04450000
         L     R1,CMLPARM4        ADDRESS OF DATA_RECEIVED AREA         04460000
         MVC   RETDATAR,0(R1)     SET DATA_RECEIVED LOCAL VARIABLE      04470000
                                                                        04480000
         L     R1,CMLPARM5        ADDRESS OF RECEIVED_LENGTH AREA       04490000
         MVC   RCVLENG,0(R1)      SET RECEIVED_LENGTH LOCAL VARIABLE    04500000
                                                                        04510000
         L     R1,CMLPARM6        ADDRESS OF STATUS_RECEIVED AREA       04520000
         MVC   RETSTAT,0(R1)      SET STATUS_RECEIVED LOCAL VARIABLE    04530000
                                                                        04540000
         L     R1,CMLPARM7        ADDRESS OF RTS_RECEIVED AREA          04550000
         MVC   RETRTSR,0(R1)      SET RTS_RECEIVED LOCAL VARIABLE       04560000
                                                                        04570000
         L     R1,CMLPARM8        ADDRESS OF RETURN_CODE AREA           04580000
         MVC   RETCODE,0(R1)      SET RETURN_CODE LOCAL VARIABLE        04590000
                                                                        04600000
*                                                                       04610000
* UPDATE STATE FOR SUCCESSFUL RECEIVES                                  04620000
*---------------------------------------------------------------------- 04630000
                                                                        04640000
         CLI   RETCODE+(L'RETCODE-1),CM_OK SUCCESSFUL RECEIVE?          04650000
         BNE   ERRRCV                      BRANCH IF NOT                04660000
                                                                        04670000
         CLI   RETSTAT+(L'RETSTAT-1),CM_NO_STATUS_RECEIVED              04680000
         BE    RETURN                NO CHANGE IF NO STATUS             04690000
                                                                        04700000
         CLI   RETSTAT+(L'RETSTAT-1),CM_SEND_RECEIVED                   04710000
         BNE   CHKCONF               BRANCH IF NOT                      04720000
         MVI   RCBCONVS+(L'RCBCONVS-1),CM_SEND_STATE                    04730000
         CLI   RETDATAR+(L'RETDATAR-1),CM_NO_DATA_RECEIVED              04740000
         BE    RETURN                BRANCH IF NO DATA RECEIVED         04750000
         MVI   RCBCONVS+(L'RCBCONVS-1),CM_SEND_PENDING_STATE            04760000
         B     RETURN                AND RETURN                         04770000
                                                                        04780000
CHKCONF  DS    0H                                                       04790000
                                                                        04800000
         CLI   RETSTAT+(L'RETSTAT-1),CM_CONFIRM_RECEIVED                04810000
         BNE   CHKCONFS                                                 04820000
         MVI   RCBCONVS+(L'RCBCONVS-1),CM_CONFIRM_STATE                 04830000
         B     RETURN                AND RETURN                         04840000
                                                                        04850000
CHKCONFS DS    0H                                                       04860000
                                                                        04870000
         CLI   RETSTAT+(L'RETSTAT-1),CM_CONFIRM_SEND_RECEIVED           04880000
         BNE   CHKCONFD                                                 04890000
         MVI   RCBCONVS+(L'RCBCONVS-1),CM_CONFIRM_SEND_STATE            04900000
         B     RETURN                AND RETURN                         04910000
                                                                        04920000
CHKCONFD DS    0H                                                       04930000
                                                                        04940000
         CLI   RETSTAT+(L'RETSTAT-1),CM_CONFIRM_DEALLOC_RECEIVED        04950000
         BNE   RETURN                                                   04960000
         MVI   RCBCONVS+(L'RCBCONVS-1),CM_CONFIRM_DEALLOCATE_STATE      04970000
         B     RETURN                AND RETURN                         04980000
                                                                        04990000
*---------------------------------------------------------------------- 05000000
* EXCEPTION ROUTINES                                                    05010000
*---------------------------------------------------------------------- 05020000
                                                                        05030000
ERRPROD  DS    0H                                                       05040000
                                                                        05050000
         MVC   RETCODE,=A(CM_PRODUCT_SPECIFIC_ERROR)                    05060000
         B     RETURN                                                   05070000
                                                                        05080000
ERRSTATE DS    0H                                                       05090000
                                                                        05100000
         MVC   RETCODE,=A(CM_PROGRAM_STATE_CHECK)                       05110000
         B     RETURN                                                   05120000
                                                                        05130000
ERRPARM  DS    0H                                                       05140000
                                                                        05150000
         MVC   RETCODE,=A(CM_PROGRAM_PARAMETER_CHECK)                   05160000
         B     RETURN                                                   05170000
                                                                        05180000
ERRSESS  DS    0H                                                       05190000
                                                                        05200000
         MVC   RETCODE,=A(CM_RESOURCE_FAILURE_NO_RETRY)                 05210000
         B     ERRSHIP                                                  05220000
                                                                        05230000
ERRRCV   DS    0H                                                       05240000
                                                                        05250000
ERRSHIP  DS    0H                                                       05260000
                                                                        05270000
         LA    R1,ESTAB                                                 05280000
         LA    R2,L'ESTABENT                                            05290000
         LA    R3,ESTABLST                                              05300000
                                                                        05310000
ESLOOP   DS    0H                                                       05320000
                                                                        05330000
         CLC   RETCODE,0(R1)          DOES RETCODE MATCH ENTRY?         05340000
         BE    ESFOUND                BRANCH IF YES                     05350000
         BXLE  R1,R2,ESLOOP           CHECK ALL TABLE ENTRIES           05360000
         B     RETURN                 JUST RETURN IF NOT IN TABLE       05370000
                                                                        05380000
ESFOUND  DS    0H                                                       05390000
                                                                        05400000
         ICM   R15,15,4(R1)           GET NEW STATE VALUE               05410000
         BP    ESGOOD                 BRANCH IF STATE IS OK             05420000
         EX    0,*                    KILL THE PROCESS                  05430000
                                                                        05440000
ESGOOD   DS    0H                                                       05450000
                                                                        05460000
         ST    R15,RCBCONVS           SET THE NEW STATE                 05470000
         C     R15,=A(CM_RESET_STATE) IS THE NEW STATE "RESET"          05480000
         BNE   RETURN                 BRANCH IF NOT                     05490000
         OI    FLAG,FLAGFREE          SET THE END CONVERSATION          05500000
         B     RETURN                 AND RETURN                        05510000
                                                                        05520000
ESTAB    DC    A(CM_CONVERSATION_TYPE_MISMATCH),A(CM_RESET_STATE)       05530000
ESTABENT EQU   ESTAB,*-ESTAB                                            05540000
         DC    A(CM_PIP_NOT_SPECIFIED_CORRECTLY),A(CM_RESET_STATE)      05550000
         DC    A(CM_SECURITY_NOT_VALID),A(CM_RESET_STATE)               05560000
         DC    A(CM_SYNC_LVL_NOT_SUPPORTED_PGM),A(CM_RESET_STATE)       05570000
         DC    A(CM_TPN_NOT_RECOGNIZED),A(CM_RESET_STATE)               05580000
         DC    A(CM_TP_NOT_AVAILABLE_NO_RETRY),A(CM_RESET_STATE)        05590000
         DC    A(CM_TP_NOT_AVAILABLE_RETRY),A(CM_RESET_STATE)           05600000
         DC    A(CM_DEALLOCATED_ABEND_TIMER),A(CM_RESET_STATE)          05610000
         DC    A(CM_DEALLOCATED_ABEND_SVC),A(CM_RESET_STATE)            05620000
         DC    A(CM_DEALLOCATED_ABEND),A(CM_RESET_STATE)                05630000
         DC    A(CM_DEALLOCATED_NORMAL),A(CM_RESET_STATE)               05640000
         DC    A(CM_RESOURCE_FAILURE_NO_RETRY),A(CM_RESET_STATE)        05650000
         DC    A(CM_RESOURCE_FAILURE_RETRY),A(CM_RESET_STATE)           05660000
         DC    A(CM_PROGRAM_ERROR_PURGING),A(CM_RECEIVE_STATE)          05670000
         DC    A(CM_SVC_ERROR_PURGING),A(CM_RECEIVE_STATE)              05680000
         DC    A(CM_PROGRAM_ERROR_NO_TRUNC),A(CM_RECEIVE_STATE)         05690000
         DC    A(CM_SVC_ERROR_NO_TRUNC),A(CM_RECEIVE_STATE)             05700000
         DC    A(CM_PROGRAM_ERROR_TRUNC),A(CM_RECEIVE_STATE)            05710000
         DC    A(CM_SVC_ERROR_TRUNC),A(CM_RECEIVE_STATE)                05720000
         DC    A(CM_UNSUCCESSFUL),A(CM_RECEIVE_STATE)                   05730000
         DC    A(CM_TAKE_BACKOUT),A(-1)                                 05740000
         DC    A(CM_DEALLOCATED_ABEND_TIMER_BO),A(-1)                   05750000
         DC    A(CM_DEALLOCATED_ABEND_SVC_BO),A(-1)                     05760000
         DC    A(CM_DEALLOCATED_ABEND_BO),A(-1)                         05770000
         DC    A(CM_RESOURCE_FAIL_NO_RETRY_BO),A(-1)                    05780000
         DC    A(CM_RESOURCE_FAILURE_RETRY_BO),A(-1)                    05790000
ESTABLST EQU   *-L'ESTABENT                                             05800000
                                                                        05810000
*---------------------------------------------------------------------- 05820000
* EXIT TRACE AND RETURN TO CALLER                                       05830000
*---------------------------------------------------------------------- 05840000
                                                                        05850000
RETURN   DS    0H                                                       05860000
                                                                        05870000
         TM    FLAG,FLAGFREE          RELEASE THE SESSION?              05880000
         BNO   RETURNX                BRANCH IF NOT                     05890000
                                                                        05900000
         L62DLRC (RRCB),                                               +05910000
               L62RETRC,                                               +05920000
               MF=(E,L62MFL)          DELETE THE RCB & RELEASE          05930000
                                                                        05940000
RETURNX  DS    0H                                                       05950000
                                                                        05960000
         BAS   R14,VTAMUNLK           RELEASE THE LOCK IF NECESSARY     05970000
                                                                        05980000
         $TRACE *=A(TRC_CPIC_EXIT),48 TRACE ENTRY                       05990000
         BNZ   NOXTRACE               BRANCH IF TRACING NOT AVAILABLE   06000000
         MVC   0(8,R1),=CL8'ICPIRCV'  MODULE NAME                       06010000
         MVC   8(4,R1),RETCODE        RETURN_CODE VALUE                 06020000
         MVC   12(8,R1),CONVID        CONVERSATION ID                   06030000
         MVC   20(4,R1),CONVS         CONVERSATION STATE                06040000
         MVC   24(4,R1),BUFFER        BUFFER ADDRESS                    06050000
         MVC   28(4,R1),RCVLENG       RECEIVED LENGTH                   06060000
         MVC   32(4,R1),RETDATAR      DATA RECEIVED VARIABLE            06070000
         MVC   36(4,R1),RETSTAT       STATUS RECEIVED VARIABLE          06080000
         MVC   40(4,R1),RETRTSR       RTS RECEIVED VARIABLE             06090000
         CLC   RETCODE,=A(CM_OK)      SHOULD WE TRACE DATA?             06100000
         BNE   NOXTRACE               BRANCH IF NOT                     06110000
         ICM   R3,15,RCVLENG          IS THERE DATA TO TRACE?           06120000
         BNP   NOXTRACE               BRANCH IF NOT                     06130000
         L     R2,BUFFER              START OF RECEIVED DATA            06140000
         SR    R4,R4                  STARTING OFFSET                   06150000
XTRCDATA DS    0H                                                       06160000
         $TRACE *=A(TRC_CPIC_RECEIVE_DATA),144 RECEIVED DATA TRACE      06170000
         BNZ   NOXTRACE               BRANCH IF TRACING NOT AVAILABLE   06180000
         MVC   0(8,R1),CONVID         CONVERSATION ID                   06190000
         MVC   8(4,R1),=F'128'        SET MAX TRACE DATA LENGTH         06200000
         C     R3,=F'128'             AT LEAST 128 TO GO?               06210000
         BNL   *+8                    BRANCH IF YES                     06220000
         ST    R3,8(,R1)              SET ACTUAL DATA LENGTH REMAINING  06230000
         ST    R4,12(,R1)             SET STARTING OFFSET IN BUFFER     06240000
         LA    R14,16(,R1)            ADDRESS OF RECEIVED DATA AREA     06250000
         LA    R15,128                MAX OF 128 BYTES                  06260000
         MVCL  R14,R2                 TRACE THE RECEIVED DATA           06270000
         LA    R4,128(,R4)            UPDATE DATA OFFSET                06280000
         LTR   R3,R3                  MORE DATA TO TRACE?               06290000
         BP    XTRCDATA               BRANCH IF YES                     06300000
NOXTRACE DS    0H                                                       06310000
                                                                        06320000
         L     R1,CMLPARM4        ADDRESS OF DATA_RECEIVED AREA         06330000
         MVC   0(4,R1),RETDATAR   SET DATA_RECEIVED VARIABLE            06340000
                                                                        06350000
         L     R1,CMLPARM5        ADDRESS OF RECEIVED_LENGTH AREA       06360000
         MVC   0(4,R1),RCVLENG    SET RECEIVED_LENGTH VARIABLE          06370000
                                                                        06380000
         L     R1,CMLPARM6        ADDRESS OF STATUS_RECEIVED AREA       06390000
         MVC   0(4,R1),RETSTAT    SET STATUS_RECEIVED VARIABLE          06400000
                                                                        06410000
         L     R1,CMLPARM7        ADDRESS OF RTS_RECEIVED AREA          06420000
         MVC   0(4,R1),RETRTSR    SET RTS_RECEIVED VARIABLE             06430000
                                                                        06440000
         L     R1,CMLPARM8        ADDRESS OF RETURN_CODE AREA           06450000
         MVC   0(4,R1),RETCODE    SET RETURN_CODE VARIABLE              06460000
                                                                        06470000
         SR    R15,R15            FUNCTION RETURN CODE = 0              06480000
         CEXIT RC=(R15),INDEP=YES RETURN                                06490000
                                                                        06500000
*---------------------------------------------------------------------- 06510000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 06520000
*---------------------------------------------------------------------- 06530000
                                                                        06540000
VTAMLOCK DS    0H                                                       06550000
                                                                        06560000
         TM    FLAG,FLAGLOCK        WAS THE LOCK ALREADY OBTAINED?      06570000
         BOR   R14                  RETURN IF YES                       06580000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             06590000
                                                                        06600000
         $SER  OBTAIN,                                                 +06610000
               VTAM                                                     06620000
                                                                        06630000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              06640000
         BNE   VTAMLOEX             BRANCH IF NOT                       06650000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         06660000
                                                                        06670000
VTAMLOEX DS    0H                                                       06680000
                                                                        06690000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               06700000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          06710000
         BR    R14                  RETURN                              06720000
                                                                        06730000
*---------------------------------------------------------------------- 06740000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                06750000
*---------------------------------------------------------------------- 06760000
                                                                        06770000
VTAMUNLK DS    0H                                                       06780000
                                                                        06790000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       06800000
         BNOR  R14                  BRANCH IF NOT                       06810000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             06820000
         BOR   R14                  DON'T RELEASE IF IT WAS             06830000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             06840000
                                                                        06850000
         $SER  RELEASE,                                                +06860000
               VTAM                                                     06870000
                                                                        06880000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  06890000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          06900000
         BR    R14                  RETURN                              06910000
                                                                        06920000
*---------------------------------------------------------------------- 06930000
* ERROR ROUTINES                                                        06940000
*---------------------------------------------------------------------- 06950000
                                                                        06960000
ERR$TASK DS    0H                                                       06970000
                                                                        06980000
         $ABEND ABE_VTDIAG,                                            +06990000
               SCOPE=PCB,                                              +07000000
               TITLE='$TASK FAILURE'                                    07010000
                                                                        07020000
*---------------------------------------------------------------------- 07030000
* LITERALS AND CONSTANTS                                                07040000
*---------------------------------------------------------------------- 07050000
                                                                        07060000
         LTORG ,                                                        07070000
                                                                        07080000
         PRINT NOGEN                                                    07090000
         ISTDBIND ,               VTAM BIND IMAGE                       07100000
         ISTRH ,                  VTAM SNA REQUEST HEADER               07110000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                07120000
         IKJTCB ,                 MVS TASK CONTROL BLOCK                07130000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         07140000
         ICVT  ,                  INTEGRATOR CVT                        07150000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   07160000
         ITASK ,                  INTEGRATOR TASK BLOCK                 07170000
         IPCB ,                   INTEGRATOR PROCESS BLOCK              07180000
         IACB ,                   INTEGRATOR VTAM ACB                   07190000
         ABCODES ,                INTEGRATOR $ABEND CODES               07200000
         EVCODES ,                INTEGRATOR EVENT CODES                07210000
         ISESS ,                  INTEGRATOR SESSION BLOCK              07220000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            07230000
         IRPL ,                   INTEGRATOR VTAM RPL                   07240000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          07250000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             07260000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             07270000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             07280000
         SBUF  DSECT=YES          INTEGRATOR SBUF  SERVICES             07290000
         END   ,                                                        07300000

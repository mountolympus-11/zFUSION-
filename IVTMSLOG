IVTMSLOG TITLE 'INTEGRATOR - ISESS LOGON PROCESSOR'                     00010000
                                                                        00020000
**<DOC-ON>************************************************************* 00030000
*                                                                       00040000
* ROUTINE: IVTMSLOG - ISESS LOGON PROCESSOR                             00050000
*                                                                       00060000
* DESCRIPTION: THIS ROUTINE IS CALLED BY IVTMSESS TO PROCESS THE        00070000
*              LOGON WORK ELEMENT.  THE ISESS BLOCK IS COMPLETED        00080000
*              WITH INFORMATION FROM THE LOGON CINIT.  OPNDST           00090000
*              IS ISSUED TO ACCEPT THE SESSION.                         00100000
*                                                                       00110000
* ON ENTRY:                                                             00120000
*                                                                       00130000
*    R15 = ENTRY POINT ADDRESS                                          00140000
*    R14 = RETURN      ADDRESS                                          00150000
*    R13 = SAVE AREA   ADDRESS                                          00160000
*    R11 = ICVT        ADDRESS                                          00170000
*    R10 = ITASK       ADDRESS                                          00180000
*    R09 = IVTAMCVT    ADDRESS                                          00190000
*    R08 = ISESS       ADDRESS                                          00200000
*    R07 = IACB        ADDRESS                                          00210000
*    R01 = IWEX2       ADDRESS                                          00220000
*                                                                       00230000
* ON EXIT:                                                              00240000
*                                                                       00250000
*    R15 = 0                                                            00260000
*    R00 = 0                                                            00270000
*    R01 = 0                                                            00280000
*                                                                       00290000
*    ALL OTHER REGISTERS ARE RESTORED.                                  00300000
*                                                                       00310000
**<DOC-OFF>************************************************************ 00320000
                                                                        00330000
         EJECT ,                                                        00340000
*********************************************************************** 00350000
*                                                                       00360000
* MAINTENANCE:                                                          00370000
*                                                                       00380000
*   08/01/93 RANDY WITEK                                                00390000
*   07/01/94 RANDY WITEK - LU6.2 SUPPORT                                00400000
*   05/22/95 RANDY WITEK - USE ER PROTOCOL FOR SYSTEMS CONNECTION       00410000
*                                                                       00420000
*********************************************************************** 00430000
                                                                        00440000
         EQUS  ,                  GENERAL EQUATES                       00450000
                                                                        00460000
RICVT    EQU   R11                                                      00470000
RITASK   EQU   R10                                                      00480000
RIVTAM   EQU   R9                                                       00490000
RISESS   EQU   R8                                                       00500000
RIACB    EQU   R7                                                       00510000
RIRPL    EQU   R6                                                       00520000
RIWE     EQU   R5                                                       00530000
RINIB    EQU   R4                                                       00540000
                                                                        00550000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00560000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00570000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00580000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00590000
         USING IACB,RIACB         ESTABLISH ADDRESSABILITY              00600000
         USING IRPL,RIRPL         ESTABLISH ADDRESSABILITY              00610000
         USING IWEVTAM,RIWE       ESTABLISH ADDRESSABILITY              00620000
         USING ISTDNIB,RINIB      ESTABLISH ADDRESSABILITY              00630000
         USING ISTDBIND,ISEBIND   ESTABLISH ADDRESSABILITY              00640000
                                                                        00650000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00660000
WRK256   DS    XL256              GENERAL WORKAREA                      00670000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00680000
                                                                        00690000
$SESSMFL $SESS MF=L,                                                   +00700000
               FIELDS=((VECTOR0D,WRK256,SUB0SAVE,256))                  00710000
                                                                        00720000
RETR15   DS    F                                                        00730000
RETR0    DS    F                                                        00740000
RETR1    DS    F                                                        00750000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00760000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00770000
                                                                        00780000
         $MSGDFT PREFIX=ICTPID,                                        +00790000
               COMPID='VTM',                                           +00800000
               TABLE=*#MSGS,                                           +00810000
               WORKA=0,                                                +00820000
               MF=(E,WRK256),                                          +00830000
               PRINT=NOGEN                                              00840000
                                                                        00850000
IVTMSLOG #ENTER BASE=R12,         ENTRY LINKAGE                        +00860000
               PREG=RIWE,                                              +00870000
               AMODE=31,                                               +00880000
               RMODE=ANY                                                00890000
                                                                        00900000
         L     RIACB,IWEX2ACB            ACB WHERE LOGON IS OCCURING    00910000
                                                                        00920000
*---------------------------------------------------------------------- 00930000
* CLEAR THE "STARTING" SYNCHRONIZATION FLAG                             00940000
*---------------------------------------------------------------------- 00950000
                                                                        00960000
         NI    ISEF4,255-ISEF4STR        STARTUP WORK ELEMENT PROCESSED 00970000
                                                                        00980000
*---------------------------------------------------------------------- 00990000
* ISSUE OPNDST/CLSDST TO ACCEPT/REJECT THE PENDING CINIT                01000000
*---------------------------------------------------------------------- 01010000
                                                                        01020000
*                                                                       01030000
* BUILD ISESS FIELDS FROM LOGON WORK ELEMENT CINIT DATA                 01040000
*---------------------------------------------------------------------- 01050000
                                                                        01060000
         MVC   ISEACB@(4),IWEX2ACB       SET ACB ADDRESS IN ISESS BLOCK 01070000
         MVC   ISECID(4),IWEX2CID        SET VTAM CID IN ISESS BLOCK    01080000
         MVC   ISERLUNM,IWEX2LU          SET PARTNER    LU NAME         01090000
         MVC   ISEILUNM,IACNAME          SET INTEGRATOR LU NAME         01100000
                                                                        01110000
         LA    RIRPL,IWEX2RPL            ADDRESS OF RPL COPY            01120000
         LA    R2,IWEX2RU                ADDRESS OF CINIT COPY          01130000
         LA    R2,10(,R2)                ADDR OF CINIT BIND IMAGE SIZE  01140000
         SR    R14,R14                   CLEAR FOR ICM                  01150000
         ICM   R14,B'0011',0(R2)         R14 HAS BIND IMAGE LENGTH      01160000
         LA    R2,2(,R2)                 R2 HAS ADDRESS OF BIND IMAGE   01170000
         MVC   ISTDBIND(L'ISEBIND),0(R2) SET BIND IMAGE IN ISESS        01180000
                                                                        01190000
         ICM   R1,15,IWEX2UDL            LENGTH OF USERDATA             01200000
         BZ    NOUDATA                   BRANCH IF NONE                 01210000
         ST    R1,ISEUDATL               SET LENGTH                     01220000
         ST    R14,WRK256                SAVE ACROSS $GETSTOR           01230000
                                                                        01240000
         $GETSTOR (R1),                                                +01250000
               LOC=ANY,                                                +01260000
               OWNER=(RITASK)            STORAGE FOR USERDATA           01270000
                                                                        01280000
         L     R14,WRK256                RESTORE AFTER $GETSTOR         01290000
         ST    R1,ISEUDAT@               SET ADDRESS                    01300000
         LR    R0,R1                     COPY-TO   ADDRESS              01310000
         L     R1,ISEUDATL               COPY-TO   LENGTH               01320000
         LA    R14,0(R14,R2)             R14 ADDRESS CINIT SLU NAME KEY 01330000
         SR    R15,R15                   CLEAR FOR IC                   01340000
         IC    R15,1(,R14)               LENGTH OF CINIT SLU NAME       01350000
         LA    R14,5(R15,R14)            R14 ADDRESSES USER DATA        01360000
         LR    R15,R1                    LENGTH OF USER DATA            01370000
         MVCL  R0,R14                    COPY USER DATA TO ISESS AREA   01380000
                                                                        01390000
NOUDATA  DS    0H                                                       01400000
                                                                        01410000
         ICM   R1,15,RPLAARLN            LENGTH OF CONTROL VECTORS      01420000
         BZ    NOCVEC                    BRANCH IF NONE                 01430000
         ST    R1,ISECVECL               SET LENGTH                     01440000
                                                                        01450000
         $GETSTOR (R1),                                                +01460000
               LOC=ANY,                                                +01470000
               OWNER=(RITASK)            STORAGE FOR USERDATA           01480000
                                                                        01490000
         ST    R1,ISECVEC@               SET ADDRESS                    01500000
         LR    R0,R1                     COPY-TO ADDRESS                01510000
         L     R1,ISECVECL               COPY-TO LENGTH                 01520000
         L     R14,RPLAAREA              ADDRESS OF CV'S IN COPY        01530000
         LR    R15,R1                    CONTROL VECTORS LENGTH         01540000
         MVCL  R0,R14                    COPY CONTROL VECTORS TO ISESS  01550000
                                                                        01560000
NOCVEC   DS    0H                                                       01570000
                                                                        01580000
*                                                                       01590000
* $SESS_EXTRACT CONTROL VECTOR 0D TO OBTAIN THE LOGMODE NAME            01600000
*---------------------------------------------------------------------- 01610000
                                                                        01620000
         $SESS $SESS_EXTRACT,                                          +01630000
               SESSION=ISETK,                                          +01640000
               FIELDS=((VECTOR0D,WRK256,SUB0SAVE,256)),                +01650000
               ERRET=ERR$SESS,                                         +01660000
               MF=(E,$SESSMFL)                                          01670000
                                                                        01680000
         L     R15,SUB0SAVE              CONTROL VECTOR LENGTH          01690000
         C     R15,=F'10'                AT LEAST 10 BYTES?             01700000
         BL    ENDVEC0D                  BRANCH IF NOT                  01710000
         MVC   ISELOGMD(8),WRK256+2      COPY LOGMODE NAME FROM VECTOR  01720000
                                                                        01730000
ENDVEC0D DS    0H                                                       01740000
                                                                        01750000
*                                                                       01760000
* OBTAIN RPL FOR OPNDST OPERATION                                       01770000
*---------------------------------------------------------------------- 01780000
                                                                        01790000
         $VTAM GETRPL,                                                 +01800000
               AREA=ISERPACT,                                          +01810000
               ERRET=ERR$VTAM,                                         +01820000
               MF=(E,MFE_LIST)           ACQUIRE AN IRPL                01830000
                                                                        01840000
         LR    RIRPL,R1                  ESTABLISH ADDRESSIBILITY       01850000
         ST    RISESS,IRPISESS           SET ISESS PTR                  01860000
         MVC   IRPARG,ISECID             SET CID COPY                   01870000
         MVC   IRPTOKEN,ISETK            SET TOKEN                      01880000
         LA    R1,OPNDSTER               COMPLETION ROUTINE             01890000
         ST    R1,IRPWTGOK               SET COMPLETION ADDRESS         01900000
         LA    R1,ISEWEQ                 ISESS WORK QUEUE               01910000
         ST    R1,IRP@WEQ                WILL RECEIVE THE RPL EXIT      01920000
                                                                        01930000
*                                                                       01940000
* OBTAIN NIB FOR OPNDST OPERATION                                       01950000
*---------------------------------------------------------------------- 01960000
                                                                        01970000
         $VTAM GETNIB,                                                 +01980000
               ERRET=ERR$VTAM,                                         +01990000
               MF=(E,MFE_LIST)           ACQUIRE AN INIB                02000000
                                                                        02010000
         LR    RINIB,R1                  ESTABLISH ADDRESSIBILITY       02020000
         ST    RINIB,IRPINIB             ANCHOR INIB IN IRPL            02030000
         ST    RISESS,NIBUSER            SESSION ASSOCIATION            02040000
         MVC   NIBCID,IWEX2CID           CID OF SESSION TO BE ACCEPTED  02050000
         MVC   NIBSYM,IWEX2LU            NAME OF SLU                    02060000
                                                                        02070000
*                                                                       02080000
* OVERRIDE THE LOGMODE FOR INTEGRATOR-TO-INTEGRATOR COMMUNICATIONS      02090000
*---------------------------------------------------------------------- 02100000
                                                                        02110000
         ICM   R1,15,ISEUDAT@            IS THERE USERDATA?             02120000
         BNP   NOINTINT                  BRANCH IF NOT                  02130000
         ICM   R2,15,ISEUDATL            IS THERE USERDATA?             02140000
         BNP   NOINTINT                  BRANCH IF NOT                  02150000
         C     R2,=F'8'                  AT LEAST ROOM FOR THE DRIVER?  02160000
         BL    NOINTINT                  BRANCH IF NOT                  02170000
         CLC   0(8,R1),=CL8'ISYSDRVR'    IS THIS AN INT-TO-INT SESSION? 02180000
         BNE   NOINTINT                  BRANCH IF NOT                  02190000
         MVC   ISEBIND(L'ISEBIND),=X'0103039191204000008787000000000000+02200000
               000000000000000000'                                      02210000
         LA    R1,ISEBIND                ADDRESS OF THE BIND IMAGE      02220000
         ST    R1,NIBNDAR                SET THE BIND AREA ADDRESS      02230000
                                                                        02240000
NOINTINT DS    0H                                                       02250000
                                                                        02260000
*                                                                       02270000
* CREATE BIND IMAGE AND USER DATA FOR LU6.2 BIND                        02280000
*---------------------------------------------------------------------- 02290000
                                                                        02300000
         CLC   BINLUP(2),=X'0602'        LU TYPE 6.2?                   02310000
         BNE   NOT62BND                  BRANCH IF NOT                  02320000
         L     R1,=F'-1'                 SHOW ENTRY IS FOR CINIT        02330000
         L     R15,IL6@SBND              CALL THE LU6.2 EXTENSION       02340000
         BASR  R14,R15                   LINK TO MODULE                 02350000
         LTR   R15,R15                   CONTINUE WITH SETUP?           02360000
         BNZ   REJECT                    BRANCH IF NOT                  02370000
                                                                        02380000
NOT62BND DS    0H                                                       02390000
                                                                        02400000
*                                                                       02410000
* INITIALIZE ISESS WITH SNA PARAMETERS FROM BIND IMAGE                  02420000
*---------------------------------------------------------------------- 02430000
                                                                        02440000
         L     R15,IVT@NBIA              ENTRY OF BIND IMAGE ANALYZER   02450000
         LR    R1,RISESS                 PASS THE ISESS ADDRESS         02460000
         BASR  R14,R15                   CALL THE ROUTINE               02470000
         LTR   R15,R15                   ARE THE SNA PARAMETERS OK?     02480000
         BNZ   REJECT                    BRANCH IF NOT                  02490000
                                                                        02500000
*                                                                       02510000
* ISSUE OPNDST TO ACCEPT SESSION                                        02520000
*---------------------------------------------------------------------- 02530000
                                                                        02540000
         OPNDST RPL=(RIRPL),                                           +02550000
               ACB=(RIACB),                                            +02560000
               NIB=(RINIB),                                            +02570000
               OPTCD=(ACCEPT,SPEC,ASY) ACCEPT THE PENDING CINIT         02580000
                                                                        02590000
         B     CHECKPH1                                                 02600000
                                                                        02610000
*                                                                       02620000
* ISSUE CLSDST TO REJECT THE PENDING CINIT                              02630000
*---------------------------------------------------------------------- 02640000
                                                                        02650000
REJECT   DS    0H                                                       02660000
                                                                        02670000
         LA    R1,CLSDSTER               COMPLETION ROUTINE             02680000
         ST    R1,IRPWTGOK               SET COMPLETION ADDRESS         02690000
                                                                        02700000
         CLSDST RPL=(RIRPL),                                           +02710000
               ACB=(RIACB),                                            +02720000
               NIB=(RINIB),                                            +02730000
               OPTCD=(RELEASE,ASY)       REJECT THE PENDING CINIT       02740000
                                                                        02750000
*                                                                       02760000
* SET VTAM RETURN REGISTERS AND DO PHASE1 CHECK                         02770000
*---------------------------------------------------------------------- 02780000
                                                                        02790000
CHECKPH1 DS    0H                                                       02800000
                                                                        02810000
         STM   R15,R0,IRPR15             SAVE VTAM RETURN REGISTERS     02820000
                                                                        02830000
         $VTAM CHECKPH1,                                               +02840000
               AREA=(RIRPL),             CHECK REQUEST ACCEPTANCE      +02850000
               MF=(E,MFE_LIST)                                          02860000
                                                                        02870000
         B     RETURN                    DONE UNTIL OPNDST IS COMPLETE  02880000
                                                                        02890000
*---------------------------------------------------------------------- 02900000
* THIS IS THE RPL COMPLETION ROUTINE FOR THE OPNDST                     02910000
*                                                                       02920000
* ON ENTRY:                                                             02930000
*                                                                       02940000
*    R15 = ENTRY POINT ADDRESS                                          02950000
*    R14 = RETURN ADDRESS                                               02960000
*    R13 = AVAILABLE SAVE AREA                                          02970000
*    R11 = ICVT ADDRESS                                                 02980000
*    R10 = ITASK ADDRESS                                                02990000
*    R09 = IVTAMCVT ADDRESS                                             03000000
*    R01 = ADDRESS OF COMPLETED IRPL                                    03010000
*    R00 = RECOVERY ACTION RETURN CODE                                  03020000
*---------------------------------------------------------------------- 03030000
                                                                        03040000
         DROP  R12                                                      03050000
                                                                        03060000
OPNDSTER #ENTER BASE=R12,                                              +03070000
               PREG=(RIRPL,R2),          R1-->RIRPL, R0-->R2           +03080000
               EP=YES                    ENTRY POINT                    03090000
                                                                        03100000
         L     RIACB,RPLDACB             ACB WHERE LOGON IS OCCURING    03110000
         L     RINIB,IRPINIB             INIB ADDRESS                   03120000
         L     RISESS,IRPISESS           ISESS ADDRESS                  03130000
                                                                        03140000
*                                                                       03150000
* IF OPNDST WAS NOT SUCCESSFUL DUMP THE SESSION                         03160000
*---------------------------------------------------------------------- 03170000
                                                                        03180000
         TM    NIBFLG1,NIBCON            IS SESSION STARTED?            03190000
         BO    SESSTART                  BRANCH IF YES                  03200000
         TM    NIBFLG1,NIBNACLQ          WAS PENDING CINIT CANCELED?    03210000
         BNO   REJECT                    BRANCH IF NOT                  03220000
         BAS   R14,RETBLKS               RELEASE THE NIB AND RPL        03230000
         B     ENDSESS                   GO END THE ISESS PROCESS       03240000
                                                                        03250000
*                                                                       03260000
* IF A NEGOTIABLE BIND RESPONSE WAS RECEIVED, UPDATE THE ISESS FIELDS   03270000
*---------------------------------------------------------------------- 03280000
                                                                        03290000
SESSTART DS    0H                                                       03300000
                                                                        03310000
         OI    ISEF1,ISEF1ACT            SHOW SESS ACTIVATION COMPLETE  03320000
                                                                        03330000
         ICM   R1,15,RPLARCLN            LENGTH OF BIND RESPONSE        03340000
         BNP   SESSRET                   BRANCH IF NOT GOOD LENGTH      03350000
         ICM   R2,15,RPLAAREA            ADDRESS OF RESPONSE AREA       03360000
         BNP   SESSRET                   BRANCH IF NO RESPONSE AREA     03370000
         CLI   1(R2),X'00'               NEGOTIABLE BIND RESPONSE?      03380000
         BNE   SESSRET                   BRANCH IF NOT                  03390000
         C     R1,=A(L'ISEBIND+1)        BIG ENOUGH TO PROCESS?         03400000
         BL    SESSRET                   BRANCH IF NOT                  03410000
                                                                        03420000
         MVC   ISEBIND(L'ISEBIND),1(R2)  SET NEW BIND IMAGE FROM RESP.  03430000
                                                                        03440000
         L     R15,ISEIVUSR       ASSOCIATED IVUSER BLOCK               03450000
X        USING IVUSER,R15                                               03460000
                                                                        03470000
         TM    BINFLG1,BINCLSS    ACCEPT SECURITY INFO SPECIFIED?       03480000
         BNO   ENDCCLSS           BRANCH IF NOT                         03490000
         OI    X.IVUF3,IVUF3SIA   PARTNER ACCEPTS SECURITY INFO         03500000
ENDCCLSS DS    0H                                                       03510000
                                                                        03520000
         TM    BINFLG1,BINAVFS    ACCEPT ALREADY VERIFIED SPECIFIED?    03530000
         BNO   ENDCAVFS           BRANCH IF NOT                         03540000
         OI    X.IVUF3,IVUF3AVA   PARTNER ACCEPTS ALREADY VERIFIED      03550000
ENDCAVFS DS    0H                                                       03560000
                                                                        03570000
         TM    BINFLG1,BINPV      PERSISTENT VERIFICATION SPECIFIED?    03580000
         BNO   ENDCPV             BRANCH IF NOT                         03590000
         OI    X.IVUF3,IVUF3PVA   PARTNER USES PERSISTENT VERIFICATION  03600000
ENDCPV   DS    0H                                                       03610000
                                                                        03620000
         DROP  X                                                        03630000
                                                                        03640000
         L     R15,IVT@NBIA              ENTRY OF BIND IMAGE ANALYZER   03650000
         LR    R1,RISESS                 PASS THE ISESS ADDRESS         03660000
         BASR  R14,R15                   CALL THE ROUTINE               03670000
         LTR   R15,R15                   ARE THE SNA PARAMETERS OK?     03680000
         BZ    GET62FQN                  BRANCH IF YES                  03690000
         BAS   R14,RETBLKS               RELEASE THE BLOCKS             03700000
         B     ENDSESS                   AND KILL THE SESSION           03710000
                                                                        03720000
*                                                                       03730000
* EXTRACT FQ PARTNER LU NAME FROM NEGOTIABLE LU6.2 BIND RESPONSE        03740000
*---------------------------------------------------------------------- 03750000
                                                                        03760000
GET62FQN DS    0H                                                       03770000
                                                                        03780000
         CLC   BINLUP(2),=X'0602'        LU TYPE 6.2?                   03790000
         BNE   SESSRET                   BRANCH IF NOT                  03800000
                                                                        03810000
         L     R3,RPLAAREA               ADDRESS OF RESPONSE AREA       03820000
         LA    R3,26(,R3)                ADDRESS OF BIND RSP CRYPTO     03830000
         L     R2,RPLARCLN               LENGTH OF BIND RESPONSE        03840000
         S     R2,=F'26'                 MINUS THE FIXED PORTION        03850000
         BNP   SESSRET                   BRANCH IF NO POSSIBLE FQ NM    03860000
                                                                        03870000
         SR    R1,R1                     CLEAR FOR IC                   03880000
         IC    R1,0(,R3)                 CRYPTO BYTE                    03890000
         N     R1,=X'0000000F'           ISOLATE ADDITIONAL LENGTH      03900000
         LA    R3,1(R1,R3)               SKIP CRYPTO FIELDS             03910000
         LA    R1,1(,R1)                 AMOUNT SKIPPED OVER            03920000
         SR    R2,R1                     LENGTH OF BIND RSP REMAINING   03930000
         BNP   SESSRET                   BRANCH IF BIND RSP EXHAUSTED   03940000
                                                                        03950000
         SR    R1,R1                     CLEAR FOR IC                   03960000
         IC    R1,0(,R3)                 LENGTH OF PLUNAME FIELD        03970000
         LA    R3,1(R1,R3)               SKIP PLUNAME FIELD             03980000
         LA    R1,1(,R1)                 AMOUNT SKIPPED OVER            03990000
         SR    R2,R1                     LENGTH OF BIND RSP REMAINING   04000000
         BNP   SESSRET                   BRANCH IF BIND RSP EXHAUSTED   04010000
                                                                        04020000
         SR    R1,R1                     CLEAR FOR IC                   04030000
         IC    R1,0(,R3)                 LENGTH OF USERDATA FIELD       04040000
         LTR   R1,R1                     IS THERE USERDATA?             04050000
         BNP   SESSRET                   BRANCH IF NOT                  04060000
         LA    R1,1(,R1)                 TOTAL LENGTH OF USERDATA FIELD 04070000
         SR    R2,R1                     LENGTH OF BIND RSP REMAINING   04080000
         BM    SESSRET                   BRANCH IF NOT ALL PRESENT      04090000
                                                                        04100000
         CLI   1(R3),X'00'        STRUCTURED SUBFIELDS?                 04110000
         BNE   SESSRET            BRANCH IF NOT                         04120000
         LA    R2,2(,R3)          ADDRESS OF FIRST SUBFIELD             04130000
         BCTR  R1,0               LENGTH REMAINING                      04140000
         BCTR  R1,0               LENGTH REMAINING                      04150000
                                                                        04160000
UDATLOOP DS    0H                                                       04170000
                                                                        04180000
         LTR   R1,R1              ANY SUBFIELDS REMAINING?              04190000
         BNP   SESSRET            BRANCH IF NOT                         04200000
         SR    R0,R0              CLEAR FOR INSERT                      04210000
         ICM   R0,B'0001',0(R2)   LENGTH OF CURRENT SUBFIELD            04220000
         BNP   SESSRET            BRANCH IF SOMETHING'S FUNNY           04230000
         SR    R1,R0              LENGTH REMAINING AFTER CURRENT        04240000
         BCTR  R1,0               LENGTH REMAINING AFTER CURRENT        04250000
         LR    R14,R2             ADDRESS OF CURRENT SUBFIELD           04260000
         AR    R2,R0              ADDRESS OF NEXT VECTOR                04270000
         LA    R2,1(R2)           ADDRESS OF NEXT VECTOR                04280000
         CLI   1(R14),X'05'       IS THIS THE FQ SLU NAME?              04290000
         BNE   UDATLOOP           BRANCH IF NOT                         04300000
                                                                        04310000
         LR    R1,R0              LENGTH OF FQ NAME                     04320000
         BCTR  R1,0               LENGTH OF FQ NAME                     04330000
         LTR   R1,R1              IS THERE A NAME?                      04340000
         BNP   SESSRET            BRANCH IF NOT                         04350000
         ICM   R1,B'1000',=C' '   BLANK PAD THE NAME                    04360000
         LA    R0,2(,R14)         ADDRESS OF THE FQ NAME                04370000
         L     R15,ISEIVUSR       ASSOCIATED IVUSER BLOCK               04380000
X        USING IVUSER,R15                                               04390000
         STC   R1,X.IVUFQLNL      SAVE FQ NAME LENGTH                   04400000
         LA    R14,X.IVUFQLN      AREA TO SAVE FQ NAME                  04410000
         LA    R15,L'IVUFQLN      LENGTH OF FQ NAME AREA                04420000
         DROP  X                                                        04430000
         MVCL  R14,R0                                                   04440000
                                                                        04450000
*                                                                       04460000
* RELEASE THE RPL AND NIB                                               04470000
*---------------------------------------------------------------------- 04480000
                                                                        04490000
SESSRET  DS    0H                                                       04500000
                                                                        04510000
         BAS   R14,RETBLKS               RELEASE THE BLOCKS             04520000
                                                                        04530000
*                                                                       04540000
* IF SESSION TERMINATION STARTED WHILE THE RPL WAS ACTIVE, TRY AGAIN    04550000
*---------------------------------------------------------------------- 04560000
                                                                        04570000
         TM    ISEF1,ISEF1TRM            TERMINATION STARTED?           04580000
         BNO   SESSDIN                   BRANCH IF NOT                  04590000
         NI    ISEF1,255-ISEF1TRM        RESET THE TERMINATION FLAG     04600000
         B     ENDSESS                   AND QUEUE ANOTHER ENDSESS      04610000
                                                                        04620000
*                                                                       04630000
* CALL THE DRIVER INITIALIZATION ROUTINE                                04640000
*---------------------------------------------------------------------- 04650000
                                                                        04660000
SESSDIN  DS    0H                                                       04670000
                                                                        04680000
         L     R15,IVT@SDIN              ENTRY ADDRESS                  04690000
         BASR  R14,R15                   CALL DRIVER INITIALIZATION     04700000
         B     RETURN                    ALL DONE                       04710000
                                                                        04720000
*---------------------------------------------------------------------- 04730000
* THIS IS THE RPL COMPLETION ROUTINE FOR THE CLSDST                     04740000
*                                                                       04750000
* ON ENTRY:                                                             04760000
*                                                                       04770000
*    R15 = ENTRY POINT ADDRESS                                          04780000
*    R14 = RETURN ADDRESS                                               04790000
*    R13 = AVAILABLE SAVE AREA                                          04800000
*    R11 = ICVT ADDRESS                                                 04810000
*    R10 = ITASK ADDRESS                                                04820000
*    R09 = IVTAMCVT ADDRESS                                             04830000
*    R01 = ADDRESS OF COMPLETED IRPL                                    04840000
*    R00 = RECOVERY ACTION RETURN CODE                                  04850000
*---------------------------------------------------------------------- 04860000
                                                                        04870000
         DROP  R12                                                      04880000
                                                                        04890000
CLSDSTER #ENTER BASE=R12,         ENTRY LINKAGE                        +04900000
               PREG=(RIRPL,R2),   R1-->RIRPL, R0-->R2                  +04910000
               EP=YES             THIS IS AN ENTRY POINT                04920000
                                                                        04930000
         L     RIACB,RPLDACB      ACB WHERE LOGON IS OCCURING           04940000
         L     RINIB,IRPINIB      INIB ADDRESS                          04950000
         L     RISESS,IRPISESS    ISESS ADDRESS                         04960000
                                                                        04970000
*                                                                       04980000
* RELEASE THE INIB AND IRPL BLOCK                                       04990000
*---------------------------------------------------------------------- 05000000
                                                                        05010000
         BAS   R14,RETBLKS        RETURN TO BLOCKS                      05020000
                                                                        05030000
*                                                                       05040000
* QUEUE AN END SESSION WORK ELEMENT TO THE ISESS PROCESS                05050000
*---------------------------------------------------------------------- 05060000
                                                                        05070000
ENDSESS  DS    0H                                                       05080000
                                                                        05090000
         $VTAMWE L'IWEXH,         LENGTH                               +05100000
               IWECENDS           CODE                                  05110000
                                                                        05120000
         LA    R0,ISEWEQ          QUEUE ADDRESS                         05130000
         BAS   R14,QWE            QUEUE THE WORK ELEMENT                05140000
         B     RETURN                                                   05150000
                                                                        05160000
*---------------------------------------------------------------------- 05170000
* RETURN TO CALLER                                                      05180000
*---------------------------------------------------------------------- 05190000
                                                                        05200000
RETURN   DS    0H                                                       05210000
                                                                        05220000
         LM    R15,R1,RETREGS     LOAD RETURN VALUES                    05230000
                                                                        05240000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    05250000
                                                                        05260000
*---------------------------------------------------------------------- 05270000
* SUBROUTINE: RETBLKS TO RETURN THE RPL AND NIB                         05280000
*---------------------------------------------------------------------- 05290000
                                                                        05300000
RETBLKS  DS    0H                                                       05310000
                                                                        05320000
         STM   R14,R2,SUB0SAVE    SAVE REGISTERS                        05330000
                                                                        05340000
         ICM   R2,15,IRPIBNDA     IS THERE A BIND AREA ALLOCATED?       05350000
         BZ    RETINIB            BRANCH IF NOT                         05360000
                                                                        05370000
         $RETSTOR (R2),                                                +05380000
               OWNER=(RITASK)     RELEASE THE BIND AREA                 05390000
                                                                        05400000
RETINIB  DS    0H                                                       05410000
                                                                        05420000
         $VTAM RETNIB,                                                 +05430000
               AREA=(RINIB),                                           +05440000
               ERRET=ERR$VTAM,                                         +05450000
               MF=(E,MFE_LIST)    RELEASE THE NIB                       05460000
                                                                        05470000
         $VTAM RETRPL,                                                 +05480000
               AREA=(RIRPL),                                           +05490000
               ERRET=ERR$VTAM,                                         +05500000
               MF=(E,MFE_LIST)    RELEASE THE NIB                       05510000
                                                                        05520000
         LM    R14,R2,SUB0SAVE    RESTORE REGISTERS                     05530000
         BR    R14                RETURN TO CALLER                      05540000
                                                                        05550000
*---------------------------------------------------------------------- 05560000
* SUBROUTINE QWE - QUEUE A WORK ELEMENT TO A GIVEN WORK QUEUE           05570000
*                                                                       05580000
* ENTRY            R14 = RETURN ADDRESS                                 05590000
*                  R1  = WORK ELEMENT ADDRESS                           05600000
*                  R0  = QUEUE ADDRESS                                  05610000
*                                                                       05620000
* RETURNS          R15 = 0 --> QUEUEING WAS SUCCESSFUL                  05630000
*                      = 4 --> QUEUEING FAILED, WORK ELEMENT RELEASED   05640000
*---------------------------------------------------------------------- 05650000
                                                                        05660000
QWE      DS    0H                                                       05670000
                                                                        05680000
         STM   R14,R4,SUB0SAVE    SAVE REGISTERS                        05690000
         LR    R3,R0              SAVE QUEUE ADDRESS                    05700000
         LR    R4,R1              SAVE WORK ELEMENT ADDRESS             05710000
                                                                        05720000
         $VTAMQ (R4),             WORK ELEMENT                         +05730000
               (R3)               QUEUE                                 05740000
                                                                        05750000
         L     R14,SUB0SAVE       RESTORE REGISTERS                     05760000
         LM    R0,R4,SUB0SAVE+8   RESTORE REGISTERS                     05770000
         BR    R14                AND RETURN TO CALLER W/R15            05780000
                                                                        05790000
*---------------------------------------------------------------------- 05800000
* ERROR ROUTINES                                                        05810000
*---------------------------------------------------------------------- 05820000
                                                                        05830000
ERR$VTAM DS    0H                                                       05840000
                                                                        05850000
         $ABEND ABE_VTDIAG,                                            +05860000
               SCOPE=PCB,                                              +05870000
               TITLE='$VTAM FAILURE'                                    05880000
                                                                        05890000
ERR$SESS DS    0H                                                       05900000
                                                                        05910000
         $ABEND ABE_VTDIAG,                                            +05920000
               SCOPE=PCB,                                              +05930000
               TITLE='$SESS FAILURE'                                    05940000
                                                                        05950000
*---------------------------------------------------------------------- 05960000
*  CONSTANTS AND LITERALS                                               05970000
*---------------------------------------------------------------------- 05980000
                                                                        05990000
         LTORG ,                                                        06000000
         PRINT NOGEN                                                    06010000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                06020000
         ISTDBIND ,               VTAM BIND IMAGE                       06030000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         06040000
         ICVT  ,                  INTEGRATOR CVT                        06050000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   06060000
         IRPL ,                   INTEGRATOR VTAM RPL+                  06070000
         IACB ,                   INTEGRATOR VTAM ACB+                  06080000
         INIB ,                   INTEGRATOR VTAM NIB+                  06090000
         ISESS ,                  INTEGRATOR SESSION BLOCK              06100000
         ISQE ,                   INTEGRATOR SESS INIT QUEUE ELEMENT    06110000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            06120000
         ITASK ,                  INTEGRATOR TASK BLOCK                 06130000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          06140000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       06150000
         EVCODES ,                INTEGRATOR EVENT CODES                06160000
         ABCODES ,                INTEGRATOR $ABEND CODES               06170000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     06180000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        06190000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             06200000
         $PROC DSECT=YES          INTEGRATOR $PROC SERVICES             06210000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             06220000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             06230000
         IFGEXLST ,               VTAM EXIT LIST                        06240000
         END   ,                                                        06250000

IRUNTSSA TITLE '- CONSTRUCT TABLE-SELECT SEARCH ARGUMENT'               00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE:  IRUNTSSA - Construct table-select search argument           00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine accepts the $NAVPARM and a TVBR vector                00080000
*    associated with the current screen(set) and builds a table         00090000
*    services search argument in TBSARG1 (level 1) format that          00100000
*    can be used to identify an element selected from a                 00110000
*    repeating group.                                                   00120000
*                                                                       00130000
*    A copy of the search argument anchored in                          00140000
*    $NAVPARM.IXRFSARG (table services row add filter) is               00150000
*    recursively copied into STGMGR ITASK owned storage,                00160000
*    marking all predicates that refer to columns not resolved          00170000
*    in the current screen(set) as "catagorically true".  This          00180000
*    allows table selection logic to later formulate partial            00190000
*    rows and test for the appropriate table selection entry(s)         00200000
*    by issuing provisional TBADD requests.  The completed              00210000
*    filter SARG is returned in IXRTSSA (table select search            00220000
*    argument).                                                         00230000
*                                                                       00240000
* REQUIREMENTS:                                                         00250000
*                                                                       00260000
*    The input $NAVPARM must contain a TVBR vector representing         00270000
*    both scalar and repeating variables on the target screen           00280000
*    (set).  Without repeating groups, the table selection              00290000
*    metaphor has no meaning.  (*IXR@TVBR or RC04).                     00300000
*                                                                       00310000
*    The input $NAVPARM is also expected to contain a filter            00320000
*    SARG that defines result set row admission or selection            00330000
*    criteria.  A subset of that SARG is generated by this              00340000
*    routine.  If the filter SARG is omitted (IXRFSARG = 0) or          00350000
*    if the subset SARG is catagorically true (possible) or             00360000
*    false (error), the table selection operation is                    00370000
*    meaningless and is failed (RC08).                                  00380000
*                                                                       00390000
*    All completion codes may be accompanied by a table select          00400000
*    filter SARG returned in IXRTSSA.  The caller is responsible        00410000
*    for invoking IRUNTSSD to delete the SARG at the end of             00420000
*    screen (set) processing.                                           00430000
*                                                                       00440000
*                                                                       00450000
* NOTES:                                                                00460000
*                                                                       00470000
*    It would be possible to accomplish the same result as that         00480000
*    performed in this routine by updating the source SARG in           00490000
*    place, and then restoring it to its original state at the          00500000
*    end of table select processing. The TSSA approach was              00510000
*    chosen instead because it allows for SARG subtrees to be           00520000
*    dropped entirely (rather than blindly copied).  It also            00530000
*    allows for future optimizations that might change the              00540000
*    shape of the SARG tree.                                            00550000
*                                                                       00560000
*                                                                       00570000
* FUTURES:                                                              00580000
*                                                                       00590000
*    Consider creating a dedicated STGMGR storage pool to allow         00600000
*    the entire search argument to be deleted with a single             00610000
*    STGTERM call.                                                      00620000
*                                                                       00630000
*                                                                       00640000
* LINKAGE:                                                              00650000
*                                                                       00660000
*    Standard linkage upon entry                                        00670000
*    Internally recursive using BAKR linkage                            00680000
*                                                                       00690000
*                                                                       00700000
* ON ENTRY:                                                             00710000
*                                                                       00720000
*    R1  contains the address of $NAVPARM (see REQUIREMENTS)            00730000
*                                                                       00740000
*                                                                       00750000
* ON EXIT:                                                              00760000
*                                                                       00770000
*    R15 contains one of the following return codes                     00780000
*                                                                       00790000
*        RC00 - table select subset SARG created and anchored           00800000
*               in IXRTSSA                                              00810000
*                                                                       00820000
*               R1 contains the addr of the subset SARG                 00830000
*                                                                       00840000
*               R0 contains a code indicating whether or not            00850000
*                  the SARG is catagorically true, false, or            00860000
*                  undetermined as follows:                             00870000
*                                                                       00880000
*                  00 - truth value not determined                      00890000
*                  01 - SARG is categorically true                      00900000
*                  FF - SARG is categorically false                     00910000
*                                                                       00920000
*        RC04 - no repeating variables defined for the                  00930000
*               screen(set)                                             00940000
*                                                                       00950000
*        RC08 - no SARG present on which to base the table              00960000
*               select operation                                        00970000
*                                                                       00980000
*        RC12 - residual table select subset SARG found                 00990000
*               (program error)                                         01000000
*                                                                       01010000
*        RC16 - search argument error detected during SARG              01020000
*               optimization                                            01030000
*                                                                       01040000
*               R0 - TBSAOPT service return code as reason code         01050000
*               R1 - TBSAOPT service reason code as info code           01060000
*                                                                       01070000
*        RC20 - reserved                                                01080000
*                                                                       01090000
*        RC24 - storage availability / management failure               01100000
*                                                                       01110000
*               R0 - storage service completion code                    01120000
*                                                                       01130000
**<DOC-OFF>****************************************************         01140000
                                                                        01150000
         EJECT                                                          01160000
***************************************************************         01170000
*                                                                       01180000
* MAINTENANCE:                                                          01190000
*                                                                       01200000
*    06/14/95  R. Turgeon                                               01210000
*              Initial version                                          01220000
*                                                                       01230000
***************************************************************         01240000
                                                                        01250000
         EJECT                                                          01260000
WORKAREA #WORK ,                                                        01270000
                                                                        01280000
COLNAME  DS    CL(L'SCOLNAME)     COL NAME EXTRACTED FROM SARG NODE     01290000
                                                                        01300000
         #ENDWORK ,                                                     01310000
                                                                        01320000
         EJECT                                                          01330000
         $NAVPARM ,               NAVIGATION PARAMETERS                 01340000
                                                                        01350000
         EJECT                                                          01360000
         TVBRVEC ,                TRAVERSE VARS BY REGION               01370000
                                                                        01380000
         EJECT                                                          01390000
         TBBNODES ,               TABLE SERVICES SARG FORMATS           01400000
                                                                        01410000
         EJECT                                                          01420000
         ICATALOG COLUMNS         SYSCOLUMNS FORMAT                     01430000
                                                                        01440000
         EJECT                                                          01450000
         TBSERVIS SAOPT           SEARCH ARGUMENT OPTIMIZER             01460000
                                                                        01470000
         EJECT                                                          01480000
         EQUS  ,                                                        01490000
                                                                        01500000
         EJECT                                                          01510000
IRUNTSSA #ENTER PREG=(R8)                                               01520000
                                                                        01530000
         USING ITASK,R10          STDENV                                01540000
         L     R9,TSKPCBC         PROCESS MODE                          01550000
         USING IPCB,R9            LIFE OF FUNCTION ADDRESSABILITY       01560000
                                                                        01570000
         EJECT                                                          01580000
***************************************************************         01590000
*                                                                       01600000
*   Accept passed parameters, perform cursory validations,              01610000
*   and establish life-of-function addressability to major              01620000
*   control blocks                                                      01630000
*                                                                       01640000
***************************************************************         01650000
                                                                        01660000
         USING $NAVPARM,R8        NAVIGATION PARAMETERS                 01670000
                                                                        01680000
         ICM   R7,15,IXR@TVBR     TVBR VECTOR                           01690000
         BZ    WRN_TVBR           NO REPEATING REGIONS IF NOT           01700000
         USING TVBRVEC,R7         REPEATING VARIABLE TRAVERSAL AID      01710000
                                                                        01720000
         ICM   R0,15,IXRTSSA      RESIDUAL SUBSET SARG PRESENT?         01730000
         BNZ   ERR_TSSA           ERROR IF SO                           01740000
                                                                        01750000
         ICM   R6,15,IXRFSARG     ENTRY SELECTION, RESULT SET SARG      01760000
         USING TBSARG1,R6         SOURCE SARG                           01770000
         BZ    ERR_SARG           IDENTIFICATION IMPOSSIBLE IF OMITTED  01780000
                                                                        01790000
***************************************************************         01800000
*                                                                       01810000
*   Copy the source search argument, pruning where possible             01820000
*                                                                       01830000
***************************************************************         01840000
                                                                        01850000
         ICM   R1,15,TBS1NODE     R1 <== SARG ORIGIN                    01860000
         BZ    ERR_SARG           NO SARG                               01870000
         BAS   R14,TSCOPY         COPY AND PRUNE THE SARG               01880000
         LTR   R15,R15            COMPLETED WITHOUT ERROR?              01890000
         BNZ   ERR_STG            ATTRIBUTE TO STORAGE ERROR            01900000
                                                                        01910000
***************************************************************         01920000
*                                                                       01930000
*   Construct SARG header and anchor for return                         01940000
*                                                                       01950000
***************************************************************         01960000
                                                                        01970000
         LR    R2,R1              SUBSET SARG ORIGIN                    01980000
                                                                        01990000
         STGGET TBS1LEN,QH=TSKSTG                                       02000000
         BNZ   ERR_STG            STORAGE FAILURE                       02010000
                                                                        02020000
*--------------------------------------------------------------         02030000
*   Clone the source SARG header and anchor subset SARG                 02040000
*--------------------------------------------------------------         02050000
                                                                        02060000
H2       USING TBSARG1,R1         SUBSET SARG HEADER                    02070000
         MVC   0(TBS1LEN,R1),TBSARG1                                    02080000
         ST    R2,H2.TBS1NODE     ANCHOR RETURNED SUBSET SARG TREE      02090000
         ST    R1,IXRTSSA         POST IN TVBR                          02100000
                                                                        02110000
*--------------------------------------------------------------         02120000
*   Search argument optimization / truth value analysis                 02130000
*--------------------------------------------------------------         02140000
                                                                        02150000
         LR    R0,R1              SEARCH ARGUMENT ORIGIN                02160000
                                                                        02170000
         TBSAOPT (R0),MF=(E,MFE_LIST)   SARG OPTIMIZATION               02180000
                                                                        02190000
         LTR   R15,R15            VALID SARG /TRUTH VALUE (R0) BACK?    02200000
         BNZ   ERR_OPT            ERROR IF NOT                          02210000
         DROP  H2                 SUBSET SARG HEADER                    02220000
                                                                        02230000
***************************************************************         02240000
*                                                                       02250000
*   Return completion status and subset SARG to caller                  02260000
*                                                                       02270000
***************************************************************         02280000
                                                                        02290000
NORMRET  DS    0H                 R0 <== TRUTH VALUE CODE OR ZERO       02300000
         L     R1,IXRTSSA         R1 <== SUBSET SARG                    02310000
         LA    R15,RC00           INDICATE SUCCESS                      02320000
         B     RETURN             COMPLETE                              02330000
                                                                        02340000
WRN_TVBR DS    0H                 NO REPEATING REGIONS / VARIABLES      02350000
         LA    R15,RC04           WARNING                               02360000
         SR    R0,R0              REASON CODE NOT DEFINED               02370000
         SR    R1,R1              INFO CODE NOT DEFINED                 02380000
         B     RETURN                                                   02390000
                                                                        02400000
ERR_SARG DS    0H                 NO SOURCE SARG PROVIDED OR            02410000
         LA    R15,RC08           NO SUBSET SARG PRODUCED               02420000
         SR    R0,R0              REASON CODE NOT DEFINED               02430000
         SR    R1,R1              INFO CODE NOT DEFINED                 02440000
         B     RETURN                                                   02450000
                                                                        02460000
ERR_TSSA DS    0H                 RESIDUAL SUBSET SARG                  02470000
         LA    R15,RC12           STG FREE IS CALLERS RESPONSIBILITY    02480000
         SR    R0,R0              REASON CODE NOT DEFINED               02490000
         SR    R1,R1              INFO CODE NOT DEFINED                 02500000
         B     RETURN                                                   02510000
                                                                        02520000
ERR_OPT  DS    0H                 SEARCH ARG ERROR DETECTED DURING      02530000
         LR    R1,R0              SERVICE RTN RSNCODE AS INFCODE        02540000
         LR    R0,R15             SERVICE RTN RETCODE AS RSNCODE        02550000
         LA    R15,RC16           SARG OPTIMIZATION                     02560000
         B     RETURN                                                   02570000
                                                                        02580000
ERR_STG  DS    0H                 STORAGE FAILURE                       02590000
         LR    R1,R0              SERVICE RTN RSNCODE AS INFCODE        02600000
         LR    R0,R15             PRESERVE SERVICE ROUTINE RETCODE      02610000
         LA    R15,RC24           SET LOCAL INDICATOR                   02620000
                                                                        02630000
*--------------------------------------------------------------         02640000
*   Return to caller                                                    02650000
*--------------------------------------------------------------         02660000
                                                                        02670000
RETURN   DS    0H                                                       02680000
         #EXIT ,                                                        02690000
                                                                        02700000
         EJECT                                                          02710000
**<DOC-ON>*****************************************************         02720000
*                                                                       02730000
* ROUTINE:  TSCOPY - Copy source predicate subtree                      02740000
*                                                                       02750000
* DESCRIPTION:                                                          02760000
*                                                                       02770000
*    The current SARG node and its subtrees are copied. If the          02780000
*    current node has been previously marked either                     02790000
*    catagorically true or catagorically false, the subtrees            02800000
*    are not copied.  In any case, the address of the SARG node         02810000
*    copy is returned.                                                  02820000
*                                                                       02830000
*                                                                       02840000
* NOTES:                                                                02850000
*                                                                       02860000
*    BAKR linkage, Recursive.  WORKAREA is used to construct            02870000
*    storage manager parameter lists etc.  No data saved in             02880000
*    WORKAREA remains valid over a recursive TSCOPY call.               02890000
*                                                                       02900000
*                                                                       02910000
* ON ENTRY:                                                             02920000
*                                                                       02930000
*    R1  contains the address of a source predicate tree node           02940000
*                                                                       02950000
*                                                                       02960000
* ON EXIT:                                                              02970000
*                                                                       02980000
*    R15 contains zero or a storage manager failure code                02990000
*                                                                       03000000
*    R1  contains the address of a newly allocated predicate            03010000
*        tree node                                                      03020000
*                                                                       03030000
**<DOC-OFF>****************************************************         03040000
                                                                        03050000
TSCOPY   DS    0H                                                       03060000
         BAKR  R14,0                                                    03070000
                                                                        03080000
         LR    R4,R1              SARG NODE, MULTIPLE FORMATS           03090000
P        USING TBBPRED,R4            PREDICATE FORMATS                  03100000
C        USING TBCONN,R4             BOOLEAN CONNECTOR                  03110000
                                                                        03120000
*--------------------------------------------------------------         03130000
*   Acquire subset SARG node of matching size and copy                  03140000
*--------------------------------------------------------------         03150000
                                                                        03160000
         LA    R2,TBPRLEN         ASSUME PREDICATE FORMAT               03170000
         CLI   C.TBCOTYPE,TBCO$CON                                      03180000
         BNE   *+8                ASSUMPTION CORRECT                    03190000
         LA    R2,TBCOLEN         ELSE ITS A CONNECTOR                  03200000
                                                                        03210000
         STGGET (R2),QH=TSKSTG    ACQUIRE STORAGE FOR SUBSET NODE       03220000
         BNZ   TS_EXIT            STORAGE FAILURE                       03230000
                                                                        03240000
         BCTR  R2,0               PREPARE FOR COPY                      03250000
         EX    R2,*+4                                                   03260000
         MVC   0(*-*,R1),0(R4)                                          03270000
                                                                        03280000
         LR    R3,R1              SUBSET NODE                           03290000
P2       USING TBBPRED,R3            PREDICATE FORMATS                  03300000
C2       USING TBCONN,R3             BOOLEAN CONNECTOR                  03310000
                                                                        03320000
*-------------------------------------------------------------          03330000
*   All predicates of cols not members of screen(set) are TRUE          03340000
*-------------------------------------------------------------          03350000
                                                                        03360000
         CLI   C2.TBCOTYPE,TBCO$CON                                     03370000
         BE    TS_BOOL            DONE IF NODE IS NOT A CONNECTOR       03380000
                                                                        03390000
         CLI   P2.TBPRTV,0        PREDETERMINED TRUTH VALUE?            03400000
         BNE   TS_RETSN           NOT CHANGED IF SO                     03410000
                                                                        03420000
         MVI   COLNAME,C' '       CONSTRUCT BLANK PADDED COLUMN NAME    03430000
         MVC   COLNAME+1(L'COLNAME-1),COLNAME                           03440000
         LH    R2,P2.TBPRCOLL     LENGTH OF SARG RESIDENT COLUMN NAME   03450000
         BCTR  R2,0               PREPARE FOR COPY                      03460000
         L     R15,P2.TBPRCOL     LOCATE COLUMN NAME ORIGIN             03470000
         EX    R2,*+4             COPY                                  03480000
         MVC   COLNAME(*-*),0(R15)                                      03490000
                                                                        03500000
         LA    R1,COLNAME         R1 <== COLUMN NAME                    03510000
         BAS   R14,MATCHCOL       DETERMINE IF COLUMN MEMBER OF SSET    03520000
         BE    *+8                TRUTH VALUE UNKNOWN IF SO             03530000
         MVI   P2.TBPRTV,TBPR$T   ELSE MARK CATAGORICALLY TRUE          03540000
         B     TS_RETSN           DONE                                  03550000
                                                                        03560000
*-------------------------------------------------------------          03570000
*   Copy subtrees of boolean connector nodes                            03580000
*-------------------------------------------------------------          03590000
                                                                        03600000
TS_BOOL  DS    0H                                                       03610000
         CLI   C2.TBCOTV,0        CATAGORICALLY TRUE OR FALSE?          03620000
         BNE   TS_RETSN           SUBTREES IRRELAVENT IF SO             03630000
                                                                        03640000
         ICM   R1,15,C.TBCOLEFT   LEFT SOURCE SUBTREE                   03650000
         BZ    TS_RTREE           ODD, BUT ONWARD                       03660000
         BAS   R14,TSCOPY         COPY SUBTREE, RETURN ROOT             03670000
         LTR   R15,R15            SUCCESS?                              03680000
         BNZ   TS_EXIT            ERROR OTHERWISE                       03690000
         ST    R1,C2.TBCOLEFT     ATTACH TO OUR NODE                    03700000
                                                                        03710000
TS_RTREE DS    0H                                                       03720000
         ICM   R1,15,C.TBCORGHT   RIGHT SOURCE SUBTREE                  03730000
         BZ    TS_RETSN           ODD, BUT ONWARD                       03740000
         BAS   R14,TSCOPY         COPY SUBTREE, RETURN ROOT             03750000
         LTR   R15,R15            SUCCESS?                              03760000
         BNZ   TS_EXIT            ERROR OTHERWISE                       03770000
         ST    R1,C2.TBCORGHT     ATTACH TO OUR NODE                    03780000
                                                                        03790000
*--------------------------------------------------------------         03800000
*   Return completion status and SARG node copy to caller               03810000
*--------------------------------------------------------------         03820000
                                                                        03830000
TS_RETSN DS    0H                                                       03840000
         LR    R1,R3              RETURN SARG NODE COPY                 03850000
         SR    R15,R15            SUCCESSFUL COMPLETION                 03860000
                                                                        03870000
TS_EXIT  DS    0H                                                       03880000
         PR    ,                                                        03890000
         DROP  C,C2,P,P2          SARG NODES, SOURCE AND COPY           03900000
                                                                        03910000
         EJECT                                                          03920000
**<DOC-ON>*****************************************************         03930000
*                                                                       03940000
* ROUTINE:  MATCHCOL - Match named column to screen(set)                03950000
*                                                                       03960000
* DESCRIPTION:                                                          03970000
*                                                                       03980000
*    The column name provided as input is used to drive a               03990000
*    TVBR vector scan to determine whether the column is a              04000000
*    member of the current screen(set).  If so, the address             04010000
*    of the assoicate TVBR.TVVAR entry is returned.                     04020000
*                                                                       04030000
*                                                                       04040000
* ON ENTRY:                                                             04050000
*                                                                       04060000
*    R1  contains the address of the column name                        04070000
*                                                                       04080000
*    TVBRVEC  is addressable                                            04090000
*                                                                       04100000
*                                                                       04110000
* ON EXIT:                                                              04120000
*                                                                       04130000
*    R15 contains one of the following return codes                     04140000
*        The condition code is set accordingly                          04150000
*                                                                       04160000
*        RC00 - name matched, R1 contains the assoc TVVAR addr          04170000
*        RC04 - column is not a member of the screen(set)               04180000
*                                                                       04190000
**<DOC-OFF>****************************************************         04200000
                                                                        04210000
MATCHCOL DS    0H                                                       04220000
         STM   R14,R12,12(R13)    SAVE CALLERS REGS                     04230000
                                                                        04240000
         LA    R4,TVVAR           TVBR VECTOR, COL/VAR ENTRY SECTION    04250000
         USING TVVAR,R4           TIGHTEN ADDRESSABILITY                04260000
         L     R3,TVBNVARS        NUMBER OF ENTRIES                     04270000
                                                                        04280000
*--------------------------------------------------------------         04290000
*   Match column name provided to screen(set) SYSCOLUMNS row            04300000
*--------------------------------------------------------------         04310000
                                                                        04320000
         LA    R15,RC04           ASSUME COLUMN NOT MATCHED             04330000
                                                                        04340000
MATSCAN  DS    0H                 TRAVERSE TVBR->$NAVPARM->SYSCOL       04350000
         ICM   R5,15,TVVCOLDF     $NAVPARM COL/VAR ENTRY                04360000
         BZ    MATADV             INTERMEDIATE REGION                   04370000
         L     R5,IXR@SCOL-IXRCOLDF(,R5)  ASSOCIATED SYSCOLUMNS ROW?    04380000
         USING SYSCOLS,R5                                               04390000
                                                                        04400000
         CLC   SCOLNAME,0(R1)     COLUMN IS MEMBER OF SCREEN(SET)?      04410000
         BE    MATHIT             COMPLETE IF SO                        04420000
                                                                        04430000
MATADV   DS    0H                                                       04440000
         LA    R4,TVVAR+TVVLN     ELSE ADVANCE TO NEXT ENTRY            04450000
         BCT   R3,MATSCAN         AND TRY AGAIN                         04460000
         B     MATRET             FAIL IF NO MATCH                      04470000
                                                                        04480000
*--------------------------------------------------------------         04490000
*   Returned matched TVBR entry and/or status to caller                 04500000
*--------------------------------------------------------------         04510000
                                                                        04520000
MATHIT   DS    0H                                                       04530000
         LR    R1,R4              R1 <== MATCHING TVVAR ENTRY           04540000
         SR    R15,R15            INDICATE SUCCESS                      04550000
                                                                        04560000
MATRET   DS    0H                                                       04570000
         L     R14,12(,R13)       RESTORE RETURN ADDR                   04580000
         LM    R2,R12,28(R13)     RESTORE MAINLINE REGS                 04590000
         LTR   R15,R15            REFLECT COMPLETION VIA CC             04600000
         BR    R14                RETURN                                04610000
         DROP  R5,R4              SYSCOLUMNS, TVVAR                     04620000
                                                                        04630000
         EJECT                                                          04640000
***************************************************************         04650000
*                                                                       04660000
*   Local read-only data areas, etc.                                    04670000
*                                                                       04680000
***************************************************************         04690000
                                                                        04700000
         LTORG ,                                                        04710000
                                                                        04720000
         EJECT                                                          04730000
         PRINT NOGEN                                                    04740000
         ICVT  ,                                                        04750000
         ITASK ,                                                        04760000
         IPCB  ,                                                        04770000
         END   ,                                                        04780000

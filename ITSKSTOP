ITSKSTOP TITLE '- TASK TERMINATION (STOP/CANCEL) SERVICE'               00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE: ITSKSTOP - TASK Termination (Stop/Cancel) service            00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine will process the $TASK STOP/CANCEL req, which         00080000
*    will in turn issue a stop of all subtasks created by this          00090000
*    task. When all subtasks have completly terminated,                 00100000
*    termination of this task will continue.                            00110000
*                                                                       00120000
* ON ENTRY:                                                             00130000
*                                                                       00140000
*    R1 contains the address of the parameter list mapped by            00150000
*    the TASKPL dsect generated by $TASK DSECT=YES.                     00160000
*                                                                       00170000
* ON EXIT:                                                              00180000
*                                                                       00190000
*    R15 will contain one of the following return codes:                00200000
*                                                                       00210000
*        RC00 - Normal Completion                                       00220000
*                                                                       00230000
*        RC12 - Service failure                                         00240000
*               R0 = RSN04 - $TASK POST failure                         00250000
*                    RSN08 - $TASK STOP failure                         00260000
*                                                                       00270000
*        RC16 - Internal Error                                          00280000
*               R0 = RSN04 - Storage allocation error                   00290000
*                                                                       00300000
*        RC20 - Request error                                           00310000
*               R0 = RSN04 - Invalid ITASK address specified            00320000
*                                                                       00330000
* MODE:                                                                 00340000
*                                                                       00350000
*    TASK                                                               00360000
*    APF/NON-APF                                                        00370000
*    SUP/PROB                                                           00380000
*    AMODE 31, RMODE ANY                                                00390000
*                                                                       00400000
**<DOC-OFF>*****************************************************        00410000
                                                                        00420000
         EJECT ,                                                        00430000
****************************************************************        00440000
*                                                                       00450000
* MAINTENANCE:                                                          00460000
*                                                                       00470000
*   04/21/93 Ron Colmone                                                00480000
*            Initial Version                                            00490000
*                                                                       00500000
****************************************************************        00510000
         EJECT ,                                                        00520000
         $TASK DSECT=YES          TASKMGR PLIST                         00530000
                                                                        00540000
         EJECT ,                                                        00550000
         @EPB  TYPE=DSECT         EVENT PROCESS BLOCK                   00560000
                                                                        00570000
         EJECT ,                                                        00580000
         EQUS  ,                  GENERAL EQUATES                       00590000
                                                                        00600000
         EJECT ,                                                        00610000
         ABCODES ,                $ABEND CODES                          00620000
                                                                        00630000
         EJECT ,                                                        00640000
         #WORK LENGTH=512         READ/WRITE WORKAREA                   00650000
REGSAVE  DS    16F                REGISTER SAVE AREA                    00660000
FLAGS    DS    X                  FLAGS                                 00670000
$LOCKED  EQU   X'80'                LOCK OBTAINED                       00680000
         DS    XL3                RESERVED                              00690000
TSRVWRK  DS    A                  ADDR OF TASK WORKAREA                 00700000
$TASKMFL $TASK MF=(L,*)           $TASK PLIST AREA                      00710000
         #ENDWORK                 END OF WORKAREA                       00720000
                                                                        00730000
#TSRVWLN EQU   1024               LEN  OF TASK WORKAREA                 00740000
                                                                        00750000
         EJECT ,                                                        00760000
ITSKSTOP #ENTER BASE=R12,         ENTRY LINKAGE                        +00770000
               PREG=R8,                                                +00780000
               WAPASS=YES                                               00790000
                                                                        00800000
         USING TASKPL,R8          ESTABLISH ADDRESSABILITY              00810000
         USING ITASK,R10          ESTABLISH ADDRESSABILITY              00820000
                                                                        00830000
         EJECT ,                                                        00840000
****************************************************************        00850000
*                                                                       00860000
*  STOP TASK                                                            00870000
*                                                                       00880000
****************************************************************        00890000
STOP     DS    0H                                                       00900000
         ICM   R5,15,TPLTASK      ADDR OF TASK TO STOP                  00910000
         BZ    ERR_TASK           NONE, ERROR                           00920000
T        USING ITASK,R5           ESTAB ADDR TO ITASK TO STOP           00930000
                                                                        00940000
*---------------------------------------------------------------        00950000
*  OBTAIN TASK WORKAREA                                                 00960000
*---------------------------------------------------------------        00970000
         $GETSTOR #TSRVWLN,OWNER=ITASK  ALLOCATE TASKSRV WORKA   159456 00980000
         ST    R1,TSRVWRK         SAVE TASKSRV WORKAREA ADDR            00990000
                                                                        01000000
*---------------------------------------------------------------        01010000
*  STOP/CANCEL ALL CHILDREN TASK                                        01020000
*---------------------------------------------------------------        01030000
         $SER  OBTAIN,DISP        ACQUIRE SERIALIZATION                 01040000
         B     *+4(R15)           BRANCH ON LOCK RETURN CODE            01050000
         B     LOCK_OBT           0 - LOCK OBTAINED                     01060000
         B     LOCK_HAV           4 - LOCK ALREADY OWNED                01070000
         B     ABN_LOCK           8 - UNABLE TO ACQUIRE LOCK            01080000
                                                                        01090000
LOCK_OBT DS    0H                                                       01100000
         OI    FLAGS,$LOCKED      LOCK OBTAINED                         01110000
                                                                        01120000
LOCK_HAV DS    0H                                                       01130000
         LA    R6,T.TSKSUBQ       ADDR OF CHILD SUBTASK QUEUE           01140000
         SH    R6,=AL2(TSKSIBL-ITASK)                                   01150000
Q        USING ITASK,R6           CHILD QUEUE ADDRESSABILITY            01160000
                                                                        01170000
STOP_NXT DS    0H                                                       01180000
         ICM   R6,15,Q.TSKSIBL    ADDRESS OF NEXT SUBTASK               01190000
         BZ    STOP_PST           POST SHUTDOWN EPB                     01200000
                                                                        01210000
         TM    TPLCFLGS,TPLC$CNL  CANCEL STOP REQUESTED                 01220000
         BO    STOP_CNL           YES,  ISSUE SUBTASK CANCEL            01230000
                                                                        01240000
         $TASK STOP,              STOP CHILD TASK                      +01250000
               TASK=(R6),                                              +01260000
               WORKA=*TSRVWRK,                                         +01270000
               MF=(E,$TASKMFL)                                          01280000
         BNZ   ERR_STOP           STOP ERROR                            01290000
         B     STOP_NXT           STOP NEXT CHILD                       01300000
                                                                        01310000
STOP_CNL DS    0H                                                       01320000
         $TASK CANCEL,            CANCEL CHILD TASK                    +01330000
               TASK=(R6),                                              +01340000
               WORKA=*TSRVWRK,                                         +01350000
               MF=(E,$TASKMFL)                                          01360000
         BNZ   ERR_STOP           CNCL ERROR                            01370000
         B     STOP_NXT           STOP NEXT CHILD                       01380000
                                                                        01390000
*---------------------------------------------------------------        01400000
*  POST REQUESTED TASK SHUTDOWN EPB                                     01410000
*---------------------------------------------------------------        01420000
STOP_PST DS    0H                                                       01430000
         TM    T.TSKFLGS,TSK$TERM HAS TASK TERMINATED                   01440000
         BO    STOP_END           YES, SKIP POST                        01450000
                                                                        01460000
         LA    R3,RC00            ASSUME NORMAL STOP                    01470000
         TM    TPLCFLGS,TPLC$CNL  CANCEL STOP REQUESTED                 01480000
         BZ    *+8                NO, CONTINUE                          01490000
         LA    R3,RC08            CANCEL STOP REQUEST                   01500000
                                                                        01510000
         $TASK POST,              POST SHUTDOWN EPB                    +01520000
               PCODE=(R3),                                             +01530000
               EPB=T.TSKZEPB,                                          +01540000
               TASK=(R5),                                              +01550000
               WORKA=*TSRVWRK,                                         +01560000
               MF=(E,$TASKMFL)                                          01570000
         BNZ   ERR_POST           POST ERROR                            01580000
                                                                        01590000
STOP_END DS    0H                                                       01600000
         LA    R15,RC00           NORMAL COMPLETION                     01610000
         B     RET                RETURN                                01620000
         DROP  T                  TERM ITASK                            01630000
                                                                        01640000
         EJECT ,                                                        01650000
****************************************************************        01660000
*                                                                       01670000
*   CATASTROPHIC ERRORS                                                 01680000
*                                                                       01690000
****************************************************************        01700000
                                                                        01710000
ABN_LOCK DS    0H                                                       01720000
         $ABEND ABE_DISPLOCK,                                          +01730000
               SCOPE=ITASK,                                            +01740000
               TITLE='UNABLE TO OBTAIN DISPATCHER LOCK'                 01750000
                                                                        01760000
         EJECT ,                                                        01770000
****************************************************************        01780000
*                                                                       01790000
*   ERROR EXIT                                                          01800000
*                                                                       01810000
****************************************************************        01820000
                                                                        01830000
ERR_POST DS    0H                                                       01840000
         LA    R0,RSN04           TASK POST FAILURE                     01850000
         B     RET_RC12           SERVICE  ERROR                        01860000
                                                                        01870000
ERR_STOP DS    0H                                                       01880000
         LA    R0,RSN08           TASK POST FAILURE                     01890000
         B     RET_RC12           SERVICE  ERROR                        01900000
                                                                        01910000
ERR_STG  DS    0H                                                       01920000
         LA    R0,RSN04           STORAGE ALLOCATION ERROR              01930000
         B     RET_RC16           INTERNAL ERROR                        01940000
                                                                        01950000
ERR_TASK DS    0H                                                       01960000
         LA    R0,RSN04           ITASK MISSING                         01970000
         B     RET_RC20           CALLING SEQUENCE ERROR                01980000
                                                                        01990000
         EJECT ,                                                        02000000
****************************************************************        02010000
*                                                                       02020000
*   RETURN                                                              02030000
*                                                                       02040000
****************************************************************        02050000
                                                                        02060000
RET_RC08 DS    0H                                                       02070000
         LA    R15,RC08           SUBTASK FAILURE                       02080000
         B     RET                                                      02090000
                                                                        02100000
RET_RC12 DS    0H                                                       02110000
         LA    R15,RC12           ABNORMAL RETURN (SERVICE FAIL)        02120000
         B     RET                                                      02130000
                                                                        02140000
RET_RC16 DS    0H                                                       02150000
         LA    R15,RC16           ABNORMAL RETURN (INTERNAL ERR)        02160000
         B     RET                                                      02170000
                                                                        02180000
RET_RC20 DS    0H                                                       02190000
         LA    R15,RC20           PARAMETER ERROR                       02200000
         B     RET                                                      02210000
                                                                        02220000
RET      DS    0H                                                       02230000
         BAS   R14,CLEANUP        RELEASE RESOURCES                     02240000
         #EXIT ,                  RETURN                                02250000
                                                                        02260000
         EJECT ,                                                        02270000
****************************************************************        02280000
*                                                                       02290000
* ROUTINE: CLEANUP - RELEASE ALLOCATED RESOURCES                        02300000
*                                                                       02310000
* ON ENTRY: N/A                                                         02320000
*                                                                       02330000
* ON EXIT:  N/A                                                         02340000
*                                                                       02350000
****************************************************************        02360000
CLEANUP  DS    0H                                                       02370000
         STM   R0,R15,REGSAVE     SAVE CALLER'S REGISTERS               02380000
                                                                        02390000
         TM    FLAGS,$LOCKED      LOCK ACQUIRED?                        02400000
         BZ    CLN_WRKA           NO, FREE WORKAREA                     02410000
         $SER  RELEASE,DISP       RELEASE LOCK                          02420000
                                                                        02430000
CLN_WRKA DS    0H                                                       02440000
         ICM   R3,15,TSRVWRK      WORKAREA ALLOCATED?                   02450000
         BZ    CLN_EXIT           NO, RETURN                            02460000
                                                                        02470000
         $RETSTOR (R3),OWNER=ITASK RETURN TASKSRV WORKAREA       159456 02480000
                                                                        02490000
CLN_EXIT DS    0H                                                       02500000
         LM    R0,R15,REGSAVE     RESTORE CALLER'S REGISTERS            02510000
         BR    R14                RETURN                                02520000
                                                                        02530000
         EJECT ,                                                        02540000
****************************************************************        02550000
*                                                                       02560000
*  CONSTANTS AND LITERALS                                               02570000
*                                                                       02580000
****************************************************************        02590000
                                                                        02600000
         LTORG ,                                                        02610000
                                                                        02620000
         PRINT NOGEN                                                    02630000
         ICVT  ,                                                        02640000
         ITASK ,                                                        02650000
                                                                        02660000
         IHAPSA ,                                                       02670000
         CVT   DSECT=YES,LIST=NO                                        02680000
         IKJTCB ,                                                       02690000
         PRINT GEN                                                      02700000
                                                                        02710000
         END   ,                                                        02720000

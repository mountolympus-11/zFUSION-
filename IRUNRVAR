IRUNRVAR TITLE '- PROMOTE REPLACEMENT VALUES INTO VARPOOL'              00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: IRUNRVAR - Promote replacement values into varpool           00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine accepts an STN screen (set) name identifying          00080000
*    the current state and a $NAVPARM cross-referencing all             00090000
*    VDB variables to their respective state.  For each                 00100000
*    input-capable variable residing on the current state,              00110000
*    its "replacement" value is promoted into the USER variable         00120000
*    pool, overlaying the "initial" value determined at the             00130000
*    start of the query, if any.                                        00140000
*                                                                       00150000
*                                                                       00160000
* NOTES:                                                                00170000
*                                                                       00180000
*    The source of "replacement" values is those SQL statement          00190000
*    clauses that provide explicit value assignments for                00200000
*    specified table columns.  By deferring the introduction of         00210000
*    replacement values into the variable pool until the time           00220000
*    the new values are to be actually used, the caller can             00230000
*    maintain an "initial" value for use during navigation,             00240000
*    particularly for use in a search argument.  The following          00250000
*    example suggests these two uses for the column named               00260000
*    CHECKNO:                                                           00270000
*                                                                       00280000
*       UPDATE TABLE1 SET CHECKNO = 1 WHERE CHECKNO = 999               00290000
*                                                                       00300000
*                                                                       00310000
* ON ENTRY:                                                             00320000
*                                                                       00330000
*    R1  contains the address of a parameter list described by          00340000
*        the RUNRVARP mapping macro                                     00350000
*                                                                       00360000
*                                                                       00370000
* ON EXIT:                                                              00380000
*                                                                       00390000
*    R15 contains one of the following return codes                     00400000
*                                                                       00410000
*                                                                       00420000
* ON EXIT:                                                              00430000
*                                                                       00440000
*    R15 contains one of the following return codes                     00450000
*                                                                       00460000
*        RC00 - variable promotion completed without error              00470000
*                                                                       00480000
*               R0 - number of replacement values promoted              00490000
*                                                                       00500000
*    All $VARMGR errors result in $ABEND                                00510000
*                                                                       00520000
**<DOC-OFF>****************************************************         00530000
                                                                        00540000
         EJECT                                                          00550000
***************************************************************         00560000
*                                                                       00570000
* MAINTENANCE:                                                          00580000
*                                                                       00590000
*    07/07/95 R. Turgeon                                                00600000
*             Initial version, modelled on INAVPVAR                     00610000
*                                                                       00620000
***************************************************************         00630000
                                                                        00640000
         EJECT                                                          00650000
         RUNRVARP ,               REQUEST LIST                          00660000
                                                                        00670000
         EJECT                                                          00680000
         IUSER ,                  USER CONTROL BLOCK                    00690000
                                                                        00700000
         EJECT                                                          00710000
         NAV   ,                  NAVIGATION NETWORK STRUCTURES         00720000
                                                                        00730000
         EJECT                                                          00740000
         $NAVPARM ,               QUERY / IMAGING INTERFACE REQUEST     00750000
                                                                        00760000
         EJECT                                                          00770000
         $VARMGR DSECT=YES        VARIABLE SERVICES                     00780000
                                                                        00790000
         EJECT                                                          00800000
         VARCONST ,               SQL VARIABLE MANAGEMENT CONSTANTS     00810000
                                                                        00820000
         EJECT                                                          00830000
         ICATALOG VARIABLES       PROJECT CATALOG TABLE FORMATS         00840000
                                                                        00850000
         EJECT                                                          00860000
         ABCODES  PRINT=NOGEN     ABEND CODES                           00870000
                                                                        00880000
         EQUS  ,                                                        00890000
                                                                        00900000
         EJECT                                                          00910000
         #WORK ,                  WRITEABLE WORKING STORAGE             00920000
                                                                        00930000
COUNT    DS    F                  NUMBER OF PROMOTED VARIABLE VALUES    00940000
REGSAVE  DS    16F                LOCAL REGISTER SAVEAREA               00950000
                                                                        00960000
$VMLIST  $VARMGR MF=(L,*)                                               00970000
                                                                        00980000
         #ENDWORK ,               PROJECT CONTROL BLOCK                 00990000
                                                                        01000000
         EJECT                                                          01010000
IRUNRVAR #ENTER PREG=(R9)                                               01020000
                                                                        01030000
         USING ITASK,R10          STDENV                                01040000
         L     R1,TSKPCBC         PROCESS MODE                          01050000
         USING IPCB,R1                                                  01060000
                                                                        01070000
         L     R6,PCBUSER                                               01080000
         USING IUSER,R6           LOF IUSER ADDRESSABILITY              01090000
         DROP  R1                 IPCB                                  01100000
                                                                        01110000
         EJECT                                                          01120000
***************************************************************         01130000
*                                                                       01140000
*   Fetch passed parms, establish global addressabilities               01150000
*                                                                       01160000
***************************************************************         01170000
                                                                        01180000
         USING RRVPLIST,R9        REQUEST LIST FORMAT                   01190000
                                                                        01200000
         L     R8,RRVPNAVP        SQL/NAVIGATION LINKAGE BLOCK          01210000
         USING $NAVPARM,R8        LIFE OF FUNCTION                      01220000
                                                                        01230000
         L     R7,RRVPSTN         ADDR OF CURRENT STATE STN NODE        01240000
         USING NVSTN,R7                                                 01250000
                                                                        01260000
**<DOC-ON>*****************************************************         01270000
*                                                                       01280000
*   Scan the $NAVPARM column/variable entries, locating input           01290000
*   variables residing on the current state whose replacement           01300000
*   values have not yet been promoted to the variable pool.             01310000
*   Call PUTVAR to promote those and ignore all others.                 01320000
*                                                                       01330000
**<DOC-OFF>****************************************************         01340000
                                                                        01350000
         LH    R3,IXRNVARS        NUMBER OF COLUMNS/VARIABLES           01360000
         L     R4,IXREPOFF        OFFSET TO $NAVPARM COL/VAR ENTRIES    01370000
         LA    R4,$NAVPARM(R4)    CONVERT OFFSET TO ADDRESS             01380000
         USING IXRCOLDF,R4        MAPPED                                01390000
                                                                        01400000
*--------------------------------------------------------------         01410000
*   weed out ineligible variables, promote the others                   01420000
*--------------------------------------------------------------         01430000
                                                                        01440000
VARNEXT  DS    0H                                                       01450000
         C     R7,IXRSCRNA        VAR RESIDES ON CURR SCREEN(SET)?      01460000
         BNE   VARADV             INELIGIBLE FOR PROMOTION IF NOT       01470000
         TM    IXRSTAT0,IXRS0REP+IXRS0VRE   REPLACEMENT VALUE PENDING?  01480000
         BNM   VARADV             NOT OF INTEREST OTHERWISE             01490000
                                                                        01500000
         L     R15,IXR@RVAR       R15 <== SYSVARIABLES ENTRY            01510000
         L     R1,IXRVSRS@        R1  <== REPLACEMENT VARIABLE TEXT     01520000
         LH    R0,IXRVSRLN        R0  <== LENGTH OF VARIABLE VALUE      01530000
         BAS   R14,PUTVAR         INSERT VARIABLE IN POOL               01540000
         BNZ   VARADV             SOMETHING WENT AMISS                  01550000
                                                                        01560000
         OI    IXRSTAT0,IXRS0VRE  REPLACEMENT VALUE LOADED              01570000
         OI    IXRSTAT1,IXRS1INP  REPLACEMENT VALUE FOR INPUT VARIABLE  01580000
                                                                        01590000
         L     R15,COUNT          PROMOTED VAR/VAL COUNT                01600000
         LA    R15,1(,R15)        INCREMENT ACCORDINGLY                 01610000
         ST    R15,COUNT          RETAIN UPDATED VALUE                  01620000
                                                                        01630000
VARADV   DS    0H                                                       01640000
         LA    R4,IXRCDLEN(,R4)   ADVANCE TO NEXT COLUMN/VAR ENTRY      01650000
         BCT   R3,VARNEXT         PROCESS NEXT VARIABLE                 01660000
         DROP  R4                 IXRCOLDF                              01670000
                                                                        01680000
         EJECT                                                          01690000
***************************************************************         01700000
*                                                                       01710000
*   Return normal/abnormal completion status to caller                  01720000
*                                                                       01730000
***************************************************************         01740000
                                                                        01750000
         L     R0,COUNT           RETURN NUMBER OF PROMOTED VARS/VALS   01760000
         SR    R15,R15                                                  01770000
                                                                        01780000
         #EXIT ,                                                        01790000
                                                                        01800000
         EJECT                                                          01810000
***************************************************************         01820000
*                                                                       01830000
* ROUTINE:  PUTVAR - Load variable into USER variable pool              01840000
*                                                                       01850000
* DESCRIPTION:                                                          01860000
*                                                                       01870000
*    This routine accepts a variable, as described by its               01880000
*    SYSVARIABLE entry and an associated value and posts it             01890000
*    in the USER variable pool.  Values longer than                     01900000
*    $VARMGR_VAR_SIZE are truncated without notification.               01910000
*                                                                       01920000
*    If the variable is defined with the SQL ERROR DATA                 01930000
*    attribute, it is tagged with a class code of VARCSQL_ERROR         01940000
*    to make it easy to identify later.                                 01950000
*                                                                       01960000
*                                                                       01970000
* ON ENTRY:                                                             01980000
*                                                                       01990000
*    R15 - SYSVARIABLE (SVARSECT) entry origin                          02000000
*    R1  - variable text origin                                         02010000
*    R0  - variable text length >= 0                                    02020000
*                                                                       02030000
*                                                                       02040000
* ON EXIT:                                                              02050000
*                                                                       02060000
*    R15 contains one of the following return codes                     02070000
*        The condition code is set accordingly                          02080000
*                                                                       02090000
*        RC00 - variable added to USER pool                             02100000
*        RC04 - variable length error                                   02110000
*                                                                       02120000
*    Any $VARMGR errors result in $ABEND                                02130000
*                                                                       02140000
***************************************************************         02150000
                                                                        02160000
PUTVAR   DS    0H                                                       02170000
         STM   R0,R15,REGSAVE     SAVE MAINLINE REGS                    02180000
         LR    R3,R1              VARIABLE TEXT ORIGIN                  02190000
                                                                        02200000
         LR    R2,R15             SYSVARIABLE ENTRY ORIGIN              02210000
         USING SVARSECT,R2                                              02220000
                                                                        02230000
*--------------------------------------------------------------         02240000
*   validate length, truncate value without notification                02250000
*--------------------------------------------------------------         02260000
                                                                        02270000
         LA    R15,RC04           ASSUME IMPROPER LENGTH                02280000
         LTR   R7,R0              VARIABLE LENGTH                       02290000
         BM    PUTVARX            REJECTED                              02300000
                                                                        02310000
         C     R7,=A($VARMGR_VAR_SIZE)   MAXIMUM SIZE                   02320000
         BNH   *+8                       WITHIN SUPPORTED LIMIT?        02330000
         L     R7,=A($VARMGR_VAR_SIZE)   TRUNCATE OTHERWISE             02340000
                                                                        02350000
*--------------------------------------------------------------         02360000
*   post standard / SQLERROR variable to USER pool                      02370000
*--------------------------------------------------------------         02380000
                                                                        02390000
         SR    R5,R5              RESET VARIABLE CLASS                  02400000
         TM    SVARFLG1,SVARF1ER  SQL ERROR DATA VARIABLE?              02410000
         BZ    *+8                SKIP IF NOT                           02420000
         LA    R5,VARCSQL_ERROR   ELSE SET CLASS CODE ACCORDINGLY       02430000
                                                                        02440000
         $VARMGR VPUT,                                                 X02450000
               SCOPE=$VARMGR_SCOPE_USER,                               X02460000
               CLASS=(R5),                                             X02470000
               VARNAME=SVARNAME,                                       X02480000
               VARIABLE=((R3),(R7)),                                   X02490000
               POOL=*USRVPOOL,                                         X02500000
               ERRET=ABN_VARP,                                         X02510000
               MF=(E,$VMLIST)                                           02520000
                                                                        02530000
         L     R1,IXRVPUTS        NUMBER OF VPUTS                       02540000
         LA    R1,1(,R1)          BUMPED                                02550000
         ST    R1,IXRVPUTS                                              02560000
                                                                        02570000
         SR    R15,R15            VPUT ACCEPTED, SET COMPLETION STATUS  02580000
                                                                        02590000
*--------------------------------------------------------------         02600000
*   return completion status to caller                                  02610000
*--------------------------------------------------------------         02620000
                                                                        02630000
PUTVARX  DS    0H                                                       02640000
         LM    R0,R14,REGSAVE     RESTORE MAINLINE REGS                 02650000
         LTR   R15,R15            REFLECT COMPLETION STATUS VIA CC      02660000
         BR    R14                RETURN TO MAINLINE                    02670000
         DROP  R2                 SVARSECT                              02680000
                                                                        02690000
***************************************************************         02700000
*                                                                       02710000
*   Catastrophic failures                                               02720000
*                                                                       02730000
***************************************************************         02740000
                                                                        02750000
ABN_VARP DS    0H                                                       02760000
         $ABEND ABE_VARPOOL,DUMP=YES,                                  X02770000
               TITLE='VARIABLE POOL MANAGEMENT FAILURE'                 02780000
                                                                        02790000
         EJECT ,                                                        02800000
***************************************************************         02810000
*                                                                       02820000
*   Local read only data areas, mappings, etc.                          02830000
*                                                                       02840000
***************************************************************         02850000
                                                                        02860000
MARKBLK  DC    0F'0',X'80000000'                                        02870000
                                                                        02880000
         LTORG ,                                                        02890000
                                                                        02900000
         EJECT ,                                                        02910000
         PRINT NOGEN                                                    02920000
         ICVT  ,                                                        02930000
         ITASK ,                                                        02940000
         IPCB  ,                                                        02950000
         END   ,                                                        02960000

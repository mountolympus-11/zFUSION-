ISRVEPLG TITLE '- Server Attached Task Epilog Routine'                  00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE: ISRVEPLG - Server Attach Task Epilog Routine                 00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine receives control when a $SERVER attached              00080000
*    task terminates.  The server task dispatcher sets                  00090000
*    R14 to this routine so that control is gained when                 00100000
*    the task terminates.  Standard environment is reestablish          00110000
*    upon entry and the active ITASK is switched back to                00120000
*    the SERVER task.  The Task termination EPB is posted               00130000
*    and control is passed on to the task manager dispatch              00140000
*    via a $TASK CALLDSP.                                               00150000
*                                                                       00160000
*                                                                       00170000
* ON ENTRY:                                                             00180000
*                                                                       00190000
*    Upon entry to this routine the following registers                 00200000
*    conventions will be observed:                                      00210000
*                                                                       00220000
*          R14 - Entry address                                          00230000
*                                                                       00240000
*    All other register contents are ignored and standard               00250000
*    environment is restored.                                           00260000
*                                                                       00270000
* ON EXIT:                                                              00280000
*                                                                       00290000
*    $TASK CALLDSP is issued to   pass control onto the                 00300000
*    task manager dispatcher.                                           00310000
*                                                                       00320000
* MODE:                                                                 00330000
*                                                                       00340000
*    TASK                                                               00350000
*    APF/NON-APF                                                        00360000
*    SUP/PROB                                                           00370000
*    AMODE 31, RMODE ANY                                                00380000
*                                                                       00390000
**<DOC-OFF>*****************************************************        00400000
                                                                        00410000
         EJECT ,                                                        00420000
****************************************************************        00430000
*                                                                       00440000
* MAINTENANCE:                                                          00450000
*                                                                       00460000
*   01/11/95 Ron Colmone          Par# 159456                           00470000
*            Initial Version                                            00480000
*                                                                       00490000
****************************************************************        00500000
                                                                        00510000
         EJECT ,                                                        00520000
         $SERVER DSECT=YES        TASKMGR SERVER PLIST                  00530000
                                                                        00540000
         EJECT ,                                                        00550000
         $TASK   DSECT=YES        TASKMGR PLIST                         00560000
                                                                        00570000
         EJECT ,                                                        00580000
         EQUS  ,                  GENERAL EQUATES                       00590000
*                                                                       00600000
         TRACODES ,               TRACE CODES                           00610000
                                                                        00620000
         EJECT ,                                                        00630000
ISRVEPLG CSECT                                                          00640000
         LR    R12,R14            ENTRY ADDRESS                         00650000
         USING ISRVEPLG,R12       ADDRESSABILITY                        00660000
                                                                        00670000
         @RESTENV ,               RESTORE STANDARD ENVIRONMENT          00680000
         USING ITASK,R10          ADDRESSABILITY                        00690000
         USING ICVT,R11           ADDRESSABILITY                        00700000
                                                                        00710000
         @CPYRYT ,                COPYRIGHT                             00720000
                                                                        00730000
         LR    R3,R15             RETAIN COMPLETION CODE                00740000
                                                                        00750000
*---------------------------------------------------------------        00760000
*  Switch control to Server task and preserve for standard              00770000
*  environment.                                                         00780000
*---------------------------------------------------------------        00790000
         L     R7,TSKSAT@         ADDRESS OF SERVER ATTACH BLOCK        00800000
         USING SRVATASK,R7        ADDRESSABILITY                        00810000
                                                                        00820000
         LR    R5,R10             RETAIN TERMINATED ITASK ADDR          00830000
A        USING ITASK,R5           ADDRESSABILITY                        00840000
                                                                        00850000
         L     R10,TSKSVTSK       ADDRESS OF SERVER TASK                00860000
         LA    R13,TSKDSPSA       ADDRESS OF DISPATCHER SAVEAREA        00870000
                                                                        00880000
         L     R6,TSKSRV          ADDRESS OF SERVER EXTENSION           00890000
         USING SERVERX,R6         ADDRESSABILITY                        00900000
                                                                        00910000
         @PRESENV ,               RESET SERVER AS CURRENT TASK          00920000
                                                                        00930000
*---------------------------------------------------------------        00940000
*  Trace server task EPILOG event                                       00950000
*---------------------------------------------------------------        00960000
         $TRACE TRC_SERVEPLG,16   ALLOC TRACE ENTRY                     00970000
         BNZ   NO_TRACE           TRACE NOT ACTIVE                      00980000
         ST    R3,0(,R1)          TASK COMPLETION CODE                  00990000
         ST    R5,4(,R1)          TERMINATED ITASK ADDRESS              01000000
         MVC   8(L'TSKNAME,R1),A.TSKNAME TERMINATED TASK NAME           01010000
                                                                        01020000
NO_TRACE DS    0H                                                       01030000
                                                                        01040000
*---------------------------------------------------------------        01050000
*  Ensure task is nolonger dispatchable                                 01060000
*---------------------------------------------------------------        01070000
         @CALL ITSKDPDQ,(SRVDISPQ,(R5)),                               +01080000
               MF=(E,TSKT_MFL),CTYPE=CVT                                01090000
                                                                        01100000
*---------------------------------------------------------------        01110000
*  Post task term EPB with task completion code                         01120000
*---------------------------------------------------------------        01130000
         ICM   R2,15,SATTEPB      ADDRESS OF TERM EPB                   01140000
         BZ    DISPATCH           ZERO, CONTINUE WITH DISP CALL         01150000
                                                                        01160000
         $TASK POST,              NOTIFY TASK TERMINATION              +01170000
               EPB=(R2),                                               +01180000
               PCODE=(R3),                                             +01190000
               WORKA=*TSK@WRKA,                                        +01200000
               MF=(E,TSKT_MFL)                                          01210000
                                                                        01220000
*---------------------------------------------------------------        01230000
*  Return control to task manager dispatcer                             01240000
*---------------------------------------------------------------        01250000
DISPATCH DS    0H                                                       01260000
         $SERVER CALLDSP,         PASS CONTROL TO SERVER DISPATCHER    +01270000
               WORKA=*SRVWRKA@,                                        +01280000
               MF=(E,TSKT_MFL)                                          01290000
                                                                        01300000
         EJECT ,                                                        01310000
****************************************************************        01320000
*                                                                       01330000
*  CONSTANTS AND LITERALS                                               01340000
*                                                                       01350000
****************************************************************        01360000
                                                                        01370000
         LTORG ,                                                        01380000
                                                                        01390000
         PRINT NOGEN                                                    01400000
         ICVT  ,                                                        01410000
         ITASK ,                                                        01420000
         SERVERX ,                                                      01430000
         SRVATASK ,                                                     01440000
                                                                        01450000
         IHAPSA ,                                                       01460000
         CVT   DSECT=YES,LIST=NO                                        01470000
         IKJTCB ,                                                       01480000
         PRINT GEN                                                      01490000
                                                                        01500000
         END   ,                                                        01510000

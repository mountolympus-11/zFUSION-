IINFOX   TITLE '- INFORMATION EXCHANGE TRANSACTION (ABOUT)'             00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: IINFOX - INFORMATION EXCHANGE (ABOUT)                        00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THIS ROUTINE IS CALL TO RETURN AN ABOUT INFORMATION                00080000
*    EXCHANGE PACKET.                                                   00090000
*                                                                       00100000
*                                                                       00110000
* ON ENTRY:                                                             00120000
*                                                                       00130000
*    R1 CONTAINS THE ADDRESS OF A INFORMATION EXCHANGE REQUEST          00140000
*       LIST IN TRANSACTION FORMAT (XINFO).                             00150000
*                                                                       00160000
*                                                                       00170000
* ON EXIT:                                                              00180000
*                                                                       00190000
*    A RESPONSE BUFFER DESCRIBED BY YINFO IS CONSTRUCTED,               00200000
*    TANSMITTED, AND RELEASED.                                          00210000
*                                                                       00220000
**<DOC-OFF>****************************************************         00230000
                                                                        00240000
         EJECT ,                                                        00250000
***************************************************************         00260000
*                                                                       00270000
* MAINTENANCE:                                                          00280000
*                                                                       00290000
*    06/11/94  RON COLMONE                                              00300000
*        INITIAL VERSION.                                               00310000
*                                                                       00320000
*    09/14/95  RON COLMONE                                              00330000
*        Added support to $TASK chap by user type.                      00340000
*                                                                       00350000
***************************************************************         00360000
                                                                        00370000
         EJECT ,                                                        00380000
         #WORK ,                                                        00390000
WK256    DS    XL256              GENERAL WORKAREA                      00400000
CLITYPE  DS    CL10               CLIENT TYPE                           00410000
$TSK_MFL $TASK MF=(L,*)           $TASK PLIST CONSTRUCTION AREA         00420000
         #ENDWORK ,                                                     00430000
                                                                        00440000
         EJECT                                                          00450000
         $TASK  DSECT=YES         TASK MANAGER PLIST                    00460000
                                                                        00470000
         EJECT                                                          00480000
         XINFO   ,                SYSTEM ENTRY VALIDATION               00490000
                                                                        00500000
         EJECT                                                          00510000
         YINFO ,                  RESPONSE BLOCK                        00520000
                                                                        00530000
         EJECT                                                          00540000
         @VERSION ,               RESPONSE BLOCK                        00550000
                                                                        00560000
         EQUS  ,                                                        00570000
                                                                        00580000
         ABCODES ,                                                      00590000
                                                                        00600000
         $MSGDFT PREFIX=ICTPID,COMPID='INF',TABLE=*#MSGS,              X00610000
               MF=(E,WK256),PRINT=NOGEN                                 00620000
                                                                        00630000
         EJECT ,                                                        00640000
IINFOX   #ENTER PREG=R8                                                 00650000
                                                                        00660000
         USING ITASK,R10          PROCESS MODE                          00670000
         L     R9,TSKPCBC                                               00680000
         USING IPCB,R9                                                  00690000
         L     R7,PCBUSER         ADDRESS OF IUSER                      00700000
         USING IUSER,R7           ADDRESSABILITY                        00710000
                                                                        00720000
*--------------------------------------------------------------         00730000
*                                                                       00740000
*   POST CLIENT TYPE AND VERSION TO IUSER BLOCK                         00750000
*                                                                       00760000
*--------------------------------------------------------------         00770000
                                                                        00780000
         USING XINFO,R8           INFORMATION EXCHANGE REQUEST          00790000
                                                                        00800000
         MVC   USRTYPE,XINFTYPE   CLIENT USER TYPE                      00810000
         MVC   USRCLVER,XINFVER   CLIENT VERSION                        00820000
                                                                        00830000
*--------------------------------------------------------------         00840000
*                                                                       00850000
*   INTEGRATOR USER STARTED MESSAGE                                     00860000
*                                                                       00870000
*--------------------------------------------------------------         00880000
                                                                        00890000
         USING VERSION,XINFVER                                          00900000
                                                                        00910000
         MVC   CLITYPE,=CL10'Runtime'    Assume Runtime user            00920000
                                                                        00930000
         CLI   XINFTYPE,XINFT_WB         Workbench?                     00940000
         BNE   *+10                      NO, continue                   00950000
         MVC   CLITYPE,=CL10'Workbench'  Workbench user                 00960000
                                                                        00970000
         CLI   XINFTYPE,XINFT_OP         Operator?                      00980000
         BNE   *+10                      NO, continue                   00990000
         MVC   CLITYPE,=CL10'Operator'   Operator user                  01000000
                                                                        01010000
         $MSG  001,FIELDS=(CLITYPE,PCBNAME,                            +01020000
               VERID,VERRLSE,VERMODLV,VERTYPE)                          01030000
                                                                        01040000
         EJECT                                                          01050000
*--------------------------------------------------------------         01060000
*                                                                       01070000
*   Adjust task priority depending upon user type                       01080000
*                                                                       01090000
*--------------------------------------------------------------         01100000
         LA    R3,CHAPTB#         NUMBER OF ENTRIES IN CHAP TBL         01110000
         LA    R2,CHAPTAB         CHAP TABLE ORIGIN                     01120000
                                                                        01130000
CHAP_NXT DS    0H                                                       01140000
         CLC   USRTYPE,0(R2)      SPECIFIED USER TYPE                   01150000
         BE    CHAP_SET           GO SET TASK PRIORITY                  01160000
         LA    R2,L'CHAPTAB(,R2)  ADDRESS OF NEXT ENTRY                 01170000
         BCT   R3,CHAP_NXT        NEXT ENTRY TYPE                       01180000
         B     INFO_RSP           CONTINUE WITH INFO RESPONSE           01190000
                                                                        01200000
CHAP_SET DS    0H                                                       01210000
         SR    R4,R4              PREPARE FOR INSERT                    01220000
         ICM   R4,1,1(R2)         OBTAIN DISP PRIO MODIFIER             01230000
         BZ    INFO_RSP           ZERO, CONTINUE WITH INFO RESP         01240000
                                                                        01250000
         $TASK CHAP,DPMOD=(R4),MF=(E,$TSK_MFL)                          01260000
                                                                        01270000
         EJECT                                                          01280000
*--------------------------------------------------------------         01290000
*                                                                       01300000
*   CONSTRUCT RESPONSE BUFFER IF NOT MANAGED BY CALLER                  01310000
*                                                                       01320000
*--------------------------------------------------------------         01330000
INFO_RSP DS    0H                                                       01340000
         TM    INFFLG0,INFF0TXP   TXP BUFFER MANAGED BY SCHEDULER?      01350000
         BO    ETXPINIT           SKIP INITIALIZATION IF SO             01360000
                                                                        01370000
         LA    R2,YINFRSPL        LENGTH OF RESPONSE AREA               01380000
                                                                        01390000
         $XPBUFR INIT,SIZE=(R2),XH=XINFO                                01400000
         BNZ   ABE_TXP                                                  01410000
                                                                        01420000
ETXPINIT DS    0H                 INSERT REQUEST BLOCK                  01430000
         $XPBUFR ISRT,DATALEN=YINFRSPL,NEWFUNC=(*INFFUNC,*INFSFNC)      01440000
         BNZ   ABE_TXP                                                  01450000
         LR    R5,R1              RESPONSE BLOCK ADDR                   01460000
         USING YINFRESP,R5        LIFE OF FUNCTION ADDRESSBILITY        01470000
         XC    YINFRESP(YINFRSPL),YINFRESP                              01480000
                                                                        01490000
         $XPBUFR ISRT,DATALEN=YINXRSPL                                  01500000
         BNZ   ABE_TXP                                                  01510000
         LR    R6,R1              RESPONSE BLOCK ADDR                   01520000
         USING YINFRSPX,R6        LIFE OF FUNCTION ADDRESSBILITY        01530000
         XC    YINFRSPX(YINXRSPL),YINFRSPX                              01540000
                                                                        01550000
         MVC   YINFXOFF,=AL2(YINFRSPL)  OFFSET TO INFO RESP EXT         01560000
         MVC   YINFTASK,TSKNAME   ITASK/LUNAME                          01570000
         MVC   YINFJOBN,ICTJOBNM  INTEGRATOR JOBNAME                    01580000
                                                                        01590000
         MVC   YINFVERX,ICTRLSE   INTEGRATOR SERVER RELEASE LEVEL       01600000
                                                                        01610000
*--------------------------------------------------------------         01620000
*  Determine Session type                                               01630000
*--------------------------------------------------------------         01640000
         L     R1,USRAPPL         ADDRESS OF APPL BLOCK                 01650000
         USING APPL,R1            ADDRESSABILITY                        01660000
         L     R1,APLPSESS        ADDRESS OF PSESS BLOCK                01670000
         USING PSESS,R1           ADDRESSABILITY                        01680000
                                                                        01690000
         MVC   YINFLUTY,PSSLUTYP  LUTYPE                                01700000
                                                                        01710000
         MVC   YINFAPPL,=CL8'N/A' APPLID NOT APPLICABLE FOR TCP/IP      01720000
         CLI   YINFLUTY,YINFLT_T  TCP/IP CONNECTION?                    01730000
         BE    TCPIP              YES, GET PORT AND SOCKET ID           01740000
                                                                        01750000
         MVC   YINFAPPL,ICTAPL62  INTEGRATOR LU6.2 APPLID               01760000
         CLI   YINFLUTY,YINFLT_6  LU 6.2 CONNECTION?                    01770000
         BE    XPBF_SND           YES, SEND XPBUFFER IF REQUIRED        01780000
         MVC   YINFAPPL,ICTAPLID  INTEGRATOR APPLID (DEFAULT)           01790000
                                                                        01800000
         CLI   YINFLUTY,YINFLT_0  LU0 CONNECTION                        01810000
         BE    MODCHECK           GET MODEL TYPE                        01820000
         CLI   YINFLUTY,YINFLT_2  LU2 CONNECTION                        01830000
         BNE   XPBF_SND           NO, SEND XPBUFFER IF REQUIRED         01840000
                                                                        01850000
*--------------------------------------------------------------         01860000
*  Determine 3270 Model type                                            01870000
*--------------------------------------------------------------         01880000
MODCHECK DS    0H                                                       01890000
         MVI   YINFMODL,YINFMOD2  ASSUME MOD-2                          01900000
         CLC   PSSBUFSZ,=A(MOD2)  3270 MOD-2 SESSION                    01910000
         BE    XPBF_SND           CONTINUE                              01920000
                                                                        01930000
         MVI   YINFMODL,YINFMOD3  ASSUME MOD-3                          01940000
         CLC   PSSBUFSZ,=A(MOD3)  3270 MOD-3 SESSION                    01950000
         BE    XPBF_SND           CONTINUE                              01960000
                                                                        01970000
         MVI   YINFMODL,YINFMOD4  ASSUME MOD-4                          01980000
         CLC   PSSBUFSZ,=A(MOD4)  3270 MOD-4 SESSION                    01990000
         BE    XPBF_SND           CONTINUE                              02000000
                                                                        02010000
         MVI   YINFMODL,YINFMOD5  ASSUME MOD-5                          02020000
         CLC   PSSBUFSZ,=A(MOD5)  3270 MOD-5 SESSION                    02030000
         BE    XPBF_SND           CONTINUE                              02040000
                                                                        02050000
         MVI   YINFMODL,0         RESET TO DEFAULT                      02060000
         BE    XPBF_SND           CONTINUE                              02070000
                                                                        02080000
*--------------------------------------------------------------         02090000
*  Retrieve TCP/IP protocol information                                 02100000
*--------------------------------------------------------------         02110000
TCPIP    DS    0H                                                       02120000
         L     R1,PSSCOMM@        COMMUNICATION BLOCK ADDRESS           02130000
         USING XPTCIP,R1          TEMP ADDRESSABILITY                   02140000
         MVC   YINXTCIP,XPTCHADX  TCP/IP HOST ADDRESS (CHAR FORMAT)     02150000
         MVC   YINXPORT,XPTCHPRT  TCP/IP HOST PORT                      02160000
         MVC   YINXUSOC,XPTCSOCK  TCP/IP HOST SOCKET                    02170000
         DROP  R1                                                       02180000
                                                                        02190000
*--------------------------------------------------------------         02200000
*   DISPOSE OF TXP BUFR IF ITS MANAGEMENT IS OUR RESPONSIBILITY         02210000
*--------------------------------------------------------------         02220000
XPBF_SND DS    0H                                                       02230000
         TM    INFFLG0,INFF0TXP   TXP BUFFER MANAGED BY SCHEDULER?      02240000
         BO    ENDTXP             XMIT AND FREE ARE DEFERRED            02250000
                                                                        02260000
         $XPBUFR XMIT             TRANSMIT AND FREE                     02270000
         BNZ   ABE_TXP                                                  02280000
                                                                        02290000
ENDTXP   DS    0H                                                       02300000
                                                                        02310000
         EJECT                                                          02320000
***************************************************************         02330000
*                                                                       02340000
*   RETURN TO REQUEST SCHEDULER                                         02350000
*                                                                       02360000
***************************************************************         02370000
RETURN   DS    0H                                                       02380000
         LA    R15,RC00           REFLECT SECURITY TEST RESULTS         02390000
                                                                        02400000
         #EXIT ,                                                        02410000
                                                                        02420000
         EJECT                                                          02430000
***************************************************************         02440000
*                                                                       02450000
* CATASTROPIC ERRORS                                                    02460000
*                                                                       02470000
***************************************************************         02480000
ABE_TXP  DS    0H                                                       02490000
         $ABEND ABE_TXPSERV,DUMP=YES,                                  X02500000
               TITLE='TXP BUFFER SERVICE FAILURE'                       02510000
                                                                        02520000
         EJECT ,                                                        02530000
***************************************************************         02540000
*                                                                       02550000
*   LOCAL READ ONLY DATA AREAS, ETC.                                    02560000
*                                                                       02570000
***************************************************************         02580000
                                                                        02590000
MOD2     EQU   24*80              3270 TERMINAL MODEL BUFSIZE           02600000
MOD3     EQU   32*80                                                    02610000
MOD4     EQU   43*80                                                    02620000
MOD5     EQU   27*132                                                   02630000
                                                                        02640000
*-------------------------------------------------------------          02650000
*  Dispatch Priority Modifier for user types                            02660000
*-------------------------------------------------------------          02670000
CHAPTAB  DS    0H                                                       02680000
         DC    AL1(USRTY_RT,0)    RUNTIME USER                          02690000
         DC    AL1(USRTY_WB,5)    WORKBENCH USER                        02700000
         DC    AL1(USRTY_OP,10)   HELPDESK USER                         02710000
CHAPTB#  EQU   (*-CHAPTAB)/L'CHAPTAB                                    02720000
                                                                        02730000
         LTORG ,                                                        02740000
                                                                        02750000
         EJECT                                                          02760000
         PRINT NOGEN                                                    02770000
         ICVT  ,                                                        02780000
         ITASK ,                                                        02790000
         IPCB  ,                                                        02800000
         IUSER ,                                                        02810000
         PSESS ,                                                        02820000
         XPTCIP ,                                                       02830000
         APPL  ,                                                        02840000
         XPORTHDR HDRTYPE=COMMON                                        02850000
                                                                        02860000
         END   ,                                                        02870000

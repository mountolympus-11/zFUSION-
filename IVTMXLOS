IVTMXLOS TITLE 'INTEGRATOR - VTAM LOSTERM EXIT'                         00010000
**<DOC-ON>************************************************************* 00020000
*                                                                       00030000
* ROUTINE: IVTMXLOS - INTEGRATOR VTAM LOSTERM EXIT                      00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THE LOSTERM EXIT IS DRIVEN BY VTAM TO HANDLE REQUESTS              00080000
*    FOR SESSION TERMINATION OR TO NOTIFY THE APPLICATION               00090000
*    THAT A SESSION OUTAGE HAS OCCURRED.                                00100000
*    THE INTEGRATOR ALSO PROVIDES AN NSEXIT AND A SCIP EXIT             00110000
*    WHICH WILL SUPERCEDE THE LOSTERM EXIT FOR MANY                     00120000
*    SESSION OUTAGE CONDITIONS.                                         00130000
*                                                                       00140000
*    A LOSTERM WORK ELEMENT IS CREATED.  IF THE ASSOCIATED ISESS        00150000
*    IS AVAILABLE, THE ELEMENT IS QUEUED TO THE SESSION WORK            00160000
*    QUEUE FOR PROCESSING.  OTHERWISE, THE ELEMENT IS QUEUED TO         00170000
*    THE VTAM MAIN TASK WORK QUEUE FOR A DIAGNOSTIC DUMP.               00180000
*                                                                       00190000
* ON ENTRY:                                                             00200000
*                                                                       00210000
*    BAKR IS USED TO SAVE REGISTERS.                                    00220000
*                                                                       00230000
*    R15 = ENTRY POINT ADDRESS                                          00240000
*    R14 = RETURN ADDRESS                                               00250000
*    R01 = PARAMETER LIST ADDRESS                                       00260000
*          +00(4): ADDRESS OF ACB                                       00270000
*          +04(4): CID OF ASSOCIATED SESSION                            00280000
*          +08(4): NIB USERFLD OF ASSOCIATED SESSION                    00290000
*          +0C(4): LOSTERM REASON CODE                                  00300000
*          +10(4): RESERVED (UNUSED)                                    00310000
*          +14(4): RESERVED (UNUSED)                                    00320000
*                                                                       00330000
* ON EXIT:                                                              00340000
*                                                                       00350000
*    R15 = 0                                                            00360000
*    R00 = 0                                                            00370000
*    R01 = 0                                                            00380000
*                                                                       00390000
*    ALL OTHER REGISTERS ARE RESTORED BY PR.                            00400000
*                                                                       00410000
**<DOC-OFF>************************************************************ 00420000
                                                                        00430000
         EJECT ,                                                        00440000
*********************************************************************** 00450000
*                                                                       00460000
* MAINTENANCE:                                                          00470000
*                                                                       00480000
*   08/01/93 RANDY WITEK                                                00490000
*                                                                       00500000
*********************************************************************** 00510000
         EQUS  ,                  GENERAL EQUATES                       00520000
                                                                        00530000
RICVT    EQU   R11                INTEGRATOR CVT POINTER                00540000
RITASK   EQU   R10                ASSOCIATED ITASK POINTER              00550000
RIVTAM   EQU   R9                 INTEGRATOR VTAM CVT POINTER           00560000
RIACB    EQU   R8                 ASSOCIATED IACB POINTER               00570000
RIRPL    EQU   R7                 ASSOCIATED RPL/IRPL POINTER           00580000
RISESS   EQU   R6                 ASSOCIATED ISESS POINTER              00590000
RIWE     EQU   R5                 WORK ELEMENT POINTER                  00600000
                                                                        00610000
         USING ICVT,RICVT         ESTABLISH ADDRESSIBILTY               00620000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSIBILTY               00630000
         USING ITASK,RITASK       ESTABLISH ADDRESSIBILTY               00640000
         USING IACB,RIACB         ESTABLISH ADDRESSIBILTY               00650000
         USING IRPL,RIRPL         ESTABLISH ADDRESSIBILTY               00660000
         USING IWEVTAM,RIWE       ESTABLISH ADDRESSIBILTY               00670000
         USING ISESS,RISESS       ESTABLISH ADDRESSIBILTY               00680000
                                                                        00690000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00700000
         DS    0D                                                       00710000
RCVPARMS DS    XL(L'IVR)          IVTAMRPA STORAGE                      00720000
ESTAEMFL DS    XL(L'ESTAEXPL)     PARMLIST CONSTRUCTION                 00730000
FRRPARM  DS    A                  RETURN AREA FOR FRR PARM ADDRESS      00740000
SAVER3   DS    F                  TEMPORARY SAVE AREA                   00750000
RETR15   DS    F                  RETURN CODE VALUE                     00760000
RETR0    DS    F                  RETURN REGISTER 0                     00770000
RETR1    DS    F                  RETURN REGISTER 1                     00780000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00790000
FLAG     DS    X                                                        00800000
FLESTAEX EQU   X'08'              ESTAEX ACTIVE                         00810000
FLFRR    EQU   X'04'              FRR    ACTIVE                         00820000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00830000
                                                                        00840000
IVTMXLOS #VTENTER BASE=R12,       VTAM EXIT ROUTINE LINKAGE            +00850000
               AMODE=31,                                               +00860000
               RMODE=ANY,                                              +00870000
               PREG=(R3),                                              +00880000
               EXITYPE=PLIST                                            00890000
                                                                        00900000
         USING IVTAMRPA,RCVPARMS  ESTABLISH ADDRESSIBILITY              00910000
                                                                        00920000
*---------------------------------------------------------------------- 00930000
* ESTABLISH RECOVERY ENVIRONMENT                                        00940000
*---------------------------------------------------------------------- 00950000
                                                                        00960000
         ST    R3,SAVER3          SAVE PARM REG                         00970000
         LA    R15,IVTXRTRY       RETRY ROUTINE ADDRESS                 00980000
         ST    R15,IVRRETAD       SET RETRY ROUTINE ADDRESS             00990000
         LA    R15,IVTAMRPA       PARAMETERS ADDRESS                    01000000
         ST    R15,IVRRPA@        SET ADDRESS FOR FRR                   01010000
         L     R0,=F'-1'          SHOW REGS RESTORED FROM PARM AREA     01020000
         STM   R0,R15,IVRR00      SAVE RETRY REGISTERS                  01030000
         MVC   IVRMOD,=CL8'IVTMTASK'                                    01040000
         MVC   IVRCSECT,=CL8'IVTMXLOS'                                  01050000
         MVC   IVRFRR,=CL8'IVTMXRCV'                                    01060000
         MVC   IVRTYPE,=CL8'ESTAEX'                                     01070000
         L     R3,=V(IVTMXRCV)    ADDR OF VTAM EXIT RECOVERY ROUTINE    01080000
         ICM   R0,15,PSATOLD      SRB MODE?                             01090000
         BZ    ESTFRR             BRANCH IF YES                         01100000
                                                                        01110000
         MVC   ESTAEMFL(L'ESTAEXPL),ESTAEXL                             01120000
                                                                        01130000
         ESTAEX (R3),                                                  +01140000
               CT,                                                     +01150000
               PARAM=RCVPARMS,                                         +01160000
               TERM=YES,                                               +01170000
               MF=(E,ESTAEMFL)    ESTABLISH RECOVERY                    01180000
                                                                        01190000
         OI    FLAG,FLESTAEX      RECOVERY ENVIRONMENT ESTABLISHED      01200000
         B     RECOVSET           AND CONTINUE                          01210000
                                                                        01220000
ESTFRR   DS    0H                                                       01230000
                                                                        01240000
         MVC   IVRTYPE,=CL8'FRR'                                        01250000
                                                                        01260000
         MODESET EXTKEY=ZERO,                                          +01270000
               SAVEKEY=(2)        SET KEY ZERO                          01280000
                                                                        01290000
         SETFRR A,                                                     +01300000
               FRRAD=(R3),                                             +01310000
               WRKREGS=(14,15),                                        +01320000
               PARMAD=FRRPARM     ESTABLISH RECOVERY                    01330000
                                                                        01340000
         L     R1,FRRPARM         PARM AREA FOR FRR                     01350000
         MVC   0(12,R1),RCVPARMS  SET TYPE & PARM AREA POINTER          01360000
                                                                        01370000
         MODESET KEYADDR=(2)      RESTORE PREVIOUS KEY                  01380000
                                                                        01390000
         OI    FLAG,FLFRR         RECOVERY ENVIRONMENT ESTABLISHED      01400000
         B     RECOVSET           AND CONTINUE                          01410000
                                                                        01420000
RECOVSET DS    0H                                                       01430000
                                                                        01440000
         L     R3,SAVER3          RESTORE PARM REG                      01450000
                                                                        01460000
*---------------------------------------------------------------------- 01470000
* ACCESS ISESS VIA NIB USERFLD AND VALIDATE USING VTAM CID.             01480000
*---------------------------------------------------------------------- 01490000
                                                                        01500000
         L     RISESS,8(,R3)      NIB USRFLD IS ISESS ADDRESS           01510000
         OI    IVRF1,IVRF1IVI     ISESS VALIDATION IN PROGRESS          01520000
         CLC   ISEID,=CL8'ISESS'  CHECK EYECATCHER                      01530000
         BNE   QTOMAIN            BRANCH IF NOT GOOD                    01540000
         CLC   ISECID,4(R3)       DO THE CID'S MATCH?                   01550000
         BNE   QTOMAIN            QUEUE LOSTERM TO VTAM MAIN TASK       01560000
         NI    IVRF1,255-IVRF1IVI ISESS VALIDATION COMPLETE             01570000
         LA    R4,ISEWEQ          USE THE ISESS WORK QUEUE              01580000
         L     RITASK,ISEITASK    GET ITASK POINTER FROM ISESS          01590000
         B     TRACE              GO CREATE THE WORK ELEMENT            01600000
                                                                        01610000
*---------------------------------------------------------------------- 01620000
* ISESS WASN'T FOUND, SO SEND THE LOSTERM TO THE MAIN TASK              01630000
*---------------------------------------------------------------------- 01640000
                                                                        01650000
QTOMAIN  DS    0H                                                       01660000
                                                                        01670000
         NI    IVRF1,255-IVRF1IVI ISESS VALIDATION COMPLETE             01680000
         SR    RISESS,RISESS      SHOW NO ISESS                         01690000
         LA    R4,IVTWEQ          USE THE VTAM MAIN WORK QUEUE          01700000
                                                                        01710000
*---------------------------------------------------------------------- 01720000
* TRACE THE MODULE ENTRY                                                01730000
*---------------------------------------------------------------------- 01740000
                                                                        01750000
TRACE    DS    0H                                                       01760000
                                                                        01770000
         $TRACE *=A(TRC_IVTMXLOS),32,STDENV=NO        32 USER BYTES     01780000
                                                                        01790000
         BNZ   NOMTRACE           BRANCH IF TRACING NOT AVAILABLE       01800000
                                                                        01810000
         ST    RITASK,0(,R1)      TRACE ITASK                           01820000
         ST    RISESS,4(,R1)      TRACE ISESS                           01830000
         ST    RIACB,8(,R1)       TRACE IACB                            01840000
         MVC   12(4,R1),4(R3)     TRACE THE CID                         01850000
         MVC   16(4,R1),12(R3)    TRACE LOSTERM REASON CODE             01860000
         MVC   20(4,R1),8(R3)     TRACE PARM LIST USERFLD               01870000
                                                                        01880000
NOMTRACE DS    0H                                                       01890000
                                                                        01900000
*---------------------------------------------------------------------- 01910000
* ALLOCATE LOSTERM WORK ELEMENT                                         01920000
*---------------------------------------------------------------------- 01930000
                                                                        01940000
         $VTAMWE L'IWEX3,         SIZE                                 +01950000
               IWECXLOS           CODE                                  01960000
                                                                        01970000
         LR    RIWE,R1                                                  01980000
                                                                        01990000
*---------------------------------------------------------------------- 02000000
* BUILD LOSTERM WORK ELEMENT                                            02010000
*---------------------------------------------------------------------- 02020000
                                                                        02030000
         ST    RIACB,IWEX3ACB     SET ACB ADDRESS                       02040000
         MVC   IWEX3CID,4(R3)     SET CID                               02050000
         MVC   IWEX3USR,8(R3)     SET USERFLD                           02060000
         MVC   IWEX3RC,12(R3)     LOSTERM REASON CODE                   02070000
                                                                        02080000
*---------------------------------------------------------------------- 02090000
* QUEUE LOSTERM WORK ELEMENT TO VTAM MAIN/SESSION ITASK                 02100000
*---------------------------------------------------------------------- 02110000
                                                                        02120000
         $VTAMQ (RIWE),           WORK ELEMENT                         +02130000
               (R4),              QUEUE                                +02140000
               STDENV=NO          EXIT ROUTINE                          02150000
                                                                        02160000
         B     RETURN                                                   02170000
                                                                        02180000
*---------------------------------------------------------------------- 02190000
* RETRY ROUTINE SCHEDULED BY RECOVERY                                   02200000
*---------------------------------------------------------------------- 02210000
                                                                        02220000
IVTXRTRY DS    0H                                                       02230000
                                                                        02240000
         LTR   R0,R0              WERE REGISTERS RESTORED FOR RETRY?    02250000
         BM    REGSOK             BRANCH IF YES, READY TO EXIT          02260000
X        USING IVTAMRPA,R1        PARM AREA ADDRESS MUST BE IN R1       02270000
         LM    R0,R15,X.IVRR00    RESTORE ALL THE REGISTERS             02280000
         DROP  X                                                        02290000
                                                                        02300000
REGSOK   DS    0H                                                       02310000
                                                                        02320000
         ICM   R0,15,PSATOLD      SRB MODE?                             02330000
         BNZ   RETURN             BRANCH IF NOT                         02340000
         ICM   R1,B'0001',=X'80'  KEY 8 IN BITS 24-27                   02350000
         MODESET KEYREG=(R1)      SET KEY 8                             02360000
         B     RETURN             AND WE ARE READY TO EXIT              02370000
                                                                        02380000
*---------------------------------------------------------------------- 02390000
* RETURN TO VTAM FROM EXIT ROUTINE                                      02400000
*---------------------------------------------------------------------- 02410000
                                                                        02420000
RETURN   DS    0H                                                       02430000
                                                                        02440000
         TM    FLAG,FLESTAEX      IS ESTAEX ESTABLISHED?                02450000
         BNO   RETFRR             BRANCH IF NOT                         02460000
                                                                        02470000
         ESTAEX 0                 DELETE RECOVERY ENVIRONMENT           02480000
                                                                        02490000
         NI    FLAG,255-FLESTAEX  CLEAR FLAG                            02500000
         B     EXITNOW            AND EXIT                              02510000
                                                                        02520000
RETFRR   DS    0H                                                       02530000
                                                                        02540000
         TM    FLAG,FLFRR         IS FRR ESTABLISHED?                   02550000
         BNO   EXITNOW            BRANCH IF NOT                         02560000
                                                                        02570000
         MODESET EXTKEY=ZERO,                                          +02580000
               SAVEKEY=(2)        SET KEY ZERO                          02590000
                                                                        02600000
         SETFRR D,                                                     +02610000
               WRKREGS=(14,15)    DELETE RECOVERY ENVIRONMENT           02620000
                                                                        02630000
         MODESET KEYADDR=(2)      RESTORE PREVIOUS KEY                  02640000
                                                                        02650000
         NI    FLAG,255-FLFRR     CLEAR FLAG                            02660000
         B     EXITNOW            AND EXIT                              02670000
                                                                        02680000
EXITNOW  DS    0H                                                       02690000
                                                                        02700000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 02710000
                                                                        02720000
         #VTEXIT ,                RETURN                                02730000
                                                                        02740000
*---------------------------------------------------------------------- 02750000
*  CONSTANTS AND LITERALS                                               02760000
*---------------------------------------------------------------------- 02770000
                                                                        02780000
ESTAEXL  ESTAEX *-*,CT,MF=L       ESTAEX PLIST                          02790000
ESTAEXPL EQU   ESTAEXL,*-ESTAEXL                                        02800000
                                                                        02810000
         LTORG ,                                                        02820000
         PRINT NOGEN                                                    02830000
         IVTAMRPA ,               INTEGRATOR VTAM RECOVERY PARAMETERS   02840000
         IHAFRRS ,                MVS FRR STACK                         02850000
         IHAPSA ,                 MVS PREFIXED STORAGE AREA             02860000
         ISTDBIND ,               VTAM BIND IMAGE                       02870000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         02880000
         ICVT  ,                  INTEGRATOR CVT                        02890000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   02900000
         ITASK ,                  INTEGRATOR TASK BLOCK                 02910000
         IACB ,                   INTEGRATOR VTAM ACB+                  02920000
         IRPL ,                   INTEGRATOR VTAM RPL+                  02930000
         INIB ,                   INTEGRATOR VTAM NIB+                  02940000
         ISESS ,                  INTEGRATOR SESSION BLOCK              02950000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            02960000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          02970000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       02980000
         EVCODES ,                INTEGRATOR EVENT CODES                02990000
         ABCODES ,                INTEGRATOR $ABEND CODES               03000000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     03010000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             03020000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             03030000
         IFGEXLST ,               VTAM EXIT LIST                        03040000
         END   ,                                                        03050000

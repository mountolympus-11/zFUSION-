ITRCREC  TITLE '- ACQUIRE TRACE TABLE ENTRY'                            00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: ITRCREC - Acquire trace table entry                          00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine is used to acquire and initialize a trace             00080000
*    table entry of the size and entry type provided by the             00090000
*    caller.  The size passed is rounded upwards to an entry            00100000
*    allocation unit boundary.  Upon successful completion,             00110000
*    the caller is expected to (quickly) complete the user              00120000
*    entry area returned via R1.                                        00130000
*                                                                       00140000
*    Trace records are identified by a trace class and code.            00150000
*    Normally, trace table entries are allocated only for               00160000
*    active trace classes.  However, if FORCE=YES is coded              00170000
*    in the $TRACE request, an entry is always allocated.               00180000
*                                                                       00190000
*    Trace class suppression                                            00200000
*    -----------------------                                            00210000
*                                                                       00220000
*    Trace class suppression indicators are maintained in the           00230000
*    ITASK to prevent unproductive calls to the trace record            00240000
*    evaluate/allocate routine ($TRACE).  Bits corresponding to         00250000
*    the 256 trace class codes are set in TSKTRSMY to indicate          00260000
*    that the trace class has been suppressed for the system or         00270000
*    workunit.  Whenever any events are globally enabled,               00280000
*    ICTTRCSQ is incremented to indicate that the trace record          00290000
*    evaluate/allocate routine must receive control to evaluate         00300000
*    each trace class reference.  If trace events are changed           00310000
*    at the ITASK level (via TASK(taskname)) TSKTRSMY is                00320000
*    cleared to force reevaluation of each trace class as it            00330000
*    is referenced.                                                     00340000
*                                                                       00350000
*                                                                       00360000
* NOTES:                                                                00370000
*                                                                       00380000
*    BAKR linkage                                                       00390000
*                                                                       00400000
*                                                                       00410000
* ON ENTRY:                                                             00420000
*                                                                       00430000
*    R1 - addr of workunit to which trace event applies or zero.        00440000
*         The high order bit of the workunit address is set for         00450000
*         FORCE=YES requests.                                           00460000
*                                                                       00470000
*         The low order bit of the workunit address is set if           00480000
*         STDENV=NO is specified in the $TRACE request to               00490000
*         indicate that restoration of STDENV is required in            00500000
*         this routine.  Note that workunit addresses always            00510000
*         fall on even boundaries.                                      00520000
*                                                                       00530000
*    R0 - high order halfword: event code (class,code)                  00540000
*         low  order halfword: size of user area required (>= 0)        00550000
*                                                                       00560000
*                                                                       00570000
* ON EXIT:                                                              00580000
*                                                                       00590000
*    R15 contains one of the following return codes                     00600000
*                                                                       00610000
*        RC00 - request complete                                        00620000
*                                                                       00630000
*               R1 - addr of trace entry user data area                 00640000
*                                                                       00650000
*        RC04 - trace facility disabled or event class not active       00660000
*                                                                       00670000
*        RC08 - invalid request                                         00680000
*                                                                       00690000
**<DOC-OFF>****************************************************         00700000
                                                                        00710000
         EJECT                                                          00720000
***************************************************************         00730000
*                                                                       00740000
* MAINTENANCE:                                                          00750000
*                                                                       00760000
*    11/21/94 R. Turgeon                                                00770000
*             Added FORCE=YES capability allowing special trace         00780000
*             records to be cut regardless of class activation.         00790000
*                                                                       00800000
*    01/21/95 R. Turgeon                                                00810000
*             Changed to eliminate MVCL used to zero the                00820000
*             allocated entry.  Now, only the standard header           00830000
*             is guaranteed to be clear.                                00840000
*                                                                       00850000
*    11/04/95 R. Turgeon      Rel 2.1                                   00860000
*             Changed entry conventions allowing this routine           00870000
*             to be entered directly by a non_STDENV caller.            00880000
*                                                                       00890000
*    11/08/95 R. Turgeon      Rel 2.1                                   00900000
*             Implement filtering logic that can be used to             00910000
*             prevent calls to ITRCREC when it can be determined        00920000
*             that tracing is suppress for the designated               00930000
*             trace class.                                              00940000
*                                                                       00950000
*    11/21/95 R. Turgeon      Rel 2.1                                   00960000
*             Add server-ITASK identifier and physical CPU              00970000
*             address to trace record header.                           00980000
*                                                                       00990000
***************************************************************         01000000
                                                                        01010000
         EJECT                                                          01020000
         TRTABLE ,                TRACE TABLE MAPPINGS                  01030000
                                                                        01040000
         EJECT                                                          01050000
         EQUS  ,                                                        01060000
                                                                        01070000
         EJECT                                                          01080000
ITRCREC  #ENTER SAVE=NO,PREG=(R3,R4),LINKAGE=BAKR                       01090000
                                                                        01100000
***************************************************************         01110000
*                                                                       01120000
*   Restore STDENV when entered from non-standard environments.         01130000
*   Note that storage references are tricky until the SAC is            01140000
*   issued in that case.                                                01150000
*                                                                       01160000
***************************************************************         01170000
                                                                        01180000
         USING PSA,R0             PREFIXED STORAGE AREA                 01190000
         ICM   R0,15,PSATOLD      TASK MODE?                            01200000
         BNZ   *+6                SKIP IF SO                            01210000
         SR    R10,R10            STANDARD SRB INDICATOR                01220000
                                                                        01230000
         EX    R3,LOWORDER        LOW ORDER WU ADDR FLAG BIT SET?       01240000
         BNO   STDENV             CALLER IS STDENV OTHERWISE            01250000
         SRL   R3,1               DROP THE FLAG                         01260000
         SLL   R3,1                                                     01270000
                                                                        01280000
         SAC   0                  ASC=P                                 01290000
                                                                        01300000
         @RESTENV ,               STDENV                                01310000
                                                                        01320000
STDENV   DS    0H                                                       01330000
                                                                        01340000
         USING ICVT,R11           STANDARD ENVIRONMENT, EVENTUALLY      01350000
         USING ITASK,R10          TASK MODE, POSSIBLY                   01360000
                                                                        01370000
         EJECT                                                          01380000
***************************************************************         01390000
*                                                                       01400000
*   Workunit to which request is charged may or may not be              01410000
*   the current workunit                                                01420000
*                                                                       01430000
***************************************************************         01440000
                                                                        01450000
         LR    R5,R3              WORKUNIT ADDR / FORCE FLAG            01460000
         LA    R3,0(,R3)          CLEAR FLAG BIT                        01470000
         LTR   R3,R3              WORKUNIT ADDR PROVIDED?               01480000
         BZ    STDWU              SKIP IF NOT                           01490000
                                                                        01500000
         USING @CB,R3             STANDARD WORKUNIT CB PREFIX           01510000
                                                                        01520000
         LR    R10,R3             ASSUME ITS AN ITASK                   01530000
         CLC   @CBID,=CL8'ITASK'  ASSUMPTION CORRECT?                   01540000
         BE    STDWU              OVERRIDE STDENV REG IF SO             01550000
                                                                        01560000
         CLC   @CBID,=CL8'IPCB'   PROCESS GIVEN?                        01570000
         BE    *+8                ASSERT VALID WORKUNIT PROVIDED        01580000
         EX    R0,*               ASSERTION DENIED                      01590000
         L     R10,PCBTASK-IPCB(,R3)  TRACE SUPPORT AT ITASK LEVEL      01600000
         DROP  R3                 @CB / WORKUNIT                        01610000
                                                                        01620000
*--------------------------------------------------------------         01630000
*   Identify mode, resync ICVT / ITASK trace suppression flags          01640000
*--------------------------------------------------------------         01650000
                                                                        01660000
STDWU    DS    0H                                                       01670000
         LTR   R9,R10             REQUEST CHARGED TO ITASK?             01680000
         BZ    ENDMODE            SRB MODE OTHERWISE                    01690000
         L     R9,TSKPCBC         CURRENT PCB OR ZERO IF ITASK MODE     01700000
                                                                        01710000
         L     R0,ICTTRCSQ        GLOBAL TRACE CONFIG CHANGE ID         01720000
         C     R0,TSKTRCSQ        CHANGED SINCE LAST REQUEST?           01730000
         BE    ENDMODE            DONE IF NOT                           01740000
                                                                        01750000
         ST    R0,TSKTRCSQ        CHANGE OF CONFIG RECOGNIZED           01760000
         XC    TSKTRSMY,TSKTRSMY  RESET ITASK TRACE SUPPRESSION BITS    01770000
                                                                        01780000
ENDMODE  DS    0H                 R10 <== ITASK ORIGIN, ZERO IF SRB     01790000
                                                                        01800000
         EJECT                                                          01810000
***************************************************************         01820000
*                                                                       01830000
*   Extract request parameters and analyze                              01840000
*                                                                       01850000
***************************************************************         01860000
                                                                        01870000
         LR    R3,R4              MULTIPLE PARMS                        01880000
         N     R3,=X'0000FFFF'    ISOLATE USER AREA LENGTH              01890000
         SRL   R4,16              ISOLATE THE EVENT CLASS & CODE        01900000
                                                                        01910000
*--------------------------------------------------------------         01920000
*   Ignore request if trace or event class not active                   01930000
*--------------------------------------------------------------         01940000
                                                                        01950000
         TM    ICTSTAT2,ICT2$TRC  TRACING ACTIVE?                       01960000
         BNO   IGNORE             SUSPENDED AT THE MOMENT               01970000
                                                                        01980000
         ICM   R8,15,ICTRTPTR     TRACE TABLE HDR                       01990000
         BZ    IGNORE             NOT CREATED                           02000000
         USING TRTHDR,R8                                                02010000
                                                                        02020000
         LTR   R5,R5              FORCE=YES CODED?                      02030000
         BM    SELECTED           EVENT CLASS IS SELECTED IF SO         02040000
                                                                        02050000
         LR    R14,R4             EVENT CODE                            02060000
         SRL   R14,8              ISOLATE EVENT CLASS                   02070000
         LR    R15,R14            MODIFIABLE COPY OF CLASS              02080000
         SRL   R14,3              CONVERT CLASS TO BYTE OFFSET          02090000
         N     R15,=X'00000007'   BIT NUMBER WITHIN BYTE                02100000
                                                                        02110000
         LA    R6,X'80'           ASSUME BIT 0                          02120000
         SRL   R6,0(R15)          WALK BIT RIGHT AS NECESSARY           02130000
                                                                        02140000
         LR    R2,R14             EVENT CLASS MASK BYTE OFFSET          02150000
         A     R2,ICTRTECM        GLOBAL EVENT CLASS MASK BYTE ADDR     02160000
         EX    R6,TM_OF_R2        EVENT CLASS ENABLED?                  02170000
         BO    SELECTED           SELECTED IF SO                        02180000
                                                                        02190000
         LTR   R10,R10            ITASK AVAILABLE?                      02200000
         BZ    IGNORE             SKIP IF NOT                           02210000
         ICM   R2,15,TSKECM       EVENT CLASS MASK ATTACHED?            02220000
         BZ    IGNORE             SKIP IF NOT                           02230000
         AR    R2,R14             LOCATE EVENT CLASS MASK BYTE          02240000
         EX    R6,TM_OF_R2        EVENT CLASS ENABLED?                  02250000
         BNO   IGNORE             IGNORE IF NOT                         02260000
                                                                        02270000
*--------------------------------------------------------------         02280000
*   Validate request, reject if data area is too large                  02290000
*--------------------------------------------------------------         02300000
                                                                        02310000
SELECTED DS    0H                                                       02320000
         L     R7,TRTHCP          CURRENT VECTOR ENTRY                  02330000
         L     R7,0(,R7)          TRAVERSE TO TABLE DEFINITION          02340000
         USING TRTBDEF,R7         TABLE DEFINITION                      02350000
                                                                        02360000
         AH    R3,=AL2(TRENTFIX)  ACCOUNT FOR TRACE ENTRY HDR           02370000
         AL    R3,TRTHUNIT        ROUND USERDATA AREA TO ALLOC UNITS    02380000
         BCTR  R3,0               ROUNDING UP TO ALU BOUNDARY           02390000
         SR    R2,R2              PREPARE FOR DIVIDE                    02400000
         D     R2,TRTHUNIT        NUMBER OF UNITS IN R3                 02410000
         MH    R3,TRTHUNIT+2      BACK TO BYTES                         02420000
         C     R3,TRTBSIZE        TABLE LARGE ENOUGH?                   02430000
         BNL   ERROR              FAIL IF NOT                           02440000
         DROP  R8                 TRTHDR                                02450000
                                                                        02460000
*--------------------------------------------------------------         02470000
*   Reposition to top of table if current segment is too small          02480000
*--------------------------------------------------------------         02490000
                                                                        02500000
GETSLOT  DS    0H                                                       02510000
         LM    R14,R15,TRTBCS     NEXT (CURR) / LAST SLOT PTRS          02520000
         L     R5,TRTBEND         END OF TABLE                          02530000
         SR    R5,R14             LENGTH OF AREA AVAILABLE              02540000
         CR    R3,R5              AREA SUFFICIENT FOR USERS ENTRY?      02550000
         BNH   GETENTRY           SKIP IF SO                            02560000
                                                                        02570000
         LR    R0,R14             CURRENT POSITION JUST TESTED          02580000
         L     R14,TRTBORG        FORCE WRAP TO TOP OF TABLE            02590000
         LR    R1,R15             LAST VALID ENTRY UNCHANGED            02600000
         CDS   R0,R14,TRTBCS      REPOSITION                            02610000
         BNZ   GETSLOT            REPEAT IF MOVEMENT                    02620000
                                                                        02630000
*--------------------------------------------------------------         02640000
*   Acquire new entry                                                   02650000
*--------------------------------------------------------------         02660000
                                                                        02670000
GETENTRY DS    0H                                                       02680000
         LR    R1,R14             RETAIN SLOT FOR NEW 'LAST' ENTRY      02690000
         LA    R0,0(R3,R14)       UPDATE CURRENT ENTRY FOR NEXT PASS    02700000
         CDS   R14,R0,TRTBCS      EXTRACT THE SLOT                      02710000
         BNZ   GETSLOT            NUTS!                                 02720000
                                                                        02730000
*--------------------------------------------------------------         02740000
*   Initialize the entry, return user area to caller                    02750000
*--------------------------------------------------------------         02760000
                                                                        02770000
         USING TRENTRY,R14        ENTRY                                 02780000
         XC    TRENTRY(TRENTFIX),TRENTRY                                02790000
         STCK  TRETIME            INSERT TIME STAMP                     02800000
         ST    R10,TRETSK         TASK                                  02810000
         ST    R9,TREPCB          PROCESS                               02820000
         STH   R3,TRELENG         ENTRY LENGTH                          02830000
         STH   R4,TRETYPE         ENTRY TYPE                            02840000
         ST    R15,TREBLINK       BACK LINK                             02850000
                                                                        02860000
         LH    R0,PSACPUPA        PHYSICAL CPU ADDRESS                  02870000
         STH   R0,TRECPUPA                                              02880000
                                                                        02890000
         LTR   R10,R10            STDENV ITASK IDENTIFIED?              02900000
         BZ    NOTASK1            SKIP IF NOT                           02910000
         ICM   R15,15,TSKSVTSK    SERVER ITASK OR ZERO                  02920000
         BZ    NOTASK1                                                  02930000
         L     R15,TSKSRV-ITASK(,R15)     LOCATE SERVERX EXTENSION      02940000
         LH    R0,SRVIDNUM-SERVERX(,R15)  SERVER ID (INTEGER)           02950000
         STH   R0,TRESERVR                                              02960000
                                                                        02970000
NOTASK1  DS    0H                                                       02980000
         LA    R1,TREUSER         RETURN USER AREA ADDRESS              02990000
         LAE   R1,0(R1,0)         ALWAYS IN PSPACE                      03000000
         DROP  R14                TRENTRY                               03010000
                                                                        03020000
***************************************************************         03030000
*                                                                       03040000
*   Return allocation status to caller.  If the trace record            03050000
*   is suppressed for any of a variety of reasons and the               03060000
*   caller is STDENV (non-SRB in this case), the appropriate            03070000
*   trace class suppression bit is set in the ITASK to reduce           03080000
*   the cost of future calls for the same, suppressed trace             03090000
*   class.                                                              03100000
*                                                                       03110000
***************************************************************         03120000
                                                                        03130000
         LA    R15,RC00           NORMAL COMPLETION                     03140000
         B     RETURN             DONE                                  03150000
                                                                        03160000
IGNORE   DS    0H                                                       03170000
         LA    R15,RC04           TRACE NOT ACTIVE OR CLASS SUPPRESSED  03180000
         LTR   R10,R10            STDENV REQUESTER?                     03190000
         BZ    RETURN             DONE IF NOT                           03200000
                                                                        03210000
         SRL   R4,8               DISPOSE OF CLASS CODE QUALIFIER       03220000
         SLL   R4,2               TRACE CLASS AS FULLWORD INDEX         03230000
         A     R4,ICTBITX         ENTRY CORRESPONDING TO BIT/BYTE       03240000
         LA    R1,TSKTRSMY        TRACE CLASS SUPPRESSION BITS          03250000
         AH    R1,2(,R4)          SUPPRESSION BIT ARRAY BYTE            03260000
         OC    0(1,R1),0(R4)      RAISE CALL SUPPRESS BIT FOR CLASS     03270000
         B     RETURN                                                   03280000
                                                                        03290000
ERROR    DS    0H                                                       03300000
         LA    R15,RC08           REQUEST INVALID                       03310000
         B     RETURN                                                   03320000
                                                                        03330000
*--------------------------------------------------------------         03340000
*   Return to caller                                                    03350000
*--------------------------------------------------------------         03360000
                                                                        03370000
RETURN   DS    0H                                                       03380000
         #EXIT ,                  RETURN                                03390000
                                                                        03400000
         EJECT                                                          03410000
***************************************************************         03420000
*                                                                       03430000
*   Local read only working storage                                     03440000
*                                                                       03450000
***************************************************************         03460000
                                                                        03470000
TM_OF_R2 TM    0(R2),*-*          EVENT CLASS BIT TEST                  03480000
LOWORDER TM    =X'01',*-*         TEST LOW ORDER BIT OF REG             03490000
                                                                        03500000
         LTORG ,                                                        03510000
                                                                        03520000
         PRINT NOGEN                                                    03530000
         ICVT  ,                                                        03540000
         SERVERX ,                                                      03550000
         ITASK ,                                                        03560000
         IPCB  ,                                                        03570000
         @CB   ,                                                        03580000
                                                                        03590000
         IHAPSA ,                                                       03600000
         END   ,                                                        03610000

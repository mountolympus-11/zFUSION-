IRUNXEQ  TITLE '- PLAN EXECUTOR'                                        00010000
**<DOC-ON>************************************************************* 00020000
*                                                                       00030000
* ROUTINE: IRUNXEQ - PLAN EXECUTOR                                      00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THIS ROUTINE IS CALLED FROM THE SLU SESSION DRIVER TO MOVE         00080000
*    A PLAN TO AN END STATE BY SUCCESSIVE ITERATIONS OF:                00090000
*                                                                       00100000
*       1) APPLYING STORED KEYSTROKES TO THE CURRENT VIRTUAL IMAGE      00110000
*       2) SENDING THE UPDATED VIRTUAL IMAGE DATASTREAM TO THE HOST     00120000
*       3) RECEIVING DATASTREAMS FROM THE HOST AND UPDATING THE VIRTUAL 00130000
*          IMAGE                                                        00140000
*       4) SCRAPING VARIABLES FROM THE VIRTUAL IMAGE                    00150000
*       5) DETERMINING THE STATE OF PLAN EXECUTION AFTER THE HOST       00160000
*          UPDATE (E.G. END STATE, WAIT FOR MORE HOST STUFF, OR APPLY   00170000
*          AND SEND STORED KEYSTROKES)                                  00180000
*                                                                       00190000
* ON ENTRY:                                                             00200000
*                                                                       00210000
*    R15 = ENTRY POINT ADDRESS                                          00220000
*    R14 = RETURN      ADDRESS                                          00230000
*    R13 = SAVE AREA   ADDRESS                                          00240000
*    R1  = PARM LIST   ADDRESS                                          00250000
*                                                                       00260000
*          +00 (4) = SLUHANDL ADDRESS                                   00270000
*          +04 (4) = ISLUIMGO RETURN CODE                               00280000
*          +08 (4) = ISLUIMGO REASON CODE                               00290000
*          +12 (4) = RECEIVE SPLIST ADDRESS (FROM ISLUDRV)              00300000
*          +16 (4) = $SLU2 R15 RETURN VALUE (FROM ISLUIMGO)             00310000
*          +20 (4) = $SLU2 R0  RETURN VALUE (FROM ISLUIMGO)             00320000
*          +24 (4) = $SLU2 R1  RETURN VALUE (FROM ISLUIMGO)             00330000
*          +28 (4) = RECEIVE DATA COPY      (FROM ISLUDRV)              00340000
*                                                                       00350000
* ON EXIT:                                                              00360000
*                                                                       00370000
*    R15 = GENERAL RETURN CODE                                          00380000
*                                                                       00390000
*        = -2 --> PLAN END                                              00400000
*                                                                       00410000
*        =  0 --> PLAN EXECUTION CONTINUES                              00420000
*                                                                       00430000
*        = 28 --> PLAN END CONDITION, NO PLAN ACTIVE                    00440000
*                                                                       00450000
*    R0  = 0                                                            00460000
*    R1  = 0                                                            00470000
*                                                                       00480000
*    ALL OTHER REGISTERS ARE RESTORED.                                  00490000
*                                                                       00500000
**<DOC-OFF>************************************************************ 00510000
                                                                        00520000
         EJECT ,                                                        00530000
*********************************************************************** 00540000
*                                                                       00550000
* MAINTENANCE:                                                          00560000
*                                                                       00570000
*    06/01/94  R. Colmone         Par# 124329                           00580000
*              Changed processing so that the scraping of the first     00590000
*              state (S0) of the DATA plan occurs while running         00600000
*              DATA plan, not during the execution of the REPOS         00610000
*              plan.  This will ensure that repositioning plans         00620000
*              that end on a scroll group will scrape all rows          00630000
*              while running the DATA plan.                             00640000
*                                                                       00650000
*    08/25/94  Ron Colmone        Par# 139782                           00660000
*              If a repositioning plan ends on an exception state       00670000
*              or on a screen which contains exception regions,         00680000
*              the plan is not terminated.  This occurs because         00690000
*              the logic to check if an exception state was encountered 00700000
*              is after SCRAPE processing.  This is valid in all        00710000
*              cases except when its the end of the repositioning       00720000
*              plan.  Add test to ensure exception processing           00730000
*              terminates plan execution.                               00740000
*                                                                       00750000
*    10/10/94  Su-Fen Wu          Par# 139782                    139732 00760000
*              Use the same Par# for this fix. In label PEXPLAIN,139732 00770000
*              check for zeros in SAVXPOS before using it for    139732 00780000
*              the current plan information in AAPXPOS.          139732 00790000
*                                                                       00800000
*    12/19/94  Su-Fen Wu                                                00810000
*              From state, To state for scrolling in class(n) msg       00820000
*              From state, To state for sksrun error in class(n) msg    00830000
*                                                                       00840000
*    06/21/95  R. Turgeon         Rel 2.0                               00850000
*              Minor restructuring, particularly with respect to        00860000
*              the IRUNSCUP interface, to introduce support for         00870000
*              the table-select navigation model.                       00880000
*                                                                       00890000
*    08/15/95  T. Weltzer                                               00900000
*              Count ($INCR) AIDs sent to application                   00910000
*                                                                       00920000
*    10/16/95  SU-Fen Wu          Par# 222560                    222560 00930000
*              In S0->S0 case, no nvarc table in suprarc and     222560 00940000
*              need to check for this condition.                 222560 00950000
*                                                                       00960000
*    10/27/95  SU-Fen Wu          Par# 225211                    225211 00970000
*              #VTAMSTN gets bad address due to IPROJ using      225211 00980000
*              a wrong addressability.                           225211 00990000
*                                                                       01000000
*    01/24/96  Randy Witek - ABEND S0C4 IRUNXEQ+1266             960124 01010000
*                                                                       01020000
*    01/25/96  Randy Witek - clear residual compare rc/rsn, etc. 960125 01030000
*                                                                       01040000
*    01/26/96  Randy Witek - scrolling from NVSTN0               960126 01050000
*                                                                       01060000
*    01/29/96  Randy Witek - fix trace to/from destination names 960130 01070000
*                                                                       01080000
*    02/05/96  Randy Witek - fix env error after select failure  960205 01090000
*                                                                       01100000
*********************************************************************** 01110000
                                                                        01120000
         EJECT                                                          01130000
         RUNSCOOP ,               SEARCH AND SCRAPE RTN PLIST           01140000
                                                                        01150000
         EJECT                                                          01160000
         NAV ,                    NAVIGATION STRUCTURES                 01170000
                                                                        01180000
         EJECT                                                          01190000
         NAVTRC ,                 NAVIGATION TRACE RECORD MAPPING       01200000
                                                                        01210000
         EJECT                                                          01220000
         SESSIMAG ,               SLU IMAGING STRUCTURE                 01230000
                                                                        01240000
         EJECT                                                          01250000
         $SESS    DSECT=YES       $SESS SERVICES                        01260000
                                                                        01270000
         EJECT                                                          01280000
         $SESSTMR DSECT=YES       $SESSTMR SERVICES                     01290000
                                                                        01300000
         EJECT                                                          01310000
         $INCR    TYPE=DSECT      STATISTICS SERVICE                    01320000
                                                                        01330000
         EJECT                                                          01340000
         $MSGDFT PREFIX=ICTPID,                                        +01350000
               COMPID='NAV',                                           +01360000
               TABLE=*#MSGS,                                           +01370000
               DESTADD=ADDESTS,                                        +01380000
               MSGQA=*AAPMSGQA,                                        +01390000
               STGQH=*AAPQHMSG,                                        +01400000
               WORKA=0,                                                +01410000
               MF=(E,$MSGMFL),                                         +01420000
               PRINT=NOGEN                                              01430000
                                                                        01440000
         EJECT                                                          01450000
         EQUS  ,                  GENERAL EQUATES                       01460000
                                                                        01470000
RICVT    EQU   R11                                                      01480000
RITASK   EQU   R10                                                      01490000
RSESSIMG EQU   R9                                                       01500000
RSLUHNDL EQU   R8                                                       01510000
RAAP     EQU   R7                                                       01520000
RSUPRARC EQU   R6                                                       01530000
RNVARC   EQU   R5                                                       01540000
RNVSTN   EQU   R4                                                       01550000
                                                                        01560000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              01570000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              01580000
         USING SESSIMAG,RSESSIMG  ESTABLISH ADDRESSABILITY              01590000
         USING SLUHANDL,RSLUHNDL  ESTABLISH ADDRESSABILITY              01600000
         USING AAP,RAAP           ESTABLISH ADDRESSABILITY              01610000
         USING SUPRARC,RSUPRARC   ESTABLISH ADDRESSABILITY              01620000
         USING NVARC,RNVARC       ESTABLISH ADDRESSABILITY              01630000
         USING NVSTN,RNVSTN       ESTABLISH ADDRESSABILITY              01640000
                                                                        01650000
         EJECT                                                          01660000
WORKAREA #WORK PLIST=(MFE_LIST,80)                                      01670000
                                                                        01680000
SERVNAME DS    CL8                NAME OF FAILING SERVICE               01690000
IMAGLINE DS    XL256              IMAGE LINE WORKAREA                   01700000
TRCREC   DS    F                  TRACE RECORD ADDRESS                  01710000
                                                                        01720000
RCSPLIST $SESS   MF=L             AREA FOR SPLIST COPY      (ISLUDRV)   01730000
                                                                        01740000
$MSGMFL  $MSG    MF=(L,*),                                             X01750000
               FIELDS=(,,,,,,,,,,,,,,,,,,,)                             01760000
                                                                        01770000
RCDATALN DS    F                  AREA FOR DATA COPY LENGTH (ISLUDRV)   01780000
RCDATA   DS    XL32               AREA FOR DATA COPY        (ISLUDRV)   01790000
                                                                        01800000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  01810000
SUB1SAVE DS    18F                SUBROUTINE SAVE AREA                  01820000
SAVSUPR  DS    F                                                 960130 01830000
                                                                        01840000
#CMPINFO DS    0D                                                       01850000
         CMPINFO DSECT=NO         IMAGE UTILITY FUNCTIONS RETURN AREA   01860000
                                                                        01870000
#PCBSTG  DS    A                  ADDR OF PCBSTG QH                     01880000
#NVSIMGA DS    A                  ADDR OF REAL IMAGE (FOR SKSLOAD)      01890000
##IMAGE  DS    A                  ADDR OF IMAGE STRCT ADDR FROM IMGBLD1 01900000
#IMAGE   DS    A                  ADDR OF IMAGE STRCT FROM IMGBLD1      01910000
#PROJ    DS    A                  ADDR OF IPROJ                         01920000
#PROJSTG DS    A                  ADDR OF IPROJ PRJEXSTG QH             01930000
#USRSTG  DS    A                  ADDR OF IUSER USRSTG QH               01940000
#VMPOOL  DS    A                  ADDR OF VMPOOL FROM IUSER USRVPOOL    01950000
#VTAMSTN DS    A                  ADDR OF USS STN ENTRY                 01960000
SIMGFLAG DS    F                  AREA TO CONSOLIDATE SESSIMAG FLAGS    01970000
SIMGFLDS DS    H                  NUMBER OF FIELDS IN SESSIMAG          01980000
                                                                        01990000
IMSGSEG  DS    A                  IMAGE FUNCTION DIAG MSG ADDR          02000000
IMSGSEGL DS    F                  IMAGE FUNCTION DIAG MSG LENGTH        02010000
                                                                        02020000
$SLU2R15 DS    F                  $SLU2_FROM_THE_PLU R15 (ISLUIMGO)     02030000
$SLU2R0  DS    F                  $SLU2_FROM_THE_PLU R0  (ISLUIMGO)     02040000
$SLU2R1  DS    F                  $SLU2_FROM_THE_PLU R1  (ISLUIMGO)     02050000
$SLU2RET EQU   $SLU2R15,*-$SLU2R15                                      02060000
                                                                        02070000
SAVXPOS  DS    XL(L'AAPXPOS)      LAST "KNOWN" POSITION TEMPORARY SAVE  02080000
PEERPOS  DS    XL(L'AAPXPOS)      FIRST POSITION IN PEER CHAIN          02090000
PEERLFLG DS    X                  LAST SUPARC/NVARC FLAG SAVE    139782 02100000
         DS    XL3                RESERVED                       139782 02110000
NEWSTN   DS    XL(NVSTNLN)                                              02120000
                                                                        02130000
$NVARC   DS    XL(NVARCLN)        PSEUDO-NVARC USED TO DRIVE SCOLL OPS  02140000
                                                                        02150000
PLANRET  DS    F                  PLAN EXECUTION MAJOR RETURN CODE      02160000
PLANRSN  DS    F                  PLAN EXECUTION MAJOR REASON CODE      02170000
PLANQ1   DS    F                  PLAN EXECUTION REASON CODE QUALIFIER1 02180000
PLANQ2   DS    F                  PLAN EXECUTION REASON CODE QUALIFIER2 02190000
                                                                        02200000
RETR15   DS    F                                                        02210000
RETR0    DS    F                                                        02220000
RETR1    DS    F                                                        02230000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      02240000
                                                                        02250000
INPSTAT  DS    CL8                "data" OR "no data"                   02260000
PLANSTAT DS    CL32               EXPLANATION OF CURRENT PLAN STATE     02270000
PLNRETXP DS    CL32               EXPLANATION OF PLAN END RETURN CODE   02280000
                                                                        02290000
TSTATE   DS    0CL18              TRACE FORMAT STATE AREA               02300000
FSTATE   DS    CL18               ORIGIN (FROM) STATE                   02310000
                                                                        02320000
DSTATE   DS    0CL18              INITIALIZE DESTINATION STATE TRACE    02330000
DSTATE1  DS    CL18                  DESTINATION STATE 1                02340000
DSTATE2  DS    CL18                  DESTINATION STATE 2                02350000
DSTATE3  DS    CL18                  DESTINATION STATE 3                02360000
DSTATE4  DS    CL18                  DESTINATION STATE 4                02370000
DSTATE5  DS    CL18                  DESTINATION STATE 5                02380000
DSTATE6  DS    CL18                  DESTINATION STATE 6                02390000
DSTATEL  EQU   *-DSTATE           LENGTH OF DESTINATION STATE TRACE     02400000
DSTATE#  EQU   (DSTATEL/L'DSTATE) COUNT OF DESTINATION STATES / LINE    02410000
                                                                        02420000
DLABEL   DS    CL12               DESINATION TRACE LABEL                02430000
TSTATEL  EQU   *-TSTATE           LENGTH OF DESTINATION STATE TRACE     02440000
                                                                        02450000
@IMGAUX  DS    A                  ADDR OF AUX IMAGE BUFFER              02460000
                                                                        02470000
FLAGS    DS    X                  FLAGS                                 02480000
FLIMGLN  EQU   X'80'                 NON-NULL/BLANK IMAGE LINE WRITTEN  02490000
FLRSVD1  EQU   X'40'                 *** RESERVED ***                   02500000
FLPLANND EQU   X'20'                 CALL PLAN END POSTER               02510000
FLVTAMST EQU   X'10'                 VTAM STATE IS POSSIBLE TRANSITION  02520000
FLAPPLST EQU   X'08'                 APPL STATE IS POSSIBLE TRANSITION  02530000
FLSCVERT EQU   X'04'                 VERTICAL SCROLL REQUIRED           02540000
FLRECOV  EQU   X'02'                 RECOVERY ENVIRONMENT ESTABLISHED   02550000
FLSCO    EQU   X'01'                 FIRST SCREEN OF SCRAPE FIRST/ONLY  02560000
                                                                        02570000
ADDESTS  DS    X                  $MSG ADDITIONAL DESTINATION MASK      02580000
                                                                        02590000
FLAG2    DS    X                  SECONDARY FLAG BYTE                   02600000
FL2SETIM EQU   X'80'                 TIMER SET REQUIRED (ON EXIT)       02610000
FL2SAME  EQU   X'40'                 S1 EXPECTATION IS (S0) SAME STATE  02620000
FL2EXCP  EQU   X'20'                 EXCEPTION STATE             139782 02630000
FL2TSEL  EQU   X'08'                 S1 DRIVES TABLE SELECT             02640000
FL2PREP  EQU   X'04'                 IMAGE HAS BEEN PREPED AND TILED    02650000
                                                                        02660000
         DS    0D                                                       02670000
                                                                        02680000
WORKLEN  #ENDWORK                 END OF WORKAREA                       02690000
                                                                        02700000
         EJECT                                                          02710000
IRUNXEQ  #ENTER BASE=R12,COPYRITE=NO,                                  +02720000
               PREG=(R3),         PARAMETER LIST PTR                   +02730000
               AMODE=31,                                               +02740000
               RMODE=ANY                                                02750000
                                                                        02760000
Z        USING SPLIST,RCSPLIST    ESTABLISH ADDRESSABILITY              02770000
                                                                        02780000
***************************************************************         02790000
*                                                                       02800000
*   General initialization and parm / environment validation            02810000
*                                                                       02820000
***************************************************************         02830000
                                                                        02840000
         SR    RSESSIMG,RSESSIMG  NO ADDRESSABILITY YET          960124 02850000
         SR    RSLUHNDL,RSLUHNDL  NO ADDRESSABILITY YET          960124 02860000
         SR    RAAP,RAAP          NO ADDRESSABILITY YET          960124 02870000
         SR    RSUPRARC,RSUPRARC  NO ADDRESSABILITY YET          960124 02880000
         SR    RNVARC,RNVARC      NO ADDRESSABILITY YET          960124 02890000
         SR    RNVSTN,RNVSTN      NO ADDRESSABILITY YET          960124 02900000
                                                                        02910000
         MVI   PLANSTAT,C' '                                            02920000
         MVC   PLANSTAT+1(L'PLANSTAT-1),PLANSTAT                        02930000
         MVI   PLNRETXP,C' '                                            02940000
         MVC   PLNRETXP+1(L'PLNRETXP-1),PLNRETXP                        02950000
                                                                        02960000
         L     RSLUHNDL,0(,R3)    SLUHANDL ADDRESS                      02970000
         MVC   $SLU2RET(12),16(R3) $SLU2_FROM_THE_PLU CODES (ISLUIMGO)  02980000
         ICM   R2,15,12(R3)       RECEIVE SPLIST ADDRESS                02990000
         BZ    INITNOSP           BRANCH IF NONE                        03000000
         MVC   RCSPLIST(L'SPL),0(R2) COPY TO LOCAL STORAGE              03010000
         ICM   R2,15,28(R3)       DATA AREA COPY ADDRESS                03020000
         BZ    INITNOSP           BRANCH IF NO AREA                     03030000
         MVC   RCDATALN(36),0(R2) COPY THE DATA LENGTH AND DATA         03040000
                                                                        03050000
INITNOSP DS    0H                                                       03060000
                                                                        03070000
         ICM   RAAP,15,SLHAAP     APPLICATION ACTION BLOCK              03080000
         BNP   PE_ENVR1           FAIL IF NO BLOCK                      03090000
         XC    AAPCI,AAPCI        CLEAR RESIDUAL RETURN INFO     960125 03100000
                                                                        03110000
         ICM   RSESSIMG,15,SLHSIMAG SESSIMAG BLOCK                      03120000
         BNP   PE_ENVR2           FAIL IF NO BLOCK                      03130000
                                                                        03140000
         ICM   R2,15,TSKPCBC      CURRENT PCB                           03150000
         BZ    PE_ENVR3           FAIL IF NO PCB                        03160000
X        USING IPCB,R2                                                  03170000
         LA    R2,X.PCBSTG        PCB STGMGR QH                         03180000
         ST    R2,#PCBSTG         SAVE IT                               03190000
         DROP  X                                                        03200000
                                                                        03210000
         ICM   R2,15,SLHUSER      CURRENT IUSER                         03220000
         BZ    PE_ENVR4           BRANCH IF NO IUSER                    03230000
X        USING IUSER,R2                                                 03240000
         MVC   #VMPOOL,X.USRVPOOL SAVE USRVPOOL POINTER TO VMPOOL       03250000
         LA    R1,X.USRSTG        IUSER STGMGR QH                       03260000
         ST    R1,#USRSTG         SAVE THAT ADDRESS                     03270000
         ICM   R2,15,X.USRPROJ    IPROJ POINTER                         03280000
         BZ    PE_ENVR5           FAIL IF NO IPROJ                      03290000
         ST    R2,#PROJ           SAVE IT FOR FUN                       03300000
         DROP  X                                                        03310000
                                                                        03320000
X        USING IPROJ,R2                                                 03330000
         MVC   #VTAMSTN,X.PRJEXSTN                               225211 03340000
         LA    R2,X.PRJEXSTG      IPROJ POINTER                         03350000
         ST    R2,#PROJSTG        SAVE IT FOR LATER                     03360000
         DROP  X                                                        03370000
                                                                        03380000
*---------------------------------------------------------------------- 03390000
*   ESTABLISH RECOVERY ENVIRONMENT                                      03400000
*---------------------------------------------------------------------- 03410000
                                                                        03420000
         L     R2,=A(RECOVRTN)                                          03430000
         $RCVRY CREATE,(R2),PARM=(R13),MF=(E,MFE_LIST)                  03440000
                                                                        03450000
         OI    FLAGS,FLRECOV      INDICATE RECOVERY ENVIRON ESTABLISHED 03460000
                                                                        03470000
*---------------------------------------------------------------------- 03480000
*   STOP THE SESSION RECEIVE TIMER IF ONE IS ACTIVE                     03490000
*---------------------------------------------------------------------- 03500000
                                                                        03510000
         L     R15,=A(TIMEROFF)   SHUT THE TIMER OFF                    03520000
         BASR  R14,R15                                                  03530000
                                                                        03540000
*---------------------------------------------------------------------- 03550000
*   INITIALIZE MESSAGING AREAS                                          03560000
*---------------------------------------------------------------------- 03570000
                                                                        03580000
         TM    AAPFLAG2,AAPF2XEQ          CURRENTLY EXECUTING A PLAN?   03590000
         BO    INITACTV                   BRANCH IF YES                 03600000
                                                                        03610000
         XC    AAPXPOS(L'AAPXPOS),AAPXPOS CLEAR POSITION INFORMATION    03620000
         MVC   PLANSTAT(L'MSG_NO_PLAN_ACT),MSG_NO_PLAN_ACT              03630000
         MVC   PLNRETXP(L'MSG_UNEXPECT_IN),MSG_UNEXPECT_IN              03640000
         B     INITCONT                                                 03650000
                                                                        03660000
INITACTV DS    0H                                                       03670000
                                                                        03680000
         MVC   PLANSTAT(L'MSG_PLAN_ACT),MSG_PLAN_ACT                    03690000
         MVC   PLNRETXP(L'MSG_AWAIT_DATA),MSG_AWAIT_DATA                03700000
                                                                        03710000
INITCONT DS    0H                                                       03720000
                                                                        03730000
         MVC   INPSTAT,=CL8'no data'      ASSUME NO INPUT DATA          03740000
         ICM   R1,15,RCDATALN             IS THERE INPUT DATA?          03750000
         BZ    *+10                       BRANCH IF NOT                 03760000
         MVC   INPSTAT,=CL8'data'                                       03770000
                                                                        03780000
         BAS   R14,GETNVARC       SET SCREEN SET AND STATE NAMES        03790000
*                                 THIS ESTABLISHES RSUPRARC AND         03800000
*                                 RNVARC TO THE CURRENT SUPERARC AND    03810000
*                                 ELEMENTARY ARCS                       03820000
         EJECT                                                          03830000
***************************************************************         03840000
*                                                                       03850000
*   If the session we have been running has terminated (for any         03860000
*   of a number of reasons), determine whether the termination          03870000
*   was anticipated.  If not post an appropriate error.  Else,          03880000
*   if plan is running, invoke the SCRAPE service to ensure             03890000
*   that all data has been posted to the result set.                    03900000
*                                                                       03910000
***************************************************************         03920000
                                                                        03930000
         TM    SEIFSNA,SEIF_GNE   IS THE SESSION GONE?                  03940000
         BO    TRMSESS            BRANCH YES                            03950000
                                                                        03960000
         TM    SEISTATE,SEIS_TUS  ARE WE TRYING TO LEAVE?               03970000
         BNO   TESTXEQ            BRANCH IF NOT                         03980000
                                                                        03990000
         LM    R1,R2,4(R3)        ISLUIMGO RETURN CODE AND REASON CODE  04000000
         LTR   R1,R1              TEST THE RETURN CODE                  04010000
         BNZ   PE_IMGO            TERMINATE PLAN IF NON-ZERO            04020000
         MVC   PLNRETXP(L'MSG_AWAIT_END),MSG_AWAIT_END                  04030000
         B     RETWAIT            WAITING FOR GONE FLAG                 04040000
                                                                        04050000
*--------------------------------------------------------------         04060000
*   SESSION HAS TERMINATED, ENSURE ALL RESULT SET DATA POSTED           04070000
*--------------------------------------------------------------         04080000
                                                                        04090000
TRMSESS  DS    0H                                                       04100000
                                                                        04110000
         XC    AAPCURR,AAPCURR    CURRENT POSITION DISCARDED            04120000
         TM    SEISTATE,SEIS_TUS+SEIS_CUS  DID WE EXPECT TO BE GOING?   04130000
         BZ    PE_SGNE            ELSE PREMATURE TERMINATION ERROR      04140000
                                                                        04150000
         CLC   AAPXPLAN,=A(AAPXPV_DATA)      DATA (RUN) PLAN ACTIVE?    04160000
         BNE   PLANEND                       SKIP IF NOT                04170000
                                                                        04180000
         LA    R0,TRUE            TERMINAL STATE IF EVER THERE WAS ONE  04190000
         L     R1,#VTAMSTN        USS STN ENTRY                         04200000
         BAS   R14,SCRAPE         END OF SESSION VARIABLE PROCESSING    04210000
         B     PLANEND            BRANCH IF YES                         04220000
                                                                        04230000
***************************************************************         04240000
*                                                                       04250000
* Determine type of entry and proceed accordingly                       04260000
*                                                                       04270000
*    A) end of session (from stop routine of ISLUDRV)                   04280000
*    B) start plan execution (from message routine of ISLUDRV)          04290000
*    C) normal processing of host output (from ISLUIMGO)                04300000
*                                                                       04310000
***************************************************************         04320000
                                                                        04330000
TESTXEQ  DS    0H                                                       04340000
                                                                        04350000
         LTR   RSLUHNDL,RSLUHNDL  SLUHANDL + X'80000000' ?              04360000
         BM    BGNPLAN            BRANCH IF YES, PLANXEQ MSG RECEIVED   04370000
                                                                        04380000
***************************************************************         04390000
*                                                                       04400000
*   At this point, output has been received and posted to the           04410000
*   sessimag by ISLUIMGO.  The image is "complete" if we have           04420000
*   received application data (as opposed to SNA responses,             04430000
*   etc.) and direction has been returned to the terminal.              04440000
*   In all other cases, we exit via RETWAIT to wait for more            04450000
*   activity from the application.                                      04460000
*                                                                       04470000
*   Because this routine is a SLU driver exit, it is possible           04480000
*   to acquire control when no plan is active. If this occurs           04490000
*   we simply update the SESSIMAG block accordingly and exit.           04500000
*                                                                       04510000
***************************************************************         04520000
                                                                        04530000
         LM    R1,R2,4(R3)        ISLUIMGO RETURN CODE AND REASON CODE  04540000
         LTR   R1,R1              TEST THE RETURN CODE                  04550000
         BNZ   PE_IMGO            TERMINATE PLAN IF NON-ZERO            04560000
                                                                        04570000
         TM    Z.SPLRH0,RHQSRSP   WAS A RESPONSE RECEIVED?              04580000
         BO    RETWAIT            BRANCH IF YES                         04590000
         ICM   R0,15,AAPXPLAN     ARE WE ON A PLAN?                     04600000
         BNZ   INPUTOK            BRANCH IF YES                         04610000
         TM    SEISTATE,SEIS_FUS  ARE WE COMING FROM USS/VTAM ?         04620000
         BNO   PE_IOP             BRANCH IF NOT, UNEXPECTED OUTPUT      04630000
                                                                        04640000
INPUTOK  DS    0H                                                       04650000
                                                                        04660000
         OI    SEISTATE,SEIS_RSP  HOST HAS WRITTEN A (DATA) RESPONSE    04670000
                                                                        04680000
         TM    AAPFLAG1,AAPF1SIN  SCROLLING INPUT EXPECTED?         ##  04690000
         BNO   INPUTGO            BRANCH IF NOT                     ##  04700000
         ICM   R1,15,RCDATALN     LENGTH OF HOST DATA               ##  04710000
         BNP   INPUTNSD           BRANCH IF NO DATA LENGTH          ##  04720000
         CLI   RCDATA,X'F1'       WRITE COMMAND?                    ##  04730000
         BE    INPUTCDL           CHECK LENGTH OF DATA IF YES       ##  04740000
         CLI   RCDATA,X'F5'       ERASE/WRITE COMMAND?              ##  04750000
         BE    INPUTSDR           BRANCH IF YES                     ##  04760000
         CLI   RCDATA,X'7E'       ERASE/WRITE ALT COMMAND?          ##  04770000
         BE    INPUTSDR           BRANCH IF YES                     ##  04780000
         CLI   RCDATA,X'F3'       WSF COMMAND?                      ##  04790000
         BE    INPUTSDR           BRANCH IF YES, ASSUME DATA RCV'D  ##  04800000
         B     INPUTNSD           BRANCH IF YES                     ##  04810000
                                                                        04820000
INPUTCDL DS    0H                                                   ##  04830000
                                                                        04840000
         C     R1,=F'2'           MORE THAN A CMD & WCC?            ##  04850000
         BNH   INPUTNSD           BRANCH IF NOT                     ##  04860000
                                                                        04870000
INPUTSDR DS    0H                                                   ##  04880000
                                                                        04890000
         OI    AAPFLAG2,AAPF2SDR  SCROLLING DATA WAS RECEIVED       ##  04900000
                                                                        04910000
INPUTNSD DS    0H                                                   ##  04920000
                                                                        04930000
         TM    AAPFLAG2,AAPF2SDR  WAS SCROLLING DATA RECEIVED?      ##  04940000
         BNO   RETWAIT            BRANCH IF NOT TO WAIT FOR MORE    ##  04950000
                                                                        04960000
INPUTGO  DS    0H                                                   ##  04970000
                                                                        04980000
         TM    SEISTATE,SEIS_CPT  IS IMAGE CONSIDERED COMPLETE?         04990000
         BNO   RETWAIT            BRANCH IF NOT TO WAIT FOR MORE        05000000
         TM    SEIFSNA,SEIF_CMD   DO WE HAVE THE DIRECTION?             05010000
         BNO   RETWAIT            BRANCH IF NOT TO WAIT FOR MORE        05020000
         TM    AAPFLAG1,AAPFRUN   IS A PLAN RUNNING?                    05030000
         BNO   RETWAIT            BRANCH IF NOT                         05040000
         B     RESUME                                                   05050000
                                                                        05060000
***************************************************************         05070000
*                                                                       05080000
*   Start a new plan                                                    05090000
*                                                                       05100000
*   The plan control routine (INAVCNTL) sent the SLU driver             05110000
*   a PLANXEQ message.  These come in two forms. In the more            05120000
*   common form, a repositioning subplan bring us to the                05130000
*   beginning of the run (data) plan.  In this case, we begin           05140000
*   by applying keystrokes to the current screen.                       05150000
*                                                                       05160000
*   The scrape-first form, usually used when no repositioning           05170000
*   plan is required, directs us to scrape the current screen           05180000
*   before applying keystrokes.                                         05190000
*                                                                       05200000
***************************************************************         05210000
                                                                        05220000
BGNPLAN  DS    0H                                                       05230000
                                                                        05240000
         OI    AAPFLAG2,AAPF2XEQ  WE ARE EXECUTING A PLAN               05250000
         LA    R1,SLUHANDL        R1 <== SLU SESSION HANDLE     R211219 05260000
         @CALL IRUNXINI           ESTABLISH RESOURCE MANAGERS   R211219 05270000
                                                                        05280000
         NI    AAPFLAG1,255-AAPF1SIN CLEAR SCROLLING INPUT EXPECTED  ## 05290000
         NI    AAPFLAG3,255-AAPF3SS0 CLEAR S0->S0 SCROLL         960205 05300000
         MVC   PLANSTAT(L'MSG_PLAN_ACT),MSG_PLAN_ACT                    05310000
                                                                        05320000
         BAS   R14,BUILD1         BUILD AN NVIMAGE FOR THE SESSIMAG     05330000
         BAS   R14,NEWPLAN        POSITION TO RUN THE PLAN              05340000
                                                                        05350000
         MVC   SAVXPOS(L'AAPXPOS),AAPXPOS SAVE LAST KNOWN POSITION      05360000
                                                                        05370000
         TM    AAPFLAG2,AAPF2SCO  SCRAPE FIRST/ONLY CALL?               05380000
         BNO   RUNPLAN            STANDARD PLAN START IF NOT            05390000
         NI    AAPFLAG2,255-AAPF2SCO                                    05400000
         OI    FLAGS,FLSCO        FIRST OF SCRAPE FIRST/ONLY PLAN       05410000
         OI    AAPFLAG3,AAPF3SS0  IF WE SCROLL, USE S0->S0       960126 05420000
                                                                        05430000
***************************************************************         05440000
*                                                                       05450000
*   Initialization for a scrape-first/only request. The image           05460000
*   currently maintained in SESSIMAG is the target of a                 05470000
*   data acquistion request.  These requests can be honored             05480000
*   (and should be made) only if current position has been              05490000
*   previously established in the target application by a               05500000
*   prior query.                                                        05510000
*                                                                       05520000
***************************************************************         05530000
                                                                        05540000
         L     R15,=F'-1'         REASON CODE IF NO AAPCURR             05550000
         SR    R0,R0              CLEAR FOR ERROR LOGGING               05560000
         ICM   R1,15,AAPCURR      IS A CURRENT STATE KNOWN?             05570000
         BNP   PE_EXSCR           BRANCH IF NOT                         05580000
                                                                        05590000
         BAS   R14,PREP           PREPARE IMAGE FOR SCRAPE              05600000
                                                                        05610000
         L     RNVSTN,AAPCURR     REFRESH CURRENT STN PTR               05620000
         B     PSCRPREP           READY TO SCRAPE AND GO                05630000
                                                                        05640000
         EJECT                                                          05650000
***************************************************************         05660000
*                                                                       05670000
*   Resume plan                                                         05680000
*                                                                       05690000
*   Output has been received from the application and the image         05700000
*   is considered "complete" as described above. First identify         05710000
*   where we are in the plan.  The current superarc /                   05720000
*   elementary-arc pair and their conditional (alternative)             05730000
*   peers describe all of the possible result states. However,          05740000
*   when transitions within a screen set have been made by              05750000
*   applying a scroll operation, we expect to be delivered to           05760000
*   the same screen set (state) that we previously AIDed from.          05770000
*                                                                       05780000
*   Scroll operations are not explicitly represented in the             05790000
*   plan because the number of operations is not predictable.           05800000
*   An elementary-arc used to represent scrolling is built in           05810000
*   this routine.                                                       05820000
*                                                                       05830000
***************************************************************         05840000
                                                                        05850000
RESUME   DS    0H                                                       05860000
                                                                        05870000
         ICM   R0,15,AAPXPLAN          ARE WE ON A PLAN?                05880000
         BNZ   RSMPLAN                 BRANCH IF YES                    05890000
                                                                        05900000
         OI    AAPFLAG2,AAPF2XEQ       WE ARE EXECUTING A PLAN          05910000
         LA    R1,SLUHANDL             R1 <== SLU SESS HANDL    R211219 05920000
         @CALL IRUNXINI                ESTABLISH RSRC MANAGERS  R211219 05930000
                                                                        05940000
         BAS   R14,NEWPLAN             POSITION TO RUN THE PLAN         05950000
                                                                        05960000
RSMPLAN  DS    0H                                                       05970000
                                                                        05980000
         BAS   R14,GETNVARC            SET RSUPRARC AND RNVARC          05990000
         LTR   RSUPRARC,RSUPRARC       RSUPRARC SET?                    06000000
         BZ    PE_ENVR6                BRANCH IF NOT                    06010000
                                                                        06020000
         TM    AAPFLAG3,AAPF3SS0       SCROLLING S0->S0 ?        960126 06030000
         BO    RSMS0S0                 BRANCH IF YES             960126 06040000
                                                                        06050000
         LTR   RNVARC,RNVARC           RNVARC SET?                      06060000
         BNZ   RSMNAMES                READY IF SO                      06070000
                                                                        06080000
RSMS0S0  DS    0H                                                960126 06090000
                                                                        06100000
         TM    AAPFLAG2,AAPF2SAM       S1->S1 EXPECTATION?              06110000
         BNO   PE_ENVR7                MISSING NVARC FAILURE IF NOT     06120000
                                                                        06130000
         L     RNVSTN,SUPS0STN         S0 AND S1 STATE ARE SAME         06140000
         ICM   R0,15,NVSCROLL          R0 <== SCROLLING SUCCESSOR DEF   06150000
         BZ    PE_ENVR7                SCROLL CONNECTOR EXPECTED        06160000
                                                                        06170000
         BAS   R14,BS0S0ARC            ACQUIRE SCROLLING ARC            06180000
                                                                        06190000
RSMNAMES DS    0H                                                       06200000
                                                                        06210000
***************************************************************         06220000
*                                                                       06230000
*   When a new screen is delivered, we must first match it to           06240000
*   one of the possible alternative states as represented by            06250000
*   peer SUPRARCs in the plan.  If the last AID was a scroll            06260000
*   request, we bind the result state to the state previously           06270000
*   presented.                                                          06280000
*                                                                       06290000
***************************************************************         06300000
                                                                        06310000
         MVC   PEERPOS(L'AAPXPOS),AAPXPOS    SAVE PEER CHAIN 1ST POS.   06320000
         BAS   R14,BUILD1              CONSTRUCT NVIMAGE FOR SESSIMAG   06330000
                                                                        06340000
RSMCOMP  DS    0H                                                       06350000
                                                                        06360000
         ICM   RNVSTN,15,NVAS1STN      NVSTN FOR STATE 1                06370000
         BZ    PE_ENVR9                BRANCH IF NO NVSTN               06380000
         TM    NVSFLG,NVSFUSS          IS THIS "GOING TO VTAM" ?        06390000
         BO    RSMPEER                 BRANCH IF YES, DON'T COMPARE     06400000
                                                                        06410000
         ICM   R0,15,AAPCURR           CURRENT POSITION PREV SET?       06420000
         BZ    RSMCOGO                 SKIP IF NOT                      06430000
         TM    AAPFLAG2,AAPF2SAM       RESULT BOUND TO LAST STATE SEEN? 06440000
         BNO   RSMCOGO                 SKIP IF NOT                      06450000
         CR    R0,RNVSTN               BOUND TRANSITION ARC FOUND?      06460000
         BNE   RSMPEER                 ARC IS INELIGIBLE IF NOT         06470000
                                                                        06480000
*--------------------------------------------------------------         06490000
*   SCREEN COMPARE                                                      06500000
*--------------------------------------------------------------         06510000
                                                                        06520000
RSMCOGO  DS    0H                                                       06530000
                                                                        06540000
         BAS   R14,COMPARE             COMPARE SESSIMAG TO NVSTN FOR S1 06550000
         LTR   R15,R15                 IS THAT THE ONE?                 06560000
         BZ    RSMATCH                 BINGO IF SO                      06570000
                                                                        06580000
         TM    AAPFLAG2,AAPF2SAM       RESULT BOUND TO LAST STATE SEEN? 06590000
         BO    RSMWAIT                 SCAN TERMINATES IF SO            06600000
                                                                        06610000
*--------------------------------------------------------------         06620000
*   IDENTIFY ALTERNATIVE STATE                                          06630000
*--------------------------------------------------------------         06640000
                                                                        06650000
RSMPEER  DS    0H                                                       06660000
                                                                        06670000
         L     R2,AAPXNARC             NVARC VECTOR                     06680000
         BCT   R2,RETWAIT              ONLY 1ST ARC CAN BE CONDITIONAL  06690000
         ICM   RSUPRARC,15,SUPPEER     ADDRESS OF PEER SUPRARC          06700000
         BZ    RSMWAIT                 BRANCH IF NO MORE PEERS          06710000
         ST    RSUPRARC,AAPXSARC       SET NEW SUPRARC                  06720000
                                                                        06730000
         XC    AAPXNARC,AAPXNARC       NO NVARC VECTOR                  06740000
         BAS   R14,NEWNARC             GO SET UP FOR FIRST NVARC        06750000
         B     RSMCOMP                 AND COMPARE AGAINST THAT ONE     06760000
                                                                        06770000
RSMWAIT  DS    0H                                                       06780000
                                                                        06790000
         L     RSUPRARC,AAPXSARC       RESTORE SUPRARC POINTER   960130 06800000
         MVC   AAPXPOS(L'AAPXPOS),PEERPOS    RESTORE PEER CHAIN 1ST POS 06810000
         B     RETWAIT                    AND WAIT FOR SOMETHING ELSE   06820000
                                                                        06830000
*--------------------------------------------------------------         06840000
*   MATCHING STN LOCATED                                                06850000
*--------------------------------------------------------------         06860000
                                                                        06870000
RSMATCH  DS    0H                      CURRENT STN IDENTIFIED           06880000
                                                                        06890000
         ST    RNVSTN,AAPCURR          WE KNOW WE ARE HERE              06900000
                                                                        06910000
***************************************************************         06920000
*                                                                       06930000
*   Identify exception states that force premature end-of-plan.  139782 06940000
*   Exception states are not recognized when they are raised     139782 06950000
*   on the first screen of a scrape first/only plan.             139782 06960000
*                                                                       06970000
***************************************************************         06980000
                                                                        06990000
         TM    FLAGS,FLSCO             SCRAPE FIRST/ONLY STARTUP?139782 07000000
         BO    PSCRPREP                IGNORE EXCP STATES IF SO  139782 07010000
                                                                        07020000
         TM    NVSFLG,NVSFEXCP         NEW STATE IS EXCP STATE?  139782 07030000
         BO    PEXCP                   SIGNAL EXCEPTION STATE    139782 07040000
                                                                        07050000
         L     R1,#IMAGE               R1 <== NVIMAGE ADDR       139782 07060000
         BAS   R14,EXCPRGN             TEST FOR EXCEPTION RGNS   139782 07070000
         BZ    PSCRPREP                OK, CONTINUE PROCESSING   139782 07080000
                                                                        07090000
PEXCP    DS    0H                                                       07100000
                                                                        07110000
         OI    FLAG2,FL2EXCP           INDICATE EXCEPTION STATE  139782 07120000
                                                                        07130000
         EJECT                                                          07140000
***************************************************************         07150000
*                                                                       07160000
*   Determine if we are transitioning from VTAM to the first            07170000
*   state.  If so, wait for data to be sent if required.                07180000
*                                                                       07190000
***************************************************************         07200000
                                                                        07210000
PSCRPREP DS    0H                                                       07220000
                                                                        07230000
         TM    SEISTATE,SEIS_FUS       ARE WE COMING FROM USS?          07240000
         BNO   PRPOSEND                BRANCH IF NOT                    07250000
         TM    SEIS1ATR,SEIA_RSP       HAS THE APPLICATION SENT DATA?   07260000
         BNO   PRPOSEND                BRANCH IF YES                    07270000
         TM    NVSFLG,NVSFRSP          WAS THAT THE ORIGINAL INTENT?    07280000
         BNO   RETWAIT                 BRANCH IF NO, RECORDING HAD DATA 07290000
                                                                        07300000
***************************************************************  124329 07310000
*                                                                124329 07320000
*   If we are currently processing the last NVARC of the         124329 07330000
*   repositioning plan, terminate the plan prior to scraping     124329 07340000
*   and allow the data plan to scrape the current state.         124329 07350000
*                                                                124329 07360000
***************************************************************  124329 07370000
                                                                        07380000
PRPOSEND DS    0H                                                124329 07390000
                                                                        07400000
         CLC   AAPXPLAN,=A(AAPXPV_POS)   POS PLAN ACTIVE?        124329 07410000
         BNE   PSCRAPE            NO, CONTINUE WITH SCRAPE       124329 07420000
         TM    AAPFLAG2,AAPF2LSA  PROCESSING LAST SUPERARC?      124329 07430000
         BZ    PSCRAPE            NO, CONTINUE WITH SCRAPE       124329 07440000
         TM    AAPFLAG2,AAPF2LNA  PROCESSING LAST NVARC          124329 07450000
         BZ    PSCRAPE            NO, CONTINUE WITH SCRAPE       124329 07460000
         TM    FLAG2,FL2EXCP      EXCEPTION STATE ENCOUNTERED?   139782 07470000
         BO    PSCRAPE            YES, SCRAPE ANY ERROR VARS     139782 07480000
                                                                        07490000
         BAS   R14,NEWPLAN        ADVANCE TO DATA PLAN           124329 07500000
                                                                        07510000
         OI    FLAGS,FLSCO        SCRAPE FIRST                   124329 07520000
         OI    AAPFLAG3,AAPF3SS0  IF WE SCROLL, USE S0->S0       960126 07530000
                                                                        07540000
         EJECT                                                          07550000
***************************************************************         07560000
*                                                                       07570000
*   Scrape the current state.  If the current state is the S1           07580000
*   state of a terminal SUPRARC, then no further navigation             07590000
*   will occur.  This information is provided to the search &           07600000
*   scrape routine to schedule the promotion of variables to            07610000
*   the result set.                                                     07620000
*                                                                       07630000
***************************************************************         07640000
                                                                        07650000
PSCRAPE  DS    0H                                                       07660000
                                                                        07670000
         L     R1,AAPCURR              R1 <== CURRENT STATE             07680000
                                                                        07690000
         LA    R0,FALSE                ASSUME NON-TERMINAL STATE?       07700000
         C     R1,SUPS1STN             SCRAPING S1 (DESTINATION) STATE? 07710000
         BNE   PSCRCALL                ONWARD IF NOT                    07720000
         TM    AAPFLAG2,AAPF2LSA       LAST SUPRARC?                    07730000
         BNO   PSCRCALL                ONWARD IF NOT                    07740000
         LA    R0,TRUE                 TERMINAL STATE OTHERWISE         07750000
                                                                        07760000
PSCRCALL DS    0H                      STATE SEARCH AND SCRAPE          07770000
                                                                        07780000
         CLC   AAPXSRC#,=F'1'          ARE WE ON THE FIRST ARC?  960126 07790000
         BNE   PSCRGO                  BRANCH IF NOT             960126 07800000
         TM    AAPFLAG3,AAPF3SS0       SCAPE/SCROLL S0 ?         960126 07810000
         BNO   PSCRGO                  BRANCH IF NOT             960126 07820000
         TM    SUPLKATR,SUPLTSEL       IS THIS A TBL SELECT ARC? 960126 07830000
         BNO   PSCRGO                  BRANCH IF NOT             960126 07840000
         OI    FLAG2,FL2TSEL           SET FOR TABLE SELECT      960126 07850000
                                                                        07860000
PSCRGO   DS    0H                                                       07870000
                                                                        07880000
         BAS   R14,SCRAPE              SCRAPE VARIABLES FROM SESSIMAG   07890000
                                                                        07900000
         OI    AAPFLAG2,AAPF2SCR       NOTE THAT WE HAVE SCRAPED        07910000
                                                                        07920000
         LTR   R15,R15                 SCRAPE RETURN CODE               07930000
         BNZ   PE_SCRAP                BRANCH IF ERROR                  07940000
         LTR   R0,R0                   PLAN END SIGNALED?               07950000
         BM    PLANTSLM                DONE IF SO                       07960000
                                                                        07970000
***************************************************************         07980000
*                                                                       07990000
*   If the current state is a member of vertically scrolled             08000000
*   screen set, build a pseudo-elementary ARC to represent the          08010000
*   repeated application of the scroll operation.  Otherwise,           08020000
*   execution proceeds by making the state transition contained         08030000
*   in the "planned" arc.                                               08040000
*                                                                       08050000
*   07/24/95  If a scroll request is encountered, it is honored         08060000
*   only if the destination state is of a higher/deeper VTAM-           08070000
*   distance than the scroll state.  This is intended to                08080000
*   support REPOS plans departing a state reached by cascading          08090000
*   table selects, where the backout sequence moves "up" the            08100000
*   application leg to some earlier input state, etc.                   08110000
*                                                                       08120000
*   Clarification of logic change tagged with ## needed  ??????      ## 08130000
*                                                                       08140000
***************************************************************         08150000
         NI    FLAGS,FF-FLSCVERT       ASSUME NO SCROLLING NEEDED       08160000
         NI    AAPFLAG2,255-AAPF2SDR   SHOW NO SCROLLING DATA RCV'D  ## 08170000
         NI    AAPFLAG1,255-AAPF1SIN   SCROLL INPUT NOT EXPECTED     ## 08180000
         CH    R0,=AL2(RSN04)          VERTICAL SCROLL CONTINUTATION?   08190000
         BNE   NOVERT                  SKIP IF NOT                      08200000
                                                                        08210000
         LTR   RNVARC,RNVARC                                     222560 08220000
         BZ    PSCHECK                                           222560 08230000
         ICM   R14,15,NVAS0STN                                          08240000
         BZ    NOVERT                                                   08250000
         ICM   R15,15,NVAS1STN                                          08260000
         BZ    NOVERT                                                   08270000
         CLC   NVSDEPTH-NVSTN(,R14),NVSDEPTH-NVSTN(R15)                 08280000
         BH    NOVERT                                                   08290000
                                                                        08300000
PSCHECK  DS    0H                                                222560 08310000
                                                                        08320000
         OI    FLAGS,FLSCVERT          VERTICAL SCROLL REQUIRED         08330000
         OI    AAPFLAG1,AAPF1SIN       SHOW THAT SCROLL INPUT IS NEXT## 08340000
                                                                        08350000
NOVERT   DS    0H                                                       08360000
                                                                        08370000
         NI    SEISTATE,255-SEIS_CUS   REMOVE "MAY" TRANSITION TO USS   08380000
         TM    FLAG2,FL2EXCP           EXCEPTION STATE FOUND?    139782 08390000
         BO    PLANEXCP                YES, TERMINATE THE PLAN   139782 08400000
                                                                        08410000
*--------------------------------------------------------------         08420000
*   VERTICAL SCROLL IS A DEVIATION FROM "PLANNED" TRANSITIONS           08430000
*--------------------------------------------------------------         08440000
                                                                        08450000
         TM    FLAGS,FLSCVERT          VERTICAL SCROLL REQUIRED?        08460000
         BNO   PSTDNORM                PLAN CONTINUES NORMALLY IF NOT   08470000
         ICM   R1,15,NVSCROLL          SCROLL DEFINITION PROVIDED?      08480000
         BNZ   PSCROLLV                CONTINUE VIA SCROLL OPERATION    08490000
                                                                        08500000
PSTDNORM DS    0H                                                       08510000
                                                                        08520000
         TM    FLAGS,FLSCO             SCRAPE FIRST/ONLY?        124329 08530000
         BO    PSTDS0S0                CLEAR SPECIAL SCROLLING   960126 08540000
         TM    AAPFLAG3,AAPF3SS0       LEAVING S0->S0 SCROLL?    960126 08550000
         BO    PSTDS0S0                BRANCH IF YES             960126 08560000
         BAS   R14,NEWNARC             MOVE TO THE NEXT NVARC           08570000
         B     RUNPLAN                 SEND INPUT TO THE APPL           08580000
                                                                        08590000
PSTDS0S0 DS    0H                                                960126 08600000
                                                                        08610000
         NI    AAPFLAG3,255-AAPF3SS0   NO S0->S0 SCROLL SHOWING  960126 08620000
         BAS   R14,GETNVARC            RESTORE ORIGINAL PTRS     960126 08630000
         B     RUNPLAN                 AND RUN THE PLAN          960126 08640000
                                                                        08650000
PSCROLLV DS    0H                                                       08660000
                                                                        08670000
         OI    FLAG2,FL2SAME           SCROLL RESULT S/B SAME STN       08680000
         TM    AAPFLAG3,AAPF3SS0       SCROLLING S0->S0 ?        960126 08690000
         BO    PSCRS0S0                BRANCH IF YES             960126 08700000
         L     R0,NVSCROLL             R0 <== SCROLLING SUCCESSOR DEF   08710000
         BAS   R14,BS0S0ARC            ACQUIRE SCROLLING ARC            08720000
         B     RUNPLAN                                           960126 08730000
                                                                        08740000
PSCRS0S0 DS    0H                                                960126 08750000
                                                                        08760000
         L     RNVSTN,SUPS0STN         GET THE NVSTN0            960126 08770000
         ICM   R0,15,NVSCROLL          SCROLLING SUCC. DEF.      960126 08780000
         BZ    PE_ENVR7                BRANCH IF NO DEFINITION   960126 08790000
         BAS   R14,BS0S0ARC            BUILD A SCROLLING ARC     960126 08800000
                                                                        08810000
                                                                        08820000
***************************************************************         08830000
*                                                                       08840000
*   Run plan                                                            08850000
*                                                                       08860000
*   We know where we are in the plan (either from RSMPLAN or            08870000
*   because we are reacting to a PLANXEQ message).  Send a              08880000
*   runtime SKS and an AID key into the application and then            08890000
*   exit -  waiting for one or more appropriate host responses.         08900000
*                                                                       08910000
*   On certain scrape first/only requests, it is possible that          08920000
*   no NVARC is available at this point. If so, the plan simply         08930000
*   ends.                                                               08940000
*                                                                       08950000
***************************************************************         08960000
                                                                        08970000
RUNPLAN  DS    0H                                                       08980000
                                                                        08990000
         LTR   RNVARC,RNVARC           ELEMENTARY TRANSITION POSTED?    09000000
         BZ    PLANEND                 DONE HERE IF NOT                 09010000
                                                                        09020000
         NI    FLAGS,FF-FLSCO          RESET SCRAPE / ONLY       124329 09030000
         MVC   SEIAID,NVAAID           SET THE AID BYTE FOR INPUT       09040000
         CLI   SEIAID,#3270CLR         CLEAR KEY?                       09050000
         BNE   RUNNOTCL                BRANCH IF NOT                    09060000
                                                                        09070000
         XC    SEISCSR,SEISCSR         CURSOR IN UPPER LEFT HAND CORNER 09080000
         MVC   SEIS1ROW,SEIPROWS       PRIMARY ROWS                     09090000
         MVC   SEIS1COL,SEIPCOLS       PRIMARY COLS                     09100000
         MVC   SEIS1SIZ,SEIPRISZ       ROWS * COLS                      09110000
                                                                        09120000
         L     R0,SEIS1IMG             S1 IMAGE BUFFER                  09130000
         L     R1,SEIS1SIZ             S1 IMAGE BUFFER LENGTH           09140000
         SR    R15,R15                 ZERO FILL                        09150000
         MVCL  R0,R14                  CLEAR THE IMAGE BUFFER           09160000
                                                                        09170000
         ICM   R1,15,SEIS1FLV          FIELD VECTORS                    09180000
         BZ    RUNNOTCL                BRANCH IF NO VECTOR              09190000
         XC    0(2,R1),0(R1)           FIELD COUNT = 0                  09200000
         MVC   2(2,R1),SEIS1SIZ+2      END OF IMAGE OFFSET              09210000
         B     RUNTOTHE                                                 09220000
                                                                        09230000
*---------------------------------------------------------------------- 09240000
*   RESPOND TO THE APPLICATION                                          09250000
*---------------------------------------------------------------------- 09260000
                                                                        09270000
RUNNOTCL DS    0H                                                       09280000
                                                                        09290000
         MVC   SAVXPOS(L'AAPXPOS),AAPXPOS SAVE LAST KNOWN POSITION      09300000
         BAS   R14,SKSAPPLY            BANG THE KEYBOARD                09310000
                                                                        09320000
*---------------------------------------------------------------------- 09330000
* DRIVE THE SESSION                                                     09340000
*---------------------------------------------------------------------- 09350000
                                                                        09360000
RUNTOTHE DS    0H                                                       09370000
                                                                        09380000
         $INCR ICA_VSESS_TRANS         BUMP AID COUNTER                 09390000
                                                                        09400000
         $SLU2 TO_THE_PLU,                                             +09410000
               SLUHANDL=(RSLUHNDL),                                    +09420000
               READCMD=#3270RM         SEND INPUT TO APPL               09430000
                                                                        09440000
         B     *+4(R15)                ANALYZE COMPLETION STATUS        09450000
         B     RUNSENT                   RC00 - NORMAL                  09460000
         B     PE_EXSND                  RC04 - INPUT REJECT / PROTOCOL 09470000
         B     PE_EXSND                  RC08 - SEND FAILED             09480000
         B     PE_EXSND                  RC12 - RECEIVE FAILED          09490000
                                                                        09500000
RUNSENT  DS    0H                                                       09510000
                                                                        09520000
         MVC   PLNRETXP(L'MSG_KEYS_SENT),MSG_KEYS_SENT                  09530000
         NI    SEISTATE,255-SEIS_RSP   NO RESPONSE FROM HOST AS YET     09540000
         NI    SEISTATE,255-SEIS_CPT   NOT "COMPLETE" YET               09550000
         NI    SEISTATE,255-SEIS_FUS   NO LONGER "FROM USS" STATE       09560000
                                                                        09570000
         NI    AAPFLAG2,FF-AAPF2SAM    RELEASE DESTINATION STN BIND     09580000
         TM    FLAG2,FL2SAME           LOCK CONTINUES TO SPECIFIC STN?  09590000
         BNO   *+8                     SKIP IF NOT                      09600000
         OI    AAPFLAG2,AAPF2SAM       LOCK THE CURRENT STN AS RESULT   09610000
                                                                        09620000
         TM    FLAGS,FLSCVERT          VERTICAL SCROLL IN PROGRESS?     09630000
         BO    RETWAIT                 AWAIT NON-CONDITIONAL COMPLETE   09640000
                                                                        09650000
*---------------------------------------------------------------------- 09660000
* IDENTIFY IF WE ARE CONDITIONALLY/UNCONDITIONALLY GOING TO VTAM        09670000
*---------------------------------------------------------------------- 09680000
                                                                        09690000
         MVC   PEERPOS(L'AAPXPOS),AAPXPOS    SAVE PEER CHAIN 1ST POS.   09700000
         MVC   PEERLFLG,AAPFLAG2             SAVE PEER LAST ARC  139782 09710000
         NI    PEERLFLG,AAPF2LSA+AAPF2LNA    RESET OTHER FLAGS   139782 09720000
                                                                        09730000
RUNSTCHK DS    0H                                                       09740000
                                                                        09750000
         L     RNVSTN,NVAS1STN         DESTINATION NVSTN                09760000
         TM    NVSFLG,NVSFUSS          IS THIS "GOING TO VTAM" ?        09770000
         BNO   RUNSTAPP                BRANCH IF NOT                    09780000
         OI    FLAGS,FLVTAMST          VTAM STATE IS POSSIBLE           09790000
         B     RUNSTNXT                CHECK FOR OTHER OUTCOMES         09800000
                                                                        09810000
RUNSTAPP DS    0H                                                       09820000
                                                                        09830000
         OI    FLAGS,FLAPPLST          APPLICATION STATE IS POSSIBLE    09840000
                                                                        09850000
RUNSTNXT DS    0H                                                       09860000
                                                                        09870000
         L     R2,AAPXNARC             NVARC VECTOR                     09880000
         BCT   R2,RUNSTRES             ONLY 1ST ARC CAN BE COND         09890000
         ICM   RSUPRARC,15,SUPPEER     ADDRESS OF PEER SUPRARC          09900000
         BZ    RUNSTRES                BRANCH IF NO MORE PEERS          09910000
         ST    RSUPRARC,AAPXSARC       SET NEW SUPRARC                  09920000
                                                                        09930000
         XC    AAPXNARC,AAPXNARC       NO NVARC VECTOR                  09940000
         BAS   R14,NEWNARC             GO SET UP FOR FIRST NVARC        09950000
         B     RUNSTCHK                AND CHECK ITS' TRANSITIONS       09960000
                                                                        09970000
RUNSTRES DS    0H                                                       09980000
                                                                        09990000
         MVC   AAPXPOS(L'AAPXPOS),PEERPOS    RESTORE PEER CHAIN 1ST POS 10000000
         BAS   R14,GETNVARC                  RESTORE ARC/SUPRARC 960130 10010000
         NI    AAPFLAG2,FF-AAPF2LSA-AAPF2LNA RESET LAST ARC FLGS 139782 10020000
         OC    AAPFLAG2,PEERLFLG             RESTORE ARC  FLAGS  139782 10030000
                                                                        10040000
         TM    FLAGS,FLVTAMST             IS A VTAM STATE POSSIBLE?     10050000
         BNO   RETWAIT                    BRANCH IF NOT                 10060000
         OI    SEISTATE,SEIS_TUS+SEIS_CUS VTAM STATE IS POSSIBLE        10070000
         TM    FLAGS,FLAPPLST             IS AN APPL STATE POSSIBLE?    10080000
         BNO   RETWAIT                    BRANCH IF NOT                 10090000
         NI    SEISTATE,255-SEIS_TUS      VTAM STATE WOULD BE COND.     10100000
         B     RETWAIT                    WE ARE ALL DONE               10110000
                                                                        10120000
         EJECT                                                          10130000
**<DOC-ON>*****************************************************         10140000
*                                                                       10150000
*   Normal and abnormal plan end conditions                             10160000
*                                                                       10170000
*   The completion code staged in PLANRET can be augmented by a         10180000
*   reason code (PLANRSN) and two qualifier codes (PLANQ1 and           10190000
*   PLANQ2).                                                            10200000
*                                                                       10210000
*   The completion code word (AAP_COMPLETION) of the completion         10220000
*   code and flag bytes as described in NAV.AAP where the               10230000
*   primary completion and reason codes are also defined.               10240000
*                                                                       10250000
*   AAP_COMPFLAG_POSITIONED in AAP_COMPLETION_FLAGS may be set          10260000
*   to indicate that the current application state is known at          10270000
*   the time of normal/abnormal plan end.  If not set, the              10280000
*   application is terminated by the plan scheduler for any             10290000
*   non-zero value of APP_COMPLETION_CODE encountered in the            10300000
*   PLANEND response message.                                           10310000
*                                                                       10320000
**<DOC-OFF>****************************************************         10330000
                                                                        10340000
PE_ENVR9 DS    0H                                                       10350000
         MVI   PLANRSN+(L'PLANRSN-1),AAP_RSN_NO_NVAS1STN                10360000
         ST    RNVARC,PLANQ1      BAD POINTER WORD                      10370000
         B     PE_ENVIR           SEND PLANEND TO THE MASTER            10380000
                                                                        10390000
PE_ENVR7 DS    0H                                                       10400000
         MVI   PLANRSN+(L'PLANRSN-1),AAP_RSN_NVARC_VECTOR               10410000
         ST    RNVARC,PLANQ1      BAD VECTOR                            10420000
         MVC   PLANQ2,SUPARCS     MAXIMUM VECTOR DEFINED                10430000
         B     PE_ENVIR           SEND PLANEND TO THE MASTER            10440000
                                                                        10450000
PE_ENVR6 DS    0H                                                       10460000
         MVI   PLANRSN+(L'PLANRSN-1),AAP_RSN_NO_SUPRARC                 10470000
         B     PE_ENVIR           SEND PLANEND TO THE MASTER            10480000
                                                                        10490000
PE_ENVR5 DS    0H                                                       10500000
         MVI   PLANRSN+(L'PLANRSN-1),AAP_RSN_NO_IPROJ                   10510000
         B     PE_ENVIR           SEND PLANEND TO THE MASTER            10520000
                                                                        10530000
PE_ENVR4 DS    0H                                                       10540000
         MVI   PLANRSN+(L'PLANRSN-1),AAP_RSN_NO_IUSER                   10550000
         B     PE_ENVIR           SEND PLANEND TO THE MASTER            10560000
                                                                        10570000
PE_ENVR3 DS    0H                                                       10580000
         MVI   PLANRSN+(L'PLANRSN-1),AAP_RSN_NO_TSKPCBC                 10590000
         B     PE_ENVIR           SEND PLANEND TO THE MASTER            10600000
                                                                        10610000
PE_ENVR2 DS    0H                                                       10620000
         MVI   PLANRSN+(L'PLANRSN-1),AAP_RSN_NO_SESSIMAG                10630000
         B     PE_ENVIR           SEND PLANEND TO THE MASTER            10640000
                                                                        10650000
PE_ENVR1 DS    0H                                                       10660000
         MVI   PLANRSN+(L'PLANRSN-1),AAP_RSN_NO_AAP                     10670000
         B     PE_ENVIR           SEND PLANEND TO THE MASTER            10680000
                                                                        10690000
PE_ENVIR DS    0H                                                       10700000
         MVI   PLANRET+AAP_COMPLETION_CODE,AAP_RC_ENVIRONMENT           10710000
         B     PECOMMON           SEND PLANEND TO THE MASTER            10720000
                                                                        10730000
PE_ABEND DS    0H                 SOME ABEND OCCURRED                   10740000
         MVI   PLANRET+AAP_COMPLETION_CODE,AAP_RC_ABEND                 10750000
         B     PECOMMON           SEND PLANEND TO THE MASTER            10760000
                                                                        10770000
PE_IPREP DS    0H                                                       10780000
         L     R1,CIRSNCD         IMAGE FUNCTION REASON CODE            10790000
         @CALL IIMGDIAG,CTYPE=CVT                                       10800000
         ST    R1,IMSGSEG         IMAGE MESSAGE SEGMENT                 10810000
         ST    R0,IMSGSEGL        MESSAGE SEGMENT LENGTH                10820000
                                                                        10830000
         MVI   PLANRET+AAP_COMPLETION_CODE,AAP_RC_IMGPREP_FAILED        10840000
         MVC   PLANRSN,CIRETCD    PREP'S RETURN CODE IS OUR RSN         10850000
         MVC   PLANQ1,CIRSNCD     PREP'S REASON CODE IS OUR Q1          10860000
         B     PECOMMON           SEND PLANEND TO THE MASTER            10870000
                                                                        10880000
PE_IBLD1 DS    0H                                                       10890000
         MVI   PLANRET+AAP_COMPLETION_CODE,AAP_RC_IMGBLD1_FAILED        10900000
         ST    R15,PLANRSN        REASON CODE IS IMGBLD1 RC             10910000
         B     PECOMMON           SEND PLANEND TO THE MASTER            10920000
                                                                        10930000
PE_IMGLD DS    0H                                                       10940000
         MVI   PLANRET+AAP_COMPLETION_CODE,AAP_RC_IMGLOAD_FAILED        10950000
         ST    R15,PLANRSN        REASON CODE IS IMGLOAD RC             10960000
         B     PECOMMON           SEND PLANEND TO THE MASTER            10970000
                                                                        10980000
PE_IFREE DS    0H                                                       10990000
         MVI   PLANRET+AAP_COMPLETION_CODE,AAP_RC_IMGFREE_FAILED        11000000
         ST    R15,PLANRSN        REASON CODE IS IMGFREE RC             11010000
         B     PECOMMON           SEND PLANEND TO THE MASTER            11020000
                                                                        11030000
PE_SCRAP DS    0H                                                       11040000
         LA    R14,AAP_RC_SCRAPE_FAILED                                 11050000
         CH    R15,=AL2(RC04)     NAVIGATION DECISION ERROR?            11060000
         BNE   *+8                                                      11070000
         LA    R14,AAP_RC_NAV_DECISION                                  11080000
                                                                        11090000
         STC   R14,PLANRET+AAP_COMPLETION_CODE                          11100000
         OI    PLANRET+AAP_COMPLETION_FLAGS,AAP_COMPFLAG_POSITIONED     11110000
         ST    R15,PLANRSN        SERVICE RETURN CODE IS OUR REASON     11120000
         ST    R0,PLANQ1          SERVICE R0                            11130000
         ST    R1,PLANQ2          SERVICE R1                            11140000
         B     PECOMMON           SEND PLANEND TO THE MASTER            11150000
                                                                        11160000
PE_EXSCR DS    0H                                                       11170000
         MVI   PLANRET+AAP_COMPLETION_CODE,AAP_RC_SCRAPE_FAILED         11180000
         OI    PLANRET+AAP_COMPLETION_FLAGS,AAP_COMPFLAG_POSITIONED     11190000
         ST    R15,PLANRSN        SERVICE RETURN CODE IS OUR REASON     11200000
         ST    R0,PLANQ1          SERVICE R0                            11210000
         ST    R1,PLANQ2          SERVICE R1                            11220000
         B     PECOMMON           SEND PLANEND TO THE MASTER            11230000
                                                                        11240000
PE_EXSND DS    0H                                                       11250000
         MVI   PLANRET+AAP_COMPLETION_CODE,AAP_RC_$SLU2_FAILED          11260000
         ST    R15,PLANRSN        $SLU2 R15                             11270000
         ST    R0,PLANQ1          $SLU2 R0                              11280000
         ST    R1,PLANQ2          $SLU2 R1                              11290000
         B     PECOMMON           SEND PLANEND TO THE MASTER            11300000
                                                                        11310000
PE_EXCMP DS    0H                                                       11320000
         MVI   PLANRET+AAP_COMPLETION_CODE,AAP_RC_COMPARE_FAILED        11330000
         MVC   PLANRSN,CIRETCD    COMPARE'S RETURN CODE IS OUR RSN      11340000
         MVC   PLANQ1,CIRSNCD     COMPARE'S REASON CODE IS OUR Q1       11350000
         B     PECOMMON           SEND PLANEND TO THE MASTER            11360000
                                                                        11370000
PE_SKSLD DS    0H                                                       11380000
         MVI   PLANRET+AAP_COMPLETION_CODE,AAP_RC_SKSLOAD_FAILED        11390000
         OI    PLANRET+AAP_COMPLETION_FLAGS,AAP_COMPFLAG_POSITIONED     11400000
         ST    R15,PLANRSN        REASON CODE IS SKSLOAD RC             11410000
         B     PECOMMON           SEND PLANEND TO THE MASTER            11420000
                                                                        11430000
PE_SKSRN DS    0H                                                       11440000
         MVI   PLANRET+AAP_COMPLETION_CODE,AAP_RC_SKSRUN_FAILED         11450000
         ST    R15,PLANRSN        SKSRUN RETURN CODE IS OUR REASON      11460000
         B     PECOMMON           SEND PLANEND TO THE MASTER            11470000
                                                                        11480000
PE_IOP   DS    0H                                                       11490000
         MVI   PLANRET+AAP_COMPLETION_CODE,AAP_RC_UNEXPECTED_INPUT      11500000
         B     PECOMMON           SEND PLANEND TO THE MASTER            11510000
                                                                        11520000
PE_TIMER DS    0H                                                       11530000
         MVI   PLANRET+AAP_COMPLETION_CODE,AAP_RC_TIMER_FAILED          11540000
         B     PECOMMON           SEND PLANEND TO THE MASTER            11550000
                                                                        11560000
PE_SGNE  DS    0H                                                       11570000
         MVI   PLANRET+AAP_COMPLETION_CODE,AAP_RC_SESSION_GONE          11580000
         B     PECOMMON           SEND PLANEND TO THE MASTER            11590000
                                                                        11600000
PE_IMGO  DS    0H                                                       11610000
         CLC   Z.SPLRETCD,=A($SESS_RC_TOT_RECEIVE_DATA)                 11620000
         BE    PE_LOST            WE ARE LOST IF TIMER POPPED           11630000
         MVI   PLANRET+AAP_COMPLETION_CODE,AAP_RC_ISLUIMGO              11640000
         ST    R1,PLANRSN         ISLUIMGO RETURN CODE IS THE REASON    11650000
         ST    R2,PLANQ1          ISLUIMGO REASON PASSED AS QUALIFIER   11660000
         B     PECOMMON           SEND PLANEND TO THE MASTER            11670000
                                                                        11680000
PE_LOST  DS    0H                                                       11690000
         XC    AAPCURR,AAPCURR    CURRENT POSITION IS UNKNOWN           11700000
         ICM   R1,15,AAPCIRSN     IMAGE FUNCTION REASON CODE            11710000
         BZ    PE_LOST1                                                 11720000
         @CALL IIMGDIAG,CTYPE=CVT                                       11730000
         ST    R1,IMSGSEG         IMAGE MESSAGE SEGMENT                 11740000
         ST    R0,IMSGSEGL        MESSAGE SEGMENT LENGTH                11750000
                                                                        11760000
PE_LOST1 DS    0H                                                       11770000
         TM    SEISTATE,SEIS_RSP  HOST FAILED TO RESPOND?               11780000
         BNO   PE_RESP            DIFFERENTIATE FROM UNKNOWN RESPONSE   11790000
         MVI   PLANRET+AAP_COMPLETION_CODE,AAP_RC_LOST                  11800000
         B     PECOMMON                                                 11810000
                                                                        11820000
PE_RESP  DS    0H                 HOST HAS NOT RESPONDED TO INPUT       11830000
         MVI   PLANRET+AAP_COMPLETION_CODE,AAP_RC_NO_APPL_RESPONSE      11840000
         B     PECOMMON                                                 11850000
                                                                        11860000
*--------------------------------------------------------------         11870000
*   NORMAL PLAN ENDINGS, WITH QUALIFICATION                             11880000
*--------------------------------------------------------------         11890000
                                                                        11900000
PLANEND  DS    0H                                                       11910000
                                                                        11920000
         MVI   PLANRET+AAP_COMPLETION_CODE,AAP_RC_SUCCESS               11930000
         B     PECOMMON                                                 11940000
                                                                        11950000
PLANEXCP DS    0H                                                       11960000
                                                                        11970000
         MVI   PLANRET+AAP_COMPLETION_CODE,AAP_RC_SUCCESS               11980000
         MVI   PLANRSN+(L'PLANRSN-1),AAP_RSN_EXCEPTION                  11990000
         B     PECOMMON                                                 12000000
                                                                        12010000
PLANTSLM DS    0H                                                       12020000
                                                                        12030000
         MVI   PLANRET+AAP_COMPLETION_CODE,AAP_RC_SUCCESS               12040000
         MVI   PLANRSN+(L'PLANRSN-1),AAP_RSN_TSELMATCH                  12050000
                                                                        12060000
*--------------------------------------------------------------         12070000
*   DOCUMENT REASON FOR PLAN END / TERMINATION                          12080000
*--------------------------------------------------------------         12090000
                                                                        12100000
PECOMMON DS    0H                                                       12110000
                                                                        12120000
         MVI   PLNRETXP,C' '      CLEAR                                 12130000
         MVC   PLNRETXP+1(L'PLNRETXP-1),PLNRETXP                        12140000
         SR    R15,R15            PREPARE FOR INSERT                    12150000
         ICM   R15,7,PLANRET+1    PLAN END RETURN CODE                  12160000
         SLL   R15,3              RETCODE * 8                           12170000
         L     R1,=A(PRETEXPL)    PLANRET EXPLANATIONS                  12180000
         LA    R1,0(R15,R1)       ADDRESS OF APPROPRIATE EXPLANATION    12190000
                                                                        12200000
         LTR   R15,R15            SUCCESSFUL PLAN END?                  12210000
         BNZ   PEXPLAIN           SKIP IF NOT                           12220000
                                                                        12230000
         CLC   PLANRSN,=A(AAP_RSN_EXCEPTION)                            12240000
         BNE   *+8                NOT EXCEPTION STATE                   12250000
         L     R1,=A(EXP_EXCP)    SELECT APPROP STATUS                  12260000
                                                                        12270000
         CLC   PLANRSN,=A(AAP_RSN_TSELMATCH)                            12280000
         BNE   *+8                NOT TABLE SELECT ARGUMENT MISMATCH    12290000
         L     R1,=A(EXP_TSEL)    SELECT APPROP STATUS                  12300000
                                                                        12310000
PEXPLAIN DS    0H                                                       12320000
                                                                        12330000
         LM    R14,R15,0(R1)      TEXT PTR / TEXT LENGTH                12340000
         BCTR  R15,0              TEXT LENGTH CODE                      12350000
         EX    R15,*+4            INSERT TEXT SEGMENT                   12360000
         MVC   PLNRETXP(*-*),0(R14)                                     12370000
                                                                        12380000
*--------------------------------------------------------------         12390000
*   RESTORE LAST KNOWN POSITION IF POSITION LOST  ??????? rjc           12400000
*--------------------------------------------------------------         12410000
                                                                        12420000
         TM    PLANRET+AAP_COMPLETION_FLAGS,AAP_COMPFLAG_POSITIONED     12430000
         BO    PERETPOS           RETAIN CURRENT POSITION               12440000
                                                                        12450000
         OC    SAVXPOS(L'AAPXPOS),SAVXPOS NO SUPRARC PTR SAVED   139782 12460000
         BZ    PERETPOS           DO NOT OVERLAY CURRENT SUPRARC 139782 12470000
         MVC   AAPXPOS(L'AAPXPOS),SAVXPOS SET LAST KNOWN POSITION       12480000
                                                                        12490000
PERETPOS DS    0H                                                       12500000
                                                                        12510000
         MVC   RETR15,=F'28'      RET CODE IS 28 "PLAN END-NO PLAN"     12520000
         MVC   PLANSTAT(L'MSG_NO_PLAN_ACT),MSG_NO_PLAN_ACT              12530000
                                                                        12540000
         TM    AAPFLAG2,AAPF2XEQ  ARE WE EXECUTING A PLAN?              12550000
         BNO   RETURN             BRANCH IF NOT                         12560000
         OI    FLAGS,FLPLANND     REMEMBER TO CALL PLAN END POSTER      12570000
                                                                        12580000
         MVC   RETR15,=F'-2'      RETURN CODE IS "TRUE PLAN END"        12590000
         CLC   =A(AAP_RC_SUCCESS),PLANRET                               12600000
         BE    *+8                NO PC NOTIFICATION IF SUCCESS         12610000
         MVI   ADDESTS,$IMSGQ     RETURN PLAN-END MSGS TO REMOTE        12620000
                                                                        12630000
         MVC   PLANSTAT(L'MSG_PLAN_END),MSG_PLAN_END                    12640000
         B     RETURN             RETURN TO CALLER                      12650000
                                                                        12660000
         EJECT                                                          12670000
***************************************************************         12680000
*                                                                       12690000
*   Normal and abnormal cleanup and termination sequence.  If           12700000
*   control passes to RETWAIT to await further input.  In this          12710000
*   case, the session timer is reactivated.                             12720000
*                                                                       12730000
***************************************************************         12740000
                                                                        12750000
RETWAIT  DS    0H                                                       12760000
                                                                        12770000
         OI    FLAG2,FL2SETIM     SET SESS TIMER UPON EXIT              12780000
                                                                        12790000
RETURN   DS    0H                                                       12800000
                                                                        12810000
         BAS   R14,IMGFREE        RELEASE IMAGE IF ANY                  12820000
         L     R15,=A(TRCNMSG)    TRACE AND DIAGNOSTIC MESSAGE ROUTINE  12830000
         BASR  R14,R15            CUT TRACE ENTRY AND ISSUE DIAG. MSG   12840000
                                                                        12850000
         TM    FLAG2,FL2SETIM     SET SESS TIMER UPON EXIT?             12860000
         BNO   RETCONT            SKIP IF NOT                           12870000
         BAS   R14,TIMERON        SET THE RECEIVE DATA TIMER            12880000
         LTR   R15,R15            IS TIMER SET?                         12890000
         BNZ   PE_TIMER           BRANCH IF NOT                         12900000
                                                                        12910000
*--------------------------------------------------------------         12920000
*   ENSURE TVBRVEC AND ASSOC IMAGES CLEANED AT END OF PLAN              12930000
*--------------------------------------------------------------         12940000
                                                                        12950000
RETCONT  DS    0H                                                       12960000
                                                                        12970000
         ICM   R15,15,RETR15      PLAN COMPLETE OR TERMINATED?          12980000
         BZ    RETEXIT            SKIP IF STILL RUNNING                 12990000
                                                                        13000000
         XC    AAPXPLAN,AAPXPLAN  NO PLAN ACTIVE                        13010000
         MVI   AAPFLAG2,0         PLAN NO LONGER ACTIVE                 13020000
                                                                        13030000
         ICM   R1,15,AAPNAVP      R1 <== $NAVPARM                       13040000
         BZ    RETEXIT            SKIP IF N/A                           13050000
                                                                        13060000
         @CALL IRUNCLNV,CTYPE=STD                                       13070000
                                                                        13080000
RETEXIT  DS    0H                                                       13090000
                                                                        13100000
*---------------------------------------------------------------------- 13110000
*   NOTIFY REQUESTER IF PLAN END AND CLEANUP                            13120000
*---------------------------------------------------------------------- 13130000
                                                                        13140000
         TM    FLAGS,FLPLANND     CALL PLAN END POSTER ?                13150000
         BNO   RETXIT2            BRANCH IF NOT                         13160000
                                                                        13170000
         @CALL IRUNXTRM,                                        R211219X13180000
               (SLUHANDL,*PLANRET,*PLANRSN,*PLANQ1,*PLANQ2),    R211219X13190000
               CTYPE=STD,                                       R211219X13200000
               MF=(E,MFE_LIST)                                  R211219 13210000
                                                                        13220000
RETXIT2  DS    0H                                                       13230000
                                                                        13240000
*---------------------------------------------------------------------- 13250000
*   RETURN TO CALLER                                                    13260000
*---------------------------------------------------------------------- 13270000
                                                                        13280000
         TM    FLAGS,FLRECOV      RECOVERY ENVIRON ESTABLISHED?         13290000
         BNO   RETXIT3            DONE IF NOT                           13300000
                                                                        13310000
         $RCVRY DELETE,MF=(E,MFE_LIST)                                  13320000
                                                                        13330000
RETXIT3  DS    0H                                                       13340000
                                                                        13350000
         LM    R15,R1,RETREGS     RETURN VALUES                         13360000
                                                                        13370000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    13380000
                                                                        13390000
         EJECT                                                          13400000
***************************************************************         13410000
*                                                                       13420000
* ROUTINE:  BS0S0ARC                                                    13430000
*                                                                       13440000
* DESCRIPTION:                                                          13450000
*                                                                       13460000
*    Construct an nvarc in working storage that can be used             13470000
*    to perform scroll transitions that are not represented in          13480000
*    standard plans.                                                    13490000
*                                                                       13500000
* ON ENTRY:                                                             13510000
*                                                                       13520000
*    R0 - addr of scrolling NVUSUCC                                     13530000
*                                                                       13540000
* ON EXIT:                                                              13550000
*                                                                       13560000
*    RNVARC - contains the address of the pseudo NVARC                  13570000
*                                                                       13580000
***************************************************************         13590000
                                                                        13600000
BS0S0ARC DS    0H                                                       13610000
                                                                        13620000
         ST    R14,FWORD               RETAIN RETURN ADDRESS            13630000
                                                                        13640000
         LR    R14,R0                  SCROLL SUCCESSOR ENTRY           13650000
         USING NVUSUCC,R14                                              13660000
         LA    R14,NVUENTRY+((NVUESCRD-1)*NVUENTLN)                     13670000
         USING NVUENTRY,R14            SCROLL (DOWN) MODEL ENTRY        13680000
                                                                        13690000
         XC    $NVARC,$NVARC           INITIALIZE WORKING ELEM ARC      13700000
A        USING NVARC,$NVARC            SWITCH TO MOCK-UP ARC            13710000
                                                                        13720000
         LA    R1,SUPS1STN             SET FOR S1->S1 SCROLLING  960126 13730000
         TM    AAPFLAG3,AAPF3SS0       SCROLLING S0->S0 ?        960126 13740000
         BNO   USESUPS1                BRANCH IF NOT             960126 13750000
         LA    R1,SUPS0STN             SET FOR S0->S0 SCROLLING  960126 13760000
                                                                        13770000
USESUPS1 DS    0H                                                960126 13780000
                                                                        13790000
         MVC   A.NVAS0STN,0(R1)        INHERIT STNS FROM SUPRARC 960126 13800000
         MVC   A.NVAS1STN,0(R1)        SCROLL OP RETAINS STATE   960126 13810000
                                                                        13820000
         LTR   RNVARC,RNVARC           ELEMENTARY ARC SUBSTITUTION?     13830000
         BZ    BS0CONT                                                  13840000
         LA    R1,NVAS1STN             SET FOR S1->S1 SCROLLING  960126 13850000
         TM    AAPFLAG3,AAPF3SS0       SCROLLING S0->S0 ?        960126 13860000
         BNO   USENVAS1                BRANCH IF NOT             960126 13870000
         LA    R1,NVAS0STN             SET FOR S0->S0 SCROLLING  960126 13880000
                                                                        13890000
USENVAS1 DS    0H                                                960126 13900000
                                                                        13910000
         MVC   A.NVAS0STN,0(R1)        INHERIT STNS FROM NVARC   960126 13920000
         MVC   A.NVAS1STN,0(R1)        SCROLL OP RETAINS STATE   960126 13930000
                                                                        13940000
BS0CONT  DS    0H                                                       13950000
                                                                        13960000
         MVC   A.NVAATTRS,NVUATTRS     INHERIT LINKAGE ATTRIBUTES       13970000
         MVC   A.NVAAID,NVUESAID       SCROLL AID KEY                   13980000
         MVC   A.NVASKSID,NVUSKSID     SCROLL SKS                       13990000
         MVC   A.NVAIMGID,NVUIMGID     SCROLL SOURCE SYSIMAGE ROWID+    14000000
         LA    R0,NVUSKSA              RUN-READY SCRIPT ANCHOR IN STN   14010000
         ST    R0,A.NVASKSAA           ASSOCIATE WITH MOCK ARC          14020000
         DROP  R14,A                   NVUENTRY, SUPRARC, MOCK-UP ARC   14030000
                                                                        14040000
         LA    RNVARC,$NVARC           SWITCH TO SCROLLER MOCK-UP ARC   14050000
         L     R14,FWORD               RESTORE RETURN ADDRESS           14060000
         SR    R15,R15                 RETURN CODS NOT DEFINED          14070000
         BR    R14                     RETURN                           14080000
                                                                        14090000
         EJECT                                                          14100000
*---------------------------------------------------------------------- 14110000
* SUBROUTINE NEXTPLAN: MOVE EXECUTION TO NEXT PLAN, SUPRARC, AND NVARC  14120000
*            NEXTSARC: MOVE EXECUTION TO NEXT SUPRARC AND NVARC IN PLAN 14130000
*            NEXTNARC: MOVE EXECUTION TO NEXT NVARC IN SUPRARC          14140000
*                                                                       14150000
* ENTRY:  AAP                                                           14160000
*                                                                       14170000
* RETURN: AAPXPLAN = CURRENT PLAN    VECTOR                             14180000
*         AAPXSARC = CURRENT SUPRARC ADDRESS                            14190000
*         AAPXNARC = CURRENT NVARC   VECTOR                             14200000
*         RSUPRARC = CURRENT SUPRARC ADDRESS                            14210000
*         RNVARC   = CURRENT NVARC   ADDRESS                            14220000
*---------------------------------------------------------------------- 14230000
                                                                        14240000
NEWPLAN  DS    0H                                                       14250000
                                                                        14260000
         STM   R14,R3,SUB0SAVE            SAVE REGISTERS                14270000
         MVC   SAVXPOS(L'AAPXPOS),AAPXPOS SAVE LAST KNOWN POSITION      14280000
         B     NEXTPLAN                   NOW POSITION IT               14290000
                                                                        14300000
NEWNARC  DS    0H                                                       14310000
                                                                        14320000
         STM   R14,R3,SUB0SAVE            SAVE REGISTERS                14330000
         MVC   SAVXPOS(L'AAPXPOS),AAPXPOS SAVE LAST KNOWN POSITION      14340000
         B     NEXTNARC                   NOW POSITION IT               14350000
                                                                        14360000
NEXTPLAN DS    0H                                                       14370000
                                                                        14380000
         XC    AAPXSARC,AAPXSARC     SHOW NO SUPRARC                    14390000
         XC    AAPXSRC#,AAPXSRC#     SHOW NO SUPRARC VECTOR             14400000
         XC    AAPXNARC,AAPXNARC     SHOW NO NVARC                      14410000
         SR    RSUPRARC,RSUPRARC     SHOW NO SUPRARC                    14420000
         SR    RNVARC,RNVARC         SHOW NO NVARC                      14430000
                                                                        14440000
         L     R3,AAPXPLAN           CURRENT PLAN VECTOR                14450000
         LA    R2,1(,R3)             BUMP PLAN VECTOR                   14460000
         ST    R2,AAPXPLAN           SET UPDATED PLAN VECTOR            14470000
         M     R2,=A(PLANLN)         PLAN OFFSET                        14480000
         LA    R3,AAPPLANS(R3)       ADDRESS OF PLAN                    14490000
         LA    R2,AAPPLEND           ADDRESS OF LAST PLAN END           14500000
         CR    R3,R2                 ARE ALL PLANS FINISHED?            14510000
         BNL   PLANEND               BRANCH IF YES                      14520000
                                                                        14530000
X        USING PLAN,R3                                                  14540000
         OC    X.PLVISITS,X.PLVISITS IS THIS A NULL PLAN?               14550000
         BZ    NEXTPLAN              BRANCH IF YES                      14560000
         DROP  X                                                        14570000
                                                                        14580000
NEXTSARC DS    0H                                                       14590000
                                                                        14600000
         XC    AAPXNARC,AAPXNARC     SHOW NO NVARC                      14610000
         SR    RNVARC,RNVARC         SHOW NO NVARC                      14620000
         ICM   RSUPRARC,15,AAPXSARC  CURRENT SUPRARC                    14630000
         BNZ   NSARCNXT              BRANCH IF WE HAVE A SUPRARC        14640000
         L     R1,AAPXPLAN           CURRENT PLAN VECTOR                14650000
         BCTR  R1,0                  MINUS 1                            14660000
         M     R0,=A(PLANLN)         PLAN OFFSET                        14670000
         LA    R3,AAPPLANS(R1)       R3 = PLAN BLOCK                    14680000
X        USING PLAN,R3                                                  14690000
         L     RSUPRARC,X.PLSTART    FIRST SUPRARC                      14700000
                                                                        14710000
         ST    RSUPRARC,AAPXSARC     SET CURRENT SUPRARC                14720000
         MVC   AAPXSRC#,=F'1'        SET CURRENT SUPRARC VECTOR         14730000
         B     NEXTNARC              CHECK IF LAST SUPRARC              14740000
         DROP  X                                                        14750000
                                                                        14760000
NSARCNXT DS    0H                                                       14770000
                                                                        14780000
         ICM   RSUPRARC,15,SUPNEXT   NEXT SUPRARC IN HEIRARCHY          14790000
         BZ    NEXTPLAN              GO TO NEXT PLAN WHEN EXHAUSTED     14800000
         ST    RSUPRARC,AAPXSARC     SET NEW SUPRARC                    14810000
         L     R1,AAPXSRC#           CURRENT SUPRARC VECTOR             14820000
         LA    R1,1(,R1)             UPDATE                             14830000
         ST    R1,AAPXSRC#           SET UPDATED SUPRARC VECTOR         14840000
                                                                        14850000
NEXTNARC DS    0H                                                       14860000
                                                                        14870000
         L     RNVARC,AAPXNARC       NVARC VECTOR                       14880000
         LA    R1,1(,RNVARC)         NEW NVARC VECTOR                   14890000
         ST    R1,AAPXNARC           SET UPDATED NVARC VECTOR           14900000
                                                                        14910000
         BAS   R14,GETNVARC          GO SET RNVARC                      14920000
                                                                        14930000
         LTR   RNVARC,RNVARC         NVARCS EXHAUSTED?                  14940000
         BNZ   NEXTRET               DONE IF NOT                        14950000
         CLC   AAPXNARC,=F'1'        REQUESTING FIRST NVARC?            14960000
         BNE   NEXTSARC              END OF NVARC LIST IF NOT           14970000
*                                    ELSE ALLOW FOR SCRAPE-FIRST/ONLY   14980000
                                                                        14990000
NEXTRET  DS    0H                                                       15000000
                                                                        15010000
         LM    R14,R3,SUB0SAVE       RESTORE REGISTERS                  15020000
         BR    R14                   RETURN                             15030000
                                                                        15040000
         EJECT                                                          15050000
***************************************************************         15060000
*                                                                       15070000
* ROUTINE: GETNVARC - Locate SUPRARC / NVARC and their attributes       15080000
*                                                                       15090000
* DESCRIPTION:                                                          15100000
*                                                                       15110000
*    This routine is used to identify the current SUPRARC and           15120000
*    NVARC pair, if any, by loading their addresses or zeros            15130000
*    into their standard base regs; RSUPRARC and RNVARC,                15140000
*    respectively.  Additionally, various attributes including          15150000
*    last-SUPRARC, last-NVARC, and table-select are set or              15160000
*    reset accordingly.                                                 15170000
*                                                                       15180000
* ENTRY:  AAP                                                           15190000
*                                                                       15200000
* RETURN: RNVARC, RSUPRARC                                              15210000
*                                                                       15220000
***************************************************************         15230000
                                                                        15240000
GETNVARC DS    0H                                                       15250000
                                                                        15260000
         STM   R14,R2,SUB1SAVE        SAVE REGISTERS                    15270000
                                                                        15280000
         SR    RSUPRARC,RSUPRARC      NOT OBTAINED YET                  15290000
         SR    RNVARC,RNVARC          NOT OBTAINED YET                  15300000
         NI    AAPFLAG2,FF-AAPF2LSA-AAPF2LNA   RESET LAST ARC FLAGS     15310000
         NI    FLAG2,FF-FL2TSEL       S1 IS A TABLE SELECT              15320000
                                                                        15330000
*------------------------------------------------------------           15340000
*   Identify SUPRARC and associated attributes                          15350000
*------------------------------------------------------------           15360000
                                                                        15370000
         ICM   RSUPRARC,15,AAPXSARC   SUPRARC POINTER                   15380000
         BZ    GETNVRET               BRANCH IF NO SUPRARC              15390000
                                                                        15400000
         ICM   R15,15,SUPNEXT         LAST SUPRARC?                     15410000
         BNZ   GETNVATR               SKIP IF NOT                       15420000
         OI    AAPFLAG2,AAPF2LSA      INDICATE TERMINAL STATE           15430000
         B     GETNVIN                AND CONTINUE                      15440000
                                                                        15450000
GETNVATR DS    0H                                                       15460000
                                                                        15470000
         TM    SUPLKATR-SUPRARC(R15),SUPLTSEL                           15480000
         BNO   GETNVIN                                           960126 15490000
         OI    FLAG2,FL2TSEL          S1 DRIVES A TABLE SELECT          15500000
                                                                        15510000
*------------------------------------------------------------           15520000
*   Identify NVARC, if any, and associated attributes                   15530000
*------------------------------------------------------------           15540000
                                                                        15550000
GETNVIN  DS    0H                                                       15560000
                                                                        15570000
         ICM   R2,15,AAPXNARC         NVARC VECTOR                      15580000
         BNP   GETNVRET               BRANCH IF NO VECTOR               15590000
         C     R2,SUPARCS             IS VECTOR REASONABLE?             15600000
         BH    GETNVRET               BRANCH IF NOT                     15610000
         BL    *+8                    SKIP IF NOT LAST NVARC     124329 15620000
         OI    AAPFLAG2,AAPF2LNA      LAST NVARC W/IN SUPRARC    124329 15630000
                                                                        15640000
         BCTR  R2,0                   ENTRY NUMBER AS INDEX             15650000
         MH    R2,=AL2(NVARCLN)       ENTRY OFFSET                      15660000
         ICM   R1,15,SUPARCL          NVARC TABLE                       15670000
         BZ    PE_ENVIR               BRANCH IF NO TABLE                15680000
         LA    RNVARC,0(R2,R1)        NVARC POINTER                     15690000
                                                                        15700000
GETNVRET DS    0H                                                       15710000
                                                                        15720000
         LM    R14,R2,SUB1SAVE        RESTORE REGISTERS                 15730000
         BR    R14                    RETURN TO CALLER                  15740000
                                                                        15750000
                                                                        15760000
*---------------------------------------------------------------------- 15770000
* SUBROUTINE IMGMAKE: PREPARE A TEMPORARY NVSTN AND IMAGE FOR SKSLOAD   15780000
*                                                                       15790000
* ENTRY:  NVSIMGID                                                      15800000
*         (THE REAL IMAGE ID FOR THE CURRENT NVSTN)                     15810000
*                                                                       15820000
* RETURN: R1  = 0 --> NO IMAGE LOADED                                   15830000
*             =!0 --> NEW IMAGE STRUCTURE ADDRESS                       15840000
*---------------------------------------------------------------------- 15850000
                                                                        15860000
IMGMAKE  DS    0H                                                       15870000
                                                                        15880000
         STM   R0,R15,SUB1SAVE                                          15890000
                                                                        15900000
         LA    R2,NVSTNLN                                               15910000
         BCTR  R2,0               PREPARE TO 'EX' A MVC                 15920000
         EX    R2,*+4                                                   15930000
         MVC   NEWSTN(0),0(RNVSTN)  MAKE A COPY FOR THE STN             15940000
         LA    RNVSTN,NEWSTN                                            15950000
         ST    R1,NVSIMGID        SET THE REAL IMAGE ID                 15960000
         XC    NVSIMGA,NVSIMGA    INDICATE NEW IMAGE IS NEEDED          15970000
                                                                        15980000
         @CALL IIMGLOAD,                                         960130+15990000
               (*#PCBSTG,(RNVSTN)),                              960130+16000000
               CTYPE=CVT,                                        960130+16010000
               MF=(E,MFE_LIST)                                   960130 16020000
                                                                        16030000
         C     R15,=A(RC04)       ALMOST LOADED?                        16040000
         BH    ERRIMGLD           BRANCH IF NOT                         16050000
         SR    R15,R15            SET RETURN CODE                       16060000
         L     R1,NVSIMGA         R1 IS THE NEW IMAGE ADDRESS           16070000
         B     STNMEXIT           READY TO RETURN                       16080000
                                                                        16090000
ERRIMGLD DS    0H                 SET RETURN CODE                       16100000
                                                                        16110000
         LA    R15,RC04                                                 16120000
                                                                        16130000
STNMEXIT DS    0H                                                       16140000
                                                                        16150000
         LM    R2,R14,SUB1SAVE+8  RESTORE CALLER'S REGISTERS            16160000
         BR    R14                RETURN TO CALLER                      16170000
                                                                        16180000
*---------------------------------------------------------------------- 16190000
* SUBROUTINE SCRAPE: SCRAPE VARIABLES FROM A SESSIMAG BUFFER            16200000
*                                                                       16210000
* ENTRY:  RAAP, #IMAGE, #VMPOOL, #USRSTG                                16220000
*         R0  = TERMINAL STATE INDICATOR (TRUE OR FALSE)                16230000
*         R1  = NVSTN                                                   16240000
*                                                                       16250000
* RETURN: R15 = SCRAPE RETURN CODE                                      16260000
*         R0  = SCRAPE RETURN INFORMATION                               16270000
*         R1  = SCRAPE RETURN INFORMATION                               16280000
*---------------------------------------------------------------------- 16290000
                                                                        16300000
SCRAPE   DS    0H                                                       16310000
                                                                        16320000
         STM   R14,R2,SUB0SAVE               SAVE REGISTERS             16330000
                                                                        16340000
X        USING RUNSCOOP,MFE_LIST                                        16350000
         XC    X.RUNSCOOP(RUNSLN),X.RUNSCOOP CLEAR THE PARM LIST        16360000
                                                                        16370000
         ST    R0,X.RUNSTERM                 T/F: TERMINAL STATE        16380000
         ST    R1,X.RUNSSTN                  SET NVSTN FOR STATE @      16390000
                                                                        16400000
         MVC   X.RUNSNAVP,AAPNAVP            SET $NAVPARM @             16410000
         MVC   X.RUNSIMAG,#IMAGE             SET NVIMAGE FOR SESSIMAG @ 16420000
         MVC   X.RUNSVPOL,#VMPOOL            SET VMPOOL @               16430000
         MVC   X.RUNSQH,AAPQHMSG             SET STGMGR QH @            16440000
         MVC   X.RUNSMSGQ,AAPMSGQA           SET MESSAGE QUEUE ANCHOR @ 16450000
                                                                        16460000
         CLC   AAPXPLAN,=A(AAPXPV_DATA)      DATA (RUN) PLAN ACTIVE?    16470000
         BNE   *+10                          SKIP IF NOT                16480000
         MVC   X.RUNSDATA,=A(TRUE)           ELIGIBLE FOR RESULT SET    16490000
                                                                        16500000
         TM    FLAG2,FL2TSEL                 TABLE SELECT OPERATION?    16510000
         BNO   *+10                          SKIP IF NOT                16520000
         MVC   X.RUNSTSEL,=A(TRUE)           SET PARM ACCORDINGLY       16530000
                                                                        16540000
         LA    R1,X.RUNSCOOP                 PARM LIST ADDRESS          16550000
         L     R15,#RUNSCUP                  ROUTINE ENTRY ADDRESS      16560000
         BASR  R14,R15                       LINK TO THE SCRAPER        16570000
         DROP  X                                                        16580000
                                                                        16590000
         L     R14,SUB0SAVE                  RESTORE REGISTERS          16600000
         L     R2,SUB0SAVE+16                RESTORE REGISTERS          16610000
         BR    R14                           RETURN TO CALLER           16620000
                                                                        16630000
*---------------------------------------------------------------------- 16640000
* SUBROUTINE BUILD1: CALL IMGBLD1 TO CREATE NVIMAGE FOR BUFFER          16650000
*                                                                       16660000
* ENTRY:  SESSIMAG                                                      16670000
*                                                                       16680000
* RETURN: ALL REGISTERS ARE RESTORED                                    16690000
*                                                                       16700000
*---------------------------------------------------------------------- 16710000
                                                                        16720000
BUILD1   DS    0H                                                       16730000
                                                                        16740000
         STM   R14,R12,SUB1SAVE   SAVE REGISTERS                        16750000
                                                                        16760000
         OC    #IMAGE,#IMAGE      IS THE IMAGE BUILT ALREADY?           16770000
         BNZ   BUILT1             BRANCH IF YES                         16780000
                                                                        16790000
         LH    R2,SEIS1ROW                                       960130 16800000
         LH    R3,SEIS1COL                                       960130 16810000
                                                                        16820000
         @CALL IIMGBLD1,                                         960130+16830000
               (*#PCBSTG,*SEIS1IMG,(R2),(R3),*SEISCSR),          960130+16840000
               CTYPE=CVT,                                        960130+16850000
               MF=(E,MFE_LIST)                                   960130 16860000
                                                                        16870000
         LTR   R15,R15            GOT AN IMAGE?                         16880000
         BNP   PE_IBLD1                                                 16890000
         ST    R15,#IMAGE         SAVE THE IMAGE POINTER                16900000
         LA    R1,#IMAGE                                                16910000
         ST    R1,##IMAGE         SET THE POINTER POINTER FOR IMGFREE   16920000
                                                                        16930000
BUILT1   DS    0H                                                       16940000
                                                                        16950000
         LM    R14,R12,SUB1SAVE   RESTORE REGISTERS                     16960000
         BR    R14                RETURN TO CALLER                      16970000
                                                                        16980000
*---------------------------------------------------------------------- 16990000
* SUBROUTINE PREP: CALL IMGPREP TO PREPARE IMAGES FOR COMPARE/SCRAPE    17000000
*                                                                       17010000
* ENTRY:  #IMAGE   =(ADDRESS OF NVIMAGE BUILT FOR SESSIMAG)             17020000
*         #PROJSTG =(ADDRESS OF APPROPRIATE STGMGR QH)                  17030000
*         R1       =(ADDRESS OF RELATED NVSTN)                          17040000
*                                                                       17050000
* RETURN: ALL REGISTERS ARE RESTORED                                    17060000
*                                                                       17070000
*---------------------------------------------------------------------- 17080000
                                                                        17090000
PREP     DS    0H                                                       17100000
                                                                        17110000
         STM   R14,R12,SUB1SAVE   SAVE REGISTERS                        17120000
         LR    RNVSTN,R1          PASSED PARM                           17130000
                                                                        17140000
*                                                                       17150000
* LOAD THE IMAGE FOR THE NETWORK IF NOT DONE SO ALREADY                 17160000
*---------------------------------------------------------------------- 17170000
                                                                        17180000
         OC    NVSIMGA,NVSIMGA    IS THE IMAGE LOADED?                  17190000
         BNZ   COMPLDED           BRANCH IF YES                         17200000
                                                                        17210000
         @CALL IIMGLOAD,                                         960130+17220000
               (*#PROJSTG,(RNVSTN)),                             960130+17230000
               CTYPE=CVT,                                        960130+17240000
               MF=(E,MFE_LIST)                                   960130 17250000
                                                                        17260000
         C     R15,=A(RC04)       ALMOST LOADED?                        17270000
         BH    PE_IMGLD           BRANCH IF NOT                         17280000
                                                                        17290000
COMPLDED DS    0H                                                       17300000
                                                                        17310000
*                                                                       17320000
* PREPARE THE IMAGES FOR COMPARE                                        17330000
*---------------------------------------------------------------------- 17340000
                                                                        17350000
         @CALL IIMGPREP,                                         960130+17360000
               (*#PCBSTG,*NVSIMGA,*#IMAGE,#CMPINFO),             960130+17370000
               CTYPE=CVT,                                        960130+17380000
               MF=(E,MFE_LIST)                                   960130 17390000
                                                                        17400000
         MVC   AAPCIRC,CIRETCD    RETURN CODE                           17410000
         MVC   AAPCIRSN,CIRSNCD   REASON CODE                           17420000
         XC    AAPCIPFL,AAPCIPFL  # OF PROTECTED FIELDS                 17430000
         XC    AAPCIBYT,AAPCIBYT  # BYTES COMPARED                      17440000
                                                                        17450000
         LTR   R15,R15            PREPARED OK?                          17460000
         BNZ   PE_IPREP           BRANCH IF NOT                         17470000
                                                                        17480000
         OI    FLAG2,FL2PREP      PREP COMPLETE                         17490000
                                                                        17500000
         LM    R14,R12,SUB1SAVE   RESTORE REGISTERS                     17510000
         BR    R14                RETURN TO CALLER                      17520000
                                                                        17530000
*---------------------------------------------------------------------- 17540000
* SUBROUTINE COMPARE: COMPARE TWO IMAGES TO VALIDATE POSITION IN PLAN   17550000
*                                                                       17560000
* ENTRY:  SESSIMAG                                                      17570000
*         NVARC (NVAS1STN IS THE IMAGE TO VERIFY)                       17580000
*                                                                       17590000
* RETURN: R15 = 0 --> IMAGES COMPARE EQUAL                              17600000
*             =!0 --> IMAGES DO NOT COMPARE EQUAL                       17610000
*                                                                       17620000
*---------------------------------------------------------------------- 17630000
                                                                        17640000
COMPARE  DS    0H                                                       17650000
                                                                        17660000
         STM   R14,R12,SUB0SAVE   SAVE REGISTERS                        17670000
                                                                        17680000
         ICM   RNVSTN,15,NVAS1STN NVSTN FOR STATE 1                     17690000
         BZ    PE_ENVR9           BRANCH IF NO NVSTN                    17700000
                                                                        17710000
*---------------------------------------------------------------------- 17720000
* PREPARE S1 IMAGE FOR COMPARE                                          17730000
*---------------------------------------------------------------------- 17740000
                                                                        17750000
         LR    R1,RNVSTN          PASS NVSTN ADDRESS IN R1              17760000
         BAS   R14,PREP           PREP IMAGE STRUCTS FOR COMPARE/SCRAPE 17770000
                                                                        17780000
*---------------------------------------------------------------------- 17790000
* COMPARE THE IMAGE STRUCTURES                                          17800000
*---------------------------------------------------------------------- 17810000
                                                                        17820000
         @CALL IIMGCMP,                                          960130+17830000
               (*#PCBSTG,*NVSIMGA,*#IMAGE,#CMPINFO),             960130+17840000
               CTYPE=CVT,                                        960130+17850000
               MF=(E,MFE_LIST)                                   960130 17860000
                                                                        17870000
         MVC   AAPCIRC,CIRETCD    RETURN CODE                           17880000
         MVC   AAPCIRSN,CIRSNCD   REASON CODE                           17890000
         MVC   AAPCIPFL,CIPFLGS   # OF PROTECTED FIELDS                 17900000
         MVC   AAPCIBYT,CIBYTES   # BYTES COMPARED                      17910000
                                                                        17920000
*---------------------------------------------------------------------- 17930000
* RETURN TO CALLER                                                      17940000
*---------------------------------------------------------------------- 17950000
                                                                        17960000
         L     R14,SUB0SAVE       RESTORE REGISTERS                     17970000
         LM    R0,R12,SUB0SAVE+8  RESTORE REGISTERS                     17980000
         BR    R14                RETURN TO CALLER                      17990000
                                                                        18000000
*---------------------------------------------------------------------- 18010000
* SUBROUTINE IMGFREE: RELEASE AN IMAGE IF WE HAVE ONE                   18020000
*                                                                       18030000
* ENTRY:  #IMAGE, ##IMAGE                                               18040000
*                                                                       18050000
* RETURN: ALL REGISTERS ARE RESTORED                                    18060000
*                                                                       18070000
*---------------------------------------------------------------------- 18080000
                                                                        18090000
IMGFREE  DS    0H                                                       18100000
                                                                        18110000
         OC    ##IMAGE,##IMAGE    IS THERE AN IMAGE TO RELEASE?         18120000
         BZR   R14                RETURN IMMEDIATELY IF NOT             18130000
                                                                        18140000
         STM   R14,R12,SUB0SAVE   SAVE REGISTERS                        18150000
                                                                        18160000
         @CALL IIMGFREE,                                         960130+18170000
               (*#PCBSTG,*##IMAGE),                              960130+18180000
               CTYPE=CVT,                                        960130+18190000
               MF=(E,MFE_LIST)                                   960130 18200000
                                                                        18210000
         LTR   R15,R15            IMAGE FREED OK?                       18220000
         BNZ   PE_IFREE           BRANCH IF NOT                         18230000
                                                                        18240000
         LM    R14,R12,SUB0SAVE   RESTORE REGISTERS                     18250000
         BR    R14                RETURN TO CALLER                      18260000
                                                                        18270000
*---------------------------------------------------------------------- 18280000
* SUBROUTINE SKSAPPLY: UPDATE SESSIMAG WITH STORED KEYSTROKES AND AID   18290000
*                                                                       18300000
* ENTRY:  SESSIMAG                                                      18310000
*         NVARC                                                         18320000
*                                                                       18330000
* RETURN: ALL REGISTERS ARE RESTORED                                    18340000
*                                                                       18350000
*---------------------------------------------------------------------- 18360000
                                                                        18370000
SKSAPPLY DS    0H                                                       18380000
                                                                        18390000
         STM   R14,R12,SUB0SAVE   SAVE REGISTERS                        18400000
                                                                        18410000
         ICM   RNVSTN,15,NVAS0STN NVSTN FOR STATE 0                     18420000
         BZ    PE_ENVIR           BRANCH IF NO NVSTN                    18430000
                                                                        18440000
*---------------------------------------------------------------------- 18450000
*    ENSURE IMAGE STRUCTURES ARE READY FOR SKSRUN                       18460000
*---------------------------------------------------------------------- 18470000
                                                                        18480000
         TM    FLAG2,FL2PREP      IMAGE PREPED AND TILED?               18490000
         BO    SKSGO              DONE HERE IF SO                       18500000
         LR    R1,RNVSTN          PASS NVSTN IN REGISTER 1              18510000
         BAS   R14,PREP           PREP THE IMAGE                        18520000
                                                                        18530000
*---------------------------------------------------------------------- 18540000
* LOAD THE SKS IF NECESSARY                                             18550000
*---------------------------------------------------------------------- 18560000
                                                                        18570000
SKSGO    DS    0H                                                       18580000
                                                                        18590000
         ICM   R1,15,NVASKSAA     ADDRESS OF SKS-EXE-READY ANCHOR       18600000
         BZ    PE_ENVIR           BRANCH IF NULL                        18610000
         OC    0(4,R1),0(R1)      IS THERE A POINTER THERE?             18620000
         BNZ   SKSLDED            BRANCH IF YES                         18630000
                                                                        18640000
         MVC   #NVSIMGA,NVSIMGA   SAVE THE CURRENT IMAGE                18650000
         CLC   NVSIMGID,NVAIMGID  IMAGE ID MATCH THE REAL ONE ?         18660000
         BE    SKSLOAD            YES, NO NEW IMAGE NEEDED              18670000
         L     R1,NVAIMGID                                              18680000
         BAS   R14,IMGMAKE        BUILD A NEW SET OF STN/IMAGE          18690000
         LTR   R15,R15                                                  18700000
         BNZ   PE_IMGLD           ERROR IN BUILDING IMAGE               18710000
         ST    R1,#NVSIMGA        REPLACE IMAGE WITH THE NEW ONE        18720000
                                                                        18730000
SKSLOAD  DS    0H                                                       18740000
                                                                        18750000
         @CALL ISKSLOAD,                                         960130+18760000
               (*#PROJSTG,*#NVSIMGA,*NVSTVAR,*NVASKSAA,          960130+18770000
               *NVASKSID),                                       960130+18780000
               CTYPE=CVT,                                        960130+18790000
               MF=(E,MFE_LIST)                                   960130 18800000
                                                                        18810000
         LR    R3,R15             SAVE RETRUN CODE                      18820000
         CLC   NVSIMGID,NVAIMGID  IMAGE ID MATCH THE REAL ONE ?         18830000
         BE    SKSRC              YES, DO NOT FREE THE IMAGE            18840000
                                                                        18850000
         $CLINK FUNC=IMGFREE,(LONG,#PCBSTG),                           +18860000
               (STRUCT**,#NVSIMGA)                                      18870000
                                                                        18880000
SKSRC    DS    0H                                                       18890000
                                                                        18900000
         LTR   R3,R3              SKSLOAD OK?                           18910000
         BNZ   PE_SKSLD           BRANCH IF NOT                         18920000
                                                                        18930000
SKSLDED  DS    0H                                                       18940000
                                                                        18950000
*                                                                       18960000
* RUN THE SKS                                                           18970000
*---------------------------------------------------------------------- 18980000
                                                                        18990000
         L     R3,NVASKSAA        ANCHOR ADDRESS                        19000000
         L     R3,0(,R3)          SCRIPT ADDRESS                        19010000
                                                                        19020000
         @CALL ISKSRUN,                                          960130+19030000
               (*#USRSTG,*#IMAGE,*AAPMSGQA,*#VMPOOL,*AAPNAVP,    960130+19040000
               (R3)),                                            960130+19050000
               CTYPE=CVT,                                        960130+19060000
               MF=(E,MFE_LIST)                                   960130 19070000
                                                                        19080000
         LTR   R15,R15            SKSRUN OK?                            19090000
         BNZ   PE_SKSRN           BRANCH IF NOT                         19100000
                                                                        19110000
X        USING NVIMAGE,R2                                               19120000
         L     R2,#IMAGE          TEMPORARY NVIMAGE BLOCK ADDRESS       19130000
         L     R1,X.NVICSRP       CURSOR POSITION AFTER SKSRUN          19140000
         ST    R1,SEISCSR         UPDATE CURSOR POSITION IN SESSIMAG    19150000
         DROP  X                                                        19160000
                                                                        19170000
         LM    R14,R12,SUB0SAVE   RESTORE REGISTERS                     19180000
         BR    R14                RETURN TO CALLER                      19190000
                                                                        19200000
         EJECT                                                          19210000
***************************************************************         19220000
*                                                                       19230000
* ROUTINE: EXCPRGN - Test tiled image for exception regions             19240000
*                                                                       19250000
* ON ENTRY:                                                             19260000
*                                                                       19270000
*    R1 - addr of image handle (NVIMAGE)                                19280000
*                                                                       19290000
* ON EXIT:                                                              19300000
*                                                                       19310000
*    R15 contains one of the following return codes                     19320000
*                                                                       19330000
*        RC00 - no exception regions encountered                        19340000
*        RC04 - exception region materialized on given image            19350000
*                                                                       19360000
***************************************************************         19370000
                                                                        19380000
EXCPRGN  DS    0H                                                       19390000
                                                                        19400000
         STM   R0,R15,SUB0SAVE         SAVE MAINLINE REGS               19410000
         LR    R2,R1                   ACCEPT NVIMAGE                   19420000
         USING NVIMAGE,R2                                               19430000
                                                                        19440000
*--------------------------------------------------------------         19450000
*   IDENTIFY INSTANTIATED REGIONS                                       19460000
*--------------------------------------------------------------         19470000
                                                                        19480000
         L     R3,NVIRGNTR             REGION TREE                      19490000
         USING RGNTREE,R3              REGION TREE BASE FORMAT          19500000
                                                                        19510000
         ICM   R1,15,NVIRECRT          REGION INSTANCE TREE (RECENTRY)  19520000
         BZ    EXCPROK                 NO TILING                        19530000
         LA    R0,RGTROOT              HIGHEST LEVEL RGNTRY             19540000
                                                                        19550000
         @CALL IRGNVERF,CTYPE=CVT      IDENTIFY ALL REGION INSTANCES    19560000
                                                                        19570000
*--------------------------------------------------------------         19580000
*   SCAN FOR MATERIALIZED EXCEPTION REGIONS                             19590000
*--------------------------------------------------------------         19600000
                                                                        19610000
         LA    R1,RGTROOT              REGION TREE                      19620000
         USING RGNTRY,R1               ADDRESSABILITY                   19630000
                                                                        19640000
EXCPRNXT DS    0H                                                       19650000
                                                                        19660000
         TM    RGNFLAG2,RG2CURR        REGION MATERIALIZED?             19670000
         BNO   EXCPRADV                NOT OF INTEREST OTHERWISE        19680000
         ICM   R15,15,RGNSRGN          LOCATE REGION DEFINITION         19690000
         BZ    EXCPRADV                SKIP IF NO ASSOCIATION           19700000
                                                                        19710000
         USING SYSRGN,R15              SYSREGION                        19720000
         CLI   SRAEXCP,FALSE           EXCEPTION REGION?                19730000
         BNE   EXCPRHIT                DONE IF SO                       19740000
         DROP  R15                     SYSRGN                           19750000
                                                                        19760000
EXCPRADV DS    0H                      ADVANCE TO NEXT REGION TREE NODE 19770000
                                                                        19780000
         ICM   R1,15,RGNNEXT           UNORDERED NODE LIST              19790000
         BNZ   EXCPRNXT                SEARCH ALL NODES                 19800000
         DROP  R1,R3                   RGNTRY, RGNTREE                  19810000
                                                                        19820000
*--------------------------------------------------------------         19830000
*   RETURN COMPLETION STATUS TO CALLER                                  19840000
*--------------------------------------------------------------         19850000
                                                                        19860000
EXCPROK  DS    0H                                                       19870000
                                                                        19880000
         LA    R15,RC00                NO EXCEPTION RGNS FOUND          19890000
         B     EXCPRET                 DONE                             19900000
                                                                        19910000
EXCPRHIT DS    0H                                                       19920000
                                                                        19930000
         LA    R15,RC04                EXCEPTION REGION ENCOUNTERED     19940000
                                                                        19950000
EXCPRET  DS    0H                                                       19960000
                                                                        19970000
         LM    R0,R14,SUB0SAVE         RESTORE MAINLINE REGS            19980000
         LTR   R15,R15                 REFLECT COMPLETION STAT VIA CC   19990000
         BR    R14                     RETURN                           20000000
         DROP  R2                      NVIMAGE                          20010000
                                                                        20020000
         EJECT                                                          20030000
***************************************************************         20040000
*                                                                       20050000
* ROUTINE: RECOVRTN - IRUNXEQ ABEND recovery                            20060000
*                                                                       20070000
* DESCRIPTION:                                                          20080000
*                                                                       20090000
*    This process recovery routine establishes a recovery               20100000
*    environment for IRUNXEQ and all services invoked by                20110000
*    IRUNXEQ.  If a recoverable ABEND occurs, registers are             20120000
*    restored to the intial IRUNXEQ entry state and an error            20130000
*    continuation point is selected.                                    20140000
*                                                                       20150000
***************************************************************         20160000
                                                                        20170000
RECOVRTN DS    0H                                                       20180000
                                                                        20190000
         PUSH  USING                                                    20200000
         USING IRUNXEQ,R12                                              20210000
         STM   R2,R12,TSKERCVR+(R2*4)                                   20220000
         ST    R1,TSKERCVR+(R13*4)                                      20230000
         L     R15,=A(PE_ABEND)                                         20240000
         BR    R14                                                      20250000
         POP   USING                                                    20260000
                                                                        20270000
         EJECT                                                          20280000
***************************************************************         20290000
*                                                                       20300000
*   LOCAL READ/ONLY DATA AREAS                                          20310000
*                                                                       20320000
***************************************************************         20330000
                                                                        20340000
MSG_NO_PLAN_ACT  DC  C'No plan active: '                                20350000
MSG_PLAN_ACT     DC  C'Plan executing: '                                20360000
MSG_PLAN_END     DC  C'Plan has ended: '                                20370000
*                                                                       20380000
MSG_UNEXPECT_IN  DC  C'unanticipated input'                             20390000
MSG_AWAIT_DATA   DC  C'waiting for data '                               20400000
MSG_AWAIT_END    DC  C'waiting for session end'                         20410000
MSG_KEYS_SENT    DC  C'text and/or AID key sent'                        20420000
                                                                        20430000
         LTORG ,                                                        20440000
                                                                        20450000
         DROP  R12                                                      20460000
                                                                        20470000
         EJECT ,                                                        20480000
***************************************************************         20490000
*                                                                       20500000
* SUBROUTINE TIMERON: START THE SESSION RECEIVE TIMER                   20510000
*                                                                       20520000
* ENTRY:  SLH, AAP                                                      20530000
*                                                                       20540000
* RETURN: R15 = 0 --> SESSION RECEIVE TIMER IS ACTIVE                   20550000
*             =!0 --> TIMER COULD NOT BE SET                            20560000
*                                                                       20570000
***************************************************************         20580000
                                                                        20590000
TIMERON  DS    0H                                                       20600000
                                                                        20610000
         SR    R15,R15                SHOW TIMER SET                    20620000
         TM    AAPFLAG2,AAPF2TIM      IS A TIMER ACTIVE?                20630000
         BOR   R14                    RETURN IF YES                     20640000
                                                                        20650000
         STM   R14,R12,SUB0SAVE       SAVE REGISTERS                    20660000
         BASR  R12,0                  ADDRESSABILITY                    20670000
         USING *,R12                                                    20680000
                                                                        20690000
         L     R3,ICTATOT1            RECEIVE TOT W/ DIRECTION          20700000
         TM    SEIFSNA,SEIF_CMD       DO WE HAVE THE DIRECTION?         20710000
         BO    *+8                    BRANCH IF YES                     20720000
         L     R3,ICTATOT2            RECEIVE TOT W/O DIRECTION         20730000
         LTR   R3,R3                  GOOD TIMER VALUE?                 20740000
         BP    *+8                    BRANCH IF YES                     20750000
         LA    R3,AAP_RECEIVE_TOT     USE AAP DEFINED TOT INSTEAD       20760000
                                                                        20770000
         $SESSTMR SET,                                                 +20780000
               BINTVL=(R3),                                            +20790000
               TOKEN=SLHSTKN,                                          +20800000
               CLASS=$SESSTMR_CLASS_RECEIVE_DATA,                      +20810000
               ERRET=TONFAIL,                                          +20820000
               MF=(E,MFE_LIST)                                          20830000
                                                                        20840000
         OI    AAPFLAG2,AAPF2TIM      SHOW TIMER INACTIVE               20850000
                                                                        20860000
TONFAIL  DS    0H                                                       20870000
                                                                        20880000
         L     R14,SUB0SAVE           RESTORE REGISTERS                 20890000
         LM    R0,R12,SUB0SAVE+8                                        20900000
         BR    R14                    RETURN TO CALLER                  20910000
                                                                        20920000
         LTORG ,                                                        20930000
                                                                        20940000
***************************************************************         20950000
*                                                                       20960000
* SUBROUTINE TIMEROFF: CANCEL THE SESSION RECEIVE TIMER                 20970000
*                                                                       20980000
* ENTRY:  SLH, AAP                                                      20990000
*                                                                       21000000
* RETURN: ALL REGISTERS ARE RESTORED                                    21010000
*                                                                       21020000
***************************************************************         21030000
                                                                        21040000
TIMEROFF DS    0H                                                       21050000
                                                                        21060000
         TM    AAPFLAG2,AAPF2TIM      IS A TIMER ACTIVE?                21070000
         BNOR  R14                    RETURN IF NOT                     21080000
                                                                        21090000
         STM   R14,R12,SUB0SAVE       SAVE REGISTERS                    21100000
         BASR  R12,0                  ADDRESSABILITY                    21110000
         USING *,R12                                                    21120000
                                                                        21130000
         $SESSTMR CANCEL,                                              +21140000
               TOKEN=SLHSTKN,                                          +21150000
               CLASS=$SESSTMR_CLASS_RECEIVE_DATA,                      +21160000
               MF=(E,MFE_LIST)                                          21170000
                                                                        21180000
         NI    AAPFLAG2,255-AAPF2TIM  SHOW TIMER INACTIVE               21190000
                                                                        21200000
         LM    R14,R12,SUB0SAVE       RESTORE REGISTERS                 21210000
         BR    R14                    RETURN TO CALLER                  21220000
                                                                        21230000
         LTORG ,                                                        21240000
                                                                        21250000
         EJECT                                                          21260000
***************************************************************         21270000
*                                                                       21280000
* ROUTINE: TRCNMSG - CUT TRACE ENTRY AND SEND DIAGNOSTIC MSGS           21290000
*                                                                       21300000
* ENTRY:   AAP, SESSIMAG, SLUHANDL                                      21310000
*                                                                       21320000
* RETURN:  ALL REGISTERS ARE RESTORED                                   21330000
*                                                                       21340000
***************************************************************         21350000
                                                                        21360000
TRCNMSG  DS    0D                                                       21370000
                                                                        21380000
         USING *,R12                ROUTINE ADDRESSABILITY              21390000
         STM   R14,R12,SUB0SAVE     SAVE REGISTERS                      21400000
         LR    R12,R15              BASE REGISTER                       21410000
                                                                        21420000
*--------------------------------------------------------------         21430000
*  Consolidate session image flags                                      21440000
*--------------------------------------------------------------         21450000
         MVC   SIMGFLAG+0(1),SEIS1ATR                                   21460000
         MVC   SIMGFLAG+1(1),SEIFSNA                                    21470000
         MVC   SIMGFLAG+2(1),SEIONCE                                    21480000
         MVC   SIMGFLAG+3(1),SEISTATE                                   21490000
                                                                        21500000
         ICM   R1,15,SEIS1FLV       IS THERE A FIELD VECTOR TABLE?      21510000
         BZ    TRCGO                BRANCH IF NOT                       21520000
         MVC   SIMGFLDS(2),0(R1)    SAVE NUMBER OF FIELDS               21530000
                                                                        21540000
*--------------------------------------------------------------         21550000
*  If Internal Navigation trace class is active, then                   21560000
*  format trace record,                                                 21570000
*--------------------------------------------------------------         21580000
                                                                        21590000
TRCGO    DS    0H                                                       21600000
                                                                        21610000
         XC    TRCREC,TRCREC        CLEAR TRACE RECORD ADDRESS          21620000
                                                                        21630000
         $TRACE *=A(TRC_NAV_RUNXEQ),NTLEN  ALLOCATE TRACE ENTRY         21640000
         BNZ   TRCEND               BRANCH IF TRACING NOT AVAILABLE     21650000
         ST    R15,TRCREC           SAVE ADDRESS OF TRACE RECORD        21660000
         LR    R15,R1               ADDRESS OF TRACE RECORD             21670000
         USING NAVTRC,R15           ADDRESSABILITY                      21680000
                                                                        21690000
         MVC   NTTSKNM,TSKNAME      TASK NAME                           21700000
         MVC   NTAPNAME,AAPANAME    APPLICATION NAME                    21710000
         MVC   NTLOGMOD,AAPLOGMD    LOGMODE NAME                        21720000
                                                                        21730000
         MVC   NTR15,RETR15         R15                                 21740000
         MVC   NTPLNRET,PLANRET     PLANRET                             21750000
         MVC   NTPLNRSN,PLANRSN     PLANRSN                             21760000
         MVC   NTPLNQ1,PLANQ1       PLANQ1                              21770000
         MVC   NTPLNQ2,PLANQ2       PLANQ2                              21780000
         MVC   NTPLNVEC,AAPXPLAN    CURRENT PLAN VECTOR                 21790000
         MVC   NTSARC#,AAPXSRC#     CURRENT SUPRARC VECTOR              21800000
         MVC   NTNVAVEC,AAPXNARC    CURRENT NVARC VECTOR                21810000
                                                                        21820000
         MVC   NTSIFATR,SEIS1ATR    SESSIMAG FLAGS                      21830000
         MVC   NTSIFSNA,SEIFSNA     SESSIMAG FLAGS                      21840000
         MVC   NTSIFONC,SEIONCE     SESSIMAG FLAGS                      21850000
         MVC   NTSIFSTA,SEISTATE    SESSIMAG FLAGS                      21860000
                                                                        21870000
         MVC   NTSL2RET,$SLU2RET    $SLU2_FROM_THE_PLU RETURN VALUES    21880000
         MVC   NTSPLRET,Z.SPLRETCD  RECEIVE RETURN CODE                 21890000
         MVC   NTSPLRSN,Z.SPLRSNCD  RECEIVE REASON CODE                 21900000
         MVC   NTSPLCTL,Z.SPLCNTRL  RECEIVE CNTRL FLAGS                 21910000
         MVC   NTSPLRH,Z.SPLRH      RECEIVE USER REQUEST HEADER         21920000
         MVC   NTSPLSEQ,Z.SPLSEQNO  RECEIVE SEQUENCE NUMBER             21930000
         MVC   NTSPLA,Z.SPLAREA     RECEIVE DATA ADDRESS                21940000
         MVC   NTSPLAL,Z.SPLAREAL   RECEIVE DATA LENGTH                 21950000
         MVC   NTSPLSEN,Z.SPLSENSE  RECEIVE SENSE                       21960000
         MVC   NTSPLSTA,Z.SPLSTATE  RECEIVE SESSION STATE               21970000
                                                                        21980000
         MVC   NTRCDATA,RCDATA      INPUT DATA (IF ANY)                 21990000
         MVC   NTSESTKN,SLHSTKN     SESSION TOKEN                       22000000
                                                                        22010000
         MVC   NTAID,SEIAID         CURRENT 3270 AID BYTE               22020000
         MVC   NTIMGFLD,SIMGFLDS    CURRENT FIELD COUNT                 22030000
         MVC   NTS1ROW,SEIS1ROW     CURRENT ROW COUNT                   22040000
         MVC   NTS1COL,SEIS1COL     CURRENT COL COUNT                   22050000
         MVC   NTCSR,SEISCSR+2      CURRENT CSR POSITION                22060000
                                                                        22070000
         MVC   NTCMPRC,AAPCIRC      CMPINFO RETURN CODE                 22080000
         MVC   NTCMPRSN,AAPCIRSN    CMPINFO REASON CODE                 22090000
         MVC   NTCMPPFL,AAPCIPFL    CMPINFO NUMBER OF PROT FIELDS       22100000
         MVC   NTCMPBYT,AAPCIBYT    CMPINFO NUMBER OF BYTES COMPARED    22110000
                                                                        22120000
*--------------------------------------------------------------         22130000
                                                                        22140000
         MVC   NTSRCST,BLANKS     INITIALIZE STATE FIELDS               22150000
         MVC   NTDESTST,BLANKS    INITIALIZE STATE FIELDS               22160000
                                                                        22170000
         ICM   R0,15,#PROJ        IS IPROJ AVAILABLE?            960124 22180000
         BZ    TRCNAVAL           SKIP IF NOT                    960124 22190000
                                                                        22200000
         LTR   R0,RSUPRARC        CURRENT SUPRARC ?              960130 22210000
         BZ    TRCNAVAL           NO STATE INFO TO TRACE                22220000
         O     R0,=X'80000000'    INDICATE FORMAT FROM STATE            22230000
         LR    R1,RNVARC          NVARC ADDRESS                         22240000
         LA    R2,NTSRCST         TARGET FORMAT AREA                    22250000
         BAS   R14,FMTSTATE       FORMAT STATE NAME                     22260000
                                                                        22270000
         LR    R0,RSUPRARC        SUPRARC ADDRESS                       22280000
         LA    R2,NTDESTST        DESTINATION STATE                     22290000
         BAS   R14,FMTSTATE       FORMAT STATE NAME                     22300000
                                                                        22310000
         ICM   R0,15,SUPPEER      CONDITIONAL TRANSITION                22320000
         BZ    TRCEND             NO CONTINUE                           22330000
         MVC   NTDESTST,$COND     DEFAULT CONDITIONAL TRACE DEST        22340000
         B     TRCEND                                                   22350000
                                                                        22360000
TRCNAVAL DS    0H                                                       22370000
                                                                        22380000
         MVC   NTSRCST,$NAVAIL    SOURCE STATE NOT AVAILABLE            22390000
         MVC   NTDESTST,$NAVAIL   DEST   STATE NOT AVAILABLE            22400000
                                                                        22410000
         DROP  R15                NAVTRC, SUPRARC                       22420000
                                                                        22430000
TRCEND   DS    0H                                                       22440000
                                                                        22450000
*--------------------------------------------------------------         22460000
*   DETERMINE IF MSG CL(NAVIGATION) IS ACTIVE                           22470000
*--------------------------------------------------------------         22480000
                                                                        22490000
         $MSGATTR 'NAVIGATION'    TEST NAVIGATION MSG TRACE             22500000
         BZ    TRCMSG             ALWAYS LOGGING IF ACTIVE              22510000
                                                                        22520000
         CLC   RETR15,=F'-2'      IS THIS A PLAN END?                   22530000
         BNE   TRCEXIT            NO TRACE MESSAGES IF NOT              22540000
                                                                        22550000
         ICM   R15,15,PLANRET     IS THIS A NORMAL PLANEND?             22560000
         BZ    TRCEXIT            BRANCH IF YES                         22570000
                                                                        22580000
*--------------------------------------------------------------         22590000
*   TRACE THIS EVENT VIA CL(NAVIGATION) MSG LOG                         22600000
*--------------------------------------------------------------         22610000
                                                                        22620000
TRCMSG   DS    0H                                                       22630000
                                                                        22640000
         CLC   PLNRETXP(L'AWAIT_DATA),AWAIT_DATA                        22650000
         BNE   MSGSTART                                                 22660000
         CLC   INPSTAT,=CL8'no data' TEST FOR NO INPUT DATA             22670000
         BE    TRCEXIT                                                  22680000
                                                                        22690000
MSGSTART DS    0H                                                       22700000
                                                                        22710000
         MVI   IMAGLINE,C' '      NULL MESSAGE TOKEN                    22720000
         LA    R2,1               TOKEN LENGTH                          22730000
         ICM   R1,15,IMSGSEGL     IMAGE FUNCTION MSG QUALIFIER AVAIL?   22740000
         BZ    TRC099             READY FOR MSG IF NOT                  22750000
                                                                        22760000
         MVC   IMAGLINE+0(3),=CL3' - '                                  22770000
         L     R15,IMSGSEG        IMAGE FUNCTION MESSAGE QUALIFIER      22780000
         BCTR  R1,0               PREPARE FOR COPY                      22790000
         EX    R1,*+4             CONVERT TEXT TO SUFFIX FORMAT         22800000
         MVC   IMAGLINE+3(*-*),0(R15)                                   22810000
         LA    R2,3+1(,R1)        LENGTH OF SUFFIX                      22820000
                                                                        22830000
*--------------------------------------------------------------         22840000
                                                                        22850000
TRC099   DS    0H                                                       22860000
                                                                        22870000
         $MSG  099,                  "IRUNXEQ EXIT ..."                +22880000
               FIELDS=((SLHSTKN,4),  SESSION TOKEN PART 1              +22890000
               (SLHSTKN+4,4),        SESSION TOKEN PART 2              +22900000
               (TSKNAME,8),          TASK NAME                         +22910000
               (AAPANAME,16),        APPL NAME                         +22920000
               (AAPLOGMD,8),         LOGMODE                           +22930000
               (RETR15,4),           R15                               +22940000
               PLANSTAT,             EXPLANATION OF PLAN STATE         +22950000
               PLNRETXP,             EXPLANATION OF PLANRET CODE       +22960000
               (IMAGLINE,(R2)))      IMAGE FUNC FAILURE QUALIFIER       22970000
                                                                        22980000
*--------------------------------------------------------------         22990000
*  Trace source (from) state                                            23000000
*--------------------------------------------------------------         23010000
                                                                        23020000
         ST    RSUPRARC,SAVSUPR                                  960130 23030000
         MVI   TSTATE,C' '        CLEAR TRACE FORMAT STATE AREA         23040000
         MVC   TSTATE+1(TSTATEL-1),TSTATE                               23050000
         MVC   DLABEL(L'$DLBL),$DLBL                                    23060000
                                                                        23070000
         ICM   R0,15,#PROJ        IS IPROJ AVAILABLE?            960124 23080000
         BZ    TRCNOSTA           SKIP IF NOT                    960124 23090000
                                                                        23100000
         LTR   R0,RSUPRARC        CURRENT SUPRARC AVAILBLE ?     960130 23110000
         BZ    TRCNOSTA           NO STATE INFO TO TRACE                23120000
         O     R0,=X'80000000'    INDICATE FORMAT FROM STATE            23130000
         LR    R1,RNVARC          NVARC ADDRESS                         23140000
         TM    FLAGS,FLSCVERT     VERTICAL SCROLL REQUIRED              23150000
         BNO   TRCNOSCR                                                 23160000
         TM    AAPFLAG3,AAPF3SS0  SCROLLING/SCRAPING S0 ?        960130 23170000
         BO    TRCNOSCR           BRANCH IF YES                  960130 23180000
         O     R1,=X'80000000'    USE STN1 IN NVARC                     23190000
                                                                        23200000
TRCNOSCR DS    0H                                                       23210000
                                                                        23220000
         LA    R2,FSTATE          TARGET FORMAT AREA                    23230000
         BAS   R14,FMTSTATE       FORMAT STATE NAME                     23240000
                                                                        23250000
         $MSG  106,               ISSUE SOURCE STATE MESSAGE           +23260000
               FIELDS=(FSTATE)                                          23270000
                                                                        23280000
         TM    FLAGS,FLSCVERT     VERTICAL SCROLL REQUIRED              23290000
         BNO   TRCDEST                                                  23300000
         MVC   DSTATE1,FSTATE     SCROLLING FSTATE = DSTTATE            23310000
         SR    RSUPRARC,RSUPRARC  NO SUPRARC NEEDED                     23320000
         B     TRCDMSG            ISSUE MESSAGE                         23330000
                                                                        23340000
*--------------------------------------------------------------         23350000
*  Trace Destination (to) states.                                       23360000
*--------------------------------------------------------------         23370000
                                                                        23380000
TRCDEST  DS    0H                                                       23390000
                                                                        23400000
         LR    R1,RNVARC          ADDRESS OF CURRENT NVARC              23410000
                                                                        23420000
TRCDFMT1 DS    0H                                                       23430000
                                                                        23440000
         LA    R2,DSTATE          ADDR OF DEST STATE FORMAT AREA        23450000
         LA    R3,DSTATE#         COUNT OF ENTRIES PER LINE             23460000
                                                                        23470000
TRCDFMT2 DS    0H                                                       23480000
                                                                        23490000
         LTR   R0,RSUPRARC        FORMAT SUPRARC                        23500000
         BZ    TRCDMSG            NO SUPRARC, ISSUE MESSAGE             23510000
         BAS   R14,FMTSTATE       FORMAT CURRENT STATE                  23520000
                                                                        23530000
         SR    R1,R1              NO MORE NEED FOR NVARC                23540000
         ICM   RSUPRARC,15,SUPPEER PEER SUPRARC AVAILABLE?              23550000
         BZ    TRCDMSG            NO, FORMAT MESSAGE                    23560000
         LA    R2,L'DSTATE(,R2)   INCREMENT DEST TRACE FMT AREA         23570000
         BCT   R3,TRCDFMT2        FORMAT NEXT DESTINATION STATE         23580000
                                                                        23590000
TRCDMSG  DS    0H                                                       23600000
                                                                        23610000
         $MSG  107,                                                    +23620000
               FIELDS=(DLABEL,DSTATE1,DSTATE2,DSTATE3,                 +23630000
               DSTATE4,DSTATE5,DSTATE6)                                 23640000
                                                                        23650000
         MVI   TSTATE,C' '        CLEAR TRACE FORMAT STATE AREA         23660000
         MVC   TSTATE+1(TSTATEL-1),TSTATE                               23670000
         LTR   RSUPRARC,RSUPRARC  ANY MORE PEER SUPRARCS?               23680000
         BNZ   TRCDFMT1           YES, CONTINUE WITH NEXT LINE          23690000
                                                                        23700000
TRCNOSTA DS    0H                                                       23710000
                                                                        23720000
         L     RSUPRARC,SAVSUPR                                  960130 23730000
                                                                        23740000
*--------------------------------------------------------------         23750000
* Format Navigation trace messages                                      23760000
*--------------------------------------------------------------         23770000
                                                                        23780000
         $MSG  100,                  "DIAGNOSTIC DATA FOLLOWS"         +23790000
               FIELDS=((PLANRET,4),  PLANRET                           +23800000
               (PLANRSN,4),          PLANRSN                           +23810000
               (PLANQ1,4),           PLANQ1                            +23820000
               (PLANQ2,4))           PLANQ2                             23830000
                                                                        23840000
         $MSG  101,                  " .... PART 2 ..."                +23850000
               FIELDS=((AAPXPLAN,4), CURRENT PLAN VECTOR               +23860000
               (AAPXSRC#,4),         CURRENT SUPRARC VECTOR            +23870000
               (AAPXNARC,4),         CURRENT NVARC VECTOR              +23880000
               (SIMGFLAG,4),         SESSIMAG FLAGS                    +23890000
               (SEIAID,1),           CURRENT 3270 AID                  +23900000
               (SEIS1ROW,4),         CURRENT ROWS AND COLUMNS          +23910000
               (SEISCSR+2,2),        CURRENT CURSOR POSITION           +23920000
               (SIMGFLDS,2),         CURRENT FIELD COUNT               +23930000
               ($SLU2R15,4),         $SLU2_FROM_THE_PLU R15            +23940000
               ($SLU2R0,4),                             R0             +23950000
               ($SLU2R1,4),                             R1             +23960000
               (Z.SPLSTATE,4))       RECEIVE SPLSTATE                   23970000
                                                                        23980000
         $MSG  102,                  " .... PART 3 ..."                +23990000
               FIELDS=((Z.SPLRETCD,4),       SPLRETCD                  +24000000
               (Z.SPLRSNCD,4),               SPLRSNCD                  +24010000
               (Z.SPLCNTRL,3),               SPLCNTRL                  +24020000
               (Z.SPLRH,3),                  SPLRH                     +24030000
               (Z.SPLAREA,4),                SPLAREA                   +24040000
               (Z.SPLAREAL,4),               SPLAREAL                  +24050000
               (Z.SPLSENSE,4),               SPLSENSE                  +24060000
               (Z.SPLSEQNO,2),               SPLSEQNO                  +24070000
               AAPCIRC,                      CMPINFO RETURN CODE       +24080000
               AAPCIRSN,                     CMPINFO REASON CODE       +24090000
               AAPCIPFL,                     CMPINFO # OF PROT FIELDS  +24100000
               AAPCIBYT)                     CMPINFO # BYTES COMPARED   24110000
                                                                        24120000
         $MSG  103,                  " INPUT/NO INPUT"                 +24130000
               FIELDS=((INPSTAT,8),  STATUS TEXT                       +24140000
               (RCDATA+0,4),                                           +24150000
               (RCDATA+4,4),                                           +24160000
               (RCDATA+8,4),                                           +24170000
               (RCDATA+12,4),                                          +24180000
               (RCDATA+16,4),                                          +24190000
               (RCDATA+20,4),                                          +24200000
               (RCDATA+24,4),                                          +24210000
               (RCDATA+28,4))                                           24220000
                                                                        24230000
***************************************************************         24240000
*                                                                       24250000
*   PRESENT SCREEN IMAGE                                                24260000
*                                                                       24270000
***************************************************************         24280000
                                                                        24290000
         $MSG  114                SCREEN DUMP HEADER                    24300000
                                                                        24310000
         XC    @IMGAUX,@IMGAUX    NO AUX BUFFER ALLOCATED               24320000
                                                                        24330000
         ICM   R3,15,SEIS1IMG     CURRENT IMAGE ADDRESS                 24340000
         BNP   IMGNONE            BRANCH IF NONE                        24350000
         SR    R5,R5              CLEAR                                 24360000
         ICM   R5,3,SEIS1ROW      ROW COUNT                             24370000
         BNP   IMGNONE            SKIP IF NOT GOOD COUNT                24380000
                                                                        24390000
         SR    R4,R4              CLEAR                                 24400000
         ICM   R4,3,SEIS1COL      COL COUNT                             24410000
         BNP   IMGNONE            SKIP IF NOT GOOD COUNT                24420000
                                                                        24430000
         $GETSTOR *SEIS1SIZ       ACQUIRE WORKING STORAGE FOR IMAGE     24440000
                                                                        24450000
         ST    R1,@IMGAUX         RETAIN AUX IMAGE BUFFER ADDR          24460000
         LR    R14,R1             MAKE MODIFIABLE WORKING COPY OF IMG   24470000
         L     R15,SEIS1SIZ                                             24480000
         L     R0,SEIS1IMG                                              24490000
         LR    R1,R15                                                   24500000
         MVCL  R14,R0                                                   24510000
                                                                        24520000
         L     R3,@IMGAUX         WORKING COPY OF SCREEN IMAGE          24530000
         LR    R1,R3              R1 <== IMAGE ORIGIN                   24540000
         L     R0,SEIS1SIZ        R0 <== IMAGE SIZE                     24550000
                                                                        24560000
         @CALL IIMGDARK,CTYPE=CVT                                       24570000
                                                                        24580000
*--------------------------------------------------------------         24590000
*   FORMAT ALL NON-TRIVIAL LINES OF CURRENT IMAGE                       24600000
*--------------------------------------------------------------         24610000
         LA    R5,1               LINE NUMBER 1                         24620000
         L     R6,=A(NULLBLNK)    TRT TABLE ADDRESS                     24630000
                                                                        24640000
IMGLINE  DS    0H                                                       24650000
                                                                        24660000
         TRTL  ARG=(R3),                                               +24670000
               LENGTH=(R4),                                            +24680000
               TRTABLE=(R6)       CHECK FOR A NON-NULL/BLANK            24690000
                                                                        24700000
         BZ    IMGSKIP            BRANCH IF ALL BLANK/NULL              24710000
         LR    R2,R4              LINE LENGTH                           24720000
         CH    R2,=H'256'         MORE THAN AN MVC/TR ?                 24730000
         BNH   IMGLNEOK           BRANCH IF NOT                         24740000
         LA    R2,256             TRIM TO FIT INSTRUCTION ARCH.         24750000
                                                                        24760000
IMGLNEOK DS    0H                                                       24770000
                                                                        24780000
         BCTR  R2,0               LENGTH CODE FOR EXECUTE               24790000
         EX    R2,IMGMOVE         MOVE LINE TO WORKING STORAGE          24800000
         L     R1,=A(NULLATTR)    TRANSLATE TABLE FOR IMAGE MESSAGING   24810000
         EX    R2,IMGTRANS        TRANSLATE THE LINE                    24820000
         LA    R2,1(,R2)          LENGTH OF LINE                        24830000
         OI    FLAGS,FLIMGLN      INDICATE IMAGE LINE WRITTEN           24840000
                                                                        24850000
         $MSG  104,               " ###: .... IMAGE LINE ..."          +24860000
               FIELDS=((R5),      LINE NUMBER                          +24870000
               (IMAGLINE,(R2)))   ONE IMAGE LINE                        24880000
                                                                        24890000
IMGSKIP  DS    0H                                                       24900000
                                                                        24910000
         AR    R3,R4              ADDRESS NEXT IMAGE ROW                24920000
         LA    R5,1(,R5)          BUMP ROW NUMBER                       24930000
         CH    R5,SEIS1ROW        ALL ROWS DONE?                        24940000
         BNH   IMGLINE            BRANCH IF NOT                         24950000
                                                                        24960000
         TM    FLAGS,FLIMGLN      WAS AN IMAGE LINE WRITTEN?            24970000
         BO    IMGEND             BRANCH IF YES                         24980000
                                                                        24990000
IMGNONE  DS    0H                                                       25000000
                                                                        25010000
         $MSG  105                "IMAGE IS NULL.."                     25020000
                                                                        25030000
IMGEND   DS    0H                                                       25040000
                                                                        25050000
         $MSG  124                SCREEN DUMP TRAILER                   25060000
                                                                        25070000
*--------------------------------------------------------------         25080000
*   EXIT DIAGNOSTIC MESSAGING AND TRACE ROUTINE                         25090000
*--------------------------------------------------------------         25100000
                                                                        25110000
TRCEXIT  DS    0H                                                       25120000
                                                                        25130000
         ICM   R2,15,@IMGAUX      AUX IMAGE ALLOCATED?                  25140000
         BZ    TRCX                                                     25150000
         XC    @IMGAUX,@IMGAUX                                          25160000
                                                                        25170000
         $RETSTOR (R2)                                                  25180000
                                                                        25190000
TRCX     DS    0H                                                       25200000
                                                                        25210000
         LM    R14,R12,SUB0SAVE   RESTORE REGISTERS                     25220000
         BR    R14                RETURN TO CALLER                      25230000
                                                                        25240000
         EJECT ,                                                        25250000
***************************************************************         25260000
*                                                                       25270000
* ROUTINE: FMTSTATE - Format state name for trace                       25280000
*                                                                       25290000
* DESCRIPTION:                                                          25300000
*                                                                       25310000
*   This routine will format the current (source) state name            25320000
*   or destination state name identified by the SUPRARC/                25330000
*   NVARC.  If the state requested for formatting, exists in            25340000
*   a screen set, the state name is formatted with a leading            25350000
*   '+' to indicate the state is a screen set.                          25360000
*                                                                       25370000
* ENTRY:   R0  - Address of SUPRARC                                     25380000
*                (High order bit on requests that source                25390000
*                state is to be formated)                               25400000
*          R1  - Address of NVARC  (if zero use SUPRARC)                25410000
*          R2  - Address of format area                                 25420000
*                                                                       25430000
* EXIT:    N/A                                                          25440000
*                                                                       25450000
***************************************************************         25460000
                                                                        25470000
FMTSTATE DS    0H                                                       25480000
                                                                        25490000
         STM   R0,R15,SUB1SAVE    SAVE CALLER'S REGISTERS               25500000
                                                                        25510000
*--------------------------------------------------------------         25520000
*  Obtain Destination (TO) state STN from SUPRARC/NVARC                 25530000
*--------------------------------------------------------------         25540000
                                                                        25550000
         LTR   RSUPRARC,R0        SUPRARC ADDRESS                960130 25560000
         BM    FMTSRC             NEG, FORMAT SOURCE STATE              25570000
         BZ    FMT_NA             STN NOT AVAILABLE                     25580000
                                                                        25590000
         L     RNVSTN,SUPS1STN    ASSUME SUPRARC S1 STN ADDRESS  960130 25600000
         LR    RNVARC,R1          IS NVARC AVAILABLE ?           960130 25610000
         N     RNVARC,=X'7FFFFFFF'                               960130 25620000
         BZ    FMTSTN                                            222560 25630000
         L     RNVSTN,NVAS1STN    ELSE, USE NVARC S1 STN ADDRESS 960130 25640000
         B     FMTSTN             FORMAT THIS STN                       25650000
                                                                        25660000
*--------------------------------------------------------------         25670000
*  Obtain Source (FROM) state STN from SUPRARC/NVARC                    25680000
*--------------------------------------------------------------         25690000
                                                                        25700000
FMTSRC   DS    0H                                                       25710000
                                                                        25720000
         L     RNVSTN,SUPS0STN    ASSUME SUPRARC S0 STN ADDRESS  960130 25730000
         LR    RNVARC,R1          IS NVARC AVAILABLE             960130 25740000
         N     RNVARC,=X'7FFFFFFF'                               960130 25750000
         BZ    FMTSTN             NO, CONTINUE                   222560 25760000
         L     RNVSTN,NVAS0STN    ASSUME NVARC S0 STN ADDRESS    960130 25770000
         LTR   RNVARC,R1                                         960130 25780000
         BNM   FMTSTN                                                   25790000
         L     RNVSTN,NVAS1STN    SCROLLING, USE NVARC S1 STN AD 960130 25800000
                                                                        25810000
*--------------------------------------------------------------         25820000
*  Format state name.                                                   25830000
*--------------------------------------------------------------         25840000
                                                                        25850000
FMTSTN   DS    0H                                                       25860000
                                                                        25870000
         MVC   0(L'NVSTNAME,R2),NVSTNAME ASSUME NOT IN SSET             25880000
         TM    NVSTSSN,BF         SCREEN SET NAME PRESENT               25890000
         BZ    FMTTRIM            NO, CONTINUE                          25900000
                                                                        25910000
         MVI   0(R2),C'+'         INDICATE SCREEN SET                   25920000
         MVC   1(L'NVSTSSN,R2),NVSTSSN  USE SCREEN SET NAME             25930000
                                                                        25940000
FMTTRIM  DS    0H                                                       25950000
                                                                        25960000
         @TRIM 0(R2),L'TSTATE,CHAR=C' '                                 25970000
         LA    R2,0(R1,R2)        END OF STRING ADDRESS                 25980000
                                                                        25990000
         LTR   RSUPRARC,RSUPRARC  SOURCE STN DOES NOT CONTINUE   960130 26000000
         BM    FMT_RET            RETURN                                26010000
         ICM   R0,15,SUPPEER      ARE THERE PEER SUPRARCS?              26020000
         BZ    FMT_RET            NO, ALL DONE                          26030000
                                                                        26040000
         MVI   0(R2),C','         LIST OF STATES CONTINUES              26050000
         B     FMT_RET            RETURN                                26060000
                                                                        26070000
FMT_NA   DS    0H                                                       26080000
                                                                        26090000
         MVC   0(L'TSTATE,R2),=CL(L'TSTATE)'Not Available'              26100000
                                                                        26110000
FMT_RET  DS    0H                                                       26120000
                                                                        26130000
         LM    R0,R15,SUB1SAVE    RESTORE CALLERS REGISTERS             26140000
         BR    R14                RETURN                                26150000
                                                                        26160000
         EJECT ,                                                        26170000
*--------------------------------------------------------------         26180000
*   TARGETS OF DYNAMIC 'EX'                                             26190000
*--------------------------------------------------------------         26200000
                                                                        26210000
IMGMOVE  MVC   IMAGLINE(*-*),0(R3) COPY AN IMAGE LINE (MAX. 256 BYTES)  26220000
IMGTRANS TR    IMAGLINE(*-*),0(R1) TRANSLATE NULLS AND ATTRIBUTES       26230000
                                                                        26240000
AWAIT_DATA   DC  C'waiting for data '                                   26250000
                                                                        26260000
*--------------------------------------------------------------         26270000
*   Plan completion status message segments                             26280000
*--------------------------------------------------------------         26290000
                                                                        26300000
PRETEXPL DS    0F                 LENGTH LIMITTED TO L'PLNRETXP         26310000
                                                                        26320000
         DC    A(EXP0,L'EXP0)                                           26330000
         DC    A(EXP1,L'EXP1)                                           26340000
         DC    A(EXP2,L'EXP2)                                           26350000
         DC    A(EXP3,L'EXP3)                                           26360000
         DC    A(EXP4,L'EXP4)                                           26370000
         DC    A(EXP5,L'EXP5)                                           26380000
         DC    A(EXP6,L'EXP6)                                           26390000
         DC    A(EXP7,L'EXP7)                                           26400000
         DC    A(EXP8,L'EXP8)                                           26410000
         DC    A(EXP9,L'EXP9)                                           26420000
         DC    A(EXP10,L'EXP10)                                         26430000
         DC    A(EXP11,L'EXP11)                                         26440000
         DC    A(EXP12,L'EXP12)                                         26450000
         DC    A(EXP13,L'EXP13)                                         26460000
         DC    A(EXP14,L'EXP14)                                         26470000
         DC    A(EXP15,L'EXP15)                                         26480000
         DC    A(EXP16,L'EXP16)                                         26490000
         DC    A(EXP17,L'EXP17)                                         26500000
         DC    A(EXP18,L'EXP18)                                         26510000
         DC    A(EXP19,L'EXP19)                                         26520000
         DC    A(EXPXX,L'EXPXX)                                         26530000
                                                                        26540000
EXP_EXCP DC    A(EXPMEXCP,L'EXPMEXCP)                                   26550000
EXP_TSEL DC    A(EXPMTSEL,L'EXPMTSEL)                                   26560000
                                                                        26570000
EXP0     DC    C'successful end'                                        26580000
EXP1     DC    C'LOST; position unknown'                                26590000
EXP2     DC    C'unexpected input received'                             26600000
EXP3     DC    C'session ended'                                         26610000
EXP4     DC    C'application update error'                              26620000
EXP5     DC    C'environmental error'                                   26630000
EXP6     DC    C'image compare error'                                   26640000
EXP7     DC    C'application send error'                                26650000
EXP8     DC    C'image analysis error'   (scrape failure)               26660000
EXP9     DC    C'image load error'                                      26670000
EXP10    DC    C'image build error'                                     26680000
EXP11    DC    C'image free error'                                      26690000
EXP12    DC    C'image prepare error'                                   26700000
EXP13    DC    C'SKS load error'                                        26710000
EXP14    DC    C'SKS run error'                                         26720000
EXP15    DC    C'session timer error'                                   26730000
EXP16    DC    C'ABEND encountered and logged'                          26740000
EXP17    DC    C'no response from application'                          26750000
EXP18    DC    c'resource manager cleanup'                              26760000
EXP19    DC    c'navigation decision error'                             26770000
EXPXX    DC    c'completion status unknown'                             26780000
                                                                        26790000
EXPMEXCP DC    C'defined exception state reached'                       26800000
EXPMTSEL DC    C'table select criteria mismatch'                        26810000
                                                                        26820000
*--------------------------------------------------------------         26830000
                                                                        26840000
$DLBL    DC    CL12'To State:'      DESTINATION STATE LABEL             26850000
$COND    DC    CL18'*CONDITIONAL*'  CONDITIONAL STATE                   26860000
$NAVAIL  DC    CL18'*N/AVAILABLE*'  NOT AVAILABLE LABEL                 26870000
BLANKS   DC    CL24' '              HANDY BLANKS                        26880000
                                                                        26890000
         LTORG ,                                                        26900000
                                                                        26910000
*--------------------------------------------------------------         26920000
* TRANSLATE TABLE TO IDENTIFY NULL/BLANK IMAGE LINES                    26930000
*--------------------------------------------------------------         26940000
                                                                        26950000
NULLBLNK DC    256X'FF'                                                 26960000
         ORG   NULLBLNK+X'00'                                           26970000
         DC    X'00'                                                    26980000
         ORG   NULLBLNK+X'40'                                           26990000
         DC    X'00'                                                    27000000
         ORG   ,                                                        27010000
                                                                        27020000
*---------------------------------------------------------------------- 27030000
* TRANSLATE TABLE FOR SENDING IMAGE LINES TO $MSG SERVICE               27040000
*---------------------------------------------------------------------- 27050000
                                                                        27060000
NULLATTR DC    X'400102030405060708090A0B0C0D0E0F'                      27070000
         DC    X'101112131415161718191A1B1C1D1E1F'                      27080000
         DC    X'7C7C7C7C7C7C7C7C7C7C7C7C7C7C7C7C'                      27090000
         DC    X'7C7C7C7C7C7C7C7C7C7C7C7C7C7C7C7C'                      27100000
         DC    X'404142434445464748494A4B4C4D4E4F'                      27110000
         DC    X'505152535455565758595A5B5C5D5E5F'                      27120000
         DC    X'606162636465666768696A6B6C6D6E6F'                      27130000
         DC    X'707172737475767778797A7B7C7D7E7F'                      27140000
         DC    X'808182838485868788898A8B8C8D8E8F'                      27150000
         DC    X'909192939495969798999A9B9C9D9E9F'                      27160000
         DC    X'A0A1A2A3A4A5A6A7A8A9AAABACADAEAF'                      27170000
         DC    X'B0B1B2B3B4B5B6B7B8B9BABBBCBDBEBF'                      27180000
         DC    X'C0C1C2C3C4C5C6C7C8C9CACBCCCDCECF'                      27190000
         DC    X'D0D1D2D3D4D5D6D7D8D9DADBDCDDDEDF'                      27200000
         DC    X'E0E1E2E3E4E5E6E7E8E9EAEBECEDEEEF'                      27210000
         DC    X'F0F1F2F3F4F5F6F7F8F9FAFBFCFDFEFF'                      27220000
                                                                        27230000
         PRINT NOGEN                                                    27240000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                27250000
         IKJTCB ,                 MVS TASK CONTROL BLOCK                27260000
         ISTDBIND ,               VTAM BIND IMAGE                       27270000
         ISTRH ,                  VTAM SNA REQUEST HEADER               27280000
                                                                        27290000
         TRACODES ,               TRACE CODE EQUATES                    27300000
         MSGCODES ,               INTERTASK MSG CODE EQUATES            27310000
         ABCODES ,                $ABEND CODES                          27320000
                                                                        27330000
         ICVT  ,                  ICVT                                  27340000
         IVTAMCVT ,               VTAM CVT                              27350000
         ITASK ,                  TASK BLOCK                            27360000
         IPCB ,                   PROCESS BLOCK                         27370000
         IUSER ,                  IUSER BLOCK                           27380000
         IPROJ ,                  IPROJ BLOCK                           27390000
         SLUHANDL ,               SLU HANDLE STRUCTURE                  27400000
         $NAVPARM ,               VDB DEFINITION                        27410000
         REGION ,                 AUX REGION INFO                       27420000
         ICATALOG REGIONS         SYSREGION DEFINITION                  27430000
         ISESS ,                  SESSION BLOCK & EQUATES               27440000
         END   ,                                                        27450000

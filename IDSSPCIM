IDSSPCIM TITLE 'DATASPACE SERVICES - SPACE IMPORT'                      00010000
***************************************************************         00020000
*                                                                       00030000
*   READ / WRITE WORKING STORAGE AREA                                   00040000
*                                                                       00050000
***************************************************************         00060000
WORKAREA DSECT                                                          00070000
                                                                        00080002
         @WORK ,                  STANDARD WORKAREA                     00090002
                                                                        00100002
SERCNTL  DS    F                  SPC_SERCNTL IMAGE FROM TARGET SPACE   00110000
REGSAVEX DS    16F                SUBROUTINE REG SAVEAREA               00120000
                                                                        00130000
WORKLEN  EQU   *-WORKAREA         WORKAREA LENGTH                       00140000
                                                                        00150002
         EJECT ,                                                        00160000
         PORTPRMS ,                                                     00170000
                                                                        00180002
         EJECT ,                                                        00190000
         SPCBLOCK ,                                                     00200000
                                                                        00210002
         EJECT ,                                                        00220000
         OIE ,                                                          00230000
                                                                        00240002
         EJECT ,                                                        00250000
         $TOKEN ,                                                       00260000
                                                                        00270002
         EJECT ,                                                        00280000
         SPCEQUS ,                                                      00290000
                                                                        00300002
         EJECT ,                                                        00310000
         EQUS  LINKAGE=VCON                                             00320000
                                                                        00330000
         EJECT ,                                                        00340000
**<DOC-ON>*****************************************************         00350002
*                                                                       00360000
* ROUTINE: IDSSPCIM - SPACE IMPORT                                      00370000
*                                                                       00380000
* DESCRIPTION:                                                          00390000
*                                                                       00400000
*    THIS ROUTINE IMPLEMENTS THE $SPACE IMPORT FUNCTION. THE            00410000
*    START SUBFUNCTION IS USED TO INITIATE A $SPACE IMPORT,             00420000
*    MAINLY TO MAINTAIN SYMMETRY WITH THE EXPORT FUNCTION.              00430000
*    EACH ALU MOVE CALL PRESENTS A SINGLE ALU NUMBER AND AN             00440000
*    ASSOCIATED ALU BUFFER. THE ALU IS MOVED FROM THE                   00450000
*    REQUESTERS BUFFER DIRECTLY INTO THE SPACE. UPON RECEIPT OF         00460000
*    THE END SUBFUNCTION, ALL OBJECTS OIES ARE RESET, REMOVING          00470000
*    THEIR READ AND WRITE ACCESS FLAGS.                                 00480000
*                                                                       00490000
*                                                                       00500000
* NOTES 07/01/93:                                                       00510000
*                                                                       00520000
*    CHANGE INTRODUCED TO PRESERVE SOME DATA ITEMS IN THE               00530000
*    TARGET SPACE DEFINITION WHEN ALU0 IS IMPORTED FROM THE             00540000
*    SOURCE SPACE.  THE FOLLOWING FIELDS ARE NOT AFFECTED BY            00550000
*    IMPORT:                                                            00560000
*                                                                       00570000
*       SPC_SERCNTL  - EXTERNAL SERIALIZATION CONTROL WORD              00580000
*                                                                       00590000
*    IN THE FUTURE, IT WOULD BE DESIRABLE TO ALLOW THE OIE POOL         00600000
*    OF THE SOURCE SPACE TO BE EXPENDED OVER AN IMPORT AS WELL.         00610000
*    THIS WOULD ALLOW SHARED (SERIALIZED) SPACES TO INCREASE            00620000
*    THEIR OBJECT CAPACITY OVER A RESTART (WARM START?).                00630000
*                                                                       00640000
*                                                                       00650000
* ON ENTRY:                                                             00660000
*                                                                       00670000
*    R1 POINTS TO A PARAMETER LIST DESCRIBED BY THE PORTPRMS            00680000
*       MAPPING MACRO                                                   00690000
*                                                                       00700000
*    A/R10 - AR QUALIFIED ADDRESS OF THE STORAGE SPCBLOCK               00710000
*                                                                       00720000
*                                                                       00730000
* ON EXIT:                                                              00740000
*                                                                       00750000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES                     00760000
*                                                                       00770000
**<DOC-OFF>****************************************************         00780002
                                                                        00790002
         EJECT ,                                                        00800000
IDSSPCIM @ENTER WORKA=(WORKAREA,WORKLEN)                                00810000
                                                                        00820000
         LAE   R7,0(R1,0)         PLIST RESIDES IN PRIMARY SPACE        00830000
         USING PORTPRMS,R7        FORMATTED AREA                        00840000
                                                                        00850000
         LAE   R2,0(R2,0)         PSPACE                                00860000
         LAE   R3,0(R3,0)         PSPACE                                00870000
         LAE   R4,0(R4,0)         PSPACE                                00880000
         LAE   R5,0(R5,0)         PSPACE                                00890000
                                                                        00900000
*--------------------------------------------------------------         00910000
*   VALIDATE PASSED PARAMETERS - OPEN SPACE WINDOWS                     00920000
*--------------------------------------------------------------         00930000
         L     R2,PPSTOKEN        SPACE TOKEN                           00940000
         USING $TOKEN,R2          ADDRESSABILITY                        00950000
         CLC   $TOKTAG,=CL8'SPCTOKEN'                                   00960000
         BNE   ERR_REQ                                                  00970000
                                                                        00980000
         L     R10,$SPCBASE       PRINCIPLE SPACE ACCESS WINDOW         00990000
         LAM   AR10,AR10,$ALET                                          01000000
         USING SPCBLOCK,R10                                             01010000
         DROP  R2                 $TOKEN                                01020000
                                                                        01030000
         LAE   R9,SPCBLOCK        OPEN WINDOW TO SPACE                  01040000
         LAE   R8,SPCBLOCK        OPEN WINDOW TO SPACE                  01050000
                                                                        01060000
*--------------------------------------------------------------         01070000
*   IDENTIFY IMPORT PHASE                                               01080000
*--------------------------------------------------------------         01090000
         L     R2,PPFUNC          CALL FUNCTION                         01100000
         B     *+4(R2)            ANALYZE                               01110000
         B     IMP_DATA              0 - NOT DEFINED FOR IMPORT         01120000
         B     IMP_INIT              4 - INITIALIZE                     01130000
         B     IMP_TERM              8 - TERMINATE                      01140000
         B     ERR_REQ              12 - N/A                            01150000
         B     ERR_REQ              16 - N/A                            01160000
                                                                        01170000
         EJECT ,                                                        01180000
***************************************************************         01190000
*                                                                       01200000
* IMPORT INTIALIZATION                                                  01210000
*                                                                       01220000
***************************************************************         01230000
IMP_INIT DS    0H                                                       01240000
         L     R4,PPSTOKEN        FETCH OBJECT SPACE TOKEN PTR          01250000
         LA    R4,$STOKEN-$TOKEN(R4)                                    01260000
                                                                        01270000
         OI    SPC_FLAGS,SPC_$IMPORT                                    01280000
                                                                        01290000
         LA    R15,RC00           PROCEED                               01300000
         B     IMP_FIN            RETURN                                01310000
                                                                        01320000
         EJECT ,                                                        01330000
***************************************************************         01340000
*                                                                       01350000
* IMPORT TERMINATION                                                    01360000
*                                                                       01370000
***************************************************************         01380000
IMP_TERM DS    0H                                                       01390000
         @CALL IDSMAPSV,(STGRESET,0,*SPC_ALU_COUNT,0),                 X01400000
               MF=(E,MFE_LIST)                                          01410000
                                                                        01420000
         BAS   R14,RESETOIE       RESET UPDATE STATUS OF ALL OBJECTS    01430000
                                                                        01440000
         NI    SPC_FLAGS,FF-SPC_$IMPORT                                 01450000
                                                                        01460000
         L     R4,PPSTOKEN        FETCH OBJECT/SPACE TOKEN PTR          01470000
         LA    R4,$STOKEN-$TOKEN(R4)                                    01480000
         MVC   SPC_STOKEN,0(R4)   REFRESH SPACE TOKEN                   01490000
                                                                        01500000
         LA    R15,RC00           ASSUME IMPORT COMPLETE                01510000
         B     IMP_FIN            RETURN                                01520000
                                                                        01530000
         EJECT ,                                                        01540000
***************************************************************         01550000
*                                                                       01560000
* IMPORT NEXT ALU                                                       01570000
*                                                                       01580000
***************************************************************         01590000
IMP_DATA DS    0H                                                       01600000
         L     R2,PPALU@          LOCATE ALU NUMBER                     01610000
         ICM   R2,15,0(R2)        FETCH ALU NUMBER                      01620000
         BZ    IMP_ALU0           ALU0 IS A SPECIAL CASE                01630000
         C     R2,SPC_ALU_COUNT   ALU # EXCEEDS SPACE CAPACITY          01640000
         BNL   ERR_REQ            ERROR IF SO                           01650000
         LAE   R11,SPCBLOCK       USE PREEXISTING SPACE PARMS           01660000
         B     IMP_CONT           REJOIN COMMON LOGIC                   01670000
                                                                        01680000
IMP_ALU0 DS    0H                 BUFFER CONTAINS ALU0                  01690000
         MVC   SERCNTL,SPC_SERCNTL   SAVE EXTERNAL SERIALIZATION WORK   01700000
         L     R11,PPBUF@         BUFFER CONTAINS ALU0                  01710000
         LAE   R11,0(R11,0)       PRIMARY SPACE                         01720000
                                                                        01730000
*--------------------------------------------------------------         01740000
*   COMPUTE OBJECT SPACE ALU LOCATION AND LENGTH                        01750000
*--------------------------------------------------------------         01760000
IMP_CONT DS    0H                                                       01770000
         USING SPCBLOCK,R11       TEMPORARY ADDRESSABILITY              01780000
         @ALU  (R2)               CONVERT ALU # TO ADDRESS              01790000
         BNZ   ERR_ALU            ALU TRANSLATION ERROR                 01800000
         LR    R8,R1              OPEN CORRESPONDING SPACE WINDOW       01810000
         L     R9,SPC_ALU_SIZE    LENGTH OF ALU                         01820000
         DROP  R11                TEMPORARY SPCBLOCK                    01830000
                                                                        01840000
*--------------------------------------------------------------         01850000
*   MOVE ALU TO SPACE, REFRESH PRESERVED ALU0 INFORMATION               01860000
*--------------------------------------------------------------         01870000
         L     R4,PPBUF@          ALU ORIGIN                            01880000
         LR    R5,R9              SOURCE LENGTH = TARGET LENGTH         01890000
         MVCL  R8,R4              COPY                                  01900000
                                                                        01910000
         L     R2,PPALU@          RELOCATE ALU NUMBER                   01920000
         ICM   R2,15,0(R2)        REFETCH ALU NUMBER                    01930000
         BNZ   IMP_CPT            ALU0 IS A SPECIAL CASE                01940000
                                                                        01950000
         OI    SPC_FLAGS,SPC_$IMPORT REFRESH IMPORT IN PROGRESS         01960000
         MVC   SPC_SERCNTL,SERCNTL   REFRESH EXTERNAL SERIALIZATION     01970000
                                                                        01980000
IMP_CPT  DS    0H                                                       01990000
         LA    R15,RC00           SUCCESS                               02000000
         B     IMP_FIN            DONE                                  02010000
                                                                        02020000
         EJECT ,                                                        02030000
***************************************************************         02040000
*                                                                       02050000
* ROUTINE: RESETOIE                                                     02060000
*                                                                       02070000
* DESCRIPTION:                                                          02080000
*                                                                       02090000
*    RESET OBJECT MODIFICATION STATUS IN ALL OBJECTS                    02100000
*                                                                       02110000
* ON ENTRY:                                                             02120000
*                                                                       02130000
*    SPCBLOCK IS ADDRESSABLE VIA A/R10                                  02140000
*                                                                       02150000
* ON EXIT:                                                              02160000
*                                                                       02170000
*    R15 CONTAINS ZERO                                                  02180000
*                                                                       02190000
***************************************************************         02200000
RESETOIE DS    0H                                                       02210000
         STM   R0,R15,REGSAVEX    SAVE MAINLINE REGS                    02220000
                                                                        02230000
         NI    SPC_STGMAP_OIE+(OIEFLAGS-OIE),FF-OIEWRITE                02240000
         NI    SPC_POOL_OIE+(OIEFLAGS-OIE),FF-OIEWRITE                  02250000
                                                                        02260000
*--------------------------------------------------------------         02270000
*   LOCATE OIE POOL BASE FOR OIE TRAVERSAL                              02280000
*--------------------------------------------------------------         02290000
         LAE   R11,SPC_POOL_OIE   OIE POOL                              02300000
         USING OIE,R11            LIFE OF ROUTINE                       02310000
         L     R1,OIESTORG        ORIGIN OF OIEPOOL                     02320000
         @ALU  (1)                DERIVE ORIGIN ADDRESS                 02330000
         BNZ   ERR_ALU            ZERO TOLERANCE                        02340000
         LR    R9,R1              PRESERVE OIE POOL BASE                02350000
                                                                        02360000
*--------------------------------------------------------------         02370000
*   RESET READ/WRITE ACCESS FLAG IN CLOSED OIE'S                        02380000
*-------------------------------------------------------------          02390001
         LA    R11,SPC_OIE_LIST-(OIEMSTRF-OIE)                          02400000
                                                                        02410000
RSOIENXT DS    0H                 PROCESS NEXT APPL OBJECT              02420000
         ICM   R11,15,OIEMSTRF    OFFLINK OF NEXT PROJECT               02430000
         BZ    RSOIEEND           DONE IF END OF LIST                   02440000
         AR    R11,R9                                                   02450000
         NI    OIEFLAGS,FF-OIEWRITE-OIEREAD                             02460000
         B     RSOIENXT           VISIT ALL OBJECTS                     02470000
                                                                        02480000
RSOIEEND DS    0H                                                       02490000
         LM    R0,R14,REGSAVEX    RESTORE MAINLINE REGS                 02500000
         SR    R15,R15                                                  02510000
         BR    R14                                                      02520000
         DROP  R11                OIE                                   02530000
                                                                        02540000
         EJECT ,                                                        02550000
***************************************************************         02560000
*                                                                       02570000
* RETURN COMPLETION STATUS TO CALLER                                    02580000
*                                                                       02590000
***************************************************************         02600000
ERR_REQ  DS    0H                 INVALID REQUEST                       02610000
         LA    R15,RC16                                                 02620000
         B     IMP_FIN                                                  02630000
                                                                        02640000
ERR_ALU  DS    0H                 ALU TRANSLATION ERROR                 02650000
         LA    R15,RC20                                                 02660000
         B     IMP_FIN                                                  02670000
                                                                        02680000
ERR_ENV  DS    0H                 ENVIRONMENTAL / SERVICE FAILURE       02690000
                                                                        02700000
IMP_FIN  DS    0H                                                       02710000
         NOP   0                  SPACE FOR TRAP                        02720000
                                                                        02730000
         @EXIT ,                                                        02740000
                                                                        02750000
         EJECT ,                                                        02760000
***************************************************************         02770000
*                                                                       02780000
* READ ONLY CONSTANTS, ETC                                              02790000
*                                                                       02800000
***************************************************************         02810000
         LTORG ,                                                        02820000
         END   ,                                                        02830000

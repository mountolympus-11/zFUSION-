ISESCAPI TITLE 'SESSION SERVICES C-LANGUAGE API'                        00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE:  ISESCAPI - Session Services C-Language API                  00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*   This module contains the functions used to bridge a                 00080000
*   C-language program to the session services API.  Please             00090000
*   refer to the function prolog for a description of                   00100000
*   each function.                                                      00110000
*                                                                       00120000
* FUNCTIONS:                                                            00130000
*                                                                       00140000
*   SESS  - Session Services API                                        00150000
*                                                                       00160000
* ON ENTRY:                                                             00170000
*                                                                       00180000
*   R1 Contains the address of the parameter list following             00190000
*   the SAS/C standard linkage conventions.  See function               00200000
*   prolog for details.                                                 00210000
*                                                                       00220000
* ON EXIT:                                                              00230000
*                                                                       00240000
*   R15 Contains the return info as documented in the                   00250000
*   function prolog.                                                    00260000
*                                                                       00270000
**<DOC-OFF>*****************************************************        00280000
                                                                        00290000
         EJECT ,                                                        00300000
****************************************************************        00310000
*                                                                       00320000
* MAINTENANCE:                                                          00330000
*                                                                       00340000
*   07/26/93 Ron Colmone                                                00350000
*            Initial version                                            00360000
*                                                                       00370000
****************************************************************        00380000
         EJECT ,                                                        00390000
         $SESS  DSECT=YES         Session service plist                 00400000
                                                                        00410000
         EJECT ,                                                        00420000
         EQUS  ,                  GENERAL EQUATES                       00430000
                                                                        00440000
         $MSGDFT PREFIX=ICTPID,COMPID='SES',TABLE=*#MSGS,              +00450000
               CONID=*ICTCONID,CONNAME=ICTCONNM,MF=(E,WRK256)           00460000
                                                                        00470000
         EJECT ,                                                        00480000
         COPY  CRAB               "C"  RUNTIME ANCHOR BLOCK             00490000
         USING CRAB,R12           LIFETIME ADDRESSABILITY               00500000
                                                                        00510000
         EJECT ,                                                        00520000
         COPY  DSA                DYNAMIC SAVE AREA                     00530000
WORKDSA  DS    0D                 DSA USER SECTION                      00540000
WRK256   DS    XL256              GENERAL WORKAREA                      00550000
PRM_SPL  DS    A                  ADDR OF SPLIST                        00560000
PRM_TKN  DS    A                  ADDR OF SESSION TOKEN                 00570000
PRM_REQ  DS    F                  REQUEST FUNCTION CODE                 00580000
PRM_AREA DS    A                  AREA ADDRESS                          00590000
PRM_ALEN DS    F                  AREA LENGTH                           00600000
                                                                        00610000
$SESSPL@ DS    A                  ADDRESS OF $SESS PLIST                00620000
WORKLEN  EQU   *-WORKDSA          LENGTH OF DSA USER SECTION            00630000
DSALEN   EQU   *-DSA              LENGTH OF DSA                         00640000
                                                                        00650000
         EJECT ,                                                        00660000
**<DOC-ON>******************************************************        00670000
*                                                                       00680000
* FUNCTION: SESS - Session Services API                                 00690000
*                                                                       00700000
* DESCRIPTION:                                                          00710000
*                                                                       00720000
*   This function provides a bridge from a C-Language program           00730000
*   to the Session Services API.   This function will simply            00740000
*   invoke the $SESS API using the passed session parameters.           00750000
*   An existing plist may optionally be specified to allow              00760000
*   current values to be utilized for certain session related           00770000
*   fields (i.e. SEQNO).  Auto_protocol=yes is specified to             00780000
*   allow the session services API to manage session protocol.          00790000
*                                                                       00800000
*   If a sess plist is not provided,  a new plist is used               00810000
*   assuming the default values.                                        00820000
*                                                                       00830000
*                                                                       00840000
* ENTRY:    R1 Contains the address of the parameter list               00850000
*              as follows:                                              00860000
*                                                                       00870000
*               +00  - Address of SPLIST or 0                           00880000
*               +04  - Address of SESSTOKN                              00890000
*               +08  - Function request code                            00900000
*               +12  - Address of area                                  00910000
*               +16  - Length  of area                                  00920000
*                                                                       00930000
* EXIT:     R15 Contain the return code from the $SESS                  00940000
*               service.                                                00950000
*                                                                       00960000
**<DOC-OFF>*****************************************************        00970000
                                                                        00980000
ISESCAPI CSECT ,                                                        00990000
SESS     CENTRY DSA=DSALEN                                              01000000
         USING DSA,R13            ADDRESSABILITY                        01010000
                                                                        01020000
         LR    R8,R1              SAVE PARM ADDRESS                     01030000
                                                                        01040000
         LA    R0,WORKDSA         WORKAREA ORIGIN                       01050000
         LA    R1,WORKLEN         LENGTH OF WORKAREA                    01060000
         SR    R15,R15            PREPAREA FOR CLEAR                    01070000
         MVCL  R0,R14             CLEAR WORKAREA                        01080000
                                                                        01090000
         LM    R3,R7,0(R8)        RETRIVED PASSED PARMS                 01100000
         ST    R3,PRM_SPL         SAVE PLIST ADDRESS                    01110000
         ST    R4,PRM_TKN         SAVE SESSION TOKEN ADDRESS            01120000
         ST    R5,PRM_REQ         SAVE REQUEST FUNCTION CODE            01130000
         ST    R6,PRM_AREA        SAVE AREA ADDRESS                     01140000
         ST    R7,PRM_ALEN        SAVE AREA LENGTH                      01150000
                                                                        01160000
*---------------------------------------------------------------        01170000
*  RESTORE STANDARD ENVIRONMENT                                         01180000
*---------------------------------------------------------------        01190000
         @RESTENV ,                                                     01200000
         USING ICVT,R11           ADDRESSABILITY                        01210000
         USING ITASK,R10          ADDRESSABILITY                        01220000
                                                                        01230000
         EJECT ,                                                        01240000
*---------------------------------------------------------------        01250000
*  IF A $SESS PARAMETER LIST IS PROVIDED,  ISSUE THE SESSION            01260000
*  REQUEST USING THIS PLIST AND ASSUME ALL CURRENT VALUES               01270000
*  SPECIFIED IN THE PLIST.                                              01280000
*---------------------------------------------------------------        01290000
         L     R4,PRM_REQ         OBTAIN FUNCTION CODE                  01300000
         ICM   R3,15,PRM_SPL      $SESS PLIST PROVIDED?                 01310000
         BZ    SESS_SPL           NO,  USE INTERNAL PLIST               01320000
                                                                        01330000
         $SESS (R4),              REQUEST SESSION SERVICES             +01340000
               SESSION=*PRM_TKN,                                       +01350000
               AREA=*PRM_AREA,                                         +01360000
               AREALEN=*PRM_ALEN,                                      +01370000
               CNTRL=*,                                                +01380000
               RH=*,                                                   +01390000
               SEQNO=*,                                                +01400000
               SENSE=*,                                                +01410000
               MF=(E,(R3))                                              01420000
                                                                        01430000
         B     SESS_TST           TEST COMPLETION STATUS                01440000
                                                                        01450000
         EJECT ,                                                        01460000
*---------------------------------------------------------------        01470000
*  THE $SESS PARAMETER LIST IS NOT PROVIDED.  IF THE REQUEST IS         01480000
*  TO SEND DATA,  THEN ISSUE THE SESSION SERVICES REQUEST USING         01490000
*  THE AUTO_PROTOCOL OPTION.                                            01500000
*---------------------------------------------------------------        01510000
SESS_SPL DS    0H                                                       01520000
         $GETSTOR L'SPL,OWNER=ITASK    ALLOCATE $SESS PLIST             01530000
         LR    R3,R1              ADDR OF SPLIST                        01540000
         ST    R3,$SESSPL@        SAVE PLIST ADDRESS                    01550000
                                                                        01560000
         C     R4,=A($SESS_SEND_DATA)  SEND REQUEST?                    01570000
         BNE   NO_AUTOP           NO, THEN DON'T USE AUTO_PROTOCOL      01580000
                                                                        01590000
         $SESS (R4),              REQUEST SESSION SERVICES             +01600000
               SESSION=*PRM_TKN,                                       +01610000
               AREA=*PRM_AREA,                                         +01620000
               AREALEN=*PRM_ALEN,                                      +01630000
               AUTO_PROTOCOL=YES,                                      +01640000
               MF=(E,(R3))                                              01650000
                                                                        01660000
         B     SESS_TST           TEST COMPLETION STATUS                01670000
                                                                        01680000
         EJECT ,                                                        01690000
*---------------------------------------------------------------        01700000
*  THE $SESS PARAMETER LIST IS NOT PROVIDED AND REQUEST IS NOT TO       01710000
*  SEND DATA.  THEREFORE,  AUTO_PROTOCOL IS NOT SPECIFIED ON            01720000
*  THE SESSION REQUEST.                                                 01730000
*---------------------------------------------------------------        01740000
NO_AUTOP DS    0H                                                       01750000
         $SESS (R4),              REQUEST SESSION SERVICES             +01760000
               SESSION=*PRM_TKN,                                       +01770000
               AREA=*PRM_AREA,                                         +01780000
               AREALEN=*PRM_ALEN,                                      +01790000
               MF=(E,(R3))                                              01800000
                                                                        01810000
         EJECT ,                                                        01820000
*---------------------------------------------------------------        01830000
*  OBTAIN RETURN CODE, FREE PLIST AND RETURN                            01840000
*---------------------------------------------------------------        01850000
SESS_TST DS    0H                                                       01860000
         USING SPLIST,R3          ADDRESSABILITY                        01870000
         LTR   R5,R15             REQUEST ACCEPTED                      01880000
         BNZ   SPL_DIAG           NO, EXIT                              01890000
         L     R5,SPLRETCD        OBTAIN SESS SERVICE RETCODE           01900000
                                                                        01910000
SPL_DIAG DS    0h                                                       01920000
         LTR   R5,R5              REQUEST COMPLETED SUCCESSFULLY        01930000
         BZ    SPL_FREE           YES, RETURN SPLIST STORAGE            01940000
         @CALL ISESDIAG,(SPLIST,0,0,0),                                +01950000
               CTYPE=CVT,MF=(E,WRK256)                                  01960000
                                                                        01970000
SPL_FREE DS    0H                                                       01980000
         ICM   R3,15,$SESSPL@     SPLIST ALLOCATED?                     01990000
         BZ    SESS_RET           NO, RETURN                            02000000
         $RETSTOR (R3),OWNER=ITASK  FREE $SESS PLIST                    02010000
                                                                        02020000
SESS_RET DS    0H                                                       02030000
         CEXIT RC=(R5)            RETURN                                02040000
                                                                        02050000
         DROP  R3                 SPLIST                                02060000
         EJECT ,                                                        02070000
*---------------------------------------------------------------        02080000
*  LITERALS AND CONSTANTS                                               02090000
*---------------------------------------------------------------        02100000
         LTORG ,                                                        02110000
                                                                        02120000
         PRINT NOGEN                                                    02130000
         ICVT  ,                                                        02140000
         IVTAMCVT ,                                                     02150000
         ITASK ,                                                        02160000
         IPCB  ,                                                        02170000
         ISTDBIND ,                                                     02180000
         ISESS ,                                                        02190000
         IHAPSA ,                                                       02200000
         IKJTCB ,                                                       02210000
         CVT   DSECT=YES,LIST=NO                                        02220000
         PRINT GEN                                                      02230000
                                                                        02240000
         END   ,                                                        02250000

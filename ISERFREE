ISERFREE TITLE 'ISERFREE - RELEASE ALL LOCKS HELD BY WORK UNIT'         00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: ISERFREE - RELEASE ALL LOCKS HELD BY WORK UNIT               00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THIS ROUTINE IS USED TO RELEASE ALL LOCKS HELD BY THE              00080000
*    GIVEN QLOCK, WHICH REPRESENTS A WORK UNIT. THE QLOCK IS            00090000
*    PASSED TO PROVIDE SUPPORT FOR CALLERS RUNNING IN OTHER             00100000
*    THAN THE STANDARD ENVIRONMENT.                                     00110000
*                                                                       00120000
*                                                                       00130000
* ON ENTRY:                                                             00140000
*                                                                       00150000
*    R0  CONTAINS THE ADDRESS OF A 256 BYTE WORKAREA                    00160000
*                                                                       00170000
*    R1  CONTAINS A QLOCK DESIGNATION                                   00180000
*                                                                       00190000
*        WHEN R1 IS ZERO, IT IMPLIES THE USE OF THE QLOCK               00200000
*        ASSOCIATED WITH A STANDARD WORK UNIT (ITASK OR PCB).           00210000
*        WHEN R1 IS NON-ZERO, IT CONTAINS THE ADDRESS OF A              00220000
*        QLOCK (MAPPING $QLOCK) ASSOCIATED WITH A NON-STANDARD          00230000
*        WORK UNIT SUCH AS AN SRB.                                      00240000
*                                                                       00250000
* ON EXIT:                                                              00260000
*                                                                       00270000
*    ALL LOCKS OWNED BY THE DESIGNATED WORK UNIT ARE RELEASED           00280000
*                                                                       00290000
**<DOC-OFF>****************************************************         00300000
                                                                        00310000
***************************************************************         00320000
*                                                                       00330000
* MAINTENANCE:                                                          00340000
*                                                                       00350000
*    06/14/93 R. TURGEON                                                00360000
*             Initial version                                           00370000
*                                                                       00380000
***************************************************************         00390000
                                                                        00400000
         EJECT                                                          00410000
         #WORK LENGTH=256                                               00420000
         #ENDWORK                 OS/VS REGISTER SAVEAREA               00430000
                                                                        00440000
         EJECT                                                          00450000
         $QLOCK ,                 LOCK QUEUE ENTRY AND STATUS           00460000
                                                                        00470000
         EJECT                                                          00480000
         $LOCK  ,                 LOCK FORMAT                           00490000
                                                                        00500000
         EJECT                                                          00510000
         EQUS  ,                                                        00520000
                                                                        00530000
         EJECT                                                          00540000
ISERFREE #ENTER PREG=R8,WAPASS=YES                                      00550000
                                                                        00560000
         USING ITASK,R10          ITASK                                 00570000
         USING IPCB,R9            PROCESS                               00580000
                                                                        00590000
         EJECT                                                          00600000
*--------------------------------------------------------------         00610000
*   LOCATE QLOCK ASSOCIATED WITH WORK UNIT                              00620000
*--------------------------------------------------------------         00630000
         LTR   R8,R8              LOCK CONTROL AREA PROVIDED?           00640000
         BNZ   REL_GO             DONE IF NOT                           00650000
         USING QLOCK,R8                                                 00660000
                                                                        00670000
         LTR   R10,R10            ITASK MODE                            00680000
         BZ    REL_FIN            ENVIRONMENT REQUIRED                  00690000
         L     R8,TSKSERQ         ITASK QLOCK                           00700000
         ICM   R9,15,TSKPCBC      PROCESS MODE?                         00710000
         BZ    *+8                SKIP IF NOT PROCESS MODE              00720000
         L     R8,PCBSERQ         PROCESS QLOCK                         00730000
                                                                        00740000
*--------------------------------------------------------------         00750000
*   RELEASE ALL LOCKS                                                   00760000
*--------------------------------------------------------------         00770000
REL_GO   DS    0H                                                       00780000
         ICM   R5,15,ICTLK@       LOCK MANAGER INITIALIZED?             00790000
         BZ    REL_MILS           SKIP IF NOT                           00800000
         USING LOCK,R5            EXAMINE CURRENT LOCK                  00810000
                                                                        00820000
REL_LOCK DS    0H                                                       00830000
         ICM   R0,15,LOCKUSE      LOCK HELD BY ANYONE?                  00840000
         BNM   REL_NEXT           WU CANNOT BE HOLDING IF NOT           00850000
                                                                        00860000
         $SER  RELEASE,LOCKPTR=(R5),QLOCK=(R8),COND=YES                 00870000
                                                                        00880000
REL_NEXT DS    0H                                                       00890000
         ICM   R5,15,LOCKLINK     SCAN ALL LOCKS                        00900000
         BNZ   REL_LOCK           RELEASE LOCKS                         00910000
         DROP  R5                 LOCK                                  00920000
                                                                        00930000
*--------------------------------------------------------------         00940000
*   Release Multiple Instance locks held                                00950000
*--------------------------------------------------------------         00960000
REL_MILS DS    0H                                                       00970000
         ICM   R0,15,QLOMILCT     ANY MULTI INSTANCE LOCKS HELD         00980000
         BZ    REL_FIN            DONE IF NOT                           00990000
                                                                        01000000
         LA    R3,QLOMILH#        # OF ENTRIES IN MIL HELD ARRAY        01010000
         LA    R2,QLOMILHD        MIL HELD ARRAY ORIGIN                 01020000
                                                                        01030000
REL_MIL  DS    0H                                                       01040000
         ICM   R5,15,0(R2)        ADDRESS OF MIL LOCK                   01050000
         BZ    REL_MNXT           NONE, GET NEXT MIL LOCK ARRAY PTR     01060000
                                                                        01070000
         $SER  RELEASE,LOCKPTR=(R5),QLOCK=(R8),COND=YES                 01080000
                                                                        01090000
REL_MNXT DS    0H                                                       01100000
         LA    R2,4(,R2)          ADDRESS OF NEXT ARRAY ENTRY           01110000
         BCT   R3,REL_MIL         CHECK NEXT ARRAY ENTRY                01120000
                                                                        01130000
*--------------------------------------------------------------         01140000
*   RETURN                                                              01150000
*--------------------------------------------------------------         01160000
REL_FIN  DS    0H                                                       01170000
         #EXIT ,                                                        01180000
                                                                        01190000
         EJECT ,                                                        01200000
***************************************************************         01210000
*                                                                       01220000
*   LOCAL READ-ONLY STORAGE, ETC.                                       01230000
*                                                                       01240000
***************************************************************         01250000
         LTORG ,                                                        01260000
                                                                        01270000
         EJECT                                                          01280000
         PRINT NOGEN                                                    01290000
         ICVT  ,                                                        01300000
         ITASK ,                                                        01310000
         IPCB  ,                                                        01320000
         END   ,                                                        01330000

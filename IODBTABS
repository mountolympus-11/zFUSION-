IODBTABS TITLE '- ODBC SQLTABLES() RESULT SET GENERATOR'                00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: IODBTABS - ODBC SQLTables() result set generator             00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    That QCS is expected and required to contain the semantic          00080000
*    information acquired from a SQL                                    00090000
*                                                                       00100000
*       SELECT <col-list> FROM SYSVCAT_ODBC_TABS# WHERE ...             00110000
*                                                                       00120000
*    statement.  The result set generated by this query can be          00130000
*    fashioned to conform to the various forms of the SQLTables()       00140000
*    function by appropriate composition of the <col-list> and          00150000
*    the use of an ORDER BY clause.                                     00160000
*                                                                       00170000
*    A one character, numeric suffix (#) is appended to the table       00180000
*    name to identify the appropriate format of the result set.         00190000
*    The ODBC-defined technique for passing parameters on the           00200000
*    SQLTables() function call provides for the return of               00210000
*    one of four distinct table formats.  Each format is a              00220000
*    version SYSVCAT_ODBC_TABS, each differing by the presence          00230000
*    of nulls in the columns returned, as follows:                      00240000
*                                                                       00250000
*      TABS1: Return standard result set                                00260000
*                                                                       00270000
*      TABS2: Return TABLE_QUALIFIERs only, all other columns nulled    00280000
*                                                                       00290000
*      TABS3: Return TABLE_OWNERs only, all other columns nulled        00300000
*                                                                       00310000
*      TABS4: Return TABLE_TYPEs only, all other columns nulled         00320000
*                                                                       00330000
*                                                                       00340000
* IMPLEMENTATION NOTES:                                                 00350000
*                                                                       00360000
*    Because the product does not implement table qualifiers            00370000
*    or owners, TABS2 and TABS3 requests always return an               00380000
*    empty table.                                                       00390000
*                                                                       00400000
*    TABS2 - TABS4 requests must be made with the DISTINCT              00410000
*    keyword to reduce multiple occurrances of a single data            00420000
*    type to a single result set row.                                   00430000
*                                                                       00440000
*                                                                       00450000
*    TABLE_QUALIFIER  - Table qualifiers are not implemented.           00460000
*                       This column is nulled.                          00470000
*                                                                       00480000
*    TABLE_OWNER      - Table owners are not implemented.               00490000
*                       This column is nulled.                          00500000
*                                                                       00510000
*    TABLE_TYPE       - Is either "TABLE" or "SYSTEM TABLE"             00520000
*                                                                       00530000
*    REMARKS          - The content of this column is not               00540000
*                       specified by ODBC.  It will contain             00550000
*                       "CATALOG" for catalog component tables          00560000
*                       and "VDB" for virtual data base table           00570000
*                       definitions.                                    00580000
*                                                                       00590000
*                                                                       00600000
* ON ENTRY                                                              00610000
*                                                                       00620000
*    R1  contains the address of the Query Content Summary              00630000
*                                                                       00640000
*    R0  contains the address of a preallocated savearea                00650000
*        not less than 1K in length or zero                             00660000
*                                                                       00670000
*                                                                       00680000
* ON EXIT:                                                              00690000
*                                                                       00700000
*    R15 contains zero or a return code acquired from SQLCODES          00710000
*        if an error is encountered.  R0 and R1 contain reason          00720000
*        and info codes respectively.  The QCSESTAT words are           00730000
*        updated accordingly.                                           00740000
*                                                                       00750000
**<DOC-OFF>****************************************************         00760000
                                                                        00770000
         EJECT                                                          00780000
***************************************************************         00790000
*                                                                       00800000
*  MAINTENANCE:                                                         00810000
*                                                                       00820000
*    01/25/95  R. Turgeon    Int 2.0  ODCB Support                      00830000
*              Initial version                                          00840000
*                                                                       00850000
*    10/31/95  R. Turgeon    Rel 2.1                                    00860000
*              Create transient result set with NOLOCATOR               00870000
*              option                                                   00880000
*                                                                       00890000
***************************************************************         00900000
                                                                        00910000
         EJECT                                                          00920000
         QCS   ,                  QUERY CONTENT SUMMARY                 00930000
                                                                        00940000
         EJECT                                                          00950000
         SQLSEMAL ,               SQL SEMANTIC SUMMARY                  00960000
                                                                        00970000
         EJECT                                                          00980000
         KYNDXRET ,               RESULT SET NDX DEFINITION RETURN AREA 00990000
                                                                        01000000
         EJECT                                                          01010000
         SPACETYP DSECT=YES       OBJECT SPACE DEFINITION BLOCK         01020000
                                                                        01030000
         EJECT                                                          01040000
         SCTDEF DSECT=YES         SPACE COMPONENT TABLE / ENTRIES       01050000
                                                                        01060000
         EJECT                                                          01070000
         TBSERVIS CREATE,OPEN,CLOSE,GET,ADD,PSARG,COLUMN                01080000
                                                                        01090000
         EJECT                                                          01100000
         ICATALOG TABLE                                                 01110000
                                                                        01120000
         EJECT                                                          01130000
         VCATALOG ODBC_TABS       VIRTUAL CATALOG TABLE COMPOSITION     01140000
                                                                        01150000
         EJECT                                                          01160000
         CATINFO ,                COLUMN AND INDEX DEFINTION HEADER     01170000
                                                                        01180000
         EJECT                                                          01190000
         DDENTRY ,                SYSDICTIONARY ROW FORMAT              01200000
                                                                        01210000
         EJECT                                                          01220000
         ODBCSQLH ,               ODBC CONSTANTS, DEFINITIONS, ETC.     01230000
                                                                        01240000
         EJECT                                                          01250000
         CRSDP ,                  CREATE RESULT SET REQUEST/RESPONSE    01260000
                                                                        01270000
         EJECT                                                          01280000
         EQUS  ,                                                        01290000
                                                                        01300000
         ABCODES ,                                                      01310000
                                                                        01320000
         EJECT                                                          01330000
         #WORK ,                                                        01340000
                                                                        01350000
@OSC     DS    A             OBJECT SPACE CONTENTS BLOCK ADDRESS        01360000
@NDXDEF  DS    A             RESULT SET INDEX DEFINITION (KYNDXRET)     01370000
SYSTABTK DS    F             SYSTABLES CATALOG - TABLE TOKEN            01380000
                                                                        01390000
REQVIEW  DS    F             REQUEST TYPE FROM TABLE NAME SUFFIX        01400000
REQ_STD  EQU   1                STANDARD                                01410000
REQ_QUAL EQU   2                TABLE QUALIFIERS ONLY                   01420000
REQ_OWNR EQU   3                TABLE OWNERS ONLY                       01430000
REQ_TYPE EQU   4                TABLE TYPES ONLY                        01440000
                                                                        01450000
RET_CRSD DS    F             RESULT SET DEFINITION SERVICE RTN RETCODE  01460000
$SCNCKPT DS    XL8           ICAT$SCN CHECKPOINT AREA                   01470000
                                                                        01480000
RETCODES DS    0F,0F,0F      COMPLETION STATUS                          01490000
RETCODE  DS    F                RETURN CODE                             01500000
RSNCODE  DS    F                REASON CODE                             01510000
INFCODE  DS    F                INFO CODE                               01520000
                                                                        01530000
WK256    DS    XL256         GENERAL PURPOSE WORKAREA                   01540000
                                                                        01550000
*--------------------------------------------------------------         01560000
*   TABLE COLUMN STATUS MAINTAINED FOR NULLABLE COLUMNS                 01570000
*--------------------------------------------------------------         01580000
                                                                        01590000
STATQUAL DS    F             TABLE_QUALIFIER                            01600000
STAOWNER DS    F             TABLE_OWNER                                01610000
STANAME  DS    F             TABLE_NAME                                 01620000
STATYPE  DS    F             TABLE_TYPE                                 01630000
STAREMRK DS    F             REMARKS                                    01640000
                                                                        01650000
NULL_IND DS    XL4           NULL INDICATORS FOR 32 COLUMNS             01660000
                                                                        01670000
*--------------------------------------------------------------         01680000
*   PLIST CONSTRUCTION AREAS                                            01690000
*--------------------------------------------------------------         01700000
                                                                        01710000
$CRSDP   DS    0F,XL(CRSDPLN)    CREATE RESULT SET DEFINITION REQ/RESP  01720000
$CRSTREF DS    0F,XL(CRSTREFL)   CREATE RESULT SET - TABLE REFERENCE    01730000
                                                                        01740000
*--------------------------------------------------------------         01750000
*   VARDATA COLUMN COLLECTION AND CONSTRUCTION AREA                     01760000
*--------------------------------------------------------------         01770000
                                                                        01780000
VCHAR@   DS    A             FREE AREA PTR IN VARDATA COLLECTION AREA   01790000
VCHAR#   DS    F             FREE STG LEFT IN VARDATA COLLECTION AREA   01800000
VCHARBUF DS    XL512         VARDATA COLLECTION AREA                    01810000
                                                                        01820000
*--------------------------------------------------------------         01830000
*   TABLE SERVICES ROW BUFFERS                                          01840000
*--------------------------------------------------------------         01850000
                                                                        01860000
$ODBCROW DS    XL(ODBTABS_LENGTH)   SYSVCAT_ODBC_TABS SOURCE ROW BUFFER 01870000
                                                                        01880000
$SYSTAB  DS    XL(STBLN)     SYSTABLES ROW BUFFER                       01890000
                                                                        01900000
$DDEROW  DS    XL(DDELN)     SYSDICTIONARY ROW BUFFER                   01910000
$DDEVX   DS    XL256         VARDATAX EXTENSION AREA                    01920000
                                                                        01930000
         #ENDWORK                                                       01940000
                                                                        01950000
         EJECT                                                          01960000
IODBTABS #ENTER PREG=R8                                                 01970000
                                                                        01980000
         USING ITASK,R10                                                01990000
                                                                        02000000
         EJECT                                                          02010000
***************************************************************         02020000
*                                                                       02030000
*   Validate the table name suffix that is used to identify             02040000
*   the content of the result set.                                      02050000
*                                                                       02060000
***************************************************************         02070000
                                                                        02080000
         USING QCS,R8             LIFE OF FUNCTION                      02090000
                                                                        02100000
         ICM   R2,1,QCSTABLE+L'TABNAME-1                                02110000
                                                                        02120000
         CLM   R2,1,=C'1'         VALIDATE TABLE NAME SUFFIX            02130000
         BL    ERR_CTAB                                                 02140000
         CLM   R2,1,=C'4'                                               02150000
         BH    ERR_CTAB                                                 02160000
                                                                        02170000
         N     R2,=X'0000000F'    CONVERT TO NUMERIC                    02180000
         ST    R2,REQVIEW         RETAIN REQUEST TYPE                   02190000
                                                                        02200000
TABNAME  DS    0C'SYSVCAT_ODBC_TABS#'                                   02210000
                                                                        02220000
***************************************************************         02230000
*                                                                       02240000
*   Prepare to materialize the ODBC-defined result set                  02250000
*   by initializing a SYSVCAT_ODBC_TABS table in the execution          02260000
*   space.  We leave it to coop to determine the proper                 02270000
*   ordering and row admittance criterea via the use of                 02280000
*   ALL/DISTINCT and ORDER BY in the source SELECT statement.           02290000
*                                                                       02300000
***************************************************************         02310000
                                                                        02320000
         GENTBLNM QCSTABLE        GENERATE A NAME FOR THE RESULT SET    02330000
                                                                        02340000
C        USING ODBTABS,$ODBCROW   SYSVCAT_ODBC_TABS ROW                 02350000
                                                                        02360000
*--------------------------------------------------------------         02370000
*   GENERATE A RESULT SET DEFINITION FROM THE BASE TABLE                02380000
*--------------------------------------------------------------         02390000
                                                                        02400000
         L     R7,=V(IVCATABS)    SYSVCAT_ODBC_TABS TABLE FORMAT        02410000
         USING CATINFO,R7         DEFINITION FORMAT                     02420000
                                                                        02430000
TREF     USING CRSTREF,$CRSTREF   SINGLE VIRTUAL TABLE REFERENCE        02440000
         L     R6,QCSSSMRY        LOCATE THE SEMANTIC SUMMARY           02450000
         USING SQSEMAL,R6                                               02460000
         MVC   TREF.CRSTAB,SQSATBLS    RETAIN PTR TO TABLE IDENTIFIER   02470000
         MVC   TREF.CRSTCOL@,CATCOLS   TBCOLDEF PTR ARRAY ORIGIN        02480000
         MVC   TREF.CRSTCOL#,CAT#COLS  NUMBER OF COLUMNS IN BASE TABLE  02490000
         DROP  R7                 CATINFO                               02500000
                                                                        02510000
CRSD     USING CRSDP,$CRSDP       CREATE RESULT SET DEFINITION REQ/RESP 02520000
         ST    R6,CRSD.CRSDSMRY   PROVIDE SEMANTIC SUMMARY AS PARM      02530000
         LA    R0,TREF.CRSTREF    TABLE REFERENCE LIST ORIGIN           02540000
         ST    R0,CRSD.CRSDTBL@   ANCHOR IN CRSDP                       02550000
         LA    R0,1               TABLE REFERENCE IS A SINGLETON        02560000
         ST    R0,CRSD.CRSDTBL#   ANCHOR IN CRSDP                       02570000
         DROP  TREF,R6            CRSDP TABLE REFERENCE, SQSEMAL        02580000
                                                                        02590000
         LA    R1,CRSD.CRSDP      R1 <== RESULT SET DEFINITION REQ/RESP 02600000
         @CALL ISQLCRSD,CTYPE=STD                                       02610000
                                                                        02620000
         ST    R15,RET_CRSD       RETAIN RESULT SET DEFINITION RETCODE  02630000
         CH    R15,=AL2(RC08)     ANALYZE RETURN CODE                   02640000
         BE    ERR_CREF           INVALID COLUMN REFERENCE              02650000
         BH    ERR_RSD            REQUEST IN ERROR                      02660000
                                                                        02670000
*--------------------------------------------------------------         02680000
*   BUILD RESULT SET INDEX DEFINITIONS, RETURN KYNDXRET IN R1           02690000
*--------------------------------------------------------------         02700000
                                                                        02710000
         @CALL ISQKYNDX,(QCS,*CRSD.CRSDPTR@,*CRSD.CRSDRSC#),           X02720000
               MF=(E,MFE_LIST)                                          02730000
                                                                        02740000
         B     *+4(R15)           ANALYZE COMPLETION CODE               02750000
         B     TBLCRE                RC00 - INDEX DEFINITION RETURNED   02760000
         B     TBLCRE                RC04 - NO INDICIES REQUIRED        02770000
         B     ERR_ORD               RC08 - ORDER-BY CLAUSE IN ERROR    02780000
         B     ERR_DIST              RC12 - ERROR RELATED TO DISTINCT   02790000
         EX    R0,*                  RC16 - DEFINED / NOT ANTICIPATED   02800000
                                                                        02810000
*--------------------------------------------------------------         02820000
*   CREATE THE RESULT SET                                               02830000
*--------------------------------------------------------------         02840000
                                                                        02850000
TBLCRE   DS    0H                                                       02860000
         XC    DWORD,DWORD        TBKEYDEF LIST AND ENTRY COUNT         02870000
         ST    R1,@NDXDEF         INDEX DEFINITION BLOCK OR ZERO        02880000
         LTR   R1,R1              INDEX DEFINITIONS PRESENTED?          02890000
         BZ    TBLCRETB           DONE HERE IF NOT                      02900000
                                                                        02910000
         USING KYNDXRET,R1        INDEX DEFINITION RETURN AREA          02920000
         LA    R0,KYNDXLST        TBKEYDEF LIST ORIGIN                  02930000
         ST    R0,DWORD+0         SAVE IN PARAMETER WORKAREA            02940000
         L     R0,KYNDXCNT        TBKEYDEF LIST ENTRY COUNT             02950000
         ST    R0,DWORD+4         SAVE IN PARAMETER WORKAREA            02960000
         DROP  R1                 KYNDXRET                              02970000
                                                                        02980000
TBLCRETB DS    0H                                                       02990000
         TBCREATE QCSTABLE,       PROVIDE GENERATED TABLE NAME         X03000000
               STOKEN=*ICTXSPT@,  EXECUTION SPACE                      X03010000
               TTOKEN=QCSTTOKN,   TABLE TOKEN IS GLOBAL SQL RESOURCE   X03020000
               COLCNT=*CRSD.CRSDTOT#,   COLUMN COUNT                   X03030000
               COLLST=*CRSD.CRSDPTR@,   COLUMN POINTER ARRAY           X03040000
               KEYCNT=*DWORD+4,   KEY COUNT                            X03050000
               KEYLST=*DWORD+0,   KEY LIST                             X03060000
               OPTS=(REPLACE,NOLOCATOR),                               X03070000
               MF=(E,WK256)                                             03080000
                                                                        03090000
*--------------------------------------------------------------         03100000
*   ANALYZE TBCREATE STATUS, RELEASE INDEX & RSD DEFINITIONS            03110000
*--------------------------------------------------------------         03120000
                                                                        03130000
         STM   R15,R1,RETCODES    PRESERVE TBCREATE COMPLETION STATUS   03140000
         ICM   R2,15,@NDXDEF      INDEX DEFINITION WORKAREA PENDING?    03150000
         BZ    TBLNONDX           SKIP IF NOT                           03160000
                                                                        03170000
         $RETSTOR (R2)            STORAGE OBLIGATION                    03180000
                                                                        03190000
TBLNONDX DS    0H                                                       03200000
                                                                        03210000
         CLC   RET_CRSD,=A(RC00)  RESULT SET DEFINITION CREATED?        03220000
         BNE   TBLNORSD           SKIP IF BASE TABLE DEFINITION USED    03230000
                                                                        03240000
         $RETSTOR *CRSD.CRSDPTR@                                        03250000
                                                                        03260000
TBLNORSD DS    0H                                                       03270000
                                                                        03280000
         LM    R15,R1,RETCODES    RESTORE TBCREATE COMPLETION STATUS    03290000
         LTR   R15,R15            TABLE CREATED WITHOUT INCIDENT?       03300000
         BNZ   ERR_TBSV           TERMINATING ERROR OTHERWISE           03310000
                                                                        03320000
         MVI   QCSTDROP,TRUE      AUTO DROP UPON CLOSE                  03330000
         DROP  CRSD               CREATE RESULT SET DEFINITION REQ/RESP 03340000
                                                                        03350000
*--------------------------------------------------------------         03360000
*   TERMINATE AT THIS POINT IF SQLPREPARE()                             03370000
*--------------------------------------------------------------         03380000
                                                                        03390000
         CLI   QCSCLI,QCSC_PRP    SQLPREPARE()?                         03400000
         BE    NORMRET            DONE IF SO                            03410000
                                                                        03420000
         EJECT                                                          03430000
***************************************************************         03440000
*                                                                       03450000
*   Request types 2 and 3 request TABLE_QUALIFIER and                   03460000
*   TABLE_OWNER only, repectively. Because this implementation          03470000
*   includes neither table qualifiers or owners, the result             03480000
*   set created (after a bit of grinding) will always be                03490000
*   empty. So, we simply bypass all of that unproductive work           03500000
*   with a fast exitd here if applicable.                               03510000
*                                                                       03520000
***************************************************************         03530000
                                                                        03540000
         CLC   REQVIEW,=A(REQ_QUAL)                                     03550000
         BE    NORMRET                                                  03560000
                                                                        03570000
         CLC   REQVIEW,=A(REQ_OWNR)                                     03580000
         BE    NORMRET                                                  03590000
                                                                        03600000
***************************************************************         03610000
*                                                                       03620000
*   Identify columns that accept nulls included in result set.          03630000
*   Some columns have no local interpretation and are set               03640000
*   null for the life of this function.                                 03650000
*                                                                       03660000
***************************************************************         03670000
                                                                        03680000
         TBCOLUMN BYNAME,         IDENTIFY COLUMNS BY NAME             X03690000
               (('TABLE_QUALIFIER',STATQUAL),                          X03700000
               ('TABLE_OWNER',STAOWNER),                               X03710000
               ('TABLE_NAME',STANAME),                                 X03720000
               ('TABLE_TYPE',STATYPE),                                 X03730000
               ('REMARKS',STAREMRK)),                                  X03740000
               TTOKEN=QCSTTOKN,                                        X03750000
               MF=(E,WK256)                                             03760000
                                                                        03770000
*--------------------------------------------------------------         03780000
*   NULL THOSE COLUMNS NOT POPULATED IN THIS IMPLEMENTATION             03790000
*--------------------------------------------------------------         03800000
                                                                        03810000
         SR    R2,R2              R2 <== COLUMN NUMBER                  03820000
         LA    R3,NULL_IND        R3 <== NULL INDICATOR MASK ORIGIN     03830000
                                                                        03840000
         ICM   R2,3,STATQUAL      TABLE_QUALIFIER COLUMN NUMBER         03850000
         BZ    *+8                                                      03860000
         BAS   R14,SETNULL                                              03870000
                                                                        03880000
         ICM   R2,3,STAOWNER      TABLE_OWNER COLUMN NUMBER             03890000
         BZ    *+8                                                      03900000
         BAS   R14,SETNULL                                              03910000
                                                                        03920000
*--------------------------------------------------------------         03930000
*   NULL THOSE COLUMNS SUPPRESSED BY REQUEST FORMAT                     03940000
*--------------------------------------------------------------         03950000
                                                                        03960000
         CLC   REQVIEW,=A(REQ_STD)   ALL COLUMNS REQUESTED?             03970000
         BE    FINREQ                                                   03980000
                                                                        03990000
         ICM   R2,3,STANAME       TABLE NAME PRESENT IN RESULT SET?     04000000
         BZ    *+8                SKIP IF NOT                           04010000
         BAS   R14,SETNULL        PERM NULL                             04020000
                                                                        04030000
         ICM   R2,3,STAREMRK      REMARKS PRESENT IN RESULT SET?        04040000
         BZ    *+8                SKIP IF NOT                           04050000
         BAS   R14,SETNULL        PERM NULL                             04060000
                                                                        04070000
         CLC   REQVIEW,=A(REQ_TYPE)                                     04080000
         BE    FINREQ                                                   04090000
                                                                        04100000
         ICM   R2,3,STATYPE       TABLE TYPE PRESENT IN RESULT SET?     04110000
         BZ    *+8                SKIP IF NOT                           04120000
         BAS   R14,SETNULL        PERM NULL                             04130000
                                                                        04140000
FINREQ   DS    0H                                                       04150000
                                                                        04160000
         EJECT                                                          04170000
***************************************************************         04180000
*                                                                       04190000
*   Complete the predicate tree.  TBPSARG is issued to complete         04200000
*   the saearch argument passed to this routine, if any, with           04210000
*   references to the result set table created above.  The              04220000
*   near-ready tree is passed in via QCSSITRE and the TBPSARGed         04230000
*   tree is generally returned via QCSSATRE when it will be             04240000
*   used as a true TBGET search argument.  However, because we          04250000
*   will use it instead as a TBADD filter we leave QCSSATRE             04260000
*   null - all of the result set trimming will be accomplished          04270000
*   up front at TBADD time.                                             04280000
*                                                                       04290000
***************************************************************         04300000
                                                                        04310000
         ICM   R2,15,QCSSITRE     SEARCH ARGUMENT TREE PROVIDED?        04320000
         BZ    SARG_FIN           NO FURTHER PROCESSING IF NOT          04330000
                                                                        04340000
         TBPSARG TTOKEN=QCSTTOKN, CONVERT TO TABLE SERVICES EXEC FORM  X04350000
               SARGS=(R2),                                             X04360000
               XSTGMGR=(IGENCSTG,QCSGPSTG,WK256),                      X04370000
               MF=(E,MFE_LIST)                                          04380000
                                                                        04390000
         ST    R15,QCSPSARC       POST TBPSARG RETCODE                  04400000
         ST    R0,QCSPSARS        POST TBPSARG RSNCODE                  04410000
         LTR   R15,R15            NORMAL COMPLETION?                    04420000
         BNZ   ERR_ANAL           QCS ANALYSIS REQUIRED IF NOT          04430000
                                                                        04440000
         CLM   R0,1,=AL1(TRUE)    SEARCH ARG IS CATEGORICALLY TRUE?     04450000
         BNE   *+10               SKIP IF NOT                           04460000
         XC    QCSSITRE,QCSSITRE  SEARCH ARGUMENT / FILTER WITHDRAWN    04470000
                                                                        04480000
SARG_FIN DS    0H                                                       04490000
                                                                        04500000
         EJECT                                                          04510000
***************************************************************         04520000
*                                                                       04530000
*   CATALOG SCAN                                                        04540000
*                                                                       04550000
*   Acquire a description of the catalog tables residing in             04560000
*   the selected object space via repeated calls to ICAT$SCN,           04570000
*   retrieving one catalog component table per call. If EOT             04580000
*   is returned on the first call, we assume that SYSDICTIONARY         04590000
*   does not exist in the target space, and therefore no                04600000
*   formal catalog structure is in use.                                 04610000
*                                                                       04620000
*   Although SYSDICTIONARY drives the catalog formatting                04630000
*   process, no information is extracted from those entries             04640000
*   at this time.                                                       04650000
*                                                                       04660000
***************************************************************         04670000
                                                                        04680000
CCATSCAN DS    0H                                                       04690000
         @CALL ICAT$SCN,(*QCSTSPAC,$SCNCKPT,$DDEROW),                  X04700000
               CTYPE=CVT,                                              X04710000
               MF=(E,MFE_LIST)                                          04720000
                                                                        04730000
         CH    R15,=AL2(RC04)     CATALOG TABLE DESCRIPTORS RETURNED?   04740000
         BE    CCATEOT            END OF TABLE                          04750000
         BH    ERR_CSCN           TERMINATING ERROR WHILE SCANNING CAT  04760000
                                                                        04770000
         ST    R0,@OSC            RETAIN OBJECT SPACE CONTENT BLOCK PTR 04780000
         LTR   R9,R1              SPACE COMPONENT TABLE DEFINITION      04790000
         BZ    CCATSCAN           UNANTICIPATED SPACE CONFIGURATION     04800000
         USING SCTDEF,R9                                                04810000
                                                                        04820000
*--------------------------------------------------------------         04830000
*   LOAD STATIC TABLE INFORMATION INTO SYSVCAT_ODBC_TABS ROW            04840000
*--------------------------------------------------------------         04850000
                                                                        04860000
D        USING DDENTRY,$DDEROW    SYSDICTIONARY ROW                     04870000
                                                                        04880000
         LA    R0,VCHARBUF        VARDATA COLLECTION AREA               04890000
         ST    R0,VCHAR@          ENTIRE AREA AVAILABLE FOR USE         04900000
         LA    R0,L'VCHARBUF      VARDATA COLLECTION AREA LENGTH        04910000
         ST    R0,VCHAR#          INITAL AMOUNT AVAILABLE FOR USE       04920000
                                                                        04930000
         $VARTRMC SCT_TABLE_NAME,VCHAR@,VCHAR#                          04940000
                                                                        04950000
         BZ    *+8                                                      04960000
         EX    R0,*               ASSERT SPACE AVAILABLE                04970000
         ST    R1,C.ODBTAB_TABLE_NAME                                   04980000
                                                                        04990000
*--------------------------------------------------------------         05000000
*   TABLE TYPE AND REMARKS                                              05010000
*--------------------------------------------------------------         05020000
                                                                        05030000
         LA    R2,TYPE_SYSTEM_TABLE                                     05040000
         LA    R3,REMARK_CATALOG                                        05050000
         CLC   =C'SYS',SCT_TABLE_NAME                                   05060000
         BE    TAB_SET                                                  05070000
                                                                        05080000
         LA    R2,TYPE_TEMPORARY                                        05090000
         LA    R3,REMARK_CATALOG                                        05100000
                                                                        05110000
TAB_SET  DS    0H                                                       05120000
         ST    R2,C.ODBTAB_TABLE_TYPE                                   05130000
         ST    R3,C.ODBTAB_REMARKS                                      05140000
                                                                        05150000
*--------------------------------------------------------------         05160000
*   ADD THE COMPLETED ROW TO THE RESULT SET                             05170000
*--------------------------------------------------------------         05180000
                                                                        05190000
         TBADD C.ODBTABS,         INSERT ROW IN RESULT SET             X05200000
               TTOKEN=QCSTTOKN,                                        X05210000
               FILTER=*QCSSITRE,  SEARCH ARGUMENT AS FILTER            X05220000
               NULLMASK=NULL_IND, NULL INDICATORS                      X05230000
               MF=(E,MFE_LIST)                                          05240000
                                                                        05250000
         CH    R15,=AL2(RC08)     ADDED OR SUPPRESSED PER REQUEST?      05260000
         BH    ERR_TBSV           ERROR OTHERWISE                       05270000
         B     CCATSCAN           NEXT TABLE                            05280000
                                                                        05290000
CCATEOT  DS    0H                 CATALOG SWEEP COMPLETED               05300000
         DROP  D,R9               DDENTRY, SCTDEF                       05310000
                                                                        05320000
         EJECT                                                          05330000
***************************************************************         05340000
*                                                                       05350000
*   VDB TABLE SCAN                                                      05360000
*                                                                       05370000
*   If the current object space is a "project" space, SYSTABLES         05380000
*   contains the name of each VDB table defined in it.                  05390000
*                                                                       05400000
***************************************************************         05410000
                                                                        05420000
         L     R15,@OSC           RESTORE OBJECT SPACE CONTENT DESC     05430000
         USING OSC,R15            TRANSIENT ADDRESSABILITY              05440000
         CLI   OSCSTYPE,SPACE_TYPE_PRJ   PROJECT SPACE?                 05450000
         BNE   VTABFIN            DONE IF NOT                           05460000
         DROP  R15                OSC                                   05470000
                                                                        05480000
*--------------------------------------------------------------         05490000
*   DETERMINE IF SYSTABLES EXISTS IN THIS PROJECT                       05500000
*--------------------------------------------------------------         05510000
                                                                        05520000
         TBOPEN 'SYSTABLES',                                           X05530000
               STOKEN=*QCSTSPAC,                                       X05540000
               TTOKEN=SYSTABTK,                                        X05550000
               MF=(E,MFE_LIST)                                          05560000
                                                                        05570000
         LTR   R15,R15            NORMAL COMPLETION                     05580000
         BNZ   VTABFIN            ASSUME STD (MORE OR LESS) UNAVAILABLE 05590000
                                                                        05600000
*--------------------------------------------------------------         05610000
*   ACQUIRE NAME OF NEXT VDB TABLE DEFINED IN THIS PROJECT              05620000
*--------------------------------------------------------------         05630000
                                                                        05640000
VTABNEXT DS    0H                 ACQUIRE VDB TABLE SUMMARY ENTRY       05650000
         TBGET $SYSTAB,L'$SYSTAB,                                      X05660000
               POS=NEXT,                                               X05670000
               TTOKEN=SYSTABTK,                                        X05680000
               MF=(E,MFE_LIST)                                          05690000
                                                                        05700000
         CH    R15,=AL2(RC04)     ANALYZE COMPLETION STATUS             05710000
         BE    VTABEOT            END OF TABLE / DEFICIENT BUFFER       05720000
         BH    ERR_TBSV           TABLE SERVICES ERROR                  05730000
                                                                        05740000
TAB      USING SYSTABLE,$SYSTAB                                         05750000
                                                                        05760000
*--------------------------------------------------------------         05770000
*   INIT VARDATA COLLECTION BUFFER, POST STATIC TABLE INFO              05780000
*--------------------------------------------------------------         05790000
                                                                        05800000
         LA    R0,VCHARBUF        VARDATA COLLECTION AREA               05810000
         ST    R0,VCHAR@          ENTIRE AREA AVAILABLE FOR USE         05820000
         LA    R0,L'VCHARBUF      VARDATA COLLECTION AREA LENGTH        05830000
         ST    R0,VCHAR#          INITAL AMOUNT AVAILABLE FOR USE       05840000
                                                                        05850000
         $VARTRMC TAB.STBLNAME,VCHAR@,VCHAR#                            05860000
                                                                        05870000
         BZ    *+8                                                      05880000
         EX    R0,*               ASSERT SPACE AVAILABLE                05890000
         ST    R1,C.ODBTAB_TABLE_NAME                                   05900000
         DROP  TAB                SYSTABLE ROW                          05910000
                                                                        05920000
*--------------------------------------------------------------         05930000
*   PROCESS VDB COLUMNS                                                 05940000
*--------------------------------------------------------------         05950000
                                                                        05960000
         LA    R2,TYPE_TABLE                                            05970000
         ST    R2,C.ODBTAB_TABLE_TYPE                                   05980000
         LA    R3,REMARK_VDB                                            05990000
         ST    R3,C.ODBTAB_REMARKS                                      06000000
                                                                        06010000
*--------------------------------------------------------------         06020000
*   ADD THE COMPLETED ROW TO THE RESULT SET                             06030000
*--------------------------------------------------------------         06040000
                                                                        06050000
         TBADD C.ODBTABS,         INSERT ROW IN RESULT SET             X06060000
               TTOKEN=QCSTTOKN,                                        X06070000
               FILTER=*QCSSITRE,  SEARCH ARGUMENT AS FILTER            X06080000
               NULLMASK=NULL_IND, NULL INDICATORS                      X06090000
               MF=(E,MFE_LIST)                                          06100000
                                                                        06110000
         CH    R15,=AL2(RC08)     ADDED OR SUPPRESSED PER REQUEST?      06120000
         BH    ERR_TBSV           ERROR OTHERWISE                       06130000
         B     VTABNEXT           IDENTIFY NEXT VDB TABLE               06140000
                                                                        06150000
*--------------------------------------------------------------         06160000
*   VDB SCAN COMPLETE, CLOSE SYSTABLES                                  06170000
*--------------------------------------------------------------         06180000
                                                                        06190000
VTABEOT  DS    0H                                                       06200000
         TBCLOSE TTOKEN=SYSTABTK,                                      X06210000
               MF=(E,MFE_LIST)                                          06220000
                                                                        06230000
VTABFIN  DS    0H                                                       06240000
                                                                        06250000
         EJECT                                                          06260000
***************************************************************         06270000
*                                                                       06280000
*   RETURN RESULT SET AND/OR COMPLETION STATUS TO REQUESTER             06290000
*                                                                       06300000
***************************************************************         06310000
                                                                        06320000
NORMRET  DS    0H                 FORMAT DATA FOR RETURN                06330000
         MVC   QCSTSPAC,ICTXSPT@  RETURN EXECUTION SPACE TOKEN          06340000
         B     RETURN             DONE                                  06350000
                                                                        06360000
*--------------------------------------------------------------         06370000
*   REFERENCE TO UNDEFINED COLUMN                                       06380000
*--------------------------------------------------------------         06390000
                                                                        06400000
ERR_CREF DS    0H                 INVALID COLUMN REFERENCE              06410000
CREF     USING SQCOLREF,R1        COLUMN OCCURRENCE                     06420000
         MVC   QCSECLEX,CREF.SQCOL@C   #CLEX ADDRESS                    06430000
                                                                        06440000
         SQLSTAT ERC_CREF                                               06450000
                                                                        06460000
         B     RETURN                                                   06470000
         DROP  CREF               SQCOLREF                              06480000
                                                                        06490000
*--------------------------------------------------------------         06500000
*   ORDER BY CLAUSE ERROR                                               06510000
*--------------------------------------------------------------         06520000
                                                                        06530000
ERR_ORD  DS    0H                 ERROR IN 'ORDER BY' CLAUSE            06540000
         LR    R2,R1              SUPPLEMENTAL MESSAGE                  06550000
                                                                        06560000
         SQLSTAT ERC_ORD,INFO=(R15)                                     06570000
                                                                        06580000
         SQLMSG 170,(R2)                                                06590000
                                                                        06600000
         B     RETURN                                                   06610000
                                                                        06620000
*--------------------------------------------------------------         06630000
*   DISTINCT KEYDEF BUILD ERROR                                         06640000
*--------------------------------------------------------------         06650000
                                                                        06660000
ERR_DIST DS    0H                 ERROR BUILDING INDEX serving DISTINCT 06670000
         SQLSTAT ERC_DIST,INFO=(R15)                                    06680000
                                                                        06690000
         B     RETURN                                                   06700000
                                                                        06710000
*--------------------------------------------------------------         06720000
*   RESULT SET DEFINITION - CONSTRUCTION ERROR                          06730000
*--------------------------------------------------------------         06740000
                                                                        06750000
ERR_RSD  DS    0H                 ERROR CONSTRUCTING RSD                06760000
         SQLSTAT ERC_RSD,INFO=(R15)                                     06770000
                                                                        06780000
         B     RETURN                                                   06790000
                                                                        06800000
*--------------------------------------------------------------         06810000
*   INVALID TABLE NAME                                                  06820000
*--------------------------------------------------------------         06830000
                                                                        06840000
ERR_CTAB DS    0H                 TABLE NAME SUFFIX IS INVALID          06850000
         SQLSTAT ERC_CTAB                                               06860000
                                                                        06870000
         B     RETURN                                                   06880000
                                                                        06890000
*--------------------------------------------------------------         06900000
*   CATALOG SCAN FAILURE                                                06910000
*--------------------------------------------------------------         06920000
                                                                        06930000
ERR_CSCN DS    0H                                                       06940000
         SQLIDCMP COMPONENT='CATALOG SCAN'                              06950000
                                                                        06960000
         SQLSTAT ERC_CSCN,INFO=(R15)                                    06970000
                                                                        06980000
         B     RETURN                                                   06990000
                                                                        07000000
*--------------------------------------------------------------         07010000
*   TABLE SERVICE FAILURE                                               07020000
*--------------------------------------------------------------         07030000
                                                                        07040000
ERR_TBSV DS    0H                                                       07050000
         SQLIDCMP COMPONENT='TABLE SERVICES'                            07060000
                                                                        07070000
         SQLSTAT ERC_TBSV,INFO=(R15)                                    07080000
                                                                        07090000
         B     RETURN                                                   07100000
                                                                        07110000
*--------------------------------------------------------------         07120000
*   SERVICE FAILURE, QCS ANALYSIS REQUIRED FOR DETAIL                   07130000
*--------------------------------------------------------------         07140000
                                                                        07150000
ERR_ANAL DS    0H                 QCS ANALYSIS REQUIRED                 07160000
         SQLSTAT ERC_ANALYZE                                            07170000
                                                                        07180000
         B     RETURN                                                   07190000
                                                                        07200000
*--------------------------------------------------------------         07210000
*   RETURN                                                              07220000
*--------------------------------------------------------------         07230000
                                                                        07240000
RETURN   DS    0H                                                       07250000
                                                                        07260000
         #EXIT ,                                                        07270000
                                                                        07280000
         EJECT                                                          07290000
***************************************************************         07300000
*                                                                       07310000
*   CATASTROPHIC FAILURES, PROGRAMMING ERRORS, ETC.                     07320000
*                                                                       07330000
***************************************************************         07340000
                                                                        07350000
ABN_FAIL $ABEND ABE_ENV,DUMP=YES,                                      X07360000
               TITLE='RESULT SET DEFINITION - GENERATION ERROR'         07370000
                                                                        07380000
                                                                        07390000
         EJECT                                                          07400000
***************************************************************         07410000
*                                                                       07420000
* ROUTINE: SETNULL - SET NULL MASK BIT FOR GIVEN COLUMN                 07430000
*                                                                       07440000
* ON ENTRY:                                                             07450000
*                                                                       07460000
*    R3 - MASK ORIGIN                                                   07470000
*    R2 - COLUMN NUMBER (1 TO N)                                        07480000
*                                                                       07490000
***************************************************************         07500000
                                                                        07510000
SETNULL  DS    0H                                                       07520000
         ST    R14,FWORD          PRESERVE RETURN ADDRESS               07530000
                                                                        07540000
         SETBIT (R3),(R2)                                               07550000
                                                                        07560000
         L     R14,FWORD          RESTORE RETURN ADDRESS                07570000
         BR    R14                RETURN                                07580000
                                                                        07590000
         EJECT                                                          07600000
***************************************************************         07610000
*                                                                       07620000
*   LOCAL READ-ONLY WORKING STORAGE                                     07630000
*                                                                       07640000
***************************************************************         07650000
                                                                        07660000
TYPE_TABLE         DCVAR 'TABLE'                                        07670000
TYPE_SYSTEM_TABLE  DCVAR 'SYSTEM TABLE'                                 07680000
TYPE_TEMPORARY     DCVAR 'LOCAL TEMPORARY'                              07690000
                                                                        07700000
REMARK_CATALOG     DCVAR 'CATALOG'                                      07710000
REMARK_VDB         DCVAR 'VDB'                                          07720000
                                                                        07730000
*--------------------------------------------------------------         07740000
*   LITERALS, ETC.                                                      07750000
*--------------------------------------------------------------         07760000
                                                                        07770000
         LTORG ,                                                        07780000
                                                                        07790000
         EJECT                                                          07800000
         SQLCODES ,                                                     07810000
                                                                        07820000
         EJECT                                                          07830000
         PRINT NOGEN                                                    07840000
         ICVT ,              ICVT                                       07850000
         ITASK ,             ITASK                                      07860000
         END   ,                                                        07870000

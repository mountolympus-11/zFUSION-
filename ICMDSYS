ICMDSYS  TITLE 'INTEGRATOR - SYSTEMS COMMAND PROCESSOR'                 00010000
                                                                        00020000
**<DOC-ON>************************************************************* 00030000
*                                                                       00040000
*     ROUTINE: ICMDSYS - INTEGRATOR SYSTEMS COMMAND PROCESSOR           00050000
*                                                                       00060000
* DESCRIPTION: THIS ROUTINE PROCESSES THE VARIOUS FORMS OF THE SYSTEMS  00070000
*              COMMAND WHICH IS USED TO CONTROL THE SESSION CONNECTION  00080000
*              WITH A REMOTE INTEGRATOR.                                00090000
*                                                                       00100000
*      SYNTAX: SYSTEMS DEFINE  APPLID() SMFID() DESC()                  00110000
*              SYSTEMS DELETE  APPLID()                                 00120000
*              SYSTEMS DISPLAY <APPLID()>                               00130000
*              SYSTEMS START   APPLID()                                 00140000
*              SYSTEMS STOP    APPLID()                                 00150000
*              SYSTEMS DRAIN   APPLID()                                 00160000
*              SYSTEMS TEST    APPLID()                                 00170000
*              SYSTEMS IMPORT  APPLID() PROJECT() <AS()> <REPLACE>      00180000
*              SYSTEMS EXPORT  APPLID() PROJECT() <AS()> <REPLACE>      00190000
*                                                                       00200000
* ON ENTRY:                                                             00210000
*                                                                       00220000
*    R15 = ENTRY POINT ADDRESS                                          00230000
*    R14 = RETURN      ADDRESS                                          00240000
*    R13 = SAVE AREA   ADDRESS                                          00250000
*    R11 = ICVT        ADDRESS                                          00260000
*    R10 = ITASK       ADDRESS                                          00270000
*    R01 = CMDEQ       ADDRESS                                          00280000
*                                                                       00290000
* ON EXIT:                                                              00300000
*                                                                       00310000
*    R15 = 0                                                            00320000
*    R00 = 0                                                            00330000
*    R01 = 0                                                            00340000
*                                                                       00350000
*    ALL OTHER REGISTERS ARE RESTORED.                                  00360000
*                                                                       00370000
**<DOC-OFF>************************************************************ 00380000
                                                                        00390000
*********************************************************************** 00400000
*                                                                       00410000
* MAINTENANCE:                                                          00420000
*                                                                       00430000
*   12/31/93 RANDY WITEK                                                00440000
*                                                                       00450000
*********************************************************************** 00460000
                                                                        00470000
         EQUS  ,                  GENERAL EQUATES                       00480000
                                                                        00490000
RICVT    EQU   R11                                                      00500000
RITASK   EQU   R10                                                      00510000
RIVTAM   EQU   R9                                                       00520000
RCMDREQ  EQU   R8                                                       00530000
RCCSUMRY EQU   R7                                                       00540000
RISY     EQU   R6                                                       00550000
RPTR     EQU   R5                                                       00560000
                                                                        00570000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00580000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00590000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00600000
         USING CMDREQ,RCMDREQ     ESTABLISH ADDRESSABILITY              00610000
         USING CCSUMRY,RCCSUMRY   ESTABLISH ADDRESSIBILITY              00620000
         USING ISY,RISY           ESTABLISH ADDRESSIBILITY              00630000
                                                                        00640000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00650000
WRK256   DS    XL256              GENERAL WORKAREA                      00660000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00670000
                                                                        00680000
KMDNAME  DS    CL8                REQUEST NAME                          00690000
KMDSTAT  DS    CL8                COMMAND COMPLETION STATUS             00700000
KMDRSN   DS    CL32               COMMAND FAILURE REASON                00710000
                                                                        00720000
KMDREQ   DS    XL(L'CCSID)        REQUEST CODE                          00730000
KMDAPPID DS    CL(L'ISYAPPID)     APPLID NAME                           00740000
KMDSMFID DS    CL(L'ISYSMFID)     SYSTEM SMFID                          00750000
KMDDESC  DS    CL(L'ISYDESC)      DESCRIPTION                           00760000
KMDPROJ  DS    CL(L'PTREXPRJ)     PROJECT                               00770000
KMDASPJ  DS    CL(L'PTREXPRJ)     AS PROJECT NAME                       00780000
KMDREPL  DS    CL1                REPLACE IF IT EXISTS                  00790000
                                                                        00800000
DEQNOTE  DS    CL8                "ENDED   " OR "ABORTED "              00810000
DEQQTIME DS    XL11               F021207A20207A20204B2020 HH:MM:SS.TH  00820000
DEQSTIME DS    XL11               F021207A20207A20204B2020 HH:MM:SS.TH  00830000
DEQETIME DS    XL11               F021207A20207A20204B2020 HH:MM:SS.TH  00840000
DEQQDATE DS    XL8                40212020204B20202020     DDD.YYYY     00850000
DEQSDATE DS    XL8                40212020204B20202020     DDD.YYYY     00860000
DEQEDATE DS    XL8                40212020204B20202020     DDD.YYYY     00870000
                                                                        00880000
RETR15   DS    F                                                        00890000
RETR0    DS    F                                                        00900000
RETR1    DS    F                                                        00910000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00920000
                                                                        00930000
FLAGS    DS    X                                                        00940000
FLAGLOCK EQU   X'80'              VTAM GLOBAL LOCK HELD                 00950000
FLAGLCKD EQU   X'40'              VTAM GLOBAL LOCK HELD ON ENTRY        00960000
FLAGAPID EQU   X'20'              SPECIFIC APPLID SPECIFIED             00970000
FLAGREPL EQU   X'10'              REPLACE SPECIFIED                     00980000
WKPTR    DS    XL(L'PTRH)         PROJECT TRANSFER REQUEST              00990000
WORKLEN  #ENDWORK                 END OF WORKAREA                       01000000
                                                                        01010000
         $MSGDFT PREFIX=ICTPID,                                        +01020000
               COMPID='CMD',                                           +01030000
               TABLE=*#MSGS,                                           +01040000
               WORKA=0,                                                +01050000
               CONID=*CMRQCNID,CONNAME=CMRQCNAM,CART=CMRQCART,         +01060000
               DESTADD=*CMRQDMSK,                                      X01070000
               MSGQA=*CMRQMQA,STGQH=*CMRQSTGQ,                         +01080000
               MF=(E,WRK256),                                          +01090000
               PRINT=NOGEN                                              01100000
                                                                        01110000
ICMDSYS  #ENTER BASE=R12,                                              +01120000
               PREG=(RCMDREQ),     R1 --> RCMDREQ                      +01130000
               AMODE=31,                                               +01140000
               RMODE=ANY                                                01150000
                                                                        01160000
*--------------------------------------------------------------         01170000
* INITIALIZATION                                                        01180000
*--------------------------------------------------------------         01190000
                                                                        01200000
         MVC   KMDSTAT,=CL8'complete'                                   01210000
         MVC   KMDDESC,=CL32' '                                         01220000
         L     RIVTAM,ICTVTCVT      VTAM CVT                            01230000
         ICM   RCCSUMRY,15,CMRQSMRY ASSOC COMMAND SUMMARY               01240000
         BZ    PARSDONE             AMBIGUOUS REQUEST                   01250000
         ICM   R0,15,CMRQSMR#       TOTAL NUMBER OF OPERAND ENTRIES     01260000
         BZ    PARSDONE             AMBIGUOUS REQUEST IF ZERO           01270000
                                                                        01280000
*---------------------------------------------------------------------- 01290000
* IDENTIFY AND VALIDATE THE KEYWORDS AND VALUES THAT WERE SPECIFIED     01300000
*---------------------------------------------------------------------- 01310000
                                                                        01320000
PARSENXT DS    0H                                                       01330000
                                                                        01340000
         CLC   CCSID,=AL2(SYSTEMS_DEFINE)                               01350000
         BE    PARSREQ                  BRANCH IF DEFINE REQUEST        01360000
         CLC   CCSID,=AL2(SYSTEMS_DELETE)                               01370000
         BE    PARSREQ                  BRANCH IF DELETE REQUEST        01380000
         CLC   CCSID,=AL2(SYSTEMS_START)                                01390000
         BE    PARSREQ                  BRANCH IF START REQUEST         01400000
         CLC   CCSID,=AL2(SYSTEMS_STOP)                                 01410000
         BE    PARSREQ                  BRANCH IF STOP REQUEST          01420000
         CLC   CCSID,=AL2(SYSTEMS_DRAIN)                                01430000
         BE    PARSREQ                  BRANCH IF DRAIN REQUEST         01440000
         CLC   CCSID,=AL2(SYSTEMS_TEST)                                 01450000
         BE    PARSREQ                  BRANCH IF TEST REQUEST          01460000
         CLC   CCSID,=AL2(SYSTEMS_DISPLAY)                              01470000
         BE    PARSREQ                  BRANCH IF DISPLAY REQUEST       01480000
         CLC   CCSID,=AL2(SYSTEMS_IMPORT)                               01490000
         BE    PARSREQ                  BRANCH IF DISPLAY REQUEST       01500000
         CLC   CCSID,=AL2(SYSTEMS_EXPORT)                               01510000
         BE    PARSREQ                  BRANCH IF DISPLAY REQUEST       01520000
         CLC   CCSID,=AL2(SYSTEMS_APPLID)                               01530000
         BE    PARSAPPL                 BRANCH IF APPLID PARM           01540000
         CLC   CCSID,=AL2(SYSTEMS_SMFID)                                01550000
         BE    PARSMFID                 BRANCH IF SMFID PARM            01560000
         CLC   CCSID,=AL2(SYSTEMS_DESC)                                 01570000
         BE    PARSDESC                 BRANCH IF DESC PARM             01580000
         CLC   CCSID,=AL2(SYSTEMS_PROJECT)                              01590000
         BE    PARSPROJ                 BRANCH IF DESC PARM             01600000
         CLC   CCSID,=AL2(SYSTEMS_ASPROJ)                               01610000
         BE    PARSASPJ                 BRANCH IF DESC PARM             01620000
         CLC   CCSID,=AL2(SYSTEMS_REPLACE)                              01630000
         BE    PARSREPL                 BRANCH IF DESC PARM             01640000
                                                                        01650000
         B     ERREJECT                 REJECT OTHERWISE                01660000
                                                                        01670000
*                                                                       01680000
* A REQUEST KEYWORD WAS FOUND                                           01690000
*---------------------------------------------------------------------- 01700000
                                                                        01710000
PARSREQ  DS    0H                                                       01720000
                                                                        01730000
         OC    KMDREQ,KMDREQ         WAS A REQUEST KEYWORD ALREADY HIT? 01740000
         BNZ   ERRCNFLC              BRANCH IF YES                      01750000
         MVC   KMDREQ(L'CCSID),CCSID SAVE THE REQUEST CODE              01760000
         B     PARSBUMP              ADVANCE TO NEXT OPERAND            01770000
                                                                        01780000
*                                                                       01790000
* APPLID(AAA...) KEYWORD WAS SPECIFIED                                  01800000
*---------------------------------------------------------------------- 01810000
                                                                        01820000
PARSAPPL DS    0H                                                       01830000
                                                                        01840000
         LA    R2,KMDAPPID           MVCL COPY-TO ADDRESS               01850000
         LA    R3,L'ISYAPPID         MVCL COPY-TO LENGTH                01860000
         OC    KMDAPPID,KMDAPPID     ALREADY SPECIFIED?                 01870000
         BNZ   ERRCNFLC              BRANCH IF YES                      01880000
         OI    FLAGS,FLAGAPID        SPECIFIC APPLID NAME PROVIDED      01890000
         B     PARSCOMM              GO COPY PARM TO LOCAL STORAGE      01900000
                                                                        01910000
*                                                                       01920000
* SMFID(AAA...) KEYWORD WAS SPECIFIED                                   01930000
*---------------------------------------------------------------------- 01940000
                                                                        01950000
PARSMFID DS    0H                                                       01960000
                                                                        01970000
         LA    R2,KMDSMFID           MVCL COPY-TO ADDRESS               01980000
         LA    R3,L'ISYSMFID         MVCL COPY-TO LENGTH                01990000
         OC    KMDSMFID,KMDSMFID     ALREADY SPECIFIED?                 02000000
         BNZ   ERRCNFLC              BRANCH IF YES                      02010000
         B     PARSCOMM              GO COPY PARM TO LOCAL STORAGE      02020000
                                                                        02030000
*                                                                       02040000
* DESC(AAA...) KEYWORD WAS SPECIFIED                                    02050000
*---------------------------------------------------------------------- 02060000
                                                                        02070000
PARSDESC DS    0H                                                       02080000
                                                                        02090000
         LA    R2,KMDDESC            MVCL COPY-TO ADDRESS               02100000
         LA    R3,L'ISYDESC          MVCL COPY-TO LENGTH                02110000
         CLC   KMDDESC,=CL32' '      WAS DESCRIPTION ALREADY GIVEN?     02120000
         BNE   ERRCNFLC              BRANCH IF YES                      02130000
         B     PARSCOMM              GO COPY PARM TO LOCAL STORAGE      02140000
                                                                        02150000
*                                                                       02160000
* PROJECT(AAA...) KEYWORD WAS SPECIFIED                                 02170000
*---------------------------------------------------------------------- 02180000
                                                                        02190000
PARSPROJ DS    0H                                                       02200000
                                                                        02210000
         LA    R2,KMDPROJ            MVCL COPY-TO ADDRESS               02220000
         LA    R3,L'PTREXPRJ         MVCL COPY-TO LENGTH                02230000
         OC    KMDPROJ,KMDPROJ       WAS PROJECT ALREADY GIVEN?         02240000
         BNE   ERRCNFLC              BRANCH IF YES                      02250000
         B     PARSCOMM              GO COPY PARM TO LOCAL STORAGE      02260000
                                                                        02270000
*                                                                       02280000
* AS(AAA...) KEYWORD WAS SPECIFIED                                      02290000
*---------------------------------------------------------------------- 02300000
                                                                        02310000
PARSASPJ DS    0H                                                       02320000
                                                                        02330000
         LA    R2,KMDASPJ            MVCL COPY-TO ADDRESS               02340000
         LA    R3,L'PTREXPRJ         MVCL COPY-TO LENGTH                02350000
         OC    KMDASPJ,KMDASPJ       WAS PROJECT ALREADY GIVEN?         02360000
         BNE   ERRCNFLC              BRANCH IF YES                      02370000
         B     PARSCOMM              GO COPY PARM TO LOCAL STORAGE      02380000
                                                                        02390000
*                                                                       02400000
* REPLACE KEYWORD WAS SPECIFIED                                         02410000
*---------------------------------------------------------------------- 02420000
                                                                        02430000
PARSREPL DS    0H                                                       02440000
                                                                        02450000
         OI    FLAGS,FLAGREPL        REPLACE SPECFIED                   02460000
         B     PARSBUMP              CONTINUE ON WITH THE PARSE         02470000
                                                                        02480000
PARSCOMM DS    0H                                                       02490000
                                                                        02500000
         CLC   CCSVALCT,=H'1'        SINGLE VALUE SPECIFIED?            02510000
         BNE   ERRSYNTX              BRANCH IF NOT                      02520000
         LH    R15,CCSVLEN           LENGTH OF SPECIFIED APPLID         02530000
         LTR   R15,R15               IS THE LENGTH OK?                  02540000
         BNP   ERRSYNTX              BRANCH IF NOT                      02550000
         CR    R15,R3                IS THE LENGTH OK?                  02560000
         BH    ERRSYNTX              BRANCH IF NOT                      02570000
         L     R14,CCSVDISP          OFFSET TO PARM IN CMD LINE         02580000
         A     R14,CMRQOPST          CONVERT OFFSET TO ADDRESS          02590000
         ICM   R15,8,=C' '           MVCL PAD BYTE                      02600000
         MVCL  R2,R14                COPY PARM                          02610000
         B     PARSBUMP              CONTINUE ON WITH THE PARSE         02620000
                                                                        02630000
*                                                                       02640000
* ADVANCE THE SCAN TO THE NEXT KEYWORD ENTRY IN THE SUMMARY             02650000
*---------------------------------------------------------------------- 02660000
                                                                        02670000
PARSBUMP DS    0H                                                       02680000
                                                                        02690000
         LA    R15,CCSVSLN                    LENGTH OF VALUE ENTRY     02700000
         MH    R15,CCSVALCT                   TIMES NUMBER OF ENTRIES   02710000
         LA    RCCSUMRY,CCSPFXL(R15,RCCSUMRY) ADDRESS OF NEXT KEYWORD   02720000
         BCT   R0,PARSENXT                    BRANCH IF MORE KEYWORDS   02730000
                                                                        02740000
PARSDONE DS    0H                                                       02750000
                                                                        02760000
*---------------------------------------------------------------------- 02770000
* COMMAND WAS PARSED.  JUMP TO THE SPECIFIC REQUEST ROUTINE.            02780000
*---------------------------------------------------------------------- 02790000
                                                                        02800000
         SR    R1,R1              CLEAR                                 02810000
         ICM   R1,3,KMDREQ        GET THE REQUEST ID                    02820000
         BNP   ERRSYNTX           BRANCH IF NO REQUEST KEYWORD          02830000
         BCTR  R1,0               NORMALIZE                             02840000
         C     R1,=A(RQMAX)       IS REQUEST ID VALID?                  02850000
         BH    ERRSYNTX           BRANCH IF NOT                         02860000
         SLL   R1,2               MULTIPLY BY 4                         02870000
         B     RQJUMP(R1)         JUMP TO ROUTINE                       02880000
                                                                        02890000
RQJUMP   B     RQDEFINE           1=DEFINE                              02900000
         B     RQDELETE           2=DELETE                              02910000
         B     RQSTART            3=START                               02920000
         B     RQSTOP             4=STOP                                02930000
         B     RQDISPLY           5=DISPLAY                             02940000
         B     RQDRAIN            6=DRAIN                               02950000
         B     RQTEST             7=TEST                                02960000
         B     RQIMPORT           8=IMPORT                              02970000
         B     RQEXPORT           9=EXPORT                              02980000
RQMAX    EQU   ((*-RQJUMP)/4)-1                                         02990000
                                                                        03000000
*---------------------------------------------------------------------- 03010000
* REQUEST = DEFINE                                                      03020000
*---------------------------------------------------------------------- 03030000
                                                                        03040000
RQDEFINE DS    0H                                                       03050000
                                                                        03060000
         OC    KMDAPPID,KMDAPPID  APPLID= SPECIFIED?                    03070000
         BZ    ERRSYNTX           BRANCH IF NOT                         03080000
         OC    KMDSMFID,KMDSMFID  SMFID= SPECIFIED?                     03090000
         BZ    ERRSYNTX           BRANCH IF NOT                         03100000
         MVC   KMDNAME,=CL8'define'                                     03110000
                                                                        03120000
         $SYSTEMS DEFINE,                                              +03130000
               APPLID=KMDAPPID,                                        +03140000
               SMFID=KMDSMFID,                                         +03150000
               DESC=KMDDESC,                                           +03160000
               ERRET=ERR$SYST,                                         +03170000
               MF=(E,MFE_LIST)                                          03180000
                                                                        03190000
         B     RETURNOK                                                 03200000
                                                                        03210000
*---------------------------------------------------------------------- 03220000
* REQUEST = DELETE                                                      03230000
*---------------------------------------------------------------------- 03240000
                                                                        03250000
RQDELETE DS    0H                                                       03260000
                                                                        03270000
         OC    KMDAPPID,KMDAPPID  APPLID= SPECIFIED?                    03280000
         BZ    ERRSYNTX           BRANCH IF NOT                         03290000
         MVC   KMDNAME,=CL8'delete'                                     03300000
                                                                        03310000
         $SYSTEMS DELETE,                                              +03320000
               APPLID=KMDAPPID,                                        +03330000
               ERRET=ERR$SYST,                                         +03340000
               MF=(E,MFE_LIST)                                          03350000
                                                                        03360000
         B     RETURNOK                                                 03370000
                                                                        03380000
*---------------------------------------------------------------------- 03390000
* REQUEST = START                                                       03400000
*---------------------------------------------------------------------- 03410000
                                                                        03420000
RQSTART  DS    0H                                                       03430000
                                                                        03440000
         OC    KMDAPPID,KMDAPPID  APPLID= SPECIFIED?                    03450000
         BZ    ERRSYNTX           BRANCH IF NOT                         03460000
         MVC   KMDNAME,=CL8'start'                                      03470000
                                                                        03480000
         $SYSTEMS START,                                               +03490000
               APPLID=KMDAPPID,                                        +03500000
               ERRET=ERR$SYST,                                         +03510000
               MF=(E,MFE_LIST)                                          03520000
                                                                        03530000
         B     RETURNOK                                                 03540000
                                                                        03550000
*---------------------------------------------------------------------- 03560000
* REQUEST = STOP                                                        03570000
*---------------------------------------------------------------------- 03580000
                                                                        03590000
RQSTOP   DS    0H                                                       03600000
                                                                        03610000
         OC    KMDAPPID,KMDAPPID  APPLID= SPECIFIED?                    03620000
         BZ    ERRSYNTX           BRANCH IF NOT                         03630000
         MVC   KMDNAME,=CL8'stop'                                       03640000
                                                                        03650000
         $SYSTEMS STOP,                                                +03660000
               APPLID=KMDAPPID,                                        +03670000
               ERRET=ERR$SYST,                                         +03680000
               MF=(E,MFE_LIST)                                          03690000
                                                                        03700000
         B     RETURNOK                                                 03710000
                                                                        03720000
*---------------------------------------------------------------------- 03730000
* REQUEST = DRAIN                                                       03740000
*---------------------------------------------------------------------- 03750000
                                                                        03760000
RQDRAIN  DS    0H                                                       03770000
                                                                        03780000
         OC    KMDAPPID,KMDAPPID  APPLID= SPECIFIED?                    03790000
         BZ    ERRSYNTX           BRANCH IF NOT                         03800000
         MVC   KMDNAME,=CL8'drain'                                      03810000
                                                                        03820000
         $SYSTEMS DRAIN,                                               +03830000
               APPLID=KMDAPPID,                                        +03840000
               ERRET=ERR$SYST,                                         +03850000
               MF=(E,MFE_LIST)                                          03860000
                                                                        03870000
         B     RETURNOK                                                 03880000
                                                                        03890000
*---------------------------------------------------------------------- 03900000
* REQUEST = TEST                                                        03910000
*---------------------------------------------------------------------- 03920000
                                                                        03930000
RQTEST   DS    0H                                                       03940000
                                                                        03950000
         OC    KMDAPPID,KMDAPPID  APPLID= SPECIFIED?                    03960000
         BZ    ERRSYNTX           BRANCH IF NOT                         03970000
         MVC   KMDNAME,=CL8'test'                                       03980000
                                                                        03990000
         $SYSTEMS QWORK,                                               +04000000
               APPLID=KMDAPPID,                                        +04010000
               WORKUNIT=TESTTRAN,                                      +04020000
               ERRET=ERR$SYST,                                         +04030000
               MF=(E,MFE_LIST)                                          04040000
                                                                        04050000
         B     RETURNOK                                                 04060000
                                                                        04070000
TESTTRAN DC    F'12',CL8'ITRNTEST'                                      04080000
                                                                        04090000
*---------------------------------------------------------------------- 04100000
* REQUEST = DISPLAY                                                     04110000
*---------------------------------------------------------------------- 04120000
                                                                        04130000
RQDISPLY DS    0H                                                       04140000
                                                                        04150000
         MVC   KMDNAME,=CL8'display'                                    04160000
                                                                        04170000
         BAS   R14,VTAMLOCK       SERIALIZE THE CHAIN OF ISYS BLOCKS    04180000
                                                                        04190000
         SR    R3,R3              COUNT OF SYSTEMS DISPLAYED            04200000
         LA    RISY,IVTSY1ST-(ISYNEXT-ISY)                              04210000
                                                                        04220000
RQDISPNX DS    0H                                                       04230000
                                                                        04240000
         ICM   RISY,15,ISYNEXT    ADDRESS OF NEXT ISYS BLOCK            04250000
         BM    RQDISPDN           BRANCH AT END OF CHAIN                04260000
         OC    KMDAPPID,KMDAPPID  SPECIFIC CONNECTION REQUESTED?        04270000
         BZ    RQDISPGO           BRANCH IF NOT                         04280000
         CLC   ISYAPPID,KMDAPPID  DO THE ID'S MATCH?                    04290000
         BNE   RQDISPNX           BRANCH IF NOT                         04300000
                                                                        04310000
RQDISPGO DS    0H                                                       04320000
                                                                        04330000
         $MSG  341,FIELDS=(KMDNAME,                                    +04340000
               ISYAPPID,                                               +04350000
               ISYSMFID,                                               +04360000
               ISYTKUSR,                                               +04370000
               ISYTKSES,                                               +04380000
               ISYFLAGS,                                               +04390000
               ISYDESC,                                                +04400000
               ISYITASK,                                               +04410000
               ISYTNAME,                                               +04420000
               ISYIPCB,                                                +04430000
               ISYPNAME)                                                04440000
                                                                        04450000
         $MSG  342,FIELDS=(ISYSMSG#,                                   +04460000
               ISYSBYT#,                                               +04470000
               ISYRMSG#,                                               +04480000
               ISYRBYT#)                                                04490000
                                                                        04500000
         LA    R3,1(,R3)          UPDATE COUNT OF SYSTEMS               04510000
                                                                        04520000
X        USING ITWA,R4                                                  04530000
Y        USING IQT,R2                                                   04540000
                                                                        04550000
         LA    R4,ISYPTWA         P-S ITWA                              04560000
         LA    R2,ISYSTWA         S-P ITWA                              04570000
         TM    ISYF1,ISYF1ORI     ARE WE THE SESSION ORIGINATOR?        04580000
         BO    RQDORI             BRANCH IF YES                         04590000
         LA    R2,ISYPTWA         P-S ITWA                              04600000
         LA    R4,ISYSTWA         S-P ITWA                              04610000
                                                                        04620000
RQDORI   DS    0H                                                       04630000
                                                                        04640000
         TM    X.ITWF1,ITWF1ACT   ACTIVE TRANSACTION?                   04650000
         BNO   RQDSPTRN           BRANCH IF NOT                         04660000
         LA    R0,0(,R4)          ITWA ADDRESS                          04670000
         BAS   R14,TRANDISP       DISPLAY IT                            04680000
                                                                        04690000
RQDSPTRN DS    0H                                                       04700000
                                                                        04710000
         LR    R4,R2              ITWA USED FOR TRANSACTION INITIATION  04720000
         TM    X.ITWF1,ITWF1ACT   ACTIVE TRANSACTION?                   04730000
         BNO   RQDSPQD            BRANCH IF NOT                         04740000
         LA    R0,0(,R4)          ITWA ADDRESS                          04750000
         BAS   R14,TRANDISP       DISPLAY IT                            04760000
                                                                        04770000
RQDSPQD  DS    0H                                                       04780000
                                                                        04790000
         LA    R2,ISYWQ1ST-(IQTNEXT-IQT) SET TO RUN QUEUED TRAN CHAIN   04800000
         ICM   R2,15,Y.IQTNEXT    GET FIRST IQT                         04810000
         BM    RQDISPNX           BRANCH IF NONE                        04820000
         TM    X.ITWF1,ITWF1ACT   ACTIVE TRANSACTION?                   04830000
         BNO   RQDSPIQT           BRANCH IF NOT, SHOW IT AS QUEUED      04840000
                                                                        04850000
RQDSPQLP DS    0H                                                       04860000
                                                                        04870000
         ICM   R2,15,Y.IQTNEXT    GET THE NEXT IQT                      04880000
         BM    RQDISPNX           BRANCH IF END                         04890000
                                                                        04900000
RQDSPIQT DS    0H                                                       04910000
                                                                        04920000
         LA    R0,0(,R2)          IQT ADDRESS                           04930000
         O     R0,=X'80000000'    FLAG IT AS AN IQT                     04940000
         BAS   R14,TRANDISP       AND DISPLAY THE QUEUED TRANSACTION    04950000
         B     RQDSPQLP           AND LOOP TO DO THEM ALL               04960000
                                                                        04970000
         DROP  X                                                        04980000
         DROP  Y                                                        04990000
                                                                        05000000
RQDISPDN DS    0H                                                       05010000
                                                                        05020000
         $MSG  343,FIELDS=(KMDNAME,                                    +05030000
               (R3))                                                    05040000
                                                                        05050000
         B     RETURNOK                                                 05060000
                                                                        05070000
*---------------------------------------------------------------------- 05080000
* REQUEST = IMPORT/EXPORT                                               05090000
*---------------------------------------------------------------------- 05100000
                                                                        05110000
RQIMPORT DS    0H                                                       05120000
                                                                        05130000
         USING PTR,RPTR                                                 05140000
                                                                        05150000
         LA    RPTR,WKPTR                                               05160000
         MVC   KMDNAME,=CL8'import'                                     05170000
         MVI   PTRREQ,#PTRQIMP    IMPORT REQUEST                        05180000
         B     RQIECOMN                                                 05190000
                                                                        05200000
RQEXPORT DS    0H                                                       05210000
                                                                        05220000
         LA    RPTR,WKPTR                                               05230000
         MVC   KMDNAME,=CL8'export'                                     05240000
         MVI   PTRREQ,#PTRQEXP    EXPORT REQUEST                        05250000
                                                                        05260000
RQIECOMN DS    0H                                                       05270000
                                                                        05280000
         OC    KMDAPPID,KMDAPPID  APPLID= SPECIFIED?                    05290000
         BZ    ERRSYNTX           BRANCH IF NOT                         05300000
         OC    KMDPROJ,KMDPROJ    PROJECT= SPECIFIED?                   05310000
         BZ    ERRSYNTX           BRANCH IF NOT                         05320000
                                                                        05330000
         MVC   PTREXPRJ,KMDPROJ   EXPORT PROJECT NAME                   05340000
         MVC   PTRIMPRJ,KMDPROJ   ASSUME IMPORT-NAME = EXPORT-NAME      05350000
         OC    KMDASPJ,KMDASPJ    AS= SPECIFIED                         05360000
         BZ    RQIESET            BRANCH IF NOT                         05370000
         MVC   PTRIMPRJ,KMDASPJ   IMPORT-NAME = AS-NAME                 05380000
                                                                        05390000
RQIESET  DS    0H                                                       05400000
                                                                        05410000
         MVC   PTRL(L'PTRL+L'PTRTP),XFERTRAN                            05420000
         MVC   PTRACC,=A(#PTRA_WB) EXCLUSIVE ACCESS                     05430000
         ICM   R2,B'1111',CMRQUTOK UTOKEN AVAILABLE ?                   05440000
         BZ    RQINOUTK           BRANCH IF NOT                         05450000
                                                                        05460000
         OI    PTRFLAGS,#PTRFUTK  INDICATE UTOKEN AVAILABLE             05470000
         USING TOKEN,R2                                                 05480000
         SR    R1,R1              GET UTOKEN'S LENGTH                   05490000
         IC    R1,TOKLEN                                                05500000
         BCTR  R1,0               COPY UTOKEN TO PTR                    05510000
         EX    R1,*+4                                                   05520000
         MVC   PTRUTOKN(0),TOKEN                                        05530000
         DROP  R2                                                       05540000
                                                                        05550000
RQINOUTK DS    0H                                                       05560000
                                                                        05570000
         TM    FLAGS,FLAGREPL     REPLACE= SPECIFIED ?                  05580000
         BNO   RQIESYS            BRANCH IF NOT                         05590000
         MVC   PTRCONF,=A(#PTR$CON) REPLACE CONFIRMED                   05600000
                                                                        05610000
RQIESYS  DS    0H                                                       05620000
                                                                        05630000
         $SYSTEMS QWORK,                                               +05640000
               APPLID=KMDAPPID,                                        +05650000
               WORKUNIT=PTR,                                           +05660000
               ERRET=ERR$SYST,                                         +05670000
               MF=(E,MFE_LIST)                                          05680000
                                                                        05690000
         DROP  RPTR                                                     05700000
                                                                        05710000
         B     RETURNOK                                                 05720000
                                                                        05730000
XFERTRAN DC    A(L'PTRH),CL8'ITRNXFER'                                  05740000
                                                                        05750000
*---------------------------------------------------------------------- 05760000
* EXCEPTION ROUTINES                                                    05770000
*---------------------------------------------------------------------- 05780000
                                                                        05790000
ERRSYNTX DS    0H                                                       05800000
         MVC   RETR15,=A(CCODE_SYNTAX)   SYNTAX ERROR                   05810000
         B     RETURN                                                   05820000
                                                                        05830000
ERRCNFLC DS    0H                                                       05840000
         MVC   RETR15,=A(CCODE_CONFLICT) CONFLICTING OPERANDS           05850000
         B     RETURN                                                   05860000
                                                                        05870000
ERREJECT DS    0H                                                       05880000
         MVC   RETR15,=A(CCODE_REJECT)   COMMAND REJECTED               05890000
         B     RETURN                                                   05900000
                                                                        05910000
ERR$SYST DS    0H                                                       05920000
         LA    R4,SYSRS           REASON CODE LOOKUP TABLE              05930000
         LA    R2,L'SYSRSENT      LENGTH OF TABLE ENTRY                 05940000
         LA    R3,SYSRSEND        ADDRESS OF LAST VALID ENTRY           05950000
ERRSYSLP DS    0H                                                       05960000
X        USING SYLIST,MFE_LIST                                          05970000
         CLC   X.SYLRSNCD,0(R4)   IS THIS THE REASON?                   05980000
         DROP  X                                                        05990000
         BE    ERRSYSOK           BRANCH IF YES                         06000000
         BXLE  R4,R2,ERRSYSLP     CHECK FOR CORRECT ENTRY               06010000
ERRSYSOK DS    0H                                                       06020000
         LM    R2,R3,4(R4)        R2=TEXT LENGTH, R3=TEXT ADDRESS       06030000
         MVC   KMDSTAT,=CL8'failed-'                                    06040000
         B     RETURNMG                                                 06050000
                                                                        06060000
*---------------------------------------------------------------------- 06070000
* RETURN TO CALLER                                                      06080000
*---------------------------------------------------------------------- 06090000
                                                                        06100000
RETURNOK DS    0H                                                       06110000
         SR    R2,R2              NO ERROR TEXT LENGTH                  06120000
         SR    R3,R3              NO ERROR TEXT ADDRESS                 06130000
                                                                        06140000
RETURNMG DS    0H                                                       06150000
                                                                        06160000
         $MSG  340,FIELDS=(KMDNAME,                                    +06170000
               KMDSTAT,                                                +06180000
               ((R3),(R2)))                                             06190000
                                                                        06200000
RETURN   DS    0H                                                       06210000
                                                                        06220000
         BAS   R14,VTAMUNLK       RELEASE SERIALIZATION IF APPROPRIATE  06230000
         MVC   CMRQCOMP(4),RETR15 SET COMMAND PROCESSOR COMPLETION CODE 06240000
         LM    R15,R1,RETREGS     LOAD RETURN VALUES                    06250000
                                                                        06260000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    06270000
                                                                        06280000
*---------------------------------------------------------------------- 06290000
*                                                                       06300000
* ROUTINE: TRANDISP - DISPLAY A TRANSACTION                             06310000
*                                                                       06320000
* DESCRIPTION:                                                          06330000
*                                                                       06340000
*    THIS ROUTINE ISSUES MSG INTVTM022 TO DISPLAY A TRANSACTION.        06350000
*                                                                       06360000
* ENTRY:   R0>0 --> ACTIVE TRANSACTION (ITWA ADDRESS)                   06370000
*          R0<0 --> QUEUED TRANSACTION (IQTR ADDRESS)                   06380000
*                                                                       06390000
* EXIT:    ALL REGISTERS ARE RESTORED.                                  06400000
*---------------------------------------------------------------------- 06410000
                                                                        06420000
TRANDISP DS    0H                                                       06430000
                                                                        06440000
         STM   R0,R15,SUB0SAVE    SAVE CALLER'S REGISTERS               06450000
         LR    R4,R0                                                    06460000
                                                                        06470000
         MVC   DEQNOTE,=CL8'ACTIVE'                                     06480000
         LTR   R4,R4              QUEUED TRANSACTION?                   06490000
         BNP   TDQUEUED           BRANCH IF YES                         06500000
                                                                        06510000
X        USING ITWA,R4                                                  06520000
                                                                        06530000
         MVC   WRK256(12),=XL12'F021207A20207A20204B2020'               06540000
         ED    WRK256(12),X.ITWQTIME                                    06550000
         MVC   DEQQTIME(11),WRK256+1                                    06560000
                                                                        06570000
         MVC   WRK256(12),=XL12'F021207A20207A20204B2020'               06580000
         ED    WRK256(12),X.ITWSTIME                                    06590000
         MVC   DEQSTIME(11),WRK256+1                                    06600000
                                                                        06610000
         MVC   WRK256(10),=XL10'40212020204B20202020'                   06620000
         ED    WRK256(10),X.ITWQDATE                                    06630000
         MVC   DEQQDATE(8),WRK256+2                                     06640000
                                                                        06650000
         MVC   WRK256(10),=XL10'40212020204B20202020'                   06660000
         ED    WRK256(10),X.ITWSDATE                                    06670000
         MVC   DEQSDATE(8),WRK256+2                                     06680000
                                                                        06690000
         MVC   DEQETIME(11),=CL11'00:00:00.00'                          06700000
         MVC   DEQEDATE(8),=CL8'000.0000'                               06710000
                                                                        06720000
         $MSG  022,COMPID='VTM',                                       +06730000
               FIELDS=(X.ITWTRAN#,                                     +06740000
               X.ITWNAME,                                              +06750000
               DEQNOTE,                                                +06760000
               ISYAPPID,                                               +06770000
               ISYSMFID,                                               +06780000
               X.ITWRNAME,                                             +06790000
               X.ITWSMSG#,                                             +06800000
               X.ITWSBYT#,                                             +06810000
               X.ITWRMSG#,                                             +06820000
               X.ITWRBYT#,                                             +06830000
               DEQQTIME,                                               +06840000
               DEQQDATE,                                               +06850000
               DEQSTIME,                                               +06860000
               DEQSDATE,                                               +06870000
               DEQETIME,                                               +06880000
               DEQEDATE)                                                06890000
                                                                        06900000
         B     TDEXIT                                                   06910000
                                                                        06920000
         DROP  X                                                        06930000
                                                                        06940000
TDQUEUED DS    0H                                                       06950000
                                                                        06960000
X        USING IQT,R4                                                   06970000
Y        USING TMSGSTD,X.IQTTMSG                                        06980000
                                                                        06990000
         MVC   DEQNOTE,=CL8'QUEUED'                                     07000000
                                                                        07010000
         MVC   WRK256(12),=XL12'F021207A20207A20204B2020'               07020000
         ED    WRK256(12),X.IQTQTIME                                    07030000
         MVC   DEQQTIME(11),WRK256+1                                    07040000
                                                                        07050000
         MVC   WRK256(10),=XL10'40212020204B20202020'                   07060000
         ED    WRK256(10),X.IQTQDATE                                    07070000
         MVC   DEQQDATE(8),WRK256+2                                     07080000
                                                                        07090000
         MVC   DEQSTIME(11),=CL11'00:00:00.00'                          07100000
         MVC   DEQETIME(11),=CL11'00:00:00.00'                          07110000
         MVC   DEQSDATE(8),=CL8'000.0000'                               07120000
         MVC   DEQEDATE(8),=CL8'000.0000'                               07130000
                                                                        07140000
         $MSG  022,COMPID='VTM',                                       +07150000
               FIELDS=(ZERO,                                           +07160000
               (Y.TMSGINFO+4,8),                                       +07170000
               DEQNOTE,                                                +07180000
               ISYAPPID,                                               +07190000
               ISYSMFID,                                               +07200000
               BLANK,                                                  +07210000
               ZERO,                                                   +07220000
               ZERO,                                                   +07230000
               ZERO,                                                   +07240000
               ZERO,                                                   +07250000
               DEQQTIME,                                               +07260000
               DEQQDATE,                                               +07270000
               DEQSTIME,                                               +07280000
               DEQSDATE,                                               +07290000
               DEQETIME,                                               +07300000
               DEQEDATE)                                                07310000
                                                                        07320000
         B     TDEXIT                                                   07330000
                                                                        07340000
         DROP  Y                                                        07350000
         DROP  X                                                        07360000
                                                                        07370000
TDEXIT   DS    0H                                                       07380000
                                                                        07390000
         LM    R0,R15,SUB0SAVE    RESTORE CALLER'S REGISTERS            07400000
         BR    R14                RETURN                                07410000
                                                                        07420000
*---------------------------------------------------------------------- 07430000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 07440000
*---------------------------------------------------------------------- 07450000
                                                                        07460000
VTAMLOCK DS    0H                                                       07470000
                                                                        07480000
         TM    FLAGS,FLAGLOCK       IS LOCK HELD?                       07490000
         BOR   R14                  BRANCH IF YES, DON'T DO IT AGAIN    07500000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             07510000
                                                                        07520000
         $SER  OBTAIN,                                                 +07530000
               VTAM                                                     07540000
                                                                        07550000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              07560000
         BNE   VTAMLOEX             BRANCH IF NOT                       07570000
         OI    FLAGS,FLAGLCKD       REMEMBER LOCK HELD ON ENTRY         07580000
                                                                        07590000
VTAMLOEX DS    0H                                                       07600000
                                                                        07610000
         OI    FLAGS,FLAGLOCK       REMEMBER LOCK IS HELD               07620000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          07630000
         BR    R14                  RETURN                              07640000
                                                                        07650000
*---------------------------------------------------------------------- 07660000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                07670000
*---------------------------------------------------------------------- 07680000
                                                                        07690000
VTAMUNLK DS    0H                                                       07700000
                                                                        07710000
         TM    FLAGS,FLAGLOCK       IS LOCK HELD?                       07720000
         BNOR  R14                  BRANCH IF NOT                       07730000
         TM    FLAGS,FLAGLCKD       WAS LOCK HELD ON ENTRY?             07740000
         BOR   R14                  DON'T RELEASE IF IT WAS             07750000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             07760000
                                                                        07770000
         $SER  RELEASE,                                                +07780000
               VTAM                                                     07790000
                                                                        07800000
         NI    FLAGS,255-FLAGLOCK   SHOW LOCK NOT HELD                  07810000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          07820000
         BR    R14                  RETURN                              07830000
                                                                        07840000
*---------------------------------------------------------------------- 07850000
*  CONSTANTS AND LITERALS                                               07860000
*---------------------------------------------------------------------- 07870000
                                                                        07880000
         LTORG ,                                                        07890000
ZERO     DC    F'0'                                                     07900000
BLANK    DC    CL1' '                                                   07910000
                                                                        07920000
*---------------------------------------------------------------------- 07930000
*  $SYSTEMS MACRO REASON CODE TRANSLATIONS                              07940000
*---------------------------------------------------------------------- 07950000
                                                                        07960000
SYSRS    DS    0A                                                       07970000
         DC    A(0),A(L'SYSRSN00),A(SYSRSN00)                           07980000
SYSRSENT EQU   SYSRS,*-SYSRS                                            07990000
         DC    A(1),A(L'SYSRSN01),A(SYSRSN01)                           08000000
         DC    A(2),A(L'SYSRSN02),A(SYSRSN02)                           08010000
         DC    A(3),A(L'SYSRSN03),A(SYSRSN03)                           08020000
         DC    A(4),A(L'SYSRSN04),A(SYSRSN04)                           08030000
         DC    A(5),A(L'SYSRSN05),A(SYSRSN05)                           08040000
         DC    A(6),A(L'SYSRSN06),A(SYSRSN06)                           08050000
         DC    A(7),A(L'SYSRSN07),A(SYSRSN07)                           08060000
         DC    A(8),A(L'SYSRSN08),A(SYSRSN08)                           08070000
SYSRSEND EQU   *                                                        08080000
         DC    A(9),A(L'SYSRSN09),A(SYSRSN09)                           08090000
         DC    A(0),A(L'SYSRSNXX),A(SYSRSNXX)                           08100000
                                                                        08110000
SYSRSN00 DC    C'No errors'                                             08120000
SYSRSN01 DC    C'Invalid request code'                                  08130000
SYSRSN02 DC    C'Specified APPLID previously defined'                   08140000
SYSRSN03 DC    C'Specified APPLID could not be found'                   08150000
SYSRSN04 DC    C'Specified APPLID is already started'                   08160000
SYSRSN05 DC    C'Specified APPLID is not started'                       08170000
SYSRSN06 DC    C'Specified APPLID is draining'                          08180000
SYSRSN07 DC    C'APPLID parameter missing'                              08190000
SYSRSN08 DC    C'SMFID parameter missing'                               08200000
SYSRSN09 DC    C'WORKUNIT parameter missing'                            08210000
SYSRSNXX DC    C'Unknown reason code from $SYSTEMS'                     08220000
                                                                        08230000
         $SYSTEMS DSECT=YES       INTEGRATOR $SYSTEMS SERVICES          08240000
         PRINT NOGEN                                                    08250000
         CMDREQ  ,                COMMAND REQUEST BLOCK                 08260000
         CCSUMRY ,                COMMAND OPERAND PREPARSE SUMMARY      08270000
         KEYCODES COMMANDSET=SYSTEMS                                    08280000
         CMDCODES ,                                                     08290000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                08300000
         ICHRUTKN ,               MVS UTOKEN                            08310000
         ISTDBIND ,               VTAM BIND IMAGE                       08320000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         08330000
         ICVT  ,                  INTEGRATOR CVT                        08340000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   08350000
         ITASK ,                  INTEGRATOR TASK BLOCK                 08360000
         IPCB  ,                  INTEGRATOR PROC BLOCK                 08370000
         ISESS ,                  INTEGRATOR ISESS BLOCK                08380000
         IPOOL ,                  INTEGRATOR IPOOL BLOCK                08390000
         IACB  ,                  INTEGRATOR IACB  BLOCK                08400000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       08410000
         PTRH  ,                  INTEGRATOR PROJECT TRANSFER           08420000
         $PRJREQ DSECT=YES        INTEGRATOR PROJECT REQUEST            08430000
         EVCODES ,                INTEGRATOR EVENT CODES                08440000
         ABCODES ,                INTEGRATOR $ABEND CODES               08450000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     08460000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        08470000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             08480000
         END   ,                                                        08490000

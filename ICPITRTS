ICPITRTS TITLE 'INTEGRATOR - CPIC CMTRTS API - TEST REQUEST TO SEND'    00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: ICPITRTS - CPIC CMTRTS API                                   00100000
*                                                                       00110000
* DESCRIPTION:                                                          00120000
*                                                                       00130000
*    THIS ROUTINE IS CALLED TO PROCESS THE CMTRTS VERB.                 00140000
*                                                                       00150000
* ON ENTRY:                                                             00160000
*                                                                       00170000
*    R15 = ENTRY POINT ADDRESS                                          00180000
*    R14 = RETURN      ADDRESS                                          00190000
*    R13 = SAVE AREA   ADDRESS                                          00200000
*    R01 = PARM LIST   ADDRESS                                          00210000
*                                                                       00220000
*          +00 = ADDRESS OF CONVERSATION_ID                             00230000
*          +04 = ADDRESS OF REQUEST_TO_SEND_RECEIVED RETURN AREA        00240000
*          +08 = ADDRESS OF RETURN_CODE RETURN AREA                     00250000
*                                                                       00260000
* ON EXIT:                                                              00270000
*                                                                       00280000
*    R15 = 0                                                            00290000
*                                                                       00300000
*    RETURN_CODE = CM_OK                      --> CMTRTS SUCCESSFUL     00310000
*                = CM_PROGRAM_PARAMETER_CHECK --> INVALID CONV_ID       00320000
*                = CM_PROGRAM_STATE_CHECK     --> INVALID STATE         00330000
*                = CM_PRODUCT_SPECIFIC_ERROR  --> BAD PARM/SESS FAILURE 00340000
*                = CM_OPERATION_NOT_ACCEPTED  --> N/A                   00350000
*                                                                       00360000
**<DOC-OFF>************************************************************ 00370000
         EJECT ,                                                        00380000
*********************************************************************** 00390000
*                                                                       00400000
* MAINTENANCE:                                                          00410000
*                                                                       00420000
*   07/01/94 RANDY WITEK                                                00430000
*                                                                       00440000
*********************************************************************** 00450000
                                                                        00460000
         EQUS  ,                  GENERAL EQUATES                       00470000
                                                                        00480000
RICVT    EQU   R11                                                      00490000
RITASK   EQU   R10                                                      00500000
RBASE    EQU   R9                                                       00510000
RIVTAM   EQU   R8                                                       00520000
RCMLIST  EQU   R7                                                       00530000
RTKB     EQU   R6                                                       00540000
RRCB     EQU   R5                                                       00550000
RISESS   EQU   R4                                                       00560000
                                                                        00570000
         USING DSA,R13            ESTABLISH ADDRESSABILITY              00580000
         USING CRAB,R12           ESTABLISH ADDRESSABILITY              00590000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00600000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00610000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00620000
         USING CMLIST,RCMLIST     ESTABLISH ADDRESSABILITY              00630000
         USING TKB,RTKB           ESTABLISH ADDRESSABILITY              00640000
         USING RCB,RRCB           ESTABLISH ADDRESSABILITY              00650000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00660000
                                                                        00670000
         COPY  CRAB               "C" RUNTIME ANCHOR BLOCK              00680000
         COPY  DSA                DYNAMIC SAVE AREA                     00690000
WORKAREA DS    0H                 READ/WRITE WORKAREA                   00700000
WRK256   DS    XL256              GENERAL WORKAREA                      00710000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00720000
$SESSMFL $SESS MF=L               PLIST CONSTRUCTION                    00730000
CONVID   DS    XL8                TEMPORARY CONVERSATION ID AREA        00740000
RETCODE  DS    F                  TEMPORARY RETURN CODE     AREA        00750000
RETRTSR  DS    F                  REQUEST TO SEND RECEIVED  AREA        00760000
CONVS    DS    F                  TEMPORARY CONV STATE      AREA        00770000
FLAG     DS    X                                                        00780000
FLAGIERR EQU   X'80'                                                    00790000
FLAGLOCK EQU   X'40'                                                    00800000
FLAGLCKD EQU   X'20'                                                    00810000
         DS    0D                                                       00820000
WORKLEN  EQU   *-WORKAREA         LENGTH OF USER DSA AREA               00830000
DSALEN   EQU   *-DSA              LENGTH OF DSA                         00840000
                                                                        00850000
         $MSGDFT PREFIX=ICTPID,                                        +00860000
               COMPID='CPI',                                           +00870000
               TABLE=*#MSGS,                                           +00880000
               WORKA=0,                                                +00890000
               MF=(E,WRK256),                                          +00900000
               PRINT=NOGEN                                              00910000
                                                                        00920000
ICPTRTS@ CSECT ,                                                        00930000
ICPITRTS CENTRY DSA=DSALEN,BASE=RBASE,INDEP=YES                         00940000
                                                                        00950000
*---------------------------------------------------------------------- 00960000
* ENTRY                                                                 00970000
*---------------------------------------------------------------------- 00980000
                                                                        00990000
         LR    RCMLIST,R1         SAVE ADDRESS OF PLIST                 01000000
                                                                        01010000
         LA    R0,WORKAREA        ADDRESS OF USER DSA SECTION           01020000
         LA    R1,WORKLEN         LENGTH  OF USER DSA SECTION           01030000
         SR    R15,R15            PREPARE FOR CLEAR                     01040000
         MVCL  R0,R14             CLEAR USER DSA SECTION                01050000
                                                                        01060000
*---------------------------------------------------------------------- 01070000
* INITIALIZATION                                                        01080000
*---------------------------------------------------------------------- 01090000
                                                                        01100000
         @RESTENV ,               ENSURE ENVIRONMENT                    01110000
                                                                        01120000
         L     RIVTAM,ICTVTCVT    ESTABLISH IVTAMCVT POINTER            01130000
                                                                        01140000
         MVC   CONVID,=XL8'55AA55AA55AA55AA'                            01150000
         MVC   CONVS,=XL4'55AA55AA'                                     01160000
                                                                        01170000
         L     R1,CMLPARM3        ADDRESS OF RETURN_CODE AREA           01180000
         MVC   0(4,R1),0(R1)      TEST MOVEMENT                         01190000
                                                                        01200000
         ICM   R1,15,CMLPARM1     ADDRESS OF CONVERSATION ID            01210000
         BNP   INITERR            BRANCH IF BAD                         01220000
         MVC   CONVID,0(R1)       COPY CONVID                           01230000
                                                                        01240000
         ICM   R1,15,CMLPARM2     ADDRESS OF RTS_RECEIVED RETURN AREA   01250000
         BNP   INITERR            BRANCH IF BAD                         01260000
         MVC   0(4,R1),0(R1)      TEST MOVEMENT                         01270000
         B     INITEND                                                  01280000
                                                                        01290000
INITERR  DS    0H                                                       01300000
                                                                        01310000
         OI    FLAG,FLAGIERR      REMEMBER ERROR DETECTED               01320000
                                                                        01330000
INITEND  DS    0H                                                       01340000
                                                                        01350000
*---------------------------------------------------------------------- 01360000
* ENTRY TRACE                                                           01370000
*---------------------------------------------------------------------- 01380000
                                                                        01390000
         $TRACE *=A(TRC_CPIC_ICPITRTS),48 TRACE ENTRY W/ 48 USER BYTES  01400000
         BNZ   NOETRACE                   BRANCH IF NOT TRACING         01410000
         $APITRC ICPITRTS                 TRACE COMMON STUFF            01420000
         ST    RCMLIST,24(,R1)            TRACE PARMLIST ADDRESS        01430000
         MVC   32(8,R1),CONVID            TRACE CONVERSATION ID         01440000
NOETRACE DS    0H                                                       01450000
                                                                        01460000
*---------------------------------------------------------------------- 01470000
* LOCATE SPECIFIED CONVERSATION                                         01480000
*---------------------------------------------------------------------- 01490000
                                                                        01500000
         TM    FLAG,FLAGIERR             ERROR DETECTED ALREADY?        01510000
         BO    ERRPROD                   BRANCH IF YES                  01520000
                                                                        01530000
         LA    R1,CONVID                 ADDRESS OF CONVERSATION ID     01540000
         L     R15,ICP@LOC               ENTRY POINT OF TKB/RCB LOCATE  01550000
         BASR  R14,R15                   LOCATE THE TKB/RCB             01560000
         LTR   RTKB,R1                   TKB ADDRESS                    01570000
         BNP   ERRPARM                   BRANCH IF BAD                  01580000
         LTR   RRCB,R0                   RCB ADDRESS                    01590000
         BNP   ERRPARM                   BRANCH IF BAD                  01600000
                                                                        01610000
         MVC   CONVS,RCBCONVS            COPY CONV STATE                01620000
                                                                        01630000
*---------------------------------------------------------------------- 01640000
* STATE CHECK                                                           01650000
*---------------------------------------------------------------------- 01660000
                                                                        01670000
         CLC   CONVS,=A(CM_SEND_STATE)                                  01680000
         BE    TESTRTS                                                  01690000
         CLC   CONVS,=A(CM_RECEIVE_STATE)                               01700000
         BE    TESTRTS                                                  01710000
         CLC   CONVS,=A(CM_SEND_PENDING_STATE)                          01720000
         BE    TESTRTS                                                  01730000
         CLC   CONVS,=A(CM_DEFER_RECEIVE_STATE)                         01740000
         BE    TESTRTS                                                  01750000
         CLC   CONVS,=A(CM_DEFER_DEALLOCATE_STATE)                      01760000
         BE    TESTRTS                                                  01770000
         B     ERRSTATE                                                 01780000
                                                                        01790000
*---------------------------------------------------------------------- 01800000
* PERFORM TEST REQUEST TO SEND RECEIVED                                 01810000
*---------------------------------------------------------------------- 01820000
                                                                        01830000
TESTRTS  DS    0H                                                       01840000
                                                                        01850000
*                                                                       01860000
* RESERVE THE SESSION                                                   01870000
*---------------------------------------------------------------------- 01880000
                                                                        01890000
         BAS   R14,VTAMLOCK                                             01900000
                                                                        01910000
         $SESS $SESS_FIND_SESSION,                                     +01920000
               SESSION=RCBHSID,                                        +01930000
               ERRET=ERRPROD,                                          +01940000
               MF=(E,$SESSMFL)    LOCATE ASSOCIATED ISESS, IF ANY       01950000
                                                                        01960000
X        USING SPLIST,$SESSMFL                                          01970000
         L     RISESS,X.SPLAREA   ADDRESS OF ASSOCIATED ISESS BLOCK     01980000
         DROP  X                                                        01990000
                                                                        02000000
         TM    ISEF1,ISEF1TRM     SESS TERM STARTED?                    02010000
         BO    ERRPROD            BRANCH IF YES                         02020000
         TM    ISE62FL2,ISE62DRD  IS DRIVER DOWN?                       02030000
         BO    ERRPROD            BRANCH IF YES                         02040000
                                                                        02050000
*                                                                       02060000
* TEST THE RTS RECEIVED BIT                                             02070000
*---------------------------------------------------------------------- 02080000
                                                                        02090000
         MVC   RETRTSR,=A(CM_REQUEST_TO_SEND_NOT_RECEIVED)              02100000
         TM    ISE62FL1,ISE62SIG     WAS A SIGNAL RECEIVED?             02110000
         BNO   RETURN                ALL DONE IF NOT                    02120000
         NI    ISE62FL1,255-ISE62SIG CLEAR THE FLAG                     02130000
         MVC   RETRTSR,=A(CM_REQUEST_TO_SEND_RECEIVED)                  02140000
         B     RETURN                ALL DONE                           02150000
                                                                        02160000
*---------------------------------------------------------------------- 02170000
* EXCEPTION ROUTINES                                                    02180000
*---------------------------------------------------------------------- 02190000
                                                                        02200000
ERRPROD  DS    0H                                                       02210000
                                                                        02220000
         MVC   RETCODE,=A(CM_PRODUCT_SPECIFIC_ERROR)                    02230000
         B     RETURN                                                   02240000
                                                                        02250000
ERRSTATE DS    0H                                                       02260000
                                                                        02270000
         MVC   RETCODE,=A(CM_PROGRAM_STATE_CHECK)                       02280000
         B     RETURN                                                   02290000
                                                                        02300000
ERRPARM  DS    0H                                                       02310000
                                                                        02320000
         MVC   RETCODE,=A(CM_PROGRAM_PARAMETER_CHECK)                   02330000
         B     RETURN                                                   02340000
                                                                        02350000
*---------------------------------------------------------------------- 02360000
* EXIT TRACE AND RETURN TO CALLER                                       02370000
*---------------------------------------------------------------------- 02380000
                                                                        02390000
RETURN   DS    0H                                                       02400000
                                                                        02410000
         BAS   R14,VTAMUNLK                                             02420000
                                                                        02430000
         $TRACE *=A(TRC_CPIC_EXIT),48 TRACE ENTRY                       02440000
         BNZ   NOXTRACE               BRANCH IF TRACING NOT AVAILABLE   02450000
         MVC   0(8,R1),=CL8'ICPITRTS' MODULE NAME                       02460000
         MVC   8(4,R1),RETCODE        RETURN_CODE VALUE                 02470000
         MVC   12(8,R1),CONVID        CONVERSATION ID                   02480000
         MVC   20(4,R1),CONVS         CONVERSATION STATE                02490000
         MVC   24(4,R1),RETRTSR       RTS RECEIVED VALUE                02500000
NOXTRACE DS    0H                                                       02510000
                                                                        02520000
         L     R1,CMLPARM3        ADDRESS OF RETURN_CODE AREA           02530000
         MVC   0(4,R1),RETCODE    SET RETURN_CODE VARIABLE              02540000
         CLC   RETCODE,=A(CM_OK)  GOOD RC?                              02550000
         BNE   EXIT               BRANCH IF NOT                         02560000
                                                                        02570000
         L     R1,CMLPARM2        ADDRESS OF RTS RECEIVED AREA          02580000
         MVC   0(4,R1),RETRTSR    SET RTS_RECEIVED VARIABLE             02590000
                                                                        02600000
EXIT     DS    0H                                                       02610000
                                                                        02620000
         SR    R15,R15            FUNCTION RETURN CODE = 0              02630000
         CEXIT RC=(R15),INDEP=YES RETURN                                02640000
                                                                        02650000
*---------------------------------------------------------------------- 02660000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 02670000
*---------------------------------------------------------------------- 02680000
                                                                        02690000
VTAMLOCK DS    0H                                                       02700000
                                                                        02710000
         TM    FLAG,FLAGLOCK        WAS THE LOCK ALREADY OBTAINED?      02720000
         BOR   R14                  RETURN IF YES                       02730000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             02740000
                                                                        02750000
         $SER  OBTAIN,                                                 +02760000
               VTAM                                                     02770000
                                                                        02780000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              02790000
         BNE   VTAMLOEX             BRANCH IF NOT                       02800000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         02810000
                                                                        02820000
VTAMLOEX DS    0H                                                       02830000
                                                                        02840000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               02850000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          02860000
         BR    R14                  RETURN                              02870000
                                                                        02880000
*---------------------------------------------------------------------- 02890000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                02900000
*---------------------------------------------------------------------- 02910000
                                                                        02920000
VTAMUNLK DS    0H                                                       02930000
                                                                        02940000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       02950000
         BNOR  R14                  BRANCH IF NOT                       02960000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             02970000
         BOR   R14                  DON'T RELEASE IF IT WAS             02980000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             02990000
                                                                        03000000
         $SER  RELEASE,                                                +03010000
               VTAM                                                     03020000
                                                                        03030000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  03040000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          03050000
         BR    R14                  RETURN                              03060000
                                                                        03070000
*---------------------------------------------------------------------- 03080000
* LITERALS AND CONSTANTS                                                03090000
*---------------------------------------------------------------------- 03100000
                                                                        03110000
         LTORG ,                                                        03120000
                                                                        03130000
         PRINT NOGEN                                                    03140000
         ISTDBIND ,               VTAM BIND IMAGE                       03150000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                03160000
         IKJTCB ,                 MVS TASK CONTROL BLOCK                03170000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         03180000
         ICVT  ,                  INTEGRATOR CVT                        03190000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   03200000
         ITASK ,                  INTEGRATOR TASK BLOCK                 03210000
         IPCB ,                   INTEGRATOR PROCESS BLOCK              03220000
         ISESS ,                  INTEGRATOR SESSION BLOCK              03230000
         ABCODES ,                INTEGRATOR $ABEND CODES               03240000
         EVCODES ,                INTEGRATOR EVENT CODES                03250000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             03260000
         END   ,                                                        03270000

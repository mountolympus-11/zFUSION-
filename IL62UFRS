IL62UFRS TITLE 'INTEGRATOR - IVUSER LU6.2 FREE SESSION PROCESSING'      00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: IL62UFRS - IVUSER LU6.2 FREE SESSION PROCESSING              00100000
*                                                                       00110000
* DESCRIPTION: LOCATE A WAITING REQUEST FOR THE GIVEN MODE OR PLACE     00120000
*              THE SESSION ON THE FREE QUEUE                            00130000
*                                                                       00140000
* ON ENTRY:                                                             00150000
*                                                                       00160000
*    R15 = ENTRY POINT ADDRESS                                          00170000
*    R14 = RETURN ADDRESS                                               00180000
*    R13 = AVAILABLE SAVE AREA                                          00190000
*    R11 = ICVT ADDRESS                                                 00200000
*    R10 = ITASK ADDRESS                                                00210000
*    R09 = IVTAMCVT ADDRESS                                             00220000
*    R08 = IVUSER ADDRESS                                               00230000
*    R01 = ADDRESS OF LU6.2 FREE SESSION WORK ELEMENT                   00240000
*                                                                       00250000
* ON EXIT:                                                              00260000
*                                                                       00270000
*    R15 = 0                                                            00280000
*    R00 = 0                                                            00290000
*    R01 = 0                                                            00300000
*                                                                       00310000
*    ALL OTHER REGISTERS ARE RESTORED.                                  00320000
*                                                                       00330000
**<DOC-OFF>************************************************************ 00340000
                                                                        00350000
         EJECT ,                                                        00360000
*********************************************************************** 00370000
*                                                                       00380000
* MAINTENANCE:                                                          00390000
*                                                                       00400000
*   07/01/94 RANDY WITEK - LU6.2 SUPPORT                                00410000
*                                                                       00420000
*********************************************************************** 00430000
                                                                        00440000
         EQUS  ,                  GENERAL EQUATES                       00450000
                                                                        00460000
RICVT    EQU   R11                                                      00470000
RITASK   EQU   R10                                                      00480000
RIVTAM   EQU   R9                                                       00490000
RIVUSER  EQU   R8                                                       00500000
RIWE     EQU   R7                                                       00510000
RISESS   EQU   R6                                                       00520000
RMDE     EQU   R5                                                       00530000
RAQE     EQU   R4                                                       00540000
                                                                        00550000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00560000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00570000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00580000
         USING IVUSER,RIVUSER     ESTABLISH ADDRESSABILITY              00590000
         USING IWEVTAM,RIWE       ESTABLISH ADDRESSABILITY              00600000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00610000
         USING MDE,RMDE           ESTABLISH ADDRESSABILITY              00620000
         USING AQE,RAQE           ESTABLISH ADDRESSABILITY              00630000
                                                                        00640000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00650000
WRK256   DS    XL256              GENERAL WORKAREA                      00660000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00670000
$SESSMFL $SESS MF=L               PLIST CONSTRUCTION                    00680000
$TASKMFL $TASK MF=L               PLIST CONSTRUCTION                    00690000
$WUMFL   $WULOC MF=L              PLIST CONSTRUCTION                    00700000
L62MFL   L62POST MF=L             PLIST CONSTRUCTION                    00710000
L62RETCD DS    F                  LU6.2 RETURN CODE RETURN AREA         00720000
L62RETTK DS    XL(L'PCBENTKN)     LU6.2 WU TOKEN    RETURN AREA         00730000
WUDATA   DS    XL16               WULOC RETURN AREA                     00740000
                                                                        00750000
RETR15   DS    F                                                        00760000
RETR0    DS    F                                                        00770000
RETR1    DS    F                                                        00780000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00790000
                                                                        00800000
FLAG     DS    X                                                        00810000
FLAGLOCK EQU   X'80'                                                    00820000
FLAGLCKD EQU   X'40'                                                    00830000
FLAGDLCK EQU   X'20'              DISP LOCK HELD                        00840000
FLAGDLKD EQU   X'10'              DISP LOCK HELD ON ENTRY               00850000
                                                                        00860000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00870000
                                                                        00880000
         $MSGDFT PREFIX=ICTPID,                                        +00890000
               COMPID='L62',                                           +00900000
               TABLE=*#MSGS,                                           +00910000
               WORKA=0,                                                +00920000
               MF=(E,WRK256),                                          +00930000
               PRINT=NOGEN                                              00940000
                                                                        00950000
IL62UFRS #ENTER BASE=R12,         ENTRY LINKAGE                        +00960000
               PREG=RIWE,                                              +00970000
               AMODE=31,                                               +00980000
               RMODE=ANY                                                00990000
                                                                        01000000
*---------------------------------------------------------------------- 01010000
* ESTABLISH ENVIRONMENT                                                 01020000
*---------------------------------------------------------------------- 01030000
                                                                        01040000
         BAS   R14,VTAMLOCK       SERIALIZE                             01050000
                                                                        01060000
         L     RMDE,IWEY4MDE      ASSOCIATED MDE ADDRESS                01070000
         CLC   MDEID,=CL8'MDE'    DOES IT LOOK RIGHT?                   01080000
         BNE   ERRENVIR           BRANCH IF NOT                         01090000
                                                                        01100000
         $SESS $SESS_FIND_SESSION,                                     +01110000
               SESSION=IWEY4TKN,                                       +01120000
               ERRET=NOSESS,                                           +01130000
               MF=(E,$SESSMFL)    LOCATE ASSOCIATED ISESS               01140000
                                                                        01150000
X        USING SPLIST,$SESSMFL                                          01160000
         L     RISESS,X.SPLAREA   ADDRESS OF ASSOCIATED ISESS BLOCK     01170000
         DROP  X                                                        01180000
                                                                        01190000
         C     RMDE,ISE62MDE      IS MDE LINKED TO ISESS?               01200000
         BNE   ERRENVIR           BRANCH IF NOT                         01210000
                                                                        01220000
*---------------------------------------------------------------------- 01230000
* PUT THE SESSION ON THE FREE QUEUE                                     01240000
*---------------------------------------------------------------------- 01250000
                                                                        01260000
         BAS   R14,QSESSION       PUT SESSION ON FREE QUEUE             01270000
                                                                        01280000
*---------------------------------------------------------------------- 01290000
* IF THE SESSION IS TERMINATING...JUST GET OUT                          01300000
*---------------------------------------------------------------------- 01310000
                                                                        01320000
         TM    ISEF1,ISEF1TRM     IS TERMINATION IN PROGRESS?           01330000
         BO    RETURN             EXIT IF YES                           01340000
                                                                        01350000
*---------------------------------------------------------------------- 01360000
* IF THERE IS DATA IN THE RECEIVE QUEUE...                              01370000
* TRIGGER THE RECEIVE PROCESSOR.                                        01380000
*---------------------------------------------------------------------- 01390000
                                                                        01400000
         ICM   R15,15,ISE62RB1    IS THERE DATA QUEUED?                 01410000
         BNP   NODATA             BRANCH IF NOT                         01420000
                                                                        01430000
         $VTAMWE L'IWEY1,         SIZE                                 +01440000
               IWECRECV           CODE = CPIC RECEIVE (THIS IS A DUMMY) 01450000
                                                                        01460000
         LA    R0,ISEWEQ          QUEUE DUMMY RECEIVE TO ISESS          01470000
         BAS   R14,QWE            QUEUE IT                              01480000
         B     RETURN             AND EXIT                              01490000
                                                                        01500000
NODATA   DS    0H                                                       01510000
                                                                        01520000
*---------------------------------------------------------------------- 01530000
* IF A BID SEQUENCE IS IN PROGRESS...LET IT COMPLETE                    01540000
*---------------------------------------------------------------------- 01550000
                                                                        01560000
         TM    ISE62FL2,ISE62BID     BID SEQUENCE?                      01570000
         BO    SESSFREE              BRANCH IF YES                      01580000
                                                                        01590000
*---------------------------------------------------------------------- 01600000
* IF TP'S ARE STOPPED...GO TO DEACTIVATION PROCESSING NOW               01610000
*---------------------------------------------------------------------- 01620000
                                                                        01630000
         TM    ISE62FL3,ISE62BQS+ISE62BRS HAVE WE SENT BIS?             01640000
         BNZ   SESSFREE              BRANCH IF YES                      01650000
         TM    MDEF1,MDEF1STO        IS MODE STOPPED FOR TERMINATION    01660000
         BO    SESSFREE              BRANCH IF YES                      01670000
                                                                        01680000
*---------------------------------------------------------------------- 01690000
* THERE IS NO DATA IN THE RECEIVE QUEUE...                              01700000
* TAKE THE 1ST WAITING AQE.                                             01710000
*---------------------------------------------------------------------- 01720000
                                                                        01730000
FIND1ST  DS    0H                                                       01740000
                                                                        01750000
         LA    RAQE,MDEWR1ST         GET SET TO RUN THE CHAIN           01760000
         S     RAQE,=A(AQENEXT-AQE)  NORMALIZE FOR CHAIN RUN            01770000
                                                                        01780000
TAKE1ST  DS    0H                                                       01790000
                                                                        01800000
         ICM   RAQE,15,AQENEXT       TAKE THE NEXT WAITER               01810000
         BM    CHKSVCMG              BRANCH IF NO WAITING REQUESTS      01820000
         TM    AQEF1,AQEF1SRQ        IS IT WAITING ON SESS REQUEST?     01830000
         BO    TAKE1ST               IF YES...SKIP THIS AQE             01840000
         LM    R14,R15,AQENEXT       R14=NEXT AQE R15=PREVIOUS AQE      01850000
         ST    R15,AQEPREV-AQE(,R14) POINT NEXT AQE AT THE PREVIOUS     01860000
         ST    R14,AQENEXT-AQE(,R15) POINT PREVIOUS AQE AT THE NEXT     01870000
                                                                        01880000
*---------------------------------------------------------------------- 01890000
* COMPLETE THE GETSESSION REQUEST.                                      01900000
* - ISSUE BID IF IT IS NOT A CONWINNER SESSION.                         01910000
* - CONNECT THE RCB TO THE SESSION.                                     01920000
* - POST THE PENDING REQUEST.                                           01930000
* - RELEASE THE AQE.                                                    01940000
*---------------------------------------------------------------------- 01950000
                                                                        01960000
         TM    ISEF2,ISEF2WIN     IS THIS A CONWINNER?                  01970000
         BNO   BID                BRANCH                                01980000
                                                                        01990000
         BAS   R14,DISPLOCK       SERIALIZE                             02000000
                                                                        02010000
         $WULOC LOCATE,           FIND THE WORK UNIT                   +02020000
               TOKEN=AQEENT,      WORK UNIT TOKEN ADDRESS              +02030000
               USERDATA=WUDATA,   XL16 AREA TO RECEIVE USER DATA       +02040000
               MF=(E,$WUMFL)      VALIDATE WORK UNIT                    02050000
                                                                        02060000
         LTR   R15,R15            LOCATE SUCCESS?                       02070000
         BZ    LINKIT             BRANCH IF YES                         02080000
         SR    R0,R0              POSTCODE = SUCCESS                    02090000
         BAS   R14,POSTREQ        POST ROUTINE WILL ISSUE ERROR MESSAGE 02100000
         BAS   R14,DISPUNLK       DESERIALIZE                           02110000
         BAS   R14,FREEAQE        RELEASE THE QUEUE ELEMENT             02120000
         B     FIND1ST            SEE IF THERE'S ANOTHER WAITER         02130000
                                                                        02140000
LINKIT   DS    0H                                                       02150000
                                                                        02160000
Y        USING RCB,R3                                                   02170000
         L     R3,AQERCB          ASSOCIATED RCB ADDRESS SHOULD BE OK   02180000
         MVC   Y.RCBHSID,ISETK    SET SESSION TOKEN IN RCB              02190000
         MVC   ISE62ENT,Y.RCBENT  WORK UNIT ASSOCIATED WITH OWNING RCB  02200000
         ST    R3,ISE62RCB        TIE ISESS TO RCB                      02210000
         DROP  Y                                                        02220000
                                                                        02230000
         LM    R14,R15,ISE62FSN         DEQUEUE SESSION FROM FREE QUEUE 02240000
         LTR   R14,R14                  IS IT ALREADY OFF THE QUEUE?    02250000
         BZ    ERRENVIR                 BRANCH IF YES, ???              02260000
         ST    R14,ISE62FSN-ISESS(,R15) LINK NEXT TO PREV               02270000
         ST    R15,ISE62FSP-ISESS(,R14) LINK PREV TO NEXT               02280000
         XC    ISE62FSN,ISE62FSN        NO LONGER ON QUEUE              02290000
         XC    ISE62FSP,ISE62FSP        NO LONGER ON QUEUE              02300000
                                                                        02310000
         SR    R0,R0              POSTCODE = SUCCESS                    02320000
         BAS   R14,POSTREQ        POST THE REQUEST                      02330000
         BAS   R14,DISPUNLK       DESERIALIZE                           02340000
         BAS   R14,FREEAQE        RELEASE THE QUEUE ELEMENT             02350000
         B     RETURN                                                   02360000
                                                                        02370000
BID      DS    0H                                                       02380000
                                                                        02390000
         OI    ISE62FL2,ISE62BID  SHOW BID SEQUENCE IN PROGRESS         02400000
         MVC   AQE$STKN,ISETK     SET SESSION TOKEN IN AQE              02410000
                                                                        02420000
         $VTAMWE L'IWEY5,         LENGTH                               +02430000
               IWECBID            CODE                                  02440000
                                                                        02450000
X        USING IWEVTAM,R1                                               02460000
         ST    RAQE,X.IWEY5AQE    PASS THE AQE ADDRESS                  02470000
         DROP  X                                                        02480000
                                                                        02490000
         LA    R0,ISEWEQ          QUEUE ADDRESS                         02500000
         BAS   R14,QWE            QUEUE THE WORK ELEMENT                02510000
         LTR   R15,R15            SUCCESSFUL QUEUEING?                  02520000
         BZ    RETURN             EXIT IF YES                           02530000
         EX    0,*                HALT HERE                             02540000
                                                                        02550000
*---------------------------------------------------------------------- 02560000
* THERE IS NO DATA QUEUED AND THERE ARE NO WAITING REQUESTORS...        02570000
* THE SESSION IS FREE!                                                  02580000
* IF IT IS "SNASVCMG"...SEE IF ANY MODE NEEDS SERVICE.                  02590000
*---------------------------------------------------------------------- 02600000
                                                                        02610000
CHKSVCMG DS    0H                                                       02620000
                                                                        02630000
         CLC   MDENAME,=CL8'SNASVCMG'                                   02640000
         BNE   SESSFREE           BRANCH IF NOT SNASVCMG MODE           02650000
         LA    R3,IVUMD1ST        GET SET TO RUN MODE_LIST              02660000
         S     R3,=A(MDENEXT-MDE)                                       02670000
                                                                        02680000
MDERUN   DS    0H                                                       02690000
                                                                        02700000
X        USING MDE,R3                                                   02710000
         ICM   R3,15,X.MDENEXT    LINK TO THE NEXT MDE                  02720000
         BM    SESSFREE           BRANCH IF NO MODE NEEDS SERVICE       02730000
         TM    X.MDEF1,MDEF1WSS   WAITING FOR SNASVCMG?                 02740000
         BNO   MDERUN             BRANCH IF NOT                         02750000
         NI    X.MDEF1,255-MDEF1WSS                                     02760000
                                                                        02770000
         L62ISL *ISEACB@,         IACB ADDRESS                         +02780000
               IVULOCAL,          PARTNER LUNAME                       +02790000
               X.MDENAME,         MODE NAME                            +02800000
               =F'8',             SESSION LIMIT                        +02810000
               =F'4',             MINIMUM CONWINNERS                   +02820000
               =F'4',             MINIMUM CONLOSERS                    +02830000
               L62RETCD,          RETURN CODE AREA                     +02840000
               MF=(E,L62MFL)                                            02850000
                                                                        02860000
         B     RETURN             IGNORE RETURN CODE                    02870000
         DROP  X                                                        02880000
                                                                        02890000
*---------------------------------------------------------------------- 02900000
* PERFORM BIS PROCESSING                                                02910000
*---------------------------------------------------------------------- 02920000
                                                                        02930000
SESSFREE DS    0H                                                       02940000
                                                                        02950000
         TM    ISE62FL3,ISE62TRM  IS TERMINATION PENDING?               02960000
         BNO   SESSDEAC           BRANCH IF NOT                         02970000
                                                                        02980000
         TM    ISE62FL3,ISE62BQR  HAVE WE RECEIVED A BIS REQUEST?       02990000
         BNO   RETURN             EXIT IF NOT                           03000000
         TM    ISE62FL3,ISE62BRS  HAVE WE SENT A BIS RESPONSE?          03010000
         BO    RETURN             EXIT IF YES                           03020000
                                                                        03030000
         $VTAMWE L'IWEY3,         LENGTH                               +03040000
               IWECBISR           CODE                                  03050000
                                                                        03060000
X        USING IWEVTAM,R1                                               03070000
         OI    X.IY3F1,IY3F1RSP    SEND BIS RESPONSE                    03080000
         OI    X.IY3F1,IY3F1SNT    SEND BIS RESPONSE                    03090000
         MVC   X.IWEY3MDE,ISE62MDE PASS THE MDE ADDRESS                 03100000
         MVC   X.IWEY3NME,ISELOGMD PASS THE MODE NAME                   03110000
         MVC   X.IWEY3TKN,ISETK    PASS THE SESSION TOKEN               03120000
         DROP  X                                                        03130000
                                                                        03140000
         LA    R0,ISEWEQ          QUEUE ADDRESS                         03150000
         BAS   R14,QWE            QUEUE THE WORK ELEMENT                03160000
         B     RETURN                                                   03170000
                                                                        03180000
SESSDEAC DS    0H                                                       03190000
                                                                        03200000
         LR    R1,RMDE            PASS MDE IN R1                        03210000
         L     R15,IL6@UDFS       CHECK IF DEACTIVATION IS APPROPRIATE  03220000
         BASR  R14,R15            LINK TO ROUTINE                       03230000
         B     RETURN             AND EXIT                              03240000
                                                                        03250000
*---------------------------------------------------------------------- 03260000
* SESSION ASSOCIATED WITH REQUEST COULD NOT BE FOUND                    03270000
*---------------------------------------------------------------------- 03280000
                                                                        03290000
NOSESS   DS    0H                                                       03300000
                                                                        03310000
         $MSG  979,                     "FREE SESSION IGNORED..."      +03320000
               FIELDS=((REQTEXT,L'REQTEXT),                            +03330000
               (IWEY4TKN,4),            SESSION TOKEN                  +03340000
               (IWEY4TKN+4,4))          SESSION TOKEN                   03350000
                                                                        03360000
         B      RETURN                                                  03370000
                                                                        03380000
*---------------------------------------------------------------------- 03390000
* RETURN TO CALLER                                                      03400000
*---------------------------------------------------------------------- 03410000
                                                                        03420000
RETURN   DS    0H                                                       03430000
                                                                        03440000
         BAS   R14,VTAMUNLK       SERIALIZE                             03450000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 03460000
                                                                        03470000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    03480000
                                                                        03490000
*---------------------------------------------------------------------- 03500000
* SUBROUTINE QSESSION - RETURN AN ISESS TO THE FREE SESSION QUEUE       03510000
*                                                                       03520000
* ENTRY            RISESS = ISESS TO BE RETURNED                        03530000
*                  RMDE   = ASSOCIATED MDE ADDRESS                      03540000
*                                                                       03550000
*---------------------------------------------------------------------- 03560000
                                                                        03570000
QSESSION DS    0H                                                       03580000
                                                                        03590000
         STM   R14,R2,SUB0SAVE    SAVE REGISTERS                        03600000
                                                                        03610000
         XC    ISE62RCB,ISE62RCB  ENSURE NO RCB POINTER                 03620000
         XC    ISE62ENT,ISE62ENT  ENSURE NO ENTITY TOKEN                03630000
         ICM   R1,15,ISE62FSN     IS SESSION ALREADY ON FREE Q?         03640000
         BNZ   QEXIT              EXIT IF YES                           03650000
         TM    ISEF2,ISEF2WIN     IS THIS A CONWINNER?                  03660000
         BNO   QLOSER             BRANCH IF NOT                         03670000
                                                                        03680000
*                                                                       03690000
* QUEUE CONWINNER AT THE FRONT                                          03700000
*---------------------------------------------------------------------- 03710000
                                                                        03720000
         L     R14,MDEFS1ST                                             03730000
         L     R15,ISE62FSP-ISESS(,R14)                                 03740000
         STM   R14,R15,ISE62FSN                                         03750000
         ST    RISESS,ISE62FSP-ISESS(,R14)                              03760000
         ST    RISESS,ISE62FSN-ISESS(,R15)                              03770000
         B     QEXIT                                                    03780000
                                                                        03790000
*                                                                       03800000
* QUEUE CONLOSER AT THE REAR                                            03810000
*---------------------------------------------------------------------- 03820000
                                                                        03830000
QLOSER   DS    0H                                                       03840000
                                                                        03850000
         L     R15,MDEFSLST                                             03860000
         L     R14,ISE62FSN-ISESS(,R15)                                 03870000
         STM   R14,R15,ISE62FSN                                         03880000
         ST    RISESS,ISE62FSP-ISESS(,R14)                              03890000
         ST    RISESS,ISE62FSN-ISESS(,R15)                              03900000
                                                                        03910000
QEXIT    DS    0H                                                       03920000
                                                                        03930000
         LM    R14,R2,SUB0SAVE    RESTORE REGISTERS                     03940000
         BR    R14                AND RETURN TO CALLER W/R15            03950000
                                                                        03960000
*---------------------------------------------------------------------- 03970000
* SUBROUTINE QWE - QUEUE A WORK ELEMENT TO A GIVEN WORK QUEUE           03980000
*                                                                       03990000
* ENTRY            R14 = RETURN ADDRESS                                 04000000
*                  R1  = WORK ELEMENT ADDRESS                           04010000
*                  R0  = QUEUE ADDRESS                                  04020000
*                                                                       04030000
* RETURNS          R15 = 0 --> QUEUEING WAS SUCCESSFUL                  04040000
*                      = 4 --> QUEUEING FAILED, WORK ELEMENT RELEASED   04050000
*---------------------------------------------------------------------- 04060000
                                                                        04070000
QWE      DS    0H                                                       04080000
                                                                        04090000
         STM   R14,R4,SUB0SAVE    SAVE REGISTERS                        04100000
         LR    R3,R0              SAVE QUEUE ADDRESS                    04110000
         LR    R4,R1              SAVE WORK ELEMENT ADDRESS             04120000
                                                                        04130000
         $VTAMQ (R4),             WORK ELEMENT                         +04140000
               (R3)               QUEUE                                 04150000
                                                                        04160000
         L     R14,SUB0SAVE       RESTORE REGISTERS                     04170000
         LM    R0,R4,SUB0SAVE+8   RESTORE REGISTERS                     04180000
         BR    R14                AND RETURN TO CALLER W/R15            04190000
                                                                        04200000
*---------------------------------------------------------------------- 04210000
*   SUBROUTINE: POST THE REQUEST (R0 CONTAINS POSTCODE)                 04220000
*---------------------------------------------------------------------- 04230000
                                                                        04240000
POSTREQ  DS    0H                                                       04250000
                                                                        04260000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             04270000
                                                                        04280000
         L62POST *AQEEPB,         ADDRESS OF EPB TO BE POSTED          +04290000
               SUB0SAVE+8,        ADDRESS OF POST CODE                 +04300000
               AQEENT,            ADDRESS OF ENTITY TOKEN              +04310000
               L62RETCD,          RETURN CODE AREA                     +04320000
               MF=(E,L62MFL)                                            04330000
                                                                        04340000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          04350000
         BR    R14                  RETURN                              04360000
                                                                        04370000
*---------------------------------------------------------------------- 04380000
*   SUBROUTINE: FREE THE AQE                                            04390000
*---------------------------------------------------------------------- 04400000
                                                                        04410000
FREEAQE  DS    0H                                                       04420000
                                                                        04430000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             04440000
                                                                        04450000
         $RETSTOR (RAQE),                                              +04460000
               OWNER=(RITASK)                                           04470000
                                                                        04480000
         SR    RAQE,RAQE            SHOW NO AQE                         04490000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          04500000
         BR    R14                  RETURN                              04510000
                                                                        04520000
*---------------------------------------------------------------------- 04530000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 04540000
*---------------------------------------------------------------------- 04550000
                                                                        04560000
VTAMLOCK DS    0H                                                       04570000
                                                                        04580000
         TM    FLAG,FLAGLOCK        WAS THE LOCK ALREADY OBTAINED?      04590000
         BOR   R14                  RETURN IF YES                       04600000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             04610000
                                                                        04620000
         $SER  OBTAIN,                                                 +04630000
               VTAM                                                     04640000
                                                                        04650000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              04660000
         BNE   VTAMLOEX             BRANCH IF NOT                       04670000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         04680000
                                                                        04690000
VTAMLOEX DS    0H                                                       04700000
                                                                        04710000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               04720000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          04730000
         BR    R14                  RETURN                              04740000
                                                                        04750000
*---------------------------------------------------------------------- 04760000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                04770000
*---------------------------------------------------------------------- 04780000
                                                                        04790000
VTAMUNLK DS    0H                                                       04800000
                                                                        04810000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       04820000
         BNOR  R14                  BRANCH IF NOT                       04830000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             04840000
         BOR   R14                  DON'T RELEASE IF IT WAS             04850000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             04860000
                                                                        04870000
         $SER  RELEASE,                                                +04880000
               VTAM                                                     04890000
                                                                        04900000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  04910000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          04920000
         BR    R14                  RETURN                              04930000
                                                                        04940000
*---------------------------------------------------------------------- 04950000
*   SUBROUTINE: OBTAIN DISP GLOBAL LOCK                                 04960000
*---------------------------------------------------------------------- 04970000
                                                                        04980000
DISPLOCK DS    0H                                                       04990000
                                                                        05000000
         TM    FLAG,FLAGDLCK        WAS THE LOCK ALREADY OBTAINED?      05010000
         BOR   R14                  RETURN IF YES                       05020000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             05030000
                                                                        05040000
         $SER  OBTAIN,                                                 +05050000
               DISP                                                     05060000
                                                                        05070000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              05080000
         BNE   DISPLOEX             BRANCH IF NOT                       05090000
         OI    FLAG,FLAGDLKD        REMEMBER LOCK HELD ON ENTRY         05100000
                                                                        05110000
DISPLOEX DS    0H                                                       05120000
                                                                        05130000
         OI    FLAG,FLAGDLCK        REMEMBER LOCK IS HELD               05140000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          05150000
         BR    R14                  RETURN                              05160000
                                                                        05170000
*---------------------------------------------------------------------- 05180000
*   SUBROUTINE: RELEASE DISP GLOBAL LOCK                                05190000
*---------------------------------------------------------------------- 05200000
                                                                        05210000
DISPUNLK DS    0H                                                       05220000
                                                                        05230000
         TM    FLAG,FLAGDLCK        IS LOCK HELD?                       05240000
         BNOR  R14                  BRANCH IF NOT                       05250000
         TM    FLAG,FLAGDLKD        WAS LOCK HELD ON ENTRY?             05260000
         BOR   R14                  DON'T RELEASE IF IT WAS             05270000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             05280000
                                                                        05290000
         $SER  RELEASE,                                                +05300000
               DISP                                                     05310000
                                                                        05320000
         NI    FLAG,255-FLAGDLCK    SHOW LOCK NOT HELD                  05330000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          05340000
         BR    R14                  RETURN                              05350000
                                                                        05360000
*---------------------------------------------------------------------- 05370000
* ERROR ROUTINES                                                        05380000
*---------------------------------------------------------------------- 05390000
                                                                        05400000
ERRENVIR DS    0H                                                       05410000
                                                                        05420000
         $ABEND ABE_VTDIAG,                                            +05430000
               SCOPE=PCB,                                              +05440000
               TITLE='ENVIRONMENT ERROR'                                05450000
                                                                        05460000
*---------------------------------------------------------------------- 05470000
*  CONSTANTS AND LITERALS                                               05480000
*---------------------------------------------------------------------- 05490000
                                                                        05500000
REQTEXT  DC    C'FREE-SESSION'                                          05510000
                                                                        05520000
         LTORG ,                                                        05530000
         PRINT NOGEN                                                    05540000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                05550000
         ISTDBIND ,               VTAM BIND IMAGE                       05560000
         TRACODES ,               INTEGRATOR TRACE CODES                05570000
         ICVT  ,                  INTEGRATOR CVT                        05580000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   05590000
         IRPL ,                   INTEGRATOR VTAM RPL+                  05600000
         IACB ,                   INTEGRATOR VTAM ACB+                  05610000
         INIB ,                   INTEGRATOR VTAM NIB+                  05620000
         ISESS ,                  INTEGRATOR SESSION BLOCK              05630000
         IRQE ,                   INTEGRATOR RECEIVE QUEUE ELEMENT      05640000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            05650000
         ITASK ,                  INTEGRATOR TASK BLOCK                 05660000
         IPCB ,                   INTEGRATOR PROCESS BLOCK              05670000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          05680000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       05690000
         EVCODES ,                INTEGRATOR EVENT CODES                05700000
         ABCODES ,                INTEGRATOR $ABEND CODES               05710000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     05720000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        05730000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             05740000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             05750000
         $WULOC DSECT=YES         INTEGRATOR $WULOC SERVICES            05760000
         IFGEXLST ,               VTAM EXIT LIST                        05770000
         END   ,                                                        05780000

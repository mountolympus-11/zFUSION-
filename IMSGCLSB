IMSGCLSB TITLE '- MESSAGE CLASS TABLE INITIAL BUILD'                    00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: IMSGCLSB - Message class table initial build                 00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine constructs a table relating message class             00080000
*    codes to message suppression and destination attributes.           00090000
*    The input consists of a table of message definitions               00100000
*    mapped by MSGCLASS.  Each entry in the class summary               00110000
*    table constructed is mapped by MSGCENTt. In the summary,           00120000
*    the location of each class entry can be calculated directly        00130000
*    from the alphabetic class code provided.                           00140000
*                                                                       00150000
*    Class definitions that contain invalid class codes (valid          00160000
*    class codes are upper case alphabetics) as well as those           00170000
*    definitions that duplicate definitions previously                  00180000
*    encountered are flagged via console messages.                      00190000
*                                                                       00200000
*    As a debugging aid, if this routine discovers that it is           00210000
*    executing in a TSO address space, all $CONSOLE message             00220000
*    destinations are replaced with $JOBLOG, suppressing unwanted       00230000
*    MCS console traffic in test environments.                          00240000
*                                                                       00250000
*                                                                       00260000
* NOTES:                                                                00270000
*                                                                       00280000
*    This routine acquires control very early in the intialization      00290000
*    sequence, particularly before the journal files are available.     00300000
*    Thus, any messages produced by this routine are directed to        00310000
*    JOBLOG.                                                            00320000
*                                                                       00330000
*                                                                       00340000
* ON ENTRY:                                                             00350000
*                                                                       00360000
*    R1 - addr of initial message class defaults table                  00370000
*                                                                       00380000
* ON EXIT:                                                              00390000
*                                                                       00400000
*    R15 contains one of the following return codes                     00410000
*                                                                       00420000
*        RC00 - table construction completed                            00430000
*        RC04 - message class errors noted                              00440000
*                                                                       00450000
**<DOC-OFF>****************************************************         00460000
                                                                        00470000
         EJECT                                                          00480000
***************************************************************         00490000
*                                                                       00500000
* MAINTENANCE:                                                          00510000
*                                                                       00520000
*    05/01/93 R. TURGEON                                                00530000
*             Initial version                                           00540000
*                                                                       00550000
*    03/21/95 R. TURGEON  - HELPDESK                                    00560000
*             Implemented LCLMON= facility used to suppress             00570000
*             communications trace messages from local message          00580000
*             monitoring                                                00590000
*                                                                       00600000
***************************************************************         00610000
                                                                        00620000
         EJECT                                                          00630000
         #WORK ,                                                        00640000
                                                                        00650000
FLAGS    DS    X             FLAG BYTE                                  00660000
FTSO     EQU   X'80'            TSO ADDRESS SPACE                       00670000
                                                                        00680000
MSGDEST  DS    X             MESSAGE DESTINATIONS                       00690000
                                                                        00700000
RC       DS    F             RETURN CODE MAINTENANCE                    00710000
WK256    DS    XL256         WORKAREA / PLIST CONSTRUCTION              00720000
         #ENDWORK ,          END WORKAREA                               00730000
                                                                        00740000
         EJECT                                                          00750000
         $MCLASS DSECT=YES   GENERATE DEFINITION AND ENTRY MAPPINGS     00760000
                                                                        00770000
         EJECT                                                          00780000
         ABCODES ,           $ABEND CODES                               00790000
                                                                        00800000
         EQUS  LINKAGE=COND                                             00810000
                                                                        00820000
         $MSGDFT PREFIX=ICTPID,COMPID='MSG',TABLE=*=V(IMSGS),          X00830000
               CONID=*ICTCONID,CONNAME=ICTCONNM,                       X00840000
               DEST=MSGDEST,                                           X00850000
               MF=(E,WK256),                                           X00860000
               PRINT=NOGEN                                              00870000
                                                                        00880000
         EJECT                                                          00890000
IMSGCLSB #ENTER PREG=R8                                                 00900000
                                                                        00910000
         USING ITASK,R10                                                00920000
                                                                        00930000
*--------------------------------------------------------------         00940000
*   SELECT ADDITIONAL MESSAGE DESTINATIONS FOR DEBUG ENVIRONS           00950000
*--------------------------------------------------------------         00960000
         MVI   MSGDEST,$JOBLOG+$CONSOLE                                 00970000
                                                                        00980000
         TM    ICTSTAT2,ICT2$TSO       EXECUTING IN A TSO ADDRSPC?      00990000
         BNO   BLDTABLE                SKIP IF NOT                      01000000
                                                                        01010000
         OI    FLAGS,FTSO              NOTE EXEC ENVIRONMENT            01020000
         MVI   MSGDEST,$JOBLOG         NO UNWANTED CONSOLE TRAFFIC      01030000
                                                                        01040000
*--------------------------------------------------------------         01050000
*   ACQUIRE STORAGE FOR MODIFIABLE MESSAGE CLASS DEFINITIONS            01060000
*--------------------------------------------------------------         01070000
BLDTABLE DS    0H                                                       01080000
         USING MSGCLASS,R8             STATIC MSG DEF ARRARY            01090000
                                                                        01100000
         LA    R2,C'Z'-C'A'+1+1        A-Z PLUS DEFAULT                 01110000
         MH    R2,=AL2(MSGCSLN)        TOTAL SPACE REQUIRED             01120000
                                                                        01130000
         $GETSTOR (R2)                 ACQUIRE LONG TERM STORAGE        01140000
                                                                        01150000
         LR    R4,R1                   MESSAGE CLASS SUMMARY            01160000
                                                                        01170000
*--------------------------------------------------------------         01180000
*   CLASS SUMMARY ENTRIES DIRECTLY ADDRESSED BY CLASS CODE              01190000
*--------------------------------------------------------------         01200000
NXTCLASS DS    0H                                                       01210000
         LR    R5,R4                   REFRESH CLASS SUMMARY BASE       01220000
         USING MSGCSENT,R5             MESSAGE SUMMARY ENTRY            01230000
                                                                        01240000
         CLI   MSGCLCOD,C' '           DEFAULT ENTRY?                   01250000
         BE    SUMMRIZE                CREATE SUMMARY ENTRY             01260000
         CLI   MSGCLCOD,C'A'           CLASS CODE ACCEPTABLE?           01270000
         BL    WRNCODE                 REJECT IF NOT                    01280000
         CLI   MSGCLCOD,C'Z'                                            01290000
         BNH   ACCEPT                                                   01300000
                                                                        01310000
WRNCODE  DS    0H                                                       01320000
         $MSG  001,FIELDS=(MSGCLNAM,MSGCLCOD)                           01330000
                                                                        01340000
         MVC   RC,=A(RC04)             RETAIN WARINING SEVERITY         01350000
         B     ADVANCE                 TRY AGAIN                        01360000
                                                                        01370000
*--------------------------------------------------------------         01380000
*   MESSAGE CLASS DEFINITION CONTAINS EXPLICIT NAME / CODE              01390000
*--------------------------------------------------------------         01400000
ACCEPT   DS    0H                                                       01410000
         SR    R3,R3                   PREPARE FOR INSERT               01420000
         IC    R3,MSGCLCOD             FETCH CODE                       01430000
         SH    R3,=AL2(C'A')           CONVERT CHAR TO INDEX            01440000
         MH    R3,=AL2(MSGCSLN)        OFFSET TO ENTRY                  01450000
         LA    R5,MSGCSENT+MSGCSLN(R3) ADDRESS OF ENTRY                 01460000
                                                                        01470000
         ICM   R15,1,MSGCSCOD          CLASS PREVIOUSLY DEFINED         01480000
         BZ    SUMMRIZE                SKIP IF NOT                      01490000
                                                                        01500000
         $MSG  002,FIELDS=(MSGCLNAM,MSGCLCOD)                           01510000
                                                                        01520000
         MVC   RC,=A(RC04)             RETAIN WARINING SEVERITY         01530000
         B     ADVANCE                                                  01540000
                                                                        01550000
*--------------------------------------------------------------         01560000
*   EXTRACT MESSAGE DEFINITION TO CREATE MODIFIABLE SUMMARY             01570000
*--------------------------------------------------------------         01580000
SUMMRIZE DS    0H                                                       01590000
         MVC   MSGCSCOD,MSGCLCOD       CLASS CODE                       01600000
         MVC   MSGCSACT,MSGCLACT       ACTIVE STATUS                    01610000
         MVC   MSGCSDST,MSGCLDST       DESTINATION INFO                 01620000
         MVC   MSGCSMON,MSGCLMON       LOCAL MSG MONITOR ELIGIBILITY    01630000
                                                                        01640000
         TM    FLAGS,FTSO              TSO (DEBUG) ENVIRONMENT?         01650000
         BNO   ADVANCE                 PRODUCTION PRODUCT OTHERWISE     01660000
                                                                        01670000
         TM    MSGCSDST,$CONSOLE       CONSOLE DESTINATION?             01680000
         BNO   ADVANCE                 SKIP IF NOT                      01690000
                                                                        01700000
         NI    MSGCSDST,FF-$CONSOLE    REMOVE CONSOLE DEST              01710000
         OI    MSGCSDST,$JOBLOG        REPLACE WITH JOBLOG              01720000
                                                                        01730000
*--------------------------------------------------------------         01740000
*   PROCESS ALL CLASS DEFINITIONS                                       01750000
*--------------------------------------------------------------         01760000
ADVANCE  DS    0H                                                       01770000
         CLI   MSGCLCOD,C' '           LAST DEFINITION PROCESSED?       01780000
         BE    FIN                     DONE IF SO                       01790000
                                                                        01800000
         LA    R8,MSGCLASS+MSGCLSLN    ADVANCE TO NEXT DEFINITION       01810000
         B     NXTCLASS                AND SUMMARIZE                    01820000
                                                                        01830000
*--------------------------------------------------------------         01840000
*   NORMAL AND ABNORMAL COMPLETION                                      01850000
*--------------------------------------------------------------         01860000
FIN      DS    0H                                                       01870000
         ST    R4,ICTMSGCL             MESSAGE PROPERTIES TABLE         01880000
         L     R15,RC                  RETURN CODE                      01890000
                                                                        01900000
         #EXIT ,                                                        01910000
                                                                        01920000
         EJECT                                                          01930000
***************************************************************         01940000
*                                                                       01950000
*   LOCAL READ/ONLY DATA AREAS, ETC.                                    01960000
*                                                                       01970000
***************************************************************         01980000
         LTORG ,                                                        01990000
                                                                        02000000
         PRINT NOGEN                                                    02010000
         ITASK ,                                                        02020000
         ICVT  ,                                                        02030000
         END   ,                                                        02040000

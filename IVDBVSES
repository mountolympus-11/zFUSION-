IVDBVSES TITLE '- RETURN VDB SESSION STATUS'                            00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE: IVDBVSES - Return VDB session status                         00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine is used to return the status of all SLU               00080000
*    sessions currently maintained in the AAP queue.  Space is          00090000
*    first allocated in the TXP buffer.  Then, a VSDESC entry           00100000
*    is formatted in the acquired area for each AAP registered          00110000
*    on the IUSER.USRAPPLQ.                                             00120000
*                                                                       00130000
*                                                                       00140000
* ON ENTRY:                                                             00150000
*                                                                       00160000
*    R1  address of the query content summary (QCS)                     00170000
*                                                                       00180000
*                                                                       00190000
* ON EXIT:                                                              00200000
*                                                                       00210000
*    R15 contains one of the following return codes                     00220000
*                                                                       00230000
*       RC00 - request completed without error                          00240000
*                                                                       00250000
*              R1 - address of vsess description (VSDESC) list          00260000
*                   (in the TXP buffer)                                 00270000
*                                                                       00280000
*              R0 - number of vsess description entries                 00290000
*                                                                       00300000
*       RC08 - environmental error                                      00310000
*                                                                       00320000
**<DOC-OFF>****************************************************         00330000
                                                                        00340000
         EJECT                                                          00350000
***************************************************************         00360000
*                                                                       00370000
* MAINTENANCE:                                                          00380000
*                                                                       00390000
*   01/17/92  R. Turgeon                                                00400000
*             Initial version                                           00410000
*                                                                       00420000
***************************************************************         00430000
                                                                        00440000
         EJECT                                                          00450000
         VSDESC ,            VIRTUAL SESSION DESCRIPTOR                 00460000
                                                                        00470000
         EJECT                                                          00480000
         QCS   ,             QUERY CONTENT SUMMARY                      00490000
                                                                        00500000
         EJECT                                                          00510000
         NAV   ,             NAVIGATIONAL STRUCTURES, INCLUDING AAP     00520000
                                                                        00530000
         EJECT                                                          00540000
         IUSER ,             USER INFO                                  00550000
                                                                        00560000
         EJECT                                                          00570000
         AAP#  DSECT=YES     AAP SCAN SERVICE                           00580000
                                                                        00590000
         EJECT                                                          00600000
         #WORK ,                                                        00610000
                                                                        00620000
VCOUNT   DS    F             AAP COUNT                                  00630000
VORIGIN  DS    A             VSDESC RETURN AREA (WITHIN TXP BUFFER)     00640000
VLAST    DS    A             VSDESC OF LAST AAP VISITED BY PLAN         00650000
                                                                        00660000
         #ENDWORK ,          END OF WORKAREA                            00670000
                                                                        00680000
         EJECT                                                          00690000
         EQUS  ,                                                        00700000
                                                                        00710000
         EJECT                                                          00720000
IVDBVSES #ENTER PREG=R8                                                 00730000
                                                                        00740000
         USING ITASK,R10                                                00750000
                                                                        00760000
         EJECT                                                          00770000
***************************************************************         00780000
*                                                                       00790000
*   General initialization, acquire AAP count                           00800000
*                                                                       00810000
***************************************************************         00820000
                                                                        00830000
         USING QCS,R8             LIFE OF FUNCTION                      00840000
                                                                        00850000
         L     R7,QCSIUSER        LOCATE IUSER                          00860000
         USING IUSER,R7           LIFE OF FUNCTION                      00870000
                                                                        00880000
         AAP#  ALL,IUSER=(R7)     NUMBER OF AAPS                        00890000
                                                                        00900000
         ST    R0,VCOUNT          RETAIN AAP COUNT                      00910000
         LTR   R2,R0              ANY AAPS?                             00920000
         BZ    NORMRET            DONE IF NONE                          00930000
                                                                        00940000
*--------------------------------------------------------------         00950000
*   Allocate TXP buffer extent, one VSDESC for each AAP                 00960000
*--------------------------------------------------------------         00970000
                                                                        00980000
         MH    R2,=AL2(VSDESCLN)  TOTAL VSDESC REQUIREMENT              00990000
                                                                        01000000
         $XPBUFR ISRT,DATALEN=(R2),EXPAND=YES                           01010000
         BNZ   ERR_ENV                                                  01020000
                                                                        01030000
         ST    R1,VORIGIN         VSDESC ARRAY ORIGIN                   01040000
                                                                        01050000
*--------------------------------------------------------------         01060000
*   Format a VSDESC entry for each AAP enqueued                         01070000
*--------------------------------------------------------------         01080000
                                                                        01090000
         LR    R4,R1              LOCATE DATA AREA                      01100000
         USING VSDESC,R4          PREPARE TO FORMAT RETURN INFO         01110000
                                                                        01120000
         L     R5,USRAPPLQ        SCAN AAP QUEUE                        01130000
         USING AAP,R5                                                   01140000
                                                                        01150000
NEXTAAP  DS    0H                                                       01160000
         MVC   VSDAPPL,AAPANAME   APPLICATION NAME                      01170000
         MVC   VSDSTATE,AAPCSTNM  STATE NAME IF SESSION IS UP           01180000
                                                                        01190000
         MVI   VSDSESS,TRUE       ASSUME SESSION IS RUNNING             01200000
         ICM   R0,15,AAPCURR      CURRENT STATE (STN) IDENTIFIED?       01210000
         BZ    VTAMAAP            ELSE NOT YET UP OR GOING DOWN         01220000
         TM    AAPFLAG1,AAPFTERM  SESSION DOWN OR GOING DOWN?           01230000
         BNO   TERMAAP            SKIP IF NOT                           01240000
                                                                        01250000
VTAMAAP  DS    0H                                                       01260000
         MVI   VSDSESS,FALSE      SESSION NOT RUNNING                   01270000
         MVC   VSDSTATE,=CL16'*VTAM*'                                   01280000
                                                                        01290000
TERMAAP  DS    0H                                                       01300000
         CLI   QCSTTYPE,QCST_VDB  VDB DIRECTED REQUEST?                 01310000
         BNE   RANAAP             SKIP IF NOT                           01320000
         TM    QCSEFLG2,QCS2_NXE  EXECUTION SUPPRESSED?                 01330000
         BO    RANAAP             NO CONCEPT OF CURRENT STATE OTHERWISE 01340000
         TM    AAPFLAG1,AAPFRAN   SESSION DRIVEN BY VDB SQL?            01350000
         BNO   RANAAP             SKIP IF NOT                           01360000
                                                                        01370000
         ST    R4,VLAST           RETAIN PTR TO LAST KNOWN 'RUN' ENTRY  01380000
                                                                        01390000
RANAAP   DS    0H                 INSPECT ALL AAPS                      01400000
         LA    R4,VSDESCLN(,R4)   ADVANCE TO NEXT VSDESC SLOT           01410000
         ICM   R5,15,AAPNEXT      ADVANCE TO NEXT AAP                   01420000
         BNZ   NEXTAAP            AGAIN                                 01430000
                                                                        01440000
*--------------------------------------------------------------         01450000
*   Identify AAP / state last visited by VDB plan                       01460000
*--------------------------------------------------------------         01470000
                                                                        01480000
         ICM   R4,15,VLAST        LAST ENTRY POSTED?                    01490000
         BZ    *+8                SKIP IF NOT                           01500000
         MVI   VSDLAST,TRUE       FLAG LAST AAP                         01510000
         DROP  R4,R5              VSDESC, AAP                           01520000
                                                                        01530000
***************************************************************         01540000
*                                                                       01550000
*   Return to caller                                                    01560000
*                                                                       01570000
***************************************************************         01580000
                                                                        01590000
NORMRET  DS    0H                 FUNCTION COMPLETE                     01600000
         LA    R15,RC00           INDICATE SUCCESS                      01610000
         B     RETURN                                                   01620000
                                                                        01630000
ERR_ENV  DS    0H                 ENVIRONMENTAL ERROR                   01640000
         LA    R15,RC08           INDICATE SUCCESS                      01650000
                                                                        01660000
RETURN   DS    0H                                                       01670000
         L     R0,VCOUNT          R0 <== NUMBER OF APPLS DESCRIBED      01680000
         L     R1,VORIGIN         R1 <== VSDESC ARRAY ORIGIN            01690000
                                                                        01700000
         #EXIT ,                                                        01710000
                                                                        01720000
***************************************************************         01730000
*                                                                       01740000
*   Local read-only data areas                                          01750000
*                                                                       01760000
***************************************************************         01770000
                                                                        01780000
         LTORG ,                                                        01790000
                                                                        01800000
         PRINT NOGEN                                                    01810000
         ICVT  ,                                                        01820000
         ITASK ,                                                        01830000
         END   ,                                                        01840000

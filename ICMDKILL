ICMDKILL TITLE 'ICMDKILL - KILL ITASK CMDPROC'                          00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: ICMDKILL - KILL ITASK CMDPROC                                00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THIS ROUTINE PROCESSES THE 'KILL' COMMAND WHICH IS USED            00080000
*    TO ABEND THE NAMED TASK.  A DUMP IS EITHER TAKEN OR                00090000
*    SUPPRESSED DEPENDING ON THE USE OF THE DUMP/NODUMP                 00100000
*    OPERAND.  DUMP IS THE DEFAULT.                                     00110000
*                                                                       00120000
* RESTRICTIONS:                                                         00130000
*                                                                       00140000
*    THE 'KILL' COMMAND IS AVAILABLE IN APF-AUTHORIZED                  00150000
*    ENVIRONMENTS ONLY.                                                 00160000
*                                                                       00170000
* METHOD:                                                               00180000
*                                                                       00190000
*    1) VALIDATE OPERANDS                                               00200000
*    2) SCHEDULE THE KILL ROUTINE AGAINST THE NAMED TASK                00210000
*    3) SUPPRESS STANDARD COMPLETION MESSAGES                           00220000
*                                                                       00230000
* SYNTAX:                                                               00240000
*                                                                       00250000
*    KILL     TASK(<TASKNAME>) íDUMP/NODUMPù                            00260000
*                                                                       00270000
* ON ENTRY:                                                             00280000
*                                                                       00290000
*    R1  ADDR OF COMMAND REQUEST BLOCK (CMDREQ) IN LOCAL                00300000
*        CMDPROC FORMAT                                                 00310000
*                                                                       00320000
**<DOC-OFF>****************************************************         00330000
                                                                        00340000
***************************************************************         00350000
*                                                                       00360000
* MAINTENANCE:                                                          00370000
*                                                                       00380000
*    07/10/94 R. TURGEON                                                00390000
*             INITIAL VERSION                                           00400000
*                                                                       00410000
*    02/06/95 R. COLMONE                                                00420000
*             ADDED SUPPORT FOR ITASK RUNNING IN A SERVER               00430000
*             TASK ENVIRONMENT.                                         00440000
*                                                                       00450000
***************************************************************         00460000
                                                                        00470000
         #WORK ,             BEGIN WORKAREA                             00480000
DUMPOPT  DS    X             TRUE IF DUMP/NODUMP SPECIFIED              00490000
DUMP     DS    X             TRUE IF DUMP REQUESTED                     00500000
*                                                                       00510000
         DS    0F            FORCE ALIGNMENT                            00520000
TASKNAME DS    CL8           TASK() DESIGNATION                         00530000
                                                                        00540000
REGSAVE  DS    16F           LOCAL ROUTINE SAVEAREA                     00550000
                                                                        00560000
MSGLIST  $MSG  FIELDS=(,,,,),MF=L $MSG PLIST CONSTRUCTION AREA          00570000
         #ENDWORK ,          END WORKAREA                               00580000
                                                                        00590000
         EJECT                                                          00600000
         $ASYEXIT DSECT=YES  ASYNC EXIT SCHEDULER PLIST                 00610000
                                                                        00620000
         EJECT                                                          00630000
         CMDREQ  ,           COMMAND REQUEST BLOCK                      00640000
                                                                        00650000
         EJECT                                                          00660000
         CCSUMRY ,           COMMAND OPERAND PREPARSE SUMMARY           00670000
                                                                        00680000
         EJECT                                                          00690000
         KEYCODES COMMANDSET=KILL                                       00700000
*                                                                       00710000
         CMDCODES ,                                                     00720000
*                                                                       00730000
         EQUS  ,                                                        00740000
                                                                        00750000
         $MSGDFT PREFIX=ICTPID,COMPID='CMD',TABLE=*#MSGS,              X00760000
               CONID=*CMRQCNID,CONNAME=CMRQCNAM,CART=CMRQCART,         X00770000
               DESTADD=*CMRQDMSK,                                      X00780000
               MF=(E,MSGLIST),                                         X00790000
               PRINT=NOGEN                                              00800000
                                                                        00810000
         EJECT                                                          00820000
ICMDKILL #ENTER PREG=R8                                                 00830000
                                                                        00840000
         USING ICVT,R11                                                 00850000
         USING ITASK,R10                                                00860000
                                                                        00870000
*--------------------------------------------------------------         00880000
*    LOCATE COMMAND REQUEST BLOCK, COMMAND SUMMARY, AND OPS             00890000
*--------------------------------------------------------------         00900000
         USING CMDREQ,R8          COMMAND REQUEST BLOCK                 00910000
         ICM   R7,15,CMRQSMRY     ASSOC COMMAND SUMMARY                 00920000
         BZ    ANALYZE            AMBIGUOUS REQUEST                     00930000
         USING CCSUMRY,R7         COMMAND OPERAND SUMMARY FORMAT        00940000
         ICM   R5,15,CMRQSMR#     TOTAL NUMBER OF OPERAND ENTRIES       00950000
         BZ    ANALYZE            AMBIGUOUS REQUEST IF ZERO             00960000
         L     R6,CMRQOPST        OPERAND STRING ORIGIN                 00970000
                                                                        00980000
*--------------------------------------------------------------         00990000
*   IDENTIFY THE OPERANDS PROVIDED AND VALIDATE                         01000000
*--------------------------------------------------------------         01010000
PARSENXT DS    0H                                                       01020000
         LA    R1,KILL_TASK       SPECIFIC TASK                         01030000
         CH    R1,CCSID           CURRENT KEYWORD?                      01040000
         BE    TASKKEY            BREAK IF SO                           01050000
                                                                        01060000
         LA    R0,TRUE            ASSUME DUMP REQUESTED                 01070000
         LA    R1,KILL_DUMP       DUMP REQUEST                          01080000
         CH    R1,CCSID           CURRENT KEYWORD?                      01090000
         BE    DUMPKEY            BREAK IF SO                           01100000
                                                                        01110000
         LA    R0,FALSE           ASSUME DUMP SUPPRESSED                01120000
         LA    R1,KILL_NODUMP     DUMP SUPPRESSION                      01130000
         CH    R1,CCSID           CURRENT KEYWORD?                      01140000
         BE    DUMPKEY            BREAK IF SO                           01150000
                                                                        01160000
         B     ERREJECT           REJECT OTHERWISE                      01170000
                                                                        01180000
*--------------------------------------------------------------         01190000
*   POST SENTINELS AND VALUES FOR MAJOR AND MINOR KEYS FOUND            01200000
*--------------------------------------------------------------         01210000
DUMPKEY  DS    0H                                                       01220000
         CLI   DUMPOPT,TRUE       DUMP OPTION PREVIOUSLY SELECTED?      01230000
         BE    ERRCNFLC           CONFLICTING OPERANDS OTHERWISE        01240000
         MVI   DUMPOPT,TRUE       DUMP OPTION PREVIOUSLY SELECTED?      01250000
         STC   R0,DUMP            POST REQUEST TYPE                     01260000
         B     ADVANCE            ADVANCE TO NEXT OPERAND               01270000
                                                                        01280000
TASKKEY  DS    0H                                                       01290000
         CLI   TASKNAME,0         TASK NAME PREVIOUSLY SPECIFIED?       01300000
         BNE   ERRCNFLC           CONFLICTING OPERANDS IF SO            01310000
                                                                        01320000
         CLC   CCSVALCT,=H'1'     SINGLE VALUE?                         01330000
         BNE   ERRSYNTX           SYNTAX PROBLEM OTHERWISE              01340000
         LH    R2,CCSVLEN         FETCH VALUE LENGTH                    01350000
         LTR   R2,R2              LENGTH OF STRING                      01360000
         BNP   ERRSYNTX           SYNTAX ERROR                          01370000
         CH    R2,=AL2(L'TASKNAME)   CORRECT LENGTH?                    01380000
         BH    ERRSYNTX           ERROR IF NOT                          01390000
                                                                        01400000
         MVC   TASKNAME,BLANKS    BLANK PAD                             01410000
         L     R3,CCSVDISP        OFFSET TO TASKNAME IN CMD LINE        01420000
         AR    R3,R6              CONVERT OFFSET TO ADDRESS             01430000
         BCTR  R2,0               PREPARE FOR EX                        01440000
         EX    R2,*+4             LOCAL COPY OF TASKNAME                01450000
         MVC   TASKNAME(*-*),0(R3)                                      01460000
                                                                        01470000
*--------------------------------------------------------------         01480000
*   PROCESS ALL KEYWORDS, VALIDATE REQUEST COMPLETENESS                 01490000
*--------------------------------------------------------------         01500000
ADVANCE  DS    0H                                                       01510000
         LA    R15,CCSVSLN        LENGTH OF EACH VALUE ENTRY            01520000
         MH    R15,CCSVALCT       TOTAL SIZE CONSUMED BY VALUES         01530000
         LA    R7,CCSUMRY+CCSPFXL(R15)                                  01540000
         BCT   R5,PARSENXT        EXAMINE ALL OPERANDS                  01550000
                                                                        01560000
ANALYZE  DS    0H                                                       01570000
         CLI   TASKNAME,0         TASKNAME OPERAND PROVIDED?            01580000
         BE    ERRAMBIG           AMBIGUOUS REQUEST IF NOT              01590000
         CLI   DUMPOPT,TRUE       DUMP/NODUMP SPECIFIED?                01600000
         BE    *+8                EXPLICIT DUMP OPTION ACCEPTED         01610000
         MVI   DUMP,TRUE          DUMP BY DEFAULT                       01620000
         DROP  R7                 CCSUMRY                               01630000
                                                                        01640000
         EJECT                                                          01650000
***************************************************************         01660000
*                                                                       01670000
*   SCHEDULE THE KILL ROUTINE (IGENKILL) TO TERMINATE THE               01680000
*   NAMED ITASK                                                         01690000
*                                                                       01700000
***************************************************************         01710000
         SR    R2,R2              PREPARE FOR INSERT                    01720000
         IC    R2,DUMP            DUMP / NODUMP INDICATOR               01730000
                                                                        01740000
         $ASYEXIT TASKNAME=TASKNAME,                                   X01750000
               EP=*#GENKILL,                                           X01760000
               PARAM=((R2),*TASKNAME,*TASKNAME+4),               159456X01770000
               MF=(E,MFE_LIST)                                          01780000
                                                                        01790000
         B     *+4(R15)           ANALYZE COMPLETION STATUS             01800000
         B     NORMRET               RC00 - EXIT SCHEDULED              01810000
         B     ERRAUTH               RC04 - AUTHORIZATION REQUIRED      01820000
         B     ERRWU                 RC08 - ITASK NOT FOUND             01830000
         B     ERRSERV               RC12 - MVS SERVICE FAILURE         01840000
                                                                        01850000
         EJECT                                                          01860000
***************************************************************         01870000
*                                                                       01880000
*   RETURN COMPLETION STATUS TO REQUESTOR                               01890000
*                                                                       01900000
***************************************************************         01910000
NORMRET  DS    0H                                                       01920000
         LA    R15,CCODE_STDCOMP  REQUEST SCHEDULED                     01930000
         B     CMDRET                                                   01940000
                                                                        01950000
ERRSYNTX DS    0H                                                       01960000
         LA    R15,CCODE_SYNTAX   SYNTAX ERROR                          01970000
         B     CMDRET             DONE                                  01980000
                                                                        01990000
ERRAMBIG DS    0H                                                       02000000
         LA    R15,CCODE_AMBIG    AMBIGUOUS REQUEST                     02010000
         B     CMDRET             DONE                                  02020000
                                                                        02030000
ERRCNFLC DS    0H                                                       02040000
         LA    R15,CCODE_CONFLICT CONFLICTING OPERANDS                  02050000
         B     CMDRET             DONE                                  02060000
                                                                        02070000
ERREJECT DS    0H                                                       02080000
         LA    R15,CCODE_REJECT   COMMAND REJECTED                      02090000
         B     CMDRET             DONE                                  02100000
                                                                        02110000
*--------------------------------------------------------------         02120000
*   REQUEST FAILED IN $ASYEXIT SERVICE                                  02130000
*--------------------------------------------------------------         02140000
ERRWU    DS    0H                 NAMED ITASK NOT FOUND                 02150000
         $MSG  071,FIELDS=(TASKNAME)                                    02160000
         B     CMDFAIL                                                  02170000
                                                                        02180000
ERRAUTH  DS    0H                 APF-AUTHORIZATION REQUIRED            02190000
         $MSG  075                                                      02200000
         B     CMDFAIL                                                  02210000
                                                                        02220000
ERRSERV  DS    0H                 $ASYEXIT INTERNAL FAILURE             02230000
         ST    R0,FWORD           SERVICE ROUTINE RETURN CODE           02240000
         LR    R2,R1              SERVICE NAME (CL8)                    02250000
                                                                        02260000
         $MSG  240,FIELDS=(((R2),8),FWORD)                              02270000
                                                                        02280000
         B     CMDFAIL                                                  02290000
                                                                        02300000
CMDFAIL  DS    0H                 REQUEST FAILED                        02310000
         LA    R15,CCODE_FAIL     INDICATE FAILURE                      02320000
                                                                        02330000
*--------------------------------------------------------------         02340000
                                                                        02350000
CMDRET   DS    0H                                                       02360000
         ST    R15,CMRQCOMP       POST COMPLETION CODE PER CONVENTION   02370000
         #EXIT ,                                                        02380000
                                                                        02390000
         EJECT                                                          02400000
***************************************************************         02410000
*                                                                       02420000
*   LOCAL READ/ONLY DATA AREAS, ETC.                                    02430000
*                                                                       02440000
***************************************************************         02450000
BLANKS   DC    CL16' '                                                  02460000
                                                                        02470000
         LTORG ,                                                        02480000
                                                                        02490000
         PRINT NOGEN                                                    02500000
         ICVT  ,                                                        02510000
         ITASK ,                                                        02520000
         IPCB  ,                                                        02530000
         END   ,                                                        02540000

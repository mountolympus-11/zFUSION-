INAVBSTN TITLE '- BUILD STATE TRANSITION NETWORK'                       00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: INAVBSTN - Build State Transition Network (STN)              00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine is used to construct the state transition             00080000
*    network (STN) for the current project that is used to              00090000
*    control SLU session navigation performed on behalf of              00100000
*    run-time requests.  The STN consists of many-to-many               00110000
*    linkages connecting one session state (image, aid key,             00120000
*    cursor position, etc) to the next with all session                 00130000
*    networks usually beginning and ending in VTAM USS,                 00140000
*    depicted here as *VTAM*.                                           00150000
*                                                                       00160000
*    The NAV macro describes all of the blocks used to                  00170000
*    represent the STN. The use of each is summarized below.            00180000
*                                                                       00190000
*                                                                       00200000
*    NVREC   - An NVREC node is constructed for each SYSRECORDING       00210000
*              entry found in the project.  It contains the             00220000
*              application name and logmode and can be used             00230000
*              to acquire all of the information needed to start        00240000
*              a slu session.  An NVREC reference is included           00250000
*              in each successor link attached to the *VTAM*            00260000
*              STN node.                                                00270000
*                                                                       00280000
*              All NVREC nodes that describe recordings made            00290000
*              against the same application/logmode pair are            00300000
*              grouped together so that related screens, variables      00310000
*              etc. can be easily recognized.                           00320000
*                                                                       00330000
*    NVSTN   - This node represents either an application state         00340000
*              or the USS (*VTAM*) state.  Usually, a single            00350000
*              SYSNAVIGATION record results in the construction         00360000
*              or update of two nvstn nodes; one for the                00370000
*              predecessor (S0) state and one for the successor         00380000
*              (S1) state.  These nodes are fixed in length and         00390000
*              are not relocated once constructed.  STN nodes           00400000
*              are chained to each other via the intermediate           00410000
*              NVPRED (predecessor) and NVUSUCC (successor)             00420000
*              linkage arrays.                                          00430000
*                                                                       00440000
*    NVPRED  - The NVPRED block is a variable length structure          00450000
*              used to relate a given state to all of its               00460000
*              immediate predecessors.  There is a single NVPRED        00470000
*              attached to all NVSTN nodes that are reached from        00480000
*              a previously encountered state, including *VTAM*.        00490000
*              the *VTAM* NVSTN node does not have an associated        00500000
*              NVPRED.                                                  00510000
*                                                                       00520000
*    NVUSUCC - The NVUSUCC block is a variable length structure         00530000
*              used to relate a given state to all of its               00540000
*              immediate successors.  There is a unique NVUSUCC         00550000
*              block for each set of successor states                   00560000
*              associated with a unique aid key / conditional           00570000
*              group.                                                   00580000
*                                                                       00590000
*    The STN is built with the assistance of a $ENTITY locator          00600000
*    that is used to acquire the address of an NVREC or NVSTN           00610000
*    mode by recording or screen(set) name, respectively.               00620000
*                                                                       00630000
*                                                                       00640000
* NOTES:                                                                00650000
*                                                                       00660000
*    The navigation state transition network is a multilink             00670000
*    structure that must be serialized while under construction.        00680000
*    the caller must hold the project-instance (MIL) lock.              00690000
*                                                                       00700000
*    SYSRECORDING and SYSNAVIGATION catalog tables are read             00710000
*    using the table tokens contained in the IPROJ.  The tables         00720000
*    are neither opened nor closed in this routine.                     00730000
*                                                                       00740000
*                                                                       00750000
* FUTURES:                                                              00760000
*                                                                       00770000
*    Maintain last screen, screen set, and NVSTN information            00780000
*    to avoid two $ENTITY calls when, generally, only one is            00790000
*    necessary for S1 when:  S0->S1, S1->S2 ...                         00800000
*                                                                       00810000
*                                                                       00820000
* ON ENTRY:                                                             00830000
*                                                                       00840000
*    R1  contains the address of the host IPROJ to which all            00850000
*        navigational structures are attached.  It is assumed           00860000
*        that the navigation storage queue header defined               00870000
*        at IPROJ.PRJEXSTG has been initialized                         00880000
*                                                                       00890000
*                                                                       00900000
* ON EXIT:                                                              00910000
*                                                                       00920000
*    R15 contains one of the following return codes                     00930000
*                                                                       00940000
*        RC00  - navigation network generation complete                 00950000
*                                                                       00960000
*        RC04  - some warnings have been issued that may impact         00970000
*                the usability of the project. Msgs describing          00980000
*                these conditions are returned.                         00990000
*                                                                       01000000
*        RC08  - navigation network generation complete, but            01010000
*                no *VTAM* transitions into (some) application          01020000
*                are defined. Thus, VDB sessions cannot be              01030000
*                established, only continued.                           01040000
*                                                                       01050000
*        RC12  - invalid or conflicting catalog entries                 01060000
*                encountered, consult the reason code and               01070000
*                info code                                              01080000
*                                                                       01090000
*        RC16  - no SYSRECORDING or SYSNAVIGATION entries               01100000
*                available in the given project                         01110000
*                                                                       01120000
*        RC20  - unrecoverable error, consult the reason code           01130000
*                and info code                                          01140000
*                                                                       01150000
*                                                                       01160000
*    R0  contains one of the following reason codes.  If                01170000
*        multiple reasons apply, the reason code is a composite         01180000
*        created by ORing all applicable codes together.                01190000
*                                                                       01200000
*        RSN00 - no execptions noted                                    01210000
*                                                                       01220000
*        RSN04 - at least one invalid SYSRECORDINGs entry               01230000
*                encountered, msgs generated                            01240000
*                                                                       01250000
*        RSN08 - at least one SYSNAVIGATION entry in error              01260000
*                encountered or conflict noted, msgs generated          01270000
*                                                                       01280000
*        RSN16 - region definition warnings/errors noted                01290000
*                                                                       01300000
*        RSN32 - invalid state association entries                      01310000
*                                                                       01320000
*        RSN64 - environmental error or service rtn failure             01330000
*                                                                       01340000
*    R1  contains a return code dependent information code              01350000
*                                                                       01360000
**<DOC-OFF>****************************************************         01370000
                                                                        01380000
         EJECT                                                          01390000
***************************************************************         01400000
*                                                                       01410000
* MAINTENANCE:                                                          01420000
*                                                                       01430000
*    02/XX/93 R. Turgeon                                                01440000
*             Initial version                                           01450000
*                                                                       01460000
*    09/02/94 R. Colmone         PAR# 141172                            01470000
*             Region analysis for screen set is now defered             01480000
*             until the entire SYSNAVIGATION table is                   01490000
*             processed.  This enables screen sets to span              01500000
*             recordings.                                               01510000
*                                                                       01520000
*    11/21/94 Su-fen Wu  - par# 156082                                  01530000
*             Accept clear screen in loadimag (RC04)                    01540000
*                                                                       01550000
*    12/06/94 R. Turgeon                                                01560000
*             Removed PAGE= / SHRPAGE= for $SPACE, $OBJECT,             01570000
*             and TB* service requests                                  01580000
*                                                                       01590000
*    12/15/94 R. Turgeon   par# 160490                           160490 01600000
*             Corrected bad branch after processing of *RESUME*  160490 01610000
*             records that caused <ALL-GROUP> conditional logic  160490 01620000
*             to be bypassed. Also, ordered the successor chain  160490 01630000
*             by AID key then cond group.                        160490 01640000
*                                                                       01650000
*    05/10/95 R. Turgeon   Rel 2.0.0 - Table select                     01660000
*             Identify table selection operations in SYSNAVIGATION.     01670000
*             Reflect in successor linkage entry and summarize          01680000
*             in the STN for ease of identification.                    01690000
*                                                                       01700000
***************************************************************         01710000
                                                                        01720000
         EJECT                                                          01730000
         #WORK ,                  WRITEABLE WORKING STORAGE             01740000
                                                                        01750000
FLAGS    DS    X                  FLAG BYTE                             01760000
F$S0SET  EQU   X'80'                 S0 STATE IS MEMBER OF SCREEN SET   01770000
F$S1SET  EQU   X'40'                 S1 STATE IS MEMBER OF SCREEN SET   01780000
F$S0S1EQ EQU   X'20'                 S0 AND S1 MEMBERS OF SAME SSET     01790000
F$RESUME EQU   X'10'                 *RESUME* RECORDING PRESENT         01800000
F$ALLCND EQU   X'08'                 SET WHEN AN STN <ALL-GROUPS> COND  01810000
*                                    IS POSTED TO SOME NVUSUCC LINKAGE  01820000
F$EONAV  EQU   X'01'                 END OF SYSNAV TABLE ENCOUNTERED    01830000
                                                                        01840000
BYTE     DS    X                  SINGLE BYTE WORKAREA                  01850000
                                                                        01860000
RETCMASK DS    X                  BITS 0-7 REPRESENT RC28-RC00,         01870000
*                                 RESPECTIVELY ALLOWING MAXIMUM RETCODE 01880000
*                                 VALUES TO BE MAINTAINED REGARDLESS OF 01890000
*                                 PRIOR OR SUBSEQUENT POSTINGS          01900000
$RC28    EQU   B'10000000'                                              01910000
$RC24    EQU   B'01000000'                                              01920000
$RC20    EQU   B'00100000'                                              01930000
$RC16    EQU   B'00010000'                                              01940000
$RC12    EQU   B'00001000'                                              01950000
$RC08    EQU   B'00000100'                                              01960000
$RC04    EQU   B'00000010'                                              01970000
$RC00    EQU   B'00000000'                                              01980000
                                                                        01990000
RETCODE  DS    F                  RETURN CODE RETENTION                 02000000
RSNCODE  DS    F                  REASON CODE RETENTION                 02010000
INFCODE  DS    F                  INFO CODE RETENTION                   02020000
                                                                        02030000
CURRECA  DS    A                  ADDR OF 'MAIN' NVREC DEFINING APPL    02040000
CURRECNM DS    CL(L'SNAVSREC)     LAST RECORDING REFERENCED BY SYSNAV   02050000
S1SSET   DS    CL(L'SNAVSSET)     SCREEN SET NAME ASSOC WITH S1         02060000
SSET     DS    CL(L'SNAVSSET)     SCREEN SET NAME, DOCNAV USAGE         02070000
                                                                        02080000
S0PTR    DS    A                  ADDR OF S0 STN                        02090000
S1PTR    DS    A                  ADDR OF S1 STN                        02100000
                                                                        02110000
@ENTITY  DS    A                  ADDR OF NAVIGATION $ENTITY BLOCK      02120000
@SYSNAV  DS    A                  ADDR OF CURRENT SYSNAVIGATION ENTRY   02130000
@STNBSTN DS    A                  STNBLD - LAST NVSTN RETURNED          02140000
                                                                        02150000
ALGRPANC DS    A                  CONDLINK - ADDR OF ANCHOR NVUSUCC     02160000
ALGCOUNT DS    F                  CONDLINK - # OF ALL-GROUP ENTRIES     02170000
                                                                        02180000
VTAMSTNE DS    A                  ADDR OF NAVIGATION NETWORK ORIGIN     02190000
NEWSLOTS DS    F                  SLOT COUNT FOR VAR NODE REALLOCATION  02200000
SCROLLE  DS    F                  SCROLL SUCCESSOR ENTRY ID             02210000
CNTSREC  DS    H                  NUMBER OF SYSREC ENTRIES ACCEPTED     02220000
CNTSNAV  DS    H                  NUMBER OF SYSNAV ENTRIES ACCEPTED     02230000
                                                                        02240000
MODELSTN DS    0F,XL(NVSTNLN)     VALRGNS - MODEL STN CONSTRUCTION AREA 02250000
                                                                        02260000
USERAREA DS    4F                 $ENTITY USERDATA EXCHANGE AREA        02270000
REGSAVE  DS    16F                LOCAL REGISTER SAVEAREA               02280000
REGSAVEX DS    16F                LOCAL REGISTER SAVEAREA               02290000
                                                                        02300000
WRK256   DS    XL256              GENERAL WORKAREA                      02310000
                                                                        02320000
MSGLIST  $MSG  FIELDS=(,,,,,,),MF=L   $MSG PLIST CONSTRUCTION AREA      02330000
                                                                        02340000
$CMPINFO DS    0D                                                       02350000
         CMPINFO DSECT=NO                                               02360000
                                                                        02370000
$IOAREA  DS    0D                 TABLE ROW RETRIEVAL AREA              02380000
         DS    XL(SRECLN)            SYSRECORDINGS ROW SIZE             02390000
         ORG   $IOAREA                                                  02400000
         DS    XL(SNAVLN)            SYSNAVIGATION ROW SIZE             02410000
         ORG   ,                                                        02420000
$IOAREAL EQU   *-$IOAREA             LENGTH OF I/O AREA REQUIRED        02430000
                                                                        02440000
$IOAREA2 DS    XL(SNAVLN)         SYSNAVIGATION RECORD #2               02450000
                                                                        02460000
         #ENDWORK ,               PROJECT CONTROL BLOCK                 02470000
                                                                        02480000
         EJECT                                                          02490000
         IPROJ ,                  PROJECT CONTROL BLOCK                 02500000
                                                                        02510000
         EJECT                                                          02520000
         NAV   ,                  NAVIGATION NETWORK STRUCTURES         02530000
                                                                        02540000
         EJECT                                                          02550000
         REGION ,                 REGION NETWORK                        02560000
                                                                        02570000
         EJECT                                                          02580000
         EXRGNET ,                EXECUTION REGION NETWORK              02590000
                                                                        02600000
         EJECT                                                          02610000
         $ENTITY DSECT=YES        ENTITY MANAGER REQUEST LIST           02620000
                                                                        02630000
         EJECT                                                          02640000
         ICATALOG RECORDINGS,NAVIGATION                                 02650000
                                                                        02660000
         EJECT                                                          02670000
         TBSERVIS SET,GET                                               02680000
                                                                        02690000
         EJECT                                                          02700000
         RAPLIST ,                IRGNANAL ENTRANCE LIST                02710000
                                                                        02720000
         EJECT                                                          02730000
         TRACODES PRINT=NOGEN     TRACE TABLE ENTRY CODES               02740000
                                                                        02750000
         ABCODES PRINT=NOGEN      $ABEND CODES                          02760000
                                                                        02770000
         EQUS  ,                                                        02780000
                                                                        02790000
         $MSGDFT PREFIX=ICTPID,COMPID='NAV',TABLE=*#MSGS,              X02800000
               CONID=*ICTCONID,CONNAME=ICTCONNM,                       X02810000
               DEST=$IMSGQ,                                            X02820000
               MSGQA=PRJEXMCQ,STGQH=PRJEXSTG,                          X02830000
               PRINT=NOGEN,MF=(E,MSGLIST)                               02840000
                                                                        02850000
         EJECT                                                          02860000
INAVBSTN #ENTER PREG=(R7),BASE=(R12,R9)                                 02870000
                                                                        02880000
         USING  ITASK,R10         STDENV                                02890000
                                                                        02900000
         EJECT                                                          02910000
***************************************************************         02920000
*                                                                       02930000
*   General initialization, construct navigation node locator           02940000
*                                                                       02950000
***************************************************************         02960000
                                                                        02970000
         USING IPROJ,R7           PROJECT RESOURCES                     02980000
         XC    PRJEXSTN,PRJEXSTN  NO STN ANCHOR                         02990000
         XC    PRJEXENT,PRJEXENT  NO STN ENTITY LOCATOR                 03000000
                                                                        03010000
*--------------------------------------------------------------         03020000
*   NAVIGATIONAL ENTITY LOOKUP STRUCTURE                                03030000
*--------------------------------------------------------------         03040000
                                                                        03050000
         $ENTITY INIT,            INITIALIZE A SESSION LOCATOR         X03060000
               ANCHOR=@ENTITY,    LOCAL ENTITY STRUCTURE ANCHOR        X03070000
               SLOTS=128,         ANTICIPATE MODERATE OBJECT LOAD      X03080000
               QH=PRJEXSTG,       NAV STRUCTURES ATTACHED TO PROJECT   X03090000
               WKA=WRK256,        PROVIDE A WORKAREA                   X03100000
               MF=(E,MFE_LIST)                                          03110000
                                                                        03120000
         BZ    *+8                ASSERT EXPECTATION                    03130000
         EX    R0,*               DENIED                                03140000
                                                                        03150000
         EJECT                                                          03160000
**<DOC-ON>*****************************************************         03170000
*                                                                       03180000
*   Phase I                                                             03190000
*                                                                       03200000
*   Create an NVREC node for each valid SYSRECORDINGs entry.            03210000
*   These nodes contain the information required to establish           03220000
*   sessions with any of the applications referenced in the             03230000
*   SYSNAVIGATION entries processed later.  NVREC.NVRMAIN               03240000
*   contains a pointer to the "principle NVREC", the first              03250000
*   reference to a given application name / logmode pair.               03260000
*                                                                       03270000
**<DOC-OFF>****************************************************         03280000
                                                                        03290000
         TBSET POS=TOP,           ESTABLISH POSITION AT TOP OF TABLE   X03300000
               TTOKEN=PRJTKREC,                                        X03310000
               MF=(E,MFE_LIST)                                          03320000
                                                                        03330000
         LTR   R15,R15                                                  03340000
         BNZ   ABN_TBSV                                                 03350000
                                                                        03360000
*--------------------------------------------------------------         03370000
*   ACQUIRE NEXT SYSRECORDING ENTRY                                     03380000
*--------------------------------------------------------------         03390000
                                                                        03400000
         LA    R5,$IOAREA         TABLE ROW INPUT AREA                  03410000
         USING SRECSECT,R5        CAST TO DESIRED FORMAT                03420000
                                                                        03430000
RECINEXT DS    0H                                                       03440000
         TBGET SRECSECT,          ACQUIRE NEXT SYSRECORDINGS ROW       X03450000
               LENGTH=SRECLN,                                          X03460000
               POS=NEXT,                                               X03470000
               TTOKEN=PRJTKREC,                                        X03480000
               MF=(E,MFE_LIST)                                          03490000
                                                                        03500000
         CH    R15,=AL2(RC04)     TEST COMPLETION STATUS                03510000
         BL    RECINOK            ROW ACQUIRED                          03520000
         BE    RECINFIN           END OF SYSRECORDINGS                  03530000
         BH    ABN_TBSV           TABLE SERVICES ERROR                  03540000
                                                                        03550000
*--------------------------------------------------------------         03560000
*   GENERATE ENTRY FOR VALID RECORDING                                  03570000
*--------------------------------------------------------------         03580000
                                                                        03590000
RECINOK  DS    0H                                                       03600000
         TM    SRECFLG1,SRECFINV  VALID SYSRECORDINGS ENTRY?            03610000
         BNO   RECINVAL           ONWARD IF SO                          03620000
         LA    R1,SRECNAME        R1 <== RECORDING NAME                 03630000
         BAS   R14,DOCREC         DOCUMENT INVALID SYSRECORDING ROW     03640000
         B     RECINEXT           TRY NEXT ENTRY                        03650000
                                                                        03660000
RECINVAL DS    0H                                                       03670000
         STGGET NVRECLN,QH=PRJEXSTG                                     03680000
         BNZ   ABN_STG            STORAGE FAILURE                       03690000
                                                                        03700000
         LR    R4,R1              ACQUIRED STORAGE                      03710000
         USING NVREC,R4           CAST TO DESIRED FORMAT                03720000
         MVC   NVRNAME,SRECNAME   RECORDING NAME                        03730000
         MVC   NVRAPPL,SRECAPPL   INTEGRATOR APPL NAME                  03740000
         MVC   NVRLGMOD,SRECMODE  LOGMODE                               03750000
                                                                        03760000
*--------------------------------------------------------------         03770000
*   CREATE A RECORDING-APPL LINKAGE ENTITY                              03780000
*--------------------------------------------------------------         03790000
                                                                        03800000
         ST    R4,USERAREA        USERDATA AS (NVREC->,0,0,0)           03810000
                                                                        03820000
         $ENTITY ADD,             ENROLL THE RECORDING-APPL            X03830000
               ANCHOR=@ENTITY,    LOCAL ENTITY STRUCTURE ANCHOR        X03840000
               QNAME=CSTRREC,     RECORDING QUALIFIER                  X03850000
               ENTITY=NVRNAME,    ENTITY NAME IS RECORDING NAME        X03860000
               TOKEN=DWORD,       TOKEN WILL BE DISCARDED              X03870000
               USERDATA=USERAREA, ASSOCIATE NAME TO BLOCK ORIGIN       X03880000
               MF=(E,MFE_LIST)                                          03890000
                                                                        03900000
         BZ    *+8                ASSERT EXPECTATION                    03910000
         EX    R0,*               DENIED                                03920000
                                                                        03930000
         LH    R15,CNTSREC        NUMBER OF REGISTERED RECORDINGS       03940000
         LA    R15,1(,R15)        ACCOUNT FOR THIS ENTRY                03950000
         STH   R15,CNTSREC        TOTAL NUMBER OF ACCEPTED ENTRIES      03960000
                                                                        03970000
*--------------------------------------------------------------         03980000
*   GROUP ALL NVREC NODES THAT DESCRIBE THE SAME APPL-LOGMODE           03990000
*--------------------------------------------------------------         04000000
                                                                        04010000
         LA    R1,NVREC           R1 <== NVREC NODE AS PARAMETER        04020000
         BAS   R14,APPLGRP        LOCATE NVREC ACTING AS APPL SUMMARY   04030000
         ST    R1,NVRMAIN         GROUP RELATED RECORDINGS TOGETHER     04040000
         B     RECINEXT           PROCESS NEXT ENTRY                    04050000
                                                                        04060000
*--------------------------------------------------------------         04070000
*   END OF SYSRECORDINGS ENCOUNTERED - VALIDATE COMPLETENESS            04080000
*--------------------------------------------------------------         04090000
                                                                        04100000
RECINFIN DS    0H                 ALL RECORDINGS HAVE BEEN PROCESSED    04110000
         ICM   R15,3,CNTSREC      RECORDINGS ACCEPTED?                  04120000
         BNP   ERR_NONE           DONE IF NOT                           04130000
         DROP  R4,R5              NVREC, SRECSECT                       04140000
                                                                        04150000
         EJECT                                                          04160000
**<DOC-ON>*****************************************************         04170000
*                                                                       04180000
*   Phase II                                                            04190000
*                                                                       04200000
*   Each SYSNAVIGATION row is read first into $IOAREA2 and is           04210000
*   then moved to $IOAREA1 during its processing.  Thus, these          04220000
*   two I/O areas usually contain two adjacent SYSNAVIGATION            04230000
*   rows, making it easy to identify the last member of a               04240000
*   screen set and, perhaps, the transition into a new screen           04250000
*   set - both times when several validations are performed.            04260000
*                                                                       04270000
*   The SYSNAVIGATION rows are read in recording sequence.  A           04280000
*   change of recording causes a "principle NVREC" switch but           04290000
*   is otherwise insignificant.  Recordings have no individual          04300000
*   identities in the STN.                                              04310000
*                                                                       04320000
*   State Association Records, also referred to as SAR or               04330000
*   *RESUME* records, may precede the first recording when              04340000
*   SYSNAVIGATION is scanned in PRIMARY key order.  Because the         04350000
*   state relationships they convey cannot be posted until              04360000
*   after the STN is built, they must be reprocessed later.             04370000
*   F$RESUME is set to denote the presence of SARs.                     04380000
*                                                                       04390000
**<DOC-OFF>****************************************************         04400000
                                                                        04410000
         TBSET POS=TOP,           ESTABLISH POSITION AT TOP OF TABLE   X04420000
               TTOKEN=PRJTKNAV,   CATALOG OPENED FOR PROJECT           X04430000
               INDEX='PRIMARY',   READ NAVIGATION ENTRIES BY RECORDING X04440000
               MF=(E,MFE_LIST)                                          04450000
                                                                        04460000
         LTR   R15,R15                                                  04470000
         BNZ   ABN_TBSV                                                 04480000
                                                                        04490000
*--------------------------------------------------------------         04500000
*   GET THE FIRST SYSNAVIGATION ROW PRIMING DOUBLE BUFFER PUMP          04510000
*--------------------------------------------------------------         04520000
                                                                        04530000
         TBGET $IOAREA2,          ACQUIRE FIRST SYSNAVIGATION ROW      X04540000
               LENGTH=SNAVLN,                                          X04550000
               POS=NEXT,                                               X04560000
               TTOKEN=PRJTKNAV,   CATALOG OPENED FOR PROJECT           X04570000
               INDEX='PRIMARY',   READ NAVIGATION ENTRIES BY RECORDING X04580000
               MF=(E,MFE_LIST)                                          04590000
                                                                        04600000
         CH    R15,=AL2(RC04)     TEST COMPLETION STATUS                04610000
         BE    NAVINFIN           END OF SYSNAVIGATION                  04620000
         BH    ABN_TBSV           TABLE SERVICES ERROR                  04630000
                                                                        04640000
         LA    R5,$IOAREA         PRIMARY SYSNAV ROW INPUT AREA         04650000
         USING SNAVSECT,R5        DECLARE FORMAT                        04660000
                                                                        04670000
*--------------------------------------------------------------         04680000
*   PENDING SYSNAV ROW BECOMES CURRENT, REFRESH NEXT ENTRY              04690000
*--------------------------------------------------------------         04700000
                                                                        04710000
NAVINEXT DS    0H                                                       04720000
         TM    FLAGS,F$EONAV      END-OF-TABLE READING 'NEXT' SYSNAV?   04730000
         BO    NAVINFIN           SYSNAV PROCESSING COMPLETE            04740000
         MVC   SNAVSECT(SNAVLN),$IOAREA2                                04750000
                                                                        04760000
         TBGET $IOAREA2,          ACQUIRE NEXT SYSNAVIGATION ROW       X04770000
               LENGTH=SNAVLN,                                          X04780000
               POS=NEXT,                                               X04790000
               TTOKEN=PRJTKNAV,   CATALOG OPENED FOR PROJECT           X04800000
               INDEX='PRIMARY',   READ NAVIGATION ENTRIES BY RECORDING X04810000
               MF=(E,MFE_LIST)                                          04820000
                                                                        04830000
         CH    R15,=AL2(RC04)     TEST COMPLETION STATUS                04840000
         BL    NAVINOK            ROW ACQUIRED                          04850000
         BH    ABN_TBSV           TABLE SERVICES ERROR                  04860000
                                                                        04870000
         OI    FLAGS,F$EONAV      INDICATE END OF SYSNAVIGATION         04880000
         XC    $IOAREA2(SNAVLN),$IOAREA2                                04890000
                                                                        04900000
*--------------------------------------------------------------         04910000
*   IDENTIFY S0 AND S1 SCREEN SETS AND RELATION TO EACH OTHER           04920000
*--------------------------------------------------------------         04930000
                                                                        04940000
NAVINOK  DS    0H                                                       04950000
         NI    FLAGS,FF-F$S0SET-F$S1SET-F$S0S1EQ                        04960000
         TM    SNAVSSET,BF        CURRENT S0 A MEMBER OF A SCREEN SET?  04970000
         BZ    *+8                SKIP IF NOT                           04980000
         OI    FLAGS,F$S0SET      S0 A MEMBER OF SCREEN SET             04990000
                                                                        05000000
N2       USING SNAVSECT,$IOAREA2                                        05010000
         TM    N2.SNAVSSET,BF     CURRENT S1 IN SCREEN SET?             05020000
         BZ    RECHANGE           SKIP IF NOT                           05030000
         OI    FLAGS,F$S1SET      INDICATE S1 IS SSET MEMBER            05040000
         MVC   S1SSET,N2.SNAVSSET RETAIN SSET NAME FOR LATER USE        05050000
                                                                        05060000
         CLC   SNAVSSET,S1SSET    MEMBERS OF THE SAME SCREEN SET?       05070000
         BNE   RECHANGE           SKIP IF NOT                           05080000
         OI    FLAGS,F$S0S1EQ     S0 AND S1 ARE MEMBERS OF SAME SSET    05090000
         DROP  N2                 SNAVSECT IN $IOAREA2                  05100000
                                                                        05110000
*--------------------------------------------------------------         05120000
*   DEFER PROCESSING OF SAR ROWS UNTIL STN IS COMPLETED                 05130000
*--------------------------------------------------------------         05140000
                                                                        05150000
RECHANGE DS    0H                                                       05160000
         TM    SNAVFLG2,SNV2SAR   STATE RESUMPTION RECORD?              05170000
         BNO   RECGET             NO, RETRIEVE ASSOCIATED SYSREC        05180000
         OI    FLAGS,F$RESUME     INDICATE *RESUME* RECORDS EXIST       05190000
         B     NAVINEXT           PROCEED WITH NEXT RECORD              05200000
                                                                        05210000
*--------------------------------------------------------------         05220000
*   IF RECORDING NAME HAS CHANGED, LOCATE ASSOCIATED MAIN NVREC         05230000
*--------------------------------------------------------------         05240000
                                                                        05250000
RECGET   DS    0H                                                       05260000
         CLC   SNAVSREC,CURRECNM  CROSSED INTO ANOTHER RECORDING?       05270000
         BE    NAVINGO            PREV ESTABLISHED MAIN NVREC USED      05280000
                                                                        05290000
         LA    R1,SNAVSREC        R1 <== RECORDING NAME AS PARM         05300000
         BAS   R14,IDAPPL         ACQUIRE MAIN NVREC DEFINING APPL      05310000
         BZ    NAVINREG           RECORDING NAME IS VALID               05320000
                                                                        05330000
         LA    R0,012             R0  <== REF INTEG ERROR KEY(RECNAME)  05340000
         LA    R1,SNAVSECT        R1  <== SYSNAVIGATION ENTRY IN ERROR  05350000
         LA    R15,$RC12          R15 <== TERMINATING ERROR             05360000
         BAS   R14,DOCNAV         DESCRIBE ERROR                        05370000
         B     NAVSKIP            REJECT ENTRY                          05380000
                                                                        05390000
NAVINREG DS    0H                                                       05400000
         ST    R1,CURRECA         SAVE PTR TO APPL-DEFINING NVREC       05410000
         MVC   CURRECNM,SNAVSREC  RETAIN CURRENT RECORDING NAME         05420000
                                                                        05430000
         EJECT                                                          05440000
**<DOC-ON>*****************************************************         05450000
*                                                                       05460000
*   Process standard S0->S1 navigation record                           05470000
*                                                                       05480000
*   First, NVSTN nodes are located and/or created for both the          05490000
*   S0 and S1 states.  Then PREDLINK and SUCCLINK are invoked           05500000
*   to create the predecessor and successor linkages between            05510000
*   these two states.  It is often the case that the current            05520000
*   S0 state has already been defined because it will match             05530000
*   the S1 state of the immediately preceding SYSNAVIGATION             05540000
*   entry.  If the current S1 state matches, it is because a            05550000
*   loop introduced by circuit definition has been closed.              05560000
*                                                                       05570000
**<DOC-OFF>****************************************************         05580000
                                                                        05590000
NAVINGO  DS    0H                                                       05600000
         SR    R0,R0              PREPARE FOR CLEAR                     05610000
         ST    R0,S0PTR           RESET S0 ENTRY PTR                    05620000
         ST    R0,S1PTR           RESET S1 ENTRY PTR                    05630000
                                                                        05640000
*--------------------------------------------------------------         05650000
*   LOCATE OR CREATE AN NVSTN REPRESENTING S0                           05660000
*--------------------------------------------------------------         05670000
                                                                        05680000
         LA    R1,SNAVLSCR        S0 STATE NAME                         05690000
         LA    R0,SNAVSSET        S0 OPTIONALLY MEMBER OF SCREEN SET    05700000
         L     R15,SNAVLKEY       SYSIMAGE ROWID                        05710000
         BAS   R14,STNBLD         LOCATE OR BUILD STATE ENTRY           05720000
         BNZ   NAVS1              DOES NOT APPLY                        05730000
                                                                        05740000
         LR    R4,R1              ACCEPT ALLOCATED STN ENTRY            05750000
         USING NVSTN,R4           CAST TO DESIRED FORMAT                05760000
         ST    R4,S0PTR           RETAIN PTR FOR SUBSEQUENT LINKUPS     05770000
                                                                        05780000
         OC    NVSFLG,SNAVFLG0    MERGE STATE ATTRIBUTES                05790000
                                                                        05800000
         LTR   R4,R4              NEW ENTRY (INDICATED BY HIORD BIT)    05810000
         LA    R4,0(,R4)          DISCARD NEW NVSTN FLAG                05820000
         BNM   NAVS0FIN           SKIP ENTRY INITIALIZATION IF NOT      05830000
                                                                        05840000
*--------------------------------------------------------------         05850000
*   KEEP INITIAL *VTAM* STATE, ASSOC ALL OTHERS WITH MAIN NVREC         05860000
*--------------------------------------------------------------         05870000
                                                                        05880000
         TM    NVSFLG,NVSFUSS     S0 REPRESENTS SESSION ESTABLISHMENT?  05890000
         BO    *+10               *VTAM* NODE SERVES ALL APPLICATIONS   05900000
         MVC   NVSRECP,CURRECA    NVREC DEFINING THIS APPLICATION       05910000
                                                                        05920000
*--------------------------------------------------------------         05930000
*   SCREEN(SET) REGION IDENTIFICATION, COLLECTION, VALIDATION           05940000
*--------------------------------------------------------------         05950000
                                                                        05960000
NAVS0FIN DS    0H                                                       05970000
         TM    NVSFLG,NVSFUSS     S0 REPRESENTS SESSION ESTABLISHMENT?  05980000
         BNO   *+8                SKIP IF NOT SESSION ESTABLISHMENT     05990000
         ST    R4,VTAMSTNE        ESTABLISH STN ANCHOR NODE             06000000
                                                                        06010000
         L     R0,SNAVLKEY        ASSOC SYSIMAGE KEY                    06020000
         L     R1,S0PTR           NVSTN AND CREATE/LOCATE FLAG          06030000
         LA    R15,SNAVLSCR       STATE NAME                            06040000
         BAS   R14,VALRGNS        VALIDATE/ACCUM REGIONS FOR SCREEN/SET 06050000
                                                                        06060000
         EJECT                                                          06070000
**<DOC-ON>*****************************************************         06080000
*                                                                       06090000
*   If S0->S1 represents a "table selection" operation the              06100000
*   following considerations apply:                                     06110000
*                                                                       06120000
*      1) The transition cannot be both a scroll operation              06130000
*         (confined to members of the same screen set) and a            06140000
*         table select.  (error code 015)                               06150000
*                                                                       06160000
*      2) S0 and S1 may not be members of the same screen set.          06170000
*         Note that neither S0 nor S1 are required to be                06180000
*         members of any screen set.  However, if S0 is a               06190000
*         member of a screen set, the screen set ends on this           06200000
*         SYSNAV row, i.e. this is the last line of the screen          06210000
*         set.  (error code 016)                                        06220000
*                                                                       06230000
**<DOC-OFF>****************************************************         06240000
                                                                        06250000
         TM    SNAVFLG2,SNV2TSEL  TABLE SELECT OPERATION?               06260000
         BNO   TSEL_FIN           DONE HERE IF NOT                      06270000
                                                                        06280000
         LA    R0,015             ASSUME 'SCROLL / SELECT CONFLICT'     06290000
         TM    SNAVFLG2,SNV2SCRL  CORES SCROLLING OPERATION DEFINED?    06300000
         BNZ   TSEL_ERR           ERROR (1) ABOVE IF SO                 06310000
                                                                        06320000
         LA    R0,016             ASSUME 'SELECT SCREEN SET CONFLICT'   06330000
         TM    FLAGS,F$S0S1EQ     OPERATION FAILS TO LEAVE SCREEN SET?  06340000
         BNO   TSEL_FIN           ERROR (2) ABOVE IF SO                 06350000
                                                                        06360000
TSEL_ERR DS    0H                 R0  <== SUPPLEMENTAL ERROR MSG #      06370000
         LA    R1,SNAVSECT        R1  <== INVALID SYSNAVIGATION ROW     06380000
         LA    R15,$RC04          R15 <== WARNING                       06390000
         BAS   R14,DOCNAV         ISSUE SYSNAV ORIENTED DIAGNOSTIC      06400000
         NI    SNAVFLG2,FF-SNV2TSEL   WITHDRAW THE TABLE SELECT DEF     06410000
                                                                        06420000
TSEL_FIN DS    0H                 TABLE SELECT VALIDATION COMPLETE      06430000
                                                                        06440000
         EJECT                                                          06450000
**<DOC-ON>*****************************************************         06460000
*                                                                       06470000
*   If S1 is a continuation of the S0 screen set, S1 has no             06480000
*   unique identity but the S0->S1 transition may define a              06490000
*   scrolling operation.  Scroll definitions in any other               06500000
*   type of transition are invalid.                                     06510000
*                                                                       06520000
**<DOC-OFF>****************************************************         06530000
                                                                        06540000
         TM    FLAGS,F$S0S1EQ     S0 AND S1 MEMBERS OF SAME SCREEN SET? 06550000
         BO    NAVSCROL           SCROLL DEFINITION POSSIBLE, ALL ELSE  06560000
*                                 IS REDUNDANT                          06570000
                                                                        06580000
         TM    SNAVFLG2,SNV2SCRL  SCROLLING OPERATION DEFINED?          06590000
         BZ    NAVC1              CONTINUE WITHOUT ERROR IF NOT         06600000
                                                                        06610000
         LA    R1,SNAVSECT        R1  <== SYSNAV ENTRY                  06620000
         LA    R0,021             ERR('NOT MEMBERS OF SAME SCREEN SET') 06630000
         LA    R15,$RC04          R15 <== WARNING                       06640000
         BAS   R14,DOCNAV         DOCUMENT FAILURE                      06650000
         NI    SNAVFLG2,FF-SNV2SCRL   WITHDRAW THE SCROLL DEFINITION    06660000
                                                                        06670000
NAVC1    DS    0H                                                       06680000
                                                                        06690000
         EJECT                                                          06700000
**<DOC-ON>*****************************************************         06710000
*                                                                       06720000
*   Define S1 - Locate or create an NVSTN representing S1               06730000
*                                                                       06740000
**<DOC-OFF>****************************************************         06750000
                                                                        06760000
NAVS1    DS    0H                                                       06770000
         SR    R0,R0              ASSUME NO ASSOCIATED SSET             06780000
         TM    FLAGS,F$S1SET      ASSUMPTION CORRECT?                   06790000
         BNO   *+8                SKIP IF NOT                           06800000
         LA    R0,S1SSET          PASS SCREEN SET NAME OTHERWISE        06810000
                                                                        06820000
         LA    R1,SNAVRSCR        S1 STATE NAME                         06830000
         L     R15,SNAVRKEY       SYSIMAGE ROWID                        06840000
         BAS   R14,STNBLD         LOCATE OR BUILD STATE ENTRY           06850000
         BNZ   NAVS1FIN           DOES NOT APPLY                        06860000
                                                                        06870000
         LR    R4,R1              ACCEPT ALLOCATED STN ENTRY            06880000
         USING NVSTN,R4           CAST TO DESIRED FORMAT                06890000
         ST    R4,S1PTR           RETAIN PTR FOR SUBSEQUENT LINKUPS     06900000
                                                                        06910000
         OC    NVSFLG,SNAVFLG1    MERGE STATE ATTRIBUTES                06920000
                                                                        06930000
         LTR   R4,R4              NEW ENTRY (INDICATED BY HORD BIT)     06940000
         LA    R4,0(,R4)          DISCARD NEW NVSTN FLAG                06950000
         BNM   NAVS1FIN           SKIP ENTRY INITIALIZATION IF NOT      06960000
                                                                        06970000
*--------------------------------------------------------------         06980000
*   ASSOCIATE ALL STATES OTHER THAN *VTAM* WITH THE MAIN NVREC          06990000
*--------------------------------------------------------------         07000000
                                                                        07010000
         TM    NVSFLG,NVSFUSS     S0 REPRESENTS SESSION ESTABLISHMENT?  07020000
         BO    *+10               *VTAM* NODE SERVES ALL APPLICATIONS   07030000
         MVC   NVSRECP,CURRECA    NVREC DEFINING THIS APPLICATION       07040000
                                                                        07050000
*--------------------------------------------------------------         07060000
*   SCREEN(SET) REGION IDENTIFICATION, COLLECTION, VALIDATION           07070000
*--------------------------------------------------------------         07080000
                                                                        07090000
NAVS1FIN DS    0H                                                       07100000
         L     R0,SNAVRKEY        SYSIMAGE (SCREEN) KEY FROM SYSNAV     07110000
         L     R1,S1PTR           NVSTN AND CREATE/LOCATE FLAG          07120000
         LA    R15,SNAVRSCR       STATE NAME                            07130000
         BAS   R14,VALRGNS        VALIDATE/ACCUM REGIONS FOR SCREEN/SET 07140000
                                                                        07150000
         EJECT                                                          07160000
**<DOC-ON>*****************************************************         07170000
*                                                                       07180000
*   At this point, S0 and S1 NVSTN addresses have been saved in         07190000
*   S0PTR and S1PTR, respectively.  If a true state-to-state            07200000
*   transition is described by the current SYSNAVIGATION row,           07210000
*   PREDLINK and SUCCLINK are invoked to define the appropriate         07220000
*   predecessor and successor relationships. This completes the         07230000
*   processing of standard S0->S1 transition entries.                   07240000
*                                                                       07250000
**<DOC-OFF>****************************************************         07260000
                                                                        07270000
         ICM   R0,15,S0PTR        PREDECESSOR STATE IDENTIFIED?         07280000
         BZ    NAVACC             NO LINKAGE OTHERWISE                  07290000
         ICM   R0,15,S1PTR        SUCCESSOR STATE IDENTIFIED?           07300000
         BZ    NAVACC             NO LINKAGE OTHERWISE                  07310000
                                                                        07320000
         BAS   R14,PREDLINK       CREATE/UPDATE PREDECESSOR LINKAGES    07330000
                                                                        07340000
         LA    R1,SNAVSECT        R1 <== SYSNAVIGATION ENTRY            07350000
         BAS   R14,SUCCLINK       CREATE/UPDATE SUCCESSOR LINKAGES      07360000
         B     NAVACC             SYSNAV ENTRY PROCESSING COMPLETE      07370000
                                                                        07380000
         EJECT                                                          07390000
**<DOC-ON>*****************************************************         07400000
*                                                                       07410000
*   Create scrolling screen set linkages                                07420000
*                                                                       07430000
**<DOC-OFF>****************************************************         07440000
                                                                        07450000
NAVSCROL DS    0H                                                       07460000
         L     R4,S0PTR           RETAIN SSET PTR FOR SCROLL LINKAGE    07470000
         USING NVSTN,R4           CAST TO DESIRED FORMAT                07480000
                                                                        07490000
         LA    R3,NVUESCRD-1      ENTRY FOR SCROLL-DOWN                 07500000
         TM    SNAVFLG2,SNV2DOWN  SCROLL DOWN?                          07510000
         BO    NAVSCOP                                                  07520000
         LA    R3,NVUESCRR-1      ENTRY FOR SCROLL-DOWN                 07530000
         TM    SNAVFLG2,SNV2RIGH  SCROLL RIGHT?                         07540000
         BO    NAVSCOP                                                  07550000
         LA    R3,NVUESCRL-1      ENTRY FOR SCROLL-DOWN                 07560000
         TM    SNAVFLG2,SNV2LEFT  SCROLL LEFT?                          07570000
         BNO   NAVACC                                                   07580000
                                                                        07590000
NAVSCOP  DS    0H                                                       07600000
         ST    R3,SCROLLE         RETAIN SCROLL ENTRY IDENTIFIER        07610000
         TM    SNAVFLG2,SNV2MAID  INDETERMINATE RESULT STATE FROM AID?  07620000
         BNO   NAVSCVRF           CONTINUE SCROLLING DEFINITION IF NOT  07630000
                                                                        07640000
         LA    R1,SNAVSECT        R1 <== SYSNAV ENTRY                   07650000
         LA    R0,020             'SCROLL/COND CONFLICT - SCROLL IGN'   07660000
         LA    R15,$RC04          R15 <== WARNING                       07670000
         BAS   R14,DOCNAV         DOCUMENT FAILURE                      07680000
         B     NAVSKIP            IGNORE SCROLLING                      07690000
                                                                        07700000
*--------------------------------------------------------------         07710000
*   MULTIPLE SCROLL DEFS WITHIN SCREEN SET MUST BE CONSISTENT           07720000
*--------------------------------------------------------------         07730000
                                                                        07740000
NAVSCVRF DS    0H                                                       07750000
         ICM   R15,15,NVSCROLL    SCROLLING DEFS PREV ENCOUNTERED?      07760000
         BZ    NAVSCALO           ALLOCATE SCROLL ENTRY IF NOT          07770000
         USING NVUSUCC,R15        SUCCESSOR NODE                        07780000
         L     R3,SCROLLE         SCOLL SUCCESSOR ENTRY ID              07790000
         MH    R3,=AL2(NVUENTLN)  CONVERT INDEX TO OFFSET               07800000
         LA    R6,NVUENTRY(R3)    CONVERT OFFSET TO ADDRESS             07810000
         USING NVUENTRY,R6        SUCCESSOR ENTRY                       07820000
                                                                        07830000
         CLI   NVUESAID,0         ENTRY INITIALIZED?                    07840000
         BE    NAVSCNEW           CONSTRUCT NEW ENTRY IF NOT            07850000
         CLC   NVUESAID,SNAVAID   AIDS ARE IDENTICAL?                   07860000
         BNE   NAVSCNFL           CONFLICT IF NOT                       07870000
         CLC   NVUSKSID,SNAVSKSK  SKS SAME OR BOTH OMITTED?             07880000
         BE    NAVACC             IGNORE REDUNDANT SCROLL DEFINITION    07890000
                                                                        07900000
         @CALL ISKSCOMP,(IPROJ,*NVUSKSID,0,*SNAVSKSK,0),               X07910000
               CTYPE=CVT,                                              X07920000
               MF=(E,MFE_LIST)                                          07930000
                                                                        07940000
         LTR   R15,R15            NORMAL COMPLETION?                    07950000
         BNZ   NAVSCNFL           ERROR PRECLUDED COMPARE               07960000
         LTR   R0,R0              SKS COMPARE EQUAL?                    07970000
         BNZ   NAVSCNFL           ERROR IF NOT                          07980000
         B     NAVACC             INGORE REDUNDANT SCROLL DEFINITION    07990000
                                                                        08000000
NAVSCNFL DS    0H                 SCROLL ENTRY CONFLICTS WITH PRIOR     08010000
         LA    R1,SNAVSECT        R1 <== SYSNAV ENTRY                   08020000
         LA    R0,022             'SCROLL DEFINITION CONFLICT'          08030000
         LA    R15,$RC04          R15 <== WARNING                       08040000
         BAS   R14,DOCNAV         DOCUMENT FAILURE                      08050000
         B     NAVSKIP            IGNORE ENTRY ENTIRELY                 08060000
                                                                        08070000
*--------------------------------------------------------------         08080000
*   FORMAT NEW SCROLLING SUCCESSOR LINKAGE ENTRY                        08090000
*--------------------------------------------------------------         08100000
                                                                        08110000
NAVSCNEW DS    0H                 CREATE SCROLLING SUCCESSOR ENTRY      08120000
         L     R15,NVSCROLL       SUCCESSOR BLOCK PREFIX                08130000
         USING NVUSUCC,R15        TEMP ADDRESSABILITY                   08140000
         L     R1,NVUCOUNT        ACTIVE ENTRY COUNT                    08150000
         LA    R1,1(,R1)          ACCOUNT FOR NEW ENTRY                 08160000
         ST    R1,NVUCOUNT        SAVE UPDATED ENTRY COUNT              08170000
         DROP  R15                NVUSUCC                               08180000
                                                                        08190000
         MVC   NVUESAID,SNAVAID   POST THE AID                          08200000
         MVC   NVUSKSID,SNAVSKSK  ASSOCIATED SKS                        08210000
         MVC   NVUCSRP,SNAVCSRP   CURSOR POSITION                       08220000
         MVC   NVUIMGID,SNAVLKEY  RECORDED SCROLL INPUT IMAGE           08230000
         ST    R4,NVUSTN          SUCCESSOR STN = CURRENT STN           08240000
         B     NAVACC             SCROLL DEFINITION ACCEPTED            08250000
         DROP  R6                 NVUENTRY                              08260000
                                                                        08270000
*--------------------------------------------------------------         08280000
*   ALLOCATE SCROLLING SUCCESSOR LINKAGE BLOCK                          08290000
*--------------------------------------------------------------         08300000
                                                                        08310000
NAVSCALO DS    0H                 ALLOCATE SCROLLING SUCCESSOR BLOCK    08320000
         LA    R1,NVUENTLN        LENGTH OF EACH SUCCESSOR SLOT         08330000
         SLL   R1,2               TIMES FOUR FOR UP/DOWN/LEFT/RIGHT     08340000
         LA    R3,NVUSUCFX(R1)    TOTAL LENGTH OF SUCCESSOR BLOCK       08350000
                                                                        08360000
         STGGET (R3),QH=PRJEXSTG  ACQUIRE NEW BLOCK                     08370000
         BNZ   ABN_STG            STORAGE FAILURE                       08380000
                                                                        08390000
         LR    R15,R1             ACQUIRED STORAGE ADDRESS              08400000
         USING NVUSUCC,R15        TEMP SUCCESSOR ENTRY ADDRESSABILITY   08410000
         ST    R3,NVUSIZE         BLOCK LENGTH                          08420000
         MVC   NVUSLOTS,=F'4'     FBA CONFIGURATION                     08430000
         ST    R15,NVSCROLL       ATTACH TO IMAGE STN ENTRY             08440000
         B     NAVSCVRF           CREATE NEW ENTRY                      08450000
         DROP  R15                NVUSUCC                               08460000
                                                                        08470000
         EJECT                                                          08480000
***************************************************************         08490000
*                                                                       08500000
*   SYSNAVIGATION entry processing complete, account and repeat         08510000
*                                                                       08520000
***************************************************************         08530000
                                                                        08540000
NAVACC   DS    0H                 ACCEPT NAVIGATION ENTRY               08550000
         LH    R15,CNTSNAV        NUMBER OF ACCEPTED SYSNAVIGATION ROWS 08560000
         LA    R15,1(,R15)        ACCOUNT FOR THIS PASS                 08570000
         STH   R15,CNTSNAV        TOTAL NUMBER OF ACCEPTED ENTRIES      08580000
                                                                        08590000
NAVSKIP  DS    0H                 PROCESS NEXT SYSNAV ENTRY             08600000
         B     NAVINEXT           PROCESS NEXT ENTRY                    08610000
                                                                        08620000
NAVINFIN DS    0H                 ALL SYSNAVS HAVE BEEN PROCESSED       08630000
         ICM   R15,3,CNTSNAV      SYSNAVS ACCEPTED?                     08640000
         BNP   ERR_NONE           DONE IF NOT                           08650000
         DROP  R4,R5              NVSTN, SNAVSECT                       08660000
                                                                        08670000
         EJECT                                                          08680000
**<DOC-ON>*****************************************************         08690000
*                                                                       08700000
*  Phase III                                                            08710000
*                                                                       08720000
*  Process state association rows (SAR) SYSNAVIGATION records           08730000
*                                                                       08740000
**<DOC-OFF>****************************************************         08750000
                                                                        08760000
         TM    FLAGS,F$RESUME     SAR RECORDS AVAILABLE?                08770000
         BZ    NAV_NSAR           NO, PROCESSING COMPLETE               08780000
                                                                        08790000
*--------------------------------------------------------------         08800000
*  RESET SYSNAVIGATION POSITION TO TOP                                  08810000
*--------------------------------------------------------------         08820000
                                                                        08830000
         TBSET POS=TOP,           ESTABLISH POSITION AT TOP OF TABLE   X08840000
               TTOKEN=PRJTKNAV,   CATALOG OPENED FOR PROJECT           X08850000
               INDEX='PRIMARY',   READ NAVIGATION ENTRIES BY RECORDING X08860000
               MF=(E,MFE_LIST)                                          08870000
                                                                        08880000
         LTR   R15,R15                                                  08890000
         BNZ   ABN_TBSV                                                 08900000
                                                                        08910000
*--------------------------------------------------------------         08920000
*  CONSTRUCT TBSARGS TO RETRIVE *RESUME* RECORDS ONLY                   08930000
*--------------------------------------------------------------         08940000
                                                                        08950000
         LA    R1,WRK256          AREA TO CONSTRUCT SARG                08960000
         USING TBSARGS,R1         TEMP ADDRESSABILITY                   08970000
         XC    WRK256,WRK256      CLEAR WORKAREA                        08980000
         MVI   TBSAVER,TBSAV0     VERSION ID                            08990000
         MVI   TBSABOOL,TBSABAND  AND BOOLEAN CONNECTOR                 09000000
         LA    R0,1               SINGLE TERM                           09010000
         STH   R0,TBSAENTS                                              09020000
         LA    R0,TBSAFIXL+TBSANFXL+L'$RSMREC                           09030000
         STH   R0,TBSALEN         TOTAL SARG LENGTH                     09040000
                                                                        09050000
         LA    R1,TBSARGS+TBSAFIXL  SARG ENTRY EXTENSION                09060000
         USING TBSANTRY,R1        TEMP ADDRESSABILITY                   09070000
         MVI   TBSAOPR,TBSAO$EQ   EQUAL                                 09080000
         MVC   TBSAACOL,=CL16'SNAVSREC'  RECORDING NAME                 09090000
         MVC   TBSAAVAL(L'$RSMREC),$RSMREC                              09100000
         DROP  R1                 TBSANTRY                              09110000
                                                                        09120000
*--------------------------------------------------------------         09130000
*  RETRIEVE ALL *RESUME* SYSNAVIGATION RECORDS                          09140000
*--------------------------------------------------------------         09150000
                                                                        09160000
NAVRNEXT DS    0H                                                       09170000
         TBGET $IOAREA,           ACQUIRE FIRST SYSNAVIGATION ROW      X09180000
               LENGTH=SNAVLN,                                          X09190000
               POS=NEXT,                                               X09200000
               SARGS=WRK256,      SEARCH FOR *RESUME* RECORDS          X09210000
               TTOKEN=PRJTKNAV,   CATALOG OPENED FOR PROJECT           X09220000
               INDEX='PRIMARY',   READ NAVIGATION ENTRIES BY RECORDING X09230000
               MF=(E,MFE_LIST)                                          09240000
                                                                        09250000
         CH    R15,=AL2(RC04)     TEST COMPLETION STATUS                09260000
         BE    NAV_NSAR           END OF SYSNAV, ANALIZE RGNS    160490 09270000
         BH    ABN_TBSV           TABLE SERVICES ERROR                  09280000
                                                                        09290000
         LA    R1,$IOAREA         PRIMARY SYSNAV ROW INPUT AREA         09300000
         BAS   R14,RSMPROC        PROCESS SAR RECORD                    09310000
         B     NAVRNEXT           RETRIEVE NEXT SAR RECORD              09320000
                                                                        09330000
NAV_NSAR DS    0H                                                       09340000
                                                                        09350000
         EJECT                                                          09360000
**<DOC-ON>*****************************************************         09370000
*                                                                       09380000
*   Phase IV                                                            09390000
*                                                                       09400000
*   Merge <ALL-GROUP> conditional entries into each conditional         09410000
*   successor NVUSUCC block accessed by the same AID key.               09420000
*                                                                       09430000
**<DOC-OFF>****************************************************         09440000
                                                                        09450000
         ICM   R4,15,PRJEXLST     TRAVERSE LIST OF ALL STNS             09460000
         BZ    NALLGRP            DONE IF NONE                          09470000
         USING NVSTN,R4           STN NODE ADDRESSABILITY               09480000
                                                                        09490000
NXT1STN  DS    0H                                                       09500000
         ICM   R6,15,NVSTSUCC     SUCCESSOR LINKAGE CHAIN               09510000
         BZ    ADV1STN            NEXT STATE IF NO SUCCESSORS           09520000
AG       USING NVUSUCC,R6         ALL-GROUP SUCCESSOR BLOCK PTR         09530000
                                                                        09540000
NXT1AG   DS    0H                                                       09550000
         CLC   =X'FFFF',AG.NVUCGRP   ALL-GROUP CONDITIONAL ENTRY?       09560000
         BNE   ADV1AG             SKIP IF NOT                           09570000
         LA    R5,NVSTSUCC-(NVUNEXT-NVUSUCC)  OF SUCCESSOR BLOCKS       09580000
         USING NVUSUCC,R5         MAPPED                                09590000
                                                                        09600000
         NI    FLAGS,FF-F$ALLCND  SUCCESSOR NOT YET MATCHED             09610000
                                                                        09620000
*--------------------------------------------------------------         09630000
*   LOCATE CONDITIONAL SUCCESSORS HAVING SAME AID AS ALL-GROUP          09640000
*--------------------------------------------------------------         09650000
                                                                        09660000
NXT1SUCC DS    0H                                                       09670000
         LR    R2,R5              RETAIN ADDR OF ANCHORING SUCCESSOR    09680000
         ICM   R5,15,NVUNEXT      ADVANCE TO NEXT SUCCESSOR NODE        09690000
         BZ    ADV1AGVF           END OF SUCCESSOR CHAIN                09700000
                                                                        09710000
         CLI   NVUMAID,FALSE      SUCCESSOR LINKAGE IS CONDITIONAL?     09720000
         BE    NXT1SUCC           SKIP IF NOT                           09730000
         CLC   NVUAID,AG.NVUAID   IDENTICAL AID?                        09740000
         BNE   NXT1SUCC           SKIP IF NOT                           09750000
         CR    R5,R6              ENSURE NOT THE ALL-GROUP ENTRY ITSELF 09760000
         BE    NXT1SUCC           SKIP IF SO                            09770000
                                                                        09780000
         LA    R15,AG.NVUSUCC     R15 <== ALL-GROUP SUCCESSOR LINKAGES  09790000
         LA    R1,NVUSUCC         R1  <== SUCCESSOR INHERITS ALL-GROUP  09800000
         LR    R0,R2              R0  <== SUCCESSOR NODES ANCHOR NVU    09810000
         BAS   R14,CONDLINK       INHERIT ALL-GROUP LINKAGES            09820000
                                                                        09830000
         LR    R5,R1              CURRENT SUCCESSOR MAY BE REALLOCATED  09840000
         OI    FLAGS,F$ALLCND     INDICATE <ALL-GROUPS> MERGE OCCURRED  09850000
         B     NXT1SUCC           CONTINUE SCAN                         09860000
                                                                        09870000
*--------------------------------------------------------------         09880000
*   ENSURE THAT <ALL-GROUPS> ENTRY ACCEPTED BY SOME COND GROUP          09890000
*--------------------------------------------------------------         09900000
                                                                        09910000
ADV1AGVF DS    0H                                                       09920000
         TM    FLAGS,F$ALLCND     ALL-GROUPS MERGE TOOK PLACE?          09930000
         BO    ADV1AG             ONWARD IF SO                          09940000
                                                                        09950000
         MVC   AG.NVUCGRP,=C'??'  CONVERT ALL-GROUPS ENTRY TO COND GRP  09960000
                                                                        09970000
         MVC   SSET,NVSTSSN       IDENTIFY SCREEN SET                   09980000
         TM    SSET,BF            SCREEN A MEMBER OF SCREEN SET?        09990000
         BNZ   *+10               SKIP IF SO                            10000000
         MVC   SSET,NVSTNAME      CLEAR SCREEN SET NAME                 10010000
                                                                        10020000
         $CLINK FUNC=GENAID,      ACQUIRE LABEL FOR AID KEY            X10030000
               (CHAR,AG.NVUAID),                                       X10040000
               (INT*,FWORD)                                             10050000
                                                                        10060000
         LR    R2,R15             AID KEY LABEL WITH NULL TERMINATOR    10070000
                                                                        10080000
         $MSG  013,FIELDS=(SSET,((R2),0))                               10090000
                                                                        10100000
         OI    RETCMASK,$RC04     WARNINGS ISSUED                       10110000
         LA    R0,RSN08           SYSNAVIGATION RELATED                 10120000
         O     R0,RSNCODE         ACCUMULATED REASONS                   10130000
         ST    R0,RSNCODE         SAVE UPDATED MASK FOR RETURN          10140000
                                                                        10150000
*--------------------------------------------------------------         10160000
*   PROCESS ALL STN-TO-STN SUCCESSOR LINKAGE ENTRIES                    10170000
*--------------------------------------------------------------         10180000
                                                                        10190000
ADV1AG   DS    0H                                                       10200000
         ICM   R6,15,AG.NVUNEXT   LOCATE NEXT ALL-GROUP ENTRY           10210000
         BNZ   NXT1AG             CONTINUE SCAN                         10220000
                                                                        10230000
*--------------------------------------------------------------         10240000
*   EXAMINE ALL STNs                                                    10250000
*--------------------------------------------------------------         10260000
                                                                        10270000
ADV1STN  DS    0H                                                       10280000
         ICM   R4,15,NVSLIST      LOCATE NEXT STN ON GLOBAL LIST        10290000
         BNZ   NXT1STN            CONTINUE SCAN                         10300000
                                                                        10310000
NALLGRP  DS    0H                                                       10320000
         DROP  AG,R4,R5           ALL-GROUP NVU, STN, CURRENT NVU       10330000
                                                                        10340000
         EJECT                                                          10350000
**<DOC-ON>*****************************************************         10360000
*                                                                       10370000
*   Phase V - Final analysis of screen set regions                      10380000
*                                                                       10390000
**<DOC-OFF>****************************************************         10400000
                                                                        10410000
NAV_RANL DS    0H                                                       10420000
         ICM   R4,15,PRJEXLST     TRAVERSE LIST OF ALL STNS             10430000
         BZ    NAV_DONE           DONE IF NONE                          10440000
         USING NVSTN,R4           STN NODE ADDRESSABILITY               10450000
                                                                        10460000
NRA_LOOP DS    0H                                                       10470000
         LR    R1,R4              R1 <== STN ENTRY                      10480000
         BAS   R14,VALFINAL       FINAL REGION VALIDATIONS              10490000
                                                                        10500000
NRA_NEXT DS    0H                                                       10510000
         ICM   R4,15,NVSLIST      ADDRESS OF NEXT STN                   10520000
         BNZ   NRA_LOOP           PROCESS NEXT STN                      10530000
                                                                        10540000
NAV_DONE DS    0H                                                       10550000
         DROP  R4                 NVSTN                                 10560000
                                                                        10570000
         EJECT                                                          10580000
**<DOC-ON>*****************************************************         10590000
*                                                                       10600000
*   Phase VI - State depth assignments                                  10610000
*                                                                       10620000
**<DOC-OFF>****************************************************         10630000
                                                                        10640000
         ICM   R1,15,VTAMSTNE     VTAM DEPARTURE IDENTIFIED?            10650000
         BZ    DEPTHFIN           DONE IF NOT                           10660000
         SR    R0,R0              INITIAL STATE DEPTH (*VTAM*)          10670000
                                                                        10680000
         @CALL INAVMPTH,CTYPE=STD                                       10690000
                                                                        10700000
DEPTHFIN DS    0H                                                       10710000
                                                                        10720000
         EJECT                                                          10730000
***************************************************************         10740000
*                                                                       10750000
*   Return completion status to requester                               10760000
*                                                                       10770000
***************************************************************         10780000
                                                                        10790000
         MVC   PRJEXENT,@ENTITY   RETURN ENTITY ORIGIN                  10800000
         MVC   PRJEXSTN,VTAMSTNE  INITIAL USS->APPL TRANSITION NODE     10810000
                                                                        10820000
         ICM   R1,15,VTAMSTNE     VTAM TRANSITIONS TO SOME STATE?       10830000
         BNZ   RETURN             DONE IF SO                            10840000
                                                                        10850000
         LA    R1,002             DOCUMENT ERROR                        10860000
         BAS   R14,DOCGEN                                               10870000
                                                                        10880000
         OI    RETCMASK,$RC08     INDICATE ERROR                        10890000
         B     RETURN                                                   10900000
                                                                        10910000
*--------------------------------------------------------------         10920000
*   NO SYSRECORDING ENTRIES                                             10930000
*--------------------------------------------------------------         10940000
                                                                        10950000
ERR_NONE DS    0H                 NO SYSREC/SYSNAV ENTRIES              10960000
         LA    R1,001             DOCUMENT ERROR                        10970000
         BAS   R14,DOCGEN                                               10980000
                                                                        10990000
         OI    RETCMASK,$RC16     INDICATE ERROR                        11000000
         B     RETURN                                                   11010000
                                                                        11020000
*--------------------------------------------------------------         11030000
*   PROGRAM FAILURE                                                     11040000
*--------------------------------------------------------------         11050000
                                                                        11060000
ERR_FAIL DS    0H                 PERMANENT ERROR ENCOUNTERED           11070000
         OI    RETCMASK,$RC20     RETURN FAILURE                        11080000
         B     RETURN                                                   11090000
                                                                        11100000
         EJECT                                                          11110000
***************************************************************         11120000
*                                                                       11130000
*   RETURN TO REQUESTER                                                 11140000
*                                                                       11150000
***************************************************************         11160000
                                                                        11170000
RETURN   DS    0H                                                       11180000
         L     R1,INFCODE         INFO CODE                             11190000
         L     R0,RSNCODE         REASON CODE                           11200000
                                                                        11210000
*--------------------------------------------------------------         11220000
*   CONVERT RETURN CODE MASK TO HIGHEST SEVERITY RETURN CODE            11230000
*--------------------------------------------------------------         11240000
                                                                        11250000
         SR    R15,R15                                                  11260000
         ICM   R15,8,RETCMASK                                           11270000
         BZ    RETEXIT                                                  11280000
         LA    R2,7               # SIGNIFICANT RETCODE BITS            11290000
                                                                        11300000
RETCYC   DS    0H                                                       11310000
         LTR   R15,R15                                                  11320000
         BM    RETCOMP                                                  11330000
         SLL   R15,1                                                    11340000
         BCT   R2,RETCYC                                                11350000
                                                                        11360000
RETCOMP  DS    0H                                                       11370000
         LR    R15,R2                                                   11380000
         SLL   R15,2                                                    11390000
                                                                        11400000
RETEXIT  DS    0H                                                       11410000
         #EXIT ,                                                        11420000
                                                                        11430000
         EJECT                                                          11440000
**<DOC-ON>*****************************************************         11450000
*                                                                       11460000
* ROUTINE: LOCSTN - Locate NVSTN node                                   11470000
*                                                                       11480000
* DESCRIPTION:                                                          11490000
*                                                                       11500000
*    This routine is used to locate the NVSTN entry for a given         11510000
*    state as represented by the state name, or alternatively,          11520000
*    the screen set name.                                               11530000
*                                                                       11540000
*                                                                       11550000
* ON ENTRY:                                                             11560000
*                                                                       11570000
*    R1  - addr of the state name                                       11580000
*                                                                       11590000
*                                                                       11600000
* ON EXIT:                                                              11610000
*                                                                       11620000
*    R15 contains one of the following return codes.  The               11630000
*        condition code is set accordingly                              11640000
*                                                                       11650000
*        RC00 - NVSTN entry returned in R1                              11660000
*        RC04 - screen(set) not found                                   11670000
*                                                                       11680000
**<DOC-OFF>****************************************************         11690000
                                                                        11700000
LOCSTN   DS    0H                                                       11710000
         STM   R0,R15,REGSAVEX    SAVE MAINLINE REGS                    11720000
         LTR   R2,R1              PRESERVE STATE/IMAGE NAME PTR         11730000
                                                                        11740000
*--------------------------------------------------------------         11750000
*   LOCATE NAMED STATE BY SCREEN SET NAME                               11760000
*--------------------------------------------------------------         11770000
                                                                        11780000
         $ENTITY EXTR,            LOCATE ENTITY BY SCREEN SET NAME     X11790000
               QNAME=CSTRSSET,                                         X11800000
               ENTITY=((R2),L'NVSTSSN),                                X11810000
               USERDATA=USERAREA,                                      X11820000
               ANCHOR=@ENTITY,                                         X11830000
               MF=(E,MFE_LIST)                                          11840000
                                                                        11850000
         CH    R15,=AL2(RC04)     TEST COMPLETION STATUS                11860000
         BL    LOCFOUND           SCREEN SET REGISTERED                 11870000
         BE    LOCBYIMG           NO SUCH SCREEN SET                    11880000
         EX    R0,*               ASSERT 'PROPERLY FORMULATED REQ'      11890000
                                                                        11900000
*--------------------------------------------------------------         11910000
*   LOCATE NAMED STATE BY STATE NAME                                    11920000
*--------------------------------------------------------------         11930000
                                                                        11940000
LOCBYIMG DS    0H                 LOCATE ENTITY BY STATE NAME           11950000
         $ENTITY EXTR,            LOCATE ENTITY                        X11960000
               QNAME=CSTRIMAG,    ENTITY IS A STATE IMAGE              X11970000
               ENTITY=((R2),L'NVSTNAME),                               X11980000
               USERDATA=USERAREA,                                      X11990000
               ANCHOR=@ENTITY,                                         X12000000
               MF=(E,MFE_LIST)                                          12010000
                                                                        12020000
         CH    R15,=AL2(RC04)     TEST COMPLETION STATUS                12030000
         BL    LOCFOUND           STATE NAME REGISTERED                 12040000
         BE    LOCNF              CREATE NEW STN ENTRY                  12050000
         EX    R0,*               ASSERT 'PROPERLY FORMULATED REQ'      12060000
                                                                        12070000
*--------------------------------------------------------------         12080000
*   LOCATE NAMED STATE BY STATE NAME                                    12090000
*--------------------------------------------------------------         12100000
                                                                        12110000
LOCFOUND DS    0H                 MATCHING ENTRY FOUND                  12120000
         L     R1,USERAREA        RETURN PREVIOUSLY CONSTRUCTED ENTRY   12130000
         LA    R1,0(,R1)          CLEAR HIGHORDER BIT                   12140000
         LA    R15,RC00           SUCCESS                               12150000
         B     LOCRET                                                   12160000
                                                                        12170000
LOCNF    DS    0H                 NO MATCHING ENTRY FOUND               12180000
         LA    R15,RC04           FAILURE                               12190000
                                                                        12200000
LOCRET   DS    0H                                                       12210000
         LM    R2,R14,REGSAVEX+8  RESTORE REGS                          12220000
         LTR   R15,R15            REFLECT COMPLETION STATUS VIA CC      12230000
         BR    R14                                                      12240000
                                                                        12250000
         EJECT                                                          12260000
**<DOC-ON>*****************************************************         12270000
*                                                                       12280000
* ROUTINE: STNBLD - Locate or construct NVSTN entry                     12290000
*                                                                       12300000
* DESCRIPTION:                                                          12310000
*                                                                       12320000
*    This routine is used to locate the NVSTN entry for a given         12330000
*    state as represented by the state name.  If the state has          12340000
*    not been previously registered in the navigation $ENTITY           12350000
*    structure, a new NVSTN entry is allocated, initialized,            12360000
*    and registered.  *VTAM* (initial/terminal state) and               12370000
*    standard states are accepted.  Pseudo-states such as               12380000
*    recording start and stop states and various error states           12390000
*    represented by internally assigned state names beginning           12400000
*    with an asterisk are rejected.  Note that this is not an           12410000
*    error condition.                                                   12420000
*                                                                       12430000
*    States (screens) may be members of a screen set. Membership        12440000
*    in a screen set allows constructs defined on one state,            12450000
*    such as regions and varaiables, to be inherited accross            12460000
*    several several closely related states.  The earliest              12470000
*    example of such a set of states is the scroll group. If            12480000
*    an entry was previoulsy constructed for the screen set,            12490000
*    that entry is returned.                                            12500000
*                                                                       12510000
*                                                                       12520000
* NOTES:                                                                12530000
*                                                                       12540000
*    In future versions, it may be desirable to loosen the              12550000
*    tight association between screen sets and scrolling.               12560000
*    The advantage of the current implementation is that it             12570000
*    eliminates the need for spurious images when scrolling             12580000
*    is defined.                                                        12590000
*                                                                       12600000
*    The last screen (state) name, screen set name, and the             12610000
*    associated NVSTN address are tested and preserved on               12620000
*    each call to bypass unneeded $ENTITY calls where possible.         12630000
*                                                                       12640000
*                                                                       12650000
* ON ENTRY:                                                             12660000
*                                                                       12670000
*    R1  - addr of the state name or *VTAM*                             12680000
*    R0  - addr of screen set name or 0                                 12690000
*    R15 - image id                                                     12700000
*                                                                       12710000
*                                                                       12720000
* ON EXIT:                                                              12730000
*                                                                       12740000
*    R15 contains one of the following return codes.  The               12750000
*        condition code is set accordingly                              12760000
*                                                                       12770000
*        RC00 - NVSTN entry returned                                    12780000
*                                                                       12790000
*               R1 contains the addr of the NVSTN entry. the high       12800000
*                  order bit is set if the NVSTN was created by         12810000
*                  this request                                         12820000
*                                                                       12830000
*        RC04 - ineligible state                                        12840000
*                                                                       12850000
**<DOC-OFF>****************************************************         12860000
                                                                        12870000
STNBLD   DS    0H                                                       12880000
         STM   R0,R15,REGSAVE     SAVE MAINLINE REGS                    12890000
         LR    R6,R0              PRESERVE SCREEN SET NAME ADDR         12900000
                                                                        12910000
         LTR   R2,R1              PRESERVE STATE/IMAGE NAME PTR         12920000
         CLC   =C'*VTAM*',0(R2)   VTAM TRANSITION STATE?                12930000
         BE    STNBLOC            ONWARD IF SO                          12940000
         CLI   0(R2),C'*'         OTHER SPECIAL/UNMAPPABLE STATE?       12950000
         BE    STNBSKIP           DONE IF SO                            12960000
                                                                        12970000
***************************************************************         12980000
*                                                                       12990000
*   Locate preallocated NVSTN entry by screen set name                  13000000
*                                                                       13010000
***************************************************************         13020000
                                                                        13030000
STNBLOC  DS    0H                                                       13040000
         LTR   R6,R6              SCREEN SET MEMBERSHIP?                13050000
         BZ    STNBYIMG           LOCATE BY IMAGE NAME IF NOT           13060000
         TM    0(R6),BF           SCREEN SET NAME POSTED?               13070000
         BZ    STNBYIMG           BY IMAGE NAME OTHERWISE               13080000
                                                                        13090000
         $ENTITY EXTR,            LOCATE ENTITY                        X13100000
               QNAME=CSTRSSET,    BY SCREEN SET NAME                   X13110000
               ENTITY=((R6),L'NVSTSSN),                                X13120000
               USERDATA=USERAREA,                                      X13130000
               ANCHOR=@ENTITY,                                         X13140000
               MF=(E,MFE_LIST)                                          13150000
                                                                        13160000
         CH    R15,=AL2(RC04)     TEST COMPLETION STATUS                13170000
         BL    STNBHIT1           STN PREVIOUSLY REGISTERED             13180000
         BE    STNBYIMG           STN NOT YET CREATED                   13190000
         EX    R0,*               ASSERT 'PROPERLY FORMULATED REQ'      13200000
                                                                        13210000
STNBHIT1 DS    0H                 MATCHING SCREEN SET DEFINED           13220000
         USING NVSTN,R4           DECLARE INTENTIONS                    13230000
         L     R4,USERAREA        RETURN PREVIOUSLY CONSTRUCTED ENTRY   13240000
         LA    R4,0(,R4)          CLEAR HIGHORDER BIT                   13250000
         ST    R4,@STNBSTN        SAVE STN PTR FOR RETURN               13260000
         B     STNBCPT            RETURN SCREEN SET                     13270000
                                                                        13280000
***************************************************************         13290000
*                                                                       13300000
*   Locate preallocated NVSTN entry by state name.  If an NVSTN         13310000
*   is found to already exist, it is possible that it is                13320000
*   appearing for the first time as a member of a screen set.           13330000
*                                                                       13340000
***************************************************************         13350000
                                                                        13360000
STNBYIMG DS    0H                 VALID STATE NAME                      13370000
         $ENTITY EXTR,            LOCATE ENTITY                        X13380000
               QNAME=CSTRIMAG,    ENTITY IS A STATE IMAGE              X13390000
               ENTITY=((R2),L'NVSTNAME),                               X13400000
               USERDATA=USERAREA,                                      X13410000
               ANCHOR=@ENTITY,                                         X13420000
               MF=(E,MFE_LIST)                                          13430000
                                                                        13440000
         CH    R15,=AL2(RC04)     TEST COMPLETION STATUS                13450000
         BL    STNBHIT2           STN PREVIOUSLY REGISTERED             13460000
         BE    STNCRE             CREATE NEW STN ENTRY                  13470000
         EX    R0,*               ASSERT 'PROPERLY FORMULATED REQ'      13480000
                                                                        13490000
STNBHIT2 DS    0H                                                       13500000
         USING NVSTN,R4           DECLARE INTENTIONS                    13510000
         L     R4,USERAREA        RETURN PREVIOUSLY CONSTRUCTED ENTRY   13520000
         LA    R4,0(,R4)          CLEAR HIGHORDER BIT                   13530000
         ST    R4,@STNBSTN        SAVE STN PTR FOR RETURN               13540000
         B     STNBSSET           SCREEN SET PROCESSING                 13550000
                                                                        13560000
***************************************************************         13570000
*                                                                       13580000
*   Neither screen set nor screen were previously defined.              13590000
*   Create a new NVSTN for the screen(set)                              13600000
*                                                                       13610000
***************************************************************         13620000
                                                                        13630000
STNCRE   DS    0H                                                       13640000
         STGGET NVSTNLN,QH=PRJEXSTG                                     13650000
         BNZ   ABN_STG            STORAGE FAILURE                       13660000
                                                                        13670000
         LA    R4,0(,R1)          ACQUIRED STORAGE                      13680000
         USING NVSTN,R4           CAST TO DESIRED FORMAT                13690000
         MVC   NVSTEYE,=CL8'STNENTRY'                                   13700000
         MVC   NVSTNAME,0(R2)     STATE/IMAGE NAME                      13710000
         MVC   NVSIMGID,REGSAVE+(4*R15)                                 13720000
                                                                        13730000
         MVC   NVSLIST,PRJEXLST   LIST OF ALL STNS                      13740000
         ST    R4,PRJEXLST        NEW NODE ADDED AT FRONT               13750000
                                                                        13760000
*--------------------------------------------------------------         13770000
*   ENROLL THE STN ENTRY FOR SUBSEQUENT LOOKUP                          13780000
*--------------------------------------------------------------         13790000
                                                                        13800000
         ST    R4,USERAREA        USERDATA AS (NVSTN->,0,0,0)           13810000
                                                                        13820000
         $ENTITY ADD,             ENROLL THE STATE/IMAGE               X13830000
               QNAME=CSTRIMAG,    IMAGE QUALIFIER                      X13840000
               ENTITY=NVSTNAME,   ENTITY NAME                          X13850000
               TOKEN=DWORD,       TOKEN WILL BE DISCARDED              X13860000
               USERDATA=USERAREA, ASSOCIATE NAME TO BLOCK ORIGIN       X13870000
               ANCHOR=@ENTITY,    LOCAL ENTITY STRUCTURE ANCHOR        X13880000
               MF=(E,MFE_LIST)                                          13890000
                                                                        13900000
         BZ    *+8                ASSERT EXPECTATION                    13910000
         EX    R0,*               DENIED                                13920000
                                                                        13930000
         LA    R1,NVSTN           STN PTR                               13940000
         O     R1,=X'80000000'    INDICATE NEW ALLOCATION               13950000
         ST    R1,@STNBSTN        SAVE STN PTR FOR RETURN               13960000
                                                                        13970000
***************************************************************         13980000
*                                                                       13990000
*   If the NVSTN is a member of a screen set, ensure that the           14000000
*   screen set is defined                                               14010000
*                                                                       14020000
***************************************************************         14030000
                                                                        14040000
STNBSSET DS    0H                                                       14050000
         LTR   R6,R6              SCREEN SET MEMBERSHIP?                14060000
         BZ    STNRGNS            DONE IF NOT                           14070000
         TM    0(R6),BF           SCREEN SET NAMED?                     14080000
         BZ    STNRGNS            DONE IF NOT                           14090000
                                                                        14100000
         MVC   NVSTSSN,0(R6)      INSERT SCREEN SET NAME                14110000
         ST    R4,USERAREA        USERDATA AS (NVSTN->,0,0,0)           14120000
                                                                        14130000
         $ENTITY ADD,             ENROLL THE STATE/IMAGE               X14140000
               QNAME=CSTRSSET,    SCREEN SET QUALIFIER                 X14150000
               ENTITY=NVSTSSN,    SCREEN SET NAME                      X14160000
               TOKEN=DWORD,       TOKEN WILL BE DISCARDED              X14170000
               USERDATA=USERAREA, ASSOCIATE NAME TO BLOCK ORIGIN       X14180000
               ANCHOR=@ENTITY,    LOCAL ENTITY STRUCTURE ANCHOR        X14190000
               MF=(E,MFE_LIST)                                          14200000
                                                                        14210000
         BZ    *+8                ASSERT EXPECTATION                    14220000
         EX    R0,*               DENIED                                14230000
                                                                        14240000
***************************************************************         14250000
*                                                                       14260000
*   Associate regions with this screen or screen set                    14270000
*                                                                       14280000
***************************************************************         14290000
                                                                        14300000
STNRGNS  DS    0H                                                       14310000
         LA    R1,NVSTSSN         ASSUME LOCATE BY SCREEN-SET NAME      14320000
         TM    0(R1),BF           SCREEN-SET NAME DEFINED?              14330000
         BNZ   *+8                SKIP IF SO                            14340000
         LA    R1,NVSTNAME        ELSE REVERT TO UNEMBELISHED SCREEN ID 14350000
                                                                        14360000
         @CALL ILOCSSET,CTYPE=CVT                                       14370000
         LTR   R15,R15            REGION TREE LOCATED AS EXPECTED?      14380000
         BNZ   STNBCPT            NOT AVAILABLE (CONSULT R15)           14390000
                                                                        14400000
         USING EXRGNET,R1         TEMP ADDRESSABILITY                   14410000
         LA    R2,EXRNROOT        RGNTREE ORIGIN                        14420000
         ST    R2,NVSRGN          POST REGION TREE FOR SCREEN SET       14430000
         DROP  R1                 EXRGNET                               14440000
                                                                        14450000
***************************************************************         14460000
*                                                                       14470000
*   Return completion status and NVSTN entry to requester               14480000
*                                                                       14490000
***************************************************************         14500000
                                                                        14510000
STNBCPT  DS    0H                 STN CONSTRUCTION COMPLETE             14520000
         L     R1,@STNBSTN        RETURN STN PTR & NEW FLAG             14530000
         LA    R15,RC00           INDICATE SUCCESS                      14540000
         B     STNBRET            DONE                                  14550000
                                                                        14560000
STNBSKIP DS    0H                 INELIGIBLE STATE                      14570000
         LA    R15,RC04           INDICATE BYPASS                       14580000
                                                                        14590000
STNBRET  DS    0H                                                       14600000
         LM    R2,R14,REGSAVE+8   RESTORE MAINLINE REGS                 14610000
         LTR   R15,R15            REFLECT COMPLETION STATUS VIA CC      14620000
         BR    R14                RETURN                                14630000
         DROP  R4                 NVSTN                                 14640000
                                                                        14650000
         EJECT                                                          14660000
**<DOC-ON>*****************************************************         14670000
*                                                                       14680000
* ROUTINE: VALRGNS - Region definition validation                       14690000
*                                                                       14700000
* DESCRIPTION:                                                          14710000
*                                                                       14720000
*    This routine is used to validate region definitions                14730000
*    made against a single screen and to accumulate the region          14740000
*    instances posted to a particular screen set, as represented        14750000
*    by single NVSTN.  The following considerations apply:              14760000
*                                                                       14770000
*       1) States that are not members of screen sets may or may        14780000
*          not be involved in circuit definitions.  Because only        14790000
*          the first instance of the state is retained, all             14800000
*          region validation can be made the first time the             14810000
*          NVSTN is presented.  VALFINAL is called to perform           14820000
*          final region validation.                                     14830000
*                                                                       14840000
*       2) States that are members of screen sets must have every       14850000
*          image instance tiled and recorded.  Final validation         14860000
*          can only occur after the entire SYSNAVIGATION is read        14870000
*          to ensure that all member states have been examined.         14880000
*          The VALFINAL call is deferred.                               14890000
*                                                                       14900000
*                                                                       14910000
* ON ENTRY:                                                             14920000
*                                                                       14930000
*    R0  - SYSIMAGES image ID number                                    14940000
*    R1  - addr of NVSTN entry, referred to as the TRUE NVSTN           14950000
*    R15 - addr of the state / screen set name                          14960000
*                                                                       14970000
*                                                                       14980000
* ON EXIT:                                                              14990000
*                                                                       15000000
*    RETCMASK and RSNCODE are updated to reflect region                 15010000
*    validation errors and warnings                                     15020000
*                                                                       15030000
**<DOC-OFF>****************************************************         15040000
                                                                        15050000
VALRGNS  DS    0H                                                       15060000
         STM   R0,R15,REGSAVE     SAVE MAINLINE REGS                    15070000
         LR    R3,R15             IMAGE NAME                            15080000
         LR    R4,R1              NVSTN PTR AND CREATE/LOCATE FLAG      15090000
         USING NVSTN,R4           DECLARE INTENTIONS                    15100000
                                                                        15110000
*--------------------------------------------------------------         15120000
*   BYPASS STNS W/O IMAGE OR RGNS                                       15130000
*--------------------------------------------------------------         15140000
                                                                        15150000
         LA    R15,RC00           ASSUME NO WORK TO DO                  15160000
         LTR   R2,R0              IMAGE ATTACHED TO ENTRY?              15170000
         BZ    VALRFIN            NO ASSOCIATED IMAGE                   15180000
                                                                        15190000
         ICM   R0,15,NVSRGN       REGIONS ASSOC WITH SCREEN(SET) ?      15200000
         BZ    VALRFIN            SKIP IF NOT                           15210000
                                                                        15220000
*--------------------------------------------------------------         15230000
*   REPROCESS ONLY SCREEN SET MEMBERS, ALL OTHERS ARE ONE SHOTS         15240000
*--------------------------------------------------------------         15250000
                                                                        15260000
         TM    NVSTSSN,BF         MEMBER OF SCREEN SET?                 15270000
         BNZ   VALFILTR           ELIGIBLE IF SO                        15280000
         LTR   R4,R4              FIRST APPEARANCE OF NEW STATE?        15290000
         BNM   VALRFIN            PREVIOUSLY PROCESSED IF NOT           15300000
                                                                        15310000
VALFILTR DS    0H                 ELIGIBLE IF NOT JUST PROCESSED        15320000
M        USING NVSTN,MODELSTN     MODEL STN CONSTRUCTION AREA           15330000
         C     R2,M.NVSIMGID      IMAGE (JUST) PREVIOUSLY PROCESSED?    15340000
         BE    VALRFIN            SKIP REDUNDANT REQUEST IF SO          15350000
                                                                        15360000
*--------------------------------------------------------------         15370000
*   CREATE/UPDATE MODEL STN AND PERFORM IMAGE/REGION VALIDATION         15380000
*--------------------------------------------------------------         15390000
                                                                        15400000
         MVC   M.NVSTN(NVSTNLN),NVSTN   WORKING COPY OF STN             15410000
         MVC   M.NVSTNAME,0(R3)         INSERT CURRENT STATE NAME       15420000
         ST    R2,M.NVSIMGID            INSERT CORR IMAGE ID            15430000
         XC    M.NVSIMGA,M.NVSIMGA      DISCARD REF TO RESIDUAL NVIMAGE 15440000
                                                                        15450000
         @CALL IRGNTST1,(IPROJ,M.NVSTN),CTYPE=CVT,                     X15460000
               MF=(E,MFE_LIST)                                          15470000
                                                                        15480000
         TM    M.NVSATTRS,NVSAERGN      EXCEPTION REGIONS ENCOUNTERED?  15490000
         BNO   *+8                      SKIP IF NOT                     15500000
         OI    NVSATTRS,NVSAERGN        REFLECT IN TRUE STN             15510000
         DROP  M                                                        15520000
                                                                        15530000
*--------------------------------------------------------------         15540000
*   ANALYZE AND POST IRGNTST1 COMPLETION STATUS                         15550000
*--------------------------------------------------------------         15560000
                                                                        15570000
         CH    R15,=AL2(RC04)     ANALYZE COMPLETION STATUS             15580000
         BL    VALRTST1           VERIFICATION COMPLETED WITHOUT NOTE   15590000
         BH    VALRERR            SEVERE ERROR ENCOUNTERED              15600000
                                                                        15610000
         LA    R14,RSN16          INDICATE REGION CONFLICTS             15620000
         CH    R0,=AL2(RSN04)     WARNING SEVERITY?                     15630000
         BE    *+8                SAME RETCODE USED HERE IF SO          15640000
         OI    RETCMASK,$RC12     ELSE INDICATE TERMING CATALOG ERROR   15650000
         B     VALRPST            POST COMPLETION STATUS                15660000
                                                                        15670000
VALRERR  DS    0H                                                       15680000
         ST    R15,INFCODE        PRESERVE INFO CODE                    15690000
         LA    R14,RSN64          INDICATE INVALID SYSNAVIGATION        15700000
         OI    RETCMASK,$RC12     FORCE TERMINATION                     15710000
                                                                        15720000
VALRPST  DS    0H                 R15 <== RETCODE, R14 <== RSNCODE      15730000
         O     R14,RSNCODE        CONSTRUCT COMPOSITE MASK              15740000
         ST    R14,RSNCODE        SAVE UPDATED VALUE                    15750000
         LR    R0,R14             PREPARE REASON CODE FOR RETURN        15760000
                                                                        15770000
VALRTST1 DS    0H                 END OF TILED IMAGE TEST #1            15780000
                                                                        15790000
*--------------------------------------------------------------         15800000
*   FINAL VALIDATIONS FOR STATES NOT MEMBERS OF SCREEN SETS             15810000
*--------------------------------------------------------------         15820000
                                                                        15830000
         TM    NVSTSSN,BF         MEMBER OF SCREEN SET?                 15840000
         BNZ   VALRFIN            FINAL VALIDATIONS MUST BE DEFERRED    15850000
                                                                        15860000
         LA    R1,NVSTN           R1 <== STN ENTRY                      15870000
         BAS   R14,VALFINAL       FINAL REGION VALIDATION THIS STATE    15880000
                                                                        15890000
*--------------------------------------------------------------         15900000
*   RETURN TO CALLER                                                    15910000
*--------------------------------------------------------------         15920000
                                                                        15930000
VALRFIN  DS    0H                                                       15940000
         LM    R0,R14,REGSAVE     RESTORE MAINLINE REGS                 15950000
         BR    R14                DONE                                  15960000
         DROP  R4                 NVSTN                                 15970000
                                                                        15980000
         EJECT                                                          15990000
**<DOC-ON>*****************************************************         16000000
*                                                                       16010000
* ROUTINE: VALFINAL - Screen(set) region validation - final             16020000
*                                                                       16030000
* DESCRIPTION:                                                          16040000
*                                                                       16050000
*    This routine provides linkage to IRGNANAL which is called          16060000
*    with the SCREEN-SET or SCROLL-SCREEN-SET option to perform         16070000
*    final region validations once all screens in the screen set        16080000
*    have been tiled and exaimed.                                       16090000
*                                                                       16100000
*    NVSATTRS.NVSARVAL is set in all NVSTNs processed by this           16110000
*    routine.                                                           16120000
*                                                                       16130000
*                                                                       16140000
* ON ENTRY:                                                             16150000
*                                                                       16160000
*    R1  - addr of NVSTN                                                16170000
*                                                                       16180000
*                                                                       16190000
* ON EXIT:                                                              16200000
*                                                                       16210000
*    RETCMASK and RSNCODE are updated to reflect region                 16220000
*    validation errors and warnings                                     16230000
*                                                                       16240000
**<DOC-OFF>****************************************************         16250000
                                                                        16260000
VALFINAL DS    0H                                                       16270000
         STM   R0,R15,REGSAVEX    SAVE MAINLINE REGS                    16280000
         LR    R4,R1              NVSTN PTR AND CREATE/LOCATE FLAG      16290000
         USING NVSTN,R4           DECLARE INTENTIONS                    16300000
                                                                        16310000
         TM    NVSATTRS,NVSARVAL  FINAL REGION VERF PREV COMPLETED?     16320000
         BO    VFIFIN             DONE IF NOT                           16330000
                                                                        16340000
         ICM   R3,15,NVSRGN       REGIONS DEFINED ON SCREEN/SET?        16350000
         BZ    VFIFIN             DONE IF NOT                           16360000
         USING RGNTREE,R3         MAP REGION TREE DESCRIPTOR            16370000
                                                                        16380000
*--------------------------------------------------------------         16390000
*   VALIDATION TYPE DEPENDS ON PRESENCE/ABSENCE OF SCROLL               16400000
*--------------------------------------------------------------         16410000
                                                                        16420000
         LA    R2,RAPC$SMY        ASSUME NO SCROLLING INTENT            16430000
         ICM   R1,15,NVSCROLL     SCROLL SKS ATTACHED?                  16440000
         BZ    VFIVERF            ONWARD IF NOT                         16450000
                                                                        16460000
         LA    R1,NVUENTRY-NVUSUCC+(NVUENTLN*(NVUESCRD-1))(,R1)         16470000
         USING NVUENTRY,R1        TEMP ENTRY ADDRESSABILITY             16480000
         ICM   R0,1,NVUESAID      VERTICAL SCROLL DEFINED?              16490000
         BZ    VFIVERF            SKIP IF NOT                           16500000
         LA    R2,RAPC$SCR        INCLUDE SCROLL VALIDATIONS            16510000
         DROP  R1                 NVUENTRY                              16520000
                                                                        16530000
*--------------------------------------------------------------         16540000
*   FINAL REGION VALIDATIONS FOR SCREEN / SCREEN(SET)                   16550000
*--------------------------------------------------------------         16560000
                                                                        16570000
VFIVERF  DS    0H                                                       16580000
         @CALL IRGNANAL,                                               +16590000
               ((R2),RGTROOT,NVSTSSN,NVSTNAME,PRJEXMCQ,PRJEXSTG),      +16600000
               CTYPE=CVT,                                              +16610000
               MF=(E,MFE_LIST)                                          16620000
                                                                        16630000
         OI    NVSATTRS,NVSARVAL  REGION VALIDATION COMPLETED           16640000
                                                                        16650000
*--------------------------------------------------------------         16660000
*   POST COMPLETION CODES                                               16670000
*--------------------------------------------------------------         16680000
                                                                        16690000
         CH    R15,=AL2(RC04)     ANALYZE COMPLETION STATUS             16700000
         BL    VFIFIN             DONE HERE IF SO                       16710000
         MVI   BYTE,$RC04         WARNINGS ISSUED                       16720000
         BE    *+8                RC04 CONSTANT AS WARNING SEV          16730000
         MVI   BYTE,$RC12         ERRORS CARRIED THIS WAY               16740000
                                                                        16750000
         OC    RETCMASK,BYTE      RETAIN SEVERITY INDICATOR             16760000
         LA    R0,RSN16           INDICATE REGION CONFLICTS             16770000
         O     R0,RSNCODE         RETAIN RSNCODE                        16780000
         ST    R0,RSNCODE         AS A COMPOSITE MASK                   16790000
                                                                        16800000
*--------------------------------------------------------------         16810000
*   RETURN TO CALLER                                                    16820000
*--------------------------------------------------------------         16830000
                                                                        16840000
VFIFIN   DS    0H                                                       16850000
         LM    R0,R14,REGSAVEX    RESTORE MAINLINE REGS                 16860000
         BR    R14                DONE                                  16870000
         DROP  R4,R3              NVSTN, RGNTREE                        16880000
                                                                        16890000
         EJECT                                                          16900000
**<DOC-ON>*****************************************************         16910000
*                                                                       16920000
* ROUTINE: CONDLINK - Complete <ALL-GROUP> successor linkages           16930000
*                                                                       16940000
* DESCRIPTION:                                                          16950000
*                                                                       16960000
*    This routine augments existing predecessor->successor              16970000
*    linkage blocks (NVUSUCC) with the set of linkages contained        16980000
*    in the given <ALL-GROUP> successor block.                          16990000
*                                                                       17000000
*                                                                       17010000
* ON ENTRY:                                                             17020000
*                                                                       17030000
*    R15 - <ALL-GROUP> successor (source) linkage block (nvusucc)       17040000
*    R1  - inheriting (target) successor                                17050000
*    R0  - inheriting successor anchor entry                            17060000
*                                                                       17070000
*                                                                       17080000
* ON EXIT:                                                              17090000
*                                                                       17100000
*    R1  - addr of target successor.  It may have been                  17110000
*          reallocated to allow for insertion of new entries.           17120000
*                                                                       17130000
**<DOC-OFF>****************************************************         17140000
                                                                        17150000
CONDLINK DS    0H                                                       17160000
         STM   R0,R15,REGSAVE     SAVE MAINLINE REGS                    17170000
         ST    R0,ALGRPANC        RETAIN TARGET SUCCESSOR               17180000
                                                                        17190000
         LR    R5,R1              TARGET SUCCESSOR NODE                 17200000
         USING NVUSUCC,R5                                               17210000
                                                                        17220000
         LR    R6,R15             ALL-GROUP LINKAGES                    17230000
AG       USING NVUSUCC,R6                                               17240000
         ICM   R0,15,AG.NVUCOUNT  ENTRIES EXPECTED                      17250000
         BZ    CONDRET            DONE IF NONE                          17260000
         ST    R0,ALGCOUNT        RETAIN FOR LOOP CONTROL               17270000
         LA    R6,AG.NVUENTRY     PREPARE FOR ENTRY SCAN                17280000
AGE      USING NVUENTRY,R6                                              17290000
                                                                        17300000
*--------------------------------------------------------------         17310000
*   DETERMINE WHETHER ALL-GROUP ENTRY ALREADY RESIDES IN TARGET         17320000
*--------------------------------------------------------------         17330000
                                                                        17340000
CONDPASS DS    0H                                                       17350000
         ICM   R14,15,NVUCOUNT    ENTRIES PREVIOUSLY POSTED?            17360000
         BZ    CONDCONT           SKIP IF NOT                           17370000
         LA    R3,NVUENTRY        LOCATE FIRST ENTRY                    17380000
         USING NVUENTRY,R3        ENTRY ADDRESSABILITY                  17390000
                                                                        17400000
CONDSCAN DS    0H                                                       17410000
         CLC   NVUSTN,AGE.NVUSTN  MATCHING LINKAGE ENTRY?               17420000
         BE    CONDNXAG           NO NEW ENTRY IF SO                    17430000
         LA    R3,NVUENTLN(,R3)   ELSE ADVANCE TO NEXT ENTRY            17440000
         BCT   R14,CONDSCAN       SCAN ALL ENTRIES                      17450000
         DROP  R3                 NVUENTRY                              17460000
                                                                        17470000
CONDCONT DS    0H                                                       17480000
         L     R2,NVUCOUNT        NUMBER OF SLOTS IN USE                17490000
         C     R2,NVUSLOTS        FREE SLOTS REMAIN?                    17500000
         BL    CONDAUGM           READY FOR INSERT IF SO                17510000
                                                                        17520000
*--------------------------------------------------------------         17530000
*   (RE)ALLOCATE SUCCESSOR LINKAGE BLOCK                                17540000
*--------------------------------------------------------------         17550000
                                                                        17560000
         LR    R1,R5              R1 <== EXHAUSTED SUCCESSOR ADDR       17570000
         L     R0,ALGRPANC        R0 <== ANCHOR NVUSUCC ENTRY IN CHAIN  17580000
         BAS   R14,SUCCREAL       REALLOCATE                            17590000
         LR    R5,R1              RESTORE STANDARD ADDRESSABILITY       17600000
                                                                        17610000
*--------------------------------------------------------------         17620000
*   MERGE ALL-GROUP ENTRY INTO TARGET SUCCESSOR BLOCK                   17630000
*--------------------------------------------------------------         17640000
                                                                        17650000
CONDAUGM DS    0H                                                       17660000
         L     R2,NVUCOUNT        NUMBER OF SLOTS IN USE                17670000
         MH    R2,=AL2(NVUENTLN)  COMPUTE FREE SLOT OFFSET              17680000
         LA    R3,NVUENTRY(R2)    ADDR OF FREE SLOT                     17690000
         MVC   0(NVUENTLN,R3),AGE.NVUENTRY                              17700000
                                                                        17710000
         L     R15,NVUCOUNT       NUMBER OF SLOTS IN USE                17720000
         LA    R15,1(,R15)        ACCOUNT FOR NEW ENTRY                 17730000
         ST    R15,NVUCOUNT       POST CURRENT USAGE                    17740000
                                                                        17750000
*--------------------------------------------------------------         17760000
*   PROCESS ALL ALL-GROUP SUCCESSOR LINKAGES                            17770000
*--------------------------------------------------------------         17780000
                                                                        17790000
CONDNXAG DS    0H                                                       17800000
         LA    R6,NVUENTLN(,R6)   ADVANCE TO NEXT ALL-GROUP ENTRY       17810000
         L     R1,ALGCOUNT        NUMBER OF ALL-GROUP ENTRIES REMAINING 17820000
         SH    R1,=H'1'           ACCOUNT FOR THIS PASS                 17830000
         ST    R1,ALGCOUNT        RETAIN FOR NEXT PASS                  17840000
         BNZ   CONDPASS           PROCESS ALL ALL-GROUP ENTRIES         17850000
                                                                        17860000
CONDRET  DS    0H                                                       17870000
         LA    R1,NVUSUCC         RETURN ADDR OF TARGET SUCCESSOR       17880000
         SR    R15,R15            RETURN CODES NOT DEFINED              17890000
         LM    R2,R15,REGSAVE+8   RESTORE CALLERS REGS                  17900000
         BR    R14                RETURN                                17910000
         DROP  AG,AGE,R5                                                17920000
                                                                        17930000
         EJECT                                                          17940000
**<DOC-ON>*****************************************************         17950000
*                                                                       17960000
* ROUTINE: PREDLINK - Construct predecessor link (S1->S0)               17970000
*                                                                       17980000
* DESCRIPTION:                                                          17990000
*                                                                       18000000
*    This routine creates the successor->predecessor linkage            18010000
*    entries allowing all predecessors of a given state to be           18020000
*    readily identified during STN scan.                                18030000
*                                                                       18040000
* ON ENTRY:                                                             18050000
*                                                                       18060000
*    S0PTR - addr of predecessor NVSTN entry                            18070000
*    S1PTR - addr of successor NVSTN entry                              18080000
*                                                                       18090000
**<DOC-OFF>****************************************************         18100000
                                                                        18110000
PREDLINK DS    0H                                                       18120000
         STM   R0,R15,REGSAVE     SAVE MAINLINE REGS                    18130000
                                                                        18140000
         L     R4,S1PTR           LOCATE S1 STN ENTRY                   18150000
         LA    R4,0(,R4)          CLEAR FLAGS                           18160000
         USING NVSTN,R4           MAP THE STN ENTRY                     18170000
                                                                        18180000
PREDRTRY DS    0H                                                       18190000
         ICM   R5,15,NVSTPRED     LOCATE PREDECESSOR LINKAGE BLOCK      18200000
         BZ    PREDREAL           NOT AVAILABLE                         18210000
         USING NVPRED,R5          MAPPED                                18220000
                                                                        18230000
*--------------------------------------------------------------         18240000
*   IGNORE REDUNDANT PRED->SUCC LINKAGES                                18250000
*--------------------------------------------------------------         18260000
                                                                        18270000
         ICM   R2,15,NVPCOUNT     ENTRIES PREVIOUSLY POSTED?            18280000
         BZ    PREDCONT           SKIP IF NOT                           18290000
         LA    R3,NVPENTRY        LOCATE FIRST ENTRY                    18300000
         USING NVPENTRY,R3        ENTRY ADDRESSABILITY                  18310000
         L     R1,S0PTR           PREDECESSOR STN ENTRY                 18320000
         LA    R1,0(,R1)          REMOVE FLAG                           18330000
                                                                        18340000
PREDSCAN DS    0H                                                       18350000
         C     R1,NVPSTN          MATCHING LINKAGE?                     18360000
         BE    PREDRET            IGNORE IF SO                          18370000
         LA    R3,NVPENTLN(,R3)   ELSE ADVANCE TO NEXT ENTRY            18380000
         BCT   R2,PREDSCAN        SCAN ALL ENTRIES                      18390000
         DROP  R3                 NVPENTRY                              18400000
                                                                        18410000
PREDCONT DS    0H                                                       18420000
         L     R2,NVPCOUNT        NUMBER OF SLOTS IN USE                18430000
         C     R2,NVPSLOTS        FREE SLOTS REMAIN?                    18440000
         BL    PREDFMT            READY FOR INSERT IF SO                18450000
                                                                        18460000
***************************************************************         18470000
*                                                                       18480000
*   (Re)allocate predecessor linkage block if no space remains          18490000
*                                                                       18500000
***************************************************************         18510000
                                                                        18520000
PREDREAL DS    0H                 ALLOC NEW PREDECESSOR LINKAGE BLOCK   18530000
         LA    R1,##SLOTS         DEFAULT SLOT COUNT FOR NEW BLOCK      18540000
         LTR   R5,R5              REPLACING CURRENT PRED LINKAGE?       18550000
         BZ    PREDGET            SKIP IF NOT                           18560000
         L     R1,NVPSLOTS        CURRENT SLOT COUNT                    18570000
         AR    R1,R1              DOUBLED IN NEW BLOCK                  18580000
                                                                        18590000
PREDGET  DS    0H                                                       18600000
         ST    R1,NEWSLOTS        NUMBER OF SLOTS IN NEW BLOCK          18610000
         MH    R1,=AL2(NVPENTLN)  LENGTH OF EACH SLOT                   18620000
         LA    R3,NVPREDFX(R1)    TOTAL LENGTH OF PRED BLOCK            18630000
                                                                        18640000
         STGGET (R3),QH=PRJEXSTG  ACQUIRE NEW BLOCK                     18650000
         BNZ   ABN_STG            STORAGE FAILURE                       18660000
                                                                        18670000
         LR    R6,R1              PRESERVE ACQUIRED STORAGE ADDRESS     18680000
                                                                        18690000
*--------------------------------------------------------------         18700000
*   RETAIN CONTENTS OF REPLACED PREDECESSOR BLOCK                       18710000
*--------------------------------------------------------------         18720000
                                                                        18730000
         LTR   R5,R5              PRED LINKAGE REPLACEMENT?             18740000
         BZ    PREDREND           SKIP THE COPY IF NOT                  18750000
                                                                        18760000
         LR    R0,R6              NEW STORAGE                           18770000
         L     R1,NVPSIZE         SIZE OF PRIOR BLOCK                   18780000
         LA    R14,NVPRED         PRIOR BLOCK ORIGIN                    18790000
         LR    R15,R1             SOURCE LENGTH = TARGET LENGTH         18800000
         MVCL  R0,R14             COPY                                  18810000
                                                                        18820000
         L     R2,NVPSIZE         SIZE OF OLD BLOCK                     18830000
                                                                        18840000
         STGRETN ADDR=(R5),LEN=(R2),QH=PRJEXSTG                         18850000
         BNZ   ABN_STG            STORAGE MANAGEMENT FAILURE            18860000
                                                                        18870000
*--------------------------------------------------------------         18880000
*   COMPLETE CONFIGURATION OF NEW PREDECESSOR BLOCK                     18890000
*--------------------------------------------------------------         18900000
                                                                        18910000
PREDREND DS    0H                                                       18920000
         LR    R5,R6              CAST NEW EXTENT AS PRED BLOCK         18930000
         ST    R5,NVSTPRED        REPLACE STN PRED BLOCK PTR            18940000
         ST    R3,NVPSIZE         SIZE OF NEW BLOCK                     18950000
         L     R0,NEWSLOTS        TOTAL NUMBER OF SLOTS                 18960000
         ST    R0,NVPSLOTS        REALLOC COMPLETE                      18970000
         B     PREDRTRY           REDRIVE THE REQUEST                   18980000
                                                                        18990000
***************************************************************         19000000
*                                                                       19010000
*   Format predecessor linkage entry - R2 contains slot index           19020000
*                                                                       19030000
***************************************************************         19040000
                                                                        19050000
PREDFMT  DS    0H                                                       19060000
         MH    R2,=AL2(NVPENTLN)  COMPUTE FREE SLOT OFFSET              19070000
         LA    R3,NVPENTRY(R2)    ADDR OF FREE SLOT                     19080000
                                                                        19090000
         USING NVPENTRY,R3        PREPARE FOR SLOT CONSTRUCTION         19100000
         L     R1,S0PTR           FETCH PREDECESSOR STN PTR             19110000
         LA    R1,0(,R1)          CLEAR CREATION FLAG                   19120000
         ST    R1,NVPSTN          AND COMPLETE LINKAGE                  19130000
         DROP  R3                 SLOT CONSTRUCTION COMPLETE            19140000
                                                                        19150000
         L     R15,NVPCOUNT       NUMBER OF SLOTS IN USE                19160000
         LA    R15,1(,R15)        ACCOUNT FOR NEW ENTRY                 19170000
         ST    R15,NVPCOUNT       POST CURRENT USAGE                    19180000
         ST    R15,NVSTNPRE       PREDECESSOR COUNT SUMMARIZED IN STN   19190000
                                                                        19200000
*--------------------------------------------------------------         19210000
*   PREDECESSOR LINKAGE UPDATE COMPLETE                                 19220000
*--------------------------------------------------------------         19230000
                                                                        19240000
PREDRET  DS    0H                                                       19250000
         LM    R0,R14,REGSAVE     RESTORE MAINLINE REGS                 19260000
         SR    R15,R15            REFLECT COMPLETION STATUS VIA CC      19270000
         BR    R14                RETURN                                19280000
         DROP  R5,R4              NVPRED, NVSTN                         19290000
                                                                        19300000
         EJECT                                                          19310000
**<DOC-ON>*****************************************************         19320000
*                                                                       19330000
* ROUTINE: SUCCLINK - Construct successor link (S0->S1)                 19340000
*                                                                       19350000
* DESCRIPTION:                                                          19360000
*                                                                       19370000
*    This routine creates the predecessor->successor linkage            19380000
*    entries allowing all successors of given state to be               19390000
*    readily identified during STN scan.                                19400000
*                                                                       19410000
*    Successor linkages are represented by a list of successor          19420000
*    linkage blocks, with each block representing possible              19430000
*    state transitions resulting from a single AID key.                 19440000
*                                                                       19450000
*    If the successor node represents the transition from USS           19460000
*    (*VTAM*) to the initial state of an application, the               19470000
*    linkage entry is supplemented with a ptr to the principle          19480000
*    SYSRECORDING NVREC entry.                                          19490000
*                                                                       19500000
*                                                                       19510000
* NOTES:                                                                19520000
*                                                                       19530000
*    The successor chain is ordered by AID key then cond group.  160490 19540000
*    Note that when <GENERIC> conditionals are used, there       160490 19550000
*    are no unconditional successors for the same AID key.       160490 19560000
*                                                                       19570000
*                                                                       19580000
* ON ENTRY:                                                             19590000
*                                                                       19600000
*    S0PTR - addr of predecessor NVSTN entry                            19610000
*    S1PTR - addr of successor NVSTN entry                              19620000
*                                                                       19630000
**<DOC-OFF>****************************************************         19640000
                                                                        19650000
SUCCLINK DS    0H                                                       19660000
         STM   R0,R15,REGSAVE     SAVE MAINLINE REGS                    19670000
                                                                        19680000
         ST    R1,@SYSNAV         ACCEPT SYSNAVIGATION ENTRY            19690000
         L     R4,S0PTR           LOCATE S0 STN ENTRY                   19700000
         LA    R4,0(,R4)          CLEAR FLAGS                           19710000
         USING NVSTN,R4           MAP THE STN ENTRY                     19720000
                                                                        19730000
*--------------------------------------------------------------         19740000
*   LOCATE SUCCESSOR BLOCK CORRESPONDING TO GIVEN AID & COND            19750000
*--------------------------------------------------------------         19760000
                                                                        19770000
SUCCRTRY DS    0H                                                       19780000
         L     R2,@SYSNAV         RESTORE SYSNAV PTR                    19790000
         USING SNAVSECT,R2        PREPARE FOR SCAN                      19800000
         LA    R5,NVSTSUCC-(NVUNEXT-NVUSUCC)  OF SUCCESSOR BLOCKS       19810000
         USING NVUSUCC,R5         MAPPED                                19820000
                                                                        19830000
SUCCSCAN DS    0H                                                160490 19840000
         LR    R6,R5              PRESERVE ANCHOR ENTRY PTR      160490 19850000
         ICM   R5,15,NVUNEXT      ADVANCE TO NEXT SUCCESSOR      160490 19860000
         BZ    SUCCINS            END OF SUCCESSOR LIST REACHED  160490 19870000
         CLI   NVUAID,0           NEWLY ALLOCATED BLOCK?         160490 19880000
         BE    SUCCUSE            CLAIM FOR THIS AID             160490 19890000
         CLC   NVUAID,SNAVAID     LOCATE MATCHING AID            160490 19900000
         BL    SUCCSCAN           LIST IS ORDERED BY AID         160490 19910000
         BNE   SUCCINS            PROPER INSERT LOCATION FOUND   160490 19920000
                                                                        19930000
         CLC   NVUCGRP,SNAVCGRP   MATCHING COND GROUP IDS?       160490 19940000
         BL    SUCCSCAN           CONTINUE SCAN IF NOT           160490 19950000
         BE    SUCCUSE            ELSE PREALLOCATED SUCCESSOR    160490 19960000
                                                                        19970000
SUCCINS  DS    0H                 INSERT NEW NODE IN CHAIN       160490 19980000
         SR    R5,R5              NEW ALLOC, NOT REALLOCATION    160490 19990000
         B     SUCCNEW            R6 MARKS INSERT LOCATION       160490 20000000
         DROP  R2                 SNAVSECT                              20010000
                                                                        20020000
***************************************************************         20030000
*                                                                       20040000
*   Redundant pred->succ linkages are discarded.  However, some         20050000
*   attributes of the transition, including 'conditional', are          20060000
*   inherited from any SYSNAVIGATION occurance.                         20070000
*                                                                       20080000
***************************************************************         20090000
                                                                        20100000
SUCCUSE  DS    0H                                                       20110000
         ICM   R14,15,NVUCOUNT    ENTRIES PREVIOUSLY POSTED?            20120000
         BZ    SUCCCONT           SKIP IF NOT                           20130000
         LA    R3,NVUENTRY        LOCATE FIRST ENTRY                    20140000
         USING NVUENTRY,R3        ENTRY ADDRESSABILITY                  20150000
         L     R1,S1PTR           SUCCESSOR STN ENTRY                   20160000
         LA    R1,0(,R1)          REMOVE FLAG                           20170000
                                                                        20180000
SUCCDUPL DS    0H                                                       20190000
         C     R1,NVUSTN          MATCHING LINKAGE?                     20200000
         BE    SUCCMERG           NO NEW ENTRY IF SO                    20210000
         LA    R3,NVUENTLN(,R3)   ELSE ADVANCE TO NEXT ENTRY            20220000
         BCT   R14,SUCCDUPL       SCAN ALL ENTRIES                      20230000
         DROP  R3                 NVUENTRY                              20240000
                                                                        20250000
SUCCCONT DS    0H                                                       20260000
         L     R2,NVUCOUNT        NUMBER OF SLOTS IN USE                20270000
         C     R2,NVUSLOTS        FREE SLOTS REMAIN?                    20280000
         BL    SUCCFMT            READY FOR INSERT IF SO                20290000
                                                                        20300000
***************************************************************         20310000
*                                                                       20320000
*   (Re)allocate successor linkage block                                20330000
*                                                                       20340000
*   R5 - zero or addr of exhausted successor                            20350000
*   R6 - anchor successor entry                                         20360000
*                                                                       20370000
***************************************************************         20380000
                                                                        20390000
SUCCNEW  DS    0H                 ALLOC NEW SUCCESSOR LINKAGE BLOCK     20400000
         LR    R1,R5              R1 <== EXHAUSTED SUCCESSOR OR ZERO    20410000
         LR    R0,R6              R0 <== ANCHOR NVUSUCC ENTRY IN CHAIN  20420000
         BAS   R14,SUCCREAL       REALLOCATE                            20430000
         B     SUCCRTRY           REDRIVE THE REQUEST                   20440000
                                                                        20450000
***************************************************************         20460000
*                                                                       20470000
*   Format successor linkage entry - R2 contains slot index             20480000
*                                                                       20490000
***************************************************************         20500000
                                                                        20510000
SUCCFMT  DS    0H                                                       20520000
         MH    R2,=AL2(NVUENTLN)  COMPUTE FREE SLOT OFFSET              20530000
         LA    R3,NVUENTRY(R2)    ADDR OF FREE SLOT                     20540000
         USING NVUENTRY,R3        PREPARE FOR SLOT CONSTRUCTION         20550000
                                                                        20560000
         L     R2,@SYSNAV         RECALL PASSED SYSNAVIGATION ENTRY     20570000
         USING SNAVSECT,R2        ADDRESSABILITY                        20580000
                                                                        20590000
*--------------------------------------------------------------         20600000
*   CONSTRUCT BASIC SUCCESSOR ENTRY                                     20610000
*--------------------------------------------------------------         20620000
                                                                        20630000
         L     R1,S1PTR           FETCH SUCCESSOR STN PTR               20640000
         LA    R1,0(,R1)          CLEAR CREATION FLAG                   20650000
         ST    R1,NVUSTN          AND COMPLETE LINKAGE                  20660000
                                                                        20670000
         MVC   NVUAID,SNAVAID     RETAIN TRANSITIONING AID KEY          20680000
         MVC   NVUCSRP,SNAVCSRP   RETAIN TRANSITIONING CURSOR POSITION  20690000
         MVC   NVUSKSID,SNAVSKSK  ASSOCIATED SKS ROWID OR ZERO          20700000
         MVC   NVUIMGID,SNAVLKEY  RETAIN BASE SYSIMAGE ROWID OR ZERO    20710000
         MVC   NVUCGRP,SNAVCGRP   CONDITIONAL GROUP IDS                 20720000
         L     R15,NVUCOUNT       NUMBER OF SLOTS IN USE                20730000
         LA    R15,1(,R15)        ACCOUNT FOR NEW ENTRY                 20740000
         ST    R15,NVUCOUNT       POST CURRENT USAGE                    20750000
                                                                        20760000
         L     R15,NVSTNSUC       NUMBER OF SUCCESSORS SUMMARIZED       20770000
         LA    R15,1(,R15)        IN STN                                20780000
         ST    R15,NVSTNSUC                                             20790000
                                                                        20800000
*--------------------------------------------------------------         20810000
*   ATTACH APPLICATION INFORMATION IF PREDECESSOR IS *VTAM*             20820000
*--------------------------------------------------------------         20830000
                                                                        20840000
         TM    NVSFLG,NVSFUSS     PREDECESSOR IS START OF APPL?         20850000
         BNO   SUCCMERG           DONE HERE IF NOT                      20860000
                                                                        20870000
         $ENTITY EXTR,            LOCATE RECORDING/APPL BRIDGE ENTITY  X20880000
               QNAME=CSTRREC,     RECORDING QUALIFIER                  X20890000
               ENTITY=SNAVSREC,   RECORDING NAME                       X20900000
               USERDATA=USERAREA,                                      X20910000
               ANCHOR=@ENTITY,                                         X20920000
               MF=(E,MFE_LIST)                                          20930000
                                                                        20940000
         CH    R15,=AL2(RC04)     TEST COMPLETION STATUS                20950000
         BL    SUCCAPPL           ATTACH TRANSITION TO APPLICATION      20960000
         BE    SUCCMERG           ERROR (AND PROBABLY DEADLY LATER)     20970000
         EX    R0,*               ASSERT 'PROPERLY FORMULATED REQ'      20980000
                                                                        20990000
SUCCAPPL DS    0H                                                       21000000
         MVC   NVUSPECL,USERAREA  LABEL TRANSITION WITH APPL INFO       21010000
         DROP  R2                 SNAVSECT                              21020000
                                                                        21030000
***************************************************************         21040000
*                                                                       21050000
*   Common segment for merging attributes into new or existing          21060000
*   pred->succ linkages.                                                21070000
*                                                                       21080000
*   NVSTN and NVUENTRY are addressable                                  21090000
*                                                                       21100000
***************************************************************         21110000
                                                                        21120000
SUCCMERG DS    0H                                                       21130000
         L     R2,@SYSNAV         RESTORE SYSNAV PTR                    21140000
         USING SNAVSECT,R2        SYSNAVIGATION ROW                     21150000
                                                                        21160000
         OC    NVSFLG2,SNAVFLG2   SUMMARIZE SUCCESSOR ATTRIBUTES        21170000
         NI    NVSFLG2,NVS2MAID+NVS2TSEL   ONLY THOSE OF INTEREST       21180000
                                                                        21190000
*--------------------------------------------------------------         21200000
*   IDENTIFY MULTIPLE CONDITIONAL DESTINATIONS                          21210000
*--------------------------------------------------------------         21220000
                                                                        21230000
         TM    SNAVFLG2,SNV2MAID  MULTIPLE (CONDITIONAL) DESTINATIONS?  21240000
         BNO   SUCCMEND           SKIP IF NOT                           21250000
         MVI   NVUMAID,TRUE       MARK ALL SUCCESSORS AS CONDITIONAL    21260000
         OI    NVUATTRS,NVUACOND  PRED->SUCC IS EXPLICITLY CONDITIONAL  21270000
                                                                        21280000
SUCCMEND DS    0H                                                       21290000
                                                                        21300000
*--------------------------------------------------------------         21310000
*   IDENTIFY TABLE SELECT CAPABILITIES                                  21320000
*--------------------------------------------------------------         21330000
                                                                        21340000
         TM    SNAVFLG2,SNV2TSEL  TABLE SELECT OPERATION?               21350000
         BNO   *+8                SKIP IF NOT                           21360000
         OI    NVUATTRS,NVUATSEL  PRED->SUCC IS A TABLE SELECT          21370000
         DROP  R3,R2              NVUENTRY, SNAVSECT                    21380000
                                                                        21390000
*--------------------------------------------------------------         21400000
*   PREDECESSOR LINKAGE UPDATE COMPLETE                                 21410000
*--------------------------------------------------------------         21420000
                                                                        21430000
         LM    R0,R14,REGSAVE     RESTORE MAINLINE REGS                 21440000
         SR    R15,R15            REFLECT COMPLETION STATUS VIA CC      21450000
         BR    R14                RETURN                                21460000
         DROP  R5,R4              NVUSUCC, NVSTN                        21470000
                                                                        21480000
         EJECT                                                          21490000
***************************************************************         21500000
*                                                                       21510000
* ROUTINE:  SUCCREAL - ALlocate or expand successor linkage block       21520000
*                                                                       21530000
* DESCRIPTION:                                                          21540000
*                                                                       21550000
*    Allocate / reallocate the passed successor linkage block           21560000
*    when no space remains in the current block.  The block is          21570000
*    expanded and the contents of the old block are then copied         21580000
*    into the new extent.                                               21590000
*                                                                       21600000
*                                                                       21610000
* ON ENTRY:                                                             21620000
*                                                                       21630000
*    R1 - addr of exhausted NVUSUCC or zero if new allocation           21640000
*    R0 - addr of prev NVUSUCC in chain used to anchor new block        21650000
*                                                                       21660000
*                                                                       21670000
* ON EXIT:                                                              21680000
*                                                                       21690000
*    R1 - addr of new nvusucc block                                     21700000
*                                                                       21710000
***************************************************************         21720000
                                                                        21730000
SUCCREAL DS    0H                                                       21740000
         STM   R0,R15,REGSAVEX    SAVE CALLERS REGS                     21750000
         LR    R4,R0              PRESERVE ADDRESS OF STN               21760000
PREV     USING NVUSUCC,R4         PRIVATE ADDRESSABILITY                21770000
         LR    R5,R1              EXHAUSTED NVUSUCC ENTRY OR ZERO       21780000
         USING NVUSUCC,R5         STANDARD ADDRESSABILITY               21790000
                                                                        21800000
         LA    R1,##SLOTS         DEFAULT SLOT COUNT FOR NEW BLOCK      21810000
         LTR   R5,R5              REPLACING CURRENT SUCC LINKAGE?       21820000
         BZ    SUCCGET            SKIP IF NOT                           21830000
         L     R1,NVUSLOTS        CURRENT SLOT COUNT                    21840000
         AR    R1,R1              DOUBLED IN NEW BLOCK                  21850000
                                                                        21860000
SUCCGET  DS    0H                                                       21870000
         ST    R1,NEWSLOTS        PRESERVE NEW BLOCK SLOT COUNT         21880000
         MH    R1,=AL2(NVUENTLN)  LENGTH OF EACH SLOT                   21890000
         LA    R3,NVUSUCFX(R1)    TOTAL LENGTH OF SUCCESSOR BLOCK       21900000
                                                                        21910000
         STGGET (R3),QH=PRJEXSTG  ACQUIRE NEW BLOCK                     21920000
         BNZ   ABN_STG            STORAGE FAILURE                       21930000
                                                                        21940000
         LR    R6,R1              PRESERVE ACQUIRED STORAGE ADDRESS     21950000
                                                                        21960000
*--------------------------------------------------------------         21970000
*   RETAIN CONTENTS OF REPLACED SUCCESSOR BLOCK                         21980000
*--------------------------------------------------------------         21990000
                                                                        22000000
         LTR   R5,R5              SUCCESSOR LINKAGE REPLACEMENT?        22010000
         BZ    SUCCREND           SKIP THE COPY IF NOT                  22020000
                                                                        22030000
         LR    R0,R6              NEW STORAGE                           22040000
         L     R1,NVUSIZE         SIZE OF PRIOR BLOCK                   22050000
         LA    R14,NVUSUCC        OLD BLOCK ORIGIN                      22060000
         LR    R15,R1             SOURCE LENGTH = TARGET LENGTH         22070000
         MVCL  R0,R14             COPY                                  22080000
                                                                        22090000
         L     R2,NVUSIZE         SIZE OF OLD BLOCK                     22100000
                                                                        22110000
         STGRETN ADDR=(R5),LEN=(R2),QH=PRJEXSTG                         22120000
         BNZ   ABN_STG            STORAGE MANAGEMENT FAILURE            22130000
                                                                        22140000
*--------------------------------------------------------------         22150000
*   COMPLETE THE CONSTRUCTION OF THE NEW SUCCESSOR BLOCK                22160000
*--------------------------------------------------------------         22170000
                                                                        22180000
SUCCREND DS    0H                                                       22190000
         LTR   R5,R5              SUCCESSOR LINKAGE REPLACEMENT? 160490 22200000
         BNZ   *+10               SKIP IF SO, LINK ALREADY SET   160490 22210000
         MVC   NVUNEXT-NVUSUCC(,R6),PREV.NVUNEXT                 160490 22220000
                                                                        22230000
         ST    R6,PREV.NVUNEXT    UPDATE (NOP) SUCCESSOR CHAIN          22240000
         LR    R5,R6              CAST NEW EXTENT AS SUCCESSOR BLOCK    22250000
         ST    R3,NVUSIZE         SIZE OF NEW BLOCK                     22260000
         MVC   NVUSLOTS,NEWSLOTS  SLOT COUNT USED FOR (RE)ALLOC         22270000
                                                                        22280000
*--------------------------------------------------------------         22290000
*   RETURN SUCCESSOR NODE TO REQUESTER                                  22300000
*--------------------------------------------------------------         22310000
                                                                        22320000
         LR    R1,R5              RETURN PTR TO NEW BLOCK               22330000
         SR    R15,R15            RETURN CODES NOT DEFINED              22340000
         LM    R2,R14,REGSAVEX+8  RESTORE REGS                          22350000
         BR    R14                RETURN                                22360000
         DROP  PREV,R5            PREV, CURRENT SUCCESSOR BLOCKS        22370000
                                                                        22380000
         EJECT                                                          22390000
**<DOC-ON>*****************************************************         22400000
*                                                                       22410000
* ROUTINE: APPLGRP - Loc/create NVREC uniquely identifying appl         22420000
*                                                                       22430000
* DESCRIPTION:                                                          22440000
*                                                                       22450000
*    This routine locates or creates a $ENTITY node                     22460000
*    representing an application name / logmode combination             22470000
*    which uniquely identifies a host application.  The                 22480000
*    $ENTITY contains the address of the first NVREC created            22490000
*    that has that appl/logmode combination, referred to as             22500000
*    the "principle NVREC".  That address is used throughout            22510000
*    the navigation network to identify a single application            22520000
*    without regard for the specific recording the navigation           22530000
*    information was obtained from.                                     22540000
*                                                                       22550000
*                                                                       22560000
* ON ENTRY:                                                             22570000
*                                                                       22580000
*    R1 - addr of an NVREC entry                                        22590000
*                                                                       22600000
*                                                                       22610000
* ON EXIT:                                                              22620000
*                                                                       22630000
*    R1 - addr of the first NVREC posted having the same                22640000
*         application name and logmode as the given NVREC               22650000
*                                                                       22660000
**<DOC-OFF>****************************************************         22670000
                                                                        22680000
APPLGRP  DS    0H                                                       22690000
         STM   R0,R15,REGSAVE     SAVE MAINLINE REGS                    22700000
         LR    R4,R1              ACCEPT CANDIDATE NVREC                22710000
         USING NVREC,R4           MAPPED                                22720000
                                                                        22730000
*--------------------------------------------------------------         22740000
*   DETERMINE WHETHER APPLICATION WAS PREVIOUSLY DEFINED                22750000
*--------------------------------------------------------------         22760000
                                                                        22770000
         $ENTITY EXTR,            LOCATE ENTITY                        X22780000
               QNAME=CSTRAPPL,    ENTITY IS AN APPLICATION             X22790000
               ENTITY=(NVRAPPID,NVRAPPLN),                             X22800000
               USERDATA=USERAREA,                                      X22810000
               ANCHOR=@ENTITY,                                         X22820000
               MF=(E,MFE_LIST)                                          22830000
                                                                        22840000
         CH    R15,=AL2(RC04)     TEST COMPLETION STATUS                22850000
         BL    APPLHIT            APPLICATION PREVIOUSLY REGISTERED     22860000
         BE    APPLREG            REGISTRATION REQUIRED                 22870000
         EX    R0,*               ASSERT 'PROPERLY FORMULATED REQ'      22880000
                                                                        22890000
APPLHIT  DS    0H                                                       22900000
         L     R1,USERAREA        RETURN 'MAIN' NVREC                   22910000
         B     APPLFIN            DONE                                  22920000
                                                                        22930000
*--------------------------------------------------------------         22940000
*   ENROLL THE APPLICATION REPRESENTED BY CANDIDATE NVREC               22950000
*--------------------------------------------------------------         22960000
                                                                        22970000
APPLREG  DS    0H                                                       22980000
         ST    R4,USERAREA        $ENTITY IS NVREC LOCATOR              22990000
                                                                        23000000
         $ENTITY ADD,             ENROLL THE STATE/IMAGE               X23010000
               QNAME=CSTRAPPL,    ENTITY IS AN APPLICATION             X23020000
               ENTITY=(NVRAPPID,NVRAPPLN),                             X23030000
               TOKEN=DWORD,       TOKEN WILL BE DISCARDED              X23040000
               USERDATA=USERAREA, ASSOCIATE NAME TO BLOCK ORIGIN       X23050000
               ANCHOR=@ENTITY,    LOCAL ENTITY STRUCTURE ANCHOR        X23060000
               MF=(E,MFE_LIST)                                          23070000
                                                                        23080000
         BZ    *+8                ONWARD IF SATISFIED                   23090000
         EX    R0,*               ASSERT 'PROPERLY FORMULATED REQ'      23100000
                                                                        23110000
         LA    R1,NVREC           CANDIDATE NVREC IS 'MAIN' NVREC       23120000
                                                                        23130000
*--------------------------------------------------------------         23140000
*   RETURN MAIN NVREC TO REQUESTER                                      23150000
*--------------------------------------------------------------         23160000
                                                                        23170000
APPLFIN  DS    0H                                                       23180000
         LM    R2,R14,REGSAVE+8   RESTORE MAINLINE REGS                 23190000
         SR    R15,R15            RETCODE NOT DEFINED                   23200000
         BR    R14                RETURN                                23210000
         DROP  R4                 NVREC                                 23220000
                                                                        23230000
         EJECT                                                          23240000
**<DOC-ON>*****************************************************         23250000
*                                                                       23260000
* ROUTINE: IDAPPL - Locate NVREC uniquely identifying appl              23270000
*                                                                       23280000
* DESCRIPTION:                                                          23290000
*                                                                       23300000
*    Tthis routine returns the address of the principle NVREC           23310000
*    of a set of NVREC nodes that each define the appl/logmode          23320000
*    of the host application on which a named recording is based.       23330000
*                                                                       23340000
*                                                                       23350000
* ON ENTRY:                                                             23360000
*                                                                       23370000
*    R1 - addr of a recording name                                      23380000
*                                                                       23390000
*                                                                       23400000
* ON EXIT:                                                              23410000
*                                                                       23420000
*    R15 contains one of the following return codes                     23430000
*                                                                       23440000
*        RC00 - NVREC located and returned via R1                       23450000
*                                                                       23460000
*        RC04 - recording not defined                                   23470000
*                                                                       23480000
**<DOC-OFF>****************************************************         23490000
                                                                        23500000
IDAPPL   DS    0H                                                       23510000
         STM   R0,R15,REGSAVE     SAVE MAINLINE REGS                    23520000
         LR    R2,R1              ACCEPT CANDIDATE NVREC                23530000
                                                                        23540000
*--------------------------------------------------------------         23550000
*   LOCATE RECORDING NVREC BY NAME                                      23560000
*--------------------------------------------------------------         23570000
                                                                        23580000
         $ENTITY EXTR,            LOCATE ENTITY                        X23590000
               QNAME=CSTRREC,     ENTITY IS A RECORDING NAME           X23600000
               ENTITY=((R2),L'NVRNAME),                                X23610000
               USERDATA=USERAREA,                                      X23620000
               ANCHOR=@ENTITY,                                         X23630000
               MF=(E,MFE_LIST)                                          23640000
                                                                        23650000
         CH    R15,=AL2(RC04)     TEST COMPLETION STATUS                23660000
         BL    IDAMATCH           RECORDING NAME RECOGNZIED             23670000
         BE    IDARET             RECORDING NOT DEFINED                 23680000
         EX    R0,*               ASSERT 'PROPERLY FORMULATED REQ'      23690000
                                                                        23700000
IDAMATCH DS    0H                                                       23710000
         L     R1,USERAREA            NVREC PTR                         23720000
         L     R1,NVRMAIN-NVREC(,R1)  MAIN NVREC                        23730000
                                                                        23740000
*--------------------------------------------------------------         23750000
*   RETURN MAIN NVREC TO REQUESTER                                      23760000
*--------------------------------------------------------------         23770000
                                                                        23780000
IDARET   DS    0H                                                       23790000
         LM    R2,R14,REGSAVE+8   RESTORE MAINLINE REGS                 23800000
         LTR   R15,R15            REFLECT COMPLETION STATUS VIA CC      23810000
         BR    R14                RETURN                                23820000
                                                                        23830000
         EJECT                                                          23840000
**<DOC-ON>*****************************************************         23850000
*                                                                       23860000
* ROUTINE: RSMPROC - Process resume state record                        23870000
*                                                                       23880000
* DESCRIPTION:                                                          23890000
*                                                                       23900000
*    This routine will accept a resume state (SAR) SYSNAVIGATION        23910000
*    record and validate that the specified resume state                23920000
*    screen matches the associated S1 state.                            23930000
*                                                                       23940000
*                                                                       23950000
* ON ENTRY:                                                             23960000
*                                                                       23970000
*    R1 - addr of SYSNAVIGATION record                                  23980000
*                                                                       23990000
*                                                                       24000000
* ON EXIT:                                                              24010000
*                                                                       24020000
*    RETCMASK and RSNCODE are updated to reflect SAR (RESUME)           24030000
*    validation errors and warnings                                     24040000
*                                                                       24050000
**<DOC-OFF>****************************************************         24060000
                                                                        24070000
RSMPROC  DS    0H                                                       24080000
         STM   R0,R15,REGSAVE     SAVE MAINLINE REGS                    24090000
         LR    R5,R1              ACCEPT SYSNAV RECORD                  24100000
         USING SNAVSECT,R5        ADDRESSABILITY                        24110000
                                                                        24120000
         LA    R1,SNAVLSCR        SSET/IMAGE NAME FOR S0 STATE          24130000
         BAS   R14,LOCSTN         LOCATE ASSOCIATED STN                 24140000
         ST    R1,S0PTR           RETAIN S0 STN PTR                     24150000
                                                                        24160000
         LA    R1,SNAVRSCR        SSET/IMAGE NAME FOR S1 STATE          24170000
         BAS   R14,LOCSTN         LOCATE ASSOCIATED STN                 24180000
         ST    R1,S1PTR           RETAIN S1 STN PTR                     24190000
                                                                        24200000
         ICM   R1,15,S0PTR        RESTING STATE IDENTIFIED?             24210000
         BZ    RSMERROR           DOCUMENT STATE REFERENCE ERROR        24220000
         ICM   R0,15,S1PTR        RESUMPTION STATE IDENTIFIED?          24230000
         BZ    RSMERROR           DOCUMENT STATE REFERENCE ERROR        24240000
         BAS   R14,RSMCOMP        COMPARE ASSOCIATED STATES             24250000
         BNZ   RSMNOMCH           NO MATCH,  NOTIFY OF ERROR            24260000
                                                                        24270000
         USING NVSTN,R1           STN ADDRESSABILITY                    24280000
         ST    R0,NVSRESUM        POST RESUMPTION STATE ADDRESS         24290000
         LA    R15,RC00           NORMAL COMPLETION                     24300000
         B     RSMEXIT            FETCH NEXT SYSNAV ROW                 24310000
         DROP  R1                                                       24320000
                                                                        24330000
*--------------------------------------------------------------         24340000
*   RESUME STATE DOES NOT COMPARE TO FINAL OUTPUT STATE                 24350000
*--------------------------------------------------------------         24360000
                                                                        24370000
RSMNOMCH DS    0H                                                       24380000
         BAS   R14,RSM_MSG1       DOCUMENT INVALID STATE ASSOC          24390000
                                                                        24400000
         L     R1,CIRSNCD         IMAGE FUNCTION REASON CODE            24410000
         @CALL IIMGDIAG,CTYPE=CVT                                       24420000
         LR    R2,R1              ADDRESS OF MESSAGE SEGMENT            24430000
         LR    R3,R0              LENGTH  OF MESSAGE SEGMENT            24440000
                                                                        24450000
         $MSG  037,FIELDS=(((R2),(R3)))                                 24460000
                                                                        24470000
         B     RSMWARN            SET WARNING COMPLETION STATUS         24480000
                                                                        24490000
*--------------------------------------------------------------         24500000
*   INVALID STATE REFERENCE(S) FOUND IN SAR ENTRY                       24510000
*--------------------------------------------------------------         24520000
                                                                        24530000
RSMERROR DS    0H                                                       24540000
         BAS   R14,RSM_MSG1       DOCUMENT INVALID STATE ASSOC          24550000
                                                                        24560000
         LA    R1,SNAVLSCR        ASSUME S0 NOT DEFINED                 24570000
         ICM   R0,15,S0PTR        CORRECT?                              24580000
         BNZ   *+8                SKIP DIAGNOSTIC                       24590000
         BAS   R14,RSM_MSG2       ISSUE DIAGNOSTIC                      24600000
                                                                        24610000
         LA    R1,SNAVRSCR        ASSUME S1 NOT DEFINED                 24620000
         ICM   R0,15,S1PTR        CORRECT?                              24630000
         BNZ   *+8                SKIP DIAGNOSTIC                       24640000
         BAS   R14,RSM_MSG2       ISSUE DIAGNOSTIC                      24650000
                                                                        24660000
*--------------------------------------------------------------         24670000
*   UPDATE COMPLETION STATUS                                            24680000
*--------------------------------------------------------------         24690000
                                                                        24700000
RSMWARN  DS    0H                                                       24710000
         OI    RETCMASK,$RC04     INDICATE WARNING                      24720000
         LA    R0,RSN32           INVALID SAR ENTRY                     24730000
         O     R0,RSNCODE         COMPOSITE REASON CODE                 24740000
         ST    R0,RSNCODE         RETAIN RSNCODE SUPPLEMENT             24750000
                                                                        24760000
*--------------------------------------------------------------         24770000
*   RETURN                                                              24780000
*--------------------------------------------------------------         24790000
                                                                        24800000
RSMEXIT  DS    0H                                                       24810000
         LM    R0,R14,REGSAVE     RESTORE CALLER'S REGISTERS            24820000
         BR    R14                RETURN                                24830000
                                                                        24840000
*--------------------------------------------------------------         24850000
*  STATE ASSOCIATION MESSAGE ROUTINES                                   24860000
*--------------------------------------------------------------         24870000
                                                                        24880000
RSM_MSG1 DS    0H                                                       24890000
         ST    R14,FWORD          PRESERVE RETURN ADDRESS               24900000
                                                                        24910000
         $MSG   035,FIELDS=(SNAVSREC,SNAVRSCR,SNAVLSCR)                 24920000
                                                                        24930000
         L     R14,FWORD          RESTORE RETURN ADDR                   24940000
         BR    R14                RETURN                                24950000
                                                                        24960000
RSM_MSG2 DS    0H                 RSM VALIDATION MSG RTN                24970000
         ST    R14,FWORD          PRESERVE RETURN ADDRESS               24980000
         LR    R2,R1              STATE NAME                            24990000
                                                                        25000000
         $MSG  036,FIELDS=(((R2),L'SNAVLSCR))                           25010000
                                                                        25020000
         L     R14,FWORD          RESTORE RETURN ADDR                   25030000
         BR    R14                RETURN                                25040000
                                                                        25050000
         DROP  R5                 SNAVSECT                              25060000
                                                                        25070000
         EJECT                                                          25080000
**<DOC-ON>*****************************************************         25090000
*                                                                       25100000
* ROUTINE: RSMCOMP - Compare resume state with associated state         25110000
*                                                                       25120000
* ON ENTRY:                                                             25130000
*                                                                       25140000
*    R0 - addr of NVSTN of resume state                                 25150000
*    R1 - addr of NVSTN of final resting state                          25160000
*                                                                       25170000
* ON EXIT:                                                              25180000
*                                                                       25190000
*    R15 -  0 - resume state matches associated state                   25200000
*          >0 - states are not equal                                    25210000
*                                                                       25220000
**<DOC-OFF>****************************************************         25230000
                                                                        25240000
RSMCOMP  DS    0H                                                       25250000
         STM   R0,R15,REGSAVEX    SAVE MAINLINE REGS                    25260000
                                                                        25270000
         LR    R5,R0              ADDR OF RESUME STN                    25280000
RSTN     USING NVSTN,R5           ADDRESSABILITY                        25290000
         LR    R4,R1              ADDR OF FINAL  STN                    25300000
FSTN     USING NVSTN,R4           ADDRESSABILITY                        25310000
                                                                        25320000
         LA    R15,RC00           ASSUME SUCCESSFUL COMPLETION          25330000
         ST    R15,FWORD          INITIALIZE COMPARE COMPLETION CODE    25340000
                                                                        25350000
*--------------------------------------------------------------         25360000
*  LOAD RESUME STATE IMAGE                                              25370000
*--------------------------------------------------------------         25380000
                                                                        25390000
         $CLINK FUNC=IMGLOAD,     LOAD/CONSTRUCT IMAGE FOR STN (RESUM) X25400000
               (STRUCT*,PRJEXSTG),                                     X25410000
               (STRUCT*,RSTN.NVSTN)                                     25420000
                                                                        25430000
         ST    R15,FWORD          SAVE CURRENT COMPLETION STATUS        25440000
         C     R15,=A(RC04)                                      156082 25450000
         BH    RSMCPRET           NO, FAIL SAR STN COMPARE       156082 25460000
                                                                        25470000
*--------------------------------------------------------------         25480000
*  LOAD FINAL RESTING STATE IMAGE.  CLEAR REGION TREE ADDRESS           25490000
*  ASSOCIATED WITH THIS IMAGE TO ENABLE IMAGE TO BE TILED               25500000
*  WITH RESUME STATES REGION TREE.                                      25510000
*--------------------------------------------------------------         25520000
                                                                        25530000
         $CLINK FUNC=IMGLOAD,     LOAD/CONSTRUCT IMAGE FOR STN (FINAL) X25540000
               (STRUCT*,PRJEXSTG),                                     X25550000
               (STRUCT*,FSTN.NVSTN)                                     25560000
                                                                        25570000
         ST    R15,FWORD          SAVE CURRENT COMPLETION STATUS        25580000
         C     R15,=A(RC04)                                      156082 25590000
         BH    RSMCPRET           NO, FAIL SAR STN COMPARE       156082 25600000
                                                                        25610000
         ICM   R3,15,FSTN.NVSIMGA ADDRESS OF FINAL STATE IMAGE          25620000
         BZ    RSMCPREP                                                 25630000
         USING NVIMAGE,R3         ADDRESSABILITY                        25640000
         XC    NVIRGNTR,NVIRGNTR  RESET FINAL STN RGNTREE               25650000
         DROP  R3                 NVIMAGE                               25660000
                                                                        25670000
*--------------------------------------------------------------         25680000
*  PREPARE IMAGES FOR COMPARE USING RESUME STATE'S REGION TREE          25690000
*--------------------------------------------------------------         25700000
                                                                        25710000
RSMCPREP DS    0H                                                       25720000
         $CLINK FUNC=IMGPREP,         TILE RESTING STATE IMAGE USING   X25730000
               (STRUCT*,PRJEXSTG),    REGION TREE FROM RESUME STATE    X25740000
               (LONG,RSTN.NVSIMGA),   IN PREPARATION FOR IMAGE COMPARE X25750000
               (LONG,FSTN.NVSIMGA),                                    X25760000
               (STRUCT*,$CMPINFO)                                       25770000
                                                                        25780000
         ST    R15,FWORD          SAVE CURRENT COMPLETION STATUS        25790000
         LTR   R15,R15            PREPARE SUCCESSFUL?                   25800000
         BNZ   RSMCPCLN           NO, FREE IMAGE STRUCTURES             25810000
                                                                        25820000
*--------------------------------------------------------------         25830000
*  COMPARE ASSOCIATED IMAGES                                            25840000
*--------------------------------------------------------------         25850000
                                                                        25860000
         L     R1,TSKPCBC         ADDRESS OF CURRENT PROCESS            25870000
         USING IPCB,R1            TEMP ADDRESSABILITY                   25880000
         LA    R2,PCBSTG          ADDRESS OF WORKING STG QUEUE HDR      25890000
         DROP  R1                 IPCB                                  25900000
                                                                        25910000
         $CLINK FUNC=IMGCMP,          COMPARE FINAL RESTING STATE      X25920000
               (STRUCT*,(R2)),        WITH ASSOCIATED RESTING          X25930000
               (LONG,RSTN.NVSIMGA),   STATE IMAGE                      X25940000
               (LONG,FSTN.NVSIMGA),                                    X25950000
               (STRUCT*,$CMPINFO)                                       25960000
                                                                        25970000
         ST    R15,FWORD          SAVE CURRENT COMPLETION STATUS        25980000
                                                                        25990000
*--------------------------------------------------------------         26000000
*  FREE IMAGE STRUCTURES AND RETURN                                     26010000
*--------------------------------------------------------------         26020000
                                                                        26030000
RSMCPCLN DS    0H                                                       26040000
         $CLINK FUNC=IMGFREE,     FREE FINAL STATE IMAGE STRUCTURE     X26050000
               (STRUCT*,PRJEXSTG),                                     X26060000
               (STRUCT**,FSTN.NVSIMGA)                                  26070000
                                                                        26080000
         $CLINK FUNC=IMGFREE,     FREE RESUME STATE IMAGE STRUCTURE    X26090000
               (STRUCT*,PRJEXSTG),                                     X26100000
               (STRUCT**,RSTN.NVSIMGA)                                  26110000
                                                                        26120000
RSMCPRET DS    0H                                                       26130000
         LM    R0,R14,REGSAVEX    RESTORE MAINLINE REGS                 26140000
         ICM   R15,15,FWORD       REFLECT COMPLETION STATE VIA CC       26150000
         BR    R14                RETURN                                26160000
         DROP  FSTN,RSTN          FINAL RESTING STN, RESUME STN         26170000
                                                                        26180000
         EJECT                                                          26190000
**<DOC-ON>*****************************************************         26200000
*                                                                       26210000
* ROUTINE: DOCREC - Document invalid SYSRECORDINGs entry                26220000
*                                                                       26230000
* DESCRIPTION:                                                          26240000
*                                                                       26250000
*    When a recording is initiated, a provisional SYSRECORDINGs         26260000
*    entry is cataloged to reserve the recording name.  The             26270000
*    recording itself is not cataloged until so directed by the         26280000
*    user or end of session.  If the system fails in the                26290000
*    meantime, the provisional SYSRECORDINGs entry will not be          26300000
*    deleted.  We take this opportunity to inform the user of           26310000
*    the situation.                                                     26320000
*                                                                       26330000
*    The global reason code will be set to reflect the presence         26340000
*    of an invalid SYSRECORDINGs entry.                                 26350000
*                                                                       26360000
* ON ENTRY:                                                             26370000
*                                                                       26380000
*    R1 - addr of the invalid SYSRECORDINGs entry                       26390000
*                                                                       26400000
**<DOC-OFF>****************************************************         26410000
                                                                        26420000
DOCREC   DS    0H                                                       26430000
         STM   R0,R15,REGSAVEX    PRESERVE MAINLINE REGS                26440000
         LR    R2,R1              SYSRECORDINGS ENTRY NAME              26450000
                                                                        26460000
         $MSG  010,FIELDS=(((R2),L'SRECNAME))                           26470000
                                                                        26480000
         OI    RETCMASK,$RC04     INDICATE WARNINGS                     26490000
         LA    R15,RSN04          INDICATE INVALID SYSRECORDING         26500000
         O     R15,RSNCODE        RETAIN ALL INDICATORS                 26510000
         ST    R15,RSNCODE        RETAIN RSNCODE SUPPLEMENT             26520000
                                                                        26530000
         LM    R0,R14,REGSAVEX    RESTORE MAINLINE REGS                 26540000
         SR    R15,R15            RETCODE NOT DEFINED                   26550000
         BR    R14                                                      26560000
                                                                        26570000
         EJECT                                                          26580000
**<DOC-ON>*****************************************************         26590000
*                                                                       26600000
* ROUTINE: DOCNAV - Document invalid SYSNAVIGATION entry                26610000
*                                                                       26620000
* DESCRIPTION:                                                          26630000
*                                                                       26640000
*    The SYSNAVIGATION entry provided as input is invalid.              26650000
*    A message code is provided describing the specific source          26660000
*    of error.                                                          26670000
*                                                                       26680000
* ON ENTRY:                                                             26690000
*                                                                       26700000
*    R0  - message ID                                                   26710000
*    R1  - addr of the invalid SYSNAVIGATION entry                      26720000
*    R15 - severity code in RETCMASK format                             26730000
*                                                                       26740000
**<DOC-OFF>****************************************************         26750000
                                                                        26760000
DOCNAV   DS    0H                                                       26770000
         STM   R0,R15,REGSAVEX    PRESERVE MAINLINE REGS                26780000
         LR    R2,R0              MESSAGE ID                            26790000
         STC   R15,BYTE           SEVERITY                              26800000
                                                                        26810000
*--------------------------------------------------------------         26820000
*   CONSTRUCT SCREEN SET NAME                                           26830000
*--------------------------------------------------------------         26840000
                                                                        26850000
         LR    R5,R1              SYSNAVIGATION ENTRY ACCEPTED          26860000
         USING SNAVSECT,R5        MAPPED                                26870000
                                                                        26880000
         MVC   SSET,SNAVSSET      IDENTIFY SCREEN SET                   26890000
         TM    SNAVSSET,BF        MEMBERS OF SCREEN SET?                26900000
         BNZ   DOCNMSG            SKIP IF SO                            26910000
         MVC   SSET,BLANKS        CLEAR THE SCREEN SET NAME             26920000
         MVC   SSET(3),=C'N/A'    NO SCREEN SET NAMED                   26930000
                                                                        26940000
*--------------------------------------------------------------         26950000
*   ISSUE BACKGROUND AND SUPPLEMENTAL MESSAGE                           26960000
*--------------------------------------------------------------         26970000
                                                                        26980000
DOCNMSG  DS    0H                                                       26990000
         $MSG  011,FIELDS=(SNAVSREC,SSET,SNAVLSCR,SNAVRSCR)             27000000
                                                                        27010000
         $MSG  (R2)               DETAIL MSG                            27020000
                                                                        27030000
*--------------------------------------------------------------         27040000
*   POST USER-SUPPLIED RETCODE AND STANDARD RSNCODE                     27050000
*--------------------------------------------------------------         27060000
                                                                        27070000
         OC    RETCMASK,BYTE      RESTORE USER-SUPPLIED SEVERITY        27080000
         LA    R0,RSN08           INDICATE INVALID SYSNAVIGATION        27090000
         O     R0,RSNCODE         RETAIN ALL INDICATORS                 27100000
         ST    R0,RSNCODE         RETAIN RSNCODE SUPPLEMENT             27110000
                                                                        27120000
*--------------------------------------------------------------         27130000
*   RETURN TO CALLER                                                    27140000
*--------------------------------------------------------------         27150000
                                                                        27160000
         LM    R0,R14,REGSAVEX    RESTORE MAINLINE REGS                 27170000
         SR    R15,R15            RETCODE NOT DEFINED                   27180000
         BR    R14                RETURN                                27190000
         DROP  R5                 SYSNAVIGATION                         27200000
                                                                        27210000
         EJECT                                                          27220000
***************************************************************         27230000
*                                                                       27240000
* ROUTINE: DOCGEN - Construct message and queue for return              27250000
*                                                                       27260000
* ON ENTRY:                                                             27270000
*                                                                       27280000
*    R1 - nav component msg id                                          27290000
*                                                                       27300000
***************************************************************         27310000
                                                                        27320000
DOCGEN   DS    0H                                                       27330000
         STM   R0,R15,REGSAVEX    SAVE MAINLINE REGS                    27340000
         LR    R2,R1              MESSAGE NUMBER                        27350000
                                                                        27360000
         $MSG  (R2)                                                     27370000
                                                                        27380000
DOCGEXIT DS    0H                                                       27390000
         LM    R0,R14,REGSAVEX    RESTORE MAINLINE REGS                 27400000
         BR    R14                                                      27410000
                                                                        27420000
         EJECT ,                                                        27430000
***************************************************************         27440000
*                                                                       27450000
*   Catastophic failures, etc.                                          27460000
*                                                                       27470000
***************************************************************         27480000
ABN_TBSV DS    0H                 CATALOG / TABLE SERVICE FAILURE       27490000
         $ABEND ABE_TBSERV,DUMP=YES,                                   X27500000
               TITLE='TABLE SERVICE FAILURE'                            27510000
                                                                        27520000
ABN_STG  DS    0H                                                       27530000
         $ABEND ABE_STORAGE,(R2),DUMP=YES,                             X27540000
               TITLE='STORAGE MANAGEMENT FAILURE'                       27550000
                                                                        27560000
         EJECT ,                                                        27570000
***************************************************************         27580000
*                                                                       27590000
*   Local read-only storage, etc.                                       27600000
*                                                                       27610000
***************************************************************         27620000
                                                                        27630000
BLANKS   DC    CL16' '            USEFUL STRING                         27640000
$RSMREC  DC    CL16'*RESUME*'     SAR SYSNAV RECORDING NAME             27650000
                                                                        27660000
##SLOTS  EQU   4                  INITIAL PREDECESSOR/SUCCESSOR SLOTS.  27670000
                                                                        27680000
CSTRAPPL DC    CL8'APPL'          $ENTITY APPLICATION QUALIFIER         27690000
CSTRREC  DC    CL8'REC'           $ENTITY RECORDING QUALIFIER           27700000
CSTRIMAG DC    CL8'IMAGE'         $ENTITY IMAGE QUALIFIER               27710000
CSTRSSET DC    CL8'SSET'          $ENTITY SCREEN SET QUALIFIER          27720000
                                                                        27730000
         LTORG ,                                                        27740000
                                                                        27750000
         EJECT ,                                                        27760000
         PRINT NOGEN                                                    27770000
         ICVT  ,                                                        27780000
         ITASK ,                                                        27790000
         IPCB  ,                                                        27800000
         END   ,                                                        27810000

IVTMNREC TITLE 'INTEGRATOR - VTAM MAIN TASK RECEIVE-ANY DRIVER'         00010000
**<DOC-ON>************************************************************* 00020000
*                                                                       00030000
* ROUTINE: IVTMNREC - VTAM MAIN TASK RECEIVE-ANY DRIVER                 00040000
*                                                                       00050000
* DESCRIPTION: THIS ROUTINE IS TRIGGERED BY A WORK ELEMENT AFTER        00060000
*              A SUCCESSFUL OPEN OF A VTAM ACB. A RECEIVE-ANY           00070000
*              IS ISSUED TO SOLICIT INPUT FROM ALL SESSIONS             00080000
*              ASSOCIATED WITH THE ACB.                                 00090000
*              SUBSEQUENT INPUT KEEPS THE RECEIVE PROCESS GOING.        00100000
*              A RECEIVE-ANY IS ALWAYS OUTSTANDING WHEN THE ACB         00110000
*              IS OPEN AND IT WILL BE CANCELED BY VTAM WHEN THE         00120000
*              ACB IS CLOSED.                                           00130000
*                                                                       00140000
* ON ENTRY:                                                             00150000
*                                                                       00160000
*    R15 = ENTRY POINT ADDRESS                                          00170000
*    R14 = RETURN ADDRESS                                               00180000
*    R13 = AVAILABLE SAVE AREA                                          00190000
*    R11 = ICVT ADDRESS                                                 00200000
*    R10 = ITASK ADDRESS                                                00210000
*    R09 = IVTAMCVT ADDRESS                                             00220000
*    R01 = ADDRESS OF THE RECEIVE-ANY WORK ELEMENT (IWEXC)              00230000
*                                                                       00240000
* ON EXIT:                                                              00250000
*                                                                       00260000
*    R15 = 0                                                            00270000
*    R00 = 0                                                            00280000
*    R01 = 0                                                            00290000
*                                                                       00300000
*    ALL OTHER REGISTERS ARE RESTORED.                                  00310000
*                                                                       00320000
**<DOC-OFF>************************************************************ 00330000
                                                                        00340000
         EJECT ,                                                        00350000
*********************************************************************** 00360000
*                                                                       00370000
* MAINTENANCE:                                                          00380000
*                                                                       00390000
*   08/01/93 RANDY WITEK                                                00400000
*   07/01/94 RANDY WITEK - LU6.2 SUPPORT                                00410000
*                                                                       00420000
*********************************************************************** 00430000
                                                                        00440000
         EQUS  ,                  GENERAL EQUATES                       00450000
                                                                        00460000
RICVT    EQU   R11                                                      00470000
RITASK   EQU   R10                                                      00480000
RIVTAM   EQU   R9                                                       00490000
RIACB    EQU   R8                                                       00500000
RIRPL    EQU   R7                                                       00510000
RIWE     EQU   R6                                                       00520000
RISESS   EQU   R5                                                       00530000
                                                                        00540000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00550000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00560000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00570000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00580000
         USING IACB,RIACB         ESTABLISH ADDRESSABILITY              00590000
         USING IRPL,RIRPL         ESTABLISH ADDRESSABILITY              00600000
         USING IWEVTAM,RIWE       ESTABLISH ADDRESSABILITY              00610000
         USING ISTRH,RPLURH       ESTABLISH ADDRESSABILITY              00620000
                                                                        00630000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00640000
                                                                        00650000
$TASKMFL $TASK MF=L               $TASK PLIST CONSTRUCTION              00660000
                                                                        00670000
WRK256   DS    XL256              GENERAL WORKAREA                      00680000
                                                                        00690000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00700000
                                                                        00710000
SUB1SAVE DS    18F                SUBROUTINE SAVE AREA                  00720000
                                                                        00730000
RETR15   DS    F                                                        00740000
RETR0    DS    F                                                        00750000
RETR1    DS    F                                                        00760000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00770000
                                                                        00780000
FLAG     DS    X                                                        00790000
FLAGLOCK EQU   X'80'              VTAM GLOBAL LOCK HELD                 00800000
FLAGLCKD EQU   X'40'              VTAM GLOBAL LOCK HELD ON ENTRY        00810000
                                                                        00820000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00830000
                                                                        00840000
         $MSGDFT PREFIX=ICTPID,                                        +00850000
               COMPID='VTM',                                           +00860000
               TABLE=*#MSGS,                                           +00870000
               WORKA=0,                                                +00880000
               MF=(E,WRK256),                                          +00890000
               PRINT=NOGEN                                              00900000
                                                                        00910000
IVTMNREC #ENTER BASE=R12,         ENTRY LINKAGE                        +00920000
               PREG=RIWE,                                              +00930000
               AMODE=31,                                               +00940000
               RMODE=ANY                                                00950000
                                                                        00960000
*---------------------------------------------------------------------- 00970000
* PROCESS A WORK ELEMENT THAT TRIGGERS A RECEIVE ANY                    00980000
*---------------------------------------------------------------------- 00990000
                                                                        01000000
         L     RIACB,IWEXCACB     ACB ADDRESS                           01010000
         BAS   R14,RCVANY         ISSUE A RECEIVE ANY                   01020000
         B     EXIT               WAIT FOR COMPLETION EXIT              01030000
                                                                        01040000
*---------------------------------------------------------------------- 01050000
* RETURN TO CALLER                                                      01060000
*---------------------------------------------------------------------- 01070000
                                                                        01080000
EXIT     DS    0H                                                       01090000
                                                                        01100000
         LM    R15,R1,RETREGS     LOAD RETURN VALUES                    01110000
                                                                        01120000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    01130000
                                                                        01140000
*---------------------------------------------------------------------- 01150000
* ERROR ROUTINES                                                        01160000
*---------------------------------------------------------------------- 01170000
                                                                        01180000
ERR$VTAM DS    0H                                                       01190000
                                                                        01200000
         $ABEND ABE_VTDIAG,                                            +01210000
               SCOPE=PCB,                                              +01220000
               TITLE='$VTAM FAILURE'                                    01230000
                                                                        01240000
ERRVTAM  DS    0H                                                       01250000
                                                                        01260000
         $ABEND ABE_VTDIAG,                                            +01270000
               SCOPE=PCB,                                              +01280000
               TITLE='VTAM FAILURE'                                     01290000
                                                                        01300000
*---------------------------------------------------------------------- 01310000
*                                                                       01320000
* RPL COMPLETION ROUTINE FOR RECEIVES                                   01330000
*                                                                       01340000
* ON ENTRY:                                                             01350000
*                                                                       01360000
*    R15 = ENTRY POINT ADDRESS                                          01370000
*    R14 = RETURN ADDRESS                                               01380000
*    R13 = AVAILABLE SAVE AREA                                          01390000
*    R11 = ICVT ADDRESS                                                 01400000
*    R10 = ITASK ADDRESS                                                01410000
*    R09 = IVTAMCVT ADDRESS                                             01420000
*    R01 = ADDRESS OF COMPLETED IRPL                                    01430000
*    R00 = RECOVERY ACTION RETURN CODE                                  01440000
*                                                                       01450000
*---------------------------------------------------------------------- 01460000
                                                                        01470000
RCVEND   #ENTER BASE=R12,         ENTRY LINKAGE                        +01480000
               PREG=(RIRPL,R2),   R1-->RIRPL, R0-->R2                  +01490000
               EP=YES             THIS IS AN ENTRY POINT                01500000
                                                                        01510000
         L     RIACB,RPLDACB      ACB REFERENCE                         01520000
         L     RISESS,RPLUSFLD    ISESS ADDRESS                         01530000
         L     R1,IACRECA#        CURRENT # OF RECANY'S                 01540000
         S     R1,=F'1'           DECREMENT IT                          01550000
         TM    RPLOPT5,RPLNODE    IS THIS A RECEIVE-ANY COMPLETION?     01560000
         BNO   *+8                BRANCH IF NOT                         01570000
         ST    R1,IACRECA#        SAVE UPDATED COUNT                    01580000
                                                                        01590000
         C     R2,=F'4'           RTNCD > 4?                            01600000
         BH    RCVDERR            BRANCH IF YES                         01610000
                                                                        01620000
         LTR   RISESS,RISESS      ISESS PRESENT?                        01630000
         BZ    ERRVTAM            BRANCH IF NOT                         01640000
                                                                        01650000
         TM    RPLOPT5,RPLNODE    IS THIS A RECEIVE-ANY COMPLETION?     01660000
         BNO   RCVDSPEC           BRANCH IF NOT                         01670000
         XC    IACRARTY,IACRARTY  ZERO THE RECANY RETRY COUNTER         01680000
         BAS   R14,RCVANY         RESTART THE RECEIVE-ANY PROCESS       01690000
                                                                        01700000
RCVDSPEC DS    0H                                                       01710000
                                                                        01720000
         TM    RHF0,RHQSRSP       IS THIS A RESPONSE?                   01730000
         BO    RCVDRESP           BRANCH IF YES                         01740000
                                                                        01750000
         CLI   RPLFDB2,3          EXCEPTION REQUEST?                    01760000
         BE    RCVDEXRQ           BRANCH IF YES                         01770000
                                                                        01780000
EXRQCONT DS    0H                                                       01790000
                                                                        01800000
         L     R1,IRPRATOT        TOTAL BYTE COUNT FOR CHAIN            01810000
         L     R2,RPLRLEN         AMOUNT OF DATA JUST RECEIVED          01820000
         C     R2,RPLBUFL         IS AMOUNT GREATER THAN BUFFER SIZE?   01830000
         BNH   RCVUPDAT           BRANCH IF NOT                         01840000
         L     R2,RPLBUFL         AMOUNT RECEIVED IS REALLY BUFFER SIZE 01850000
RCVUPDAT AR    R1,R2              PLUS AMOUNT JUST RECEIVED             01860000
         ST    R1,IRPRATOT        SAVE UPDATED CHAIN LENGTH             01870000
         L     R1,IRPRACUR        CURRENT BUFFER                        01880000
         ST    R2,4(,R1)          AMOUNT OF DATA IN THIS BUFFER         01890000
         NI    IRPRARH+1,X'0F'    CLEAR RESPONSE INDICATORS             01900000
         OC    IRPRARH(3),RPLURH  COMPOSITE USER RH                     01910000
                                                                        01920000
         CLC   RPLRLEN,RPLBUFL    DID DATA LENGTH EXCEED BUFFER SIZE?   01930000
         BNH   TESTLIC            BRANCH IF NOT                         01940000
         L     R1,IACRECSZ        CURRENT RECEIVE-ANY SIZE              01950000
         A     R1,=A(IVTRECIN)    INCREASE SIZE BY RECANY INCREMENT     01960000
         ST    R1,IACRECSZ        SET THE UPDATED RECEIVE-ANY SIZE      01970000
         B     RCVDPART           ISSUE RECEIVE SPEC TO COMPLETE        01980000
                                                                        01990000
TESTLIC  DS    0H                                                       02000000
                                                                        02010000
         TM    RHF0,RHECI         IS THIS A LAST-IN-CHAIN?              02020000
         BO    RCVDALL            BRANCH IF YES                         02030000
                                                                        02040000
         TM    IRPF1,IRPF1PRG     IS THIS AN EXCEPTION REQUEST CHAIN?   02050000
         BO    RCVDPART           BRANCH IF YES TO COLLECT CHAIN        02060000
                                                                        02070000
         TM    IACF1,IACF162      PASS RU'S ONE AT A TIME?              02080000
         BO    RCVDALL            BRANCH IF YES                         02090000
                                                                        02100000
RCVDPART DS    0H                                                       02110000
                                                                        02120000
         BAS   R14,RCVSPEC        GO ISSUE A RECEIVE SPECIFIC           02130000
         B     EXIT               WAIT FOR COMPLETION EXIT              02140000
                                                                        02150000
*                                                                       02160000
* QUEUE A COMPLETE CHAIN OR RU (FOR LU6.2) TO THE ISESS                 02170000
*---------------------------------------------------------------------- 02180000
                                                                        02190000
RCVDALL  DS    0H                                                       02200000
                                                                        02210000
         TM    IRPF1,IRPF1PRG     IS THIS AN EX-REQUEST CHAIN?          02220000
         BO    COPYSKIP           BRANCH YES TO RELEASE RPL/BUFFER(S)   02230000
                                                                        02240000
         BAS   R14,VTAMLOCK       SERIALIZE VTAM/SESS BLOCKS            02250000
                                                                        02260000
         $SER  OBTAIN,DISP        NEED STORAGE FROM NON-CURRENT ITASK   02270000
                                                                        02280000
         $VTAM VALISESS,                                               +02290000
               AREA=(RISESS),                                          +02300000
               AREALEN=(RIACB),                                        +02310000
               MF=(E,MFE_LIST)    VERIFY THAT ISESS IS STILL VALID      02320000
                                                                        02330000
         LTR   R15,R15            ISESS VALID?                          02340000
         BNZ   COPYSKUN           BRANCH IF NOT                         02350000
                                                                        02360000
         ICM   R3,15,IRPRATOT     TOTAL DATA LENGTH                     02370000
         BZ    RALLNBUF           BRANCH IF NO BUFFER NEEDED            02380000
                                                                        02390000
         $GETSTOR (R3),                                                +02400000
               LOC=ANY,                                                +02410000
               OWNER=*ISEITASK    OBTAIN A DATA BUFFER                  02420000
                                                                        02430000
         LR    R4,R1              DATA BUFFER ADDRESS                   02440000
                                                                        02450000
RALLNBUF DS    0H                                                       02460000
                                                                        02470000
         $VTAMWE L'IWEXD,         SIZE OF DATA WORK ELEMENT            +02480000
               IWECDATA           CODE                                  02490000
                                                                        02500000
         LR    RIWE,R1            IWE REFERENCE                         02510000
         ICM   R3,15,IRPRATOT     TOTAL DATA LENGTH                     02520000
         BZ    COPYDONE           BRANCH IF ZERO DATA LENGTH            02530000
         ST    R3,IWEXDLEN        SET DATA LENGTH                       02540000
         ST    R4,IWEXDBUF        SET DATA BUFFER ADDRESS               02550000
         LR    R2,R4              DATA BUFFER ADDRESS                   02560000
         L     R15,IRPRA1ST       FIRST DATA BUFFER IN CHAIN            02570000
                                                                        02580000
COPYBUFR DS    0H                                                       02590000
                                                                        02600000
         LTR   R15,R15            END OF DATA BUFFER CHAIN COPY?        02610000
         BZ    COPYDONE           BRANCH IF YES                         02620000
         LA    R0,8(,R15)         ADDRESS OF DATA IN THE BUFFER         02630000
         L     R1,4(,R15)         LENGTH OF DATA IN THE BUFFER          02640000
         LR    R3,R1              LENGTH OF DATA IN THE BUFFER          02650000
         MVCL  R2,R0              COPY DATA TO USER BUFFER              02660000
         L     R15,0(,R15)        LINK TO NEXT BUFFER IN CHAIN          02670000
         B     COPYBUFR           GO COPY THE DATA IN THAT BUFFER       02680000
                                                                        02690000
COPYDONE DS    0H                                                       02700000
                                                                        02710000
         MVC   IWEXDCID(4),RPLARG            SET CID IN ELEMENT         02720000
         MVC   IWEXDURH(3),IRPRARH           SET USER RH IN ELEMENT     02730000
         MVC   IWEXDCTL(3),RPLCNTRL          SET CNTRL INFO IN ELEMENT  02740000
         MVC   IWEXDSEQ(2),RPLSEQNO          SET SNA SEQ# IN ELEMENT    02750000
         MVC   IWEXDSNS(L'IWEXDSNS),RPLFDBK2 COPY SENSE FOR LUSTAT      02760000
                                                                        02770000
         LR     R1,RIWE           PASS WORK ELEMENT IN R1               02780000
         LA     R0,ISEWEQ         PASS QUEUE ADDRESS IN R0              02790000
         BAS    R14,QWE           QUEUE THE WORK ELEMENT                02800000
                                                                        02810000
COPYSKUN DS    0H                                                       02820000
                                                                        02830000
         BAS   R14,UNLOCKS        RELEASE DISP AND VTAM LOCKS           02840000
                                                                        02850000
COPYSKIP DS    0H                                                       02860000
                                                                        02870000
         BAS   R14,FREERPL        RELEASE RPL AND BUFFER(S)             02880000
         B     EXIT                                                     02890000
                                                                        02900000
*---------------------------------------------------------------------- 02910000
* A RESPONSE WAS RECEIVED IN THE DFSYN FLOW                             02920000
*---------------------------------------------------------------------- 02930000
                                                                        02940000
RCVDRESP DS    0H                                                       02950000
                                                                        02960000
*                                                                       02970000
* VALIDATE ISESS                                                        02980000
*---------------------------------------------------------------------- 02990000
                                                                        03000000
         BAS   R14,VTAMLOCK       SERIALIZE VTAM/SESS BLOCKS            03010000
                                                                        03020000
         $VTAM VALISESS,                                               +03030000
               AREA=(RISESS),                                          +03040000
               AREALEN=(RIACB),                                        +03050000
               MF=(E,MFE_LIST)    VERIFY THAT ISESS IS STILL VALID      03060000
                                                                        03070000
         LTR   R15,R15            ISESS VALID?                          03080000
         BNZ   RCVDRUNL           BRANCH IF NOT                         03090000
                                                                        03100000
*                                                                       03110000
* ALLOCATE A RESP WORK ELEMENT                                          03120000
*---------------------------------------------------------------------- 03130000
                                                                        03140000
         $VTAMWE L'IWEX6,         SIZE                                 +03150000
               IWECXRSP           CODE                                  03160000
                                                                        03170000
         LR    RIWE,R1                                                  03180000
                                                                        03190000
*                                                                       03200000
* BUILD RESP WORK ELEMENT                                               03210000
*---------------------------------------------------------------------- 03220000
                                                                        03230000
         ST    RIACB,IWEX6ACB     SET ACB ADDRESS                       03240000
         MVC   IWEX6CID,RPLARG    SET CID                               03250000
         ST    RISESS,IWEX6USR    SET USERFLD                           03260000
         SR    R1,R1              CLEAR FOR IC                          03270000
         IC    R1,RPLLEN          LENGTH OF VTAM RPL                    03280000
         BCTR  R1,0               LENGTH CODE FOR MVC                   03290000
         EX    R1,CPYRSRPL        COPY RPL TO WORK ELEMENT              03300000
                                                                        03310000
*                                                                       03320000
* QUEUE RESP WORK ELEMENT TO VTAM SESSION ITASK                         03330000
*---------------------------------------------------------------------- 03340000
                                                                        03350000
         LR     R1,RIWE           PASS WORK ELEMENT IN R1               03360000
         LA     R0,ISEWEQ         PASS QUEUE ADDRESS IN R0              03370000
         BAS    R14,QWE           QUEUE THE WORK ELEMENT                03380000
                                                                        03390000
*                                                                       03400000
* RELEASE THE BUFFER(S) ASSOCIATED WITH THE IRPL                        03410000
*---------------------------------------------------------------------- 03420000
                                                                        03430000
RCVDRUNL DS     0H                                                      03440000
                                                                        03450000
         BAS   R14,VTAMUNLK       RELEASE SERIALIZATION                 03460000
                                                                        03470000
         BAS   R14,FREEBUFR       FREE THE BUFFERS                      03480000
                                                                        03490000
*                                                                       03500000
* ISSUE A RESETSR TO RETURN THE SESSION TO CONTINUE-ANY MODE            03510000
*---------------------------------------------------------------------- 03520000
                                                                        03530000
         XC    IRPWTGOK,IRPWTGOK  CLEAR ADDRS FOR AUTO RPL RELEASE      03540000
         XC    IRPWTGER,IRPWTGER  CLEAR ADDRS FOR AUTO RPL RELEASE      03550000
                                                                        03560000
         RESETSR RPL=(RIRPL),     PUT DFSYN BACK IN CA MODE            +03570000
               OPTCD=CA,                                               +03580000
               RTYPE=DFSYN                                              03590000
                                                                        03600000
         STM   R15,R0,IRPR15      SAVE VTAM RETURN REGISTERS            03610000
                                                                        03620000
         $VTAM CHECKPH1,          PHASE-1 RETURN CODE CHECK            +03630000
               AREA=(RIRPL),      IRPL TO BE CHECKED                   +03640000
               MF=(E,MFE_LIST)                                          03650000
                                                                        03660000
         B     EXIT               AND WE ARE DONE                       03670000
                                                                        03680000
CPYRSRPL MVC   IWEX6RPL(0),0(RIRPL) COPY THE RESPONSE RPL               03690000
                                                                        03700000
*---------------------------------------------------------------------- 03710000
* AN EXCEPTION REQUEST WAS RECEIVED                                     03720000
*---------------------------------------------------------------------- 03730000
                                                                        03740000
RCVDEXRQ DS    0H                                                       03750000
                                                                        03760000
*                                                                       03770000
* VALIDATE ISESS                                                        03780000
*---------------------------------------------------------------------- 03790000
                                                                        03800000
         BAS   R14,VTAMLOCK       SERIALIZE VTAM/SESS BLOCKS            03810000
                                                                        03820000
         $VTAM VALISESS,                                               +03830000
               AREA=(RISESS),                                          +03840000
               AREALEN=(RIACB),                                        +03850000
               MF=(E,MFE_LIST)    VERIFY THAT ISESS IS STILL VALID      03860000
                                                                        03870000
         LTR   R15,R15            ISESS VALID?                          03880000
         BNZ   RCVDEUNL           BRANCH IF NOT                         03890000
                                                                        03900000
*                                                                       03910000
* ALLOCATE AN EXCEPTION REQUEST WORK ELEMENT                            03920000
*---------------------------------------------------------------------- 03930000
                                                                        03940000
         $VTAMWE L'IWEXE,         SIZE                                 +03950000
               IWECEXRQ           CODE                                  03960000
                                                                        03970000
         LR    RIWE,R1                                                  03980000
                                                                        03990000
*                                                                       04000000
* BUILD EXCEPTION REQUEST WORK ELEMENT                                  04010000
*---------------------------------------------------------------------- 04020000
                                                                        04030000
         ST    RIRPL,IWEXERP@     SAVE ORIGINAL RPL ADDRESS             04040000
         LA    R14,IWEXERPL       COPY-TO ADDRESS                       04050000
         LR    R0,RIRPL           COPY-FROM ADDRESS                     04060000
         LA    R1,L'IRP           SIZE OF THE IRPL                      04070000
         LR    R15,R1             COPY-TO SIZE                          04080000
         MVCL  R14,R0             COPY THE EXCEPTION REQUEST IRPL       04090000
                                                                        04100000
*                                                                       04110000
* QUEUE EXCEPTION REQUEST WORK ELEMENT TO VTAM SESSION ITASK            04120000
*---------------------------------------------------------------------- 04130000
                                                                        04140000
         LR     R1,RIWE           PASS WORK ELEMENT IN R1               04150000
         LA     R0,ISEWEQ         PASS QUEUE ADDRESS IN R0              04160000
         BAS    R14,QWE           QUEUE THE WORK ELEMENT                04170000
                                                                        04180000
*                                                                       04190000
* MARK THE CHAIN AS "PURGING" IN THE IRPL                               04200000
*---------------------------------------------------------------------- 04210000
                                                                        04220000
RCVDEUNL DS    0H                                                       04230000
                                                                        04240000
         BAS   R14,VTAMUNLK       RELEASE SERIALIZATION                 04250000
                                                                        04260000
         OI    IRPF1,IRPF1PRG     MARK CHAIN AS PURGING                 04270000
         B     EXRQCONT           RECEIVE COMPLETE CHAIN/CANCEL         04280000
                                                                        04290000
*---------------------------------------------------------------------- 04300000
* UNSUCCESSFUL RECEIVE                                                  04310000
*---------------------------------------------------------------------- 04320000
                                                                        04330000
RCVDERR  DS    0H                                                       04340000
                                                                        04350000
         TM    RPLOPT5,RPLNODE    IS ERROR ON RECEIVE-ANY COMPLETION?   04360000
         BO    RECANYER           BRANCH IF YES                         04370000
                                                                        04380000
*                                                                       04390000
* RECEIVE-SPECIFIC FAILED FOR A PARTICULAR SESSION                      04400000
*                                                                       04410000
* VALIDATE ISESS                                                        04420000
*---------------------------------------------------------------------- 04430000
                                                                        04440000
         BAS   R14,VTAMLOCK       SERIALIZE VTAM/SESS BLOCKS            04450000
                                                                        04460000
         $VTAM VALISESS,                                               +04470000
               AREA=(RISESS),                                          +04480000
               AREALEN=(RIACB),                                        +04490000
               MF=(E,MFE_LIST)    VERIFY THAT ISESS IS STILL VALID      04500000
                                                                        04510000
         LTR   R15,R15            ISESS VALID?                          04520000
         BNZ   RCVDSUNL           BRANCH IF NOT                         04530000
                                                                        04540000
*                                                                       04550000
* ALLOCATE A RECEIVE ERROR WORK ELEMENT                                 04560000
*---------------------------------------------------------------------- 04570000
                                                                        04580000
         $VTAMWE L'IWEXF,         SIZE                                 +04590000
               IWECRCVE           CODE                                  04600000
                                                                        04610000
         LR    RIWE,R1                                                  04620000
                                                                        04630000
*                                                                       04640000
* BUILD RECEIVE ERROR WORK ELEMENT                                      04650000
*---------------------------------------------------------------------- 04660000
                                                                        04670000
         ST    RIRPL,IWEXFRP@     SAVE ORIGINAL RPL ADDRESS             04680000
         LA    R14,IWEXFRPL       COPY-TO ADDRESS                       04690000
         LR    R0,RIRPL           COPY-FROM ADDRESS                     04700000
         LA    R1,L'IRP           SIZE OF THE IRPL                      04710000
         LR    R15,R1             COPY-TO SIZE                          04720000
         MVCL  R14,R0             COPY THE EXCEPTION REQUEST IRPL       04730000
                                                                        04740000
*                                                                       04750000
* QUEUE RECEIVE ERROR WORK ELEMENT TO VTAM SESSION ITASK                04760000
*---------------------------------------------------------------------- 04770000
                                                                        04780000
         LR     R1,RIWE           PASS WORK ELEMENT IN R1               04790000
         LA     R0,ISEWEQ         PASS QUEUE ADDRESS IN R0              04800000
         BAS    R14,QWE           QUEUE THE WORK ELEMENT                04810000
                                                                        04820000
*                                                                       04830000
* FREE THE RPL AND BUFFER(S)                                            04840000
*---------------------------------------------------------------------- 04850000
                                                                        04860000
RCVDSUNL DS    0H                                                       04870000
                                                                        04880000
         BAS   R14,VTAMUNLK       RELEASE SERIALIZATION                 04890000
         BAS   R14,FREERPL        RELEASE RPL AND BUFFER(S)             04900000
         B     EXIT                                                     04910000
                                                                        04920000
*                                                                       04930000
* RECEIVE-ANY FAILED.                                                   04940000
* IF THIS IS NOT THE LAST RECANY, JUST LET IT FAIL.                     04950000
*---------------------------------------------------------------------- 04960000
                                                                        04970000
RECANYER DS    0H                                                       04980000
                                                                        04990000
         OC    IACRECA#,IACRECA#  ARE THERE OTHER RECANY'S?             05000000
         BZ    LASTRECA           BRANCH IF NOT                         05010000
         BAS   R14,FREERPL        RELEASE RPL AND BUFFERS               05020000
         B     EXIT                                                     05030000
                                                                        05040000
*                                                                       05050000
* LAST RECANY FAILED.  REISSUE RECANY IF RETRY COUNTER PERMITS.         05060000
*---------------------------------------------------------------------- 05070000
                                                                        05080000
LASTRECA DS    0H                                                       05090000
                                                                        05100000
         CLC   RPLRTNCD(2),=XL2'100D' VTAM INACTIVE FOR ACB?            05110000
         BE    ALLDONE            BRANCH IF YES                         05120000
         L     R1,IACRARTY        CURRENT RECANY RETRY COUNTER          05130000
         A     R1,=F'1'           BUMP THE COUNTER                      05140000
         ST    R1,IACRARTY        SAVE UPDATED COUNT                    05150000
         C     R1,=A(IVTRRMAX)    CHECK RECANY RETRY MAX                05160000
         BH    ALLDONE            BRANCH IF RETRIES EXHAUSTED           05170000
         BAS   R14,FREERPL        RELEASE RPL AND BUFFERS               05180000
         BAS   R14,RCVANY         RESTART THE RECEIVE-ANY PROCESS       05190000
         B     EXIT                                                     05200000
                                                                        05210000
*                                                                       05220000
* LAST RECANY WILL NOT BE REISSUED.  ISSUE INFORMATIVE MESSAGE.         05230000
*---------------------------------------------------------------------- 05240000
                                                                        05250000
ALLDONE  DS    0H                                                       05260000
                                                                        05270000
         $MSG  980,                                                    +05280000
               FIELDS=((IACNAME,8))                                     05290000
                                                                        05300000
         BAS   R14,FREERPL        RELEASE RPL AND BUFFERS               05310000
         B     EXIT                                                     05320000
                                                                        05330000
*---------------------------------------------------------------------- 05340000
* SUBROUTINE TO RELEASE DISP AND VTAM LOCKS                             05350000
*---------------------------------------------------------------------- 05360000
                                                                        05370000
UNLOCKS  DS    0H                                                       05380000
                                                                        05390000
         STM   R14,R2,SUB0SAVE    SAVE RETURN ADDRESS                   05400000
                                                                        05410000
         $SER  RELEASE,DISP       DISP LOCK                             05420000
                                                                        05430000
         BAS   R14,VTAMUNLK       VTAM LOCK                             05440000
                                                                        05450000
         LM    R14,R2,SUB0SAVE    RESTORE REGISTERS                     05460000
         BR    R14                RETURN TO CALLER                      05470000
                                                                        05480000
*---------------------------------------------------------------------- 05490000
* SUBROUTINE TO ALLOCATE A RECEIVE BUFFER                               05500000
*---------------------------------------------------------------------- 05510000
                                                                        05520000
ALLOCBUF DS    0H                                                       05530000
                                                                        05540000
         STM   R14,R2,SUB0SAVE    SAVE RETURN ADDRESS                   05550000
         L     R2,IACRECSZ        CURRENT RECEIVE-ANY SIZE              05560000
                                                                        05570000
         $GETSTOR (R2),           GET 8K FOR TESTING                   +05580000
               LOC=ANY,           ABOVE OR BELOW IS OK                 +05590000
               OWNER=(RITASK)     CURRENT TASK (VTAM MAIN)              05600000
                                                                        05610000
         LR    R0,R2              R1=ADDRESS, R0=LENGTH                 05620000
         LM    R14,R15,SUB0SAVE   RESTORE R14,R15                       05630000
         L     R2,SUB0SAVE+16     RESTORE R2                            05640000
         BR    R14                RETURN TO CALLER                      05650000
                                                                        05660000
*---------------------------------------------------------------------- 05670000
* SUBROUTINE TO FREE IRPL AND ASSOCIATED BUFFER(S)                      05680000
*---------------------------------------------------------------------- 05690000
                                                                        05700000
FREERPL  DS    0H                                                       05710000
                                                                        05720000
         STM   R14,R1,SUB0SAVE    SAVE RETURN ADDRESS                   05730000
         BAS   R14,FREEBUFR       RELEASE THE BUFFER(S)                 05740000
                                                                        05750000
         $VTAM RETRPL,                                                 +05760000
               AREA=(RIRPL),                                           +05770000
               ERRET=ERR$VTAM,                                         +05780000
               MF=(E,MFE_LIST)    RELEASE THE IRPL                      05790000
                                                                        05800000
         SR    RIRPL,RIRPL        SHOW NO IRPL                          05810000
         LM    R14,R1,SUB0SAVE    RESTORE REGISTERS                     05820000
         BR    R14                RETURN TO CALLER                      05830000
                                                                        05840000
*---------------------------------------------------------------------- 05850000
* SUBROUTINE TO FREE BUFFER(S) ASSOCIATED WITH AN IRPL                  05860000
*---------------------------------------------------------------------- 05870000
                                                                        05880000
FREEBUFR DS    0H                                                       05890000
                                                                        05900000
         STM   R14,R2,SUB1SAVE    SAVE RETURN ADDRESS                   05910000
         L     R2,IRPRA1ST        ADDRESS OF 1ST BUFFER                 05920000
                                                                        05930000
FREENEXT DS    0H                                                       05940000
                                                                        05950000
         LTR   R2,R2              END OF BUFFERS?                       05960000
         BZ    FREEDONE           BRANCH IF YES                         05970000
         LR    R1,R2              BUFFER TO BE FREED                    05980000
         L     R2,0(,R2)          LINK TO NEXT BUFFER                   05990000
                                                                        06000000
         $RETSTOR (R1),           RELEASE BUFFER                       +06010000
               OWNER=(RITASK)     CURRENT TASK (VTAM MAIN)              06020000
                                                                        06030000
         B     FREENEXT           GO FREE THE NEXT BUFFER               06040000
                                                                        06050000
FREEDONE DS    0H                                                       06060000
                                                                        06070000
         XC    IRPRACUR,IRPRACUR  CLEAR BUFFER ASSOC. FIELDS            06080000
         XC    IRPRA1ST,IRPRA1ST  CLEAR BUFFER ASSOC. FIELDS            06090000
         XC    IRPRATOT,IRPRATOT  CLEAR BUFFER ASSOC. FIELDS            06100000
         XC    IRPRARH,IRPRARH    CLEAR BUFFER ASSOC. FIELDS            06110000
                                                                        06120000
         LM    R14,R2,SUB1SAVE    RESTORE REGISTERS                     06130000
         BR    R14                RETURN TO CALLER                      06140000
                                                                        06150000
*---------------------------------------------------------------------- 06160000
* SUBROUTINE TO ISSUE A RECEIVE ANY                                     06170000
*---------------------------------------------------------------------- 06180000
                                                                        06190000
RCVANY   DS    0H                                                       06200000
                                                                        06210000
         STM   R0,R15,SUB1SAVE    SAVE RETURN ADDRESS                   06220000
                                                                        06230000
*                                                                       06240000
* OBTAIN RPL FOR RECEIVE-ANY OPERATION                                  06250000
*---------------------------------------------------------------------- 06260000
                                                                        06270000
         $VTAM GETRPL,                                                 +06280000
               AREA=IVTRPACT,                                          +06290000
               ERRET=ERR$VTAM,                                         +06300000
               MF=(E,MFE_LIST)    ACQUIRE AN IRPL                       06310000
                                                                        06320000
         LR    RIRPL,R1           ESTABLISH ADDRESSIBILITY              06330000
         MVC   IRPWTGOK,=A(RCVEND) SET COMPLETION ADDRESS               06340000
         LA    R1,IVTWEQ          VTAM MAIN TASK QUEUE                  06350000
         ST    R1,IRP@WEQ         WILL RECEIVE THE RPL COMPLETION       06360000
                                                                        06370000
*                                                                       06380000
* ALLOCATE A RECEIVE BUFFER                                             06390000
*---------------------------------------------------------------------- 06400000
                                                                        06410000
         BAS   R14,ALLOCBUF                                            +06420000
                                                                        06430000
         LR    R2,R1              BUFFER ADDRESS                        06440000
         ST    R2,IRPRACUR        SAVE CURRENT BUFFER ADDRESS           06450000
         ST    R2,IRPRA1ST        SAVE 1ST BUFFER ADDRESS               06460000
         LA    R2,8(,R2)          LEAVE 8-BYTE PREFIX                   06470000
         LR    R3,R0              BUFFER LENGTH                         06480000
         S     R3,=F'8'           COMPENSATE FOR 8-BYTE PREFIX          06490000
                                                                        06500000
*                                                                       06510000
* ISSUE RECEIVE-ANY                                                     06520000
*---------------------------------------------------------------------- 06530000
                                                                        06540000
         L     R1,IACRECA#        CURRENT # OF RECANY'S                 06550000
         A     R1,=F'1'           BUMP IT                               06560000
         ST    R1,IACRECA#        SAVE UPDATED COUNT                    06570000
                                                                        06580000
         RECEIVE RPL=(RIRPL),                                          +06590000
               ACB=(RIACB),       ACB ADDRESS                          +06600000
               RTYPE=DFSYN,       NORMAL FLOW INPUT                    +06610000
               AREA=(R2),         RECEIVE INTO THE NEW BUFFER          +06620000
               AREALEN=(R3),      MAX. RECEIVE LENGTH WAS IN R3        +06630000
               OPTCD=(ANY,CS)     CONTINUE-SPECIFIC                     06640000
                                                                        06650000
         STM   R15,R0,IRPR15      SAVE VTAM RETURN REGISTERS            06660000
                                                                        06670000
         $VTAM CHECKPH1,          PHASE-1 RETURN CODE CHECK            +06680000
               AREA=(RIRPL),      IRPL TO BE CHECKED                   +06690000
               MF=(E,MFE_LIST)                                          06700000
                                                                        06710000
         LM    R0,R15,SUB1SAVE    RESTORE REGISTERS                     06720000
         BR    R14                RETURN TO CALLER                      06730000
                                                                        06740000
*---------------------------------------------------------------------- 06750000
* SUBROUTINE TO ISSUE A RECEIVE SPECIFIC TO CONTINUE RECEIPT OF CHAIN   06760000
*---------------------------------------------------------------------- 06770000
                                                                        06780000
RCVSPEC  DS    0H                                                       06790000
                                                                        06800000
         STM   R14,R2,SUB1SAVE    SAVE RETURN ADDRESS                   06810000
                                                                        06820000
         MVC   IRPARG,RPLARG      SAVE CID FOR SPECIFIC REQUEST         06830000
         BAS   R14,ALLOCBUF       GET ANOTHER RECEIVE BUFFER            06840000
         LA    R2,8(,R1)          RESERVE 8-BYTE PREFIX                 06850000
         ST    R2,RPLAREA         SET THE NEW BUFFER ADDRESS            06860000
         S     R0,=F'8'           RESERVE THE 8-BYTE PREFIX             06870000
         ST    R0,RPLBUFL         SET THE NEW BUFFER LENGTH             06880000
         ICM   R15,15,IRPRACUR    IS THERE A CURRENT BUFFER?            06890000
         BNP   RCVSP1ST           BRANCH IF NOT                         06900000
         ST    R1,0(,R15)         LINK NEW BUFFER TO THE LAST BUFFER    06910000
         ST    R1,IRPRACUR        AND MAKE IT THE CURRENT BUFFER        06920000
         B     RCVSPRCV           ISSUE THE RECEIVE                     06930000
                                                                        06940000
RCVSP1ST DS    0H                                                       06950000
                                                                        06960000
         ST    R1,IRPRA1ST        SET POINTER TO FIRST BUFFER           06970000
         ST    R1,IRPRACUR        AND MAKE IT THE CURRENT BUFFER        06980000
         B     RCVSPRCV           ISSUE THE RECEIVE                     06990000
                                                                        07000000
RCVSPRCV DS    0H                                                       07010000
                                                                        07020000
         RECEIVE RPL=(RIRPL),                                          +07030000
               RTYPE=DFSYN,       NORMAL FLOW INPUT                    +07040000
               OPTCD=(SPEC,CS)    CONTINUE-SPECIFIC                     07050000
                                                                        07060000
         STM   R15,R0,IRPR15      SAVE VTAM RETURN REGISTERS            07070000
                                                                        07080000
         $VTAM CHECKPH1,          PHASE-1 RETURN CODE CHECK            +07090000
               AREA=(RIRPL),      IRPL TO BE CHECKED                   +07100000
               MF=(E,MFE_LIST)    ACQUIRE AN IRPL                       07110000
                                                                        07120000
         LM    R14,R2,SUB1SAVE    RESTORE REGISTERS                     07130000
         BR    R14                RETURN TO CALLER                      07140000
                                                                        07150000
*---------------------------------------------------------------------- 07160000
* SUBROUTINE TO QUEUE A WORK ELEMENT                                    07170000
*                                                                       07180000
*            R14 = RETURN ADDRESS                                       07190000
*            R1  = WORK ELEMENT ADDRESS                                 07200000
*            R0  = QUEUE ADDRESS                                        07210000
*---------------------------------------------------------------------- 07220000
                                                                        07230000
QWE      DS    0H                                                       07240000
                                                                        07250000
         STM   R14,R4,SUB1SAVE    SAVE REGISTERS                        07260000
                                                                        07270000
         LR    R3,R0              SAVE QUEUE   ADDRESS                  07280000
         LR    R4,R1              SAVE ELEMENT ADDRESS                  07290000
                                                                        07300000
         $VTAMQ (R4),             WORK ELEMENT                         +07310000
               (R3)               QUEUE                                 07320000
                                                                        07330000
         LM    R14,R4,SUB1SAVE    RESTORE REGISTERS                     07340000
         BR    R14                RETURN TO CALLER                      07350000
                                                                        07360000
*---------------------------------------------------------------------- 07370000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 07380000
*---------------------------------------------------------------------- 07390000
                                                                        07400000
VTAMLOCK DS    0H                                                       07410000
                                                                        07420000
         TM    FLAG,FLAGLOCK        HAVE WE ALREADY GOTTEN THE LOCK?    07430000
         BOR   R14                  BRANCH IF YES                       07440000
         STM   R14,R2,SUB1SAVE      SAVE CALLER'S REGISTERS             07450000
                                                                        07460000
         $SER  OBTAIN,                                                 +07470000
               VTAM                                                     07480000
                                                                        07490000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              07500000
         BNE   VTAMLOEX             BRANCH IF NOT                       07510000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         07520000
                                                                        07530000
VTAMLOEX DS    0H                                                       07540000
                                                                        07550000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               07560000
         LM    R14,R2,SUB1SAVE      RESTORE CALLER'S REGISTERS          07570000
         BR    R14                  RETURN                              07580000
                                                                        07590000
*---------------------------------------------------------------------- 07600000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                07610000
*---------------------------------------------------------------------- 07620000
                                                                        07630000
VTAMUNLK DS    0H                                                       07640000
                                                                        07650000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       07660000
         BNOR  R14                  BRANCH IF NOT                       07670000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             07680000
         BOR   R14                  DON'T RELEASE IF IT WAS             07690000
         STM   R14,R2,SUB1SAVE      SAVE CALLER'S REGISTERS             07700000
                                                                        07710000
         $SER  RELEASE,                                                +07720000
               VTAM                                                     07730000
                                                                        07740000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  07750000
         LM    R14,R2,SUB1SAVE      RESTORE CALLER'S REGISTERS          07760000
         BR    R14                  RETURN                              07770000
                                                                        07780000
                                                                        07790000
*---------------------------------------------------------------------- 07800000
*  CONSTANTS AND LITERALS                                               07810000
*---------------------------------------------------------------------- 07820000
                                                                        07830000
         LTORG ,                                                        07840000
         PRINT NOGEN                                                    07850000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                07860000
         ISTDBIND ,               VTAM BIND IMAGE                       07870000
         ISTRH ,                  VTAM SNA REQUEST HEADER               07880000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         07890000
         ICVT  ,                  INTEGRATOR CVT                        07900000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   07910000
         IRPL ,                   INTEGRATOR VTAM RPL+                  07920000
         IACB ,                   INTEGRATOR VTAM ACB+                  07930000
         INIB ,                   INTEGRATOR VTAM NIB+                  07940000
         ISESS ,                  INTEGRATOR SESSION BLOCK              07950000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            07960000
         ITASK ,                  INTEGRATOR TASK BLOCK                 07970000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          07980000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       07990000
         EVCODES ,                INTEGRATOR EVENT CODES                08000000
         ABCODES ,                INTEGRATOR $ABEND CODES               08010000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     08020000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        08030000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             08040000
         $PROC DSECT=YES          INTEGRATOR $PROC SERVICES             08050000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             08060000
         IFGEXLST ,               VTAM EXIT LIST                        08070000
         END   ,                                                        08080000

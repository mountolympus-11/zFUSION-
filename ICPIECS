ICPIECS TITLE 'INTEGRATOR - CPIC CMECS API - EXTRACT CONV STATE'        00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: ICPIECS - CPIC CMECS API                                     00100000
*                                                                       00110000
* DESCRIPTION:                                                          00120000
*                                                                       00130000
*    THIS ROUTINE IS CALLED TO PROCESS THE CMECS VERB.                  00140000
*                                                                       00150000
* ON ENTRY:                                                             00160000
*                                                                       00170000
*    R15 = ENTRY POINT ADDRESS                                          00180000
*    R14 = RETURN      ADDRESS                                          00190000
*    R13 = SAVE AREA   ADDRESS                                          00200000
*    R01 = PARM LIST   ADDRESS                                          00210000
*                                                                       00220000
*          +00 = ADDRESS OF CONVERSATION ID                             00230000
*          +04 = ADDRESS OF CONVERSATION STATE RETURN AREA              00240000
*          +08 = ADDRESS OF RETURN CODE AREA                            00250000
*                                                                       00260000
* ON EXIT:                                                              00270000
*                                                                       00280000
*    R15 = 0                                                            00290000
*                                                                       00300000
*    RETURN_CODE = CM_OK                      --> CMECS SUCCESSFUL      00310000
*                = CM_PROGRAM_PARAMETER_CHECK --> INVALID CONV_ID, ETC. 00320000
*                = CM_PRODUCT_SPECIFIC_ERROR  --> BAD PARM              00330000
*                = CM_OPERATION_NOT_ACCEPTED  --> N/A                   00340000
*                = CM_TAKE_BACKOUT            --> N/A                   00350000
*                                                                       00360000
**<DOC-OFF>************************************************************ 00370000
         EJECT ,                                                        00380000
*********************************************************************** 00390000
*                                                                       00400000
* MAINTENANCE:                                                          00410000
*                                                                       00420000
*   07/01/94 RANDY WITEK                                                00430000
*                                                                       00440000
*********************************************************************** 00450000
                                                                        00460000
         EQUS  ,                  GENERAL EQUATES                       00470000
                                                                        00480000
RICVT    EQU   R11                                                      00490000
RITASK   EQU   R10                                                      00500000
RBASE    EQU   R9                                                       00510000
RIVTAM   EQU   R8                                                       00520000
RCMLIST  EQU   R7                                                       00530000
RTKB     EQU   R6                                                       00540000
RRCB     EQU   R5                                                       00550000
                                                                        00560000
         USING CRAB,R12           ESTABLISH ADDRESSABILITY              00570000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00580000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00590000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00600000
         USING CMLIST,RCMLIST     ESTABLISH ADDRESSABILITY              00610000
         USING TKB,RTKB           ESTABLISH ADDRESSABILITY              00620000
         USING RCB,RRCB           ESTABLISH ADDRESSABILITY              00630000
                                                                        00640000
         COPY  CRAB               "C" RUNTIME ANCHOR BLOCK              00650000
         COPY  DSA                DYNAMIC SAVE AREA                     00660000
WORKAREA DS    0H                 READ/WRITE WORKAREA                   00670000
WRK256   DS    XL256              GENERAL WORKAREA                      00680000
                                                                        00690000
CONVID   DS    XL8                TEMPORARY CONVERSATION ID AREA        00700000
CONVS    DS    F                  TEMPORARY CONV STATE      AREA        00710000
RETCODE  DS    F                  TEMPORARY RETURN CODE     AREA        00720000
                                                                        00730000
FLAG     DS    X                                                        00740000
FLAGIERR EQU   X'80'                                                    00750000
WORKLEN  EQU   *-WORKAREA         LENGTH OF USER DSA AREA               00760000
DSALEN   EQU   *-DSA              LENGTH OF DSA                         00770000
                                                                        00780000
         $MSGDFT PREFIX=ICTPID,                                        +00790000
               COMPID='CPI',                                           +00800000
               TABLE=*#MSGS,                                           +00810000
               WORKA=0,                                                +00820000
               MF=(E,WRK256),                                          +00830000
               PRINT=NOGEN                                              00840000
                                                                        00850000
ICPECS@  CSECT ,                                                        00860000
ICPIECS  CENTRY DSA=DSALEN,BASE=RBASE,INDEP=YES                         00870000
                                                                        00880000
*---------------------------------------------------------------------- 00890000
* ENTRY                                                                 00900000
*---------------------------------------------------------------------- 00910000
                                                                        00920000
         USING DSA,R13            ADDRESSABILITY                        00930000
         LR    RCMLIST,R1         SAVE ADDRESS OF PLIST                 00940000
                                                                        00950000
         LA    R0,WORKAREA        ADDRESS OF USER DSA SECTION           00960000
         LA    R1,WORKLEN         LENGTH  OF USER DSA SECTION           00970000
         SR    R15,R15            PREPARE FOR CLEAR                     00980000
         MVCL  R0,R14             CLEAR USER DSA SECTION                00990000
                                                                        01000000
*---------------------------------------------------------------------- 01010000
* INITIALIZATION                                                        01020000
*---------------------------------------------------------------------- 01030000
                                                                        01040000
         @RESTENV ,               ENSURE ENVIRONMENT                    01050000
                                                                        01060000
         L     RIVTAM,ICTVTCVT    ESTABLISH IVTAMCVT POINTER            01070000
                                                                        01080000
         MVC   CONVID,=XL8'55AA55AA55AA55AA'                            01090000
         MVC   CONVS,=XL4'55AA55AA'                                     01100000
                                                                        01110000
         L     R1,CMLPARM3        ADDRESS OF RETURN_CODE AREA           01120000
         MVC   0(4,R1),0(R1)      TEST MOVEMENT                         01130000
                                                                        01140000
         ICM   R1,15,CMLPARM1     ADDRESS OF CONVERSATION ID            01150000
         BNP   INITERR            BRANCH IF BAD                         01160000
         MVC   CONVID,0(R1)       COPY CONVERSATION ID                  01170000
                                                                        01180000
         ICM   R1,15,CMLPARM2     ADDRESS OF CONV STATE RETURN AREA     01190000
         BNP   INITERR            BRANCH IF BAD                         01200000
         MVC   0(4,R1),0(R1)      TEST MOVEMENT                         01210000
         B     INITEND                                                  01220000
                                                                        01230000
INITERR  DS    0H                                                       01240000
                                                                        01250000
         OI    FLAG,FLAGIERR      REMEMBER ERROR DETECTED               01260000
                                                                        01270000
INITEND  DS    0H                                                       01280000
                                                                        01290000
*---------------------------------------------------------------------- 01300000
* ENTRY TRACE                                                           01310000
*---------------------------------------------------------------------- 01320000
                                                                        01330000
         $TRACE *=A(TRC_CPIC_ICPIECS),48 TRACE ENTRY W/ 48 USER BYTES   01340000
         BNZ   NOETRACE                  BRANCH IF NOT TRACING          01350000
         $APITRC ICPIECS                 TRACE COMMON STUFF             01360000
         ST    RCMLIST,24(,R1)           TRACE PARMLIST ADDRESS         01370000
         MVC   32(8,R1),CONVID           TRACE CONVERSATION ID          01380000
NOETRACE DS    0H                                                       01390000
                                                                        01400000
*---------------------------------------------------------------------- 01410000
* LOCATE SPECIFIED CONVERSATION & EXTRACT                               01420000
*---------------------------------------------------------------------- 01430000
                                                                        01440000
         TM    FLAG,FLAGIERR             ERROR DETECTED ALREADY?        01450000
         BO    ERRPROD                   BRANCH IF YES                  01460000
                                                                        01470000
         LA    R1,CONVID                 ADDRESS OF CONVERSATION ID     01480000
         L     R15,ICP@LOC               ENTRY POINT OF TKB/RCB LOCATE  01490000
         BASR  R14,R15                   LOCATE THE TKB/RCB             01500000
         LTR   RTKB,R1                   TKB ADDRESS                    01510000
         BNP   ERRPARM                   BRANCH IF BAD                  01520000
         LTR   RRCB,R0                   RCB ADDRESS                    01530000
         BNP   ERRPARM                   BRANCH IF BAD                  01540000
                                                                        01550000
         MVC   CONVS,RCBCONVS            COPY CONV STATE                01560000
                                                                        01570000
*---------------------------------------------------------------------- 01580000
* CM_TAKE_BACKOUT SUPPORT                                               01590000
*---------------------------------------------------------------------- 01600000
                                                                        01610000
* NOT IMPLEMENTED AT THIS TIME ???????????????????????????????????????? 01620000
                                                                        01630000
         B     RETURN                                                   01640000
                                                                        01650000
*---------------------------------------------------------------------- 01660000
* EXCEPTION ROUTINES                                                    01670000
*---------------------------------------------------------------------- 01680000
                                                                        01690000
ERRPROD  DS    0H                                                       01700000
                                                                        01710000
         MVC   RETCODE,=A(CM_PRODUCT_SPECIFIC_ERROR)                    01720000
         B     RETURN                                                   01730000
                                                                        01740000
ERRPARM  DS    0H                                                       01750000
                                                                        01760000
         MVC   RETCODE,=A(CM_PROGRAM_PARAMETER_CHECK)                   01770000
         B     RETURN                                                   01780000
                                                                        01790000
*---------------------------------------------------------------------- 01800000
* EXIT TRACE AND RETURN TO CALLER                                       01810000
*---------------------------------------------------------------------- 01820000
                                                                        01830000
RETURN   DS    0H                                                       01840000
                                                                        01850000
         $TRACE *=A(TRC_CPIC_EXIT),48 TRACE ENTRY                       01860000
         BNZ   NOXTRACE               BRANCH IF TRACING NOT AVAILABLE   01870000
         MVC   0(8,R1),=CL8'ICPIECS'  MODULE NAME                       01880000
         MVC   8(4,R1),RETCODE        RETURN_CODE VALUE                 01890000
         MVC   12(8,R1),CONVID        CONVERSATION ID                   01900000
         MVC   20(4,R1),CONVS         CONVERSATION STATE                01910000
NOXTRACE DS    0H                                                       01920000
                                                                        01930000
         L     R1,CMLPARM3        ADDRESS OF RETURN_CODE AREA           01940000
         MVC   0(4,R1),RETCODE    SET RETURN_CODE VARIABLE              01950000
         CLC   RETCODE,=A(CM_OK)  GOOD RC?                              01960000
         BNE   EXIT               BRANCH IF NOT                         01970000
                                                                        01980000
         L     R1,CMLPARM2        ADDRESS OF CONV STATE AREA            01990000
         MVC   0(4,R1),CONVS      SET CONV STATE VARIABLE               02000000
                                                                        02010000
EXIT     DS    0H                                                       02020000
                                                                        02030000
         SR    R15,R15            FUNCTION RETURN CODE = 0              02040000
         CEXIT RC=(R15),INDEP=YES RETURN                                02050000
                                                                        02060000
*---------------------------------------------------------------------- 02070000
* LITERALS AND CONSTANTS                                                02080000
*---------------------------------------------------------------------- 02090000
                                                                        02100000
         LTORG ,                                                        02110000
                                                                        02120000
         PRINT NOGEN                                                    02130000
         ISTDBIND ,               VTAM BIND IMAGE                       02140000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                02150000
         IKJTCB ,                 MVS TASK CONTROL BLOCK                02160000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         02170000
         ICVT  ,                  INTEGRATOR CVT                        02180000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   02190000
         ITASK ,                  INTEGRATOR TASK BLOCK                 02200000
         IPCB ,                   INTEGRATOR PROCESS BLOCK              02210000
         ABCODES ,                INTEGRATOR $ABEND CODES               02220000
         EVCODES ,                INTEGRATOR EVENT CODES                02230000
         END   ,                                                        02240000

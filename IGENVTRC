IGENVTRC TITLE '- CONSTRUCT VARCHAR DATA ITEM'                          00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: IGENVTRC - Construct VARCHAR data item                       00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine implements the $VARTRMC macro service                 00080000
*    accepting a character string and building a trimmed,               00090000
*    VARCHAR format copy of that string in a collection area            00100000
*    provided by the caller.  The (vardata) collection area             00110000
*    is identified by a free area pointer and length remaining          00120000
*    both of which are updated when as new VARDATA items are            00130000
*    posted.  Refer to the $VARTRMC macro for other details.            00140000
*                                                                       00150000
*                                                                       00160000
* ON ENTRY:                                                             00170000
*                                                                       00180000
*    R1  contains the address of a parameter list constructed           00190000
*        as follows:                                                    00200000
*                                                                       00210000
*        +00 - Source string origin                                     00220000
*        +04 - Source string length                                     00230000
*        +08 - Collection area free area pointer                        00240000
*        +12 - Collection area free area length                         00250000
*                                                                       00260000
*                                                                       00270000
* ON EXIT:                                                              00280000
*                                                                       00290000
*    R15 contains one of the following return codes:                    00300000
*                                                                       00310000
*        RC00 - Source string converted to VARCHAR format               00320000
*                                                                       00330000
*               R1 - VARCHAR data item origin address or zero           00340000
*                    if the source string is all blank / null           00350000
*                                                                       00360000
*               R0 - VARCHAR data item total length or zero             00370000
*                    if the source string is all blank / null           00380000
*                                                                       00390000
*        RC04 - Collection area overflow                                00400000
*                                                                       00410000
**<DOC-OFF>****************************************************         00420000
                                                                        00430000
         EJECT                                                          00440000
***************************************************************         00450000
*                                                                       00460000
* MAINTENANCE:                                                          00470000
*                                                                       00480000
*    01/25/95  R. Turgeon    virtual catalog support                    00490000
*              Initial version                                          00500000
*                                                                       00510000
***************************************************************         00520000
                                                                        00530000
         EJECT                                                          00540000
         EQUS  ,                                                        00550000
                                                                        00560000
         EJECT                                                          00570000
IGENVTRC #ENTER PREG=R8,SAVE=NO                                         00580000
                                                                        00590000
         EJECT                                                          00600000
*--------------------------------------------------------------         00610000
*   FETCH PASSED PARAMETERS                                             00620000
*--------------------------------------------------------------         00630000
                                                                        00640000
         LM    R4,R7,0(R8)        FETCH PASSED PARMS                    00650000
*                                 R4 <== SOURCE STRING ORIGIN           00660000
*                                 R5 <== SOURCE STRING LENGTH           00670000
         L     R8,0(,R6)          R6 <== ADDR OF COLLECT AREA FREE PTR  00680000
         L     R9,0(,R7)          R7 <== ADDR OF COLLECT AREA FREE LEN  00690000
                                                                        00700000
*--------------------------------------------------------------         00710000
*   TRIM THE SOURCE STRING OF TRAILING BLANKS / NULLS                   00720000
*--------------------------------------------------------------         00730000
                                                                        00740000
         @TRIM (R4),(R5),CHAR=NULL                                      00750000
                                                                        00760000
         LTR   R1,R1              NULL STRING?                          00770000
         BNZ   CONVERT            CONVERT TO VARCHAR IF NOT             00780000
         LA    R15,RC00           NORMAL COMPLETION                     00790000
         SR    R1,R1              INDICATE NULLS VIA ZEROED PTR         00800000
         SR    R0,R0              AND ZEROED LENGTH                     00810000
         B     EXIT                                                     00820000
                                                                        00830000
*--------------------------------------------------------------         00840000
*   ENSURE COLLECTION AREA SPACE AVAILABLE - UPDATE FREE LENGTH         00850000
*--------------------------------------------------------------         00860000
                                                                        00870000
CONVERT  DS    0H                                                       00880000
         LA    R15,RC04           ASSUME COLLECTION AREA TOO SMALL      00890000
         LA    R0,2(,R1)          TRIMMED SIZE PLUS PREFIX              00900000
         SR    R9,R0              SUFFICIENT SPACE REMAINING?           00910000
         BM    EXIT               ERROR IF NOT                          00920000
         ST    R9,0(,R7)          RETURN UPDATED FREE LENGTH            00930000
                                                                        00940000
*--------------------------------------------------------------         00950000
*   CONSTRUCT VARCHAR FORMATTED DATA ITEM                               00960000
*--------------------------------------------------------------         00970000
                                                                        00980000
         STH   R1,0(,R8)          STRING LENGTH AS PREFIX               00990000
         LA    R0,2(,R8)          COLLECTION AREA IS RECIPIENT          01000000
         LR    R5,R1              TARGET LENGTH = TRIM LENGTH           01010000
         MVCL  R0,R4              APPEND TO LENGTH                      01020000
         ST    R0,0(,R6)          RETURN UPDATED FREE SLOT ADDR         01030000
                                                                        01040000
         LA    R15,RC00           VARCHAR CONSTRUCTION COMPLETE         01050000
         LH    R1,0(,R8)          LENGTH OF TRIMMED STRING              01060000
         LA    R0,2(,R1)          R0 <== TOTAL LENGTH OF ELEMENT        01070000
         LR    R1,R8              R1 <== VARCHAR DATA ITEM PTR          01080000
                                                                        01090000
*--------------------------------------------------------------         01100000
*   RETURN TO REQUESTER                                                 01110000
*--------------------------------------------------------------         01120000
                                                                        01130000
EXIT     DS    0H                                                       01140000
                                                                        01150000
         #EXIT                                                          01160000
                                                                        01170000
         EJECT                                                          01180000
***************************************************************         01190000
*                                                                       01200000
*   Local read-only working storage                                     01210000
*                                                                       01220000
***************************************************************         01230000
         LTORG ,                                                        01240000
                                                                        01250000
         PRINT NOGEN                                                    01260000
         ICVT ,                                                         01270000
         END   ,                                                        01280000

IODBSTAT TITLE '- ODBC SQLSTATISTICS() RESULT SET GENERATOR'            00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: IODBSTAT - ODBC SQLStatistics() result set generator         00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    That QCS is expected to contain the semantic information           00080000
*    acquired from a SQL                                                00090000
*                                                                       00100000
*       SELECT <col-list> FROM SYSVCAT_ODBC_STAT# WHERE ...             00110000
*                                                                       00120000
*    statement.  The result set generated by this query can be          00130000
*    fashioned to conform to the various forms of the SQLStatistics()   00140000
*    function by appropriate composition of the <col-list> and          00150000
*    the use of an ORDER BY clause.                                     00160000
*                                                                       00170000
*    A one character, numeric suffix (#) is appended to the table       00180000
*    name to convey whether entries for all index are returned in       00190000
*    the result set, or whether only entries for "unique" indicies      00200000
*    are returned, as follows:                                          00210000
*                                                                       00220000
*      STAT1: Describe UNIQUE indicies only                             00230000
*                                                                       00240000
*      STAT2: Describe all indicies                                     00250000
*                                                                       00260000
*                                                                       00270000
* IMPLEMENTATION NOTES:                                                 00280000
*                                                                       00290000
*                                                                       00300000
*    The fAccuracy SQLStatistics() function input parameter is          00310000
*    not used in this implementation. The CARDINALITY and PAGES         00320000
*    columns returned are always available as discussed below.          00330000
*                                                                       00340000
*                                                                       00350000
*    TABLE_QUALIFIER  - Table qualifiers are not implemented.           00360000
*                       This column is nulled.                          00370000
*                                                                       00380000
*    TABLE_OWNER      - Table owners are not implemented.               00390000
*                       This column is nulled.                          00400000
*                                                                       00410000
*    INDEX_QUALIFIER  - Index qualifiers are not implemented.           00420000
*                       This column is nulled.                          00430000
*                                                                       00440000
*    TYPE             - All indexes are classified                      00450000
*                       SQL_INDEX_OTHER avoiding any confusion          00460000
*                       that could arise comparing STDENV table         00470000
*                       services to a true DBMS product.                00480000
*                                                                       00490000
*    CARDINALITY      - Table indicies created prior to release         00500000
*                       2.0 do not maintain entry counts and            00510000
*                       force a null return.  The information           00520000
*                       is provided for 2.0 and later indexes.          00530000
*                                                                       00540000
*    PAGES            - For both tables and indexes, the size           00550000
*                       is expressed in units of 4K.                    00560000
*                                                                       00570000
*    FILTER_CONDITION - Filtered indexes are not implemented.           00580000
*                       This column is nulled.                          00590000
*                                                                       00600000
*    Input to the SQLStatistics() function includes a single            00610000
*    unmasked table name included (echoed back) in the result           00620000
*    set.  Although it would be far more efficient to structure         00630000
*    this routine around this behavior, we chose instead to             00640000
*    adhere to the SQL SELECT model and examine all tables              00650000
*    registered in the target space, understanding that only            00660000
*    one will stick.  Thus, this implementation is a bit more           00670000
*    versitile than called for in the ODBC definition.                  00680000
*                                                                       00690000
*                                                                       00700000
* NOTES:                                                                00710000
*                                                                       00720000
*    If this service is extended to support multiuser execution         00730000
*    spaces, serialization or some other form of table locking          00740000
*    will be required because it operates on the target space           00750000
*    tables directly.                                                   00760000
*                                                                       00770000
*                                                                       00780000
* ON ENTRY                                                              00790000
*                                                                       00800000
*    R1  contains the address of the Query Content Summary              00810000
*                                                                       00820000
*    R0  contains the address of a preallocated savearea                00830000
*        not less than 1K in length or zero                             00840000
*                                                                       00850000
*                                                                       00860000
* ON EXIT:                                                              00870000
*                                                                       00880000
*    R15 contains zero or a return code acquired from SQLCODES          00890000
*        if an error is encountered.  R0 and R1 contain reason          00900000
*        and info codes respectively.  The QCSESTAT words are           00910000
*        updated accordingly.                                           00920000
*                                                                       00930000
**<DOC-OFF>****************************************************         00940000
                                                                        00950000
         EJECT                                                          00960000
***************************************************************         00970000
*                                                                       00980000
*  MAINTENANCE:                                                         00990000
*                                                                       01000000
*    01/25/95  R. Turgeon    Int 2.0  ODCB Support                      01010000
*              Initial version                                          01020000
*                                                                       01030000
*    10/31/95  R. Turgeon    Rel 2.1                                    01040000
*              Create transient result set with NOLOCATOR               01050000
*              option                                                   01060000
*                                                                       01070000
***************************************************************         01080000
                                                                        01090000
         EJECT                                                          01100000
         QCS   ,                  QUERY CONTENT SUMMARY                 01110000
                                                                        01120000
         EJECT                                                          01130000
         SQLSEMAL ,               SQL SEMANTIC SUMMARY                  01140000
                                                                        01150000
         EJECT                                                          01160000
         KYNDXRET ,               RESULT SET NDX DEFINITION RETURN AREA 01170000
                                                                        01180000
         EJECT                                                          01190000
         SPACETYP DSECT=YES       OBJECT SPACE DEFINITION BLOCK         01200000
                                                                        01210000
         EJECT                                                          01220000
         TBSERVIS CREATE,OPEN,CLOSE,ADD,PSARG,COLUMN,STATS,DESC         01230000
                                                                        01240000
         EJECT                                                          01250000
         VCATALOG ODBC_STATS      VIRTUAL CATALOG TABLE COMPOSITION     01260000
                                                                        01270000
         EJECT                                                          01280000
         CATINFO ,                COLUMN AND INDEX DEFINTION HEADER     01290000
                                                                        01300000
         EJECT                                                          01310000
         DDENTRY ,                SYSDICTIONARY ROW FORMAT              01320000
                                                                        01330000
         EJECT                                                          01340000
         ODBCSQLH ,               ODBC CONSTANTS, DEFINITIONS, ETC.     01350000
                                                                        01360000
         EJECT                                                          01370000
         CRSDP ,                  CREATE RESULT SET REQUEST/RESPONSE    01380000
                                                                        01390000
         EJECT                                                          01400000
         $TBSTATS ,               TABLE STATISTICS RETURN AREA FORMAT   01410000
                                                                        01420000
         EJECT                                                          01430000
         EQUS  ,                                                        01440000
                                                                        01450000
         ABCODES ,                                                      01460000
                                                                        01470000
         EJECT                                                          01480000
         #WORK ,                                                        01490000
                                                                        01500000
COL#     DS    F             COLUMN SEQUENCE-IN-INDEX                   01510000
KEYS#    DS    F             NUMBER OF INDEXES DEFINED OVER TABLE       01520000
@NDXDEF  DS    A             RESULT SET INDEX DEFINITION (KYNDXRET)     01530000
CURTABTK DS    F             CURRENT TABLE - TABLE TOKEN                01540000
                                                                        01550000
REQVIEW  DS    F             REQUEST TYPE FROM TABLE NAME SUFFIX        01560000
REQ_UNIQ EQU   1                UNIQUE INDICIES                         01570000
REQ_ALL  EQU   2                ALL INDICIES                            01580000
                                                                        01590000
RET_CRSD DS    F             RESULT SET DEFINITION SERVICE RTN RETCODE  01600000
$SCNCKPT DS    XL8           ICAT$SCN CHECKPOINT AREA                   01610000
                                                                        01620000
RETCODES DS    0F,0F,0F      COMPLETION STATUS                          01630000
RETCODE  DS    F                RETURN CODE                             01640000
RSNCODE  DS    F                REASON CODE                             01650000
INFCODE  DS    F                INFO CODE                               01660000
                                                                        01670000
REGSAVE  DS    16F           LOCAL SUBROUTINE SAVEAREA                  01680000
WK256    DS    XL256         GENERAL PURPOSE WORKAREA                   01690000
                                                                        01700000
*--------------------------------------------------------------         01710000
*   TABLE COLUMN STATUS MAINTAINED FOR NULLABLE COLUMNS                 01720000
*--------------------------------------------------------------         01730000
                                                                        01740000
NULL_QUALIFIER DS    F       TABLE_QUALIFIER                            01750000
NULL_OWNER     DS    F       TABLE_OWNER                                01760000
NULL_NON_UNIQ  DS    F       NON_UNIQUE                                 01770000
NULL_NDX_QUAL  DS    F       INDEX_QUALIFIER                            01780000
NULL_NDX_NAME  DS    F       INDEX_NAME                                 01790000
NULL_SEQ_NDX   DS    F       SEQ_IN_INDEX                               01800000
NULL_COL_NAME  DS    F       COLUMN_NAME                                01810000
NULL_COLLATION DS    F       COLLATION                                  01820000
NULL_CARDINAL  DS    F       CARDINALITY                                01830000
NULL_PAGES     DS    F       PAGES                                      01840000
NULL_FILTER    DS    F       FILTER_CONDITION                           01850000
                                                                        01860000
NULL_IND DS    XL4           NULL INDICATORS FOR 32 COLUMNS             01870000
NULL_ALL DS    XL4           RETAINS PERMANENTLY NULLED FIELDS          01880000
NULL_NDX DS    XL4           RETAINS NULLED INDEX DEFINITION FIELDS     01890000
                                                                        01900000
*--------------------------------------------------------------         01910000
*   PLIST CONSTRUCTION AREAS                                            01920000
*--------------------------------------------------------------         01930000
                                                                        01940000
$CRSDP   DS    0F,XL(CRSDPLN)    CREATE RESULT SET DEFINITION REQ/RESP  01950000
$CRSTREF DS    0F,XL(CRSTREFL)   CREATE RESULT SET - TABLE REFERENCE    01960000
                                                                        01970000
*--------------------------------------------------------------         01980000
*   VARDATA COLUMN COLLECTION AND CONSTRUCTION AREA                     01990000
*--------------------------------------------------------------         02000000
                                                                        02010000
VCHAR@   DS    A             FREE AREA PTR IN VARDATA COLLECTION AREA   02020000
VCHAR#   DS    F             FREE STG LEFT IN VARDATA COLLECTION AREA   02030000
VCHAR@T  DS    A             VCHAR@ AFTER TABLE VARDATA POSTED          02040000
VCHAR#T  DS    F             VCHAR# AFTER TABLE VARDATA POSTED          02050000
VCHAR@I  DS    A             VCHAR@ AFTER INDEX VARDATA POSTED          02060000
VCHAR#I  DS    F             VCHAR# AFTER INDEX VARDATA POSTED          02070000
                                                                        02080000
VCHARBUF DS    XL256         VARDATA COLLECTION AREA                    02090000
                                                                        02100000
*--------------------------------------------------------------         02110000
*   TABLE SERVICES ROW BUFFERS, STATISTICS, ETC.                        02120000
*--------------------------------------------------------------         02130000
                                                                        02140000
$ODBCROW DS    XL(ODBSTATS_LENGTH)  SYSVCAT_ODBC_STAT SOURCE ROW BUFFER 02150000
                                                                        02160000
$DDEROW  DS    XL(DDELN)     SYSDICTIONARY ROW BUFFER                   02170000
$DDEVX   DS    XL256         VARDATAX EXTENSION AREA                    02180000
                                                                        02190000
RETSTATS DS    A,F           ADDRESS LENGTH OF TBSTATS RETURN AREA      02200000
RTBSTATS DS    XL256         $TBSTATS RETURN AREA                       02210000
                                                                        02220000
RETDESC  DS    A,F           ADDRESS LENGTH OF TBDESC  RETURN AREA      02230000
RTBDESC  DS    XL256         TBFMT RETURN AREA                          02240000
                                                                        02250000
         #ENDWORK                                                       02260000
                                                                        02270000
         EJECT                                                          02280000
IODBSTAT #ENTER PREG=R8                                                 02290000
                                                                        02300000
         USING ITASK,R10                                                02310000
                                                                        02320000
         EJECT                                                          02330000
***************************************************************         02340000
*                                                                       02350000
*   Validate the table name suffix that is used to select               02360000
*   the content of the result set.                                      02370000
*                                                                       02380000
***************************************************************         02390000
                                                                        02400000
         USING QCS,R8             LIFE OF FUNCTION                      02410000
                                                                        02420000
         ICM   R2,1,QCSTABLE+L'TABNAME-1                                02430000
                                                                        02440000
         CLM   R2,1,=C'1'         VALIDATE TABLE NAME SUFFIX            02450000
         BL    ERR_CTAB                                                 02460000
         CLM   R2,1,=C'2'                                               02470000
         BH    ERR_CTAB                                                 02480000
                                                                        02490000
         N     R2,=X'0000000F'    CONVERT TO NUMERIC                    02500000
         ST    R2,REQVIEW         RETAIN REQUEST TYPE                   02510000
                                                                        02520000
TABNAME  DS    0C'SYSVCAT_ODBC_STAT#'                                   02530000
                                                                        02540000
***************************************************************         02550000
*                                                                       02560000
*   Prepare to materialize the ODBC-defined result set                  02570000
*   by initializing a SYSVCAT_ODBC_STATn table in the execution         02580000
*   space.  We leave it to coop to determine the proper                 02590000
*   ordering and row admittance criterea via the use of                 02600000
*   ALL/DISTINCT and ORDER BY in the source SELECT statement.           02610000
*                                                                       02620000
***************************************************************         02630000
                                                                        02640000
         GENTBLNM QCSTABLE        GENERATE A NAME FOR THE RESULT SET    02650000
                                                                        02660000
C        USING ODBSTATS,$ODBCROW  SYSVCAT_ODBC_STATn ROW                02670000
                                                                        02680000
*--------------------------------------------------------------         02690000
*   GENERATE A RESULT SET DEFINITION FROM THE BASE TABLE                02700000
*--------------------------------------------------------------         02710000
                                                                        02720000
         L     R7,=V(IVCASTAT)    SYSVCAT_ODBC_STATn TABLE FORMAT       02730000
         USING CATINFO,R7         DEFINITION FORMAT                     02740000
                                                                        02750000
TREF     USING CRSTREF,$CRSTREF   SINGLE VIRTUAL TABLE REFERENCE        02760000
         L     R6,QCSSSMRY        LOCATE THE SEMANTIC SUMMARY           02770000
         USING SQSEMAL,R6                                               02780000
         MVC   TREF.CRSTAB,SQSATBLS    RETAIN PTR TO TABLE IDENTIFIER   02790000
         MVC   TREF.CRSTCOL@,CATCOLS   TBCOLDEF PTR ARRAY ORIGIN        02800000
         MVC   TREF.CRSTCOL#,CAT#COLS  NUMBER OF COLUMNS IN BASE TABLE  02810000
         DROP  R7                 CATINFO                               02820000
                                                                        02830000
CRSD     USING CRSDP,$CRSDP       CREATE RESULT SET DEFINITION REQ/RESP 02840000
         ST    R6,CRSD.CRSDSMRY   PROVIDE SEMANTIC SUMMARY AS PARM      02850000
         LA    R0,TREF.CRSTREF    TABLE REFERENCE LIST ORIGIN           02860000
         ST    R0,CRSD.CRSDTBL@   ANCHOR IN CRSDP                       02870000
         LA    R0,1               TABLE REFERENCE IS A SINGLETON        02880000
         ST    R0,CRSD.CRSDTBL#   ANCHOR IN CRSDP                       02890000
         DROP  TREF,R6            CRSDP TABLE REFERENCE, SQSEMAL        02900000
                                                                        02910000
         LA    R1,CRSD.CRSDP      R1 <== RESULT SET DEFINITION REQ/RESP 02920000
         @CALL ISQLCRSD,CTYPE=STD                                       02930000
                                                                        02940000
         ST    R15,RET_CRSD       RETAIN RESULT SET DEFINITION RETCODE  02950000
         CH    R15,=AL2(RC08)     ANALYZE RETURN CODE                   02960000
         BE    ERR_CREF           INVALID COLUMN REFERENCE              02970000
         BH    ERR_RSD            REQUEST IN ERROR                      02980000
                                                                        02990000
*--------------------------------------------------------------         03000000
*   BUILD RESULT SET INDEX DEFINITIONS, RETURN KYNDXRET IN R1           03010000
*--------------------------------------------------------------         03020000
                                                                        03030000
         @CALL ISQKYNDX,(QCS,*CRSD.CRSDPTR@,*CRSD.CRSDRSC#),           X03040000
               MF=(E,MFE_LIST)                                          03050000
                                                                        03060000
         B     *+4(R15)           ANALYZE COMPLETION CODE               03070000
         B     TBLCRE                RC00 - INDEX DEFINITION RETURNED   03080000
         B     TBLCRE                RC04 - NO INDICIES REQUIRED        03090000
         B     ERR_ORD               RC08 - ORDER-BY CLAUSE IN ERROR    03100000
         B     ERR_DIST              RC12 - ERROR RELATED TO DISTINCT   03110000
         EX    R0,*                  RC16 - DEFINED / NOT ANTICIPATED   03120000
                                                                        03130000
*--------------------------------------------------------------         03140000
*   CREATE THE RESULT SET                                               03150000
*--------------------------------------------------------------         03160000
                                                                        03170000
TBLCRE   DS    0H                                                       03180000
         XC    DWORD,DWORD        TBKEYDEF LIST AND ENTRY COUNT         03190000
         ST    R1,@NDXDEF         INDEX DEFINITION BLOCK OR ZERO        03200000
         LTR   R1,R1              INDEX DEFINITIONS PRESENTED?          03210000
         BZ    TBLCRETB           DONE HERE IF NOT                      03220000
                                                                        03230000
         USING KYNDXRET,R1        INDEX DEFINITION RETURN AREA          03240000
         LA    R0,KYNDXLST        TBKEYDEF LIST ORIGIN                  03250000
         ST    R0,DWORD+0         SAVE IN PARAMETER WORKAREA            03260000
         L     R0,KYNDXCNT        TBKEYDEF LIST ENTRY COUNT             03270000
         ST    R0,DWORD+4         SAVE IN PARAMETER WORKAREA            03280000
         DROP  R1                 KYNDXRET                              03290000
                                                                        03300000
TBLCRETB DS    0H                                                       03310000
         TBCREATE QCSTABLE,       PROVIDE GENERATED TABLE NAME         X03320000
               STOKEN=*ICTXSPT@,  EXECUTION SPACE                      X03330000
               TTOKEN=QCSTTOKN,   TABLE TOKEN IS GLOBAL SQL RESOURCE   X03340000
               COLCNT=*CRSD.CRSDTOT#,   COLUMN COUNT                   X03350000
               COLLST=*CRSD.CRSDPTR@,   COLUMN POINTER ARRAY           X03360000
               KEYCNT=*DWORD+4,   KEY COUNT                            X03370000
               KEYLST=*DWORD+0,   KEY LIST                             X03380000
               OPTS=(REPLACE,NOLOCATOR),                               X03390000
               MF=(E,WK256)                                             03400000
                                                                        03410000
*--------------------------------------------------------------         03420000
*   ANALYZE TBCREATE STATUS, RELEASE INDEX & RSD DEFINITIONS            03430000
*--------------------------------------------------------------         03440000
                                                                        03450000
         STM   R15,R1,RETCODES    PRESERVE TBCREATE COMPLETION STATUS   03460000
         ICM   R2,15,@NDXDEF      INDEX DEFINITION WORKAREA PENDING?    03470000
         BZ    TBLNONDX           SKIP IF NOT                           03480000
                                                                        03490000
         $RETSTOR (R2)            STORAGE OBLIGATION                    03500000
                                                                        03510000
TBLNONDX DS    0H                                                       03520000
                                                                        03530000
         CLC   RET_CRSD,=A(RC00)  RESULT SET DEFINITION CREATED?        03540000
         BNE   TBLNORSD           SKIP IF BASE TABLE DEFINITION USED    03550000
                                                                        03560000
         $RETSTOR *CRSD.CRSDPTR@                                        03570000
                                                                        03580000
TBLNORSD DS    0H                                                       03590000
                                                                        03600000
         LM    R15,R1,RETCODES    RESTORE TBCREATE COMPLETION STATUS    03610000
         LTR   R15,R15            TABLE CREATED WITHOUT INCIDENT?       03620000
         BNZ   ERR_TBSV           TERMINATING ERROR OTHERWISE           03630000
                                                                        03640000
         MVI   QCSTDROP,TRUE      AUTO DROP UPON CLOSE                  03650000
         DROP  CRSD               CREATE RESULT SET DEFINITION REQ/RESP 03660000
                                                                        03670000
*--------------------------------------------------------------         03680000
*   TERMINATE AT THIS POINT IF SQLPREPARE()                             03690000
*--------------------------------------------------------------         03700000
                                                                        03710000
         CLI   QCSCLI,QCSC_PRP    SQLPREPARE()?                         03720000
         BE    NORMRET            DONE IF SO                            03730000
                                                                        03740000
         EJECT                                                          03750000
***************************************************************         03760000
*                                                                       03770000
*   Identify columns that accept nulls included in result set.          03780000
*   Some columns have no local interpretation and are set               03790000
*   null for the life of this function.                                 03800000
*                                                                       03810000
***************************************************************         03820000
                                                                        03830000
         TBCOLUMN BYNAME,         IDENTIFY COLUMNS BY NAME / ROUND 1   X03840000
               (('TABLE_QUALIFIER',NULL_QUALIFIER),                    X03850000
               ('TABLE_OWNER',NULL_OWNER),                             X03860000
               ('NON_UNIQUE',NULL_NON_UNIQ),                           X03870000
               ('INDEX_QUALIFIER',NULL_NDX_QUAL),                      X03880000
               ('INDEX_NAME',NULL_NDX_NAME),                           X03890000
               ('SEQ_IN_INDEX',NULL_SEQ_NDX)),                         X03900000
               TTOKEN=QCSTTOKN,                                        X03910000
               MF=(E,WK256)                                             03920000
                                                                        03930000
         TBCOLUMN BYNAME,         IDENTIFY COLUMNS BY NAME / ROUND 2   X03940000
               (('COLUMN_NAME',NULL_COL_NAME),                         X03950000
               ('COLLATION',NULL_COLLATION),                           X03960000
               ('CARDINALITY',NULL_CARDINAL),                          X03970000
               ('PAGES',NULL_PAGES),                                   X03980000
               ('FILTER_CONDITION',NULL_FILTER)),                      X03990000
               TTOKEN=QCSTTOKN,                                        X04000000
               MF=(E,WK256)                                             04010000
                                                                        04020000
*--------------------------------------------------------------         04030000
*   NULL THOSE COLUMNS NOT POPULATED IN THIS IMPLEMENTATION             04040000
*--------------------------------------------------------------         04050000
                                                                        04060000
         SR    R2,R2              R2 <== COLUMN NUMBER                  04070000
         LA    R3,NULL_ALL        R3 <== NULL INDICATOR MASK ORIGIN     04080000
                                                                        04090000
         ICM   R2,3,NULL_QUALIFIER   TABLE_QUALIFIER COLUMN NUMBER      04100000
         BZ    *+8                                                      04110000
         BAS   R14,SETNULL                                              04120000
                                                                        04130000
         ICM   R2,3,NULL_OWNER       TABLE_OWNER COLUMN NUMBER          04140000
         BZ    *+8                                                      04150000
         BAS   R14,SETNULL                                              04160000
                                                                        04170000
         ICM   R2,3,NULL_NDX_QUAL    INDEX_QUALIFIER                    04180000
         BZ    *+8                                                      04190000
         BAS   R14,SETNULL                                              04200000
                                                                        04210000
         ICM   R2,3,NULL_FILTER      FILTER_CONDITION                   04220000
         BZ    *+8                                                      04230000
         BAS   R14,SETNULL                                              04240000
                                                                        04250000
*--------------------------------------------------------------         04260000
*   BUILD NULL MASK SUPPRESSING INDEX INFO FROM TABLE ENTRY             04270000
*--------------------------------------------------------------         04280000
                                                                        04290000
         LA    R3,NULL_NDX        R3 <== NULL INDICATOR MASK TEMPLATE   04300000
                                                                        04310000
         ICM   R2,3,NULL_NON_UNIQ    NON_UNIQUE                         04320000
         BZ    *+8                                                      04330000
         BAS   R14,SETNULL                                              04340000
                                                                        04350000
         ICM   R2,3,NULL_NDX_NAME    INDEX_NAME                         04360000
         BZ    *+8                                                      04370000
         BAS   R14,SETNULL                                              04380000
                                                                        04390000
         ICM   R2,3,NULL_SEQ_NDX     SEQ_IN_INDEX                       04400000
         BZ    *+8                                                      04410000
         BAS   R14,SETNULL                                              04420000
                                                                        04430000
         ICM   R2,3,NULL_COL_NAME    COLUMN_NAME                        04440000
         BZ    *+8                                                      04450000
         BAS   R14,SETNULL                                              04460000
                                                                        04470000
         ICM   R2,3,NULL_COLLATION   COLLATION                          04480000
         BZ    *+8                                                      04490000
         BAS   R14,SETNULL                                              04500000
                                                                        04510000
*--------------------------------------------------------------         04520000
*   INIT TBSTATS AND TBDESC RETURN AREAS IN $REALLOC FORMAT             04530000
*--------------------------------------------------------------         04540000
                                                                        04550000
         LA    R0,RTBSTATS        TBSTATS RETURN AREA                   04560000
         O     R0,=X'80000000'    SUGGESTED AREA IS NOT FREEABLE        04570000
         LA    R1,L'RTBSTATS      RETURN AREA LENGTH                    04580000
         STM   R0,R1,RETSTATS     EXPANDABLE RETURN AREA                04590000
                                                                        04600000
         LA    R0,RTBDESC         TBDESC RETURN AREA                    04610000
         O     R0,=X'80000000'    SUGGESTED AREA IS NOT FREEABLE        04620000
         LA    R1,L'RTBDESC       RETURN AREA LENGTH                    04630000
         STM   R0,R1,RETDESC      EXPANDABLE RETURN AREA                04640000
                                                                        04650000
         EJECT                                                          04660000
***************************************************************         04670000
*                                                                       04680000
*   Complete the predicate tree.  TBPSARG is issued to complete         04690000
*   the search argument passed to this routine, if any, with            04700000
*   references to the result set table created above.  The              04710000
*   near-ready tree is passed in via QCSSITRE and the TBPSARGed         04720000
*   tree is generally returned via QCSSATRE when it will be             04730000
*   used as a true TBGET search argument.  However, because we          04740000
*   will use it instead as a TBADD filter we leave QCSSATRE             04750000
*   null - all of the result set trimming will be accomplished          04760000
*   up front at TBADD time.                                             04770000
*                                                                       04780000
***************************************************************         04790000
                                                                        04800000
         ICM   R2,15,QCSSITRE     SEARCH ARGUMENT TREE PROVIDED?        04810000
         BZ    SARG_FIN           NO FURTHER PROCESSING IF NOT          04820000
                                                                        04830000
         TBPSARG TTOKEN=QCSTTOKN, CONVERT TO TABLE SERVICES EXEC FORM  X04840000
               SARGS=(R2),                                             X04850000
               XSTGMGR=(IGENCSTG,QCSGPSTG,WK256),                      X04860000
               MF=(E,MFE_LIST)                                          04870000
                                                                        04880000
         ST    R15,QCSPSARC       POST TBPSARG RETCODE                  04890000
         ST    R0,QCSPSARS        POST TBPSARG RSNCODE                  04900000
         LTR   R15,R15            NORMAL COMPLETION?                    04910000
         BNZ   ERR_ANAL           QCS ANALYSIS REQUIRED IF NOT          04920000
                                                                        04930000
         CLM   R0,1,=AL1(TRUE)    SEARCH ARG IS CATEGORICALLY TRUE?     04940000
         BNE   *+10               SKIP IF NOT                           04950000
         XC    QCSSITRE,QCSSITRE  SEARCH ARGUMENT / FILTER WITHDRAWN    04960000
                                                                        04970000
SARG_FIN DS    0H                                                       04980000
                                                                        04990000
         EJECT                                                          05000000
***************************************************************         05010000
*                                                                       05020000
*   SYSDICTIONARY SCAN                                                  05030000
*                                                                       05040000
*   Acquire the SYSDICTIONARY entry of each table residing in           05050000
*   the selected object space via repeated calls to ICAT$SCN,           05060000
*   retrieving one table descriptor per call. If EOT is                 05070000
*   returned on the first call, we assume that SYSDICTIONARY            05080000
*   does not exist in the target space, and therefore no                05090000
*   contents information is available.                                  05100000
*                                                                       05110000
***************************************************************         05120000
                                                                        05130000
CCATSCAN DS    0H                                                       05140000
         @CALL ICAT$SCN,(*QCSTSPAC,$SCNCKPT,$DDEROW),                  X05150000
               CTYPE=CVT,                                              X05160000
               MF=(E,MFE_LIST)                                          05170000
                                                                        05180000
         CH    R15,=AL2(RC04)     ALL TABLES OF RECORD RETURNED?        05190000
         BE    NORMRET            END OF SEARCH                         05200000
         BH    ERR_CSCN           TERMINATING ERROR WHILE SCANNING CAT  05210000
                                                                        05220000
*--------------------------------------------------------------         05230000
*   LOAD STATIC TABLE INFORMATION INTO SYSVCAT_ODBC_STATn ROW           05240000
*--------------------------------------------------------------         05250000
                                                                        05260000
D        USING DDENTRY,$DDEROW    SYSDICTIONARY ROW                     05270000
                                                                        05280000
         LA    R0,VCHARBUF        VARDATA COLLECTION AREA               05290000
         ST    R0,VCHAR@          ENTIRE AREA AVAILABLE FOR USE         05300000
         LA    R0,L'VCHARBUF      VARDATA COLLECTION AREA LENGTH        05310000
         ST    R0,VCHAR#          INITAL AMOUNT AVAILABLE FOR USE       05320000
                                                                        05330000
         $VARTRMC D.DDETABNM,VCHAR@,VCHAR#                              05340000
                                                                        05350000
         BZ    *+8                                                      05360000
         EX    R0,*               ASSERT SPACE AVAILABLE                05370000
         ST    R1,C.ODBSTAT_TABLE_NAME                                  05380000
                                                                        05390000
         EJECT                                                          05400000
***************************************************************         05410000
*                                                                       05420000
*   Issue TBSTATS to acquire information about the base table           05430000
*   and all of its indicies.  The TBSTATS service and TBDESC            05440000
*   services both require that the table be opened.                     05450000
*                                                                       05460000
*   TBSTATS is capable of acquiring its own $TBSTATS return             05470000
*   area but that storage is not owned and would require RMX            05480000
*   protection.  To simplify recovery, we provide the return            05490000
*   area in workunit-owned storage.  Similar comments apply to          05500000
*   TBDESC and the TBFMT data area produced by that service.            05510000
*                                                                       05520000
*   If this service is extended to fully support multiuser              05530000
*   execution spaces, serialization or some other form of table         05540000
*   locking will be required.                                           05550000
*                                                                       05560000
**************************************************************          05570000
                                                                        05580000
         TBOPEN D.DDETABNM,                                            X05590000
               STOKEN=*QCSTSPAC,                                       X05600000
               TTOKEN=CURTABTK,                                        X05610000
               MF=(E,MFE_LIST)                                          05620000
                                                                        05630000
         LTR   R15,R15            NORMAL COMPLETION                     05640000
         BNZ   CCATSCAN           PROBABLE ERROR, BUT ATTEMPT CONTINUE  05650000
                                                                        05660000
*--------------------------------------------------------------         05670000
*   ACQUIRE TABLE STATISTICS                                            05680000
*--------------------------------------------------------------         05690000
                                                                        05700000
RESTAT   DS    0H                                                       05710000
         TBSTATS (*RETSTATS+0,*RETSTATS+4),                            X05720000
               TTOKEN=CURTABTK,                                        X05730000
               MF=(E,MFE_LIST)                                          05740000
                                                                        05750000
         CH    R15,=AL2(RC04)     ANALYZE COMPLETION                    05760000
         BL    REDESC             STATISTICS ACQUIRED                   05770000
         BH    ERR_TBSV           TABLE SERVICES FAILURE                05780000
                                                                        05790000
         LA    R1,RETSTATS        R1 <== RETURN AREA DESCRIPTOR         05800000
         BAS   R14,REALLOC        R0 <== MINIMUM LENGTH REQUIRED        05810000
         B     RESTAT             TRY AGAIN                             05820000
                                                                        05830000
*--------------------------------------------------------------         05840000
*   ACQUIRE TABLE DESCRIPTION                                           05850000
*--------------------------------------------------------------         05860000
                                                                        05870000
REDESC   DS    0H                                                       05880000
         TBDESC RETURN=*RETDESC+0,                                     X05890000
               LENGTH=*RETDESC+4,                                      X05900000
               TTOKEN=CURTABTK,                                        X05910000
               MF=(E,MFE_LIST)                                          05920000
                                                                        05930000
         CH    R15,=AL2(RC04)     ANALYZE COMPLETION                    05940000
         BL    RECLOSE            DESCRIPTION ACQUIRED                  05950000
         BH    ERR_TBSV           TABLE SERVICES FAILURE                05960000
                                                                        05970000
         LA    R1,RETDESC         R1 <== RETURN AREA DESCRIPTOR         05980000
         BAS   R14,REALLOC        R0 <== MINIMUM LENGTH REQUIRED        05990000
         B     REDESC             TRY AGAIN                             06000000
                                                                        06010000
*--------------------------------------------------------------         06020000
*   CLOSE OPENED CATALOG TABLE                                          06030000
*--------------------------------------------------------------         06040000
                                                                        06050000
RECLOSE  DS    0H                                                       06060000
         TBCLOSE TTOKEN=CURTABTK,                                      X06070000
               MF=(E,MFE_LIST)                                          06080000
                                                                        06090000
         DROP  D                  DDENTRY                               06100000
                                                                        06110000
         EJECT                                                          06120000
***************************************************************         06130000
*                                                                       06140000
*   Generate a result set row representing the base table.              06150000
*   index information is nulled in this entry.                          06160000
*                                                                       06170000
***************************************************************         06180000
                                                                        06190000
         L     R7,RETSTATS+0      LOCATE RETURNED STATISTICS            06200000
         USING $TBSTATS,R7        TBSTATS RETURN AREA FORMAT            06210000
                                                                        06220000
         MVC   NULL_IND,NULL_ALL                                        06230000
         OC    NULL_IND,NULL_NDX                                        06240000
                                                                        06250000
         MVC   C.ODBSTAT_TYPE,=AL2(SQL_TABLE_STAT)                      06260000
         MVC   C.ODBSTAT_CARDINALITY,$TBST_ROW_CNT                      06270000
                                                                        06280000
         L     R2,$TBST_BASE_OBJ                                        06290000
         AL    R2,$TBST_LOC_OBJ                                         06300000
         LA    R2,4095(,R2)       ROUND UP TO PAGE                      06310000
         SRL   R2,12              CONVERT TO 4K PAGES                   06320000
         ST    R2,C.ODBSTAT_PAGES                                       06330000
                                                                        06340000
*--------------------------------------------------------------         06350000
*   ADD THE BASE TABLE DESCRIPTOR ROW TO THE RESULT SET                 06360000
*--------------------------------------------------------------         06370000
                                                                        06380000
         TBADD C.ODBSTATS,        INSERT ROW IN RESULT SET             X06390000
               TTOKEN=QCSTTOKN,                                        X06400000
               FILTER=*QCSSITRE,  SEARCH ARGUMENT AS FILTER            X06410000
               NULLMASK=NULL_IND, NULL INDICATORS                      X06420000
               MF=(E,MFE_LIST)                                          06430000
                                                                        06440000
         CH    R15,=AL2(RC08)     ADDED OR SUPPRESSED PER REQUEST?      06450000
         BH    ERR_TBSV           ERROR OTHERWISE                       06460000
                                                                        06470000
         EJECT                                                          06480000
***************************************************************         06490000
*                                                                       06500000
*   Generate a result set row for each index matching the ODBC          06510000
*   fUnique parameter as conveyed in the target table name.             06520000
*   Requests may designate ALL indicies or only those that are          06530000
*   UNIQUE.                                                             06540000
*                                                                       06550000
***************************************************************         06560000
                                                                        06570000
         L     R6,RETDESC+0       LOCATE RETURNED DESCRIPTION           06580000
         USING TBFMT,R6           TBDESC RETURN AREA FORMAT             06590000
         SR    R0,R0              PREPARE FOR INSERT                    06600000
         ICM   R0,3,TBF#KEYS      NUMBER OF KEY (INDEX) DEFINITIONS     06610000
         BZ    NDXFIN             TABLE HAS NO INDICIES                 06620000
         ST    R0,KEYS#           RETAIN LOCAL COUNTER                  06630000
         L     R6,TBFKOFF         SCAN INDEX DEFINITIONS                06640000
         USING TBKEYDEF,R6        INDEX DEFINITION FORMAT               06650000
                                                                        06660000
         MVC   VCHAR@T,VCHAR@     PRESERVE TABLE LEVEL VARDATA          06670000
         MVC   VCHAR#T,VCHAR#     INSERTION ADDR AND REMAINING SPACE    06680000
                                                                        06690000
*--------------------------------------------------------------         06700000
*   DETERMINE WHETHER CURRENT INDEX SELECTED FOR RETURN                 06710000
*--------------------------------------------------------------         06720000
                                                                        06730000
NDXNEXT  DS    0H                                                       06740000
         CLC   REQVIEW,=A(REQ_ALL)   ALL INDICIES SELECTED BY REQUEST?  06750000
         BE    NDXSEL             SKIP THIS ONE IF NOT                  06760000
         CLI   TBKTYPE2,$UNIQUE   UNIQUE INDEX?                         06770000
         BNE   NDXADV             NOT SELECTED OTHERWISE                06780000
                                                                        06790000
NDXSEL   DS    0H                 MATCH TBKEYDEF TO TBSTATS NDX ENTRY   06800000
         ICM   R4,15,$TBST_TNDX_CNT                                     06810000
         BZ    NDXFIN             SEVERR: TBKEYDEF / TBSTATS MISMATCH   06820000
         LA    R5,$TBST_NDX       START OF INDEX SECTION                06830000
         USING $TBST_NDX,R5       TIGHTEN UP THE ADDRESSABILITY         06840000
                                                                        06850000
NDXSCAN  DS    0H                                                       06860000
         CLC   TBKEYNAM,$TBST_NDX_NAME                                  06870000
         BE    NDXGO                                                    06880000
         LA    R5,$TBST_NDX+$TBST_NDX_LEN                               06890000
         BCT   R4,NDXSCAN                                               06900000
         B     NDXFIN             SEVERR: TBKEYDEF / TBSTATS MISMATCH   06910000
                                                                        06920000
*--------------------------------------------------------------         06930000
*   PREPARE FOR INDEX FORMATTING                                        06940000
*--------------------------------------------------------------         06950000
                                                                        06960000
NDXGO    DS    0H                                                       06970000
         MVC   VCHAR@,VCHAR@T     RESTORE TABLE LEVEL VARDATA           06980000
         MVC   VCHAR#,VCHAR#T     INSERTION ADDR AND REMAINING SPACE    06990000
                                                                        07000000
         MVC   NULL_IND,NULL_ALL  PERMANENTLY NULLED COLUMNS            07010000
                                                                        07020000
***************************************************************         07030000
*                                                                       07040000
*   Initialize row with index level information                         07050000
*                                                                       07060000
***************************************************************         07070000
                                                                        07080000
         MVC   C.ODBSTAT_TYPE,=AL2(SQL_INDEX_OTHER)                     07090000
                                                                        07100000
*--------------------------------------------------------------         07110000
*   INDEX ENTRY UNQIUENESS / NONUNIQUENESS                              07120000
*--------------------------------------------------------------         07130000
                                                                        07140000
         LA    R0,FALSE           ASSUME UNIQUE INDEX                   07150000
         CLI   TBKTYPE2,$UNIQUE   UNIQUE INDEX?                         07160000
         BE    *+8                ASSUMPTION IS CORRECT                 07170000
         LA    R0,TRUE            INDEX IS NONUNIQUE                    07180000
         STH   R0,C.ODBSTAT_NON_UNIQUE                                  07190000
                                                                        07200000
*--------------------------------------------------------------         07210000
*   INDEX NAME                                                          07220000
*--------------------------------------------------------------         07230000
                                                                        07240000
         $VARTRMC $TBST_NDX_NAME,VCHAR@,VCHAR#                          07250000
                                                                        07260000
         BZ    *+8                                                      07270000
         EX    R0,*               ASSERT SPACE AVAILABLE                07280000
         ST    R1,C.ODBSTAT_INDEX_NAME                                  07290000
                                                                        07300000
*--------------------------------------------------------------         07310000
*   CARDINALITY, NULL IF INFORMATION IS NOT AVAILABLE                   07320000
*--------------------------------------------------------------         07330000
                                                                        07340000
         ICM   R0,15,$TBST_NDX_ACT                                      07350000
         ST    R0,C.ODBSTAT_CARDINALITY                                 07360000
         BNM   NDX_CARDINALITY                                          07370000
                                                                        07380000
         SR    R2,R2              R2 <== COLUMN NUMBER                  07390000
         LA    R3,NULL_IND        R3 <== NULL INDICATOR MASK ORIGIN     07400000
         ICM   R2,3,NULL_CARDINAL CARDINALITY COLUMN NUMBER             07410000
         BZ    *+8                NOT INCLUDED IN RESULT SET            07420000
         BAS   R14,SETNULL        NULL THAT COLUMN                      07430000
                                                                        07440000
NDX_CARDINALITY  DS  0H                                                 07450000
                                                                        07460000
*--------------------------------------------------------------         07470000
*   PAGES (4K)                                                          07480000
*--------------------------------------------------------------         07490000
                                                                        07500000
         L     R2,$TBST_NDX_OBJ                                         07510000
         LA    R2,4095(,R2)       ROUND UP TO PAGE                      07520000
         SRL   R2,12              CONVERT TO 4K PAGES                   07530000
         ST    R2,C.ODBSTAT_PAGES                                       07540000
         DROP  R7,R5              $TBSTATS, $TBST_NDX                   07550000
                                                                        07560000
         EJECT                                                          07570000
***************************************************************         07580000
*                                                                       07590000
*   Complete row with column information for current index              07600000
*                                                                       07610000
***************************************************************         07620000
                                                                        07630000
         MVC   VCHAR@I,VCHAR@     PRESERVE TABLE/INDEX LEVEL VARDATA    07640000
         MVC   VCHAR#I,VCHAR#     INSERTION ADDR AND REMAINING SPACE    07650000
                                                                        07660000
         LH    R5,TBKCOUNT        NUMBER OF COLUMNS SPANNED BY INDEX    07670000
         LA    R4,TBKCOLS         ORIGIN OF TBCOLDEF PTR ARRAY          07680000
         XC    COL#,COL#          RESET COLUMN NUMBER                   07690000
                                                                        07700000
COLNEXT  DS    0H                                                       07710000
         L     R3,0(,R4)          NTH NDX COLUMN KEY                    07720000
         USING TBCOLDEF,R3                                              07730000
                                                                        07740000
         MVC   VCHAR@,VCHAR@I     RESTORE TABLE/INDEX LEVEL VARDATA     07750000
         MVC   VCHAR#,VCHAR#I     INSERTION ADDR AND REMAINING SPACE    07760000
                                                                        07770000
*--------------------------------------------------------------         07780000
*   COLUMN NAME                                                         07790000
*--------------------------------------------------------------         07800000
                                                                        07810000
         $VARTRMC TBCNAME,VCHAR@,VCHAR#                                 07820000
                                                                        07830000
         BZ    *+8                                                      07840000
         EX    R0,*               ASSERT SPACE AVAILABLE                07850000
         ST    R1,C.ODBSTAT_COLUMN_NAME                                 07860000
                                                                        07870000
*--------------------------------------------------------------         07880000
*   COLUMN SEQUENCE-IN-INDEX                                            07890000
*--------------------------------------------------------------         07900000
                                                                        07910000
         L     R15,COL#           COLUMN SEQUENCE-IN-INDEX              07920000
         LA    R15,1(,R15)        COLUMNS NUMBERED 1 TO N               07930000
         ST    R15,COL#           RETAIN CURRENT COLUMN NUMBER          07940000
                                                                        07950000
         STH   R15,C.ODBSTAT_SEQ_IN_INDEX                               07960000
                                                                        07970000
*--------------------------------------------------------------         07980000
*   COLLATION, ASCENDING OR DESCENDING                                  07990000
*--------------------------------------------------------------         08000000
                                                                        08010000
         MVI   C.ODBSTAT_COLLATION,C'A'                                 08020000
         LTR   R3,R3              ASCENDING SEQUENCE BY SUBKEY?         08030000
         BNM   *+8                ASSUMPTION CORRECT IF SO              08040000
         MVI   C.ODBSTAT_COLLATION,C'D'                                 08050000
         DROP  R3                 TBCOLDEF                              08060000
                                                                        08070000
*--------------------------------------------------------------         08080000
*   ADD THE INDEX/COLUMN DESCRIPTOR ROW TO THE RESULT SET               08090000
*--------------------------------------------------------------         08100000
                                                                        08110000
         TBADD C.ODBSTATS,        INSERT ROW IN RESULT SET             X08120000
               TTOKEN=QCSTTOKN,                                        X08130000
               FILTER=*QCSSITRE,  SEARCH ARGUMENT AS FILTER            X08140000
               NULLMASK=NULL_IND, NULL INDICATORS                      X08150000
               MF=(E,MFE_LIST)                                          08160000
                                                                        08170000
         CH    R15,=AL2(RC08)     ADDED OR SUPPRESSED PER REQUEST?      08180000
         BH    ERR_TBSV           ERROR OTHERWISE                       08190000
                                                                        08200000
*--------------------------------------------------------------         08210000
*   EXAMINE ALL COLUMNS THIS INDEX, INDICIES THIS TABLE, TABLES         08220000
*--------------------------------------------------------------         08230000
                                                                        08240000
         LA    R4,4(,R4)          NEXT TBKEYDEF COLDEF ARRAY ENTRY      08250000
         BCT   R5,COLNEXT         PROCESS NEXT INDEX SUBKEY COLUMN      08260000
                                                                        08270000
NDXADV   DS    0H                 NEXT INDEX FOR CURRENT TABLE          08280000
         L     R0,KEYS#           NUMBER OF INDICIES                    08290000
         SH    R0,=H'1'           ACCOUNT FOR THIS PASS                 08300000
         ST    R0,KEYS#           NUMBER LEFT TO PROCESS                08310000
         BNP   NDXFIN             DONE WHEN ZERO                        08320000
                                                                        08330000
         LH    R2,TBKCOUNT        NUMBER OF COLUMNS SPANNED BY NDX      08340000
         SLL   R2,2               FOUR BYTE ENTRY FOR EACH              08350000
         LA    R6,TBKEYDEF+TBKEYDFL(R2)                                 08360000
         B     NDXNEXT            PROCESS NEXT INDEX ON CURRENT TABLE   08370000
         DROP  R6                 TBKEYDEF                              08380000
                                                                        08390000
NDXFIN   DS    0H                                                       08400000
         B     CCATSCAN           ADVANCE TO NEXT TABLE                 08410000
                                                                        08420000
         EJECT                                                          08430000
***************************************************************         08440000
*                                                                       08450000
*   RETURN RESULT SET AND/OR COMPLETION STATUS TO REQUESTER             08460000
*                                                                       08470000
***************************************************************         08480000
                                                                        08490000
NORMRET  DS    0H                 FORMAT DATA FOR RETURN                08500000
         MVC   QCSTSPAC,ICTXSPT@  RETURN EXECUTION SPACE TOKEN          08510000
         B     RETURN             DONE                                  08520000
                                                                        08530000
*--------------------------------------------------------------         08540000
*   REFERENCE TO UNDEFINED COLUMN                                       08550000
*--------------------------------------------------------------         08560000
                                                                        08570000
ERR_CREF DS    0H                 INVALID COLUMN REFERENCE              08580000
CREF     USING SQCOLREF,R1        COLUMN OCCURRENCE                     08590000
         MVC   QCSECLEX,CREF.SQCOL@C   #CLEX ADDRESS                    08600000
                                                                        08610000
         SQLSTAT ERC_CREF                                               08620000
                                                                        08630000
         B     RETURN                                                   08640000
         DROP  CREF               SQCOLREF                              08650000
                                                                        08660000
*--------------------------------------------------------------         08670000
*   ORDER BY CLAUSE ERROR                                               08680000
*--------------------------------------------------------------         08690000
                                                                        08700000
ERR_ORD  DS    0H                 ERROR IN 'ORDER BY' CLAUSE            08710000
         LR    R2,R1              SUPPLEMENTAL MESSAGE                  08720000
                                                                        08730000
         SQLSTAT ERC_ORD,INFO=(R15)                                     08740000
                                                                        08750000
         SQLMSG 170,(R2)                                                08760000
                                                                        08770000
         B     RETURN                                                   08780000
                                                                        08790000
*--------------------------------------------------------------         08800000
*   DISTINCT KEYDEF BUILD ERROR                                         08810000
*--------------------------------------------------------------         08820000
                                                                        08830000
ERR_DIST DS    0H                 ERROR BUILDING INDEX serving DISTINCT 08840000
         SQLSTAT ERC_DIST,INFO=(R15)                                    08850000
                                                                        08860000
         B     RETURN                                                   08870000
                                                                        08880000
*--------------------------------------------------------------         08890000
*   RESULT SET DEFINITION - CONSTRUCTION ERROR                          08900000
*--------------------------------------------------------------         08910000
                                                                        08920000
ERR_RSD  DS    0H                 ERROR CONSTRUCTING RSD                08930000
         SQLSTAT ERC_RSD,INFO=(R15)                                     08940000
                                                                        08950000
         B     RETURN                                                   08960000
                                                                        08970000
*--------------------------------------------------------------         08980000
*   INVALID TABLE NAME                                                  08990000
*--------------------------------------------------------------         09000000
                                                                        09010000
ERR_CTAB DS    0H                 TABLE NAME SUFFIX IS INVALID          09020000
         SQLSTAT ERC_CTAB                                               09030000
                                                                        09040000
         B     RETURN                                                   09050000
                                                                        09060000
*--------------------------------------------------------------         09070000
*   CATALOG SCAN FAILURE                                                09080000
*--------------------------------------------------------------         09090000
                                                                        09100000
ERR_CSCN DS    0H                                                       09110000
         SQLIDCMP COMPONENT='CATALOG SCAN'                              09120000
                                                                        09130000
         SQLSTAT ERC_CSCN,INFO=(R15)                                    09140000
                                                                        09150000
         B     RETURN                                                   09160000
                                                                        09170000
*--------------------------------------------------------------         09180000
*   TABLE SERVICE FAILURE                                               09190000
*--------------------------------------------------------------         09200000
                                                                        09210000
ERR_TBSV DS    0H                                                       09220000
         SQLIDCMP COMPONENT='TABLE SERVICES'                            09230000
                                                                        09240000
         SQLSTAT ERC_TBSV,INFO=(R15)                                    09250000
                                                                        09260000
         B     RETURN                                                   09270000
                                                                        09280000
*--------------------------------------------------------------         09290000
*   SERVICE FAILURE, QCS ANALYSIS REQUIRED FOR DETAIL                   09300000
*--------------------------------------------------------------         09310000
                                                                        09320000
ERR_ANAL DS    0H                 QCS ANALYSIS REQUIRED                 09330000
         SQLSTAT ERC_ANALYZE                                            09340000
                                                                        09350000
         B     RETURN                                                   09360000
                                                                        09370000
*--------------------------------------------------------------         09380000
*   RELEASE ACQUIRED STORAGE AREAS AND RETURN                           09390000
*--------------------------------------------------------------         09400000
                                                                        09410000
RETURN   DS    0H                                                       09420000
         STM   R15,R1,RETCODES    PRESERVE RETURN REGS                  09430000
                                                                        09440000
         ICM   R2,15,RETSTATS+0   AUX $TBSTATS RETURN AREA ALLOCATED?   09450000
         BNP   RET_STAT           SKIP IF NOT                           09460000
                                                                        09470000
         $RETSTOR (R2)                                                  09480000
                                                                        09490000
RET_STAT DS    0H                                                       09500000
         ICM   R2,15,RETDESC+0    AUX TBFMT (TBDESC) RETURN AREA ALLOC? 09510000
         BNP   RET_DESC           SKIP IF NOT                           09520000
                                                                        09530000
         $RETSTOR (R2)                                                  09540000
                                                                        09550000
RET_DESC DS    0H                                                       09560000
         LM    R15,R1,RETCODES    RESTORE RETURN REGS                   09570000
                                                                        09580000
         #EXIT ,                                                        09590000
                                                                        09600000
         EJECT                                                          09610000
***************************************************************         09620000
*                                                                       09630000
*   CATASTROPHIC FAILURES, PROGRAMMING ERRORS, ETC.                     09640000
*                                                                       09650000
***************************************************************         09660000
                                                                        09670000
ABN_FAIL $ABEND ABE_ENV,DUMP=YES,                                      X09680000
               TITLE='RESULT SET DEFINITION - GENERATION ERROR'         09690000
                                                                        09700000
         EJECT                                                          09710000
***************************************************************         09720000
*                                                                       09730000
* ROUTINE: REALLOC - REALLOCATE DATA RETURN AREA                        09740000
*                                                                       09750000
* ON ENTRY:                                                             09760000
*                                                                       09770000
*    R1 - DATA AREA DESCRIPTOR IN $REALLOC FORMAT                       09780000
*    R0 - LENGTH OF DATA AREA REQUIRED                                  09790000
*                                                                       09800000
* ON EXIT:                                                              09810000
*                                                                       09820000
*    RETURN AREA REPLACED AND ITS DESCRIPTOR UPDATED                    09830000
*                                                                       09840000
***************************************************************         09850000
                                                                        09860000
REALLOC  DS    0H                                                       09870000
         STM   R0,R15,REGSAVE     PRESERVE MAINLINE REGS                09880000
                                                                        09890000
         LR    R2,R1              DATA AREA (PTR,LENGTH)                09900000
         LR    R3,R0              LENGTH REQUIRED                       09910000
                                                                        09920000
         $REALLOC (R2),(R3),                                           X09930000
               COND=NO,                                                X09940000
               MF=(E,MFE_LIST)                                          09950000
                                                                        09960000
         LM    R0,R14,REGSAVE     RESTORE MAINLINE REGS                 09970000
         BR    R14                RETURN                                09980000
                                                                        09990000
         EJECT                                                          10000000
***************************************************************         10010000
*                                                                       10020000
* ROUTINE: SETNULL - SET NULL MASK BIT FOR GIVEN COLUMN                 10030000
*                                                                       10040000
* ON ENTRY:                                                             10050000
*                                                                       10060000
*    R3 - MASK ORIGIN                                                   10070000
*    R2 - COLUMN NUMBER (1 TO N)                                        10080000
*                                                                       10090000
***************************************************************         10100000
                                                                        10110000
SETNULL  DS    0H                                                       10120000
         ST    R14,FWORD          PRESERVE RETURN ADDRESS               10130000
                                                                        10140000
         SETBIT (R3),(R2)                                               10150000
                                                                        10160000
         L     R14,FWORD          RESTORE RETURN ADDRESS                10170000
         BR    R14                RETURN                                10180000
                                                                        10190000
         EJECT                                                          10200000
***************************************************************         10210000
*                                                                       10220000
*   LOCAL READ-ONLY WORKING STORAGE                                     10230000
*                                                                       10240000
***************************************************************         10250000
                                                                        10260000
TYPE_TABLE         DCVAR 'TABLE'                                        10270000
TYPE_SYSTEM_TABLE  DCVAR 'SYSTEM TABLE'                                 10280000
TYPE_TEMPORARY     DCVAR 'LOCAL TEMPORARY'                              10290000
                                                                        10300000
REMARK_CATALOG     DCVAR 'CATALOG'                                      10310000
REMARK_VDB         DCVAR 'VDB'                                          10320000
                                                                        10330000
*--------------------------------------------------------------         10340000
*   LITERALS, ETC.                                                      10350000
*--------------------------------------------------------------         10360000
                                                                        10370000
         LTORG ,                                                        10380000
                                                                        10390000
         EJECT                                                          10400000
         SQLCODES ,                                                     10410000
                                                                        10420000
         EJECT                                                          10430000
         PRINT NOGEN                                                    10440000
         ICVT ,              ICVT                                       10450000
         ITASK ,             ITASK                                      10460000
         END   ,                                                        10470000

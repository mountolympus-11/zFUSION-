ICONSCOP TITLE '- COMMAND OPERAND SCOPING'                              00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: ICONSCOP - Command operand scoping                           00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine is invoked to ensure that a command line              00080000
*    submitted by an unauthorized requester does not violate            00090000
*    "scope constaints" imposed in the KEYTAB-resident operand          00100000
*    definitions.                                                       00110000
*                                                                       00120000
*    Scope constraints are limitations imposed on the use               00130000
*    and/or value range of command line operands to ensure that         00140000
*    no work units, facilities, etc. other than those owned by          00150000
*    the requester are impacted, and that no private                    00160000
*    information is disclosed.                                          00170000
*                                                                       00180000
*    The KEYTAB (operand definitions) and OPLIST (operand               00190000
*    instances) are scanned in parallel to determine whether            00200000
*    any restricted operands (AUTH=YES) have been specified in          00210000
*    the command line.  If so, the validation fails.                    00220000
*                                                                       00230000
*                                                                       00240000
* SCOPING ROUTINES:                                                     00250000
*                                                                       00260000
*    If a KEYTAB SCOPEREQ= routine is attached to an operand,           00270000
*    it is invoked regardless of whether the operand was                00280000
*    explicitly coded in the command.                                   00290000
*                                                                       00300000
*    The normal technique for imposing a scope constraint is to         00310000
*    first verify that if the operand was specified, that its           00320000
*    value does not violate the scope constraint.  If the               00330000
*    operand is not specified, the appropriate value can be             00340000
*    inserted into the operand extension area and posted in the         00350000
*    OPLIST entry.                                                      00360000
*                                                                       00370000
*    Scoping routines are passed a parameter list mapped by             00380000
*    CSCOPEP which is quite similar to the parameter list               00390000
*    provided to this routine.  That mapping also describes             00400000
*    scoping routine return code requirements.                          00410000
*                                                                       00420000
*                                                                       00430000
* ON ENTRY:                                                             00440000
*                                                                       00450000
*    R1  contains the address of a parameter list constructed           00460000
*        as follows                                                     00470000
*                                                                       00480000
*        +00 - addr of operand keyword table KEYHDR (ref KEYTAB)        00490000
*        +04 - addr of OPLIST operand summary table (ref OPLIST)        00500000
*        +08 - addr of command request block        (ref CITREQ)        00510000
*        +12 - operand extension area                                   00520000
*        +16 - operand extension area length                            00530000
*                                                                       00540000
*                                                                       00550000
* ON EXIT:                                                              00560000
*                                                                       00570000
*    R15 contains one of the following return codes                     00580000
*                                                                       00590000
*        RC00 - command properly scoped                                 00600000
*                                                                       00610000
*               R0 - length of extension area used                      00620000
*                                                                       00630000
*        RC04 - command is not properly scoped (violation)              00640000
*        RC08 - space exhausted in the extension area                   00650000
*                                                                       00660000
*    For all error return codes (RC > RC00)                             00670000
*                                                                       00680000
*        R0 - addr of KEYTAB entry                                      00690000
*        R1 - addr of OPLIST entry                                      00700000
*                                                                       00710000
**<DOC-OFF>****************************************************         00720000
                                                                        00730000
         EJECT                                                          00740000
***************************************************************         00750000
*                                                                       00760000
* MAINTENANCE:                                                          00770000
*                                                                       00780000
*    04/06/95 R. Turgeon                                                00790000
*             Initial version                                           00800000
*                                                                       00810000
***************************************************************         00820000
                                                                        00830000
         EJECT                                                          00840000
         #WORK ,             BEGIN WORKAREA                             00850000
                                                                        00860000
EXTAREA  DS    A             EXTENSION AREA ORIGIN                      00870000
EXTFREE  DS    A             EXTENSION AREA FREE PTR                    00880000
EXTFRELN DS    F             EXTENSION AREA FREE AREA LENGTH            00890000
                                                                        00900000
         EJECT                                                          00910000
         CSCOPEP DSECT=NO    SCOPING ROUTINE PARAMETER LIST             00920000
                                                                        00930000
         #ENDWORK ,          END WORKAREA                               00940000
                                                                        00950000
         EJECT                                                          00960000
         KEYTAB DSECT=YES    COMMAND KEYWORD TABLE FORMATS              00970000
                                                                        00980000
         EJECT                                                          00990000
         OPLIST ,            COMMAND KEYWORD & VALUES INSTANCES         01000000
                                                                        01010000
         EJECT                                                          01020000
         CITREQ DSECT=YES    INTERTASK COMMAND EXECUTION REQUEST BLOCK  01030000
                                                                        01040000
         EJECT                                                          01050000
         EQUS  ,                                                        01060000
                                                                        01070000
         EJECT ,                                                        01080000
ICONSCOP #ENTER PREG=R8                                                 01090000
                                                                        01100000
         EJECT                                                          01110000
***************************************************************         01120000
*                                                                       01130000
*   GENERAL INITIALIZATION, FETCH PASSSED PARAMETERS                    01140000
*                                                                       01150000
***************************************************************         01160000
                                                                        01170000
         LM    R2,R3,12(R8)       FETCH EXTENSION AREA INFO             01180000
         ST    R2,EXTAREA         EXTENSION AREA ORIGIN                 01190000
         ST    R2,EXTFREE         EXTENSION AREA FREE SLOT              01200000
         ST    R3,EXTFRELN        EXTENSION AREA REMAINING LENGTH       01210000
                                                                        01220000
         LM    R5,R7,0(R8)        FETCH MAJOR CONTROL BLOCKS            01230000
         USING KEYHDR,R5          KEYTAB HEADER                         01240000
         USING OPLIST,R6          OPERAND SUMMARY TABLE                 01250000
         USING CITREQ,R7          INTERTASK COMMAND REQ BLOCK OR ZERO   01260000
                                                                        01270000
*--------------------------------------------------------------         01280000
*   PRECONSTRUCT FIXED COMPONENTS OF SCOPING ROUTINE PLIST              01290000
*--------------------------------------------------------------         01300000
                                                                        01310000
         ST    R7,CSCOCIT         INTERTASK COMMAND REQUEST BLOCK       01320000
         LA    R0,EXTFREE         FREE AREA PTR ADDRESS                 01330000
         ST    R0,CSCOXFRE        UPDATED DIRECTLY BY SCOPE RTN         01340000
         LA    R0,EXTFRELN        FREE AREA LENGTH ADDRESS              01350000
         ST    R0,CSCOXFRL        UPDATED DIRECTLY BY SCOPE RTN         01360000
                                                                        01370000
***************************************************************         01380000
*                                                                       01390000
*   Parallel scan of the KEYTAB and OPLIST                              01400000
*                                                                       01410000
***************************************************************         01420000
                                                                        01430000
         L     R4,KEYHORG         PREPARE FOR KEYTAB SCAN               01440000
         USING KEYTAB,R4                                                01450000
         L     R3,KEYHCNT         NUMBER OF KEYTAB / OPLIST ENTRIES     01460000
                                                                        01470000
*--------------------------------------------------------------         01480000
*   VALIDATE USE OF RESTRICTED OPERANDS                                 01490000
*--------------------------------------------------------------         01500000
                                                                        01510000
SCAN     DS    0H                                                       01520000
         CLI   OPLSPEC,0          KEYWORD / VALUE CODED IN COMMAND?     01530000
         BE    SCOPE              SKIP IF NOT                           01540000
         TM    KEYTOPTS,KEYTOPT_AUTH  UNSCOPED REQUESTERS ONLY?         01550000
         BO    ERR_VIO            VIOLATION IF SO                       01560000
                                                                        01570000
*--------------------------------------------------------------         01580000
*   INTERFACE WITH SCOPING ROUTINES                                     01590000
*--------------------------------------------------------------         01600000
                                                                        01610000
SCOPE    DS    0H                 INVOKE SCOPE ROUTINE IF DEFINED       01620000
         ICM   R15,15,KEYTSCOP    SCOPING ROUTINE ATTACHED?             01630000
         BZ    ADVANCE            NO ISSUES OTHERWISE                   01640000
                                                                        01650000
         ST    R4,CSCOKEY         CURRENT KEYTAB ENTRY                  01660000
         ST    R6,CSCOOPL         CURRENT OPLIST ENTRY                  01670000
                                                                        01680000
         @CALL (R15),MF=(E,CSCOPEP)                                     01690000
                                                                        01700000
         B     *+4(R15)           ANALYZE COMPLETION                    01710000
         B     ADVANCE               SCOPE VALIDATED OR COMPLETED       01720000
         B     ERR_VIO               SCOPE VIOLATION                    01730000
         B     ERR_OVFL              OPERAND EXTENSION AREA OVERFLOW    01740000
                                                                        01750000
*--------------------------------------------------------------         01760000
*   PROCESS ALL KEYTAB / OPLIST ENTRIES                                 01770000
*--------------------------------------------------------------         01780000
                                                                        01790000
ADVANCE  DS    0H                                                       01800000
         LA    R4,KEYTAB+KEYTLN   ADVANCE TO NEXT KEYTAB                01810000
         LA    R6,OPLIST+OPLISTLN ADVANCE TO CORR OPLIST ENTRY          01820000
         BCT   R3,SCAN            PROCESS ALL ENTRIES                   01830000
                                                                        01840000
         EJECT                                                          01850000
***************************************************************         01860000
*                                                                       01870000
*   RETURN COMPLETION STATUS TO CALLER                                  01880000
*                                                                       01890000
***************************************************************         01900000
                                                                        01910000
NORMRET  DS    0H                                                       01920000
         LA    R15,RC00           NO SCOPE CONSTRAINT VIOLATION         01930000
         L     R0,EXTFREE         FIRST UNUSED EXTENSION AREA BYTE      01940000
         S     R0,EXTAREA         TOTAL EXTENSION AREA SIZE USED        01950000
         SR    R1,R1              NO INFORMATION DEFINED                01960000
         B     EXIT               RETURN                                01970000
                                                                        01980000
ERR_VIO  DS    0H                 SCOPING VIOLATION ENCOUNTERED         01990000
         LA    R15,RC04           RETURN CODE                           02000000
         LA    R0,KEYTAB          OPERAND DEFINITION                    02010000
         LA    R1,OPLIST          OPERAND INSTANCE                      02020000
         B     EXIT                                                     02030000
                                                                        02040000
ERR_OVFL DS    0H                 OPERAND EXTENSION AREA OVERFLOW       02050000
         LA    R15,RC08           RETURN CODE, IDENTIFY FAILING OPERAND 02060000
         LA    R0,KEYTAB          OPERAND DEFINITION                    02070000
         LA    R1,OPLIST          OPERAND INSTANCE                      02080000
                                                                        02090000
*--------------------------------------------------------------         02100000
*   RETURN TO CALLER                                                    02110000
*--------------------------------------------------------------         02120000
                                                                        02130000
EXIT     DS    0H                                                       02140000
         #EXIT ,                  TERMINATE                             02150000
                                                                        02160000
         EJECT                                                          02170000
***************************************************************         02180000
*                                                                       02190000
*   LOCAL READ/ONLY DATA AREAS, ETC.                                    02200000
*                                                                       02210000
***************************************************************         02220000
                                                                        02230000
         LTORG ,                                                        02240000
                                                                        02250000
         PRINT NOGEN                                                    02260000
         ICVT  ,                                                        02270000
         END   ,                                                        02280000

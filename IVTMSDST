IVTMSDST TITLE 'INTEGRATOR - ISESS DRIVER START'                        00010000
**<DOC-ON>************************************************************* 00020000
*                                                                       00030000
* ROUTINE: IVTMSDST - ISESS DRIVER START                                00040000
*                                                                       00050000
* DESCRIPTION: THIS ROUTINE IS CALLED BY IVTMSDIN OR IVTMSD02 TO        00060000
*              ACTIVATE THE DRIVER PROC.                                00070000
*                                                                       00080000
*                                                                       00090000
* ON ENTRY:                                                             00100000
*                                                                       00110000
*    R15 = ENTRY POINT ADDRESS                                          00120000
*    R14 = RETURN      ADDRESS                                          00130000
*    R13 = SAVE AREA   ADDRESS                                          00140000
*    R11 = ICVT        ADDRESS                                          00150000
*    R10 = ITASK       ADDRESS                                          00160000
*    R09 = IVTAMCVT    ADDRESS                                          00170000
*    R08 = ISESS       ADDRESS                                          00180000
*    R07 = IACB        ADDRESS                                          00190000
*                                                                       00200000
* ON EXIT:                                                              00210000
*                                                                       00220000
*    R15 = 0                                                            00230000
*    R00 = 0                                                            00240000
*    R01 = 0                                                            00250000
*                                                                       00260000
*    ALL OTHER REGISTERS ARE RESTORED.                                  00270000
*                                                                       00280000
**<DOC-OFF>************************************************************ 00290000
                                                                        00300000
         EJECT ,                                                        00310000
*********************************************************************** 00320000
*                                                                       00330000
* MAINTENANCE:                                                          00340000
*                                                                       00350000
*   08/01/93 RANDY WITEK                                                00360000
*                                                                       00370000
*********************************************************************** 00380000
                                                                        00390000
         EQUS  ,                  GENERAL EQUATES                       00400000
                                                                        00410000
RICVT    EQU   R11                                                      00420000
RITASK   EQU   R10                                                      00430000
RIVTAM   EQU   R9                                                       00440000
RISESS   EQU   R8                                                       00450000
RIACB    EQU   R7                                                       00460000
                                                                        00470000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00480000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00490000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00500000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00510000
         USING IACB,RIACB         ESTABLISH ADDRESSABILITY              00520000
         USING ISTDBIND,ISEBIND   ESTABLISH ADDRESSABILITY              00530000
                                                                        00540000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00550000
$TASKMFL $TASK MF=L               $TASK PLIST CONSTRUCTION              00560000
$PROCMFL $PROC MF=L               $PROC PLIST CONSTRUCTION              00570000
DWORK    DS    D                  DOUBLEWORD                            00580000
WRK256   DS    XL256              GENERAL WORKAREA                      00590000
DRVRPROC DS    CL8                DRIVER PROC NAME                      00600000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00610000
RETR15   DS    F                                                        00620000
RETR0    DS    F                                                        00630000
RETR1    DS    F                                                        00640000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00650000
FLAG     DS    X                                                        00660000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00670000
                                                                        00680000
         $MSGDFT PREFIX=ICTPID,                                        +00690000
               COMPID='VTM',                                           +00700000
               TABLE=*#MSGS,                                           +00710000
               WORKA=0,                                                +00720000
               MF=(E,WRK256),                                          +00730000
               PRINT=NOGEN                                              00740000
                                                                        00750000
IVTMSDST #ENTER BASE=R12,         ENTRY LINKAGE                        +00760000
               AMODE=31,                                               +00770000
               RMODE=ANY                                                00780000
                                                                        00790000
*---------------------------------------------------------------------- 00800000
* START THE APPROPRIATE SESSION DRIVER PROCESS                          00810000
*---------------------------------------------------------------------- 00820000
                                                                        00830000
*                                                                       00840000
* IF THIS IS A SECONDARY BIND THE DRIVER IS ALREADY ACTIVE              00850000
*---------------------------------------------------------------------- 00860000
                                                                        00870000
         TM    ISEF1,ISEF1DRV     IS THERE A DRIVER?                    00880000
         BO    RETURN             BRANCH IF YES, ALL DONE               00890000
                                                                        00900000
*                                                                       00910000
* ALLOCATE STORAGE FOR A TOKEN COPY                                     00920000
*---------------------------------------------------------------------- 00930000
                                                                        00940000
         $GETSTOR L'ISETK+1,      GET TOKEN STORAGE                    +00950000
               LOC=ANY,                                                +00960000
               OWNER=(RITASK)                                           00970000
                                                                        00980000
         LR    R4,R1              SAVE TOKEN STORAGE ADDRESS            00990000
         MVI   0(R4),L'ISETK      SET TOKEN LENGTH                      01000000
         MVC   1(L'ISETK,R4),ISETK CREATE TOKEN COPY FOR DRIVER         01010000
                                                                        01020000
*                                                                       01030000
* CREATE A NEW PROCESS FOR THE SESSION DRIVER                           01040000
*---------------------------------------------------------------------- 01050000
                                                                        01060000
         $TASK SETEPB,            INITIALIZE TASK TERMINATION EPB      +01070000
               EPB=ISEDTEPB,                                           +01080000
               ECODE=EC$VTDT,     DRIVER TERMINATION IS THE CODE       +01090000
               ERRET=ERR$TASK,    ABEND IF SERVICE FAILURE             +01100000
               MF=(E,$TASKMFL)                                          01110000
                                                                        01120000
         TM    ISEF1,ISEF1LGN          IS THIS THE "LOGON" SESSION?     01130000
         BNO   PROCDEP                 BRANCH IF NOT                    01140000
         MVC   DRVRPROC,=CL8'$PLUMAIN' ASSUME PLU SESS                  01150000
         TM    ISEF2,ISEF2SLU          ARE WE THE SLU                   01160000
         BNO   DRPROCOK                BRANCH IF NOT                    01170000
         MVC   DRVRPROC,=CL8'$SLUMAIN' SET NAME FOR SLU "LOGON" SESSION 01180000
         B     DRPROCOK                START THE PROC                   01190000
                                                                        01200000
PROCDEP  DS    0H                                                       01210000
                                                                        01220000
         L     R1,ISETKSES             SESSION WORD OF ISESS TOKEN      01230000
         CVD   R1,DWORK                MAKE IT PACKED                   01240000
         OI    DWORK+7,X'0F'           NICE SIGN FOR UNPACKING          01250000
         UNPK  DRVRPROC+1(7),DWORK+4(4) GET A NICE ZONED DECIMAL INT.   01260000
         MVI   DRVRPROC,C'P'           ASSUME PLU SESS                  01270000
         TM    ISEF2,ISEF2SLU          ARE WE THE SLU                   01280000
         BNO   DRPROCOK                BRANCH IF NOT                    01290000
         MVI   DRVRPROC,C'S'           SET NAME FOR SLU SESSION         01300000
         B     DRPROCOK                START THE PROC                   01310000
                                                                        01320000
DRPROCOK DS    0H                                                       01330000
                                                                        01340000
         $PROC CREATE,            CREATE THE DRIVER PROCESS            +01350000
               EP=*ISEDRVEP,      PROC ENTRY FOR DRIVER PROCESS        +01360000
               NAME=DRVRPROC,     PROC NAME IS '$PLUMAIN'              +01370000
               PARM=(R4),         PASS SESSION TOKEN ADDRESS AS PARM   +01380000
               STGSIZE=*SIZE2048, INCREASE THE MAX SIZE OF STG POOL    +01390000
               TERMEPB=ISEDTEPB,  POST THIS EPB WHEN PROCESS IS GONE   +01400000
               MF=(E,$PROCMFL)                                          01410000
                                                                        01420000
         LTR   R15,R15                                                  01430000
         BNZ   ERR$PROC           BRANCH IF SERVICE ERROR               01440000
         ST    R1,ISEDIPCB        SAVE THE DRIVER IPCB ADDRESS          01450000
         OI    ISEF1,ISEF1DRV     FLAG THAT DRIVER IS ACTIVE            01460000
                                                                        01470000
*                                                                       01480000
* TRACE THE DRIVER START UP                                             01490000
*---------------------------------------------------------------------- 01500000
                                                                        01510000
         $TRACE *=A(TRC_DRIVER_START),32 TRACE ENTRY W/32 USER BYTES    01520000
                                                                        01530000
         BNZ   NODTRACE           BRANCH IF TRACING NOT AVAILABLE       01540000
                                                                        01550000
         ST    RITASK,0(,R1)      TRACE ITASK                           01560000
         MVC   4(4,R1),ISECID     TRACE THE SESSION CID                 01570000
         MVC   8(8,R1),ISETK      TRACE THE SESSION TOKEN               01580000
         MVC   16(4,R1),ISEDIPCB  TRACE IPCB ADDRESS OF DRIVER PROC     01590000
         ST    R3,20(,R1)         TRACE DRIVER ENTRY POINT ADDRESS      01600000
                                                                        01610000
NODTRACE DS    0H                                                       01620000
                                                                        01630000
         B     RETURN                                                   01640000
                                                                        01650000
*---------------------------------------------------------------------- 01660000
* RETURN TO CALLER                                                      01670000
*---------------------------------------------------------------------- 01680000
                                                                        01690000
RETURN   DS    0H                                                       01700000
                                                                        01710000
         LM    R15,R1,RETREGS     LOAD RETURN VALUES                    01720000
                                                                        01730000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    01740000
                                                                        01750000
*---------------------------------------------------------------------- 01760000
* ERROR ROUTINES                                                        01770000
*---------------------------------------------------------------------- 01780000
                                                                        01790000
ERR$PROC DS    0H                                                       01800000
                                                                        01810000
         $ABEND ABE_VTDIAG,                                            +01820000
               SCOPE=PCB,                                              +01830000
               TITLE='$PROC FAILURE'                                    01840000
                                                                        01850000
ERR$TASK DS    0H                                                       01860000
                                                                        01870000
         $ABEND ABE_VTDIAG,                                            +01880000
               SCOPE=PCB,                                              +01890000
               TITLE='$TASK FAILURE'                                    01900000
                                                                        01910000
*---------------------------------------------------------------------- 01920000
*  CONSTANTS AND LITERALS                                               01930000
*---------------------------------------------------------------------- 01940000
                                                                        01950000
SIZE2048 DC    F'2048'                                                  01960000
SIZE4096 DC    F'4096'                                                  01970000
                                                                        01980000
         LTORG ,                                                        01990000
         PRINT NOGEN                                                    02000000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                02010000
         ISTDBIND ,               VTAM BIND IMAGE                       02020000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         02030000
         ICVT  ,                  INTEGRATOR CVT                        02040000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   02050000
         IRPL ,                   INTEGRATOR VTAM RPL+                  02060000
         IACB ,                   INTEGRATOR VTAM ACB+                  02070000
         INIB ,                   INTEGRATOR VTAM NIB+                  02080000
         ISESS ,                  INTEGRATOR SESSION BLOCK              02090000
         ISQE ,                   INTEGRATOR SESS INIT QUEUE ELEMENT    02100000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            02110000
         ITASK ,                  INTEGRATOR TASK BLOCK                 02120000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          02130000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       02140000
         EVCODES ,                INTEGRATOR EVENT CODES                02150000
         ABCODES ,                INTEGRATOR $ABEND CODES               02160000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     02170000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        02180000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             02190000
         $PROC DSECT=YES          INTEGRATOR $PROC SERVICES             02200000
         END   ,                                                        02210000

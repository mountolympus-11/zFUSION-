IRECX    TITLE '- RECORDING START AND STOP RU PROCESSORS'               00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: IRECX - Recording START and STOP RU processors               00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine is scheduled to process recording start and           00080000
*    stop request units arriving from the remote process. All           00090000
*    recording functions are performed by the SLU session               00100000
*    driver, requiring interprocess communication between these         00110000
*    two processes, as described below.                                 00120000
*                                                                       00130000
*                                                                       00140000
* METHOD:                                                               00150000
*                                                                       00160000
*    IRECX PROC:                                                        00170000
*        let SLU session key = XPORT handle ;                           00180000
*        locate SLUHANDL using SLU driver key ($ENTITY) ;               00190000
*        if session not found                                           00200000
*             return( RC12, "SESSION NOT FOUND") ;                      00210000
*                                                                       00220000
*        $TSEND request to SLU driver ($TSEND REPLY=YES) ;              00230000
*        await response ($TASK WAIT) ;                                  00240000
*        if request-in-error                                            00250000
*             return( RC08, <LOCALLY GENERATED ERROR MESSAGE>) ;        00260000
*        else                                                           00270000
*             return( RC00, - ) ;                                       00280000
*    PROC END ;                                                         00290000
*                                                                       00300000
*                                                                       00310000
* NOTES:                                                                00320000
*                                                                       00330000
*    The acquisition of the TXP buffer is deferred until after          00340000
*    the remote request completes. This allows us to inspect the        00350000
*    size of the message buffer to better determine the size            00360000
*    of the TXP buffer needed.                                          00370000
*                                                                       00380000
*                                                                       00390000
* ON ENTRY:                                                             00400000
*                                                                       00410000
*    R1 contains the address of a recording function request            00420000
*       list in transaction format.  The following subfunctions         00430000
*       and their respective plists are listed below:                   00440000
*                                                                       00450000
*          START recording - XRECSTRT                                   00460000
*          STOP  recording - XRECSTOP                                   00470000
*                                                                       00480000
*                                                                       00490000
* ON EXIT:                                                              00500000
*                                                                       00510000
*    A response buffer described by YSMSREC is constructed,             00520000
*    tansmitted, and released.  The return and reason codes             00530000
*    provided by the recording service are reflected to the             00540000
*    remote process as a reason and info code, respectively.            00550000
*    The request completion (return) code is assigned as                00560000
*    follows:                                                           00570000
*                                                                       00580000
*       RC00 - function completed without error                         00590000
*                                                                       00600000
*       RC08 - non-zero return code presented by the SLU driver.        00610000
*              YRERSNC and YREINFO contain the recording service        00620000
*              return and reason codes.                                 00630000
*                                                                       00640000
*       RC12 - the SLU driver associated with the remote                00650000
*              process could not be located and is assumed to           00660000
*              have prematurely terminated.                             00670000
*                                                                       00680000
**<DOC-OFF>****************************************************         00690000
                                                                        00700000
         EJECT                                                          00710000
***************************************************************         00720000
*                                                                       00730000
* MAINTENANCE:                                                          00740000
*                                                                       00750000
*    02/01/95 T. WELTZER - PAR# 167121                                  00760000
*             ABEND0C4 IN IMSGMAKE, INVALID MSGID PASSED FROM           00770000
*             ACQRESP IN THIS ROUTINE                                   00780000
*                                                                       00790000
*    03/30/95 R. Turgeon                                                00800000
*             Disallow recording names begining with "SYS" to           00810000
*             prevent conflicts between temporary table and             00820000
*             catalog table names.                                      00830000
*                                                                       00840000
*    12/14/95 R. Turgeon                                                00850000
*             Use WUTOKEN= format of $TSEND to SLU driver               00860000
*                                                                       00870000
***************************************************************         00880000
                                                                        00890000
         EJECT                                                          00900000
         XRECSTRT ,               START RECORDING RU                    00910000
                                                                        00920000
         EJECT                                                          00930000
         XRECSTOP ,               STOP RECORDING RU                     00940000
                                                                        00950000
         EJECT                                                          00960000
         @XH ,                    TRANSACTION PLIST COMMON HEADER       00970000
                                                                        00980000
         EJECT                                                          00990000
         SLUHANDL ,               VDEVICE HANDLE TO APPL SESSION        01000000
                                                                        01010000
         EJECT                                                          01020000
         $TSEND DSECT=YES         CROSS WU MESSAGING PLIST              01030000
                                                                        01040000
         EJECT                                                          01050000
         $ENTITY DSECT=YES        CROSS WU MESSAGING PLIST              01060000
                                                                        01070000
         EJECT                                                          01080000
         $TASK DSECT=YES          $TASK SERVICES                        01090000
                                                                        01100000
         EJECT                                                          01110000
         ABCODES PRINT=NOGEN                                            01120000
                                                                        01130000
         MSGCODES ,                                                     01140000
                                                                        01150000
         EQUS  ,                                                        01160000
                                                                        01170000
         $MSGDFT PREFIX=ICTPID,COMPID='REC',TABLE=*#MSGS,              X01180000
               CONID=*ICTCONID,CONNAME=ICTCONNM,                       X01190000
               PRINT=NOGEN,MF=(E,$MSGMFL)                               01200000
                                                                        01210000
         EJECT                                                          01220000
         #WORK ,                                                        01230000
                                                                        01240000
EXTRAREA DS    4F                 $ENTITY EXTR USERDATA RETURN AREA     01250000
                                                                        01260000
RETC     DS    F                  RETURN CODE                           01270000
RSNC     DS    F                  REASON CODE                           01280000
INFOC    DS    F                  INFO CODE                             01290000
                                                                        01300000
@RUMSGS  DS    A                  PORTABLE, RU-FORMAT MSG AREA          01310000
                                                                        01320000
@MSGBUF  DS    XL256              $MSGBUF CONSTRUCTION AREA             01330000
XPSESH   DS    XL(L'@XHSESH)      SLU SESSION XPORT HANDLE              01340000
                                                                        01350000
$TASKMFL $TASK MF=(L,*)           $TASK PLIST CONSTRUCTION              01360000
$MSGMFL  $MSG  FIELDS=(,,,,,),MF=(L,*)                                  01370000
                                                                        01380000
         EJECT                                                          01390000
         YSMSREC TYPE=BLOCK       RECORDING RU RESPONSE BLOCK           01400000
                                                                        01410000
         #ENDWORK ,                                                     01420000
                                                                        01430000
         EJECT                                                          01440000
IRECX    #ENTER PREG=R8                                                 01450000
                                                                        01460000
         USING ITASK,R10          STDENV                                01470000
                                                                        01480000
         L     R9,TSKPCBC         PROCESS MODE                          01490000
         USING IPCB,R9                                                  01500000
                                                                        01510000
         EJECT                                                          01520000
***************************************************************         01530000
*                                                                       01540000
*   Locate the session manager process                                  01550000
*                                                                       01560000
***************************************************************         01570000
                                                                        01580000
         USING @XH,R8             RECORDING REQUESTS                    01590000
XS       USING XRECSTRT,R8        START RECORDING                       01600000
XP       USING XRECSTOP,R8        STOP  RECORDING                       01610000
                                                                        01620000
*--------------------------------------------------------------         01630000
*   Format local copy of XPORT session handle for SLU session           01640000
*--------------------------------------------------------------         01650000
                                                                        01660000
         MVC   XPSESH,@XHSESH     COPY XPORT REQUEST SESSION HNDL       01670000
                                                                        01680000
         SR    R1,R1              PREPARE FOR INSERT                    01690000
         CLC   @XHSFNC,=A(XRSSTART) RECORD START REQUEST?               01700000
         BNE   RSTOP              NO, MUST BE RECORD STOP               01710000
         ICM   R1,1,XS.XRSLSESS   RETRIEVE RECSTART LSESSID             01720000
         B     SETLSESS           SET LSESSID OF SLU SESSION            01730000
                                                                        01740000
RSTOP    DS    0H                                                       01750000
         ICM   R1,1,XP.XRPLSESS   RETRIEVE RECSTOP LSESSID              01760000
                                                                        01770000
SETLSESS DS    0H                                                       01780000
         BZ    *+8                NONE PROVIDED, USE REQ HNDL           01790000
         STC   R1,XPSESH+1        SET LSESSID IN SLU XPORT HNDL         01800000
                                                                        01810000
*--------------------------------------------------------------         01820000
*   Locate session manager process by XPORT handle                      01830000
*--------------------------------------------------------------         01840000
                                                                        01850000
         L     R6,PCBUSER         LOCATE USER IDENTIFICATION            01860000
         USING IUSER,R6                                                 01870000
                                                                        01880000
         $ENTITY EXTR,                                                 X01890000
               ENTITY=(XPSESH,L'XPSESH),                               X01900000
               USERDATA=EXTRAREA,                                      X01910000
               ANCHOR=USRSESS,                                         X01920000
               MF=(E,MFE_LIST)                                          01930000
                                                                        01940000
         CH    R15,=AL2(RC04)     NORMAL COMPLETION CODES               01950000
         BL    GOTHANDL              SESSION HANDLE LOCATED             01960000
         BE    ERR_WU                ERROR - NO SUCH WORKUNIT           01970000
         EX    R0,*                  ASSERT 'PROPERLY FORMULATED REQ'   01980000
         DROP  R6                 IUSER                                 01990000
                                                                        02000000
*--------------------------------------------------------------         02010000
*   Validate appl session handle, extract managing PCB addr             02020000
*--------------------------------------------------------------         02030000
                                                                        02040000
GOTHANDL DS    0H                                                       02050000
         L     R5,EXTRAREA        ACQUIRE SLU SESSION HANDLE            02060000
         USING SLUHANDL,R5        PRINCIPLE LINKAGE / CONTROL ANCHORS   02070000
                                                                        02080000
         CLC   SLHID,=C'SLUHANDL' ASSERT VALID DATA                     02090000
         BE    *+8                CONTINUE                              02100000
         EX    R0,*               ASSERTION DENIED                      02110000
                                                                        02120000
         EJECT                                                          02130000
***************************************************************         02140000
*                                                                       02150000
*   Pass request thru to SLU session driver and await response          02160000
*                                                                       02170000
***************************************************************         02180000
                                                                        02190000
         LA    R2,ITM_SLU_RECSTART                                      02200000
         CLC   @XHSFNC,=A(XRSSTART)                                     02210000
         BE    *+8                                                      02220000
         LA    R2,ITM_SLU_RECSTOP                                       02230000
                                                                        02240000
         $TSEND WUTOKEN=SLHSDTKN, SEND TO SESSION DRIVER               X02250000
               TYPE=(R2),         IDENTIFY SESSION RECORDING FUNCTION  X02260000
               INFO=(@XH,*@XHPLEN), PLIST IN RU FORMAT                 X02270000
               REPLY=YES,         RSVP                                 X02280000
               MF=(E,MFE_LIST)                                          02290000
                                                                        02300000
         CH    R15,=AL2(RC04)     EVALUATE COMPLETION STATUS            02310000
         BL    SENDREQ            TARGET WORKUNIT LOCATED               02320000
         BE    ERR_WU             WORKUNIT NOT FOUND                    02330000
         EX    R0,*               ASSERT 'PROPERLY FORMULATED REQUEST'  02340000
         DROP  R5                 SLUHANDL                              02350000
                                                                        02360000
*--------------------------------------------------------------         02370000
*   Await SLU driver response                                           02380000
*--------------------------------------------------------------         02390000
                                                                        02400000
SENDREQ  DS    0H                                                       02410000
         LR    R3,R1              EPB CREATED BY REPLY=YES              02420000
                                                                        02430000
         $TASK WAIT,              AWAIT RESPONSE FROM SESSION MGR      X02440000
               EPB=(R3),                                               X02450000
               EVENT=ACQRESP,                                          X02460000
               MF=(E,$TASKMFL)                                          02470000
                                                                        02480000
         EJECT                                                          02490000
***************************************************************         02500000
*                                                                       02510000
*   Analyze completion status, construct error msgs if needed           02520000
*                                                                       02530000
***************************************************************         02540000
                                                                        02550000
ACQRESP  DS    0H                                                       02560000
         STCM  R0,B'0011',RSNC+2  SERVICE RETCODE IS OUR RSNCODE        02570000
         STCM  R0,B'1100',INFOC+2 SERVICE RETCODE IS OUR RSNCODE        02580000
                                                                        02590000
         ICM   R4,15,RSNC         NORMAL COMPLETION?                    02600000
         BZ    PREPRESP           NO MESSAGE REQUIREMENTS IF SO         02610000
         LA    R15,RC08           GENERIC FAILURE RETURN CODE           02620000
         ST    R15,RETC           RETAIN ERROR COMPLETION               02630000
                                                                        02640000
         LA    R2,RC_START        REC START FAILURE ?                   02650000
         CLC   @XHSFNC,=A(XRSSTART)                                     02660000
         BE    *+8                YES, AS ASSUMED                       02670000
         LA    R2,RC_STOP         NO, REC STOP FAILURE                  02680000
                                                                        02690000
         LTR   R4,R4              ANTICIPATED FAILURE ?         167121  02700000
         BNP   GEN_MSG            NO, USE GENERIC MSG           167121  02710000
         C     R4,=A(RC24)                                      167121  02720000
         BH    GEN_MSG            NO, USE GENERIC MSG           167121  02730000
                                                                        02740000
         L     R1,0(R4,R2)        FETCH APPLICABLE MESSAGE CODE         02750000
         LTR   R1,R1              MESSAGE NUMBER ASSIGNED?              02760000
         BNZ   *+8                SKIP IF SO                            02770000
                                                                        02780000
GEN_MSG  DS    0H                                               167121  02790000
         L     R1,0(,R2)          ELSE USE GENERIC MSG                  02800000
         B     SETMSG             ACQUIRE MESSAGE AND CONTINUE          02810000
                                                                        02820000
*--------------------------------------------------------------         02830000
*   SLU driver not available, etc.                                      02840000
*--------------------------------------------------------------         02850000
                                                                        02860000
ERR_WU   DS    0H                                                       02870000
         LA    R15,RC12           REQUEST COULD NOT BE DELIVERED        02880000
         ST    R15,RETC           RETAIN ERROR COMPLETION               02890000
         LA    R1,002             UNEXPECTED SLU TERM (DISAPPEARANCE)   02900000
                                                                        02910000
*--------------------------------------------------------------         02920000
*   Construct error / termination message                               02930000
*--------------------------------------------------------------         02940000
                                                                        02950000
SETMSG   DS    0H                 R1 <== MESSAGE NUMBER                 02960000
         LR    R3,R1              ACCEPT MESSAGE NUMBER                 02970000
                                                                        02980000
         $MSG  (R3),              ACQUIRE FORMATTED MSG                X02990000
               BUFR=@MSGBUF,                                           X03000000
               BUFL=L'@MSGBUF,                                         X03010000
               DEST=$BUFFER,                                           X03020000
               MSGID=NO,                                               X03030000
               FIELDS=(RETC,RSNC,INFOC)                                 03040000
                                                                        03050000
         EJECT                                                          03060000
***************************************************************         03070000
*                                                                       03080000
*   Construct and send request response.  Any messages posted           03090000
*   reside in @MSGBUF.  The amount of that buffer used is               03100000
*   assurred to exceed the amount of space needed to contain            03110000
*   the same messages in the request response block.                    03120000
*                                                                       03130000
***************************************************************         03140000
                                                                        03150000
PREPRESP DS    0H                                                       03160000
         LA    R1,@MSGBUF         MESSAGE BUFFER, POSSIBLY EMPTY        03170000
         L     R2,$MSBUSED-$MSGBUF(,R1)   MAX SIZE OF ALL MSGS          03180000
         LA    R2,YSMSRECL(,R2)   LENGTH OF RESPONSE AREA REQUIRED      03190000
                                                                        03200000
         $XPBUFR INIT,SIZE=(R2),XH=@XH                                  03210000
                                                                        03220000
         BNZ   ABE_TXP                                                  03230000
                                                                        03240000
*--------------------------------------------------------------         03250000
*   Insert fixed portion of response block                              03260000
*--------------------------------------------------------------         03270000
                                                                        03280000
         $XPBUFR ISRT,DATALEN=YSMSRECL                                  03290000
                                                                        03300000
         BNZ   ABE_TXP                                                  03310000
                                                                        03320000
         LR    R5,R1              RESPONSE BLOCK ADDR                   03330000
         USING YSMSREC,R5         LIFE OF FUNCTION ADDRESSABILITY       03340000
         XC    YSMSREC(YSMSRECL),YSMSREC                                03350000
                                                                        03360000
*--------------------------------------------------------------         03370000
*   Format the response block with completion status and msgs           03380000
*--------------------------------------------------------------         03390000
                                                                        03400000
         MVC   YRERETC,RETC       RETURN CODE                           03410000
         MVC   YRERSNC,RSNC       REASON CODE                           03420000
         MVC   YREINFO,INFOC      INFO CODE                             03430000
                                                                        03440000
         LA    R6,@MSGBUF         LOCAL MESSAGE BUFFER                  03450000
         USING $MSGBUF,R6                                               03460000
         ICM   R4,15,$MSGQF       LOCATE FIRST MESSAGE                  03470000
         BZ    MSG_FIN            END OF MESSAGES                       03480000
         USING $MSBHDR,R4         ADDRESS MSG INSTANCES                 03490000
                                                                        03500000
MSGFNXT  DS    0H                                                       03510000
         LH    R2,$MSBLEN         MESSAGE TEXT LENGTH                   03520000
         STH   R2,$MSBRSVD        PREPEND TO MESSAGE TEXT               03530000
                                                                        03540000
         $XPBUFR ISRT,DATALEN=2(R2),DATA=$MSBRSVD                       03550000
                                                                        03560000
         BNZ   MSG_FIN            ASSUME FAILURES ARE CAPACITY RELATED  03570000
                                                                        03580000
         LH    R15,YREMSGC        MESSAGE COUNT                         03590000
         LA    R15,1(,R15)        ACCOUNT FOR THIS MESSAGE              03600000
         STH   R15,YREMSGC        SAVE UPDATED COUNT                    03610000
                                                                        03620000
         ICM   R4,15,$MSBLINK     MESSAGES REMAIN?                      03630000
         BNZ   MSGFNXT            AGAIN IF SO                           03640000
         DROP  R4,R5,R6           $MSBHDR, YSMSREC, $MSGBUF             03650000
                                                                        03660000
MSG_FIN  DS    0H                                                       03670000
                                                                        03680000
*--------------------------------------------------------------         03690000
*   Send response block to requestor                                    03700000
*--------------------------------------------------------------         03710000
                                                                        03720000
         $XPBUFR XMIT             TRANSMIT AND FREE                     03730000
                                                                        03740000
         BNZ   ABE_TXP                                                  03750000
                                                                        03760000
         EJECT                                                          03770000
***************************************************************         03780000
*                                                                       03790000
*   Cleanup -  return to request scheduler                              03800000
*                                                                       03810000
***************************************************************         03820000
                                                                        03830000
RETURN   DS    0H                                                       03840000
         L     R15,RETC           REFLECT COMPLETION STATUS             03850000
         L     R0,RSNC            REASON CODE                           03860000
                                                                        03870000
         #EXIT ,                                                        03880000
                                                                        03890000
         EJECT                                                          03900000
***************************************************************         03910000
*                                                                       03920000
*   Catastropic errors                                                  03930000
*                                                                       03940000
***************************************************************         03950000
                                                                        03960000
ABE_TXP  DS    0H                                                       03970000
         $ABEND ABE_TXPSERV,DUMP=YES,                                  X03980000
               TITLE='TXP buffer service failure'                       03990000
                                                                        04000000
         EJECT                                                          04010000
***************************************************************         04020000
*                                                                       04030000
*   Local read only data areas, etc.                                    04040000
*                                                                       04050000
***************************************************************         04060000
                                                                        04070000
RC_START DS    0F                                                       04080000
         DC    A(001)   GENERIC   GENERIC FAILURE: RC, RSN, INFO        04090000
         DC    A(003)     RC04    NAMED RECORDING ALREADY EXISTS        04100000
         DC    A(004)     RC08    RECORDING IS ALREADY ACTIVE           04110000
         DC    A(007)     RC12    INVALID RECORDING NAME                04120000
         DC    A(*-*)     RC16                                          04130000
         DC    A(*-*)     RC20                                          04140000
         DC    A(*-*)     RC24                                          04150000
                                                                        04160000
RC_STOP  DS    0F                                                       04170000
         DC    A(001)   GENERIC   GENERIC FAILURE: RC, RSN, INFO        04180000
         DC    A(005)     RC04    EMPTY RECORDING WAS DISCARDED         04190000
         DC    A(006)     RC08    RECORDING NOT ACTIVE                  04200000
         DC    A(*-*)     RC12                                          04210000
         DC    A(*-*)     RC16                                          04220000
         DC    A(*-*)     RC20                                          04230000
         DC    A(*-*)     RC24                                          04240000
                                                                        04250000
*--------------------------------------------------------------         04260000
                                                                        04270000
         LTORG ,                                                        04280000
                                                                        04290000
         EJECT                                                          04300000
         PRINT NOGEN                                                    04310000
         ICVT  ,                                                        04320000
         ITASK ,                                                        04330000
         IPCB  ,                                                        04340000
         IUSER ,                                                        04350000
         END   ,                                                        04360000

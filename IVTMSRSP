IVTMSRSP TITLE 'INTEGRATOR - ISESS RESP PROCESSOR'                      00010000
**<DOC-ON>************************************************************* 00020000
*                                                                       00030000
* ROUTINE: IVTMSRSP - ISESS RESP PROCESSOR                              00040000
*                                                                       00050000
* DESCRIPTION: THIS ROUTINE IS CALLED BY IVTMSESS TO PROCESS THE        00060000
*              RESP WORK ELEMENT.                                       00070000
*                                                                       00080000
* ON ENTRY:                                                             00090000
*                                                                       00100000
*    R15 = ENTRY POINT ADDRESS                                          00110000
*    R14 = RETURN ADDRESS                                               00120000
*    R13 = AVAILABLE SAVE AREA                                          00130000
*    R11 = ICVT ADDRESS                                                 00140000
*    R10 = ITASK ADDRESS                                                00150000
*    R09 = IVTAMCVT ADDRESS                                             00160000
*    R08 = ISESS ADDRESS                                                00170000
*    R01 = ADDRESS OF RESP WORK ELEMENT (IWEX6)                         00180000
*                                                                       00190000
* ON EXIT:                                                              00200000
*                                                                       00210000
*    R15 = 0                                                            00220000
*    R00 = 0                                                            00230000
*    R01 = 0                                                            00240000
*                                                                       00250000
*    ALL OTHER REGISTERS ARE RESTORED.                                  00260000
*                                                                       00270000
**<DOC-OFF>************************************************************ 00280000
                                                                        00290000
         EJECT ,                                                        00300000
*********************************************************************** 00310000
*                                                                       00320000
* MAINTENANCE:                                                          00330000
*                                                                       00340000
*   08/01/93 RANDY WITEK                                                00350000
*   07/01/94 RANDY WITEK - LU6.2 SUPPORT                                00360000
*                                                                       00370000
*********************************************************************** 00380000
                                                                        00390000
         EQUS  ,                  GENERAL EQUATES                       00400000
                                                                        00410000
RICVT    EQU   R11                                                      00420000
RITASK   EQU   R10                                                      00430000
RIVTAM   EQU   R9                                                       00440000
RISESS   EQU   R8                                                       00450000
RIACB    EQU   R7                                                       00460000
RIRPL    EQU   R6                                                       00470000
RIWE     EQU   R5                                                       00480000
RSPLIST  EQU   R5                                                       00490000
RIRQE    EQU   R4                                                       00500000
                                                                        00510000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00520000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00530000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00540000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00550000
         USING IACB,RIACB         ESTABLISH ADDRESSABILITY              00560000
         USING IRPL,RIRPL         ESTABLISH ADDRESSABILITY              00570000
         USING IWEVTAM,RIWE       ESTABLISH ADDRESSABILITY              00580000
         USING ISTDBIND,ISEBIND   ESTABLISH ADDRESSABILITY              00590000
         USING IRQE,RIRQE         ESTABLISH ADDRESSABILITY              00600000
                                                                        00610000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00620000
WRK256   DS    XL256              GENERAL WORKAREA                      00630000
RETR15   DS    F                                                        00640000
RETR0    DS    F                                                        00650000
RETR1    DS    F                                                        00660000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00670000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00680000
                                                                        00690000
         $MSGDFT PREFIX=ICTPID,                                        +00700000
               COMPID='VTM',                                           +00710000
               TABLE=*#MSGS,                                           +00720000
               WORKA=0,                                                +00730000
               MF=(E,WRK256),                                          +00740000
               PRINT=NOGEN                                              00750000
                                                                        00760000
IVTMSRSP #ENTER BASE=R12,         ENTRY LINKAGE                        +00770000
               PREG=RIWE,                                              +00780000
               AMODE=31,                                               +00790000
               RMODE=ANY                                                00800000
                                                                        00810000
         L     RIACB,IWEX6ACB       ASSOCIATED ACB                      00820000
         LA    RIRPL,IWEX6RPL       ADDRESS OF READ-ONLY RPL COPY       00830000
                                                                        00840000
*---------------------------------------------------------------------- 00850000
* VERIFY THE SESSION CID, IGNORE THE WORK ELEMENT IF NO MATCH           00860000
*---------------------------------------------------------------------- 00870000
                                                                        00880000
         CLC   ISECID,IWEX6CID      CID MATCH?                          00890000
         BNE   RETURN               BRANCH IF NOT                       00900000
                                                                        00910000
*---------------------------------------------------------------------- 00920000
* IF THE RESPONSE SATISFIES A PENDING SEND, POST THE $SESS_SEND_???     00930000
*---------------------------------------------------------------------- 00940000
                                                                        00950000
         DROP  RIWE                                                     00960000
         USING SPLIST,RSPLIST       ESTABLISH ADDRESSABILITY            00970000
                                                                        00980000
         ICM   RSPLIST,15,ISERQSND  IS THERE A PENDING SEND?            00990000
         BZ    NOPNDSND             BRANCH IF NOT                       01000000
         CLC   SPLSEQNO(2),RPLSEQNO IS RESPONSE FOR THE PENDING SEND    01010000
         BE    PENDSEND             BRANCH IF YES                       01020000
                                                                        01030000
*                                                                       01040000
* REMEMBER THAT AN "EARLY RESPONSE" WAS RECEIVED                        01050000
*---------------------------------------------------------------------- 01060000
                                                                        01070000
         MVC   ISEERSEQ(2),RPLSEQNO SET "EARLY RESPONSE" SEQ NUMBER     01080000
         MVC   ISEERFBK(4),RPLFDBK2 SET "EARLY RESPONSE" SENSE          01090000
         MVC   ISEERRTN(1),RPLRTNCD SET "EARLY RESPONSE" RETURN CODE    01100000
         MVC   ISEERFD2(1),RPLFDB2  SET "EARLY RESPONSE" REASON CODE    01110000
         MVC   ISEERRH(3),RPLURH    SET "EARLY RESPONSE" RH             01120000
         OI    ISEF4,ISEF4ERS       SHOW "EARLY RESPONSE" RECEIVED      01130000
         B     RETURN               AND LET SEND POST=SCHED HANDLE IT   01140000
                                                                        01150000
*                                                                       01160000
* UPDATE STATE INFO AND POST THE PENDING $SESS_SEND_??? REQUEST         01170000
*---------------------------------------------------------------------- 01180000
                                                                        01190000
PENDSEND DS    0H                                                       01200000
                                                                        01210000
         MVC   SPLRRH(3),RPLURH         COPY RESPONSE RH                01220000
         MVC   SPLSENSE(4),RPLFDBK2     COPY ANY SENSE INFORMATION      01230000
         MVC   SPLRSNCD+2(1),RPLRTNCD   RETURN CODE                     01240000
         MVC   SPLRSNCD+3(1),RPLFDB2    REASON CODE                     01250000
         OC    SPLRSNCD,SPLRSNCD        NON-ZERO VTAM COMPLETION CODES? 01260000
         BZ    SENDGOOD                 BRANCH IF NON-ZERO              01270000
         MVC   SPLRETCD,=A($SESS_RC_VTAMRC)                             01280000
                                                                        01290000
SENDGOOD DS    0H                                                       01300000
                                                                        01310000
         LR    R1,RSPLIST         PASS SPLIST ADDRESS IN R1             01320000
         LR    R0,RISESS          PASS ISESS  ADDRESS IN R0             01330000
         L     R15,IVT@SSFP       SEND COMPLETION PROTOCOL MGMT         01340000
         BASR  R14,R15            LINK TO UPDATE STATES                 01350000
                                                                        01360000
         MVC   SPLSTATE,ISESTATE  SET SESSION STATE WORD                01370000
         XC    ISERQSND,ISERQSND  DEQUEUE THE ACTIVE SEND REQUEST       01380000
         LR    R1,RSPLIST         PASS SPLIST ADDRESS IN R1             01390000
         L     R15,IVT@SPST       SPLIST  TRACE/POST ROUTINE            01400000
         BASR  R14,R15            LINK TO TRACE/POST ROUTINE            01410000
         B     RETURN             AND RETURN TO PROCESS MORE WORK       01420000
                                                                        01430000
*---------------------------------------------------------------------- 01440000
* IF IT IS NOT A NEGATIVE RESPONSE, JUST IGNORE IT                      01450000
*---------------------------------------------------------------------- 01460000
                                                                        01470000
NOPNDSND DS    0H                                                       01480000
                                                                        01490000
         TM    RPLURH+1,RHERI       EXCEPTION RESPONSE ?                01500000
         BNO   RETURN               BRANCH IF NOT                       01510000
                                                                        01520000
         CLC   BINLUP(2),=X'0602'   LU6.2?                              01530000
         BNE   PROCNRSP             BRANCH IF NOT                       01540000
         CLC   ISE62CBS,RPLSEQNO    IS RESPONSE FOR CURRENT BRACKET?    01550000
         BNE   RETURN               BRANCH IF NOT, IGNORE IT            01560000
                                                                        01570000
*---------------------------------------------------------------------- 01580000
* ISSUE GENERAL INFORMATION MESSAGE IF NEGATIVE RESPONSE RECEIVED       01590000
*---------------------------------------------------------------------- 01600000
                                                                        01610000
PROCNRSP DS    0H                                                       01620000
                                                                        01630000
         $MSG  967,               "-RSP RECEIVED..."                   +01640000
               FIELDS=((RISESS),     ISESS ADDRESS                     +01650000
               (ISETKUSR,4),         IVUSER TOKEN                      +01660000
               (ISETKSES,4),         ISESS  TOKEN                      +01670000
               (RITASK),             ITASK ADDRESS                     +01680000
               (TSKPCBC,4),          IPROC ADDRESS                     +01690000
               (TSKNAME,8),          ITASK NAME                        +01700000
               (RPLFDBK2,4),         SENSE                             +01710000
               (RPLCNTRL,3),         CNTRL FLAGS                       +01720000
               (RPLURH,3),           REQUEST HEADER                    +01730000
               (RPLSEQNO,2))         SEQUENCE NUMBER                    01740000
                                                                        01750000
*---------------------------------------------------------------------- 01760000
* QUEUE RESP DATA TO SESSION RECEIVE QUEUE & SATISFY $SESS RECEIVE      01770000
*---------------------------------------------------------------------- 01780000
                                                                        01790000
         $GETSTOR L'IRQ,            ALLOCATE AN IRQE                   +01800000
               LOC=ANY,                                                +01810000
               OWNER=(RITASK)                                           01820000
                                                                        01830000
         LR    RIRQE,R1             ESTABLISH ADDRESSIBILITY            01840000
         MVC   IRQID,=CL8'IRQE'     SET BLOCK ID                        01850000
         MVC   IRQRH(3),RPLURH      COPY REQUEST HEADER                 01860000
         MVC   IRQCNTRL(3),RPLCNTRL COPY CONTROL FLAGS                  01870000
         MVC   IRQSEQNO(2),RPLSEQNO COPY SEQUENCE NUMBER                01880000
         MVC   IRQSENSE(4),RPLFDBK2 COPY SENSE INFORMATION              01890000
                                                                        01900000
         L     R3,ISERCVTL          LAST IRQE ON THE QUEUE              01910000
         L     R2,IRQNEXT-IRQ(,R3)  NULL ELEMENT POINTER                01920000
         ST    RIRQE,IRQNEXT-IRQ(,R3) SET NEXT POINTER IN LAST IRQE     01930000
         ST    RIRQE,IRQPREV-IRQ(,R2) SET PREV POINTER IN ISERCVTL      01940000
         STM   R2,R3,IRQNEXT        LINK NEW ELEMENT NEXT/PREV          01950000
                                                                        01960000
         L     R15,IVT@SREC         RECEIVE PROCESSING MODULE           01970000
         BASR  R14,R15              SATISFY OUTSTANDING $SESS RECEIVE   01980000
                                                                        01990000
                                                                        02000000
*---------------------------------------------------------------------- 02010000
* RETURN TO CALLER                                                      02020000
*---------------------------------------------------------------------- 02030000
                                                                        02040000
RETURN   DS    0H                                                       02050000
                                                                        02060000
         LM    R15,R1,RETREGS     LOAD RETURN VALUES                    02070000
                                                                        02080000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    02090000
                                                                        02100000
*---------------------------------------------------------------------- 02110000
*  CONSTANTS AND LITERALS                                               02120000
*---------------------------------------------------------------------- 02130000
                                                                        02140000
         LTORG ,                                                        02150000
         PRINT NOGEN                                                    02160000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                02170000
         ISTDBIND ,               VTAM BIND IMAGE                       02180000
         ISTRH ,                  VTAM SNA REQUEST HEADER               02190000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         02200000
         ICVT  ,                  INTEGRATOR CVT                        02210000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   02220000
         IRPL ,                   INTEGRATOR VTAM RPL+                  02230000
         IACB ,                   INTEGRATOR VTAM ACB+                  02240000
         INIB ,                   INTEGRATOR VTAM NIB+                  02250000
         ISESS ,                  INTEGRATOR SESSION BLOCK              02260000
         IRQE ,                   INTEGRATOR RECEIVE QUEUE ELEMENT      02270000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            02280000
         ITASK ,                  INTEGRATOR TASK BLOCK                 02290000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          02300000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       02310000
         EVCODES ,                INTEGRATOR EVENT CODES                02320000
         ABCODES ,                INTEGRATOR $ABEND CODES               02330000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     02340000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        02350000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             02360000
         $PROC DSECT=YES          INTEGRATOR $PROC SERVICES             02370000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             02380000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             02390000
         IFGEXLST ,               VTAM EXIT LIST                        02400000
         END   ,                                                        02410000

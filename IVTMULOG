IVTMULOG TITLE 'INTEGRATOR - IVUSER LOGON PROCESSOR'                    00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: IVTMULOG - IVUSER LOGON PROCESSOR                            00100000
*                                                                       00110000
* DESCRIPTION:                                                          00120000
*                                                                       00130000
* ON ENTRY:                                                             00140000
*                                                                       00150000
*    R15 = ENTRY POINT ADDRESS                                          00160000
*    R14 = RETURN ADDRESS                                               00170000
*    R13 = AVAILABLE SAVE AREA                                          00180000
*    R11 = ICVT ADDRESS                                                 00190000
*    R10 = ITASK ADDRESS                                                00200000
*    R09 = IVTAMCVT ADDRESS                                             00210000
*    R08 = IVUSER ADDRESS                                               00220000
*    R01 = ADDRESS OF LOGON WORK ELEMENT (IWE)                          00230000
*                                                                       00240000
* ON EXIT:                                                              00250000
*                                                                       00260000
*    R15 = 0                                                            00270000
*    R00 = 0                                                            00280000
*    R01 = 0                                                            00290000
*                                                                       00300000
*    ALL OTHER REGISTERS ARE RESTORED.                                  00310000
*                                                                       00320000
**<DOC-OFF>************************************************************ 00330000
                                                                        00340000
         EJECT ,                                                        00350000
*********************************************************************** 00360000
*                                                                       00370000
* MAINTENANCE:                                                          00380000
*                                                                       00390000
*   08/01/93 RANDY WITEK                                                00400000
*   07/01/94 RANDY WITEK - LU6.2 SUPPORT                                00410000
*   12/31/95 RANDY WITEK - 2.1 TRANSACTION PROGRAM VTAM WU SUPPORT      00420000
*                                                                       00430000
*********************************************************************** 00440000
                                                                        00450000
         EQUS  ,                  GENERAL EQUATES                       00460000
                                                                        00470000
RICVT    EQU   R11                                                      00480000
RITASK   EQU   R10                                                      00490000
RIVTAM   EQU   R9                                                       00500000
RIVUSER  EQU   R8                                                       00510000
RIWE     EQU   R7                                                       00520000
RISESS   EQU   R6                                                       00530000
RIRPL    EQU   R5                                                       00540000
                                                                        00550000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00560000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00570000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00580000
         USING IVUSER,RIVUSER     ESTABLISH ADDRESSABILITY              00590000
         USING IWEVTAM,RIWE       ESTABLISH ADDRESSABILITY              00600000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00610000
         USING IRPL,RIRPL         ESTABLISH ADDRESSABILITY              00620000
                                                                        00630000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00640000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00650000
SUB1SAVE DS    18F                SUBROUTINE SAVE AREA                  00660000
$TASKMFL $TASK MF=L               PLIST CONSTRUCTION                    00670000
$PROCMFL $PROC MF=L               PLIST CONSTRUCTION                    00680000
$SESSMFL $SESS MF=L               PLIST CONSTRUCTION                    00690000
$RMGRMFL $RESMGR MF=L             PLIST CONSTRUCTION                    00700000
$WUMFL   $WULOC MF=L              PLIST CONSTRUCTION                    00710000
L62MFL   L62DFMD MF=L             PLIST CONSTRUCTION                    00720000
L62RETRC DS    F                  LU6.2 RETURN CODE RETURN AREA         00730000
L62RETMD DS    A                  LU6.2 MDE         RETURN AREA         00740000
NEWPRCNM DS    A                  ADDRESS OF NAME FOR NEW ITASK         00750000
WRK256   DS    XL256              GENERAL WORKAREA                      00760000
WUDATA   DS    XL16               $WULOC USERDATA RETURN AREA           00770000
MODENM62 DS    CL8                MODE NAME FOR LU6.2 SESSIONS          00780000
MDE62    DS    A                  ADDRESS OF LU6.2 MDE BLOCK            00790000
KILLSNS  DS    XL4                SENSE FOR UNBIND                      00800000
RETR15   DS    F                                                        00810000
RETR0    DS    F                                                        00820000
RETR1    DS    F                                                        00830000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00840000
FLAG     DS    X                                                        00850000
FLAGLOCK EQU   X'80'                                                    00860000
FLAGLCKD EQU   X'40'                                                    00870000
FLAGDLCK EQU   X'20'              DISP LOCK HELD                        00880000
FLAGDLKD EQU   X'10'              DISP LOCK WAS HELD ON ENTRY           00890000
FLAGCNWN EQU   X'08'              LU6.2 CONTENTION WINNER SESSION       00900000
FLAGPARA EQU   X'04'              LU6.2 PARALLEL SESSION REQUEST        00910000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00920000
                                                                        00930000
         $MSGDFT PREFIX=ICTPID,                                        +00940000
               COMPID='VTM',                                           +00950000
               TABLE=*#MSGS,                                           +00960000
               WORKA=0,                                                +00970000
               MF=(E,WRK256),                                          +00980000
               PRINT=NOGEN                                              00990000
                                                                        01000000
IVTMULOG #ENTER BASE=R12,         ENTRY LINKAGE                        +01010000
               PREG=RIWE,                                              +01020000
               AMODE=31,                                               +01030000
               RMODE=ANY                                                01040000
                                                                        01050000
         CLC   IWELCODE,=A(IWECXLOG) IS IT A LOGON                      01060000
         BE    LOGON                 BRANCH IF YES                      01070000
         CLC   IWELCODE,=A(IWECXSCP) IS IT A BIND                       01080000
         BE    BIND                  BRANCH IF YES                      01090000
         CLC   IWELCODE,=A(IWECSIRQ) IS IT A SESSION INITIATION         01100000
         BNE   ERRWORK               BRANCH IF NOT, ERROR               01110000
                                                                        01120000
*---------------------------------------------------------------------- 01130000
* SESSION INITIATION REQUEST WORK ELEMENT                               01140000
*---------------------------------------------------------------------- 01150000
                                                                        01160000
         LA    R1,IWEXKLU         TASK NAME WILL BE PARTNER LU NAME     01170000
         ST    R1,NEWPRCNM        THIS NAME USED FOR $TASK CREATE       01180000
         TM    ICTSTAT3,ICT3$P+ICT3$PX SYSTEM SHUTDOWN?                 01190000
         BNZ   SIRQKILL           BRANCH IF YES                         01200000
         TM    IVTF1,IVTF1TRM     IS TERMINATION UNDERWAY?              01210000
         BNO   ALLOCISE           BRANCH IF NOT                         01220000
                                                                        01230000
*                                                                       01240000
* A SESSION INITIATION IS BEING KILLED BECAUSE OF SYSTEM SHUTDOWN.      01250000
* IF THERE IS AN ASSOCIATED REQUESTOR SESSION,                          01260000
* QUEUE A SESS INIT COMPLETION WORK ELEMENT TO THAT ISESS               01270000
* -OR- POST THE REQUESTOR'S SPLIST.                                     01280000
*---------------------------------------------------------------------- 01290000
                                                                        01300000
SIRQKILL DS    0H                                                       01310000
                                                                        01320000
         OC    IWEXKTOK,IWEXKTOK    ASSOCIATED REQUESTOR SESSION TOKEN? 01330000
         BZ    SKNOASSC             BRANCH IF NOT                       01340000
         BAS   R14,VTAMLOCK         SERIALIZE                           01350000
                                                                        01360000
         $SESS $SESS_FIND_SESSION,                                     +01370000
               SESSION=IWEXKTOK,                                       +01380000
               ERRET=NOASSOC,                                          +01390000
               MF=(E,$SESSMFL)      LOCATE ASSOCIATED ISESS             01400000
                                                                        01410000
X        USING SPLIST,$SESSMFL                                          01420000
         L     R3,X.SPLAREA         ADDRESS OF ASSOCIATED ISESS BLOCK   01430000
         DROP  X                                                        01440000
                                                                        01450000
         LA    R3,ISEWEQ-ISE(,R3)   ADDRESS OF ASSOCIATED WORK QUEUE    01460000
                                                                        01470000
         $VTAMWE L'IWEXM,           SIZE                               +01480000
               IWECSICM             CODE (SESS INIT COMPLETION)         01490000
                                                                        01500000
X        USING IWEVTAM,R1                                               01510000
         MVC   X.IWEXMRET,=A($SESS_RC_CANCELED)                         01520000
         MVC   X.IWEXMATK,IWEXKTOK  SET ASSOCIATED SESSION TOKEN        01530000
         DROP  X                                                        01540000
                                                                        01550000
         LR    R0,R3                QUEUE ADDRESS                       01560000
         BAS   R14,QWE              GO QUEUE THE WORK ELEMENT           01570000
         B     NOASSOC                                                  01580000
                                                                        01590000
SKNOASSC DS    0H                                                       01600000
                                                                        01610000
         OC    IWEXKENT,IWEXKENT  ASSOCIATED REQUESTOR ENTITY TOKEN?    01620000
         BZ    NOASSOC            BRANCH IF NOT                         01630000
         BAS   R14,DISPLOCK       SERIALIZE                             01640000
                                                                        01650000
         $WULOC LOCATE,           FIND THE WORK UNIT                   +01660000
               TOKEN=IWEXKENT,    WORK UNIT TOKEN ADDRESS              +01670000
               USERDATA=WUDATA,   XL16 AREA TO RECEIVE USER DATA       +01680000
               MF=(E,$WUMFL)      VALIDATE WORK UNIT                    01690000
                                                                        01700000
         LTR   R15,R15            LOCATE SUCCESS?                       01710000
         BNZ   L62POST            BRANCH IF NOT                         01720000
                                                                        01730000
         L     R1,IWEXKSPL        REQUESTOR'S SPL ADDRESS               01740000
X        USING SPLIST,R1                                                01750000
         MVC   X.SPLRETCD,=A($SESS_RC_CANCELED)                         01760000
         L     R2,X.SPLEPB        REQUESTOR'S EPB ADDRESS               01770000
         L     R15,IVT@ATSP       $SESS TRACE ROUTINE                   01780000
         BASR  R14,R15            TRACE IT                              01790000
         DROP  X                                                        01800000
                                                                        01810000
L62POST  DS    0H                                                       01820000
                                                                        01830000
         L62POST (R2),            ADDRESS OF EPB TO BE POSTED          +01840000
               =F'0',             ADDRESS OF POST CODE                 +01850000
               IWEXKENT,          ADDRESS OF ENTITY TOKEN              +01860000
               L62RETRC,          RETURN CODE AREA                     +01870000
               MF=(E,L62MFL)                                            01880000
                                                                        01890000
         BAS   R14,DISPUNLK       RELEASE THE LOCK IF NECESSARY         01900000
                                                                        01910000
NOASSOC  DS    0H                                                       01920000
                                                                        01930000
         BAS   R14,STOPUSER       AND ENSURE USER ENDS                  01940000
         BAS   R14,STOPLU62       AND ENSURE USER ENDS                  01950000
         B     RETURN             AND RETURN                            01960000
                                                                        01970000
*---------------------------------------------------------------------- 01980000
* LOGON EXIT WORK ELEMENT                                               01990000
*---------------------------------------------------------------------- 02000000
                                                                        02010000
LOGON    DS    0H                                                       02020000
                                                                        02030000
         LA    R1,IWEX2LU         TASK NAME IS THE SLU NAME             02040000
         ST    R1,NEWPRCNM        THIS NAME USED FOR $TASK CREATE       02050000
         LA    RIRPL,IWEX2RPL     ADDR OF THE RPL COPY                  02060000
         TM    ICTSTAT3,ICT3$P+ICT3$PX SYSTEM SHUTDOWN?                 02070000
         BNZ   LOGNKILL           BRANCH IF YES                         02080000
         TM    IVTF1,IVTF1TRM     IS TERMINATION UNDERWAY?              02090000
         BO    LOGNKILL           BRANCH IF YES                         02100000
                                                                        02110000
*                                                                       02120000
* CHECK FOR LU6.2 LOGONS                                                02130000
*---------------------------------------------------------------------- 02140000
                                                                        02150000
X        USING ISTDBIND,IWEX2RU+12                                      02160000
                                                                        02170000
         CLC   X.BINLUP(2),=X'0602' LU TYPE 6.2?                        02180000
         BNE   NOT62LOG             BRANCH IF NOT                       02190000
         TM    X.BINCMNP2,BINBKFS   ARE WE THE FIRST SPEAKER?           02200000
         BNO   NOTPLUFS             BRANCH IF NOT                       02210000
         OI    FLAG,FLAGCNWN        REMEMBER OUR STATUS                 02220000
                                                                        02230000
NOTPLUFS DS    0H                                                       02240000
                                                                        02250000
         TM    X.BINFLG2,BINPSS+BINGDSVF PARALLEL SESSIONS + CNOS?      02260000
         BNO   NOTPLUPR             BRANCH IF NOT                       02270000
         BM    LOGNKILL             REJECT IF WE DON'T LIKE SETTINGS    02280000
         OI    FLAG,FLAGPARA        REMEMBER IT'S A PARALLEL REQUEST    02290000
                                                                        02300000
NOTPLUPR DS    0H                                                       02310000
                                                                        02320000
         DROP  X                                                        02330000
                                                                        02340000
*                                                                       02350000
* LOCATE LOGMODE NAME FOR LU6.2 SESSION                                 02360000
*---------------------------------------------------------------------- 02370000
                                                                        02380000
         ICM   R3,15,RPLAARLN     LENGTH OF CONTROL VECTORS             02390000
         BZ    LOGNKILL           BRANCH IF NONE                        02400000
         ICM   R2,15,RPLAAREA     ADDRESS OF CV'S IN COPY               02410000
         BZ    LOGNKILL           BRANCH IF NONE                        02420000
                                                                        02430000
FND62MOD DS    0H                                                       02440000
                                                                        02450000
         CLI   0(R2),X'0D'        IS THIS THE VECTOR?                   02460000
         BE    GOT62MOD           BRANCH IF YES                         02470000
         SR    R14,R14            CLEAR                                 02480000
         IC    R14,1(,R2)         LENGTH OF VECTOR DATA                 02490000
         LA    R14,2(,R14)        LENGTH OF CONTROL VECTOR              02500000
         LA    R2,0(R14,R2)       ADDRESS OF NEXT CONTROL VECTOR        02510000
         SR    R3,R14             REMAINING LENGTH                      02520000
         BP    FND62MOD           KEEP LOOKING IF VECTORS REMAIN        02530000
         B     LOGNKILL           BRANCH IF VECTOR NOT FOUND            02540000
                                                                        02550000
GOT62MOD DS    0H                                                       02560000
                                                                        02570000
         MVC   MODENM62,2(R2)     COPY LOGMODE NAME                     02580000
         CLI   MODENM62,C' '      DOES IT LOOK LIKE A NAME?             02590000
         BNH   LOGNKILL           BRANCH IF NOT                         02600000
         BAS   R14,LU62CHEK       SEE IF THIS SESSION CAN PROCEED       02610000
         LTR   R15,R15            CAN IT PROCEED?                       02620000
         BNZ   LOGNKILL           KILL IT IF NOT                        02630000
                                                                        02640000
NOT62LOG DS    0H                                                       02650000
                                                                        02660000
         B     ALLOCISE           CONTINUE SESSION SETUP                02670000
                                                                        02680000
*                                                                       02690000
* A PENDING LOGON IS BEING KILLED DUE TO SYSTEM SHUTDOWN.               02700000
*---------------------------------------------------------------------- 02710000
                                                                        02720000
LOGNKILL DS    0H                                                       02730000
                                                                        02740000
         $VTAMWE L'IWEXL,                                              +02750000
               IWECKILL             ALLOCATE "KILL SESSION" WE          02760000
                                                                        02770000
X        USING IWE,R1                                                   02780000
Y        USING IACB,R2                                                  02790000
                                                                        02800000
         L     R2,IWEX2ACB          SESSION ACB ADDRESS                 02810000
         MVC   X.IWEXLPNM,Y.IACNAME PASS PLU NAME                       02820000
         MVC   X.IWEXLCID,IWEX2CID  PASS THE SESSION CID TO KILL        02830000
         MVC   X.IWEXLACB,IWEX2ACB  PASS THE SESSION ACB ADDRESS        02840000
         MVC   X.IWEXLSNM,IWEX2LU   PASS SLU NAME                       02850000
         MVC   X.IWEXLSNS,KILLSNS   PASS ASSOCIATED SENSE INFO          02860000
         LA    R0,IVTWEQ            WORK QUEUE ADDRESS                  02870000
         BAS   R14,QWE              QUEUE KILL SESSION ELEMENT TO MAIN  02880000
         BAS   R14,STOPUSER         AND ENSURE USER ENDS                02890000
         BAS   R14,STOPLU62         AND ENSURE USER ENDS                02900000
         B     RETURN               AND RETURN                          02910000
                                                                        02920000
         DROP  X                                                        02930000
         DROP  Y                                                        02940000
                                                                        02950000
*---------------------------------------------------------------------- 02960000
* SCIP EXIT WORK ELEMENT (BIND)                                         02970000
*---------------------------------------------------------------------- 02980000
                                                                        02990000
BIND     DS    0H                                                       03000000
                                                                        03010000
         LA    R1,IWEX7LU         TASK NAME IS THE SLU NAME             03020000
         ST    R1,NEWPRCNM        THIS NAME USED FOR $TASK CREATE       03030000
         LA    RIRPL,IWEX7RPL     ADDR OF THE RPL COPY                  03040000
         TM    ICTSTAT3,ICT3$P+ICT3$PX SYSTEM SHUTDOWN?                 03050000
         BNZ   BINDKILL           BRANCH IF YES                         03060000
         TM    IVTF1,IVTF1TRM     IS TERMINATION UNDERWAY?              03070000
         BO    BINDKILL           BRANCH IF YES                         03080000
                                                                        03090000
*                                                                       03100000
* CHECK FOR LU6.2 BINDS                                                 03110000
*---------------------------------------------------------------------- 03120000
                                                                        03130000
X        USING ISTDBIND,IWEX7RU+1 ESTABLISH ADDRESSABILITY              03140000
         CLC   X.BINLUP(2),=X'0602' LU TYPE 6?                          03150000
         BNE   NOT62BND             BRANCH IF NOT                       03160000
         TM    X.BINCMNP2,BINBKFS   ARE WE THE FIRST SPEAKER?           03170000
         BO    NOTSLUFS             BRANCH IF NOT                       03180000
         OI    FLAG,FLAGCNWN        REMEMBER OUR STATUS                 03190000
                                                                        03200000
NOTSLUFS DS    0H                                                       03210000
                                                                        03220000
         TM    X.BINFLG2,BINPSS+BINGDSVF PARALLEL SESSIONS + CNOS?      03230000
         BNO   NOTSLUPR             BRANCH IF NOT                       03240000
         BM    BINDKILL             REJECT IF WE DON'T LIKE SETTINGS    03250000
         OI    FLAG,FLAGPARA        REMEMBER IT'S A PARALLEL REQUEST    03260000
                                                                        03270000
NOTSLUPR DS    0H                                                       03280000
                                                                        03290000
         DROP  X                                                        03300000
                                                                        03310000
*                                                                       03320000
* LOCATE THE MODE FIELD IN USERDATA                                     03330000
*---------------------------------------------------------------------- 03340000
                                                                        03350000
         LA    R3,IWEX7RU+26      ADDRESS OF BIND RU CRYPTO             03360000
         L     R2,RPLRLEN         LENGTH OF BIND RU                     03370000
         S     R2,=F'26'          MINUS THE FIXED PORTION               03380000
         BNP   BINDKILL           BRANCH IF BIND EXHAUSTED              03390000
                                                                        03400000
         SR    R1,R1              CLEAR FOR IC                          03410000
         IC    R1,0(,R3)          CRYPTO BYTE                           03420000
         N     R1,=X'0000000F'    ISOLATE ADDITIONAL LENGTH             03430000
         LA    R3,1(R1,R3)        SKIP CRYPTO FIELDS                    03440000
         LA    R1,1(,R1)          AMOUNT SKIPPED OVER                   03450000
         SR    R2,R1              LENGTH OF BIND REMAINING              03460000
         BNP   BINDKILL           BRANCH IF BIND EXHAUSTED              03470000
                                                                        03480000
         SR    R1,R1              CLEAR FOR IC                          03490000
         IC    R1,0(,R3)          LENGTH OF PLUNAME FIELD               03500000
         LA    R3,1(R1,R3)        SKIP PLUNAME FIELD                    03510000
         LA    R1,1(,R1)          AMOUNT SKIPPED OVER                   03520000
         SR    R2,R1              LENGTH OF BIND REMAINING              03530000
         BNP   BINDKILL           BRANCH IF BIND EXHAUSTED              03540000
                                                                        03550000
         SR    R1,R1              CLEAR FOR IC                          03560000
         ICM   R1,B'0001',0(R3)   LENGTH OF USERDATA FIELD              03570000
         BZ    BINDKILL           BRANCH IF NO USERDATA                 03580000
         LA    R2,1(,R3)          FIRST BYTE OF USERDATA                03590000
         BCTR  R1,0               LENGTH REMAINING                      03600000
                                                                        03610000
         CLI   0(R2),X'00'        STRUCTURED SUBFIELDS?                 03620000
         BNE   BINDKILL           BRANCH IF NOT                         03630000
                                                                        03640000
         LA    R2,1(,R2)          ADDRESS OF 1ST SUBFIELD               03650000
         BCTR  R1,0               LENGTH REMAINING                      03660000
                                                                        03670000
BND62MOD DS    0H                                                       03680000
                                                                        03690000
         LTR   R1,R1              ANY SUBFIELDS REMAINING?              03700000
         BNP   BINDKILL           BRANCH IF NOT                         03710000
         SR    R0,R0              CLEAR FOR INSERT                      03720000
         LR    R14,R2             ADDRESS OF CURRENT SUBFIELD           03730000
         ICM   R0,B'0001',0(R2)   LENGTH OF CURRENT SUBFIELD            03740000
         BNP   BINDKILL           BRANCH IF SOMETHING'S FUNNY           03750000
         SR    R1,R0              LENGTH REMAINING AFTER CURRENT        03760000
         BCTR  R1,0               LENGTH REMAINING AFTER CURRENT        03770000
         AR    R2,R0              ADDRESS OF NEXT VECTOR                03780000
         LA    R2,1(R2)           ADDRESS OF NEXT VECTOR                03790000
         CLI   1(R14),X'02'       MODE SUBFIELD?                        03800000
         BNE   BND62MOD           BRANCH IF NOT                         03810000
                                                                        03820000
         LR    R15,R0             LENGTH OF MODE SUBFIELD               03830000
         BCTR  R15,0              LENGTH OF MODE NAME                   03840000
         ICM   R15,B'1000',=C' '  SET BLANK PAD                         03850000
         LA    R0,MODENM62        COPY-TO AREA                          03860000
         LA    R1,8               COPY-TO LENGTH                        03870000
         LA    R14,2(,R14)        COPY-FROM AREA                        03880000
         MVCL  R0,R14             COPY THE MODE NAME AND BLANK PAD      03890000
         CLI   MODENM62,C' '      DOES IT LOOK LIKE A NAME?             03900000
         BNH   BINDKILL           BRANCH IF NOT                         03910000
         BAS   R14,LU62CHEK       SEE IF THIS SESSION CAN PROCEED       03920000
         LTR   R15,R15            CAN IT PROCEED?                       03930000
         BNZ   BINDKILL           KILL IT IF NOT                        03940000
                                                                        03950000
NOT62BND DS    0H                                                       03960000
                                                                        03970000
         B     ALLOCISE           CONTINUE SESSION SETUP                03980000
                                                                        03990000
*                                                                       04000000
* A PENDING BIND IS BEING KILLED DUE TO SYSTEM SHUTDOWN.                04010000
*---------------------------------------------------------------------- 04020000
                                                                        04030000
BINDKILL DS    0H                                                       04040000
                                                                        04050000
         $VTAMWE L'IWEXL,                                              +04060000
               IWECKILL             ALLOCATE "KILL SESSION" WE          04070000
                                                                        04080000
X        USING IWE,R1                                                   04090000
Y        USING IACB,R2                                                  04100000
                                                                        04110000
         OI    X.ILF1,ILF1BIND      SHOW PENDING BIND IS TO BE KILLED   04120000
         L     R2,IWEX7ACB          SESSION ACB ADDRESS                 04130000
         MVC   X.IWEXLPNM,Y.IACNAME PASS PLU NAME                       04140000
         MVC   X.IWEXLCID,IWEX7CID  PASS THE SESSION CID TO KILL        04150000
         MVC   X.IWEXLACB,IWEX7ACB  PASS THE SESSION ACB ADDRESS        04160000
         MVC   X.IWEXLSNM,IWEX7LU   PASS SLU NAME                       04170000
         MVC   X.IWEXLSNS,KILLSNS   PASS ASSOICATED SENSE INFO          04180000
         LA    R0,IVTWEQ            WORK QUEUE ADDRESS                  04190000
         BAS   R14,QWE              QUEUE KILL SESSION ELEMENT TO MAIN  04200000
         BAS   R14,STOPUSER         AND ENSURE USER ENDS                04210000
         BAS   R14,STOPLU62         AND ENSURE USER ENDS                04220000
         B     RETURN               AND RETURN                          04230000
                                                                        04240000
         DROP  X                                                        04250000
         DROP  Y                                                        04260000
                                                                        04270000
*---------------------------------------------------------------------- 04280000
* SESSION INITIATION IS PROCEEDING...ALLOCATE AN ISESS BLOCK            04290000
*---------------------------------------------------------------------- 04300000
                                                                        04310000
ALLOCISE DS    0H                                                       04320000
                                                                        04330000
         $GETSTOR L'ISEMAX,                                            +04340000
               LOC=ANY,                                                +04350000
               OWNER=(RITASK)                                           04360000
                                                                        04370000
         LR    RISESS,R1                REFERENCE TO ISESS BLOCK        04380000
         MVC   ISEID,=CL8'ISESS'        SET EYECATCHER                  04390000
         MVC   ISELEN,=A(L'ISEMAX)      SET THE LENGTH                  04400000
         ST    RIVUSER,ISEIVUSR         LINK TO OWNING IVUSER           04410000
         ST    RITASK,ISEITASK          LINK TO OWNING ITASK            04420000
                                                                        04430000
         LA    R1,ISERCVHD              INITIALIZE RECEIVE QUEUE        04440000
         S     R1,=A(IRQNEXT-IRQ)       NORMALIZE FOR CHAINING          04450000
         O     R1,=X'80000000'          HI BIT ON FOR NULL ELEMENT      04460000
         ST    R1,ISERCVHD              SET NULL ELEMENT POINTER        04470000
         ST    R1,ISERCVTL              SET NULL ELEMENT POINTER        04480000
                                                                        04490000
         TM    IVUF1,IVUF1L62           IS THIS AN LU6.2 IVUSER?        04500000
         BNO   NOT62IVU                 BRANCH IF NOT                   04510000
         MVC   ISE62MDE,MDE62           SET LU6.2 MDE -OR- 0            04520000
         LA    R1,ISE62RB1              INITIALIZE SPLIST QUEUE         04530000
         S     R1,=A(SPL62RBN-SPLIST)   NORMALIZE FOR CHAINING          04540000
         O     R1,=X'80000000'          HI BIT ON FOR NULL ELEMENT      04550000
         ST    R1,ISE62RB1              SET NULL ELEMENT POINTER        04560000
         ST    R1,ISE62RBL              SET NULL ELEMENT POINTER        04570000
NOT62IVU DS    0H                                                       04580000
                                                                        04590000
         LM    R0,R1,IVUTK              R0=USER TOKEN R1=LAST SESS TOKN 04600000
         AL    R1,=F'1'                 NEXT SESSION TOKEN              04610000
         ST    R1,IVUTKSES              SAVE THE UPDATED SESSION TOKEN  04620000
         STM   R0,R1,ISETK              SET TOKEN FOR NEW ISESS         04630000
                                                                        04640000
         OI    ISEF4,ISEF4STR           FLAG ISESS AS "STARTING"        04650000
                                                                        04660000
         CLC   IWELCODE,=A(IWECXLOG)    IS IT A USER LOGON?             04670000
         BE    ALLOCLGN                 BRANCH IF YES                   04680000
                                                                        04690000
         CLC   IWELCODE,=A(IWECXSCP)    IS IT A BIND?                   04700000
         BE    ALLOCBND                 BRANCH IF YES                   04710000
                                                                        04720000
         MVC   ISEDRIVE,IWEXKDRV        SET DRIVER NAME IF PROVIDED     04730000
         MVC   ISELOGMD,IWEXKMDE        SET LOGMODE NAME IF PROVIDED    04740000
         MVC   ISERLUNM,IWEXKLU         SET PARTNER LU NAME             04750000
         MVC   ISEPARM,IWEXKPRM         SET THE PARM WORD               04760000
         TM    IVUF1,IVUF1L62           IS THIS AN LU6.2 IVUSER?        04770000
         BO    ALLOCSOL                 BRANCH YES, NO NOTION OF LOGON  04780000
         TM    IVUF4,IVUF4TCP           IS THIS A TCP/IP USER?          04790000
         BO    ALLOCADD                 BRANCH YES, NO NOTION OF LOGON  04800000
         TM    IVUF4,IVUF4XPG           IS THIS A CPIC TP USER?         04810000
         BO    ALLOCADD                 BRANCH YES, NO NOTION OF LOGON  04820000
         OC    IVU#SESS,IVU#SESS        IS THIS THE FIRST SESSION?      04830000
         BNZ   ALLOCADD                 BRANCH IF NOT                   04840000
         OI    ISEF1,ISEF1LGN           THIS IS THE "LOGON" SESSION     04850000
         B     ALLOCADD                                                 04860000
                                                                        04870000
ALLOCSOL DS    0H                                                       04880000
                                                                        04890000
         OI    ISE62FL2,ISE62SOL        REMEMBER SOLICITED SESSION      04900000
         B     ALLOCADD                 AND CONTINUE                    04910000
                                                                        04920000
ALLOCLGN DS    0H                                                       04930000
                                                                        04940000
         MVC   ISEACB@(4),IWEX2ACB      ACB ASSOCIATION                 04950000
         TM    IVUF1,IVUF1L62           IS THIS AN LU6.2 IVUSER?        04960000
         BO    ALLOCADD                 BRANCH YES, NO NOTION OF LOGON  04970000
         OI    ISEF1,ISEF1LGN           THIS IS THE "LOGON" SESSION     04980000
         B     ALLOCADD                 AND CONTINUE                    04990000
                                                                        05000000
ALLOCBND DS    0H                                                       05010000
                                                                        05020000
         OI    ISEF2,ISEF2SLU           MARK AS SLU SESSION PARTNER     05030000
         MVC   ISEACB@(4),IWEX7ACB      ACB ASSOCIATION                 05040000
         B     ALLOCADD                 AND CONTINUE                    05050000
                                                                        05060000
ALLOCADD DS    0H                                                       05070000
                                                                        05080000
         $SESS $SESS_ADD_SESSION,                                      +05090000
               SESSION=ISETK,                                          +05100000
               AREA=(RISESS),                                          +05110000
               ERRET=ERR$SESS,                                         +05120000
               MF=(E,$SESSMFL)          ADD ISESS TO IVUSER ISESS CHAIN 05130000
                                                                        05140000
         ICM   R1,15,ISEACB@            ASSOCIATED WITH IACB YET?       05150000
         BZ    STGIWE                   BRANCH IF NOT                   05160000
                                                                        05170000
         $VTAM ADDISESS,                                               +05180000
               AREA=(RISESS),                                          +05190000
               ERRET=ERR$VTAM,                                         +05200000
               MF=(E,MFE_LIST)                                          05210000
                                                                        05220000
*                                                                       05230000
* ALLOCATE THE STAGING IWE FOR ISESS WORK                               05240000
*---------------------------------------------------------------------- 05250000
                                                                        05260000
STGIWE   DS    0H                                                       05270000
                                                                        05280000
                                                                        05290000
         $VTAMWE L'IWE,                 SIZE                           +05300000
               (RISESS)                 CODE                            05310000
                                                                        05320000
S        USING IWE,R4                   REFERENCE TO STAGING IWE        05330000
                                                                        05340000
         LR    R4,R1                    SAVE STAGING IWE FOR PARM VALUE 05350000
         MVC   S.IWEECB(4),=X'40000000' MARK STAGING ECB POSTED         05360000
                                                                        05370000
*                                                                       05380000
* ALLOCATE SESSION INITIATION WORK ELEMENT TO KICK-START THE ISESS WORK 05390000
*---------------------------------------------------------------------- 05400000
                                                                        05410000
         CLC   IWELCODE,=A(IWECSIRQ)   IS IT A SESSION INIT REQUEST?    05420000
         BNE   IWELOGON                BRANCH IF NOT                    05430000
                                                                        05440000
         $VTAMWE *IWELEN,              SIZE                            +05450000
               IWECSIRQ                CODE                             05460000
                                                                        05470000
L        USING IWE,R3                  REFERENCE TO SIRQ IWE            05480000
                                                                        05490000
         LR    R3,R1                   ESTABLISH ADDRESSIBILITY         05500000
         LR    R0,R1                   COPY-TO   ADDRESS                05510000
         L     R1,IWELEN               COPY-TO   LENGTH                 05520000
         LR    R14,RIWE                COPY-FROM ADDRESS                05530000
         LR    R15,R1                  COPY-FROM LENGTH                 05540000
         MVCL  R0,R14                  COPY THE WORK ELEMENT            05550000
         XC    L.IWELINK,L.IWELINK     NO WE'S LINKED TO THE NEW COPY   05560000
         XC    L.IWEECB,L.IWEECB       ENSURE ECB CLEAR IN NEW COPY     05570000
                                                                        05580000
         DROP  L                       REF TO STAGING & LOGON IWE'S     05590000
                                                                        05600000
         B     NEWPROC                 GET THE ISESS PROC RUNNING       05610000
                                                                        05620000
*                                                                       05630000
* ALLOCATE THE LOGON WORK ELEMENT TO KICK-START THE ISESS WORK          05640000
*---------------------------------------------------------------------- 05650000
                                                                        05660000
IWELOGON DS    0H                                                       05670000
                                                                        05680000
         CLC   IWELCODE,=A(IWECXLOG)   IS IT A USER LOGON?              05690000
         BNE   IWEBIND                 BRANCH IF YES                    05700000
                                                                        05710000
         $VTAMWE *IWELEN,               SIZE                           +05720000
               IWECXLOG                 CODE                            05730000
                                                                        05740000
L        USING IWE,R3                   REFERENCE TO LOGON IWE          05750000
                                                                        05760000
         LR    R3,R1                    ESTABLISH ADDRESSIBILITY        05770000
         LR    R0,R3                    COPY-TO   ADDRESS               05780000
         L     R1,IWELEN                COPY-TO   LENGTH                05790000
         LR    R14,RIWE                 COPY-FROM ADDRESS               05800000
         LR    R15,R1                   COPY-FROM LENGTH                05810000
         MVCL  R0,R14                   COPY THE LOGON WORK ELEMENT     05820000
         XC    L.IWELINK,L.IWELINK      NO WE'S LINKED TO NEW COPY      05830000
         XC    L.IWEECB,L.IWEECB        ENSURE ECB CLEAR IN NEW COPY    05840000
                                                                        05850000
         L     R2,RPLAAREA              ADDRESS OF CV'S                 05860000
         S     R2,RPLAREA               OFFSET  OF CV'S                 05870000
                                                                        05880000
         LA    RIRPL,L.IWEX2RPL         ADDR OF NEW RPL COPY AREA       05890000
         LA    R1,L.IWEX2RU             ADDR OF NEW CINIT COPY AREA     05900000
         ST    R1,RPLAREA               SET CINIT ADDR IN NEW RPL COPY  05910000
         AR    R1,R2                    ADDR OF CV'S IN NEW RPL COPY    05920000
         ST    R1,RPLAAREA              SET CV'S ADDR IN NEW RPL COPY   05930000
                                                                        05940000
         DROP  L                        REF. TO LOGON IWE               05950000
                                                                        05960000
         B     NEWPROC                  AND CONTINUE                    05970000
                                                                        05980000
*                                                                       05990000
* ALLOCATE THE BIND WORK ELEMENT TO KICK-START THE ISESS WORK           06000000
*---------------------------------------------------------------------- 06010000
                                                                        06020000
IWEBIND  DS    0H                                                       06030000
                                                                        06040000
         $VTAMWE *IWELEN,               SIZE                           +06050000
               IWECXSCP                 CODE                            06060000
                                                                        06070000
L        USING IWE,R3                   REFERENCE TO LOGON IWE          06080000
                                                                        06090000
         LR    R3,R1                    ESTABLISH ADDRESSIBILITY        06100000
         LR    R0,R3                    COPY-TO   ADDRESS               06110000
         L     R1,IWELEN                COPY-TO   LENGTH                06120000
         LR    R14,RIWE                 COPY-FROM ADDRESS               06130000
         LR    R15,R1                   COPY-FROM LENGTH                06140000
         MVCL  R0,R14                   COPY THE LOGON WORK ELEMENT     06150000
         XC    L.IWELINK,L.IWELINK      NO WE'S LINKED TO NEW COPY      06160000
         XC    L.IWEECB,L.IWEECB        ENSURE ECB CLEAR IN NEW COPY    06170000
         LA    RIRPL,L.IWEX7RPL         ADDR OF NEW RPL COPY AREA       06180000
         LA    R1,L.IWEX7RU             ADDR OF NEW BIND COPY AREA      06190000
         ST    R1,RPLAREA               SET BIND ADDR IN NEW RPL COPY   06200000
                                                                        06210000
         DROP  L                        REF. TO LOGON IWE               06220000
                                                                        06230000
         B     NEWPROC                  AND CONTINUE                    06240000
                                                                        06250000
*                                                                       06260000
* CREATE A NEW PROCESS FOR THE ISESS                                    06270000
*---------------------------------------------------------------------- 06280000
                                                                        06290000
NEWPROC  DS    0H                                                       06300000
                                                                        06310000
         ST    R3,S.IWELINK             LINK WORK TO STAGING IWE        06320000
         ST    R3,ISEWEQ                THIS IS THE HEAD OF THE WEQ     06330000
                                                                        06340000
         DROP  S                        REF. TO STAGING IWE             06350000
                                                                        06360000
         $TASK SETEPB,                                                 +06370000
               ECODE=EC$VTST,                                          +06380000
               ERRET=ERR$TASK,                                         +06390000
               MF=(E,$TASKMFL)          INIT. TASK TERMINATION EPB      06400000
                                                                        06410000
         LR    R3,R1                    SESS TERMINATION EPB ADDRESS    06420000
                                                                        06430000
         $PROC CREATE,                  CREATE ISESS PROCESS           +06440000
               EP=*IVT@SESS,            IVTMSESS IS THE ENTRY POINT    +06450000
               NAME=*NEWPRCNM,          IPROC NAME                     +06460000
               PARM=(R4),               STAGING IWE IS THE PARM        +06470000
               TERMEPB=(R3),            EPB TO POST WHEN PROCESS GONE  +06480000
               MF=(E,$PROCMFL)                                          06490000
                                                                        06500000
         LTR   R15,R15                                                  06510000
         BNZ   ERR$PROC                 BRANCH IF SERVICE ERROR         06520000
         ST    R1,ISEIPCB               SET THE PCB ADDRESS             06530000
         LR    R3,R1                    NEW IPCB ADDRESS                06540000
                                                                        06550000
         $RESMGR ADD,                   ADD A RESOURCE MANAGER         +06560000
               TOKEN=ISERMTOK,          PUT RESMGR TOKEN HERE          +06570000
               OWNER=(R3),              THE NEW IPCB                   +06580000
               ROUTINE=*IVT@SMGR,       ROUTINE IS IVTMSMGR            +06590000
               PARM=(RISESS),           R1 PARM IS ISESS BLOCK         +06600000
               MF=(E,$RMGRMFL)                                          06610000
                                                                        06620000
         B     RETURN                   WAIT FOR WORK                   06630000
                                                                        06640000
*---------------------------------------------------------------------- 06650000
* RETURN TO CALLER                                                      06660000
*---------------------------------------------------------------------- 06670000
                                                                        06680000
RETURN   DS    0H                                                       06690000
                                                                        06700000
         BAS   R14,VTAMUNLK             RELEASE THE LOCK IF NECESSARY   06710000
                                                                        06720000
         LM    R15,R1,RETREGS           LOAD RETURNS                    06730000
                                                                        06740000
         #EXIT R1=YES                   RETURN W/R15,R0,R1              06750000
                                                                        06760000
*---------------------------------------------------------------------- 06770000
* SUBROUTINE LU62CHEK - DETERMINE IF UNSOL. LU6.2 SESSION IS ACCEPTABLE 06780000
*                                                                       06790000
* ENTRY            MODENM62 = SESSION MODE NAME                         06800000
*                  FLAGCNWN = 0-->CONLOSER SESS 1-->CONWINNER SESS      06810000
*                  FLAGPARA = 0-->SINGLE SESS   1-->PARALLEL SESS       06820000
*                                                                       06830000
* RETURNS          R15 = 0 --> SESSION IS ACCEPTABLE                    06840000
*                      = 4 --> SESSION IS NOT ACCEPTABLE                06850000
*                  KILLSNS MAY BE SET TO APPROPRIATE VALUE              06860000
*---------------------------------------------------------------------- 06870000
                                                                        06880000
LU62CHEK DS    0H                                                       06890000
                                                                        06900000
         STM   R14,R12,SUB1SAVE   SAVE REGISTERS                        06910000
*                                                                       06920000
* LOCATE/CREATE THE REQUESTED MODE                                      06930000
*---------------------------------------------------------------------- 06940000
                                                                        06950000
         BAS   R14,VTAMLOCK       SERIALIZE                             06960000
                                                                        06970000
         L62DSMD (RIVUSER),       PARTNER_LU ADDRESS                   +06980000
               MODENM62,          MODE NAME ADDRESS                    +06990000
               =F'8',             MODE NAME LENGTH ADDRESS             +07000000
               L62RETMD,          MDE ADDRESS RETURN AREA              +07010000
               L62RETRC,          RETURN CODE AREA                     +07020000
               MF=(E,L62MFL)                                            07030000
                                                                        07040000
         OC    L62RETRC,L62RETRC  GOOD RETURN CODE?                     07050000
         BZ    LU62MODE           BRANCH IF MODE NAME EXISTS            07060000
                                                                        07070000
         L62DFMD (RIVUSER),       PARTNER_LU ADDRESS                   +07080000
               MODENM62,          MODE NAME ADDRESS                    +07090000
               =F'8',             MODE NAME LENGTH ADDRESS             +07100000
               L62RETMD,          MDE ADDRESS RETURN AREA              +07110000
               L62RETRC,          RETURN CODE AREA                     +07120000
               MF=(E,L62MFL)                                            07130000
                                                                        07140000
         OC    L62RETRC,L62RETRC  GOOD RETURN CODE?                     07150000
         BZ    LU62MODE           BRANCH IF MODE WAS DEFINED            07160000
         CLC   L62RETRC,=A(LU62_PRODUCT_SPECIFIC_ERROR) MAYBE A RACE?   07170000
         BNE   LU62NOGO           BRANCH IF NOT                         07180000
                                                                        07190000
         L62DSMD (RIVUSER),       PARTNER_LU ADDRESS                   +07200000
               MODENM62,          MODE NAME ADDRESS                    +07210000
               =F'8',             MODE NAME LENGTH ADDRESS             +07220000
               L62RETMD,          MDE ADDRESS RETURN AREA              +07230000
               L62RETRC,          RETURN CODE AREA                     +07240000
               MF=(E,L62MFL)                                            07250000
                                                                        07260000
         OC    L62RETRC,L62RETRC  DID SOMEBODY ELSE DO THE DEFINE?      07270000
         BZ    LU62MODE           BRANCH IF YES                         07280000
         B     LU62NOGO           BRANCH IF CAN'T FIND PARTNER LU       07290000
                                                                        07300000
*                                                                       07310000
* THE MDE WAS CREATED OR FOUND.                                         07320000
*---------------------------------------------------------------------- 07330000
                                                                        07340000
X        USING MDE,R4                                                   07350000
                                                                        07360000
LU62MODE DS    0H                                                       07370000
                                                                        07380000
         ICM   R4,15,L62RETMD     RETURNED MDE                          07390000
         BNP   LU62NOGO           BRANCH IF DOESN'T LOOK GOOD           07400000
         ST    R4,MDE62           SAVE FOR TYING NEW ISES TO MDE        07410000
         TM    FLAG,FLAGPARA      ARE WE LOOKING FOR PARALLEL?          07420000
         BNO   LU62NOPR           BRANCH IF NOT                         07430000
         TM    IVUF1,IVUF1PSC     ARE WE PARALLEL CAPABLE?              07440000
         BO    LU62NOPR           BRANCH IF YES TO CONTINUE             07450000
         MVC   KILLSNS,=XL4'08050000'                                   07460000
         B     LU62NOGO           BRANCH IF NOT                         07470000
                                                                        07480000
LU62NOPR DS    0H                                                       07490000
                                                                        07500000
         L     R15,X.MDEASC       ACTIVE SESSION COUNT                  07510000
         A     R15,X.MDEPSC       + PENDING SESSION COUNT               07520000
         C     R15,X.MDESESSL     IS THERE STILL ROOM?                  07530000
         BNL   LU62NOGO           BRANCH IF NOT                         07540000
         TM    FLAG,FLAGCNWN      IS THIS A CONWINNER FOR US?           07550000
         BNO   LU62NOCW           BRANCH IF NOT                         07560000
                                                                        07570000
         L     R14,X.MDESESSL     THE SESSION LIMIT                     07580000
         S     R14,X.MDEMINCL     - MINIMUM CONLOSER                    07590000
         L     R15,X.MDEACWC      ACTIVE CONWINNER COUNT                07600000
         A     R15,X.MDEPCWC      + PENDING CONWINNER COUNT             07610000
         CR    R14,R15            CAN WE FIRE UP A CONWINNER SESSION?   07620000
         BNH   LU62NOGO           BRANCH IF NOT                         07630000
         L     R15,X.MDEASC       UPDATE ACTIVE SESSION COUNT           07640000
         LA    R15,1(,R15)        UPDATE ACTIVE SESSION COUNT           07650000
         ST    R15,X.MDEASC       UPDATE ACTIVE SESSION COUNT           07660000
         L     R15,X.MDEACWC      UPDATE ACTIVE CONWINNER COUNT         07670000
         LA    R15,1(,R15)        UPDATE ACTIVE CONWINNER COUNT         07680000
         ST    R15,X.MDEACWC      UPDATE ACTIVE CONWINNER COUNT         07690000
         B     LU62GO             AND ALLOW THE SESSION TO PROCEED      07700000
                                                                        07710000
LU62NOCW DS    0H                                                       07720000
                                                                        07730000
         L     R14,X.MDESESSL     THE SESSION LIMIT                     07740000
         S     R14,X.MDEMINCW     - MINIMUM CONWINNER                   07750000
         L     R15,X.MDEACLC      ACTIVE CONLOSER COUNT                 07760000
         A     R15,X.MDEPCLC      + PENDING CONLOSER COUNT              07770000
         CR    R14,R15            CAN WE FIRE UP A CONLOSER SESSION?    07780000
         BNH   LU62NOGO           BRANCH IF NOT                         07790000
         L     R15,X.MDEASC       UPDATE ACTIVE SESSION COUNT           07800000
         LA    R15,1(,R15)        UPDATE ACTIVE SESSION COUNT           07810000
         ST    R15,X.MDEASC       UPDATE ACTIVE SESSION COUNT           07820000
         L     R15,X.MDEACLC      UPDATE ACTIVE CONLOSER COUNT          07830000
         LA    R15,1(,R15)        UPDATE ACTIVE CONLOSER COUNT          07840000
         ST    R15,X.MDEACLC      UPDATE ACTIVE CONLOSER COUNT          07850000
         B     LU62GO             AND ALLOW THE SESSION TO PROCEED      07860000
                                                                        07870000
         DROP  X                                                        07880000
                                                                        07890000
*                                                                       07900000
* RETURN FROM LU6.2 SESSION ACCEPTANCE CHECKS                           07910000
*---------------------------------------------------------------------- 07920000
                                                                        07930000
LU62GO   DS    0H                                                       07940000
                                                                        07950000
         MVC   SUB1SAVE+4(4),=F'0'                                      07960000
         B     LU62RETN                                                 07970000
                                                                        07980000
LU62NOGO DS    0H                                                       07990000
                                                                        08000000
         MVC   SUB1SAVE+4(4),=F'4'                                      08010000
         B     LU62RETN                                                 08020000
                                                                        08030000
LU62RETN DS    0H                                                       08040000
                                                                        08050000
         BAS   R14,VTAMUNLK       RELEASE SERIALIZATION                 08060000
                                                                        08070000
         LM    R14,R12,SUB1SAVE   RESTORE REGISTERS                     08080000
         BR    R14                AND RETURN TO CALLER W/R15            08090000
                                                                        08100000
*---------------------------------------------------------------------- 08110000
*   SUBROUTINE: STOP THE IVUSER (LU6.2)                                 08120000
*---------------------------------------------------------------------- 08130000
                                                                        08140000
STOPLU62 DS    0H                                                       08150000
                                                                        08160000
         TM    IVUF1,IVUF1L62     IS THIS IVUSER FOR LU6.2?             08170000
         BNOR  R14                RETURN IF NOT                         08180000
         STM   R14,R2,SUB1SAVE    SAVE REGISTERS                        08190000
                                                                        08200000
         L     R15,IL6@USUC       STOP USER CHECK ROUTINE               08210000
         BASR  R14,R15            LINK TO ROUTINE                       08220000
                                                                        08230000
         LM    R14,R2,SUB1SAVE    RESTORE REGISTERS                     08240000
         BR    R14                AND RETURN                            08250000
                                                                        08260000
*---------------------------------------------------------------------- 08270000
*   SUBROUTINE: STOP THE IVUSER (NOT-LU6.2)                             08280000
*---------------------------------------------------------------------- 08290000
                                                                        08300000
STOPUSER DS    0H                                                       08310000
                                                                        08320000
         TM    IVUF1,IVUF1L62     IS THIS IVUSER FOR LU6.2?             08330000
         BOR   R14                RETURN IF YES                         08340000
         STM   R14,R2,SUB1SAVE    SAVE REGISTERS                        08350000
                                                                        08360000
         $VTAMWE L'IWEXI,                                              +08370000
               IWECSTPU           ALLOCATE "STOP USER" WORK ELEMENT     08380000
                                                                        08390000
         LA    R0,IVUWEQ          WORK QUEUE ADDRESS                    08400000
         BAS   R14,QWE            QUEUE STOP WORK ELEMENT TO IVUSER     08410000
                                                                        08420000
         LM    R14,R2,SUB1SAVE    RESTORE REGISTERS                     08430000
         BR    R14                AND RETURN                            08440000
                                                                        08450000
*---------------------------------------------------------------------- 08460000
* SUBROUTINE QWE - QUEUE A WORK ELEMENT TO A GIVEN WORK QUEUE           08470000
*                                                                       08480000
* ENTRY            R14 = RETURN ADDRESS                                 08490000
*                  R1  = WORK ELEMENT ADDRESS                           08500000
*                  R0  = QUEUE ADDRESS                                  08510000
*                                                                       08520000
* RETURNS          R15 = 0 --> QUEUEING WAS SUCCESSFUL                  08530000
*                      = 4 --> QUEUEING FAILED, WORK ELEMENT RELEASED   08540000
*---------------------------------------------------------------------- 08550000
                                                                        08560000
QWE      DS    0H                                                       08570000
                                                                        08580000
         STM   R14,R4,SUB0SAVE    SAVE REGISTERS                        08590000
         LR    R3,R0              SAVE QUEUE ADDRESS                    08600000
         LR    R4,R1              SAVE WORK ELEMENT ADDRESS             08610000
                                                                        08620000
         $VTAMQ (R4),             WORK ELEMENT                         +08630000
               (R3)               QUEUE                                 08640000
                                                                        08650000
         L     R14,SUB0SAVE       RESTORE REGISTERS                     08660000
         LM    R0,R4,SUB0SAVE+8   RESTORE REGISTERS                     08670000
         BR    R14                AND RETURN TO CALLER W/R15            08680000
                                                                        08690000
*---------------------------------------------------------------------- 08700000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 08710000
*---------------------------------------------------------------------- 08720000
                                                                        08730000
VTAMLOCK DS    0H                                                       08740000
                                                                        08750000
         TM    FLAG,FLAGLOCK        WAS THE LOCK ALREADY OBTAINED?      08760000
         BOR   R14                  RETURN IF YES                       08770000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             08780000
                                                                        08790000
         $SER  OBTAIN,                                                 +08800000
               VTAM                                                     08810000
                                                                        08820000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              08830000
         BNE   VTAMLOEX             BRANCH IF NOT                       08840000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         08850000
                                                                        08860000
VTAMLOEX DS    0H                                                       08870000
                                                                        08880000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               08890000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          08900000
         BR    R14                  RETURN                              08910000
                                                                        08920000
*---------------------------------------------------------------------- 08930000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                08940000
*---------------------------------------------------------------------- 08950000
                                                                        08960000
VTAMUNLK DS    0H                                                       08970000
                                                                        08980000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       08990000
         BNOR  R14                  BRANCH IF NOT                       09000000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             09010000
         BOR   R14                  DON'T RELEASE IF IT WAS             09020000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             09030000
                                                                        09040000
         $SER  RELEASE,                                                +09050000
               VTAM                                                     09060000
                                                                        09070000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  09080000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          09090000
         BR    R14                  RETURN                              09100000
                                                                        09110000
*---------------------------------------------------------------------- 09120000
*   SUBROUTINE: OBTAIN DISP GLOBAL LOCK                                 09130000
*---------------------------------------------------------------------- 09140000
                                                                        09150000
DISPLOCK DS    0H                                                       09160000
                                                                        09170000
         TM    FLAG,FLAGDLCK        WAS THE LOCK ALREADY OBTAINED?      09180000
         BOR   R14                  RETURN IF YES                       09190000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             09200000
                                                                        09210000
         $SER  OBTAIN,                                                 +09220000
               DISP                                                     09230000
                                                                        09240000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              09250000
         BNE   DISPLOEX             BRANCH IF NOT                       09260000
         OI    FLAG,FLAGDLKD        REMEMBER LOCK HELD ON ENTRY         09270000
                                                                        09280000
DISPLOEX DS    0H                                                       09290000
                                                                        09300000
         OI    FLAG,FLAGDLCK        REMEMBER LOCK IS HELD               09310000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          09320000
         BR    R14                  RETURN                              09330000
                                                                        09340000
*---------------------------------------------------------------------- 09350000
*   SUBROUTINE: RELEASE DISP GLOBAL LOCK                                09360000
*---------------------------------------------------------------------- 09370000
                                                                        09380000
DISPUNLK DS    0H                                                       09390000
                                                                        09400000
         TM    FLAG,FLAGDLCK        IS LOCK HELD?                       09410000
         BNOR  R14                  BRANCH IF NOT                       09420000
         TM    FLAG,FLAGDLKD        WAS LOCK HELD ON ENTRY?             09430000
         BOR   R14                  DON'T RELEASE IF IT WAS             09440000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             09450000
                                                                        09460000
         $SER  RELEASE,                                                +09470000
               DISP                                                     09480000
                                                                        09490000
         NI    FLAG,255-FLAGDLCK    SHOW LOCK NOT HELD                  09500000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          09510000
         BR    R14                  RETURN                              09520000
                                                                        09530000
*---------------------------------------------------------------------- 09540000
* ERROR ROUTINES                                                        09550000
*---------------------------------------------------------------------- 09560000
                                                                        09570000
ERR$TASK DS    0H                                                       09580000
                                                                        09590000
         $ABEND ABE_VTDIAG,                                            +09600000
               SCOPE=PCB,                                              +09610000
               TITLE='$TASK FAILURE'                                    09620000
                                                                        09630000
ERR$PROC DS    0H                                                       09640000
                                                                        09650000
         $ABEND ABE_VTDIAG,                                            +09660000
               SCOPE=PCB,                                              +09670000
               TITLE='$PROC FAILURE'                                    09680000
                                                                        09690000
ERR$SESS DS    0H                                                       09700000
                                                                        09710000
         $ABEND ABE_VTDIAG,                                            +09720000
               SCOPE=PCB,                                              +09730000
               TITLE='$SESS FAILURE'                                    09740000
                                                                        09750000
ERR$VTAM DS    0H                                                       09760000
                                                                        09770000
         $ABEND ABE_VTDIAG,                                            +09780000
               SCOPE=PCB,                                              +09790000
               TITLE='$VTAM FAILURE'                                    09800000
                                                                        09810000
ERRWORK  DS    0H                                                       09820000
                                                                        09830000
         $ABEND ABE_VTDIAG,                                            +09840000
               SCOPE=PCB,                                              +09850000
               TITLE='UNKNOWN WORK ELEMENT'                             09860000
                                                                        09870000
*---------------------------------------------------------------------- 09880000
*  CONSTANTS AND LITERALS                                               09890000
*---------------------------------------------------------------------- 09900000
                                                                        09910000
         LTORG ,                                                        09920000
         PRINT NOGEN                                                    09930000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                09940000
         ISTDBIND ,               VTAM BIND IMAGE                       09950000
         TRACODES ,               INTEGRATOR TRACE CODES                09960000
         ICVT  ,                  INTEGRATOR CVT                        09970000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   09980000
         IRPL ,                   INTEGRATOR VTAM RPL+                  09990000
         IACB ,                   INTEGRATOR VTAM ACB+                  10000000
         INIB ,                   INTEGRATOR VTAM NIB+                  10010000
         ISESS ,                  INTEGRATOR SESSION BLOCK              10020000
         IRQE ,                   INTEGRATOR RECEIVE QUEUE ELEMENT      10030000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            10040000
         ITASK ,                  INTEGRATOR TASK BLOCK                 10050000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          10060000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       10070000
         EVCODES ,                INTEGRATOR EVENT CODES                10080000
         ABCODES ,                INTEGRATOR $ABEND CODES               10090000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     10100000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        10110000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             10120000
         $PROC DSECT=YES          INTEGRATOR $PROC SERVICES             10130000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             10140000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             10150000
         $RESMGR DSECT=YES        INTEGRATOR $RESMGR SERVICES           10160000
         $WULOC DSECT=YES         INTEGRATOR $WULOC SERVICES            10170000
         IFGEXLST ,               VTAM EXIT LIST                        10180000
         END   ,                                                        10190000

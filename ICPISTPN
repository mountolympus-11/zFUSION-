ICPISTPN TITLE 'INTEGRATOR - CPIC CMSTPN API - SET TPN'                 00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: ICPISTPN - CPIC CMSTPN API                                   00100000
*                                                                       00110000
* DESCRIPTION:                                                          00120000
*                                                                       00130000
*    THIS ROUTINE IS CALLED TO PROCESS THE CMSTPN VERB.                 00140000
*                                                                       00150000
* ON ENTRY:                                                             00160000
*                                                                       00170000
*    R15 = ENTRY POINT ADDRESS                                          00180000
*    R14 = RETURN      ADDRESS                                          00190000
*    R13 = SAVE AREA   ADDRESS                                          00200000
*    R01 = PARM LIST   ADDRESS                                          00210000
*                                                                       00220000
*          +00 = ADDRESS OF CONVERSATION_ID                             00230000
*          +04 = ADDRESS OF TPN                                         00240000
*          +08 = ADDRESS OF TPN_LENGTH                                  00250000
*          +0C = ADDRESS OF RETURN_CODE RETURN AREA                     00260000
*                                                                       00270000
* ON EXIT:                                                              00280000
*                                                                       00290000
*    R15 = 0                                                            00300000
*                                                                       00310000
*    RETURN_CODE = CM_OK                      --> CMSTPN SUCCESSFUL     00320000
*                = CM_PROGRAM_PARAMETER_CHECK --> INVALID CONV_ID, ETC. 00330000
*                = CM_PROGRAM_STATE_CHECK     --> INVALID STATE         00340000
*                = CM_PRODUCT_SPECIFIC_ERROR  --> BAD PARM              00350000
*                = CM_OPERATION_NOT_ACCEPTED  --> N/A                   00360000
*                                                                       00370000
**<DOC-OFF>************************************************************ 00380000
         EJECT ,                                                        00390000
*********************************************************************** 00400000
*                                                                       00410000
* MAINTENANCE:                                                          00420000
*                                                                       00430000
*   07/01/94 RANDY WITEK                                                00440000
*                                                                       00450000
*********************************************************************** 00460000
                                                                        00470000
         EQUS  ,                  GENERAL EQUATES                       00480000
                                                                        00490000
RICVT    EQU   R11                                                      00500000
RITASK   EQU   R10                                                      00510000
RBASE    EQU   R9                                                       00520000
RIVTAM   EQU   R8                                                       00530000
RCMLIST  EQU   R7                                                       00540000
RTKB     EQU   R6                                                       00550000
RRCB     EQU   R5                                                       00560000
                                                                        00570000
         USING DSA,R13            ESTABLISH ADDRESSABILITY              00580000
         USING CRAB,R12           ESTABLISH ADDRESSABILITY              00590000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00600000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00610000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00620000
         USING CMLIST,RCMLIST     ESTABLISH ADDRESSABILITY              00630000
         USING TKB,RTKB           ESTABLISH ADDRESSABILITY              00640000
         USING RCB,RRCB           ESTABLISH ADDRESSABILITY              00650000
                                                                        00660000
         COPY  CRAB               "C" RUNTIME ANCHOR BLOCK              00670000
         COPY  DSA                DYNAMIC SAVE AREA                     00680000
WORKAREA DS    0D                 READ/WRITE WORKAREA                   00690000
WRK256   DS    XL256              GENERAL WORKAREA                      00700000
                                                                        00710000
CONVID   DS    XL8                TEMPORARY CONVERSATION ID AREA        00720000
RETCODE  DS    F                  TEMPORARY RETURN CODE     AREA        00730000
TPNL     DS    F                  TEMPORARY TPN LENGTH      AREA        00740000
TPN      DS    CL64               TEMPORARY TPN             AREA        00750000
CONVS    DS    F                  TEMPORARY CONV STATE      AREA        00760000
                                                                        00770000
FLAG     DS    X                                                        00780000
FLAGIERR EQU   X'80'                                                    00790000
FLAGIER2 EQU   X'40'                                                    00800000
         DS    0D                                                       00810000
WORKLEN  EQU   *-WORKAREA         LENGTH OF USER DSA AREA               00820000
DSALEN   EQU   *-DSA              LENGTH OF DSA                         00830000
                                                                        00840000
         $MSGDFT PREFIX=ICTPID,                                        +00850000
               COMPID='CPI',                                           +00860000
               TABLE=*#MSGS,                                           +00870000
               WORKA=0,                                                +00880000
               MF=(E,WRK256),                                          +00890000
               PRINT=NOGEN                                              00900000
                                                                        00910000
ICPSTPN@ CSECT ,                                                        00920000
ICPISTPN CENTRY DSA=DSALEN,BASE=RBASE,INDEP=YES                         00930000
                                                                        00940000
*---------------------------------------------------------------------- 00950000
* ENTRY                                                                 00960000
*---------------------------------------------------------------------- 00970000
                                                                        00980000
         LR    RCMLIST,R1         SAVE ADDRESS OF PLIST                 00990000
                                                                        01000000
         LA    R0,WORKAREA        ADDRESS OF USER DSA SECTION           01010000
         LA    R1,WORKLEN         LENGTH  OF USER DSA SECTION           01020000
         SR    R15,R15            PREPARE FOR CLEAR                     01030000
         MVCL  R0,R14             CLEAR USER DSA SECTION                01040000
                                                                        01050000
*---------------------------------------------------------------------- 01060000
* INITIALIZATION                                                        01070000
*---------------------------------------------------------------------- 01080000
                                                                        01090000
         @RESTENV ,               ENSURE ENVIRONMENT                    01100000
                                                                        01110000
         L     RIVTAM,ICTVTCVT    ESTABLISH IVTAMCVT POINTER            01120000
                                                                        01130000
         MVC   CONVID,=XL8'55AA55AA55AA55AA'                            01140000
         MVC   CONVS,=XL4'55AA55AA'                                     01150000
         MVC   TPNL,=XL4'55AA55AA'                                      01160000
         MVC   TPN(2),=XL2'55AA'                                        01170000
         MVC   TPN+2(62),TPN                                            01180000
                                                                        01190000
         L     R1,CMLPARM4        ADDRESS OF RETURN_CODE AREA           01200000
         MVC   0(4,R1),0(R1)      TEST MOVEMENT                         01210000
                                                                        01220000
         ICM   R1,15,CMLPARM1     ADDRESS OF CONVERSATION ID            01230000
         BNP   INITERR            BRANCH IF BAD                         01240000
         MVC   CONVID,0(R1)       COPY CONVID                           01250000
                                                                        01260000
         ICM   R1,15,CMLPARM3     ADDRESS OF TPN LENGTH                 01270000
         BNP   INITERR            BRANCH IF BAD                         01280000
         MVC   TPNL,0(R1)         COPY TPN LENGTH                       01290000
         ICM   R1,15,TPNL         GET TPN LENGTH                        01300000
         BNP   INITERR2           ERROR IF NEGATIVE OR ZERO             01310000
         C     R1,=F'64'          IS LENGTH VALID                       01320000
         BH    INITERR2           BRANCH IF NOT                         01330000
                                                                        01340000
         ICM   R0,15,CMLPARM2     ADDRESS OF TPN                        01350000
         BNP   INITERR            BRANCH IF BAD                         01360000
                                                                        01370000
         LA    R14,TPN            TPN HOLDING AREA                      01380000
         LA    R15,64             MAXIMUM LENGTH                        01390000
         ICM   R1,B'1000',=C' '   BLANK PAD                             01400000
         MVCL  R14,R0             COPY THE TPN TO HOLDING AREA          01410000
         B     INITEND                                                  01420000
                                                                        01430000
INITERR  DS    0H                                                       01440000
                                                                        01450000
         OI    FLAG,FLAGIERR      REMEMBER ERROR DETECTED               01460000
         B     INITEND                                                  01470000
                                                                        01480000
INITERR2 DS    0H                                                       01490000
                                                                        01500000
         OI    FLAG,FLAGIER2      REMEMBER ERROR DETECTED               01510000
                                                                        01520000
INITEND  DS    0H                                                       01530000
                                                                        01540000
*---------------------------------------------------------------------- 01550000
* ENTRY TRACE                                                           01560000
*---------------------------------------------------------------------- 01570000
                                                                        01580000
         $TRACE *=A(TRC_CPIC_ICPISTPN),112 TRACE ENTRY W/112 USER BYTES 01590000
         BNZ   NOETRACE                    BRANCH IF NOT TRACING        01600000
         $APITRC ICPISTPN                  TRACE COMMON STUFF           01610000
         ST    RCMLIST,24(,R1)             TRACE PARMLIST ADDRESS       01620000
         MVC   32(8,R1),CONVID             TRACE CONVERSATION ID        01630000
         MVC   28(4,R1),TPNL               TRACE TPN LENGTH             01640000
         MVC   40(64,R1),TPN               TRACE TPN                    01650000
NOETRACE DS    0H                                                       01660000
                                                                        01670000
*---------------------------------------------------------------------- 01680000
* LOCATE SPECIFIED CONVERSATION                                         01690000
*---------------------------------------------------------------------- 01700000
                                                                        01710000
         TM    FLAG,FLAGIERR             INIT ERROR?                    01720000
         BO    ERRPROD                   BRANCH IF YES                  01730000
                                                                        01740000
         TM    FLAG,FLAGIER2             INIT ERROR?                    01750000
         BO    ERRPARM                   BRANCH IF YES                  01760000
                                                                        01770000
         LA    R1,CONVID                 ADDRESS OF CONVERSATION ID     01780000
         L     R15,ICP@LOC               ENTRY POINT OF TKB/RCB LOCATE  01790000
         BASR  R14,R15                   LOCATE THE TKB/RCB             01800000
         LTR   RTKB,R1                   TKB ADDRESS                    01810000
         BNP   ERRPARM                   BRANCH IF BAD                  01820000
         LTR   RRCB,R0                   RCB ADDRESS                    01830000
         BNP   ERRPARM                   BRANCH IF BAD                  01840000
                                                                        01850000
         MVC   CONVS,RCBCONVS            COPY CONV STATE                01860000
                                                                        01870000
*---------------------------------------------------------------------- 01880000
* STATE CHECK                                                           01890000
*---------------------------------------------------------------------- 01900000
                                                                        01910000
         CLC   CONVS,=A(CM_INITIALIZE_STATE)                            01920000
         BNE   ERRSTATE                                                 01930000
                                                                        01940000
*---------------------------------------------------------------------- 01950000
* PERFORM REQUESTED PARAMETER CHANGE                                    01960000
*---------------------------------------------------------------------- 01970000
                                                                        01980000
         MVC   RCBTPNM(64),TPN    SET THE NEW VALUE                     01990000
         MVC   RCBTPNML,TPNL      SET THE NEW VALUE                     02000000
         B     RETURN                                                   02010000
                                                                        02020000
*---------------------------------------------------------------------- 02030000
* EXCEPTION ROUTINES                                                    02040000
*---------------------------------------------------------------------- 02050000
                                                                        02060000
ERRPROD  DS    0H                                                       02070000
                                                                        02080000
         MVC   RETCODE,=A(CM_PRODUCT_SPECIFIC_ERROR)                    02090000
         B     RETURN                                                   02100000
                                                                        02110000
ERRSTATE DS    0H                                                       02120000
                                                                        02130000
         MVC   RETCODE,=A(CM_PROGRAM_STATE_CHECK)                       02140000
         B     RETURN                                                   02150000
                                                                        02160000
ERRPARM  DS    0H                                                       02170000
                                                                        02180000
         MVC   RETCODE,=A(CM_PROGRAM_PARAMETER_CHECK)                   02190000
         B     RETURN                                                   02200000
                                                                        02210000
*---------------------------------------------------------------------- 02220000
* EXIT TRACE AND RETURN TO CALLER                                       02230000
*---------------------------------------------------------------------- 02240000
                                                                        02250000
RETURN   DS    0H                                                       02260000
                                                                        02270000
         $TRACE *=A(TRC_CPIC_EXIT),48 TRACE ENTRY                       02280000
         BNZ   NOXTRACE               BRANCH IF TRACING NOT AVAILABLE   02290000
         MVC   0(8,R1),=CL8'ICPISTPN' MODULE NAME                       02300000
         MVC   8(4,R1),RETCODE        RETURN_CODE VALUE                 02310000
         MVC   12(8,R1),CONVID        CONVERSATION ID                   02320000
         MVC   20(4,R1),CONVS         CONVERSATION STATE                02330000
         MVC   24(4,R1),TPNL          TPN LENGTH                        02340000
         CLC   RETCODE,=A(CM_OK)      SHOULD WE TRACE DATA?             02350000
         BNE   NOXTRACE               BRANCH IF NOT                     02360000
         ICM   R3,15,TPNL             IS THERE DATA TO TRACE?           02370000
         BNP   NOXTRACE               BRANCH IF NOT                     02380000
         LA    R2,TPN                 START OF TPN                      02390000
         SR    R4,R4                  STARTING OFFSET                   02400000
         $TRACE *=A(TRC_CPIC_TPN_NAME),80 TPN NAME TRACE                02410000
         BNZ   NOXTRACE               BRANCH IF TRACING NOT AVAILABLE   02420000
         MVC   0(8,R1),CONVID         CONVERSATION ID                   02430000
         ST    R3,8(,R1)              LENGTH OF TPN                     02440000
         ST    R4,12(,R1)             SET STARTING OFFSET IN BUFFER     02450000
         LA    R14,16(,R1)            ADDRESS OF TPN DATA AREA          02460000
         LA    R15,64                 MAX OF 64 BYTES                   02470000
         MVCL  R14,R2                 TRACE THE TPN                     02480000
NOXTRACE DS    0H                                                       02490000
                                                                        02500000
         L     R1,CMLPARM4        ADDRESS OF RETURN_CODE AREA           02510000
         MVC   0(4,R1),RETCODE    SET RETURN_CODE VARIABLE              02520000
                                                                        02530000
         SR    R15,R15            FUNCTION RETURN CODE = 0              02540000
         CEXIT RC=(R15),INDEP=YES RETURN                                02550000
                                                                        02560000
*---------------------------------------------------------------------- 02570000
* LITERALS AND CONSTANTS                                                02580000
*---------------------------------------------------------------------- 02590000
                                                                        02600000
         LTORG ,                                                        02610000
                                                                        02620000
         PRINT NOGEN                                                    02630000
         ISTDBIND ,               VTAM BIND IMAGE                       02640000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                02650000
         IKJTCB ,                 MVS TASK CONTROL BLOCK                02660000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         02670000
         ICVT  ,                  INTEGRATOR CVT                        02680000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   02690000
         ITASK ,                  INTEGRATOR TASK BLOCK                 02700000
         IPCB ,                   INTEGRATOR PROCESS BLOCK              02710000
         ABCODES ,                INTEGRATOR $ABEND CODES               02720000
         EVCODES ,                INTEGRATOR EVENT CODES                02730000
         END   ,                                                        02740000

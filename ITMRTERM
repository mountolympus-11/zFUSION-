ITMRTERM TITLE 'SHUTDOWN $TIMER FACILITY'                               00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: ITMRTERM - Shutdown $TIMER facility                          00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine is used to shutdown the $TIMER facility,              00080000
*    cancelling residual STIMERMs, deleting TQEs and removing           00090000
*    the timer queue array in the process.                              00100000
*                                                                       00110000
* ON ENTRY:                                                             00120000
*                                                                       00130000
*    N/A                                                                00140000
*                                                                       00150000
* ON EXIT:                                                              00160000
*                                                                       00170000
*    R15 contains zero                                                  00180000
*                                                                       00190000
**<DOC-OFF>****************************************************         00200000
                                                                        00210000
         EJECT ,                                                        00220000
***************************************************************         00230000
*                                                                       00240000
* MAINTENANCE:                                                          00250000
*                                                                       00260000
*   09/13/94 R. TURGEON                                                 00270000
*            Initial version                                            00280000
*   08/18/95 Randy Witek - support $TIMER EXIT= and PARM=               00290000
*                                                                       00300000
***************************************************************         00310000
                                                                        00320000
         EJECT                                                          00330000
         #WORK ,                                                        00340000
                                                                        00350000
$STIMMFL STIMERM CANCEL,MF=L                                            00360000
                                                                        00370000
         #ENDWORK ,                                                     00380000
                                                                        00390000
         EJECT                                                          00400000
         $TIMEHDR ,               $TIMER STIMER LINKAGE TABLE           00410000
                                                                        00420000
         EJECT                                                          00430000
         $TQE                     $TIMER QUEUE ENTRY                    00440000
                                                                        00450000
         EJECT                                                          00460000
         EQUS  ,                                                        00470000
                                                                        00480000
         EJECT                                                          00490000
ITMRTERM #ENTER ,                                                       00500000
                                                                        00510000
         USING ITASK,R10          $TIMER MANAGER ITASK                  00520000
                                                                        00530000
*--------------------------------------------------------------         00540000
*   DETACH TIMER QUEUE FROM THE ICVT PREVENTING FURTHER REQS            00550000
*--------------------------------------------------------------         00560000
         ICM   R5,15,ICTTIME      TIME QUEUE HEADER ARRAY               00570000
         BZ    RETURN             $TIMER FACILITY NOT INSTALLED         00580000
         XC    ICTTIME,ICTTIME    DETACH FROM ICVT                      00590000
                                                                        00600000
*---------------------------------------------------------------        00610000
*   RUN ALL TIMER QUEUES DEACTIVATING TIMERS                            00620000
*---------------------------------------------------------------        00630000
         LR    R6,R5              ROVING TIMEHDR PTR                    00640000
         USING TIMEHDR,R6         PREPARE FOR SCAN                      00650000
         LA    R7,TIMH#ENT        NUMBER OF TIMER QUEUES                00660000
                                                                        00670000
NEXTHDR  DS    0H                                                       00680000
         ICM   R0,15,TIMHSYS      STIMERM TIMER ACTIVE?                 00690000
         BZ    FREETQE            SKIP IF NOT                           00700000
                                                                        00710000
         STIMERM CANCEL,ID=TIMHSYS,ERRET=FREETQE,MF=(E,$STIMMFL)        00720000
                                                                        00730000
*---------------------------------------------------------------        00740000
*   DELETE ALL TQE'S QUEUED TO THE TIMER QUEUE HDR                      00750000
*---------------------------------------------------------------        00760000
FREETQE  DS    0H                                                       00770000
         ICM   R4,15,TIMHTQE      QUEUED TQES?                          00780000
         BZ    NEXTADV            DONE IF NOT                           00790000
         USING TQE,R4                                                   00800000
         MVC   TIMHTQE,TQENEXT    DEQUEUE THE LEAD TQE                  00810000
                                                                        00820000
         $RETSTOR (R4),QHDR=TIMHSTOR                                    00830000
                                                                        00840000
         B     FREETQE                                                  00850000
         DROP  R4                 TQE                                   00860000
                                                                        00870000
*---------------------------------------------------------------        00880000
*   SCAN ALL TIMER QUEUES                                               00890000
*---------------------------------------------------------------        00900000
NEXTADV  DS    0H                                                       00910000
         LA    R6,TIMEHDRL(,R6)   ADVANCE TO NEXT TIMER QUEUE HDR       00920000
         BCT   R7,NEXTHDR         PROCESS ALL QUEUES                    00930000
         DROP  R6                 TIMEHDR                               00940000
                                                                        00950000
*---------------------------------------------------------------        00960000
*   DELETE THE TIMER QUEUE HDR ARRAY                                    00970000
*---------------------------------------------------------------        00980000
         LA    R2,TIMEHDRL        LENGTH OF EACH QUEUE HDR              00990000
         MH    R2,=AL2(TIMH#ENT)  TOTAL SIZE OF HDR ARRAY               01000000
                                                                        01010000
         STGRETN ADDR=(R5),LEN=(R2),QH=ICTSTG                           01020000
                                                                        01030000
*--------------------------------------------------------------         01040000
*   RETURN TO CALLER                                                    01050000
*--------------------------------------------------------------         01060000
RETURN   DS    0H                                                       01070000
         SR    R15,R15            RETURN CODES UNDEFINED                01080000
                                                                        01090000
         #EXIT ,                                                        01100000
                                                                        01110000
         EJECT                                                          01120000
****************************************************************        01130000
*                                                                       01140000
*   LOCAL READ-ONLY DATA AREAS                                          01150000
*                                                                       01160000
****************************************************************        01170000
         LTORG ,                                                        01180000
                                                                        01190000
         PRINT NOGEN                                                    01200000
         ICVT  ,                                                        01210000
         ITASK ,                                                        01220000
         END   ,                                                        01230000

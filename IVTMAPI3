IVTMAPI3 TITLE 'INTEGRATOR - VTAM SERVICES API (PART 3)'                00010000
**<DOC-ON>************************************************************* 00020000
*                                                                       00030000
* ROUTINE: IVTMAPI3 - INTEGRATOR VTAM SERVICES API (PART 3)             00040000
*                                                                       00050000
* DESCRIPTION: PERFORMS SERVICES REQUESTED VIA THE $VTAM MACRO.         00060000
*                                                                       00070000
* ON ENTRY:                                                             00080000
*                                                                       00090000
*    R15 = ENTRY POINT ADDRESS                                          00100000
*    R14 = RETURN ADDRESS                                               00110000
*    R13 = AVAILABLE SAVE AREA                                          00120000
*    R11 = ICVT ADDRESS                                                 00130000
*    R10 = ITASK ADDRESS                                                00140000
*    R09 = IVTAMCVT ADDRESS                                             00150000
*    R01 = $VTAM PARAMETER LIST ADDRESS                                 00160000
*          (SEE COMMENTS FOR SPECIFIC SERVICE BEING CALLED)             00170000
*                                                                       00180000
* ON EXIT:                                                              00190000
*                                                                       00200000
*    R15 = SEE COMMENTS FOR SPECIFIC SERVICE BEING CALLED               00210000
*    R00 = SEE COMMENTS FOR SPECIFIC SERVICE BEING CALLED               00220000
*    R01 = SEE COMMENTS FOR SPECIFIC SERVICE BEING CALLED               00230000
*                                                                       00240000
*    ALL OTHER REGISTERS ARE RESTORED                                   00250000
*                                                                       00260000
**<DOC-OFF>************************************************************ 00270000
                                                                        00280000
         EJECT ,                                                        00290000
*********************************************************************** 00300000
*                                                                       00310000
* MAINTENANCE:                                                          00320000
*                                                                       00330000
*   08/01/93 RANDY WITEK                                                00340000
*                                                                       00350000
*********************************************************************** 00360000
                                                                        00370000
         EQUS  ,                  GENERAL EQUATES                       00380000
                                                                        00390000
RICVT    EQU   R11                                                      00400000
RITASK   EQU   R10                                                      00410000
RIVTAM   EQU   R9                                                       00420000
RIACB    EQU   R8                                                       00430000
RIRPL    EQU   R7                                                       00440000
RIVUSER  EQU   R6                                                       00450000
RIWE     EQU   R5                                                       00460000
RISESS   EQU   R4                                                       00470000
                                                                        00480000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00490000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00500000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00510000
         USING IACB,RIACB         ESTABLISH ADDRESSABILITY              00520000
         USING IRPL,RIRPL         ESTABLISH ADDRESSABILITY              00530000
         USING IVUSER,RIVUSER     ESTABLISH ADDRESSABILITY              00540000
         USING IWEVTAM,RIWE       ESTABLISH ADDRESSABILITY              00550000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00560000
                                                                        00570000
*---------------------------------------------------------------------- 00580000
*   S A V E   A N D   W O R K I N G   S T O R A G E                     00590000
*---------------------------------------------------------------------- 00600000
                                                                        00610000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00620000
WRK256   DS    XL256              GENERAL WORKAREA                      00630000
LV0SAVE  DS    18F                SUBROUTINE SAVE AREA                  00640000
$VTAMMFL $VTAM MF=L               $VTAM PLIST COPY AREA                 00650000
RETR15   DS    F                  RETURN CODE                           00660000
RETR0    DS    F                  RETURN REGISTER 0                     00670000
RETR1    DS    F                  RETURN REGISTER 1                     00680000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00690000
FLAG     DS    X                                                        00700000
FLAGLOCK EQU   X'80'              VTAM GLOBAL LOCK HELD                 00710000
FLAGLCKD EQU   X'40'              VTAM GLOBAL LOCK HELD ON ENTRY        00720000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00730000
                                                                        00740000
*---------------------------------------------------------------------- 00750000
*   M E S S A G E   D E F A U L T S                                     00760000
*---------------------------------------------------------------------- 00770000
                                                                        00780000
         $MSGDFT PREFIX=ICTPID,COMPID='VTM',TABLE=*#MSGS,              +00790000
               PRINT=NOGEN,WORKA=0,MF=(E,WRK256)                        00800000
                                                                        00810000
*---------------------------------------------------------------------- 00820000
*   M O D U L E   E N T R Y                                             00830000
*---------------------------------------------------------------------- 00840000
                                                                        00850000
IVTMAPI3 #ENTER BASE=R12,         R12 IS BASE REGISTER                 +00860000
               AMODE=31,                                               +00870000
               RMODE=ANY,                                              +00880000
               SAVE=YES,          ALLOCATE SAVE/WORK AREA              +00890000
               PREG=R2,           SAVE R1 PARM IN R2                   +00900000
               RESTENV=NO,        ICVT AND ITASK POINTERS ARE OK       +00910000
               WAPASS=NO,         NO WORK AREA PASSED IN R0            +00920000
               LINKAGE=STD        CALLED BY BAS/BASR                    00930000
                                                                        00940000
         L     RIVTAM,ICTVTCVT    SET IVTAMCVT BASE                     00950000
                                                                        00960000
*---------------------------------------------------------------------- 00970000
* SET BLOCK ID                                                          00980000
*---------------------------------------------------------------------- 00990000
                                                                        01000000
         MVC   VPLID-VPLIST(4,R2),=CL4'VPL '                            01010000
                                                                        01020000
*---------------------------------------------------------------------- 01030000
* COPY PARM LIST TO WORKING STORAGE                                     01040000
*---------------------------------------------------------------------- 01050000
                                                                        01060000
         MVC   $VTAMMFL(L'VPL),0(R2) COPY PARM LIST TO WORKING AREA     01070000
         USING VPLIST,$VTAMMFL                                          01080000
                                                                        01090000
*---------------------------------------------------------------------- 01100000
* TRACE THE MODULE ENTRY                                                01110000
*---------------------------------------------------------------------- 01120000
                                                                        01130000
         $TRACE *=A(TRC_IVTMAPIX_ENTER),48 TRACE ENTRY W/ 48 USER BYTES 01140000
         BNZ   NOETRACE                    BRANCH IF NOT TRACING        01150000
         $APITRC IVTMAPI3                  TRACE COMMON STUFF           01160000
         MVC   24(4,R1),VPLFUNC            TRACE FUNC & FLAGS           01170000
         L     R14,4(,R13)                 CALLER'S SAVE AREA           01180000
         MVC   28(4,R1),24(R14)            TRACE VPLIST ADDRESS         01190000
         MVC   32(4,R1),VPLTASK            TRACE PROVIDED ITASK ADDRESS 01200000
         MVC   36(4,R1),VPLAREA            TRACE PROVIDED AREA  ADDRESS 01210000
NOETRACE DS    0H                                                       01220000
                                                                        01230000
*---------------------------------------------------------------------- 01240000
* JUMP TO PROCESSING ROUTINE BASED ON REQUEST CODE                      01250000
*---------------------------------------------------------------------- 01260000
                                                                        01270000
         SR    R1,R1              CLEAR                                 01280000
         ICM   R1,B'0011',VPLFUNC LOAD REQUEST CODE                     01290000
         S     R1,=F'24'          NORMALIZE FUNCTION CODE TO 0          01300000
         SLL   R1,2               MULTIPLY BY 4                         01310000
         C     R1,=A(MAXFUNC)     IS REQUEST CODE VALID?                01320000
         BNH   REQTABLE(R1)       BRANCH TO ROUTINE IF VALID            01330000
         MVC   RETR15,=F'-1'      SET RC=-1                             01340000
         B     RETURN             EXIT TO CALLER                        01350000
                                                                        01360000
REQTABLE B     VALISESS        24 VALIDATE ISESS ON IACB                01370000
MAXFUNC  EQU   (*-REQTABLE)-4                                           01380000
                                                                        01390000
*---------------------------------------------------------------------- 01400000
* REQUEST 24 - VALIDATE A GIVEN ISESS/IACB PAIR                         01410000
*                                                                       01420000
* ENTRY  VALUES: R01 = ADDRESS OF $VTAM SERVICES PARAMETER LIST         01430000
*                VPLFUNC  = 24                                          01440000
*                VPLAREA  = ADDRESS OF ISESS TO BE VALIDATED            01450000
*                VPLAREAL = ADDRESS OF IACB                             01460000
*                                                                       01470000
* RETURN VALUES: R15 = 0 --> ISESS EXISTS FOR GIVEN IACB                01480000
*                    =!0 --> ISESS DOES NOT EXIST FOR GIVEN IACB        01490000
*                R00 = 0                                                01500000
*                R01 = 0                                                01510000
*                                                                       01520000
*---------------------------------------------------------------------- 01530000
                                                                        01540000
VALISESS DS    0H                                                       01550000
                                                                        01560000
         ICM   R3,15,VPLAREA             ADDRESS OF ISESS BLOCK         01570000
         BZ    ERRSESS                   BRANCH IF INVALID              01580000
         LA    R3,0(,R3)                 ENSURE HI-BIT OFF              01590000
         ICM   RIACB,15,VPLAREAL         ADDRESS OF IACB                01600000
         BZ    ERRSESS                   BRANCH IF NO IACB              01610000
                                                                        01620000
         BAS   R14,VTAMLOCK                                             01630000
                                                                        01640000
         LR    RISESS,R3                 ISESS ADDRESS                  01650000
         N     RISESS,=X'000FFF00'       12-BITS INDEX 4096-WORD TABLE  01660000
         SRL   RISESS,6                  OFFSET OF ISESS ANCHOR         01670000
         AL    RISESS,IVT@STBL           ADDRESS OF ISESS CHAIN ANCHOR  01680000
         S     RISESS,=A(ISEISENX-ISE)   NORMALIZE FOR CHAIN RUN        01690000
                                                                        01700000
VALISERN DS    0H                                                       01710000
                                                                        01720000
         ICM   RISESS,15,ISEISENX        LINK TO NEXT ISESS             01730000
         BZ    RETURN4                   BRANCH IF NOT FOUND IN CHAIN   01740000
         CR    RISESS,R3                 IS THIS THE ISESS?             01750000
         BE    VALISEGO                  BRANCH IF YES                  01760000
         B     VALISERN                  BRANCH IF NOT TO CONTINUE      01770000
                                                                        01780000
VALISEGO DS    0H                                                       01790000
                                                                        01800000
         C     RIACB,ISEACB@             IS ISESS ON GIVEN IACB?        01810000
         BE    RETURN                    BRANCH IF YES                  01820000
         B     RETURN4                   BRANCH IF NOT                  01830000
                                                                        01840000
*---------------------------------------------------------------------- 01850000
*   SET RETURN CODE OF 4                                                01860000
*---------------------------------------------------------------------- 01870000
                                                                        01880000
RETURN4  DS    0H                                                       01890000
                                                                        01900000
         MVI   RETR15+(L'RETR15-1),4                                    01910000
         B     RETURN                                                   01920000
                                                                        01930000
*---------------------------------------------------------------------- 01940000
*   R E T U R N   T O   C A L L E R                                     01950000
*---------------------------------------------------------------------- 01960000
                                                                        01970000
*---------------------------------------------------------------------- 01980000
* TRACE THE MODULE EXIT                                                 01990000
*---------------------------------------------------------------------- 02000000
                                                                        02010000
RETURN   DS    0H                                                       02020000
                                                                        02030000
         $TRACE *=A(TRC_IVTMAPIX_EXIT),16 TRACE ENTRY W/ 16 USER BYTES  02040000
                                                                        02050000
         BNZ   NOXTRACE           BRANCH IF TRACING NOT AVAILABLE       02060000
                                                                        02070000
         MVC   0(4,R1),VPLFUNC    TRACE $VTAM FUNCTION CODE             02080000
         MVC   4(12,R1),RETREGS   TRACE 15,0,1 RETURN REGISTERS         02090000
                                                                        02100000
NOXTRACE DS    0H                                                       02110000
                                                                        02120000
         BAS   R14,VTAMUNLK       RELEASE SERIALIZATION IF APPROPRIATE  02130000
                                                                        02140000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 02150000
                                                                        02160000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    02170000
                                                                        02180000
*---------------------------------------------------------------------- 02190000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 02200000
*---------------------------------------------------------------------- 02210000
                                                                        02220000
VTAMLOCK DS    0H                                                       02230000
                                                                        02240000
         TM    FLAG,FLAGLOCK        HAVE WE ALREADY GOTTEN THE LOCK?    02250000
         BOR   R14                  BRANCH IF YES                       02260000
         STM   R14,R2,LV0SAVE       SAVE CALLER'S REGISTERS             02270000
                                                                        02280000
         $SER  OBTAIN,                                                 +02290000
               VTAM                                                     02300000
                                                                        02310000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              02320000
         BNE   VTAMLOEX             BRANCH IF NOT                       02330000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         02340000
                                                                        02350000
VTAMLOEX DS    0H                                                       02360000
                                                                        02370000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               02380000
         LM    R14,R2,LV0SAVE       RESTORE CALLER'S REGISTERS          02390000
         BR    R14                  RETURN                              02400000
                                                                        02410000
*---------------------------------------------------------------------- 02420000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                02430000
*---------------------------------------------------------------------- 02440000
                                                                        02450000
VTAMUNLK DS    0H                                                       02460000
                                                                        02470000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       02480000
         BNOR  R14                  BRANCH IF NOT                       02490000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             02500000
         BOR   R14                  DON'T RELEASE IF IT WAS             02510000
         STM   R14,R2,LV0SAVE       SAVE CALLER'S REGISTERS             02520000
                                                                        02530000
         $SER  RELEASE,                                                +02540000
               VTAM                                                     02550000
                                                                        02560000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  02570000
         LM    R14,R2,LV0SAVE       RESTORE CALLER'S REGISTERS          02580000
         BR    R14                  RETURN                              02590000
                                                                        02600000
*---------------------------------------------------------------------- 02610000
*   E R R O R   R O U T I N E S                                         02620000
*---------------------------------------------------------------------- 02630000
                                                                        02640000
ERRSESS  DS    0H                                                       02650000
                                                                        02660000
         $ABEND ABE_VTDIAG,                                            +02670000
               SCOPE=PCB,                                              +02680000
               TITLE='INVALID ISESS DETECTED'                           02690000
                                                                        02700000
*---------------------------------------------------------------------- 02710000
*   C O N S T A N T S   A N D   L I T E R A L S                         02720000
*---------------------------------------------------------------------- 02730000
                                                                        02740000
         LTORG ,                                                        02750000
                                                                        02760000
         PRINT NOGEN                                                    02770000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                02780000
         ISTDBIND ,               VTAM BIND IMAGE                       02790000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         02800000
         ICVT  ,                  INTEGRATOR CVT                        02810000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   02820000
         ITASK ,                  INTEGRATOR TASK BLOCK                 02830000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            02840000
         IACB ,                   INTEGRATOR VTAM ACB+                  02850000
         IRPL ,                   INTEGRATOR VTAM RPL+                  02860000
         INIB ,                   INTEGRATOR VTAM NIB+                  02870000
         ISESS ,                  INTEGRATOR SESSION CONTROL            02880000
         IPOOL ,                  INTEGRATOR POOL CONTROL BLOCK         02890000
         ISQE ,                   INTEGRATOR SESSION INIT QUEUE ELEMENT 02900000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENTS         02910000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       02920000
         EVCODES ,                INTEGRATOR EVENT CODES                02930000
         ABCODES ,                INTEGRATOR $ABEND CODES               02940000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     02950000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             02960000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             02970000
         IFGEXLST ,               VTAM EXIT LIST                        02980000
         END   ,                                                        02990000

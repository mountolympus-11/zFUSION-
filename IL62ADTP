IL62ADTP TITLE 'INTEGRATOR - LU6.2 DELETE TRANSACTION PROGRAM'          00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: IL62ADTP - LU6.2 DELETE TRANSACTION PROGRAM                  00100000
*                                                                       00110000
* DESCRIPTION:                                                          00120000
*                                                                       00130000
*    THIS ROUTINE IS CALLED TO REDUCE A TRANSACTION PROGRAM USE COUNT.  00140000
*                                                                       00150000
* ON ENTRY:                                                             00160000
*                                                                       00170000
*    R15 = ENTRY POINT ADDRESS                                          00180000
*    R14 = RETURN      ADDRESS                                          00190000
*    R13 = SAVE AREA   ADDRESS                                          00200000
*    R01 = PARM LIST   ADDRESS                                          00210000
*                                                                       00220000
*          +00 = ADDRESS OF TRANSACTION PROGRAM NAME                    00230000
*          +04 = ADDRESS OF RETURN CODE AREA                            00240000
*                                                                       00250000
* ON EXIT:                                                              00260000
*                                                                       00270000
*    R15 = 0                                                            00280000
*                                                                       00290000
*    RETURN_CODE = LU62_OK --> TRANSACTION PROGRAM DELETE CALL OK       00300000
*                                                                       00310000
*                = LU62_PRODUCT_SPECIFIC_ERROR --> DELETE FAILED        00320000
*                                                                       00330000
**<DOC-OFF>************************************************************ 00340000
         EJECT ,                                                        00350000
*********************************************************************** 00360000
*                                                                       00370000
* MAINTENANCE:                                                          00380000
*                                                                       00390000
*   07/01/94 RANDY WITEK                                                00400000
*                                                                       00410000
*********************************************************************** 00420000
                                                                        00430000
         EQUS  ,                  GENERAL EQUATES                       00440000
                                                                        00450000
RICVT    EQU   R11                                                      00460000
RITASK   EQU   R10                                                      00470000
RBASE    EQU   R9                                                       00480000
RIVTAM   EQU   R8                                                       00490000
RPLIST   EQU   R7                                                       00500000
RTPB     EQU   R6                                                       00510000
                                                                        00520000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00530000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00540000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00550000
         USING L62LIST,RPLIST     ESTABLISH ADDRESSABILITY              00560000
         USING TPB,RTPB           ESTABLISH ADDRESSABILITY              00570000
                                                                        00580000
         COPY  CRAB               "C" RUNTIME ANCHOR BLOCK              00590000
         USING CRAB,R12           ADDRESSABILITY                        00600000
                                                                        00610000
         COPY  DSA                DYNAMIC SAVE AREA                     00620000
WORKAREA DS    0H                 READ/WRITE WORKAREA                   00630000
WRK256   DS    XL256              GENERAL WORKAREA                      00640000
$TASKMFL $TASK MF=L                                                     00650000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00660000
TPNAME   DS    CL64               WORKING COPY OF TP NAME               00670000
LOADNAME DS    CL8                MVS LOAD MODULE NAME                  00680000
USECOUNT DS    F                  TPB USE COUNT AFTER DELETE TP         00690000
RETCODE  DS    F                  TEMPORARY RETURN CODE AREA            00700000
FLAG     DS    X                                                        00710000
FLAGLOCK EQU   X'80'                                                    00720000
FLAGLCKD EQU   X'40'                                                    00730000
WORKLEN  EQU   *-WORKAREA         LENGTH OF USER DSA AREA               00740000
DSALEN   EQU   *-DSA              LENGTH OF DSA                         00750000
                                                                        00760000
         $MSGDFT PREFIX=ICTPID,                                        +00770000
               COMPID='L62',                                           +00780000
               TABLE=*#MSGS,                                           +00790000
               WORKA=0,                                                +00800000
               MF=(E,WRK256),                                          +00810000
               PRINT=NOGEN                                              00820000
                                                                        00830000
IL6ADTP@ CSECT ,                                                        00840000
IL62ADTP CENTRY DSA=DSALEN,BASE=RBASE,INDEP=YES                         00850000
                                                                        00860000
         USING DSA,R13            ADDRESSABILITY                        00870000
         LR    RPLIST,R1          SAVE ADDRESS OF PLIST                 00880000
                                                                        00890000
         LA    R0,WORKAREA        ADDRESS OF USER DSA SECTION           00900000
         LA    R1,WORKLEN         LENGTH  OF USER DSA SECTION           00910000
         SR    R15,R15            PREPARE FOR CLEAR                     00920000
         MVCL  R0,R14             CLEAR USER DSA SECTION                00930000
                                                                        00940000
*---------------------------------------------------------------------- 00950000
* INITIALIZATION                                                        00960000
*---------------------------------------------------------------------- 00970000
                                                                        00980000
         @RESTENV ,               ENSURE ENVIRONMENT                    00990000
                                                                        01000000
         L     RIVTAM,ICTVTCVT    ESTABLISH IVTAMCVT POINTER            01010000
         USING IVTAMCVT,RIVTAM    ADDRESSABILITY                        01020000
         L     R2,L62PARM1        TPNAME ADDRESS                        01030000
         MVC   TPNAME,0(R2)       LOCAL COPY OF TPNAME                  01040000
         MVC   USECOUNT,=XL4'55AA55AA'                                  01050000
                                                                        01060000
*---------------------------------------------------------------------- 01070000
* ENTRY TRACE                                                           01080000
*---------------------------------------------------------------------- 01090000
                                                                        01100000
         $TRACE *=A(TRC_LU62_IL62ADTP),96 TRACE ENTRY W/ 96 USER BYTES  01110000
         BNZ   NOETRACE                   BRANCH IF NOT TRACING         01120000
         $APITRC IL62ADTP                 TRACE COMMON STUFF            01130000
         ST    RPLIST,24(,R1)             TRACE PARMLIST ADDRESS        01140000
         MVC   32(64,R1),TPNAME           TRACE TPNAME                  01150000
NOETRACE DS    0H                                                       01160000
                                                                        01170000
*---------------------------------------------------------------------- 01180000
* FIND THE REQUESTED TRANSACTION PROGRAM                                01190000
*---------------------------------------------------------------------- 01200000
                                                                        01210000
         BAS   R14,VTAMLOCK           SERIALIZE                         01220000
                                                                        01230000
         LA    RTPB,IVTTP1ST          GET SET TO RUN TPB CHAIN          01240000
         S     RTPB,=A(TPBNEXT-TPB)                                     01250000
                                                                        01260000
TPBRUN   DS    0H                                                       01270000
                                                                        01280000
         ICM   RTPB,15,TPBNEXT        LINK TO THE NEXT TPB              01290000
         BM    ERRPROD                BRANCH IF NOT FOUND               01300000
         CLC   TPNAME,TPBNAME         COMPARE THE NAMES                 01310000
         BH    TPBRUN                 BRANCH IF NEW NAME IS HIGH        01320000
         BL    ERRPROD                BRANCH IF NOT FOUND               01330000
                                                                        01340000
         TM    TPBF1,TPBF1LOD         IS THIS TP MVS LOADED?            01350000
         BO    DELMAIN                BRANCH IF YES                     01360000
         L     R1,TPBUSE              UPDATE USE COUNT                  01370000
         S     R1,=F'1'               UPDATE USE COUNT                  01380000
         ST    R1,TPBUSE              UPDATE USE COUNT                  01390000
         ST    R1,USECOUNT            SAVE FOR TRACE                    01400000
         BM    ERRCOUNT               BRANCH IF COUNT INVALID           01410000
         B     RETURN                 AND RETURN                        01420000
                                                                        01430000
*---------------------------------------------------------------------- 01440000
* DELETE A TP THAT WAS MVS LOADED UNDER THE MAIN TASK.                  01450000
*---------------------------------------------------------------------- 01460000
                                                                        01470000
DELMAIN  DS    0H                                                       01480000
                                                                        01490000
         C     RITASK,IVTITASK    EXECUTING IN VTAM MAIN TASK?          01500000
         BE    DLTPMAIN           BRANCH IF YES                         01510000
                                                                        01520000
*                                                                       01530000
* NO DELETES QUEUE DURING SYSTEM/VTAM TERMINATION                       01540000
*---------------------------------------------------------------------- 01550000
                                                                        01560000
         TM    ICTSTAT3,ICT3$P+ICT3$PX                                  01570000
         BNZ   RETURN             BRANCH IF SYSTEM TERMINATING          01580000
         TM    IVTF1,IVTF1TRM                                           01590000
         BO    RETURN             BRANCH IF VTAM MAIN TASK TERMINATING  01600000
                                                                        01610000
         BAS   R14,VTAMUNLK       RELEASE SERIALIZATION                 01620000
                                                                        01630000
         $VTAMWE L'IWEXV,         SIZE                                 +01640000
               IWECDLTP           CODE                                  01650000
                                                                        01660000
         LR    R4,R1              SAVE WE ADDRESS                       01670000
                                                                        01680000
         USING IWEVTAM,R4                                               01690000
                                                                        01700000
         $TASK SETEPB,            INITIALIZE EPB TO WAIT FOR DEFINE    +01710000
               ECODE=EC$62DT,     DELETE TP EVENT                      +01720000
               ERRET=ERR$TASK,    ABEND ON SERVICE ERROR               +01730000
               MF=(E,$TASKMFL)                                          01740000
                                                                        01750000
         LR    R3,R1              SAVE XEPB ADDRESS                     01760000
                                                                        01770000
         ST    R3,IWEXVEPB        SET XEPB ADDRESS IN WORK ELEMENT      01780000
         L     R1,TSKPCBC         CURRENT PCB                           01790000
         MVC   IWEXVENT,PCBENTKN-IPCB(R1) CURRENT IPCB ENTITY TOKEN     01800000
         MVC   IWEXVTPN,TPNAME    COPY TPNAME                           01810000
                                                                        01820000
         $VTAMQ (R4),             WORK ELEMENT                         +01830000
               IVTWEQ             QUEUE                                 01840000
                                                                        01850000
         LTR   R15,R15            WAS QUEUEING SUCCESSFUL?              01860000
         BNZ   ERRPROD            BRANCH IF NOT                         01870000
                                                                        01880000
         $TASK WAIT,              WAIT FOR MAIN TO DELETE              +01890000
               EPB=(R3),                                               +01900000
               MF=(E,$TASKMFL)                                          01910000
                                                                        01920000
         ST    R0,RETCODE         POST CODE IN R0 IS DELETE RC          01930000
         B     RETURN             RETURN                                01940000
                                                                        01950000
         DROP  R4                                                       01960000
                                                                        01970000
*---------------------------------------------------------------------- 01980000
* DELETE A TRANSACTION PROGRAM THAT WAS MVS LOADED                      01990000
*---------------------------------------------------------------------- 02000000
                                                                        02010000
DLTPMAIN DS    0H                                                       02020000
                                                                        02030000
*                                                                       02040000
* UPDATE THE USE COUNT. IF IT IS NOT ZERO RETURN.                       02050000
*---------------------------------------------------------------------- 02060000
                                                                        02070000
         L     R1,TPBUSE              UPDATE USE COUNT                  02080000
         S     R1,=F'1'               UPDATE USE COUNT                  02090000
         ST    R1,TPBUSE              UPDATE USE COUNT                  02100000
         ST    R1,USECOUNT            SAVE FOR TRACE                    02110000
         BM    ERRCOUNT               BRANCH IF COUNT INVALID           02120000
         BP    RETURN                 BRANCH IF MODULE STILL IN USE     02130000
                                                                        02140000
*                                                                       02150000
* RELEASE THE TPB                                                       02160000
*---------------------------------------------------------------------- 02170000
                                                                        02180000
         MVC   LOADNAME,TPBLOAD       SAVE THE MVS MODULE NAME          02190000
                                                                        02200000
         LM    R14,R15,TPBNEXT        R14=NEXT TPB R15=PREV TPB         02210000
         ST    R14,TPBNEXT-TPB(,R15)  SET NEXT LINK IN PREV TPB         02220000
         ST    R15,TPBPREV-TPB(,R14)  SET PREV LINK IN NEXT TPB         02230000
                                                                        02240000
         $VTAMRET (RTPB)              QUEUE TPB FOR RELEASE             02250000
                                                                        02260000
*                                                                       02270000
* ISSUE AN MVS DELETE TO REMOVE THE MODULE FROM STORAGE                 02280000
*---------------------------------------------------------------------- 02290000
                                                                        02300000
         DELETE EPLOC=LOADNAME                                          02310000
                                                                        02320000
         B     RETURN                                                   02330000
                                                                        02340000
*---------------------------------------------------------------------- 02350000
* EXCEPTION ROUTINES                                                    02360000
*---------------------------------------------------------------------- 02370000
                                                                        02380000
ERRPROD  DS    0H                                                       02390000
                                                                        02400000
         MVC   RETCODE,=A(LU62_PRODUCT_SPECIFIC_ERROR)                  02410000
         B     ERRCOMM                                                  02420000
                                                                        02430000
ERRCOMM  DS    0H                                                       02440000
                                                                        02450000
         B     RETURN                                                   02460000
                                                                        02470000
*---------------------------------------------------------------------- 02480000
* EXIT TRACE AND RETURN TO CALLER                                       02490000
*---------------------------------------------------------------------- 02500000
                                                                        02510000
RETURN   DS    0H                                                       02520000
                                                                        02530000
         BAS   R14,VTAMUNLK           RELEASE THE LOCK IF NECESSARY     02540000
                                                                        02550000
         $TRACE *=A(TRC_LU62_EXIT),16 TRACE ENTRY W/ 16 USER BYTES      02560000
         BNZ   NOXTRACE               BRANCH IF TRACING NOT AVAILABLE   02570000
         MVC   0(8,R1),=CL8'IL62ADTP' MODULE NAME                       02580000
         MVC   8(4,R1),RETCODE        RETURN_CODE VALUE                 02590000
         MVC   12(4,R1),USECOUNT      TRACE THE TPB USE COUNT           02600000
NOXTRACE DS    0H                                                       02610000
                                                                        02620000
         L     R1,L62PARM2        ADDRESS OF RETURN_CODE AREA           02630000
         MVC   0(4,R1),RETCODE    SET RETURN_CODE VARIABLE              02640000
                                                                        02650000
         SR    R15,R15            FUNCTION RETURN CODE = 0              02660000
         CEXIT RC=(R15),INDEP=YES RETURN                                02670000
                                                                        02680000
*---------------------------------------------------------------------- 02690000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 02700000
*---------------------------------------------------------------------- 02710000
                                                                        02720000
VTAMLOCK DS    0H                                                       02730000
                                                                        02740000
         TM    FLAG,FLAGLOCK        WAS THE LOCK ALREADY OBTAINED?      02750000
         BOR   R14                  RETURN IF YES                       02760000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             02770000
                                                                        02780000
         $SER  OBTAIN,                                                 +02790000
               VTAM                                                     02800000
                                                                        02810000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              02820000
         BNE   VTAMLOEX             BRANCH IF NOT                       02830000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         02840000
                                                                        02850000
VTAMLOEX DS    0H                                                       02860000
                                                                        02870000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               02880000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          02890000
         BR    R14                  RETURN                              02900000
                                                                        02910000
*---------------------------------------------------------------------- 02920000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                02930000
*---------------------------------------------------------------------- 02940000
                                                                        02950000
VTAMUNLK DS    0H                                                       02960000
                                                                        02970000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       02980000
         BNOR  R14                  BRANCH IF NOT                       02990000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             03000000
         BOR   R14                  DON'T RELEASE IF IT WAS             03010000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             03020000
                                                                        03030000
         $SER  RELEASE,                                                +03040000
               VTAM                                                     03050000
                                                                        03060000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  03070000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          03080000
         BR    R14                  RETURN                              03090000
                                                                        03100000
*---------------------------------------------------------------------- 03110000
* ERROR ROUTINES                                                        03120000
*---------------------------------------------------------------------- 03130000
                                                                        03140000
ERRCOUNT DS    0H                                                       03150000
                                                                        03160000
         $ABEND ABE_VTDIAG,                                            +03170000
               SCOPE=PCB,                                              +03180000
               TITLE='INVALID TP USE COUNT'                             03190000
                                                                        03200000
ERR$TASK DS    0H                                                       03210000
                                                                        03220000
         $ABEND ABE_VTDIAG,                                            +03230000
               SCOPE=PCB,                                              +03240000
               TITLE='$TASK FAILURE'                                    03250000
                                                                        03260000
*---------------------------------------------------------------------- 03270000
* LITERALS AND CONSTANTS                                                03280000
*---------------------------------------------------------------------- 03290000
                                                                        03300000
         LTORG ,                                                        03310000
                                                                        03320000
         PRINT NOGEN                                                    03330000
         ISTDBIND ,               VTAM BIND IMAGE                       03340000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                03350000
         IKJTCB ,                 MVS TASK CONTROL BLOCK                03360000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         03370000
         ICVT  ,                  INTEGRATOR CVT                        03380000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   03390000
         ITASK ,                  INTEGRATOR TASK BLOCK                 03400000
         IPCB ,                   INTEGRATOR PROCESS BLOCK              03410000
         IACB ,                   INTEGRATOR VTAM ACB                   03420000
         ABCODES ,                INTEGRATOR $ABEND CODES               03430000
         EVCODES ,                INTEGRATOR EVENT CODES                03440000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            03450000
         ISESS ,                  INTEGRATOR SESSION BLOCK              03460000
         IRPL ,                   INTEGRATOR VTAM RPL                   03470000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          03480000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             03490000
         END   ,                                                        03500000

ILU2APWR TITLE 'INTEGRATOR - LU2 SESSION IMAGE COMMAND ANALYSIS'        00010000
                                                                        00020000
**<DOC-ON>************************************************************* 00030000
*                                                                       00040000
* ROUTINE: ILU2APWR - INTEGRATOR SESSION IMAGE COMMAND ANALYSIS         00050000
*                                                                       00060000
* DESCRIPTION: THIS ROUTINE IS CALLED TO PROCESS A 3270 DATASTREAM      00070000
*              SENT BY THE HOST APPLICATION.                            00080000
*              IT IS CALLED BY ILU2APRC AFTER THE RECEIVE SPLIST        00090000
*              HAS BEEN ANALYZED.                                       00100000
*                                                                       00110000
* ON ENTRY:                                                             00120000
*                                                                       00130000
*    R15 = ENTRY POINT ADDRESS                                          00140000
*    R14 = RETURN      ADDRESS                                          00150000
*    R13 = SAVE AREA   ADDRESS                                          00160000
*    R11 = ICVT        ADDRESS                                          00170000
*    R10 = ITASK       ADDRESS                                          00180000
*    R01 = SLUHANDL    ADDRESS                                          00190000
*    R00 = SPLIST      ADDRESS                                          00200000
*                                                                       00210000
* ON EXIT:                                                              00220000
*                                                                       00230000
*    R15 = GENERAL RETURN CODE                                          00240000
*        = 0 --> INPUT SUCCESSFULLY PROCESSED, SEND POSITIVE RESPONSE   00250000
*                R00 = 0                                                00260000
*                R01 = 0                                                00270000
*        = 4 --> INPUT WAS IN ERROR, SEND NEGATIVE RESPONSE             00280000
*                R00 = SENSE DATA                                       00290000
*                R01 = 0                                                00300000
*        = 8 --> SEND FAILED (I.E. TRANSMISSION OF READ DATA FAILED)    00310000
*                R00 = $SESS SPLRETCD                                   00320000
*                R01 = $SESS SPLRSNCD                                   00330000
*                                                                       00340000
*    ALL OTHER REGISTERS ARE RESTORED.                                  00350000
*                                                                       00360000
**<DOC-OFF>************************************************************ 00370000
                                                                        00380000
*********************************************************************** 00390000
*                                                                       00400000
* MAINTENANCE:                                                          00410000
*                                                                       00420000
*   10/01/93 RANDY WITEK                                                00430000
*                                                                       00440000
*********************************************************************** 00450000
                                                                        00460000
         EQUS  ,                  GENERAL EQUATES                       00470000
                                                                        00480000
RICVT    EQU   R11                                                      00490000
RITASK   EQU   R10                                                      00500000
RIVTAM   EQU   R9                                                       00510000
RSESSIMG EQU   R8                                                       00520000
RSPLIST  EQU   R7                                                       00530000
RSLUHNDL EQU   R6                                                       00540000
RDATA    EQU   R5                                                       00550000
RDATALEN EQU   R4                                                       00560000
                                                                        00570000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00580000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00590000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00600000
         USING SESSIMAG,RSESSIMG  ESTABLISH ADDRESSABILITY              00610000
         USING SPLIST,RSPLIST     ESTABLISH ADDRESSABILITY              00620000
         USING SLUHANDL,RSLUHNDL  ESTABLISH ADDRESSABILITY              00630000
                                                                        00640000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00650000
WRK256   DS    XL256              GENERAL WORKAREA                      00660000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00670000
                                                                        00680000
APUPSIMG DS    A                  SESSIMAG ADDRESS                      00690000
APUPDATA DS    A                  DATA ADDRESS                          00700000
APUPLEN  DS    F                  DATA LENGTH                           00710000
APUPLIST EQU   APUPSIMG,*-APUPSIMG                                      00720000
                                                                        00730000
RETR15   DS    F                                                        00740000
RETR0    DS    F                                                        00750000
RETR1    DS    F                                                        00760000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00770000
                                                                        00780000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00790000
                                                                        00800000
         $MSGDFT PREFIX=ICTPID,                                        +00810000
               COMPID='LU2',                                           +00820000
               TABLE=*#MSGS,                                           +00830000
               WORKA=0,                                                +00840000
               MF=(E,WRK256),                                          +00850000
               PRINT=NOGEN                                              00860000
                                                                        00870000
ILU2APWR #ENTER BASE=R12,                                              +00880000
               PREG=(RSLUHNDL,RSPLIST), R1->RSLUHNDL, R0->RSPLIST      +00890000
               AMODE=31,                                               +00900000
               RMODE=ANY                                                00910000
                                                                        00920000
*---------------------------------------------------------------------- 00930000
* INITIALIZATION                                                        00940000
*---------------------------------------------------------------------- 00950000
                                                                        00960000
         L     RIVTAM,ICTVTCVT       VTAM CVT ADDRESS                   00970000
         L     RSESSIMG,SLHSIMAG     SESSIMAG ADDRESS                   00980000
         L     RDATA,SPLAREA         RECEIVED DATA ADDRESS              00990000
         ICM   RDATALEN,15,SPLAREAL  RECEIVED DATA LENGTH               01000000
         BZ    RETURN                BRANCH IF NOT DATA TO PROCESS      01010000
                                                                        01020000
*---------------------------------------------------------------------- 01030000
* JUMP TO THE APPROPRIATE COMMAND PROCESSING ROUTINE                    01040000
*---------------------------------------------------------------------- 01050000
                                                                        01060000
         SLR   R2,R2               CLEAR                                01070000
         L     R15,IVTXCOMM        COMMANDS TRANSLATE                   01080000
         TRT   0(1,RDATA),0(R15)   XLATE TO IDENTIFY COMMAND            01090000
         SLL   R2,2                XLATED VALUE TIMES FOUR              01100000
         B     COMMTABL(R2)        BRANCH TO PROCESS COMMAND            01110000
                                                                        01120000
COMMTABL DS    0F                                                       01130000
         B     BADCMD              00 = INVALID COMMAND BYTE            01140000
         B     COMMRMA             01 = RMA (6E)                        01150000
         B     COMMEAU             02 = EAU (6F)                        01160000
         B     COMMEWA             03 = EWA (7E)                        01170000
         B     COMMW               04 = W   (F1)                        01180000
         B     COMMRB              05 = RB  (F2)                        01190000
         B     COMMWSF             06 = WSF (F3)                        01200000
         B     COMMEW              07 = EW  (F5)                        01210000
         B     COMMRM              08 = RM  (F6)                        01220000
                                                                        01230000
*---------------------------------------------------------------------- 01240000
* 01 = READ MODIFIED ALL COMMAND (6E)                                   01250000
*---------------------------------------------------------------------- 01260000
                                                                        01270000
COMMRMA  DS    0H                                                       01280000
                                                                        01290000
         C     RDATALEN,=F'1'      SHOULD BE 1 BYTE                     01300000
         BNE   BADCMD              REJECT IF NOT                        01310000
                                                                        01320000
         BAS   R14,SENDPRSP        RESPOND TO THE READ COMMAND, ETC.    01330000
                                                                        01340000
         $SLU2 TO_THE_PLU,                                             +01350000
               SLUHANDL=(RSLUHNDL),                                    +01360000
               PLUREAD=YES,                                            +01370000
               READCMD=#3270RMA    SEND RMA DATA TO PLU APPLICATION     01380000
                                                                        01390000
         STM   R15,R1,RETREGS      PASS RETURN VALUES                   01400000
         B     RETREAD             RETURN TO CALLER                     01410000
                                                                        01420000
*---------------------------------------------------------------------- 01430000
* 02 = ERASE ALL UNPROTECTED COMMAND (6F)                               01440000
*---------------------------------------------------------------------- 01450000
                                                                        01460000
COMMEAU  DS    0H                                                       01470000
                                                                        01480000
         C     RDATALEN,=F'1'      SHOULD BE 1 BYTE                     01490000
         BNE   BADCMD              REJECT IF NOT                        01500000
                                                                        01510000
         LR    R1,RSESSIMG         PASS SESSIMAG IN R1                  01520000
         L     R15,ILU@APEU        EAU SERVICE ENTRY                    01530000
         BASR  R14,R15             EXECUTE EAU AGAINST THE IMAGE        01540000
         STM   R15,R1,RETREGS      PASS RETURN VALUES                   01550000
         B     RETURN              RETURN TO CALLER                     01560000
                                                                        01570000
*---------------------------------------------------------------------- 01580000
* 03 = ERASE WRITE ALTERNATE COMMAND (7E)                               01590000
*---------------------------------------------------------------------- 01600000
                                                                        01610000
COMMEWA  DS    0H                                                       01620000
                                                                        01630000
         C     RDATALEN,=F'2'      SHOULD BE AT LEAST 2-BYTES           01640000
         BL    BADCMD              REJECT IF NOT                        01650000
                                                                        01660000
         XC    SEISCSR,SEISCSR     CUSROR TO ZERO                       01670000
         MVC   SEIS1ROW,SEIAROWS   ALTERNATE ROWS ARE ACTIVE            01680000
         MVC   SEIS1COL,SEIACOLS   ALTERNATE COLS ARE ACTIVE            01690000
         L     R1,SEIALTSZ         ALTERNATE IMAGE SIZE                 01700000
         ST    R1,SEIS1SIZ         ALTERNATE SIZE IS ACTIVE             01710000
         L     R0,SEIS1IMG         IMAGE ADDRESS                        01720000
         SR    R15,R15             ZERO PAD AND ZERO FROM-LENGTH        01730000
         MVCL  R0,R14              NULL THE IMAGE                       01740000
         ICM   R2,15,SEIS1FLV      FIELD VECTORS                        01750000
         BZ    CALLAPUP            BRANCH IF NO FIELD VECTORS           01760000
         STH   R15,0(,R2)          FIELD COUNT                          01770000
         L     R1,SEIS1SIZ         IMAGE SIZE                           01780000
         STH   R1,2(,R2)           FIELD VECTOR TERMINATOR              01790000
                                                                        01800000
CALLAPUP DS    0H                                                       01810000
                                                                        01820000
         ST    RSESSIMG,APUPSIMG   BUILD APUP PARM LIST                 01830000
         ST    RDATA,APUPDATA      BUILD APUP PARM LIST                 01840000
         ST    RDATALEN,APUPLEN    BUILD APUP PARM LIST                 01850000
         LA    R1,APUPLIST         PASS PARM LIST IN R1                 01860000
         L     R15,ILU@APUP        SERVICE ROUTINE ENTRY                01870000
         BASR  R14,R15             CALL SERVICE ROUTINE                 01880000
         STM   R15,R1,RETREGS      PASS RETURN VALUES                   01890000
         B     RETURN              RETURN TO CALLER                     01900000
                                                                        01910000
*---------------------------------------------------------------------- 01920000
* 04 = WRITE COMMAND (F1)                                               01930000
*---------------------------------------------------------------------- 01940000
                                                                        01950000
COMMW    DS    0H                                                       01960000
                                                                        01970000
         C     RDATALEN,=F'2'      SHOULD BE AT LEAST 2-BYTES           01980000
         BL    BADCMD              REJECT IF NOT                        01990000
                                                                        02000000
         B     CALLAPUP            CALL THE IMAGE UPDATE ROUTINE        02010000
                                                                        02020000
*---------------------------------------------------------------------- 02030000
* 05 = READ BUFFER COMMAND (F2)                                         02040000
*---------------------------------------------------------------------- 02050000
                                                                        02060000
COMMRB   DS    0H                                                       02070000
                                                                        02080000
         C     RDATALEN,=F'1'      SHOULD BE 1 BYTE                     02090000
         BNE   BADCMD              REJECT IF NOT                        02100000
                                                                        02110000
         BAS   R14,SENDPRSP        RESPOND TO THE READ COMMAND, ETC.    02120000
                                                                        02130000
         $SLU2 TO_THE_PLU,                                             +02140000
               SLUHANDL=(RSLUHNDL),                                    +02150000
               PLUREAD=YES,                                            +02160000
               READCMD=#3270RB     SEND RB DATA TO PLU APPLICATION      02170000
                                                                        02180000
         STM   R15,R1,RETREGS      PASS RETURN VALUES                   02190000
         B     RETREAD             RETURN TO CALLER                     02200000
                                                                        02210000
*---------------------------------------------------------------------- 02220000
* 06 = WRITE STRUCTURED FIELD COMMAND (F3)                              02230000
*---------------------------------------------------------------------- 02240000
                                                                        02250000
COMMWSF  DS    0H                                                       02260000
                                                                        02270000
         LR    R0,RSPLIST          PASS SPLIST   IN R0                  02280000
         LR    R1,RSLUHNDL         PASS SLUHANDL IN R1                  02290000
         L     R15,ILU@APSF        SERVICE ROUTINE ENTRY                02300000
         BASR  R14,R15             CALL SERVICE ROUTINE                 02310000
         STM   R15,R1,RETREGS      PASS RETURN VALUES                   02320000
         B     RETREAD             RETURN TO CALLER                     02330000
                                                                        02340000
*---------------------------------------------------------------------- 02350000
* 07 = ERASE WRITE COMMAND (F5)                                         02360000
*---------------------------------------------------------------------- 02370000
                                                                        02380000
COMMEW   DS    0H                                                       02390000
                                                                        02400000
         C     RDATALEN,=F'2'      SHOULD BE AT LEAST 2 BYTES           02410000
         BL    BADCMD              REJECT IF NOT                        02420000
                                                                        02430000
         XC    SEISCSR,SEISCSR     CUSROR TO ZERO                       02440000
         MVC   SEIS1ROW,SEIPROWS   PRIMARY   ROWS ARE ACTIVE            02450000
         MVC   SEIS1COL,SEIPCOLS   PRIMARY   COLS ARE ACTIVE            02460000
         L     R1,SEIPRISZ         PRIMARY   IMAGE SIZE                 02470000
         ST    R1,SEIS1SIZ         PRIMARY   SIZE IS ACTIVE             02480000
         L     R0,SEIS1IMG         IMAGE ADDRESS                        02490000
         SR    R15,R15             ZERO PAD AND ZERO FROM-LENGTH        02500000
         MVCL  R0,R14              NULL THE IMAGE                       02510000
         ICM   R2,15,SEIS1FLV      FIELD VECTORS                        02520000
         BZ    CALLAPUP            BRANCH IF NO FIELD VECTORS           02530000
         STH   R15,0(,R2)          FIELD COUNT                          02540000
         L     R1,SEIS1SIZ         IMAGE SIZE                           02550000
         STH   R1,2(,R2)           FIELD VECTOR TERMINATOR              02560000
         B     CALLAPUP            CALL IMAGE UPDATE ROUTINE            02570000
                                                                        02580000
*---------------------------------------------------------------------- 02590000
* 08 = READ MODIFIED COMMAND (F6)                                       02600000
*---------------------------------------------------------------------- 02610000
                                                                        02620000
COMMRM   DS    0H                                                       02630000
                                                                        02640000
         C     RDATALEN,=F'1'      SHOULD BE 1 BYTE                     02650000
         BNE   BADCMD              REJECT IF NOT                        02660000
                                                                        02670000
         BAS   R14,SENDPRSP        RESPOND TO THE READ COMMAND, ETC.    02680000
                                                                        02690000
         $SLU2 TO_THE_PLU,                                             +02700000
               SLUHANDL=(RSLUHNDL),                                    +02710000
               PLUREAD=YES,                                            +02720000
               READCMD=#3270RM     SEND RM DATA TO PLU APPLICATION      02730000
                                                                        02740000
         STM   R15,R1,RETREGS      PASS RETURN VALUES                   02750000
         B     RETREAD             RETURN TO CALLER                     02760000
                                                                        02770000
*---------------------------------------------------------------------- 02780000
* EXCEPTION ROUTINES                                                    02790000
*---------------------------------------------------------------------- 02800000
                                                                        02810000
BADCMD   DS   0H                                                        02820000
                                                                        02830000
         MVC   RETR0(4),=X'10030000' INVALID COMMAND RECEIVED           02840000
         MVC   RETR15,=F'4'          SEND NEGATIVE RESPONSE             02850000
         B     RETURN                RETURN TO CALLER                   02860000
                                                                        02870000
*---------------------------------------------------------------------- 02880000
* RETURN TO CALLER                                                      02890000
*---------------------------------------------------------------------- 02900000
                                                                        02910000
RETURN   DS    0H                                                       02920000
                                                                        02930000
         CLC   RETR15,=F'4'          INPUT REJECTED?                    02940000
         BE    RETNOEB               BRANCH IF YES                      02950000
                                                                        02960000
         TM    SPLRH2,RHBBI          WAS BEGIN BRACKET SENT?            02970000
         BNO   RETNOBB               BRANCH IF NOT                      02980000
         NI    SEIFSNA,255-SEIF_CMD  TAKE AWAY DIRECTION                02990000
                                                                        03000000
RETNOBB  DS    0H                                                       03010000
                                                                        03020000
         TM    SPLRH2,RHCDI       DID WE RECEIVE THE DIRECTION?         03030000
         BNO   RETNOCD            BRANCH IF NOT                         03040000
         OI    SEIFSNA,SEIF_CMD   WE HAVE DIRECTION                     03050000
                                                                        03060000
RETNOCD  DS    0H                                                       03070000
                                                                        03080000
         TM    SPLRH2,RHEBI       DID WE RECEIVE END BRACKET?           03090000
         BNO   RETNOEB            BRANCH IF NOT                         03100000
         OI    SEIFSNA,SEIF_CMD   WE HAVE DIRECTION                     03110000
         OI    SEIFSNA,SEIF_KBR   KEYBOARD IS RESTORED                  03120000
                                                                        03130000
RETREAD  DS    0H                                                       03140000
                                                                        03150000
RETNOEB  DS    0H                                                       03160000
                                                                        03170000
         LM    R15,R1,RETREGS     LOAD RETURN VALUES                    03180000
                                                                        03190000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    03200000
                                                                        03210000
*---------------------------------------------------------------------- 03220000
* SUBROUTINE: SENDPRSP                                                  03230000
*---------------------------------------------------------------------- 03240000
                                                                        03250000
SENDPRSP DS     0H                                                      03260000
                                                                        03270000
         STM   R14,R12,SUB0SAVE                                         03280000
                                                                        03290000
         $SESS $SESS_SEND_POSRESP,  SEND A RESPONSE AS NEEDED          +03300000
               SESSION=SLHSTKN,                                        +03310000
               RH=*,                                                   +03320000
               SEQNO=*,                                                +03330000
               CNTRL=*,                                                +03340000
               SENSE=*,                                                +03350000
               ERRET=ERR$RESP,                                         +03360000
               MF=(E,(RSPLIST))                                         03370000
                                                                        03380000
SENDPRET DS    0H                                                       03390000
                                                                        03400000
         LM    R14,R12,SUB0SAVE                                         03410000
         BR    R14                                                      03420000
                                                                        03430000
ERR$RESP DS    0H                                                       03440000
                                                                        03450000
         CLC   SPLRETCD,=A($SESS_RC_CANCELED)                           03460000
         BE    SENDPRET                                                 03470000
         B     ABNDRESP                                                 03480000
                                                                        03490000
*---------------------------------------------------------------------- 03500000
* ERROR ROUTINES                                                        03510000
*---------------------------------------------------------------------- 03520000
                                                                        03530000
ABNDRESP DS    0H                                                       03540000
                                                                        03550000
         $ABEND ABE_VTDIAG,                                            +03560000
               SCOPE=PCB,                                              +03570000
               TITLE='$SESS SEND RESPONSE FAILURE'                      03580000
                                                                        03590000
*---------------------------------------------------------------------- 03600000
*  CONSTANTS AND LITERALS                                               03610000
*---------------------------------------------------------------------- 03620000
                                                                        03630000
         LTORG ,                                                        03640000
         PRINT NOGEN                                                    03650000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                03660000
         ISTRH ,                  VTAM REQUEST HEADER                   03670000
         ISTDBIND ,               VTAM BIND IMAGE                       03680000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         03690000
         SESSIMAG ,               INTEGRATOR LU2 IMAGE BLOCK            03700000
         ICVT  ,                  INTEGRATOR CVT                        03710000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   03720000
         ITASK ,                  INTEGRATOR TASK BLOCK                 03730000
         ISESS ,                  INTEGRATOR ISESS BLOCK                03740000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       03750000
         EVCODES ,                INTEGRATOR EVENT CODES                03760000
         ABCODES ,                INTEGRATOR $ABEND CODES               03770000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     03780000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        03790000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             03800000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             03810000
         SLUHANDL ,               INTEGRATOR SLUHANDL BLOCK             03820000
         END   ,                                                        03830000

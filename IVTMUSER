IVTMUSER TITLE 'INTEGRATOR - VTAM IVUSER SUBTASK MAIN ENTRY'            00010000
**<DOC-ON>************************************************************* 00020000
*                                                                       00030000
* ROUTINE: IVTMUSER - INTEGRATOR VTAM IVUSER SUBTASK MAIN ENTRY         00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*                                                                       00080000
*                                                                       00090000
*                                                                       00100000
*                                                                       00110000
* ON ENTRY:                                                             00120000
*                                                                       00130000
*    R15 = ENTRY POINT ADDRESS                                          00140000
*    R14 = RETURN ADDRESS                                               00150000
*    R13 = AVAILABLE SAVE AREA                                          00160000
*    R11 = ICVT ADDRESS                                                 00170000
*    R10 = ITASK ADDRESS                                                00180000
*    R01 = ADDRESS OF STAGING WORK ELEMENT (IWE)                        00190000
*          IWELCODE CONTAINS THE IVUSER BLOCK ADDRESS                   00200000
*                                                                       00210000
* ON EXIT:                                                              00220000
*                                                                       00230000
*    R15 = 0                                                            00240000
*    R00 = 0                                                            00250000
*    R01 = 0                                                            00260000
*                                                                       00270000
*    ALL OTHER REGISTERS ARE RESTORED                                   00280000
*                                                                       00290000
*                                                                       00300000
**<DOC-OFF>************************************************************ 00310000
                                                                        00320000
         EJECT ,                                                        00330000
*********************************************************************** 00340000
*                                                                       00350000
* MAINTENANCE:                                                          00360000
*                                                                       00370000
*   08/01/93 RANDY WITEK                                                00380000
*   07/01/94 RANDY WITEK - LU6.2 SUPPORT                                00390000
*   09/07/95 RANDY WITEK - SPECIAL HANDLING FOR START-UP WORK ELEMENT   00400000
*   12/31/95 RANDY WITEK - 2.1 TRANSACTION PROGRAM VTAM WU SUPPORT      00410000
*                                                                       00420000
*********************************************************************** 00430000
                                                                        00440000
         EQUS  ,                  GENERAL EQUATES                       00450000
                                                                        00460000
RICVT    EQU   R11                                                      00470000
RITASK   EQU   R10                                                      00480000
RIVTAM   EQU   R9                                                       00490000
RIVUSER  EQU   R8                                                       00500000
RIWE     EQU   R7                                                       00510000
RISESS   EQU   R6                                                       00520000
RMSG     EQU   R5                                                       00530000
                                                                        00540000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00550000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00560000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00570000
         USING IVUSER,RIVUSER     ESTABLISH ADDRESSABILITY              00580000
         USING IWEVTAM,RIWE       ESTABLISH ADDRESSABILITY              00590000
         USING TMSGSTD,RMSG       ESTABLISH ADDRESSABILITY              00600000
                                                                        00610000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00620000
                                                                        00630000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00640000
                                                                        00650000
$TASKMFL $TASK MF=L               $TASK PLIST CONSTRUCTION              00660000
                                                                        00670000
ECODE    DS    F                  SAVED EVENT CODE                      00680000
                                                                        00690000
MSGDESC  DS    0A,0F              MESSAGE BUFFER DESCRIPTOR             00700000
MSGBUFR  DS    F                     MESSAGE BUFFER ADDRESS             00710000
MSGBUFL  DS    F                     MESSAGE BUFFER LENGTH              00720000
MSGDESCL EQU   *-MSGDESC          MESSAGE BUFFER DESCRIPTOR LENGTH      00730000
                                                                        00740000
WRK256   DS    XL256              GENERAL WORKAREA                      00750000
                                                                        00760000
RETR15   DS    F                  RETURN CODE VALUE                     00770000
RETR0    DS    F                  RETURN REGISTER 0                     00780000
RETR1    DS    F                  RETURN REGISTER 1                     00790000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00800000
                                                                        00810000
FLAG     DS    X                                                        00820000
FLAGLOCK EQU   X'80'              VTAM GLOBAL LOCK HELD                 00830000
FLAGLCKD EQU   X'40'              VTAM GLOBAL LOCK HELD ON ENTRY        00840000
                                                                        00850000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00860000
                                                                        00870000
         $MSGDFT PREFIX=ICTPID,                                        +00880000
               COMPID='VTM',                                           +00890000
               TABLE=*#MSGS,                                           +00900000
               WORKA=0,                                                +00910000
               MF=(E,WRK256),                                          +00920000
               PRINT=NOGEN                                              00930000
                                                                        00940000
IVTMUSER #ENTER BASE=R12,         ENTRY LINKAGE                        +00950000
               PREG=RIVUSER,                                           +00960000
               SAVE=(YES,NOFRAME),                                     +00970000
               AMODE=31,                                               +00980000
               RMODE=ANY                                                00990000
                                                                        01000000
*---------------------------------------------------------------------- 01010000
* INITIALIZATION                                                        01020000
*---------------------------------------------------------------------- 01030000
                                                                        01040000
         L     RIVTAM,ICTVTCVT    VTAM SERVICES CVT                     01050000
                                                                        01060000
*---------------------------------------------------------------------- 01070000
* ISSUE AN INFORMATIVE MESSAGE AND CUT A TRACE RECORD                   01080000
*---------------------------------------------------------------------- 01090000
                                                                        01100000
         $TRACE *=A(TRC_IVUSER_START),32 TRACE ENTRY W/32 USER BYTES    01110000
                                                                        01120000
         BNZ   NOUTRACE                  BRANCH IF NOT TRACING          01130000
                                                                        01140000
         ST    RIVUSER,0(,R1)            TRACE IVUSER ADDRESS           01150000
         ST    RITASK,4(,R1)             TRACE ITASK  ADDRESS           01160000
         MVC   8(8,R1),IVUTK             TRACE IVUSER TOKEN             01170000
         MVC   16(4,R1),IVU#SESS         TRACE CURRENT # OF SESSIONS    01180000
         MVC   20(8,R1),TSKNAME          TRACE TASK NAME (I.E. LUNAME)  01190000
                                                                        01200000
NOUTRACE DS    0H                                                       01210000
                                                                        01220000
                                                                        01230000
         $MSG  006,               "VTAM USER TASK STARTING"            +01240000
               FIELDS=((RIVUSER), IVUSER ADDRESS                       +01250000
               (IVUTKUSR,4),      IVUSER TOKEN                         +01260000
               (RITASK),          ITASK ADDRESS                        +01270000
               (TSKPCBC,4),       IPROC ADDRESS                        +01280000
               (TSKNAME,8))       ITASK NAME                            01290000
                                                                        01300000
*---------------------------------------------------------------------- 01310000
* WAIT FOR STARTUP EPB TO BE POSTED                                     01320000
*---------------------------------------------------------------------- 01330000
                                                                        01340000
         $TASK SETEPB,                                                 +01350000
               EPB=IVUWEEPB,                                           +01360000
               ECB=IVUSTECB,                                           +01370000
               ECODE=EC$VTWE,                                          +01380000
               ERRET=ERR$TASK,    ABEND IF SERVICE FAILURE             +01390000
               MF=(E,$TASKMFL)    INITIALIZE EPB FOR FIRST EVENT        01400000
                                                                        01410000
         $TASK WAIT,                                                   +01420000
               EPB=IVUWEEPB,      WAIT FOR STARTUP EPB POSTING         +01430000
               MF=(E,$TASKMFL)                                          01440000
                                                                        01450000
         BAS   R14,TMSGRECV       PREPARE FOR INITIAL MESSAGE RECEIVE   01460000
                                                                        01470000
         MVC   ECODE,=A(EC$VTWE)  CAUSE EPB INTIALIZATION AFTER 1ST WE  01480000
         L     RIWE,IVU1STWE      GET THE START-UP WORK ELEMENT  090795 01490000
         B     STARTUP            GO PROCESS THE LOGON WE               01500000
                                                                        01510000
*---------------------------------------------------------------------- 01520000
* RESET EPB'S AS NEEDED                                                 01530000
*---------------------------------------------------------------------- 01540000
                                                                        01550000
WAIT     DS    0H                                                       01560000
                                                                        01570000
         CLC   ECODE,=A(EC$VTWE)  WAS VTAM WORK ELEMENT PROCESSED?      01580000
         BNE   WAITWORK           BRANCH IF NOT                         01590000
                                                                        01600000
         $TASK SETEPB,                                                 +01610000
               EPB=IVUWEEPB,                                           +01620000
               ECB=IWEECB,                                             +01630000
               ECODE=EC$VTWE,                                          +01640000
               ERRET=ERR$TASK,    ABEND IF SERVICE FAILURE             +01650000
               MF=(E,$TASKMFL)    INITIALIZE EPB FOR FIRST EVENT        01660000
                                                                        01670000
         B     WAITWORK           GO WAIT THE TASK                      01680000
                                                                        01690000
*---------------------------------------------------------------------- 01700000
* WAIT FOR AN EVENT TO OCCUR AND JUMP TO THE PROCESSING ROUTINE         01710000
*---------------------------------------------------------------------- 01720000
                                                                        01730000
WAITWORK DS    0H                                                       01740000
                                                                        01750000
         TM    IVUF1,IVUF1TRM     IS TERMINATION STARTED?               01760000
         BNO   WAITNOW            BRANCH IF NOT, WORK TO DO             01770000
         OC    IVU#SESS,IVU#SESS  ARE THERE ANY ACTIVE SESSIONS?        01780000
         BNZ   WAITNOW            BRANCH IF YES, WORK TO DO             01790000
         TM    IVUF1,IVUF1QTM     IS THE WORK QUEUE TERMINATED?         01800000
         BO    WAITNOW            BRANCH YES, LET QUEUE DRAIN           01810000
         OI    IVUF1,IVUF1QTM     SHOW THAT QUEUE IS TERMINATED         01820000
                                                                        01830000
         $TASK STOP,              TELL ALL PROCESSES TO GO AWAY        +01840000
               TASK=(RITASK),                                          +01850000
               ERRET=ERR$TASK,                                         +01860000
               MF=(E,$TASKMFL)                                          01870000
                                                                        01880000
         $VTAMQ 0,                NULL WORK ELEMENT                    +01890000
               IVUWEQ                                                   01900000
                                                                        01910000
WAITNOW  DS    0H                                                       01920000
                                                                        01930000
         BAS   R14,FREEMSG        RELEASE MESSAGING RESOURCES           01940000
                                                                        01950000
         $TASK WAIT,              WAIT FOR EVENT                       +01960000
               MF=(E,$TASKMFL)                                          01970000
                                                                        01980000
         ST    R15,ECODE          SAVE THE EVENT CODE                   01990000
                                                                        02000000
         C     R15,=A(EC$VTWE)    IS IT A VTAM WORK ELEMENT?            02010000
         BE    VWRK               BRANCH IF YES                         02020000
                                                                        02030000
         C     R15,=A(EC$VTST)    IS IT A VTAM ISESS PROC TERMINATION?  02040000
         BE    PTRM               BRANCH IF YES                         02050000
                                                                        02060000
         C     R15,=A(EC$MSG)     IS IT AN INTERTASK MESSAGE?           02070000
         BE    TMSG               BRANCH IF YES                         02080000
                                                                        02090000
         C     R15,=A(EC$STOP)    IS TASK STOP REQUESTED?               02100000
         BE    TSTP               BRANCH IF YES                         02110000
                                                                        02120000
         C     R15,=A(EC$CNCL)    IS TASK CANCEL REQUESTED?             02130000
         BE    TCAN               BRANCH IF YES                         02140000
                                                                        02150000
         B     WAITWORK           IGNORE ANYTHING ELSE                  02160000
                                                                        02170000
*---------------------------------------------------------------------- 02180000
* PROCESS A VTAM WORK ELEMENT                                           02190000
*---------------------------------------------------------------------- 02200000
                                                                        02210000
VWRK     DS    0H                                                       02220000
                                                                        02230000
         L     R3,EPBECB-EPB(,R1)    GET ADDRESS OF POSTED IWE          02240000
         L     RIWE,IWELINK-IWE(,R3) ADDRESS OF IWE TO SERVICE          02250000
                                                                        02260000
         $VTAMFWE (R3)            RELEASE THE OLD IWE THAT WAS POSTED   02270000
                                                                        02280000
STARTUP  DS    0H                                                       02290000
                                                                        02300000
         ST    RIWE,IVULASTW      SET ADDRESS OF LAST WORK ELEMENT      02310000
                                                                        02320000
         $TRACE *=A(TRC_IVUSER_WORK),32 TRACE ENTRY W/32 USER BYTES     02330000
                                                                        02340000
         BNZ   NOWTRACE           BRANCH IF TRACING NOT AVAILABLE       02350000
         ST    RIVUSER,0(,R1)     TRACE IVUSER ADDRESS                  02360000
         ST    RITASK,4(,R1)      TRACE ITASK  ADDRESS                  02370000
         MVC   8(8,R1),IVUTK      TRACE IVUSER TOKEN                    02380000
         LA    R14,IVUWEQ         QUEUE ADDRESS                         02390000
         ST    R14,20(,R1)        TRACE QUEUE ADDRESS                   02400000
         ST    RIWE,24(,R1)       TRACE WORK ELEMENT ADDRESS            02410000
         LTR   RIWE,RIWE          NULL WORK ELEMENT?                    02420000
         BZ    NOWTRACE           BRANCH IF YES                         02430000
         MVC   16(4,R1),IWELCODE  TRACE THE WORK ELEMENT CODE           02440000
                                                                        02450000
NOWTRACE DS    0H                                                       02460000
                                                                        02470000
         LTR   RIWE,RIWE          WAS LINK FIELD NULL?                  02480000
         BZ    EXIT               BRANCH YES, TIME TO EXIT              02490000
                                                                        02500000
         LA    R4,VWRKTBLE        ADDRESS OF JUMP TABLE                 02510000
         LA    R2,L'VWRKNTRY      LENGTH OF AN ENTRY                    02520000
         LA    R3,VWRKLAST        ADDRESS OF LAST ENTRY                 02530000
                                                                        02540000
VWRKLOOP DS    0H                                                       02550000
                                                                        02560000
         CLC   IWELCODE,0(R4)     DOES ENTRY MATCH WORK ELEMENT CODE?   02570000
         BE    VWRKGO             BRANCH IF YES                         02580000
         BXLE  R4,R2,VWRKLOOP     CHECK ALL TABLE ENTRIES               02590000
                                                                        02600000
         $MSG  981,                                                    +02610000
               FIELDS=((RIWE),                                         +02620000
               (RITASK),                                               +02630000
               (TSKPCBC,4),                                            +02640000
               (TSKNAME,8),                                            +02650000
               (IWEID,4),                                              +02660000
               (IWELEN,4),                                             +02670000
               (IWELINK,4),                                            +02680000
               (IWELCODE,4),                                           +02690000
               (IWELQUAL,4),                                           +02700000
               (IWEOWNER,4))                                            02710000
                                                                        02720000
         B     WAIT                                                     02730000
                                                                        02740000
VWRKGO   DS    0H                                                       02750000
                                                                        02760000
         ICM   R15,15,4(R4)       OFFSET OR ADDRESS OF ROUTINE          02770000
         BM    VWRKADDR           BRANCH IF ABSOLUTE ADDRESS            02780000
         ALR   R15,RIVTAM         ADDRESS OF ROUTINE ENTRY POINT        02790000
         L     R15,0(,R15)        ROUTINE ENTRY POINT                   02800000
                                                                        02810000
VWRKADDR DS    0H                                                       02820000
                                                                        02830000
         LR    R1,RIWE            PASS IWE ADDRESS IN R1                02840000
         BASR  R14,R15            LINK TO WORK ELEMENT ROUTINE          02850000
         B     WAIT               AND WAIT FOR NEXT ELEMENT             02860000
                                                                        02870000
VWRKTBLE DS    0F                                                       02880000
         DC    A(IWECXLOG,IVT@ULOG-IVTAMCVT) LOGON   EXIT WORK ELEMENT  02890000
VWRKNTRY EQU   VWRKTBLE,*-VWRKTBLE                                      02900000
         DC    A(IWECXSCP,IVT@ULOG-IVTAMCVT) SCIP    EXIT WORK ELEMENT  02910000
         DC    A(IWECSIRQ,IVT@ULOG-IVTAMCVT) SESSION INIT WORK ELEMENT  02920000
         DC    A(IWECTCPL,IVT@UTCP-IVTAMCVT) TCP/IP LOGON WORK ELEMENT  02930000
         DC    A(IWECGETS,IL6@UGTS-IVTAMCVT) GET SESSION  WORK ELEMENT  02940000
         DC    A(IWECFRES,IL6@UFRS-IVTAMCVT) FREE SESSION WORK ELEMENT  02950000
         DC    A(IWECBID,IL6@UBID-IVTAMCVT)  BID RESPONSE WORK ELEMENT  02960000
         DC    A(IWECBS,IL6@UBID-IVTAMCVT)   BID SYNC     WORK ELEMENT  02970000
         DC    A(IWECRTR,IL6@UBID-IVTAMCVT)  RTR          WORK ELEMENT  02980000
         DC    A(IWECPCV,IL6@UPCV-IVTAMCVT)  PROC CNOS    WORK ELEMENT  02990000
         DC    A(IWECSREQ,IL6@USRQ-IVTAMCVT) SESS REQ CMP WORK ELEMENT  03000000
         DC    A(IWECSDAC,IL6@USDC-IVTAMCVT) SESS DEACT.  WORK ELEMENT  03010000
         DC    A(IWECBISR,IL6@UBIS-IVTAMCVT) BIS REQ/RSP  WORK ELEMENT  03020000
         DC    A(IWECSLIM,IL6@USCN-IVTAMCVT) SESS LIMITS  WORK ELEMENT  03030000
         DC    A(IWECSTPU,X'80000000'+STPU)  STOPUSER     WORK ELEMENT  03040000
         DC    A(IWECNOP,X'80000000'+NOP)    NOP          WORK ELEMENT  03050000
         DC    A(IWECXPGL,IVT@UXPG-IVTAMCVT) CPIC VTAM WU WORK ELEMENT  03060000
VWRKLAST EQU   *-L'VWRKNTRY                                             03070000
                                                                        03080000
*---------------------------------------------------------------------- 03090000
* PROCESS A STOP USER WORK ELEMENT                                      03100000
*---------------------------------------------------------------------- 03110000
                                                                        03120000
STPU     DS    0H                                                       03130000
                                                                        03140000
         TM    IVUF1,IVUF1TRM     IS TERMINATION ALREADY STARTED?       03150000
         BO    WAIT               BRANCH IF YES                         03160000
         OI    IVUF1,IVUF1TRM     SHOW TERMINATION IS STARTED           03170000
                                                                        03180000
         LA    RISESS,IVUIS1ST-(ISENEXT-ISE) NORMALIZED HEADER ADDRESS  03190000
                                                                        03200000
         USING ISESS,RISESS                                             03210000
                                                                        03220000
         BAS   R14,VTAMLOCK                                             03230000
                                                                        03240000
STPUNXTS DS    0H                                                       03250000
                                                                        03260000
         ICM   RISESS,15,ISENEXT  NEXT SESSION IN IVUSER'S ISESS CHAIN  03270000
         BM    STPUDONE           BRANCH IF CHAIN TRAVERSED             03280000
         TM    ISEF1,ISEF1TRM     IS TERMINATION START FOR THIS ISESS?  03290000
         BO    STPUNXTS           BRANCH IF YES                         03300000
                                                                        03310000
         $VTAMWE L'IWEXH,         LENGTH                               +03320000
               IWECENDS           CODE                                  03330000
                                                                        03340000
         LR    R3,R1              SAVE NEW WORK ELEMENT ADDRESS         03350000
                                                                        03360000
         $VTAMQ (R3),             WORK ELEMENT                         +03370000
               ISEWEQ             QUEUE                                 03380000
                                                                        03390000
         B     STPUNXTS           GO DO THE NEXT SESSION                03400000
                                                                        03410000
STPUDONE DS    0H                                                       03420000
                                                                        03430000
         BAS   R14,VTAMUNLK                                             03440000
                                                                        03450000
         B     WAIT               WAIT FOR MORE WORK                    03460000
                                                                        03470000
         DROP  RISESS                                                   03480000
                                                                        03490000
*---------------------------------------------------------------------- 03500000
* PROCESS A NOP WORK ELEMENT                                            03510000
*---------------------------------------------------------------------- 03520000
                                                                        03530000
NOP      DS    0H                                                       03540000
                                                                        03550000
         B     WAIT               SEE IF IT IS TIME TO TERMINATE ITASK  03560000
                                                                        03570000
*---------------------------------------------------------------------- 03580000
* PROCESS ISESS PROC TERMINATION EPB POSTING                            03590000
*---------------------------------------------------------------------- 03600000
                                                                        03610000
PTRM     DS    0H                                                       03620000
                                                                        03630000
         B     WAIT               SEE IF IT IS TIME TO TERMINATE ITASK  03640000
                                                                        03650000
*---------------------------------------------------------------------- 03660000
* PROCESS AN INTERTASK MESSAGE                                          03670000
*---------------------------------------------------------------------- 03680000
                                                                        03690000
TMSG     DS    0H                                                       03700000
                                                                        03710000
         BAS   R14,TMSGRECV       PREPARE FOR NEXT MESSAGE              03720000
                                                                        03730000
TMSGNEXT DS    0H                                                       03740000
                                                                        03750000
         BAS   R14,GETMSG         RECEIVE THE MESSAGE                   03760000
         BNZ   WAIT               RETURN WHEN ALL MESSAGES RECEIVED     03770000
         LM    R2,R4,TMSGRTTB     MESSAGE TYPE / PROCESSING RTN TABLE   03780000
         CR    R3,R4              ENTRIES AVAILABLE IN TABLE?           03790000
         BL    TMSGDFT            NO,  PERFORM DEFAULT MESSAGE PROC     03800000
                                                                        03810000
TMSGSCAN DS    0H                                                       03820000
                                                                        03830000
         CLC   TMSGTYPE,0(R4)     MATCHING MESSAGE TYPE?                03840000
         BE    TMSGMTCH           END SCAN IF SO                        03850000
         BXLE  R4,R2,TMSGSCAN     AGAIN IF NOT                          03860000
                                                                        03870000
TMSGDFT  DS    0H                                                       03880000
         $TMSGDFT TMSGSTD         DEFAULT MESSAGE PROCESSING            03890000
                                                                        03900000
         B     TMSGNEXT           IGNORE SPURIOUS MSG                   03910000
                                                                        03920000
TMSGMTCH DS    0H                                                       03930000
                                                                        03940000
         L     R15,4(,R4)         MESSAGE PROCESSING RTN EPA            03950000
         BASR  R14,R15            CALL                                  03960000
         B     TMSGNEXT           PROCESS NEXT MESSAGE                  03970000
                                                                        03980000
*                                                                       03990000
* MESSAGE TYPES / PROCESSING ROUTINE TABLE                              04000000
*---------------------------------------------------------------------- 04010000
                                                                        04020000
TMSGRTTB DC    A(8,TMSGTBND-1,TMSGTABL)                                 04030000
                                                                        04040000
TMSGTABL DS    0A                                                       04050000
******** DC    A(ITM_MESSAGE_ID,ROUTINE)                                04060000
TMSGTBND EQU   *                                                        04070000
                                                                        04080000
*---------------------------------------------------------------------- 04090000
* PROCESS A TASK STOP REQUEST                                           04100000
*---------------------------------------------------------------------- 04110000
                                                                        04120000
TSTP     DS    0H                                                       04130000
                                                                        04140000
         TM    IVUF1,IVUF1STP            IS STOP ALREADY SET?           04150000
         BO    WAIT                      BRANCH IF YES                  04160000
         OI    IVUF1,IVUF1STP            SET STOP REQUESTED             04170000
                                                                        04180000
         $TRACE *=A(TRC_IVUSER_STOP),32  TRACE ENTRY W/32 USER BYTES    04190000
                                                                        04200000
         BNZ   NOPTRACE                  BRANCH IF NOT TRACING          04210000
                                                                        04220000
         ST    RIVUSER,0(,R1)            TRACE IVUSER ADDRESS           04230000
         ST    RITASK,4(,R1)             TRACE ITASK  ADDRESS           04240000
         MVC   8(8,R1),IVUTK             TRACE IVUSER TOKEN             04250000
         MVC   16(4,R1),IVU#SESS         TRACE CURRENT # OF SESSIONS    04260000
         MVC   20(8,R1),TSKNAME          TRACE TASK NAME (I.E. LUNAME)  04270000
                                                                        04280000
NOPTRACE DS    0H                                                       04290000
                                                                        04300000
                                                                        04310000
         $MSG  988,                      "IVUSER TASK STOP"            +04320000
               FIELDS=((RIVUSER),                                      +04330000
               (IVUTKUSR,4),                                           +04340000
               (RITASK),                                               +04350000
               (TSKPCBC,4),                                            +04360000
               (TSKNAME,8))                                             04370000
                                                                        04380000
         B     STPU                      START USER TERMINATION         04390000
                                                                        04400000
*---------------------------------------------------------------------- 04410000
* PROCESS A TASK CANCEL REQUEST                                         04420000
*---------------------------------------------------------------------- 04430000
                                                                        04440000
TCAN     DS    0H                                                       04450000
                                                                        04460000
         $TRACE *=A(TRC_IVUSER_CANCEL),32  TRACE ENTRY W/32 USER BYTES  04470000
                                                                        04480000
         BNZ   NOCTRACE                  BRANCH IF NOT TRACING          04490000
                                                                        04500000
         ST    RIVUSER,0(,R1)            TRACE IVUSER ADDRESS           04510000
         ST    RITASK,4(,R1)             TRACE ITASK  ADDRESS           04520000
         MVC   8(8,R1),IVUTK             TRACE IVUSER TOKEN             04530000
         MVC   16(4,R1),IVU#SESS         TRACE CURRENT # OF SESSIONS    04540000
         MVC   20(8,R1),TSKNAME          TRACE TASK NAME (I.E. LUNAME)  04550000
                                                                        04560000
NOCTRACE DS    0H                                                       04570000
                                                                        04580000
         $MSG  987,                      "IVUSER TASK CANCEL"          +04590000
               FIELDS=((RIVUSER),                                      +04600000
               (IVUTKUSR,4),                                           +04610000
               (RITASK),                                               +04620000
               (TSKPCBC,4),                                            +04630000
               (TSKNAME,8))                                             04640000
                                                                        04650000
         OI    IVUF1,IVUF1CAN            SET CANCEL REQUESTED           04660000
         B     STPU                      START USER TERMINATION         04670000
                                                                        04680000
*---------------------------------------------------------------------- 04690000
* EXIT TO END IVUSER SUBTASK                                            04700000
*---------------------------------------------------------------------- 04710000
                                                                        04720000
EXIT     DS    0H                                                       04730000
                                                                        04740000
         BAS   R14,FREEMSG        RELEASE MESSAGING RESOURCES           04750000
                                                                        04760000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 04770000
                                                                        04780000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    04790000
                                                                        04800000
*---------------------------------------------------------------------- 04810000
* SUBROUTINE: TMSGRECV - PREPARE FOR MESSAGE RECEIVE                    04820000
*---------------------------------------------------------------------- 04830000
                                                                        04840000
TMSGRECV DS    0H                                                       04850000
                                                                        04860000
         STM   R0,R15,SUB0SAVE    SAVE MAINLINE REGISTERS               04870000
                                                                        04880000
         $TASK SETEPB,            INITIALIZE MESSAGE EPB               +04890000
               EPB=TSKMEPB,       MESSAGE EPB                          +04900000
               ECODE=EC$MSG,                                           +04910000
               ERRET=ERR$TASK,    SERVICE ROUTINE FAILURE              +04920000
               MF=(E,$TASKMFL)                                          04930000
                                                                        04940000
         LM    R0,R15,SUB0SAVE    RESTORE MAINLINE REGISTERS            04950000
         BR    R14                RETURN                                04960000
                                                                        04970000
*---------------------------------------------------------------------- 04980000
*                                                                       04990000
* SUBROUTINE: GETMSG - RECEIVE MESSAGE FROM MESSAGE QUEUE               05000000
*                                                                       05010000
* DESCRIPTION:                                                          05020000
*                                                                       05030000
*    THIS ROUTINE WILL RECEIVE A MESSAGE FROM THE TASK                  05040000
*    MESSAGE QUEUE.  RC08 FROM $TRECV INDICATES THAT THE BUFFER         05050000
*    PROVIDED IS TOO SMALL.  THE MINIMUM LENGTH REQUIRED                05060000
*    RETURNED IN R1 IS USED TO REALLOCATE THE BUFFER AND THE            05070000
*    REQUEST IS RETRIED IF NECESSARY.                                   05080000
*                                                                       05090000
* ENTRY:  N/A                                                           05100000
*                                                                       05110000
* EXIT:   R15 CONTAINS THE $TRECV RETURN CODE AS FOLLOWS                05120000
*                                                                       05130000
*            RC00 - MESSAGE RECEIVED AND RETURNED VIA R1                05140000
*            RC04 - NO MESSAGE AVAILABLE                                05150000
*                                                                       05160000
*         RMSG CONTAINS THE ADDRESS OF THE MESSAGE IF R15=0             05170000
*                                                                       05180000
*---------------------------------------------------------------------- 05190000
                                                                        05200000
GETMSG   DS    0H                                                       05210000
                                                                        05220000
         STM   R0,R15,SUB0SAVE    SAVE CALLER'S REGISTERS               05230000
         SR    RMSG,RMSG          SHOW NO MESSAGE RECEIVED              05240000
                                                                        05250000
GETMRECV DS    0H                                                       05260000
                                                                        05270000
         $TRECV (*MSGBUFR,*MSGBUFL),                                   +05280000
               MF=(E,MFE_LIST)                                          05290000
                                                                        05300000
         C     R15,=A(RC08)       MESSAGE BUFFER TOO SMALL?             05310000
         BE    GETMREAL           BRANCH IF YES                         05320000
         LTR   R15,R15            SUCCESSFUL?                           05330000
         BNZ   GETMEXIT           BRANCH IF NOT                         05340000
         L     RMSG,MSGBUFR       SET MESSAGE POINTER                   05350000
         B     GETMEXIT           AND RETURN                            05360000
                                                                        05370000
*                                                                       05380000
* MSG BUFFER ALLOCATION INADEQUATE, REALLOCATE AND RETRY                05390000
*---------------------------------------------------------------------- 05400000
                                                                        05410000
GETMREAL DS    0H                                                       05420000
                                                                        05430000
         LR    R2,R1              MESSAGE LENGTH                        05440000
                                                                        05450000
         $REALLOC MSGDESC,                                             +05460000
               (R2),                                                   +05470000
               MF=(E,MFE_LIST)    (RE)ALLOCATE MESSAGE BUFFER           05480000
                                                                        05490000
         B     GETMRECV           RETRY RECEIVE                         05500000
                                                                        05510000
*                                                                       05520000
* RETURN TO REQUESTOR                                                   05530000
*---------------------------------------------------------------------- 05540000
                                                                        05550000
GETMEXIT DS    0H                                                       05560000
                                                                        05570000
         ST    RMSG,SUB0SAVE+(4*RMSG)                                   05580000
         ST    R15,SUB0SAVE+(4*R15)                                     05590000
         LM    R0,R15,SUB0SAVE        RESTORE CALLER'S REGISTERS        05600000
         LTR   R15,R15                SET CONDITION CODE                05610000
         BR    R14                    RETURN                            05620000
                                                                        05630000
*---------------------------------------------------------------------- 05640000
*                                                                       05650000
* SUBROUTINE: FREEMSG - FREE $TRECV MESSAGE BUFFER                      05660000
*                                                                       05670000
* DESCRIPTION:                                                          05680000
*                                                                       05690000
*    THIS ROUTINE WILL FREE THE STORAGE PREVIOUSLY ALLOCATED TO         05700000
*    $TRECV ACQUIRE AN INBOUND MESSAGE. THE BUFFER DESCRIPTOR           05710000
*    IS RESET ACCORDINGLY.                                              05720000
*---------------------------------------------------------------------- 05730000
                                                                        05740000
FREEMSG  DS    0H                                                       05750000
                                                                        05760000
                                                                        05770000
         OC    MSGBUFR,MSGBUFR    MESSAGE BUFFER (ADDR,LEN)             05780000
         BZR   R14                RETURN IF NOT ALLOCATED               05790000
         STM   R0,R15,SUB0SAVE    SAVE CALLER'S REGISTERS               05800000
                                                                        05810000
         $RETSTOR *MSGBUFR                                              05820000
                                                                        05830000
         XC    MSGDESC(MSGDESCL),MSGDESC                                05840000
         LM    R0,R15,SUB0SAVE    RESTORE CALLER'S REGISTERS            05850000
         BR    R14                RETURN                                05860000
                                                                        05870000
*---------------------------------------------------------------------- 05880000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 05890000
*---------------------------------------------------------------------- 05900000
                                                                        05910000
VTAMLOCK DS    0H                                                       05920000
                                                                        05930000
         TM    FLAG,FLAGLOCK        HAVE WE ALREADY GOTTEN THE LOCK?    05940000
         BOR   R14                  BRANCH IF YES                       05950000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             05960000
                                                                        05970000
         $SER  OBTAIN,                                                 +05980000
               VTAM                                                     05990000
                                                                        06000000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              06010000
         BNE   VTAMLOEX             BRANCH IF NOT                       06020000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         06030000
                                                                        06040000
VTAMLOEX DS    0H                                                       06050000
                                                                        06060000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               06070000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          06080000
         BR    R14                  RETURN                              06090000
                                                                        06100000
*---------------------------------------------------------------------- 06110000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                06120000
*---------------------------------------------------------------------- 06130000
                                                                        06140000
VTAMUNLK DS    0H                                                       06150000
                                                                        06160000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       06170000
         BNOR  R14                  BRANCH IF NOT                       06180000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             06190000
         BOR   R14                  DON'T RELEASE IF IT WAS             06200000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             06210000
                                                                        06220000
         $SER  RELEASE,                                                +06230000
               VTAM                                                     06240000
                                                                        06250000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  06260000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          06270000
         BR    R14                  RETURN                              06280000
                                                                        06290000
*---------------------------------------------------------------------- 06300000
* ERROR ROUTINES                                                        06310000
*---------------------------------------------------------------------- 06320000
                                                                        06330000
ERR$TASK DS    0H                                                       06340000
                                                                        06350000
         $ABEND ABE_VTDIAG,                                            +06360000
               SCOPE=PCB,                                              +06370000
               TITLE='$TASK FAILURE'                                    06380000
                                                                        06390000
*---------------------------------------------------------------------- 06400000
*  CONSTANTS AND LITERALS                                               06410000
*---------------------------------------------------------------------- 06420000
                                                                        06430000
         LTORG ,                                                        06440000
         PRINT NOGEN                                                    06450000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                06460000
         ISTDBIND ,               VTAM BIND IMAGE                       06470000
         ISTRH ,                  VTAM SNA REQUEST HEADER               06480000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         06490000
         ICVT  ,                  INTEGRATOR CVT                        06500000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   06510000
         IRPL ,                   INTEGRATOR VTAM RPL+                  06520000
         IACB ,                   INTEGRATOR VTAM ACB+                  06530000
         INIB ,                   INTEGRATOR VTAM NIB+                  06540000
         ISESS ,                  INTEGRATOR SESSION BLOCK              06550000
         IRQE ,                   INTEGRATOR RECEIVE QUEUE ELEMENT      06560000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            06570000
         ITASK ,                  INTEGRATOR TASK BLOCK                 06580000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          06590000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       06600000
         EVCODES ,                INTEGRATOR EVENT CODES                06610000
         ABCODES ,                INTEGRATOR $ABEND CODES               06620000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     06630000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        06640000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             06650000
         $TSEND DSECT=YES         INTEGRATOR $TSEND SERVICES            06660000
         END   ,                                                        06670000

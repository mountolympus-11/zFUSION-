ITBDEL   TITLE 'TABLE SERVICES - ROW DELETE'                            00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE:  ITBDEL - Table services, row delete                         00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*                                                                       00080000
* ON ENTRY:                                                             00090000
*                                                                       00100000
*    R1  contains the address of a parameter list described by          00110000
*        the @TBDEL mapping                                             00120000
*                                                                       00130000
*                                                                       00140000
* ON EXIT:                                                              00150000
*                                                                       00160000
*    R15 contains one of the following return codes                     00170000
*    R0  may contain an associated reason code or other data            00180000
*                                                                       00190000
*        RC00 - row deleted                                             00200000
*                                                                       00210000
*        RC04 - no row was deleted because either (1) a relative        00220000
*               CRP request was made but the table is empty, or         00230000
*               (2) the key provided in the model row was not           00240000
*               matched.                                                00250000
*                                                                       00260000
*        RC08 - reserved                                                00270000
*                                                                       00280000
*        RC12 - request in error                                        00290000
*                                                                       00300000
*               RSN04 - invalid table token supplied                    00310000
*                                                                       00320000
*               RSN12 - invalid CRP given or encountered                00330000
*                                                                       00340000
*               RSN20 - a row reference was made relative to the        00350000
*                       current CRP, but the CRP is not set             00360000
*                                                                       00370000
*               RSN32 - invalid index name or index not defined         00380000
*                                                                       00390000
*        RC16 - object management error encountered                     00400000
*                                                                       00410000
*               R1 - @PUSHERR summary of service rtn failure            00420000
*                                                                       00430000
*               RSN04 - table slot locator not accessable               00440000
*               RSN08 - index not accessable                            00450000
*               RSN12 - base table not accessable                       00460000
*               RSN36 - index processing failure                        00470000
*                                                                       00480000
**<DOC-OFF>****************************************************         00490000
                                                                        00500000
         EJECT                                                          00510000
***************************************************************         00520000
*                                                                       00530000
* MAINTENANCE:                                                          00540000
*                                                                       00550000
*    05/xx/92 R. Turgeon                                                00560000
*             Initial version                                           00570000
*                                                                       00580000
*    02/25/95 R. Turgeon                                                00590000
*             Null support                                              00600000
*                                                                       00610000
*    03/20/95 R. Turgeon                                                00620000
*             Maintain locator entry count in LOCINUSE                  00630000
*                                                                       00640000
*    10/23/95 R. Turgeon                                                00650000
*             Implement the NOLOCATOR property                          00660000
*                                                                       00670000
***************************************************************         00680000
                                                                        00690000
         EJECT                                                          00700000
***************************************************************         00710000
*                                                                       00720000
*   Working storage area                                                00730000
*                                                                       00740000
***************************************************************         00750000
                                                                        00760000
WORKAREA DSECT                                                          00770000
                                                                        00780000
         @WORK ,                  STANDARD WORKAREA                     00790000
                                                                        00800000
MFE_INDX DS    10F                ITB@INDX PLIST CONSTRUCTION AREA      00810000
                                                                        00820000
ALETLOCR DS    F                  LOCATOR OBJECT ALET                   00830000
ALETTABL DS    F                  BASE TABLE OBJECT ALET                00840000
ALETNDX  DS    F                  INDEX OBJECT ALET                     00850000
                                                                        00860000
BASELOCR DS    A                  ROW SLOT LOCATOR ORIGIN               00870000
BASETABL DS    A                  BASE TABLE ORIGIN                     00880000
BASESIZE DS    F                  BASE TABLE SIZE (USED EXTENT LENGTH)  00890000
                                                                        00900000
CURRKEY  DS    A                  TABLE SPACE ADDR OF CURRENT KEY DEF   00910000
CURRPOS  DS    F                  ROW # FOR NEWLY ESTABLISHED CRP       00920000
                                                                        00930000
CURRXPTR DS    A                  ADDR OF CURRENT INDEX LOCATOR         00940000
CURRXKDF DS    A                  ADDR OF ASSOCAIATED TBKEYDEF ENTRY    00950000
CURRXPRE DS    F                  OFFLINK OF INDEX ENTRY PREDECESSOR    00960000
CURRXENT DS    F                  OFFLINK OF INDEX ENTRY TO DELETE      00970000
                                                                        00980000
NULLMLEN DS    F                  LENGTH OF ROW NULL INDICATOR MASK     00990000
TOTALROW DS    F                  TOTAL STORAGE COST OF ROW             01000000
                                                                        01010000
WORKFREE DS    0D                 AVAILABLE TO SERVICE ROUTINES         01020000
WORKLEN  EQU   *-WORKAREA         LENGTH OF WORKAREA                    01030000
                                                                        01040000
         EJECT                                                          01050000
         @TBDEL ,                 PARAMETER LIST FORMAT                 01060000
                                                                        01070000
         EJECT                                                          01080000
         @TBSET ,                 CURRENT POSITION CODES                01090000
                                                                        01100000
         EJECT                                                          01110000
         $TOKEN ,                 SPACE TOKEN                           01120000
                                                                        01130000
         EJECT                                                          01140000
         TBTOKEN ,                TABLE TOKEN                           01150000
                                                                        01160000
         EJECT                                                          01170000
         $STG TYPE=DSECT          FREE STORAGE MGMT                     01180000
                                                                        01190000
         EJECT                                                          01200000
         @TABLE ,                 TABLE OBJECT PREFIX                   01210000
                                                                        01220000
         EJECT                                                          01230000
         @TBCOLDF ,               COLUMN DEFINITION                     01240000
                                                                        01250000
         EJECT                                                          01260000
         @TBKEYDF ,               INDEX DEFINITION                      01270000
                                                                        01280000
         EJECT                                                          01290000
         ROWPFX ,                 STORED ROW PREFIX                     01300000
                                                                        01310000
         EJECT                                                          01320000
         COLHDR ,                 STORED REW DESCRIPTOR HEADER          01330000
                                                                        01340000
         EJECT                                                          01350000
         LOCATOR ,                RECORD LOCATOR ARRAY FORMAT           01360000
                                                                        01370000
         EJECT                                                          01380000
         VNDXPARM ,               INDEX VALIDATION PLIST                01390000
                                                                        01400000
         EJECT                                                          01410000
         INDXPARM ,               INDEX LOOKUP PLIST                    01420000
                                                                        01430000
         EJECT                                                          01440000
         DNDXPARM ,               INDEX DELETE PLIST                    01450000
                                                                        01460000
         EJECT                                                          01470000
         INDEX ,                  INDEX ENTRY SLOT                      01480000
                                                                        01490000
         EJECT                                                          01500000
         OIE   ,                  OBJECT INDEX ENTRY ($OBJECT INLINE)   01510000
                                                                        01520000
         EJECT                                                          01530000
         SPCBLOCK ,               OBJECT SPACE BLOCK ($OBJECT INLINE)   01540000
                                                                        01550000
         EJECT                                                          01560000
         EQUS  LINKAGE=VCON                                             01570000
                                                                        01580000
         EJECT                                                          01590000
ITBDEL   @ENTER WORKA=(WORKAREA,WORKLEN),ASC=AR                         01600000
                                                                        01610000
         EJECT                                                          01620000
***************************************************************         01630000
*                                                                       01640000
*   Fetch passed parameters, preliminary validations                    01650000
*                                                                       01660000
***************************************************************         01670000
                                                                        01680000
         LAM   R1,R7,MFE_LIST     PRIMARY SPACE ADDRESSING              01690000
                                                                        01700000
         LR    R7,R1              PARAMETER LIST                        01710000
         USING TBDEL,R7           TBDEL SERVICE                         01720000
         L     R6,TBDETOKN        LOCATE TABLE TOKEN                    01730000
         L     R6,0(,R6)          TOKEN IS A PTR                        01740000
         USING TBTOKEN,R6         TABLE TOKEN ADDRESSABILITY LOF        01750000
         CLC   TTOKTAG,=CL8'TBTOKEN'                                    01760000
         BNE   ETBTOKEN                                                 01770000
                                                                        01780000
         EJECT                                                          01790000
***************************************************************         01800000
*                                                                       01810000
*   Acquire access to base table                                        01820000
*                                                                       01830000
***************************************************************         01840000
                                                                        01850000
         $OBJECT ACCESS,INTENT=WRITE,OTOKEN=TTOKTABL,                  X01860000
               INLINE=YES                                               01870000
                                                                        01880000
         BZ    TBLOBJOK           DONE IF SUCCESS                       01890000
                                                                        01900000
         $OBJECT ACCESS,INTENT=WRITE,OTOKEN=TTOKTABL,                  X01910000
               SHRPAGE=WORKFREE,MF=(E,MFE_LIST)                         01920000
                                                                        01930000
         BNZ   ETABLOBJ           ERROR HAS BEEN CAPTURED               01940000
                                                                        01950000
*-------------------------------------------------------------          01960000
*   Table object located, now verify and anchor                         01970000
*-------------------------------------------------------------          01980000
                                                                        01990000
TBLOBJOK DS    0H                                                       02000000
         ST    R0,BASESIZE        SIZE OF TABLE                         02010000
         STAM  AR1,AR1,ALETTABL   LOCATOR ALET                          02020000
         LAE   R11,0(,R1)         OBJECT ADDRESS                        02030000
         USING TABLE,R11          TABLE BASE                            02040000
         CLC   TBLTAG,=CL8'TBTABLE'                                     02050000
         BNE   ETABLOBJ                                                 02060000
         ST    R11,BASETABL       RETAIN TABLE BASE ADDR                02070000
                                                                        02080000
***************************************************************         02090000
*                                                                       02100000
*   Acquire and validate the row slot locator object unless             02110000
*   the table was constructed with the NOLOCATOR property.              02120000
*                                                                       02130000
***************************************************************         02140000
                                                                        02150000
         TM    TBLPROP1,TBLP_NOLOCATOR                                  02160000
         BO    LOCFIN                                                   02170000
                                                                        02180000
         $OBJECT ACCESS,INTENT=WRITE,OTOKEN=TTOKLOCR,                  X02190000
               INLINE=YES                                               02200000
                                                                        02210000
         BZ    LOCOBJOK           LONG FOR LOGGING IF ERROR             02220000
                                                                        02230000
         $OBJECT ACCESS,INTENT=WRITE,OTOKEN=TTOKLOCR,                  X02240000
               SHRPAGE=WORKFREE,MF=(E,MFE_LIST)                         02250000
                                                                        02260000
         BNZ   ELOCROBJ           LOCATOR FAILURE IS CATASTROPHIC       02270000
                                                                        02280000
*-------------------------------------------------------------          02290000
*   Row slot locator object found, now verify                           02300000
*-------------------------------------------------------------          02310000
                                                                        02320000
LOCOBJOK DS    0H                                                       02330000
         USING LOCATOR,R1         ROW LOCATOR                           02340000
         CLC   LOCTAG,=CL8'LOCATOR'                                     02350000
         BNE   ELOCROBJ                                                 02360000
                                                                        02370000
         STAM  AR1,AR1,ALETLOCR   ROW LOCATOR ALET                      02380000
         ST    R1,BASELOCR        SAVE STABLE ADDR OF LOCATOR           02390000
         DROP  R1                 ROW LOCATOR                           02400000
                                                                        02410000
LOCFIN   DS    0H                                                       02420000
                                                                        02430000
         EJECT                                                          02440000
***************************************************************         02450000
*                                                                       02460000
*   Row may be referenced by physical (slot) location or index          02470000
*                                                                       02480000
***************************************************************         02490000
                                                                        02500000
         ICM   R0,15,TBDENDX      TARGET RECORD LOCATED BY INDEX?       02510000
         BZ    PHYSDEL            DELETE BY PHYSICAL REF OTHERWISE      02520000
                                                                        02530000
***************************************************************         02540000
*                                                                       02550000
*   Delete record identified by key and index name.  Validate           02560000
*   the index by name and target, base table row by ROWID               02570000
*                                                                       02580000
***************************************************************         02590000
                                                                        02600000
         LA    R3,MFE_LIST        PLIST CONSTRUCTION                    02610000
         USING VNDXPARM,R3        INDEX VERIFY PLIST                    02620000
                                                                        02630000
         XC    VNDXPARM(VNDXLN),VNDXPARM                                02640000
         MVC   VNDXALE,ALETTABL   OBJECT SPACE ALET                     02650000
         MVC   VNDXCNT,=F'1'      SINGLE INDEX NAME REQUIRED            02660000
         LA    R1,TBDENDX         ADDR OF INDEX NAME PTR                02670000
         ST    R1,VNDXLIST        VERIFY SINGLE INDEX NAME              02680000
         ST    R11,VNDXBASE       BASE TABLE ORIGIN                     02690000
                                                                        02700000
         @CALL ITBNDXVY,MF=(E,VNDXPARM)                                 02710000
                                                                        02720000
         LTR   R15,R15            ALL INDEX NAMES VERIFY?               02730000
         BNZ   ENDXLIST           ERROR IF NOT                          02740000
         ST    R1,CURRXKDF        SAVE KEY DEFINITION ENTRY ADDR        02750000
         DROP  R3                 VNDXPARM                              02760000
                                                                        02770000
***************************************************************         02780000
*                                                                       02790000
*   Access the named index to acquire its base address                  02800000
*                                                                       02810000
***************************************************************         02820000
                                                                        02830000
         LR    R2,R0              INDEX ID #                            02840000
         BCTR  R2,0               ZERO RELATIVE                         02850000
         MH    R2,=AL2($TOKLN)    OFFSET TO INDEX TOKEN                 02860000
         LA    R5,TTOKNDX(R2)     ADDRESS OF INDEX TOKEN                02870000
                                                                        02880000
         $OBJECT ACCESS,INTENT=WRITE,OTOKEN=(R5),                      X02890000
               INLINE=YES                                               02900000
                                                                        02910000
         BZ    NDXOBJOK           INDEX LOCATED                         02920000
                                                                        02930000
         $OBJECT ACCESS,INTENT=WRITE,OTOKEN=(R5),                      X02940000
               SHRPAGE=WORKFREE,MF=(E,MFE_LIST)                         02950000
                                                                        02960000
         BNZ   ENDXOBJ            INDEX NOT FOUND                       02970000
                                                                        02980000
*-------------------------------------------------------------          02990000
*   index object found, now verify                                      03000000
*-------------------------------------------------------------          03010000
                                                                        03020000
NDXOBJOK DS    0H                                                       03030000
         STAM  AR1,AR1,ALETNDX    LOCATOR ALET                          03040000
         LAE   R9,0(0,R1)         SAFE HAVEN                            03050000
NDX      USING LOCATOR,R9         LOCATOR STRUCTURE                     03060000
         CLC   NDX.LOCTAG,=CL8'LOCATOR'                                 03070000
         BNE   ENDXOBJ            ERROR IF EYECATCHER IS CORRUPTED      03080000
         ST    R9,CURRXPTR        SAVE INDEX BASE PTR                   03090000
                                                                        03100000
*--------------------------------------------------------------         03110000
*   acquire the row identified by key                                   03120000
*--------------------------------------------------------------         03130000
                                                                        03140000
         LA    R2,MFE_INDX        ITB@INDX PLIST CONSTRUCTION AREA      03150000
         USING INDXPARM,R2        PARAMETER LIST FORMAT                 03160000
                                                                        03170000
         MVC   INDXALE,ALETTABL   OBJECT SPACE ALET                     03180000
         ST    R11,INDXBASE       BASE TABLE PREFIX                     03190000
         ST    R9,INDXNDX         NDX LOCATOR ADDRESS                   03200000
         MVC   INDXLOCR,BASELOCR  ROW LOCATOR ADDRESS OR ZERO           03210000
         MVC   INDXKEY,CURRXKDF   INDEX KEY DEFINITION PTR              03220000
         MVC   INDXROW,TBDEKEY    SOURCE ROW DATA ORIGIN                03230000
         MVC   INDXRALE,=F'0'     ROW RESIDES IN PSPACE / SOURCE FORMAT 03240000
         MVC   INDXRID,=F'-1'     LOCATE LOGICAL FIRST ROW              03250000
                                                                        03260000
         @CALL ITB@INDX,MF=(E,INDXPARM)                                 03270000
                                                                        03280000
         B     *+4(R15)           ITB@INDX RETURN CODE                  03290000
         B     ENOMATCH           NO MATCHING ENTRY FOUND               03300000
         B     ROWMATCH           ROW FOUND IN TABLE                    03310000
         B     ENDXFAIL           INDEX FAILURE                         03320000
         DROP  R2                 INDXPARM, INDEX LOCATOR               03330000
                                                                        03340000
*--------------------------------------------------------------         03350000
*   Derive row address using ROWID from index entry                     03360000
*--------------------------------------------------------------         03370000
                                                                        03380000
ROWMATCH DS    0H                                                       03390000
         LR    R1,R0                  MATCHING INDEX ENTRY              03400000
         LA    R1,NDX.LOCATOR(R1)     CONVERT OFFLINK TO ADDRESS        03410000
         LAM   AR1,AR1,ALETNDX        AR QUALIFIED INDEX ENTRY OFFSET   03420000
         L     R3,NDXRID-INDEX(,R1)                                     03430000
                                                                        03440000
         ICM   R8,15,BASELOCR     ROW SLOT LOCATOR ORIGIN               03450000
         BNZ   ROWISLOT           ROWID EXPRESSED AS SLOT NUMBER        03460000
                                                                        03470000
         TBVRO TABLE,*BASESIZE,(R3)                                     03480000
                                                                        03490000
         BZ    ROWVADDR           ROWID APPEARS VALID (R1 IS OFFLINK)   03500000
         B     EROWREF            ROWID IS INVALID                      03510000
                                                                        03520000
ROWISLOT DS    0H                                                       03530000
         LAM   R8,R8,ALETLOCR     REFRESH ROW LOCATOR ALET              03540000
                                                                        03550000
         TBFROW 0(,R8),(R3)       ACQUIRE OFFLINK OF TABLE ROW IN R1    03560000
                                                                        03570000
         BNZ   EROWREF            ROW REFERENCE FAILS                   03580000
                                                                        03590000
ROWVADDR DS    0H                 R1 <== ROW OFFLINK                    03600000
         LAE   R10,TABLE(R1)      CONVERT ROW OFFLINK TO ADDRESS        03610000
         USING ROWPFX,R10         DISCARD INDEX, ADDRESS BASE ROW       03620000
         B     DELROW                                                   03630000
                                                                        03640000
         EJECT                                                          03650000
***************************************************************         03660000
*                                                                       03670000
*   Identify row targetted for delete by physical reference             03680000
*                                                                       03690000
***************************************************************         03700000
                                                                        03710000
PHYSDEL  DS    0H                                                       03720000
         ICM   R2,15,TBDEPOS      IDENTIFY REQUESTED RECORD             03730000
         BM    RELATIVE           RELATIVE POSITION GIVEN               03740000
         BP    ROWID              ROW IDENTIFIER (EITHER FORMAT)        03750000
                                                                        03760000
         ICM   R2,15,TTOKTABL+($APPLVAR-$TOKEN)  ELSEWHERE IF ...       03770000
         BNP   RELATIVE           CURRENT POSITION IS A CODE            03780000
                                                                        03790000
*--------------------------------------------------------------         03800000
*   Validate the ROWID and convert it to a row address                  03810000
*--------------------------------------------------------------         03820000
                                                                        03830000
ROWID    DS    0H                                                       03840000
         ICM   R8,15,BASELOCR     ROW SLOT LOCATOR ORIGIN               03850000
         BNZ   PROISLOT           ROWID EXPRESSED AS SLOT NUMBER        03860000
                                                                        03870000
         TBVRO TABLE,*BASESIZE,(R2)                                     03880000
                                                                        03890000
         BZ    PROVADDR           ROWID APPEARS VALID (R1 IS OFFLINK)   03900000
         B     EROWREF            INVALID ROW REFERENCE                 03910000
                                                                        03920000
PROISLOT DS    0H                                                       03930000
         LAM   R8,R8,ALETLOCR     REFRESH ROW LOCATOR ALET              03940000
                                                                        03950000
         TBFROW 0(,R8),(R2)       ACQUIRE OFFLINK OF TABLE ROW IN R1    03960000
                                                                        03970000
         BNZ   EROWREF            ROW REFERENCE FAILS                   03980000
                                                                        03990000
PROVADDR DS    0H                 R1 <== ROW OFFLINK                    04000000
         LAE   R10,TABLE(R1)      CONVERT OFFLINK TO ADDRESS            04010000
         USING ROWPFX,R10         STORED ROW IS PREFIXED                04020000
         B     DELROW             DELETE THE ROW                        04030000
                                                                        04040000
*--------------------------------------------------------------         04050000
*   Delete request directed against top or bottom row                   04060000
*--------------------------------------------------------------         04070000
                                                                        04080000
RELATIVE DS    0H                                                       04090000
         ST    R2,CURRPOS         CODE USED TO REESTABLISH POSITION     04100000
         CL    R2,=A(TBDE$F)      FIRST ROW?                            04110000
         BNE   NOTFIRST           SKIP IF NOT                           04120000
         L     R3,TBLQFRST        GET OFFLINK OF FIRST ROW              04130000
         B     TESTROW            VALIDATE                              04140000
                                                                        04150000
NOTFIRST DS    0H                                                       04160000
         CL    R2,=A(TBDE$L)      LAST ROW?                             04170000
         BNE   ENOPOS             INVALID POSITION CODE                 04180000
         L     R3,TBLQLAST        GET OFFLINK OF LAST ROW               04190000
                                                                        04200000
TESTROW  DS    0H                                                       04210000
         LTR   R3,R3              ROW PRESENT?                          04220000
         BZ    EOTABLE            NO ROWS                               04230000
         LAE   R10,TABLE(R3)      CONVERT OFFLINK TO ADDRESS            04240000
         USING ROWPFX,R10         STORED ROW IS PREFIXED                04250000
         B     DELROW             DELETE THE ROW                        04260000
                                                                        04270000
         EJECT                                                          04280000
***************************************************************         04290000
*                                                                       04300000
*   Loop thru all indecies associated with the base table               04310000
*   and attempt to locate a row having the key values found             04320000
*   in the row acquired above as well as the matching slot              04330000
*   number.  Each index entry found is removed.                         04340000
*                                                                       04350000
***************************************************************         04360000
                                                                        04370000
DELROW   DS    0H                                                       04380000
         LA    R2,MFE_INDX        ITB@INDX PLIST                        04390000
         USING INDXPARM,R2        TEMP ADDRESSABILITY                   04400000
         MVC   INDXALE,ALETTABL   OBJECT SPACE ALET                     04410000
         MVC   INDXLOCR,BASELOCR  ROW LOCATOR ADDRESS OR ZERO           04420000
         ST    R11,INDXBASE       BASE TABLE PREFIX                     04430000
         LA    R0,ROWPFX+RPFXLN   STORED ROW ORIGIN                     04440000
         ST    R0,INDXROW         USED AS BASE FOR INDEX SCAN           04450000
         MVC   INDXRALE,ALETTABL  ROW RESIDES IN TABLE SPACE            04460000
         MVC   INDXRID,RPROWID    SUBSEQUENT NDX SEARCHES USE SLOT #    04470000
         DROP  R2                 INDXPARM                              04480000
                                                                        04490000
         SR    R4,R4              INDEX IDENTIFIER #                    04500000
         LA    R5,TTOKNDX-$TOKLN  FIRST INDEX TOKEN                     04510000
                                                                        04520000
         LAE   R9,TBLKYLST+(TBKLINK-TBKEYDEF)                           04530000
         ST    R9,CURRKEY         PREPARE TO SCAN INDEX KEY DEFS        04540000
                                                                        04550000
*--------------------------------------------------------------         04560000
*   Concurrently walk thru index tokens and corr index key defs         04570000
*--------------------------------------------------------------         04580000
                                                                        04590000
DLNDXTOP DS    0H                                                       04600000
         LA    R5,$TOKLN(,R5)     ADVANCE TO NEXT INDEX TOKEN           04610000
         LA    R4,1(,R4)          TOKEN IDENTIFIER                      04620000
         CH    R4,TTOK#NDX        ALL INDECIES PROCESSED?               04630000
         BH    DELETEGO           DONE IF SO                            04640000
                                                                        04650000
         L     R9,CURRKEY         CURRENT KEY DEFINITION                04660000
         USING TBKEYDEF,R9        TEMP ADDRESSABILITY                   04670000
         L     R9,TBKLINK         ADVANCE TO NEXT KEY DEFINITION        04680000
         LA    R9,TABLE(R9)       CONVERT OFFLINK TO ADDRESS            04690000
         ST    R9,CURRKEY         RETAIN PTR FOR SERVICE ROUTINES       04700000
         ST    R9,CURRXKDF        ADDR OF KEY DEFINITION                04710000
         DROP  R9                 TBKEYDEF                              04720000
                                                                        04730000
*--------------------------------------------------------------         04740000
*   Acquire access to next index                                        04750000
*--------------------------------------------------------------         04760000
                                                                        04770000
         $OBJECT ACCESS,INTENT=WRITE,OTOKEN=(R5),                      X04780000
               INLINE=YES                                               04790000
                                                                        04800000
         BZ    DLNDXACC           INDEX ACCESSED                        04810000
                                                                        04820000
         $OBJECT ACCESS,INTENT=WRITE,OTOKEN=(R5),                      X04830000
               SHRPAGE=WORKFREE,MF=(E,MFE_LIST)                         04840000
                                                                        04850000
         BNZ   ENDXOBJ            INDEX NOT FOUND                       04860000
                                                                        04870000
DLNDXACC DS    0H                                                       04880000
         LAE   R9,0(0,R1)         SAFE HAVEN                            04890000
NDX      USING LOCATOR,R9         LOCATOR STRUCTURE                     04900000
         CLC   NDX.LOCTAG,=CL8'LOCATOR'                                 04910000
         BNE   ENDXOBJ            DATA CORRUPTED                        04920000
         ST    R9,CURRXPTR        POST INDEX BASE ADDRESS               04930000
         DROP  NDX                INDEX LOCATOR                         04940000
                                                                        04950000
*--------------------------------------------------------------         04960000
*   Test for row presence in current index                              04970000
*--------------------------------------------------------------         04980000
                                                                        04990000
DLNDXGO  DS    0H                                                       05000000
         LA    R2,MFE_INDX        PRECONSTRUCTED SERVICE ROUTINE PLIST  05010000
         USING INDXPARM,R2        PLIST UPDATES                         05020000
         MVC   INDXNDX,CURRXPTR   PTR TO INDEX BASE                     05030000
         MVC   INDXKEY,CURRXKDF   PTR TO CORR COLKEY DEFINITION         05040000
                                                                        05050000
         @CALL ITB@INDX,MF=(E,INDXPARM)                                 05060000
                                                                        05070000
         B     *+4(R15)           ITB@INDX RETURN CODE                  05080000
         B     DLNDXTST           NO MATCHING ENTRY FOUND               05090000
         B     DLSETUP            ROW MATCHED, PREDECESSOR IN R1        05100000
         B     ENDXFAIL           INDEX FAILURE                         05110000
                                                                        05120000
DLNDXTST DS    0H                 NF REASONABLE ONLY IF SPARSE INDEX    05130000
         L     R9,CURRXKDF        KEY DEFINITION                        05140000
         USING TBKEYDEF,R9        TEMP ADDRESSABILITY                   05150000
         CLI   TBKTYPE,$SPARSE    SPARSE INDEX?                         05160000
         BNE   ENDXFAIL           ERROR IF NOT                          05170000
         B     DLNDXTOP           ELSE CONTINUE                         05180000
         DROP  R9,R2              TBKEYDEF, INDEX LOOKUP PLIST          05190000
                                                                        05200000
*--------------------------------------------------------------         05210000
*   Delete index entry                                                  05220000
*--------------------------------------------------------------         05230000
                                                                        05240000
DLSETUP  DS    0H                                                       05250000
         LA    R2,MFE_LIST        PLIST CONSTRUCTION AREA               05260000
         USING DNDXPARM,R2        INDEX DELETE                          05270000
         ST    R1,DNDXPRED        IDENTIFY PREDECESSOR / SUBTREE        05280000
         MVC   DNDXALE,ALETTABL   INDEX ALET                            05290000
         MVC   DNDXNDX,CURRXPTR   PTR TO INDEX BASE                     05300000
         ST    R5,DNDXTOKN        INDEX TOKEN                           05310000
                                                                        05320000
         @CALL ITB@DNDX,MF=(E,DNDXPARM)                                 05330000
                                                                        05340000
         LTR   R15,R15            INDEX ENTRY DELETED?                  05350000
         BNZ   ENDXFAIL           FAIL IF NOT                           05360000
         B     DLNDXTOP           ELSE CONTINUE                         05370000
         DROP  R2                 DNDXPARM                              05380000
                                                                        05390000
         EJECT                                                          05400000
***************************************************************         05410000
*                                                                       05420000
*   Delete current row and release its locator vector entry, if         05430000
*   a row slot locator is used.  The row is composed of a               05440000
*   prefix, the fixed length portion of the row proper, the             05450000
*   null indicator mask if applicable, and all non-null vardata         05460000
*   extensions.                                                         05470000
*                                                                       05480000
***************************************************************         05490000
                                                                        05500000
DELETEGO DS    0H                                                       05510000
         XC    CURRPOS,CURRPOS    FORFEIT CRP                           05520000
                                                                        05530000
*--------------------------------------------------------------         05540000
*   Compute contribution of null indicators to row length               05550000
*--------------------------------------------------------------         05560000
                                                                        05570000
         ICM   R1,15,RPVARYSZ     NULL IND FLAG / VARDATA ACCUM LENGTH  05580000
         BNM   DELNONUL           NO NULL INDICATORS CARRIED            05590000
         LA    R1,0(,R1)          REMOVE FLAG BIT                       05600000
                                                                        05610000
         L     R2,TBL#COLS        NUMBER OF TABLE COLUMNS               05620000
         LA    R2,7(,R2)          ROUND UP TO HIGHER EIGHT COLS         05630000
         SRL   R2,3               EIGHT NULL INDICATORS PER BYTE        05640000
         ST    R2,NULLMLEN        LENGTH OF NULL INDICATOR MASK         05650000
                                                                        05660000
DELNONUL DS    0H                 R1 <== TOTAL VARDATA LENGTH           05670000
                                                                        05680000
*--------------------------------------------------------------         05690000
*   Post total size of row storage released                             05700000
*--------------------------------------------------------------         05710000
                                                                        05720000
         AL    R1,TBLROWSZ        PLUS SIZE OF ROW FIXED PORTION        05730000
         AL    R1,NULLMLEN        PLUS SIZE OF NULL INDICATOR MASK      05740000
         LA    R1,RPFXLN(,R1)     PLUS SIZE OF ROW PREFIX               05750000
         ST    R1,TOTALROW        SAVE TOTAL STG COST OF ROW            05760000
                                                                        05770000
*--------------------------------------------------------------         05780000
*   Release row slot locator entry if in use                            05790000
*--------------------------------------------------------------         05800000
                                                                        05810000
         ICM   R8,15,BASELOCR     ROW LOCATOR MAINTAINED FOR TABLE?     05820000
         BZ    DELNLOC2           SKIP IF NOT                           05830000
         LAM   R8,R8,ALETLOCR     REFRESH LOCATOR ALET                  05840000
         USING LOCATOR,R8         LOCATOR PREFIX FORMAT                 05850000
                                                                        05860000
         ICM   R9,15,RPROWID      FETCH ROW IDENTIFIER                  05870000
         BNP   DELVARY            DAMAGED ENTRY                         05880000
         C     R9,LOCHWM          EXCEEDS MAX IN USE?                   05890000
         BH    DELVARY            DAMAGED ENTRY                         05900000
                                                                        05910000
         L     R2,LOCFREE         FREE SLOT STACK                       05920000
         ST    R9,LOCFREE         PUSH NEW SLOT ONTO TOP                05930000
         BCTR  R9,0               ZERO RELATIVE SLOT ID                 05940000
         SLL   R9,2               SLOT ENTRY OFFSET                     05950000
         LAE   R9,LOCSLOTS(R9)    SLOT ADDRESS                          05960000
         ST    R2,0(,R9)          COMPLETE FREE STACK CHAINING          05970000
         OI    0(R9),X'80'        INDICATE SLOT ON FREE LIST            05980000
                                                                        05990000
         ICM   R0,15,LOCINUSE     LOCATOR ENTRY COUNT IF MAINTAINED     06000000
         BNM   *+12               HIGH ORDER BIT IS VERSION FLAG        06010000
         SL    R0,=F'1'           ACCOUNT FOR ROW RELEASE               06020000
         ST    R0,LOCINUSE        UPDATE SLOT COUNT                     06030000
         DROP  R8                 LOCATOR                               06040000
                                                                        06050000
DELNLOC2 DS    0H                                                       06060000
                                                                        06070000
*--------------------------------------------------------------         06080000
*   Unlink row from physical sequence chain                             06090000
*--------------------------------------------------------------         06100000
                                                                        06110000
         LR    R0,R10             ROW PTR                               06120000
         SR    R0,R11             CONVERT TO OFFLINK                    06130000
         CL    R0,TBLQFRST        DESIGNATED ROW IS FIRST ROW?          06140000
         BNE   *+10               SKIP IF NOT                           06150000
         MVC   TBLQFRST,RPLNKF    UPDATE FIRST ROW PTR                  06160000
         CL    R0,TBLQLAST        DESIGNATED ROW IS LAST ROW?           06170000
         BNE   *+10               SKIP IF NOT                           06180000
         MVC   TBLQLAST,RPLNKB    UPDATE LAST ROW PTR                   06190000
                                                                        06200000
CHN      USING ROWPFX,R9          APPLIES TO ANY ADJACENT ROW           06210000
         ICM   R9,15,RPLNKB       ROW PRECEDES DESIGNATED ROW?          06220000
         BZ    CHAINFWD           SKIP IF NOT                           06230000
         LAE   R9,TABLE(R9)       LOCATE PREDECESSOR                    06240000
         MVC   CHN.RPLNKF,RPLNKF  RELINK                                06250000
         MVC   CURRPOS,CHN.RPROWID    CRP WILL BE SET TO PREDECESSOR    06260000
                                                                        06270000
CHAINFWD DS    0H                                                       06280000
         ICM   R9,15,RPLNKF       ROW FOLLOWS DESIGNATED ROW?           06290000
         BZ    CHAINBWD           SKIP IF NOT                           06300000
         LAE   R9,TABLE(R9)       LOCATE SUCCESSOR                      06310000
         MVC   CHN.RPLNKB,RPLNKB  RELINK                                06320000
                                                                        06330000
CHAINBWD DS    0H                                                       06340000
         DROP  CHN                ADJACENT ROW                          06350000
                                                                        06360000
*--------------------------------------------------------------         06370000
*   Free all varying data associated with designated row                06380000
*--------------------------------------------------------------         06390000
                                                                        06400000
DELVARY  DS    0H                                                       06410000
         ICM   R4,15,RPVARYSZ     SIZE OF VARYING DATA STORAGE          06420000
         BZ    DELBASE            NONE                                  06430000
         LAE   R8,TBLCOLST-(COLNEXT-COLHDR)                             06440000
         USING COLHDR,R8          COLUMN DEFINITION HEADER              06450000
                                                                        06460000
DELVNEXT DS    0H                 SPIN THRU ALL COLUMN DEFINTIONS       06470000
         ICM   R8,15,COLNEXT      ADVANCE TO NEXT COLUMN DEF            06480000
         BZ    DELBASE            DONE                                  06490000
         LA    R8,TABLE(R8)       CONVERT OFFLINK TO ADDRESS            06500000
         LAE   R9,COLDEF          LOCATE COLUMN DEFINITION PROPER       06510000
         USING TBCOLDEF,R9        COLUMN DEFINITION ADDRESSABILITY      06520000
                                                                        06530000
         CLI   TBCDTYPE,$VCHAR    VARCHAR?                              06540000
         BE    DELVAR1                                                  06550000
         CLI   TBCDTYPE,$VBIN     VARBIN?                               06560000
         BE    DELVAR1                                                  06570000
         CLI   TBCDTYPE,$VCHARX   VARCHARX?                             06580000
         BE    DELVARX                                                  06590000
         CLI   TBCDTYPE,$VBINX    VARBINX?                              06600000
         BE    DELVARX                                                  06610000
         B     DELVNEXT                                                 06620000
                                                                        06630000
DELVAR1  DS    0H                                                       06640000
         LAE   R9,ROWPFX+RPFXLN   ORIGIN OF STORED ROW DATA             06650000
         AL    R9,COLDISPL        LOCATE VARYING DATA STRUCTURE ORIGIN  06660000
         ICM   R9,15,0(R9)        ANCHORED STRUCTURE PRESENT?           06670000
         BZ    DELVNEXT           COMPLETE IF NOT                       06680000
         LA    R9,TABLE(R9)       CONVERT OFFLINK TO ADDRESS            06690000
         LH    R2,0(,R9)          FETCH VARYING DATA LENGTH             06700000
         LA    R2,2(,R2)          ACCOUNT FOR LENGTH DESCRIPTOR         06710000
         B     DELVFREE                                                 06720000
                                                                        06730000
DELVARX  DS    0H                                                       06740000
         LAE   R9,ROWPFX+RPFXLN   ORIGIN OF STORED ROW DATA             06750000
         AL    R9,COLDISPL        LOCATE VARYING DATA STRUCTURE ORIGIN  06760000
         L     R2,0(,R9)          FETCH VARDATA LENGTH                  06770000
         ICM   R9,15,4(R9)        ANCHORED STRUCTURE PRESENT?           06780000
         BZ    DELVNEXT           COMPLETE IF NOT                       06790000
         LA    R9,TABLE(R9)       CONVERT OFFLINK TO ADDRESS            06800000
                                                                        06810000
*--------------------------------------------------------------         06820000
*   Free variable data block                                            06830000
*--------------------------------------------------------------         06840000
                                                                        06850000
DELVFREE DS    0H                                                       06860000
         $STG  TBLSTG,FREE,(R2),A=(R9),BASE=TABLE,                     X06870000
               MF=(E,MFE_LIST)                                          06880000
                                                                        06890000
         SR    R4,R2              DISPOSED OF DATA ELEMENT              06900000
         BP    DELVNEXT           DONE WHEN ALL ARE FREED               06910000
         DROP  R8                 STORED COLUMN ENTRY HDR               06920000
                                                                        06930000
*--------------------------------------------------------------         06940000
*   Free base row                                                       06950000
*--------------------------------------------------------------         06960000
                                                                        06970000
DELBASE  DS    0H                                                       06980000
         L     R2,TBLROWSZ        LENGTH OF FIXED ROW                   06990000
         AL    R2,NULLMLEN        PLUST LENGTH OF NULL INDICATOR MASK   07000000
         LA    R2,RPFXLN(,R2)     PLUS LINKAGE PREFIX                   07010000
                                                                        07020000
         $STG  TBLSTG,FREE,(R2),A=ROWPFX,BASE=TABLE,                   X07030000
               MF=(E,MFE_LIST)                                          07040000
         DROP  R10                ROW BASE                              07050000
                                                                        07060000
         EJECT                                                          07070000
***************************************************************         07080000
*                                                                       07090000
*   Row deleted - update current position and return                    07100000
*                                                                       07110000
***************************************************************         07120000
                                                                        07130000
         L     R1,TBLROWS          UPDATE                               07140000
         BCTR  R1,0                   ROW                               07150000
         ST    R1,TBLROWS                COUNT                          07160000
                                                                        07170000
         L     R0,TBLAGSIZ         TOTAL STORAGE COMMITTED TO ROWS      07180000
         S     R0,TOTALROW         ACCOUNT FOR ROW REMOVAL              07190000
         ST    R0,TBLAGSIZ         POST TOTAL ROW STG COMMITMENT        07200000
                                                                        07210000
         LA    R15,RC00            INDICATE SUCCESSFUL COMPLETION       07220000
         ICM   R0,15,TBDENDX       DELETED RECORD LOCATED VIA INDEX     07230000
         BNZ   DEL_RET             BASE TABLE CRP IS NOT MODIFIED IF SO 07240000
                                                                        07250000
         LA    R5,TTOKTABL         BASE TABLE OBJECT                    07260000
         USING $TOKEN,R5           TOKEN ADDRESSABILITY                 07270000
         ICM   R0,15,CURRPOS       FETCH CRP RECOMMENDATION             07280000
         ST    R0,$APPLVAR         ASSUME ITS A CODE                    07290000
         BNZ   *+10                USE CODE OR SPECIFIC ROW #           07300000
         MVC   $APPLVAR,=A(TBSP$TOP)   ELSE REPOSITION AT TOP           07310000
         B     DEL_RET                                                  07320000
         DROP  R5                                                       07330000
                                                                        07340000
***************************************************************         07350000
*                                                                       07360000
*   Error handlers                                                      07370000
*                                                                       07380000
***************************************************************         07390000
                                                                        07400000
                                                                        07410000
*------- end of table / row not found -------------------------         07420000
                                                                        07430000
EOTABLE  DS    0H                 TABLE IS EMPTY / RELATIVE POS REQUEST 07440000
         SR    R0,R0                                                    07450000
         LA    R15,RC04                                                 07460000
         B     DEL_RET                                                  07470000
                                                                        07480000
ENOMATCH DS    0H                                                       07490000
         SR    R0,R0              NO REASON CODE DEFINED                07500000
         LA    R15,RC04           KEY NOT MATCHED                       07510000
         B     DEL_RET            RETURN                                07520000
                                                                        07530000
                                                                        07540000
*------- logical request errors -------------------------------         07550000
                                                                        07560000
ETBTOKEN DS    0H                 INVALID TABLE TOKEN SUPPLIED          07570000
         LA    R0,RSN04                                                 07580000
         B     ERR_REQ                                                  07590000
                                                                        07600000
EROWREF  DS    0H                 INVALID CRP REFERENCE                 07610000
         LA    R0,RSN12                                                 07620000
         B     ERR_REQ                                                  07630000
                                                                        07640000
ENOPOS   DS    0H                 RELATIVE POS REQ, BUT CRP IS NOT SET  07650000
         LA    R0,RSN20                                                 07660000
         B     ERR_REQ                                                  07670000
                                                                        07680000
ENDXLIST DS    0H                 INVALID INDEX NAME LIST               07690000
         LA    R0,RSN32                                                 07700000
         B     ERR_REQ                                                  07710000
                                                                        07720000
                                                                        07730000
ERR_REQ  DS    0H                 REQUEST IN ERROR                      07740000
         LA    R15,RC12                                                 07750000
         B     DEL_RET                                                  07760000
                                                                        07770000
                                                                        07780000
*------- object management ------------------------------------         07790000
                                                                        07800000
ELOCROBJ DS    0H                 COULD NOT ACCESS LOCATOR              07810000
         LA    R2,RSN04                                                 07820000
         B     ERR_OBJ                                                  07830000
                                                                        07840000
ENDXOBJ  DS    0H                 COULD NOT ACCESS INDEX                07850000
         LA    R2,RSN08                                                 07860000
         B     ERR_OBJ                                                  07870000
                                                                        07880000
ETABLOBJ DS    0H                 COULD NOT ACCESS BASE TABLE           07890000
         LA    R2,RSN12                                                 07900000
         B     ERR_OBJ                                                  07910000
                                                                        07920000
ENDXFAIL DS    0H                 INDEX PROCESSING FAILURE              07930000
         LA    R2,RSN36                                                 07940000
         B     ERR_OBJ                                                  07950000
                                                                        07960000
                                                                        07970000
ERR_OBJ  DS    0H                 OBJECT FALURE                         07980000
         @PUSHERR ,                                                     07990000
                                                                        08000000
         LR    R0,R2              LOCAL FAILURE REASON CODE             08010000
         LA    R15,RC16                                                 08020000
         B     DEL_RET                                                  08030000
                                                                        08040000
*--------------------------------------------------------------         08050000
*   Return completion status to requestor                               08060000
*--------------------------------------------------------------         08070000
                                                                        08080000
DEL_RET  DS    0H                 AR QUALIFIED RESULT VIA A/R1 ONLY     08090000
         SR    R2,R2                                                    08100000
         SAR   AR0,R2                                                   08110000
         SAR   AR14,R2                                                  08120000
         SAR   AR15,R2                                                  08130000
                                                                        08140000
         @EXIT ,                                                        08150000
                                                                        08160000
         EJECT                                                          08170000
***************************************************************         08180000
*                                                                       08190000
*   Local read-only data areas, etc.                                    08200000
*                                                                       08210000
***************************************************************         08220000
                                                                        08230000
         LTORG ,                                                        08240000
         END   ,                                                        08250000

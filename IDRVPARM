IDRVPARM TITLE '- CONVERT SOURCE PARMS TO INTERNAL FORM'                00010000
         #WORK ,             BEGIN WORKAREA                             00020000
                                                                        00030000
RETCODE  DS    F             RETURN CODE                                00040000
                                                                        00050000
@OPLIST  DS    0A,0F         DYNAMICALLY ACQUIRED OPLIST DESCRIPTOR     00060000
@OPADDR  DS    A                ORIGIN                                  00070000
@OPLEN   DS    A                LENGTH                                  00080000
                                                                        00090000
SCANKEY  DS    F             KEYWORD OPERAND ERROR - KEYTAB NDX         00100000
SCANERR  DS    A             KEYWORD OPERAND ERROR - FAILING TOKEN      00110000
SCANMSG  DS    A             KEYWORD OPERAND ERROR - MESSAGE TEXT       00120000
                                                                        00130000
ERRENTRY DS    A             IPRMPOST INVALID TABLE ENTRY RETURN        00140000
ERRTOKEN DS    CL16          IPRMPOST ERROR MESSAGE TOKEN RETURN        00150000
                                                                        00160000
INLINE   DS    XL255,X'00'   INPUT LINE AND DELIMITER                   00170000
WK256    DS    XL256         PLIST CONSTRUCTION, ETC.                   00180000
                                                                        00190000
         #ENDWORK ,          END WORKAREA                               00200000
                                                                        00210000
         EJECT                                                          00220000
         PRMREQB ,           PARAMETER LIST                             00230000
         EJECT                                                          00240000
         KEYTAB DSECT=YES    KEYWORD TABLE FORMATS                      00250000
         EJECT                                                          00260000
         OPLIST ,            KEYWORD & VALUES INSTANCES                 00270000
         EJECT                                                          00280000
         POSTOPS DSECT=YES   KEYWORD MAP TO INTERNAL REPRESENTATION     00290000
         EJECT                                                          00300000
         ABCODES ,           $ABEND CODES                               00310000
                                                                        00320000
         EQUS  ,                                                        00330000
                                                                        00340000
         $MSGDFT PREFIX=ICTPID,COMPID='DRV',TABLE=*#MSGS,              X00350000
               CONID=*ICTCONID,CONNAME=ICTCONNM,                       X00360000
               MF=(E,WK256),                                           X00370000
               PRINT=NOGEN                                              00380000
         EJECT                                                          00390000
                                                                        00400000
**<DOC-ON>*****************************************************         00410000
*                                                                       00420000
* ROUTINE: IDRVPARM - Convert source parmaeters to internal form        00430000
*                                                                       00440000
* DESCRIPTION:                                                          00450000
*                                                                       00460000
*    This routine may be used to accept one or more input               00470000
*    lines containing parameters in CMDSCAN format, journal             00480000
*    those lines, and post the internal representations of the          00490000
*    keywords and values in a control block provided for that           00500000
*    purpose.                                                           00510000
*                                                                       00520000
*    The syntax of the source language is described in CMDSCAN.         00530000
*    The particular set of keywords and value assignments               00540000
*    accepted is defined by the keyword module passed via               00550000
*    PRQBKMOD.                                                          00560000
*                                                                       00570000
*    Source lines are acquired by calling the routine provided          00580000
*    by PRQBRTNA and the communication word PRQBRTNP.  Entry            00590000
*    and exit linkage is boxed below.  The routine is invoked           00600000
*    in the AMODE of this routine.                                      00610000
*                                                                       00620000
*      ------------------------------------------------------           00630000
*                                                                       00640000
*       CALL:    R15 - EPA        (PRQBRTNA)                            00650000
*                R1  - Comm word  (PRQBRTNP)                            00660000
*                                                                       00670000
*       RETURN:  R15 - Return code, as follows                          00680000
*                                                                       00690000
*                      RC00 - Parm line returned as follows             00700000
*                                                                       00710000
*                             R1 - source line origin                   00720000
*                             R0 - source line length                   00730000
*                                                                       00740000
*                      RCnn - End of source lines                       00750000
*                                                                       00760000
*      ------------------------------------------------------           00770000
*                                                                       00780000
*    For each input line returned and parsed without error              00790000
*    (CMDSCAN), IPRMPOST is invoked to convert the respective           00800000
*    keywords and values to internal format.  The structure of          00810000
*    the control block identified by PRQBCB is mapped by the            00820000
*    POSTOPS table provided by PRQBPOPS.                                00830000
*                                                                       00840000
*                                                                       00850000
* ON ENTRY:                                                             00860000
*                                                                       00870000
*    R1  contains the address of a parameter list described by          00880000
*        the PRMREQB mapping                                            00890000
*                                                                       00900000
*                                                                       00910000
* ON EXIT:                                                              00920000
*                                                                       00930000
*    R15 contains one of the following return codes'                    00940000
*                                                                       00950000
*        RC00 - Function complete                                       00960000
*        RC04 - Function complete, source parm errors noted             00970000
*                                                                       00980000
**<DOC-OFF>****************************************************         00990000
                                                                        01000000
                                                                        01010000
***************************************************************         01020000
*                                                                       01030000
* MAINTENANCE:                                                          01040000
*                                                                       01050000
*    05/28/93 R. TURGEON                                                01060000
*             INITIAL VERSION                                           01070000
*                                                                       01080000
***************************************************************         01090000
                                                                        01100000
         EJECT ,                                                        01110000
IDRVPARM #ENTER PREG=R8                                                 01120000
                                                                        01130000
         USING ICVT,R11                                                 01140000
         USING ITASK,R10                                                01150000
                                                                        01160000
*--------------------------------------------------------------         01170000
*   ALLOCATE OPLIST TO ACCUMULATE PARASE RESULTS                        01180000
*--------------------------------------------------------------         01190000
         USING PRMREQB,R8         PASSED PARAMETERS                     01200000
                                                                        01210000
         L     R6,PRQBKMOD        KEYWORD MODULE                        01220000
         USING KEYHDR,R6          BEGINS WITH KEYWORD HEADER            01230000
                                                                        01240000
         L     R2,KEYHCNT         NUMBER OF ELIGIBLE KEYWORDS           01250000
         MH    R2,=AL2(OPLISTLN)  SIZE OF OPLIST BACKING KEYTAB         01260000
                                                                        01270000
         STGGET (R2),QH=TSKSTG    ACQUIRE CLEARED STORAGE               01280000
         BNZ   ERR_STG            STORAGE MGMT FAILURE                  01290000
         STM   R1,R2,@OPLIST      OPLIST BLOCK ORIGIN & LENGTH          01300000
                                                                        01310000
*--------------------------------------------------------------         01320000
*   AQUIRE SOURCE LINE FROM ACQUISITION ROUTINE                         01330000
*--------------------------------------------------------------         01340000
GET_NEXT DS    0H                                                       01350000
         L     R15,PRQBRTNA       EPA                                   01360000
         L     R1,PRQBRTNP        COMM WORD                             01370000
         BASR  R14,R15            INVOKE GET-NEXT                       01380000
         CH    R15,=AL2(RC08)     FUNCTION COMPLETE?                    01390000
         BNL   ENDLINES           DONE                                  01400000
         ST    R15,FWORD          TEMPORARILY RETAIN RETCODE            01410000
                                                                        01420000
         LTR   R0,R0              VALID LINE?                           01430000
         BNP   ERR_LINE           REJECT IF NOT                         01440000
         CL    R0,=A(L'INLINE)    TOO LARGE?                            01450000
         BH    ERR_LINE           REJECT IF SO                          01460000
                                                                        01470000
         LR    R2,R0              PREPARE FOR EX                        01480000
         BCTR  R2,0               LENGTH CODE                           01490000
         EX    R2,*+4             MOVE TO ZERO DLM AREA                 01500000
         MVC   INLINE(*-*),0(R1)  COPY SOURCE LINE                      01510000
         LA    R15,INLINE+1(R2)   LAST+1 BYTE                           01520000
         MVI   0(R15),0           C-STYLE DLM                           01530000
                                                                        01540000
         $MSG  050,FIELDS=((INLINE,1(R2)))                              01550000
                                                                        01560000
         ICM   R15,15,FWORD       PARM LINE INTENDED FOR OUR USE?       01570000
         BNZ   GET_NEXT           NO FURTHER PROCESSING OTHERWISE       01580000
                                                                        01590000
         EJECT ,                                                        01600000
***************************************************************         01610000
*                                                                       01620000
*   PARSE PARAMETER SOURCE LINE, MSG IF ERROR                           01630000
*                                                                       01640000
***************************************************************         01650000
         L     R3,@OPADDR         OPLIST BLOCK ORIGIN                   01660000
         L     R4,KEYHORG         OPERAND KEYWORD TABLE ORIGIN          01670000
         USING KEYTAB,R4          KEYTAB, SYMBOLICALLY                  01680000
         LA    R0,INLINE          PARAMETER LINE ORIGIN                 01690000
         ST    R0,FWORD           IN CHAR** FORMAT                      01700000
                                                                        01710000
PARSE    DS    0H                                                       01720000
         $CLINK FUNC=*#CMDSCAN,   COMMAND LINE PARSE SERVICE           X01730000
               (STRUCT*,KEYTAB),  KEYWORD TABLE                        X01740000
               (STRUCT*,(R3)),    OPERAND LIST                         X01750000
               (CHAR**,FWORD),    OPERAND PORTION OF CMD LINE          X01760000
               (INT*,SCANKEY),    KEYWORD TABLE ENTRY INDEX ERR RETURN X01770000
               (CHAR**,SCANMSG),  EBCIDICZ ERROR MSG TEXT              X01780000
               (CHAR**,SCANERR)   ERROR LOCATION WITHIN OPERAND STRING  01790000
                                                                        01800000
         LTR   R15,R15            TEST PARSE COMPLETION                 01810000
         BZ    PARSE              KEYWORD PROCESSED, OTHERS MAY REMAIN  01820000
         BM    APPLY              PARSE COMPLETE                        01830000
                                                                        01840000
*--------------------------------------------------------------         01850000
*   PARAMETER PARSING ERROR, DOCUMENT ACCORDINGLY                       01860000
*--------------------------------------------------------------         01870000
         LA    R0,RC04            MINIMUM POSSIBLE SEVERITY CODE        01880000
         ST    R0,RETCODE         POISED FOR REQUESTOR                  01890000
                                                                        01900000
         ICM   R15,15,SCANERR     LOCATION OF ERROR WITHIN PARM LINE    01910000
         BZ    ERRPARSE           NOT PROVIDED                          01920000
         MVI   INLINE,C' '        PREPARE PARM LINE FOR REUSE           01930000
         MVC   INLINE+1(L'INLINE-1),INLINE                              01940000
         MVI   0(R15),C'?'        TAG ACCORDINGLY                       01950000
                                                                        01960000
         $MSG  051,FIELDS=(INLINE)                                     X01970000
                                                                        01980000
ERRPARSE DS    0H                                                       01990000
         $MSG  052,FIELDS=((*SCANMSG,0))                                02000000
         B     GET_NEXT                                                 02010000
                                                                        02020000
         EJECT ,                                                        02030000
***************************************************************         02040000
*                                                                       02050000
*   APPLY PARSED OPERANDS TO OPTION BLOCK                               02060000
*                                                                       02070000
***************************************************************         02080000
APPLY    DS    0H                                                       02090000
         L     R5,PRQBPOPS        POSTOPS TABLE ORIGIN                  02100000
         USING POSTOPS,R5         SYMBOLICALLY                          02110000
         L     R3,@OPADDR         OPLIST                                02120000
                                                                        02130000
APPRETRY DS    0H                                                       02140000
         $CLINK FUNC=PRMPOST,                                          X02150000
               (STRUCT*,KEYTAB),  KEYWORD TABLE                        X02160000
               (STRUCT*,(R3)),    OPERAND LIST                         X02170000
               (STRUCT*,POSTOPS), POSTOPS TABLE                        X02180000
               (STRUCT*,ICVT),    OPTIONS POSTED IN ICVT               X02190000
               (VOID**,ERRENTRY), TABLE ENTRY IN ERROR                 X02200000
               (CHAR*,ERRTOKEN)   TERSE ERROR DESCRIPTION (TEXT)        02210000
                                                                        02220000
         LTR   R15,R15            APPLICATION/POSTING COMPLETED?        02230000
         BZ    GET_NEXT           END CYCLE IF SO                       02240000
                                                                        02250000
*--------------------------------------------------------------         02260000
*   DOCUMENT PARAMETER APPLICATION/POSTING ERROR                        02270000
*--------------------------------------------------------------         02280000
         LA    R0,RC04            MINIMUM POSSIBLE SEVERITY CODE        02290000
         ST    R0,RETCODE         POISED FOR REQUESTOR                  02300000
                                                                        02310000
         L     R4,ERRENTRY        KEYTAB ENTRY ASSOCIATED WITH ERROR    02320000
                                                                        02330000
         $MSG  053,FIELDS=(KEYTKWD,ERRTOKEN)                            02340000
                                                                        02350000
         LR    R1,R4              FAILING KEYTAB ENTRY                  02360000
         S     R1,KEYHORG         OFFSET TO FAILING ENTRY               02370000
         SR    R0,R0              PREPARE FOR DIVIDE                    02380000
         D     R0,=A(KEYTLN)      CONVERT OFFSET TO INDEX               02390000
         LA    R4,KEYTAB+KEYTLN   REDRIVE APPL/POST AT NEXT ENTRY       02400000
                                                                        02410000
         MH    R1,=AL2(OPLISTLN)  OFFSET IN CORRESPONDING OPLIST        02420000
         L     R3,@OPADDR         REFRESH OPLIST BASE ADDRESS           02430000
         AR    R3,R1              CHOKE UP ACCORDINGLY                  02440000
         B     APPRETRY           FORCE TO COMPLETION                   02450000
         DROP  R4,R5              KEYTAB, POSTOPS                       02460000
                                                                        02470000
         EJECT ,                                                        02480000
***************************************************************         02490000
*                                                                       02500000
*   RELEASE ACQUIRED BUFFERS, POST COMP STATUS, AND RETURN              02510000
*                                                                       02520000
***************************************************************         02530000
ENDLINES DS    0H                                                       02540000
         L     R2,@OPADDR                                               02550000
         STGRETN ADDR=(R2),LEN=*@OPLEN,QH=TSKSTG                        02560000
                                                                        02570000
         L     R15,RETCODE                                              02580000
         #EXIT ,                                                        02590000
                                                                        02600000
         EJECT ,                                                        02610000
***************************************************************         02620000
*                                                                       02630000
*   CATASTROPHIC LOGIC FAILURES, ETC.                                   02640000
*                                                                       02650000
***************************************************************         02660000
ERR_STG  DS    0H                                                       02670000
         ST    R15,FWORD                                                02680000
         $ABEND ABE_STORAGE,*FWORD,DUMP=YES,                           X02690000
               TITLE='STORAGE MANAGMENT FAILURE'                        02700000
                                                                        02710000
*--------------------------------------------------------------         02720000
                                                                        02730000
ERR_LINE DS    0H                                                       02740000
         $ABEND ABE_INTERFACE,DUMP=YES,                                X02750000
               TITLE='PROGRAMMING INTERFACE VIOLATION'                  02760000
                                                                        02770000
         EJECT ,                                                        02780000
***************************************************************         02790000
*                                                                       02800000
*   LOCAL READ/ONLY DATA AREAS, ETC.                                    02810000
*                                                                       02820000
***************************************************************         02830000
         LTORG ,                                                        02840000
                                                                        02850000
         PRINT NOGEN                                                    02860000
         ICVT  ,                                                        02870000
         ITASK ,                                                        02880000
         END   ,                                                        02890000

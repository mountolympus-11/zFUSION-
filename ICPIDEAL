ICPIDEAL TITLE 'INTEGRATOR - CPIC CMDEAL API - DEALLOCATE CONV'         00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: ICPIDEAL - CPIC CMDEAL API                                   00100000
*                                                                       00110000
* DESCRIPTION:                                                          00120000
*                                                                       00130000
*    THIS ROUTINE IS CALLED TO PROCESS THE CMDEAL VERB.                 00140000
*                                                                       00150000
* ON ENTRY:                                                             00160000
*                                                                       00170000
*    R15 = ENTRY POINT ADDRESS                                          00180000
*    R14 = RETURN      ADDRESS                                          00190000
*    R13 = SAVE AREA   ADDRESS                                          00200000
*    R01 = PARM LIST   ADDRESS                                          00210000
*                                                                       00220000
*          +00 = ADDRESS OF CONVERSATION ID                             00230000
*          +04 = ADDRESS OF RETURN CODE AREA                            00240000
*                                                                       00250000
* ON EXIT:                                                              00260000
*                                                                       00270000
*    R15 = 0                                                            00280000
*                                                                       00290000
*    RETURN_CODE = CM_OK --> CMDEAL COMPLETED SUCCESSFULLY              00300000
*                                                                       00310000
*                = CM_PROGRAM_PARAMETER_CHECK --> INVALID CONV_ID, ETC. 00320000
*                = CM_PROGRAM_STATE_CHECK --> NOT CM_INITIALIZE_STATE   00330000
*                = CM_PRODUCT_SPECIFIC_ERROR --> BAD PARM ADDRESS       00340000
*                                                                       00350000
**<DOC-OFF>************************************************************ 00360000
         EJECT ,                                                        00370000
*********************************************************************** 00380000
*                                                                       00390000
* MAINTENANCE:                                                          00400000
*                                                                       00410000
*   07/01/94 RANDY WITEK                                                00420000
*                                                                       00430000
*********************************************************************** 00440000
                                                                        00450000
         EQUS  ,                  GENERAL EQUATES                       00460000
                                                                        00470000
RICVT    EQU   R11                                                      00480000
RITASK   EQU   R10                                                      00490000
RBASE    EQU   R9                                                       00500000
RIVTAM   EQU   R8                                                       00510000
RCMLIST  EQU   R7                                                       00520000
RTKB     EQU   R6                                                       00530000
RRCB     EQU   R5                                                       00540000
RISESS   EQU   R4                                                       00550000
                                                                        00560000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00570000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00580000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00590000
         USING CMLIST,RCMLIST     ESTABLISH ADDRESSABILITY              00600000
         USING TKB,RTKB           ESTABLISH ADDRESSABILITY              00610000
         USING RCB,RRCB           ESTABLISH ADDRESSABILITY              00620000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00630000
                                                                        00640000
         COPY  CRAB               "C" RUNTIME ANCHOR BLOCK              00650000
         USING CRAB,R12           ADDRESSABILITY                        00660000
                                                                        00670000
         COPY  DSA                DYNAMIC SAVE AREA                     00680000
WORKAREA DS    0H                 READ/WRITE WORKAREA                   00690000
WRK256   DS    XL256              GENERAL WORKAREA                      00700000
$SESSMFL $SESS MF=L               PLIST CONSTRUCTION                    00710000
$TASKMFL $TASK MF=L               PLIST CONSTRUCTION                    00720000
L62MFL   L62DLRC MF=L             PLIST CONSTRUCTION                    00730000
L62RETRC DS    F                                                        00740000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00750000
SUB1SAVE DS    18F                SUBROUTINE SAVE AREA                  00760000
SAVEEPB  DS    A                  XEPB ADDRESS                          00770000
CONVID   DS    XL8                TEMPORARY CONVERSATION ID AREA        00780000
RETCODE  DS    F                  TEMPORARY RETURN CODE     AREA        00790000
DEAL     DS    F                  TEMPORARY DEALLOCATE TYPE AREA        00800000
CONVS    DS    F                  TEMPORARY CONV STATE      AREA        00810000
NXTSTATE DS    F                  NEXT CONVERSATION STATE   AREA        00820000
                                                                        00830000
FM7LEN   DS    X                                                        00840000
FM7TYPE  DS    X                                                        00850000
FM7SENSE DS    XL4                                                      00860000
FM7FLAGS DS    X                                                        00870000
FM7      EQU   FM7LEN,*-FM7LEN                                          00880000
                                                                        00890000
FLAG     DS    X                                                        00900000
FLAGIERR EQU   X'80'                                                    00910000
FLAGLOCK EQU   X'40'                                                    00920000
FLAGLCKD EQU   X'20'                                                    00930000
FLAGFREE EQU   X'10'              RELEASE THE SESSION                   00940000
FLAGDCFM EQU   X'08'              DEALLOCATE "CONFIRM" IN EFFECT        00950000
WORKLEN  EQU   *-WORKAREA         LENGTH OF USER DSA AREA               00960000
DSALEN   EQU   *-DSA              LENGTH OF DSA                         00970000
                                                                        00980000
         $MSGDFT PREFIX=ICTPID,                                        +00990000
               COMPID='CPI',                                           +01000000
               TABLE=*#MSGS,                                           +01010000
               WORKA=0,                                                +01020000
               MF=(E,WRK256),                                          +01030000
               PRINT=NOGEN                                              01040000
                                                                        01050000
ICPDEAL@ CSECT ,                                                        01060000
ICPIDEAL CENTRY DSA=DSALEN,BASE=RBASE,INDEP=YES                         01070000
                                                                        01080000
*---------------------------------------------------------------------- 01090000
* ENTRY                                                                 01100000
*---------------------------------------------------------------------- 01110000
                                                                        01120000
         USING DSA,R13            ADDRESSABILITY                        01130000
         LR    RCMLIST,R1         SAVE ADDRESS OF PLIST                 01140000
                                                                        01150000
         LA    R0,WORKAREA        ADDRESS OF USER DSA SECTION           01160000
         LA    R1,WORKLEN         LENGTH  OF USER DSA SECTION           01170000
         SR    R15,R15            PREPARE FOR CLEAR                     01180000
         MVCL  R0,R14             CLEAR USER DSA SECTION                01190000
                                                                        01200000
*---------------------------------------------------------------------- 01210000
* INITIALIZATION                                                        01220000
*---------------------------------------------------------------------- 01230000
                                                                        01240000
         @RESTENV ,               ENSURE ENVIRONMENT                    01250000
                                                                        01260000
         L     RIVTAM,ICTVTCVT    ESTABLISH IVTAMCVT POINTER            01270000
                                                                        01280000
         MVC   CONVID,=XL8'55AA55AA55AA55AA'                            01290000
         MVC   CONVS,=XL4'55AA55AA55AA55AA'                             01300000
                                                                        01310000
         L     R1,CMLPARM2        ADDRESS OF RETURN_CODE AREA           01320000
         MVC   0(4,R1),0(R1)      TEST MOVEMENT                         01330000
                                                                        01340000
         ICM   R1,15,CMLPARM1     ADDRESS OF CONVERSATION ID            01350000
         BNP   INITERR            BRANCH IF BAD                         01360000
         MVC   CONVID,0(R1)       COPY CONVERSATION ID                  01370000
         B     INITEND                                                  01380000
                                                                        01390000
INITERR  DS    0H                                                       01400000
                                                                        01410000
         OI    FLAG,FLAGIERR      REMEMBER ERROR DETECTED               01420000
                                                                        01430000
INITEND  DS    0H                                                       01440000
                                                                        01450000
*---------------------------------------------------------------------- 01460000
* ENTRY TRACE                                                           01470000
*---------------------------------------------------------------------- 01480000
                                                                        01490000
         $TRACE *=A(TRC_CPIC_ICPIDEAL),48 TRACE ENTRY W/ 48 USER BYTES  01500000
         BNZ   NOETRACE                   BRANCH IF NOT TRACING         01510000
         $APITRC ICPIDEAL                 TRACE COMMON STUFF            01520000
         ST    RCMLIST,24(,R1)            TRACE PARMLIST ADDRESS        01530000
         MVC   32(8,R1),CONVID            TRACE CONVERSATION ID         01540000
NOETRACE DS    0H                                                       01550000
                                                                        01560000
*---------------------------------------------------------------------- 01570000
* LOCATE SPECIFIED CONVERSATION                                         01580000
*---------------------------------------------------------------------- 01590000
                                                                        01600000
         TM    FLAG,FLAGIERR             ERROR DETECTED ALREADY?        01610000
         BO    ERRPROD                   BRANCH IF YES                  01620000
                                                                        01630000
         LA    R1,CONVID                 ADDRESS OF CONVERSATION ID     01640000
         L     R15,ICP@LOC               ENTRY POINT OF TKB/RCB LOCATE  01650000
         BASR  R14,R15                   LOCATE THE TKB/RCB             01660000
         LTR   RTKB,R1                   TKB ADDRESS                    01670000
         BNP   ERRPARM                   BRANCH IF BAD                  01680000
         LTR   RRCB,R0                   RCB ADDRESS                    01690000
         BNP   ERRPARM                   BRANCH IF BAD                  01700000
                                                                        01710000
         MVC   CONVS,RCBCONVS            COPY CONV STATE                01720000
         MVC   DEAL,RCBDEAL              COPY DEALLOCATE TYPE           01730000
                                                                        01740000
         CLC   DEAL,=A(CM_DEALLOCATE_CONFIRM)                           01750000
         BE    SETDCFM                   BRANCH IF DEALLOCATE CONFIRM   01760000
         CLC   DEAL,=A(CM_DEALLOCATE_SYNC_LEVEL)                        01770000
         BNE   STATECHK                  BRANCH IF NOT "SYNC_LEVEL"     01780000
         CLC   RCBSYNCL,=A(CM_CONFIRM)   IS SYNC LEVEL "CONFIRM"        01790000
         BE    SETDCFM                   BRANCH IF YES                  01800000
         B     STATECHK                  OTHERWISE, CONTINUE            01810000
                                                                        01820000
SETDCFM  DS    0H                                                       01830000
                                                                        01840000
         OI    FLAG,FLAGDCFM             REMEMBER "CONFIRM"             01850000
         B     STATECHK                  AND CONTINUE                   01860000
                                                                        01870000
*---------------------------------------------------------------------- 01880000
* STATE CHECK                                                           01890000
*---------------------------------------------------------------------- 01900000
                                                                        01910000
STATECHK DS    0H                                                       01920000
                                                                        01930000
         CLC   CONVS,=A(CM_SEND_STATE)                                  01940000
         BE    DSEND                     BRANCH IF SEND STATE           01950000
         CLC   CONVS,=A(CM_SEND_PENDING_STATE)                          01960000
         BE    DSENDP                    BRANCH IF SEND PENDING STATE   01970000
                                                                        01980000
         CLC   DEAL,=A(CM_DEALLOCATE_ABEND)                             01990000
         BE    DABEND                    ALL STATES OK FOR _ABEND       02000000
                                                                        02010000
         B     ERRSTATE                  BRANCH IF STATE ERROR          02020000
                                                                        02030000
*---------------------------------------------------------------------- 02040000
* PERFORM DEALLOCATION PROCESSING                                       02050000
*---------------------------------------------------------------------- 02060000
                                                                        02070000
*                                                                       02080000
* SPECIAL PROCESSING FOR CM_DEALLOCATE_ABEND WHEN NOT SEND/SEND_PENDING 02090000
*---------------------------------------------------------------------- 02100000
                                                                        02110000
DABEND   DS    0H                                                       02120000
                                                                        02130000
         BAS   R14,VTAMLOCK                                             02140000
                                                                        02150000
         $SESS $SESS_FIND_SESSION,                                     +02160000
               SESSION=RCBHSID,                                        +02170000
               ERRET=ERRSESS,                                          +02180000
               MF=(E,$SESSMFL)    LOCATE ASSOCIATED ISESS, IF ANY       02190000
                                                                        02200000
X        USING SPLIST,$SESSMFL                                          02210000
         L     RISESS,X.SPLAREA   ADDRESS OF ASSOCIATED ISESS BLOCK     02220000
         DROP  X                                                        02230000
                                                                        02240000
         TM    ISEF1,ISEF1TRM     SESS TERM STARTED?                    02250000
         BO    ERRSESS            BRANCH IF YES                         02260000
         TM    ISE62FL2,ISE62DRD  IS DRIVER DOWN?                       02270000
         BO    ERRSESS            BRANCH IF YES                         02280000
                                                                        02290000
         BAS   R14,SERR           GET US IN SEND STATE                  02300000
                                                                        02310000
         ST    R15,RETCODE        SAVE THE RETURN CODE                  02320000
         LTR   R15,R15            WAS SEND ERROR A SUCCESS?             02330000
         BNZ   ERRSERR            BRANCH IF NOT                         02340000
         MVC   RCBCONVS,=A(CM_SEND_STATE)                               02350000
                                                                        02360000
*                                                                       02370000
* DEALLOCATE WHILE IN SEND/SEND_PENDING STATE                           02380000
*---------------------------------------------------------------------- 02390000
                                                                        02400000
DSEND    DS    0H                                                       02410000
DSENDP   DS    0H                                                       02420000
                                                                        02430000
*                                                                       02440000
* RESERVE THE SESSION                                                   02450000
*---------------------------------------------------------------------- 02460000
                                                                        02470000
         BAS   R14,VTAMLOCK                                             02480000
                                                                        02490000
         $SESS $SESS_FIND_SESSION,                                     +02500000
               SESSION=RCBHSID,                                        +02510000
               ERRET=ERRSESS,                                          +02520000
               MF=(E,$SESSMFL)    LOCATE ASSOCIATED ISESS, IF ANY       02530000
                                                                        02540000
X        USING SPLIST,$SESSMFL                                          02550000
         L     RISESS,X.SPLAREA   ADDRESS OF ASSOCIATED ISESS BLOCK     02560000
         DROP  X                                                        02570000
                                                                        02580000
         TM    ISEF1,ISEF1TRM     SESS TERM STARTED?                    02590000
         BO    ERRSESS            BRANCH IF YES                         02600000
         TM    ISE62FL2,ISE62DRD  IS DRIVER DOWN?                       02610000
         BO    ERRSESS            BRANCH IF YES                         02620000
                                                                        02630000
*                                                                       02640000
* LOCATE THE SBUF                                                       02650000
*---------------------------------------------------------------------- 02660000
                                                                        02670000
         ST    RISESS,SUB0SAVE    MAKE A PLIST                          02680000
         LA    R1,SUB0SAVE        PASS ADDRESS OF PLIST                 02690000
         L     R15,ICP@SBUF       CALL THE SBUF SERVICE                 02700000
         BASR  R14,R15            LINK TO SERVICE                       02710000
                                                                        02720000
*                                                                       02730000
* VERIFY LOGICAL RECORD BOUNDARY FOR BASIC CONVERSATIONS                02740000
*---------------------------------------------------------------------- 02750000
                                                                        02760000
         CLC   DEAL,=A(CM_DEALLOCATE_ABEND)                             02770000
         BE    ABEND              NO BOUNDARY CHECK FOR ABEND TYPE      02780000
         CLC   RCBCTYPE,=A(CM_MAPPED_CONVERSATION)                      02790000
         BE    FLUSH              BRANCH IF MAPPED CONVERSATION         02800000
         OC    RCBSLLRM,RCBSLLRM  IS LAST LOGICAL RECORD COMPLETE?      02810000
         BNZ   ERRSTATE           BRANCH IF NOT                         02820000
         B     FLUSH                                                    02830000
                                                                        02840000
*                                                                       02850000
* FLUSH ANY BUFFERED DATA AND BUILD AN FMH7                             02860000
*---------------------------------------------------------------------- 02870000
                                                                        02880000
ABEND    DS    0H                                                       02890000
                                                                        02900000
         L     R3,ISE62SBF         SBUF CONTROL AREA                    02910000
X        USING SBFLIST,R3                                               02920000
         OC    X.SBFBUFO,X.SBFBUFO IS THERE BUFFERED DATA?              02930000
         DROP  X                                                        02940000
         BZ    SENDFMH7            BRANCH IF NOT                        02950000
                                                                        02960000
         BAS   R14,SENDRH          CREATE AN APPROPRIATE RH             02970000
         BAS   R14,SHIPIT          SEND OUT THE DATA                    02980000
         ST    R15,RETCODE         SAVE THE RETURN CODE                 02990000
         LTR   R15,R15             WAS SHIP SUCCESSFUL?                 03000000
         BNZ   ERRSHIP             BRANCH IF NOT                        03010000
                                                                        03020000
         BAS   R14,VTAMLOCK        RE-SERIALIZE                         03030000
                                                                        03040000
         $SESS $SESS_FIND_SESSION,                                     +03050000
               SESSION=RCBHSID,                                        +03060000
               ERRET=ERRSESS,                                          +03070000
               MF=(E,$SESSMFL)     RE-LOCATE THE ISESS                  03080000
                                                                        03090000
         TM    ISEF1,ISEF1TRM     SESS TERM STARTED?                    03100000
         BO    ERRSESS            BRANCH IF YES                         03110000
         TM    ISE62FL2,ISE62DRD  IS DRIVER DOWN?                       03120000
         BO    ERRSESS            BRANCH IF YES                         03130000
                                                                        03140000
SENDFMH7 DS    0H                                                       03150000
                                                                        03160000
         MVI   FM7LEN,7                FMH7 IS SEVEN BYTES              03170000
         MVI   FM7TYPE,7               FMH7 TYPE IS '7'                 03180000
         MVC   FM7SENSE,=XL4'08640000' DEALLOCATE_ABEND_PROG            03190000
         MVI   FM7FLAGS,0     ???????? NO ERROR LOG SUPPORT YET ??????  03200000
                                                                        03210000
         OC    ISE62KSN,ISE62KSN       IS THERE SPECIAL SENSE?          03220000
         BZ    SHIPFMH7                BRANCH IF NOT                    03230000
         MVC   FM7SENSE,ISE62KSN       USE THE SPECIAL SENSE            03240000
         XC    ISE62KSN,ISE62KSN       CLEAR THE SPECIAL SENSE          03250000
                                                                        03260000
SHIPFMH7 DS    0H                                                       03270000
                                                                        03280000
         SBUF  PACK,                                                   +03290000
               AREA=FM7,                                               +03300000
               AREALEN=7,                                              +03310000
               MF=(E,*ISE62SBF)    PLACE FMH7 IN SEND BUFFER            03320000
         BZ    *+12                BRANCH IF PACK SUCCESSFUL            03330000
         BAS   R14,SBUFBUMP        GET A LARGER SBUF                    03340000
         B     SHIPFMH7            AND PACK IT AGAIN                    03350000
                                                                        03360000
         OI    ISE62RH0,RHFI       RU STARTS WITH AN FMH                03370000
                                                                        03380000
*                                                                       03390000
* COMPLETE THE RH, SEND IT, & WAIT.                                     03400000
*---------------------------------------------------------------------- 03410000
                                                                        03420000
FLUSH    DS    0H                                                       03430000
                                                                        03440000
         BAS   R14,DEALRH          ADD APPROPRIATE RH INDICATORS        03450000
         BAS   R14,SHIPIT          SEND OUT THE DATA                    03460000
         ST    R15,RETCODE         SAVE RETURN CODE                     03470000
         LTR   R15,R15             WAS SHIP SUCCESSFUL?                 03480000
         BNZ   ERRSHIP             BRANCH IF NOT                        03490000
                                                                        03500000
*                                                                       03510000
* TRIGGER DRIVER TO RELEASE THE SESSION FOR NEXT CONVERSATION           03520000
*---------------------------------------------------------------------- 03530000
                                                                        03540000
         OI    FLAG,FLAGFREE       RELEASE THE SESSION                  03550000
         MVC   RCBCONVS,NXTSTATE   UPDATE THE STATE                     03560000
         B     RETURN              ALL DONE                             03570000
                                                                        03580000
*---------------------------------------------------------------------- 03590000
* EXCEPTION ROUTINES                                                    03600000
*---------------------------------------------------------------------- 03610000
                                                                        03620000
ERRPROD  DS    0H                                                       03630000
                                                                        03640000
         MVC   RETCODE,=A(CM_PRODUCT_SPECIFIC_ERROR)                    03650000
         B     RETURN                                                   03660000
                                                                        03670000
ERRSTATE DS    0H                                                       03680000
                                                                        03690000
         MVC   RETCODE,=A(CM_PROGRAM_STATE_CHECK)                       03700000
         B     RETURN                                                   03710000
                                                                        03720000
ERRPARM  DS    0H                                                       03730000
                                                                        03740000
         MVC   RETCODE,=A(CM_PROGRAM_PARAMETER_CHECK)                   03750000
         B     RETURN                                                   03760000
                                                                        03770000
ERRSESS  DS    0H                                                       03780000
                                                                        03790000
         MVC   RETCODE,=A(CM_RESOURCE_FAILURE_NO_RETRY)                 03800000
         B     ERRSHIP                                                  03810000
                                                                        03820000
ERRSERR  DS    0H                                                       03830000
                                                                        03840000
ERRSHIP  DS    0H                                                       03850000
                                                                        03860000
         TM    FLAG,FLAGDCFM          IS "CONFIRM" INVOLVED"?           03870000
         BO    ESLOOK                 BRANCH IF YES                     03880000
                                                                        03890000
         MVC   RETCODE,=A(CM_OK)      JUST PRETEND IT WAS OK            03900000
         MVC   RCBCONVS,=A(CM_RESET_STATE)                              03910000
         OI    FLAG,FLAGFREE          RELEASE THE SESSION               03920000
         B     RETURN                 AND RETURN                        03930000
                                                                        03940000
ESLOOK   DS    0H                                                       03950000
                                                                        03960000
         LA    R1,ESTAB                                                 03970000
         LA    R2,L'ESTABENT                                            03980000
         LA    R3,ESTABLST                                              03990000
                                                                        04000000
ESLOOP   DS    0H                                                       04010000
                                                                        04020000
         CLC   RETCODE,0(R1)          DOES RETCODE MATCH ENTRY?         04030000
         BE    ESFOUND                BRANCH IF YES                     04040000
         BXLE  R1,R2,ESLOOP           CHECK ALL TABLE ENTRIES           04050000
         B     RETURN                 JUST RETURN IF NOT IN TABLE       04060000
                                                                        04070000
ESFOUND  DS    0H                                                       04080000
                                                                        04090000
         ICM   R15,15,4(R1)           GET NEW STATE VALUE               04100000
         BP    ESGOOD                 BRANCH IF STATE IS OK             04110000
         EX    0,*                    KILL THE PROCESS                  04120000
                                                                        04130000
ESGOOD   DS    0H                                                       04140000
                                                                        04150000
         ST    R15,RCBCONVS           SET THE NEW STATE                 04160000
         C     R15,=A(CM_RESET_STATE) IS THE NEW STATE "RESET"          04170000
         BNE   RETURN                 BRANCH IF NOT                     04180000
         OI    FLAG,FLAGFREE          SET THE END CONVERSATION          04190000
         B     RETURN                 AND RETURN                        04200000
                                                                        04210000
ESTAB    DC    A(CM_CONVERSATION_TYPE_MISMATCH),A(CM_RESET_STATE)       04220000
ESTABENT EQU   ESTAB,*-ESTAB                                            04230000
         DC    A(CM_PIP_NOT_SPECIFIED_CORRECTLY),A(CM_RESET_STATE)      04240000
         DC    A(CM_SECURITY_NOT_VALID),A(CM_RESET_STATE)               04250000
         DC    A(CM_SYNC_LVL_NOT_SUPPORTED_PGM),A(CM_RESET_STATE)       04260000
         DC    A(CM_TPN_NOT_RECOGNIZED),A(CM_RESET_STATE)               04270000
         DC    A(CM_TP_NOT_AVAILABLE_NO_RETRY),A(CM_RESET_STATE)        04280000
         DC    A(CM_TP_NOT_AVAILABLE_RETRY),A(CM_RESET_STATE)           04290000
         DC    A(CM_DEALLOCATED_ABEND_TIMER),A(CM_RESET_STATE)          04300000
         DC    A(CM_DEALLOCATED_ABEND_SVC),A(CM_RESET_STATE)            04310000
         DC    A(CM_DEALLOCATED_ABEND),A(CM_RESET_STATE)                04320000
         DC    A(CM_RESOURCE_FAILURE_NO_RETRY),A(CM_RESET_STATE)        04330000
         DC    A(CM_RESOURCE_FAILURE_RETRY),A(CM_RESET_STATE)           04340000
         DC    A(CM_PROGRAM_ERROR_PURGING),A(CM_RECEIVE_STATE)          04350000
         DC    A(CM_SVC_ERROR_PURGING),A(CM_RECEIVE_STATE)              04360000
         DC    A(CM_TAKE_BACKOUT),A(-1)                                 04370000
         DC    A(CM_DEALLOCATED_ABEND_TIMER_BO),A(-1)                   04380000
         DC    A(CM_DEALLOCATED_ABEND_SVC_BO),A(-1)                     04390000
         DC    A(CM_DEALLOCATED_ABEND_BO),A(-1)                         04400000
         DC    A(CM_RESOURCE_FAIL_NO_RETRY_BO),A(-1)                    04410000
         DC    A(CM_RESOURCE_FAILURE_RETRY_BO),A(-1)                    04420000
ESTABLST EQU   *-L'ESTABENT                                             04430000
                                                                        04440000
                                                                        04450000
*---------------------------------------------------------------------- 04460000
* EXIT TRACE AND RETURN TO CALLER                                       04470000
*---------------------------------------------------------------------- 04480000
                                                                        04490000
RETURN   DS    0H                                                       04500000
                                                                        04510000
         TM    FLAG,FLAGFREE                                            04520000
         BNO   RETURNX                                                  04530000
                                                                        04540000
         L62DLRC (RRCB),                                               +04550000
               L62RETRC,                                               +04560000
               MF=(E,L62MFL)      DELETE THE RCB                        04570000
                                                                        04580000
RETURNX  DS    0H                                                       04590000
                                                                        04600000
         BAS   R14,VTAMUNLK           RELEASE THE LOCK IF NECESSARY     04610000
                                                                        04620000
         $TRACE *=A(TRC_CPIC_EXIT),48 TRACE ENTRY                       04630000
         BNZ   NOXTRACE               BRANCH IF TRACING NOT AVAILABLE   04640000
         MVC   0(8,R1),=CL8'ICPIDEAL' MODULE NAME                       04650000
         MVC   8(4,R1),RETCODE        RETURN_CODE VALUE                 04660000
         MVC   12(8,R1),CONVID        CONVERSATION ID                   04670000
         MVC   20(4,R1),CONVS         CONVERSATION STATE                04680000
         MVC   24(4,R1),DEAL          DEALLOCATE TYPE                   04690000
NOXTRACE DS    0H                                                       04700000
                                                                        04710000
         L     R1,CMLPARM2        ADDRESS OF RETURN_CODE AREA           04720000
         MVC   0(4,R1),RETCODE    SET RETURN_CODE VARIABLE              04730000
                                                                        04740000
         SR    R15,R15            FUNCTION RETURN CODE = 0              04750000
         CEXIT RC=(R15),INDEP=YES RETURN                                04760000
                                                                        04770000
*---------------------------------------------------------------------- 04780000
* SUBROUTINE SBUFBUMP: INCREASE THE SIZE OF THE SBUF                    04790000
*                                                                       04800000
* ENTRY:  R1 = SBFLIST ADDRESS                                          04810000
*                                                                       04820000
* RETURN: ALL REGISTERS ARE RESTORED.                                   04830000
*---------------------------------------------------------------------- 04840000
                                                                        04850000
SBUFBUMP DS    0H                                                       04860000
                                                                        04870000
         STM   R14,R2,SUB0SAVE    SAVE REGISTERS                        04880000
         LR    R2,R1              SBFLIST ADDRESS                       04890000
                                                                        04900000
         SBUF  OBTAIN,                                                 +04910000
               OWNER=*ISEITASK,                                        +04920000
               ERRET=ERRSBUF,                                          +04930000
               MF=(E,(R2))                                              04940000
                                                                        04950000
         LM    R14,R2,SUB0SAVE    RELOAD REGISTER                       04960000
         BR    R14                RETURN                                04970000
                                                                        04980000
*---------------------------------------------------------------------- 04990000
* SUBROUTINE SENDRH: ADD APPROPRIATE RH BITS TO SEND RH BUILD AREA      05000000
*---------------------------------------------------------------------- 05010000
                                                                        05020000
SENDRH   DS    0H                                                       05030000
                                                                        05040000
                                                                        05050000
         CLI   ISE62FSC,ISE62FSC_BETC ARE WE IN-CHAIN?                  05060000
         BNE   SENDNOBC               BRANCH IF YES                     05070000
         OI    ISE62RH0,RHBCI         SET BEGIN CHAIN                   05080000
                                                                        05090000
         CLI   ISE62FBR,ISE62FBR_BETB ARE WE IN-BRACKETS?               05100000
         BNE   SENDNOBC               BRANCH IF YES                     05110000
         OI    ISE62RH2,RHBBI         SET BEGIN BRACKET                 05120000
                                                                        05130000
SENDNOBC DS    0H                                                       05140000
                                                                        05150000
         OI    ISE62RH1,RHDR1+RHERI ASK FOR ER1                         05160000
         NI    ISE62RH1,255-RHDR2   ASK FOR ER1                         05170000
         BR    R14                  AND RETURN                          05180000
                                                                        05190000
*---------------------------------------------------------------------- 05200000
* SUBROUTINE DEALRH: ADD APPROPRIATE RH BITS TO SEND RH BUILD AREA      05210000
*---------------------------------------------------------------------- 05220000
                                                                        05230000
DEALRH   DS    0H                                                       05240000
                                                                        05250000
         MVC   NXTSTATE,=A(CM_RESET_STATE)                              05260000
         OI    ISE62RH0,RHECI         SET END CHAIN                     05270000
         OI    ISE62RH2,RHCEBI        SET CONDITIONAL END BRACKET       05280000
                                                                        05290000
         CLI   ISE62FSC,ISE62FSC_BETC ARE WE IN-CHAIN?                  05300000
         BNE   DEALNOBC               BRANCH IF YES                     05310000
         OI    ISE62RH0,RHBCI         SET BEGIN CHAIN                   05320000
                                                                        05330000
         CLI   ISE62FBR,ISE62FBR_BETB ARE WE IN-BRACKETS?               05340000
         BNE   DEALNOBC               BRANCH IF YES                     05350000
         OI    ISE62RH2,RHBBI         SET BEGIN BRACKET                 05360000
                                                                        05370000
DEALNOBC DS    0H                                                       05380000
                                                                        05390000
         CLC   DEAL,=A(CM_DEALLOCATE_FLUSH)                             05400000
         BE    DEALEXR1           USE EXCEPTION RESPONSE FOR FLUSH      05410000
         CLC   DEAL,=A(CM_DEALLOCATE_CONFIRM)                           05420000
         BE    DEALCFM            USE DR3 FOR CONFIRM                   05430000
         CLC   DEAL,=A(CM_DEALLOCATE_ABEND)                             05440000
         BE    DEALDR1            USE DR1 FOR ABEND                     05450000
         CLC   RCBSYNCL,=A(CM_NONE)                                     05460000
         BE    DEALEXR1           USE EX RESPONSE FOR SYNC LEVEL NONE   05470000
         CLC   RCBSYNCL,=A(CM_CONFIRM)                                  05480000
         BE    DEALCFM            USE DR3 FOR SYNC LEVEL CONFIRM        05490000
         CLC   RCBSYNCL,=A(CM_SYNC_POINT)                               05500000
         EX    R0,*               NOT SUPPORTED YET ******************  05510000
                                                                        05520000
DEALCFM  DS    0H                                                       05530000
                                                                        05540000
         OI    ISE62RH1,RHDR1     ASK FOR DR3                           05550000
         OI    ISE62RH1,RHDR2     ASK FOR DR3                           05560000
         NI    ISE62RH1,255-RHERI ASK FOR DR3                           05570000
         BR    R14                AND RETURN                            05580000
                                                                        05590000
DEALEXR1 DS    0H                                                       05600000
                                                                        05610000
         OI    ISE62RH1,RHDR1+RHERI ASK FOR ER1                         05620000
         NI    ISE62RH1,255-RHDR2   ASK FOR ER1                         05630000
         BR    R14                  AND RETURN                          05640000
                                                                        05650000
DEALDR1  DS    0H                                                       05660000
                                                                        05670000
         OI    ISE62RH1,RHDR1       ASK FOR DR1                         05680000
         NI    ISE62RH1,255-RHDR2   ASK FOR DR1                         05690000
         NI    ISE62RH1,255-RHERI   ASK FOR DR1                         05700000
         BR    R14                  AND RETURN                          05710000
                                                                        05720000
*---------------------------------------------------------------------- 05730000
* SUBROUTINE SERR: TRIGGER THE SESSION DRIVER TO SEND A NEGATIVE RESP.  05740000
*                  AND WAIT FOR DIRECTION.                              05750000
*                                                                       05760000
* RETURN: R15 = POST CODE FROM SERR REQUEST                             05770000
*---------------------------------------------------------------------- 05780000
                                                                        05790000
SERR     DS    0H                                                       05800000
                                                                        05810000
         STM   R14,R3,SUB1SAVE    SAVE REGISTERS                        05820000
                                                                        05830000
*                                                                       05840000
* ALLOCATE A CPIC REQUEST WORK ELEMENT                                  05850000
*---------------------------------------------------------------------- 05860000
                                                                        05870000
         $VTAMWE L'IWEY2,         SIZE                                 +05880000
               IWECSERR           CODE                                  05890000
                                                                        05900000
         LR    R3,R1              ESTABLISH ADDRESSABILITY              05910000
                                                                        05920000
*                                                                       05930000
* ALLOCATE AN XEPB                                                      05940000
*---------------------------------------------------------------------- 05950000
                                                                        05960000
         $TASK SETEPB,            INITIALIZE EPB FOR SYNCH REQUEST     +05970000
               ECODE=EC$SERR,     EVENT CODE                           +05980000
               ERRET=ERR$TASK,                                         +05990000
               MF=(E,$TASKMFL)                                          06000000
                                                                        06010000
         ST    R1,SAVEEPB         SAVE THE XEPB ADDRESS                 06020000
                                                                        06030000
*                                                                       06040000
* FILL IN THE CPIC SERR REQUEST WORK ELEMENT                            06050000
*---------------------------------------------------------------------- 06060000
                                                                        06070000
         USING IWEVTAM,R3                                               06080000
         MVC   IWEY2ENT,TKBTCBID  ENTITY TOKEN                          06090000
         MVC   IWEY2EPB,SAVEEPB   EPB ADDRESS                           06100000
         ST    RRCB,IWEY2RCB      RCB ADDRESS                           06110000
         DROP  R3                                                       06120000
                                                                        06130000
*                                                                       06140000
* QUEUE THE CPIC SERR REQUEST WORK ELEMENT TO THE SESSION QUEUE         06150000
*---------------------------------------------------------------------- 06160000
                                                                        06170000
         $VTAMQ (R3),             WORK ELEMENT                         +06180000
               ISEWEQ             QUEUE                                 06190000
                                                                        06200000
*                                                                       06210000
* RELEASE SERIALIZATION & WAIT FOR POSTING OF THE CPIC SERR REQUEST     06220000
*---------------------------------------------------------------------- 06230000
                                                                        06240000
         BAS   R14,VTAMUNLK       RELEASE LOCK                          06250000
                                                                        06260000
         $TASK WAIT,              WAIT FOR REQUEST COMPLETION          +06270000
               EPB=*SAVEEPB,      XEPB ADDRESS                         +06280000
               MF=(E,$TASKMFL)                                          06290000
                                                                        06300000
         ST    R0,SUB1SAVE+4      POST CODE (R0) IS RETURNED IN R15     06310000
         LM    R14,R3,SUB1SAVE    RELOAD REGISTER                       06320000
         BR    R14                RETURN                                06330000
                                                                        06340000
*---------------------------------------------------------------------- 06350000
* SUBROUTINE SHIPIT: TRIGGER THE SESSION DRIVER TO SEND CURRENT BUFFER  06360000
*                    AND WAIT FOR COMPLETION OF SEND.                   06370000
*                                                                       06380000
* RETURN: R15 = POST CODE FROM SHIP REQUEST                             06390000
*---------------------------------------------------------------------- 06400000
                                                                        06410000
SHIPIT   DS    0H                                                       06420000
                                                                        06430000
         STM   R14,R3,SUB1SAVE    SAVE REGISTERS                        06440000
                                                                        06450000
*                                                                       06460000
* ALLOCATE A CPIC REQUEST WORK ELEMENT                                  06470000
*---------------------------------------------------------------------- 06480000
                                                                        06490000
         $VTAMWE L'IWEXX,         SIZE                                 +06500000
               IWECSHIP           CODE                                  06510000
                                                                        06520000
         LR    R3,R1              ESTABLISH ADDRESSABILITY              06530000
                                                                        06540000
*                                                                       06550000
* ALLOCATE AN XEPB                                                      06560000
*---------------------------------------------------------------------- 06570000
                                                                        06580000
         $TASK SETEPB,            INITIALIZE EPB FOR SYNCH REQUEST     +06590000
               ECODE=EC$SHIP,     EVENT CODE                           +06600000
               ERRET=ERR$TASK,                                         +06610000
               MF=(E,$TASKMFL)                                          06620000
                                                                        06630000
         ST    R1,SAVEEPB         SAVE THE XEPB ADDRESS                 06640000
                                                                        06650000
*                                                                       06660000
* FILL IN THE CPIC SHIP REQUEST WORK ELEMENT                            06670000
*---------------------------------------------------------------------- 06680000
                                                                        06690000
         USING IWEVTAM,R3                                               06700000
         MVC   IWEXXENT,TKBTCBID  ENTITY TOKEN                          06710000
         MVC   IWEXXEPB,SAVEEPB   EPB ADDRESS                           06720000
         ST    RRCB,IWEXXRCB      RCB ADDRESS                           06730000
         DROP  R3                                                       06740000
                                                                        06750000
*                                                                       06760000
* QUEUE THE CPIC SHIP REQUEST WORK ELEMENT TO THE SESSION QUEUE         06770000
*---------------------------------------------------------------------- 06780000
                                                                        06790000
         $VTAMQ (R3),             WORK ELEMENT                         +06800000
               ISEWEQ             QUEUE                                 06810000
                                                                        06820000
*                                                                       06830000
* RELEASE SERIALIZATION & WAIT FOR POSTING OF THE CPIC SHIP REQUEST     06840000
*---------------------------------------------------------------------- 06850000
                                                                        06860000
         BAS   R14,VTAMUNLK       RELEASE LOCK                          06870000
                                                                        06880000
         $TASK WAIT,              WAIT FOR REQUEST COMPLETION          +06890000
               EPB=*SAVEEPB,      XEPB ADDRESS                         +06900000
               MF=(E,$TASKMFL)                                          06910000
                                                                        06920000
         ST    R0,SUB1SAVE+4      POST CODE (R0) IS RETURNED IN R15     06930000
         LM    R14,R3,SUB1SAVE    RELOAD REGISTER                       06940000
         BR    R14                RETURN                                06950000
                                                                        06960000
*---------------------------------------------------------------------- 06970000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 06980000
*---------------------------------------------------------------------- 06990000
                                                                        07000000
VTAMLOCK DS    0H                                                       07010000
                                                                        07020000
         TM    FLAG,FLAGLOCK        WAS THE LOCK ALREADY OBTAINED?      07030000
         BOR   R14                  RETURN IF YES                       07040000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             07050000
                                                                        07060000
         $SER  OBTAIN,                                                 +07070000
               VTAM                                                     07080000
                                                                        07090000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              07100000
         BNE   VTAMLOEX             BRANCH IF NOT                       07110000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         07120000
                                                                        07130000
VTAMLOEX DS    0H                                                       07140000
                                                                        07150000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               07160000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          07170000
         BR    R14                  RETURN                              07180000
                                                                        07190000
*---------------------------------------------------------------------- 07200000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                07210000
*---------------------------------------------------------------------- 07220000
                                                                        07230000
VTAMUNLK DS    0H                                                       07240000
                                                                        07250000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       07260000
         BNOR  R14                  BRANCH IF NOT                       07270000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             07280000
         BOR   R14                  DON'T RELEASE IF IT WAS             07290000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             07300000
                                                                        07310000
         $SER  RELEASE,                                                +07320000
               VTAM                                                     07330000
                                                                        07340000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  07350000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          07360000
         BR    R14                  RETURN                              07370000
                                                                        07380000
*---------------------------------------------------------------------- 07390000
* ERROR ROUTINES                                                        07400000
*---------------------------------------------------------------------- 07410000
                                                                        07420000
ERR$RCB  DS    0H                                                       07430000
                                                                        07440000
         $ABEND ABE_VTDIAG,                                            +07450000
               SCOPE=PCB,                                              +07460000
               TITLE='RCB CORRUPTED'                                    07470000
                                                                        07480000
ERR$TASK DS    0H                                                       07490000
                                                                        07500000
         $ABEND ABE_VTDIAG,                                            +07510000
               SCOPE=PCB,                                              +07520000
               TITLE='$TASK FAILURE'                                    07530000
                                                                        07540000
ERRSBUF  DS    0H                                                       07550000
                                                                        07560000
         $ABEND ABE_VTDIAG,                                            +07570000
               SCOPE=PCB,                                              +07580000
               TITLE='SBUF FAILURE'                                     07590000
                                                                        07600000
*---------------------------------------------------------------------- 07610000
* LITERALS AND CONSTANTS                                                07620000
*---------------------------------------------------------------------- 07630000
                                                                        07640000
         LTORG ,                                                        07650000
                                                                        07660000
         PRINT NOGEN                                                    07670000
         ISTDBIND ,               VTAM BIND IMAGE                       07680000
         ISTRH ,                  VTAM SNA REQUEST HEADER               07690000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                07700000
         IKJTCB ,                 MVS TASK CONTROL BLOCK                07710000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         07720000
         ICVT  ,                  INTEGRATOR CVT                        07730000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   07740000
         ITASK ,                  INTEGRATOR TASK BLOCK                 07750000
         IPCB ,                   INTEGRATOR PROCESS BLOCK              07760000
         IACB ,                   INTEGRATOR VTAM ACB                   07770000
         ABCODES ,                INTEGRATOR $ABEND CODES               07780000
         EVCODES ,                INTEGRATOR EVENT CODES                07790000
         ISESS ,                  INTEGRATOR SESSION BLOCK              07800000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            07810000
         IRPL ,                   INTEGRATOR VTAM RPL                   07820000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          07830000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             07840000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             07850000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             07860000
         SBUF  DSECT=YES          INTEGRATOR SBUF  SERVICES             07870000
         END   ,                                                        07880000

IVTMTPL2 TITLE 'INTEGRATOR - PLU LU2 SESSION DRIVER (TEST)'             00010000
**<DOC-ON>************************************************************* 00020000
*                                                                       00030000
* ROUTINE: IVTMTPL2 - PLU LU2 SESSION DRIVER (TEST)                     00040000
*                                                                       00050000
* DESCRIPTION: THE SESSION DRIVER IS STARTED AS A NEW PROC UNDER        00060000
*              THE SESSION ITASK WHEN A NEW SESSION IS ESTABLISHED.     00070000
*                                                                       00080000
* ON ENTRY:                                                             00090000
*                                                                       00100000
*    R15 = ENTRY POINT ADDRESS                                          00110000
*    R14 = RETURN ADDRESS                                               00120000
*    R13 = AVAILABLE SAVE AREA                                          00130000
*    R11 = ICVT ADDRESS                                                 00140000
*    R10 = ITASK ADDRESS                                                00150000
*    R01 = ADDRESS OF THE SESSION TOKEN                                 00160000
*                                                                       00170000
* ON EXIT:                                                              00180000
*                                                                       00190000
*    R15 = 0                                                            00200000
*    R00 = 0                                                            00210000
*    R01 = 0                                                            00220000
*                                                                       00230000
*    ALL OTHER REGISTERS ARE RESTORED.                                  00240000
*                                                                       00250000
**<DOC-OFF>************************************************************ 00260000
                                                                        00270000
         EJECT ,                                                        00280000
*********************************************************************** 00290000
*                                                                       00300000
* MAINTENANCE:                                                          00310000
*                                                                       00320000
*   08/01/93 RANDY WITEK                                                00330000
*                                                                       00340000
*********************************************************************** 00350000
                                                                        00360000
         EQUS  ,                  GENERAL EQUATES                       00370000
                                                                        00380000
RICVT    EQU   R11                                                      00390000
RITASK   EQU   R10                                                      00400000
RIVTAM   EQU   R9                                                       00410000
RTOKEN   EQU   R8                                                       00420000
RSPLISTR EQU   R7                                                       00430000
RSPLISTS EQU   R6                                                       00440000
                                                                        00450000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00460000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00470000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00480000
         USING SPLIST,RSPLISTR    ESTABLISH ADDRESSABILITY              00490000
S        USING SPLIST,RSPLISTS    ESTABLISH ADDRESSABILITY              00500000
                                                                        00510000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00520000
SERVNAME DS    CL8                SERVICE FAILURE NAME                  00530000
WRK256   DS    XL256              GENERAL WORKAREA                      00540000
                                                                        00550000
LV1SAVE  DS    18F                SUBROUTINE SAVE AREA                  00560000
LV0SAVE  DS    18F                SUBROUTINE SAVE AREA                  00570000
                                                                        00580000
RETRIES  DS    F                  ERROR RECOVERY RETRY COUNTER          00590000
                                                                        00600000
SNASTATE DS    F                  EXTRACT AREA                          00610000
                                                                        00620000
TERMNAME DS    CL8                TERMINAL NAME FOR PLUSESS COMMAND     00630000
MODULENM DS    CL8                MODULE   NAME FOR LOAD&GO COMMAND     00640000
POOLNAME DS    CL16               POOL     NAME FOR PLUSESS COMMAND     00650000
NEWTOKEN DS    CL8                TOKEN AREA FOR NEW SESSION            00660000
                                                                        00670000
$TASKMFL $TASK MF=L               $TASK PLIST CONSTRUCTION              00680000
$SESSRCV DS    A                  $SESS PLIST ADDRESS                   00690000
$SESSSND DS    A                  $SESS PLIST ADDRESS                   00700000
$SESSEX  $SESS MF=L,FIELDS=((SNASTATE,SNASTATE,,4))                     00710000
                                                                        00720000
RCVEPB   DS    F                  RECEIVE EPB ADDRESS                   00730000
                                                                        00740000
ECODE    DS    F                  LAST EVENT CODE                       00750000
                                                                        00760000
RETR15   DS    F                                                        00770000
RETR0    DS    F                                                        00780000
RETR1    DS    F                                                        00790000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00800000
                                                                        00810000
PROMPT   DS    XL(L'PMSG)         PROMPTING MESSAGE                     00820000
         ORG   PROMPT                                                   00830000
         DC    X'7EC31D60',C'PLATINUM INTEGRATOR - '                    00840000
PROMPTLN DC    CL57' '                                                  00850000
         DC    X'1D4013'                                                00860000
         ORG   ,                                                        00870000
                                                                        00880000
FLAGS    DS    X                  FLAG BYTE                             00890000
FLAGSQUI EQU   X'80'              QUIET MODE                            00900000
                                                                        00910000
DATASAVE DS    XL4096                                                   00920000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00930000
                                                                        00940000
         $MSGDFT PREFIX=ICTPID,                                        +00950000
               COMPID='VTM',                                           +00960000
               TABLE=*#MSGS,                                           +00970000
               WORKA=0,                                                +00980000
               MF=(E,WRK256),                                          +00990000
               PRINT=NOGEN                                              01000000
                                                                        01010000
IVTMTPL2 #ENTER BASE=R12,         ENTRY LINKAGE                        +01020000
               AMODE=31,                                               +01030000
               PREG=RTOKEN,                                            +01040000
               RMODE=ANY                                                01050000
                                                                        01060000
*---------------------------------------------------------------------- 01070000
* ESTABLISH ENVIRONMENT                                                 01080000
*---------------------------------------------------------------------- 01090000
                                                                        01100000
         L     RIVTAM,ICTVTCVT      IVTAMCVT ADDRESS                    01110000
         LA    RTOKEN,1(,RTOKEN)    POINT PAST LENGTH BYTE              01120000
         MVC   PROMPT(L'PMSG),PMSG  SET PROMPTING MESSAGE               01130000
                                                                        01140000
*---------------------------------------------------------------------- 01150000
* SET "QUIET MODE" IF REQUESTED                                         01160000
*---------------------------------------------------------------------- 01170000
                                                                        01180000
         BAS   R14,QUIETEST       CHECK FOR QUIET MODE                  01190000
                                                                        01200000
*---------------------------------------------------------------------- 01210000
* ISSUE AN INFORMATIVE MESSAGE                                          01220000
*---------------------------------------------------------------------- 01230000
                                                                        01240000
         TM    FLAGS,FLAGSQUI     QUIET MODE?                           01250000
         BO    SKIP12             BRANCH IF YES                         01260000
                                                                        01270000
         $MSG  012,               "VTAM DRIVER TOKEN...STARTING"       +01280000
               FIELDS=(((RTOKEN),4), SESSION TOKEN                     +01290000
               (4(,RTOKEN),4),       SESSION TOKEN PART2               +01300000
               (RITASK),             ITASK ADDRESS                     +01310000
               (TSKPCBC,4),          IPROC ADDRESS                     +01320000
               (TSKNAME,8))          ITASK NAME                         01330000
                                                                        01340000
SKIP12   DS    0H                                                       01350000
                                                                        01360000
*---------------------------------------------------------------------- 01370000
* ALLOCATE SEND AND RECEIVE SPLISTS FROM ITASK STORAGE                  01380000
*---------------------------------------------------------------------- 01390000
                                                                        01400000
         $GETSTOR L'SPL,                                               +01410000
               LOC=ANY,                                                +01420000
               OWNER=(RITASK)                                           01430000
                                                                        01440000
         LR    RSPLISTR,R1        THE RECEIVE PARM LIST                 01450000
         ST    R1,$SESSRCV                                              01460000
                                                                        01470000
         $GETSTOR L'SPL,                                               +01480000
               LOC=ANY,                                                +01490000
               OWNER=(RITASK)                                           01500000
                                                                        01510000
         LR    RSPLISTS,R1        THE SEND    PARM LIST                 01520000
         ST    R1,$SESSSND                                              01530000
                                                                        01540000
*---------------------------------------------------------------------- 01550000
* SAY HELLO AND START A RECEIVE                                         01560000
*---------------------------------------------------------------------- 01570000
                                                                        01580000
         B     SENDDATA                                                 01590000
                                                                        01600000
*---------------------------------------------------------------------- 01610000
* WAIT FOR AN EVENT TO OCCUR AND JUMP TO THE PROCESSING ROUTINE         01620000
*---------------------------------------------------------------------- 01630000
                                                                        01640000
WAITWORK DS    0H                                                       01650000
                                                                        01660000
         $TASK WAIT,              WAIT FOR EVENT                       +01670000
               MF=(E,$TASKMFL)                                          01680000
                                                                        01690000
         ST    R15,ECODE          SAVE THE EVENT CODE                   01700000
                                                                        01710000
         C     R15,=A(1025)       IS A RCV COMPLETE?                    01720000
         BE    RCV                BRANCH IF YES                         01730000
                                                                        01740000
         C     R15,=A(EC$STOP)    IS PROC STOP REQUESTED?               01750000
         BE    PSTP               BRANCH IF YES                         01760000
                                                                        01770000
         C     R15,=A(EC$CNCL)    IS PROC CANCEL REQUESTED?             01780000
         BE    PCAN               BRANCH IF YES                         01790000
                                                                        01800000
         B     WAITWORK           IGNORE ANYTHING ELSE                  01810000
                                                                        01820000
*---------------------------------------------------------------------- 01830000
* PROCESS A $SESS_RECEIVE COMPLETION                                    01840000
*---------------------------------------------------------------------- 01850000
                                                                        01860000
RCV      DS    0H                                                       01870000
                                                                        01880000
         L     RSPLISTR,$SESSRCV  THE RECEIVE PARM LIST                 01890000
         L     RSPLISTS,$SESSSND  THE SEND    PARM LIST                 01900000
         BAS   R14,DISPRCV        DIAGNOSTIC DISPLAY                    01910000
                                                                        01920000
*                                                                       01930000
* TEST THE RETURN CODE                                                  01940000
*---------------------------------------------------------------------- 01950000
                                                                        01960000
         CLC   SPLRETCD,=A($SESS_RC_SUCCESS)                            01970000
         BE    RCVCONT                          CHECK WHAT WAS RECEIVED 01980000
                                                                        01990000
         CLC   SPLRETCD,=A($SESS_RC_FUNCTION)                           02000000
         BE    ERR$RCV                          HOW DID THIS HAPPEN     02010000
                                                                        02020000
         CLC   SPLRETCD,=A($SESS_RC_ENVIRONMENT)                        02030000
         BE    ERR$RCV                          HOW DID THIS HAPPEN     02040000
                                                                        02050000
         CLC   SPLRETCD,=A($SESS_RC_LENGTH)                             02060000
         BE    ERR$RCV                          HOW DID THIS HAPPEN     02070000
                                                                        02080000
         CLC   SPLRETCD,=A($SESS_RC_BUSY)                               02090000
         BE    ERR$RCV                          HOW DID THIS HAPPEN     02100000
                                                                        02110000
         CLC   SPLRETCD,=A($SESS_RC_CANCELED)                           02120000
         BE    WAITWORK                         WAIT FOR PROC STOP      02130000
                                                                        02140000
         CLC   SPLRETCD,=A($SESS_RC_VTAMRC)                             02150000
         BE    RECOVER                          TRY TO RECOVER          02160000
                                                                        02170000
         CLC   SPLRETCD,=A($SESS_RC_PROTOCOL)                           02180000
         BE    RECOVER                          TRY TO RECOVER          02190000
                                                                        02200000
         CLC   SPLRETCD,=A($SESS_RC_TOT_RECEIVE_DATA)                   02210000
         BE    TIMERPOP                         TRY TO RECOVER          02220000
                                                                        02230000
*                                                                       02240000
* CHECK IF A RESPONSE WAS RECEIVED                                      02250000
*---------------------------------------------------------------------- 02260000
                                                                        02270000
RCVCONT  DS    0H                                                       02280000
                                                                        02290000
                                                                        02300000
         TM    SPLRH,RHQS         WAS IT A RESPONSE?                    02310000
         BO    RESPONSE           BRANCH IF YES                         02320000
                                                                        02330000
*                                                                       02340000
* COPY THE DATA AREA AND RELEASE IT IF THIS IS A DATA REQUEST           02350000
*---------------------------------------------------------------------- 02360000
                                                                        02370000
         TM    SPLCNTRL,RPLDATA   WAS IT A DATA REQUEST?                02380000
         BNO   RCVNAREA           BRANCH IF NOT                         02390000
         ICM   R3,15,SPLAREAL     WAS AN AREA RETURNED?                 02400000
         BZ    RCVNAREA           BRANCH IF NOT                         02410000
         L     R2,SPLAREA         ADDRESS OF DATA                       02420000
         LA    R0,DATASAVE        TEMP WORK AREA                        02430000
         L     R1,=F'4096'        SIZE OF TEMP AREA                     02440000
         MVCL  R0,R2              COPY DATA TO TEMP WORK AREA           02450000
                                                                        02460000
         $RETSTOR *SPLAREA,       RELEASE THE DATA AREA                +02470000
               OWNER=(RITASK)                                           02480000
                                                                        02490000
*                                                                       02500000
* A REQUEST WAS RECEIVED SO SEND A RESPONSE IF NEEDED                   02510000
*---------------------------------------------------------------------- 02520000
                                                                        02530000
RCVNAREA DS    0H                                                       02540000
                                                                        02550000
         BAS   R14,SENDPRSP       CALL THE RESPONSE ROUTINE             02560000
                                                                        02570000
*                                                                       02580000
* CHECK FOR A "LOGOFF"                                                  02590000
*---------------------------------------------------------------------- 02600000
                                                                        02610000
         LA    R2,DATASAVE+6      ADDRESS OF FIELD DATA                 02620000
         CLI   DATASAVE+3,X'11'   WAS SBA RECEIVED?                     02630000
         BE    CHECKOFF           BRANCH IF YES                         02640000
         LA    R2,DATASAVE+3      UNFORMATTED DATA BEGINS HERE          02650000
                                                                        02660000
CHECKOFF DS    0H                                                       02670000
                                                                        02680000
         MVC   WRK256(16),0(R2)      COPY POSSIBLE COMMAND              02690000
         OC    WRK256(16),=16C' '     UPPER CASE                        02700000
                                                                        02710000
         CLC   WRK256(6),=C'LOGOFF' LOGOFF REQUEST?                     02720000
         BNE   NOTOFF             BRANCH IF NOT                         02730000
                                                                        02740000
         $SESS $SESS_END_SESSION, END THE SESSION                      +02750000
               SESSION=(RTOKEN),                                       +02760000
               ERRET=ERR$SEND,                                         +02770000
               MF=(E,*$SESSSND)                                         02780000
         BAS   R14,DISPSND        DIAGNOSTIC DISPLAY                    02790000
         B     WAITWORK                                                 02800000
                                                                        02810000
NOTOFF   DS    0H                                                       02820000
                                                                        02830000
*                                                                       02840000
* CHECK FOR A TIMER TEST (TIMER)                                        02850000
*---------------------------------------------------------------------- 02860000
                                                                        02870000
         CLC   WRK256(5),=C'TIMER'    TIMER TEST?                       02880000
         BNE   NOTIMER                BRANCH IF NOT                     02890000
                                                                        02900000
         $SESSTMR SET,                                                 +02910000
               TOKEN=(RTOKEN),                                         +02920000
               CLASS=$SESSTMR_CLASS_RECEIVE_DATA,                      +02930000
               BINTVL=300,                                             +02940000
               ERRET=TIMEFAIL,                                         +02950000
               MF=(E,MFE_LIST)                                          02960000
                                                                        02970000
         MVC   PROMPTLN(9),=C'TIMER SET'                                02980000
         B     SENDDATA                                                 02990000
                                                                        03000000
TIMEFAIL DS    0H                                                       03010000
                                                                        03020000
         MVC   PROMPTLN(10),=C'TIMER FAIL'                              03030000
         B     SENDDATA                                                 03040000
                                                                        03050000
NOTIMER  DS    0H                                                       03060000
                                                                        03070000
*                                                                       03080000
* CHECK FOR A "SLU SESSION" REQUEST (SLUSESS-XXXXXXXX,YYYYYYYYYYYYYYYY) 03090000
*---------------------------------------------------------------------- 03100000
                                                                        03110000
         CLC   WRK256(8),=C'SLUSESS-' SLU SESSION REQUEST?              03120000
         BNE   NOTSESS                BRANCH IF NOT                     03130000
         MVC   TERMNAME(8),8(R2)      COPY TERMNAME                     03140000
         OC    TERMNAME(8),=8C' '     UPPER CASE                        03150000
         MVC   NEWTOKEN(8),0(RTOKEN)  COPY TOKEN                        03160000
         SR    R3,R3                  NO POOLNAME                       03170000
         CLI   16(R2),C','            LOOK LIKE POOLNAME SPECIFIED?     03180000
         BNE   SLUSTART               BRANCH IF NOT                     03190000
         MVC   POOLNAME(16),17(R2)    COPY POOLNAME                     03200000
         OC    POOLNAME(16),=16C' '   UPPER CASE                        03210000
         LA    R3,POOLNAME            USE THAT POOLNAME                 03220000
                                                                        03230000
SLUSTART DS    0H                                                       03240000
                                                                        03250000
         $SESS $SESS_START_SESSION, START A NEW SESSION                +03260000
               SESSION=NEWTOKEN,    WE WILL RECEIVE TOKEN HERE         +03270000
               LUNAME=TERMNAME,     HARDCODED TMRLW003 FOR TESTING     +03280000
               LOGMODE=HARDMODE,    HARDCODED LSX32702 FOR TESTING     +03290000
               POOL=(R3),           POOL NAME ADDRESS OR ZERO          +03300000
               AREA=SLUDATA,        USERDATA                           +03310000
               AREALEN=L'SLUDATA,   USERDATA LENGTH                    +03320000
               MF=(E,*$SESSSND)                                         03330000
                                                                        03340000
         BAS   R14,DISPSND          DIAGNOSTIC DISPLAY                  03350000
         B     SENDDATA                                                 03360000
                                                                        03370000
NOTSESS  DS    0H                                                       03380000
                                                                        03390000
*                                                                       03400000
* CHECK FOR A "SLU PASS" REQUEST (SLUPASS-XXXXXXXX,YYYYYYYYYYYYYYYY)    03410000
*---------------------------------------------------------------------- 03420000
                                                                        03430000
         CLC   WRK256(8),=C'SLUPASS-' SLU PASS SESSION REQUEST?         03440000
         BNE   NOTPASS                BRANCH IF NOT                     03450000
         MVC   TERMNAME(8),8(R2)      COPY TERMNAME                     03460000
         OC    TERMNAME(8),=8C' '     UPPER CASE                        03470000
         MVC   NEWTOKEN(8),0(RTOKEN)  COPY TOKEN                        03480000
         SR    R3,R3                  NO POOLNAME                       03490000
         CLI   16(R2),C','            LOOK LIKE POOLNAME SPECIFIED?     03500000
         BNE   PSSSTART               BRANCH IF NOT                     03510000
         MVC   POOLNAME(16),17(R2)    COPY POOLNAME                     03520000
         OC    POOLNAME(16),=16C' '   UPPER CASE                        03530000
         LA    R3,POOLNAME            USE THAT POOLNAME                 03540000
                                                                        03550000
PSSSTART DS    0H                                                       03560000
                                                                        03570000
         $SESS $SESS_START_SESSION, START A NEW SESSION                +03580000
               SESSION=NEWTOKEN,    WE WILL RECEIVE TOKEN HERE         +03590000
               LUNAME=TERMNAME,     HARDCODED TMRLW003 FOR TESTING     +03600000
               LOGMODE=HARDMODE,    HARDCODED LSX32702 FOR TESTING     +03610000
               POOL=(R3),           POOL NAME ADDRESS OR ZERO          +03620000
               AREA=SLUDATA,        USERDATA                           +03630000
               AREALEN=L'SLUDATA,   USERDATA LENGTH                    +03640000
               CLSDST_PASS=YES,     A SINGLE PASS WILL BE DONE         +03650000
               MF=(E,*$SESSSND)                                         03660000
                                                                        03670000
         BAS   R14,DISPSND          DIAGNOSTIC DISPLAY                  03680000
         B     SENDDATA                                                 03690000
                                                                        03700000
NOTPASS  DS    0H                                                       03710000
                                                                        03720000
*                                                                       03730000
* CHECK FOR A "SLU MPASS" REQUEST (SLUMPASS-XXXXXXXX,YYYYYYYYYYYYYYYY)  03740000
*---------------------------------------------------------------------- 03750000
                                                                        03760000
         CLC   WRK256(9),=C'SLUMPASS-' SLU MPASS SESSION REQUEST?       03770000
         BNE   NOTMPASS               BRANCH IF NOT                     03780000
         MVC   TERMNAME(8),9(R2)      COPY TERMNAME                     03790000
         OC    TERMNAME(8),=8C' '     UPPER CASE                        03800000
         MVC   NEWTOKEN(8),0(RTOKEN)  COPY TOKEN                        03810000
         SR    R3,R3                  NO POOLNAME                       03820000
         CLI   17(R2),C','            LOOK LIKE POOLNAME SPECIFIED?     03830000
         BNE   MPSSTART               BRANCH IF NOT                     03840000
         MVC   POOLNAME(16),18(R2)    COPY POOLNAME                     03850000
         OC    POOLNAME(16),=16C' '   UPPER CASE                        03860000
         LA    R3,POOLNAME            USE THAT POOLNAME                 03870000
                                                                        03880000
MPSSTART DS    0H                                                       03890000
                                                                        03900000
         $SESS $SESS_START_SESSION, START A NEW SESSION                +03910000
               SESSION=NEWTOKEN,    WE WILL RECEIVE TOKEN HERE         +03920000
               LUNAME=TERMNAME,     HARDCODED TMRLW003 FOR TESTING     +03930000
               LOGMODE=HARDMODE,    HARDCODED LSX32702 FOR TESTING     +03940000
               POOL=(R3),           POOL NAME ADDRESS OR ZERO          +03950000
               AREA=SLUDATA,        USERDATA                           +03960000
               AREALEN=L'SLUDATA,   USERDATA LENGTH                    +03970000
               MULTI_PASS=YES,      A SINGLE PASS WILL BE DONE         +03980000
               MF=(E,*$SESSSND)                                         03990000
                                                                        04000000
         BAS   R14,DISPSND          DIAGNOSTIC DISPLAY                  04010000
         B     SENDDATA                                                 04020000
                                                                        04030000
NOTMPASS DS    0H                                                       04040000
                                                                        04050000
*                                                                       04060000
* CHECK FOR PARALLEL "SLU SESS" REQ (PARSESS-XXXXXXXX,YYYYYYYYYYYYYYY)  04070000
*---------------------------------------------------------------------- 04080000
                                                                        04090000
         CLC   WRK256(8),=C'PARSESS-' PARALLEL SLU SESSION REQUEST?     04100000
         BNE   NOTPARL                BRANCH IF NOT                     04110000
         MVC   TERMNAME(8),8(R2)      COPY TERMNAME                     04120000
         OC    TERMNAME(8),=8C' '     UPPER CASE                        04130000
         MVC   NEWTOKEN(8),0(RTOKEN)  COPY TOKEN                        04140000
         SR    R3,R3                  NO POOLNAME                       04150000
         CLI   16(R2),C','            LOOK LIKE POOLNAME SPECIFIED?     04160000
         BNE   PARSTART               BRANCH IF NOT                     04170000
         MVC   POOLNAME(16),17(R2)    COPY POOLNAME                     04180000
         OC    POOLNAME(16),=16C' '   UPPER CASE                        04190000
         LA    R3,POOLNAME            USE THAT POOLNAME                 04200000
                                                                        04210000
PARSTART DS    0H                                                       04220000
                                                                        04230000
         $SESS $SESS_START_SESSION, START A NEW SESSION                +04240000
               SESSION=NEWTOKEN,    WE WILL RECEIVE TOKEN HERE         +04250000
               LUNAME=TERMNAME,     HARDCODED TMRLW003 FOR TESTING     +04260000
               LOGMODE=HARDMODE,    HARDCODED LSX32702 FOR TESTING     +04270000
               POOL=(R3),           POOL NAME ADDRESS OR ZERO          +04280000
               PARSESS=YES,         PARALLEL SESSIONS ARE OK           +04290000
               AREA=SLUDATA,        USERDATA                           +04300000
               AREALEN=L'SLUDATA,   USERDATA LENGTH                    +04310000
               MF=(E,*$SESSSND)                                         04320000
                                                                        04330000
         BAS   R14,DISPSND          DIAGNOSTIC DISPLAY                  04340000
         B     SENDDATA                                                 04350000
                                                                        04360000
NOTPARL  DS    0H                                                       04370000
                                                                        04380000
*                                                                       04390000
* CHECK FOR A "PLU SESSION" REQUEST (PLUSESS-XXXXXXXX)                  04400000
*---------------------------------------------------------------------- 04410000
                                                                        04420000
         CLC   WRK256(8),=C'PLUSESS-' PLU SESSION REQUEST?              04430000
         BNE   NOTPSESS             BRANCH IF NOT                       04440000
         MVC   TERMNAME(8),8(R2)    COPY TERMNAME                       04450000
         OC    TERMNAME(8),=8C' '     UPPER CASE                        04460000
         MVC   NEWTOKEN(8),0(RTOKEN) COPY TOKEN                         04470000
                                                                        04480000
         $SESS $SESS_START_SESSION, START A NEW SESSION                +04490000
               SESSION=NEWTOKEN,    WE WILL RECEIVE TOKEN HERE         +04500000
               LUNAME=TERMNAME,     NAME PROVIDED BY COMMAND           +04510000
               LOGMODE=HARDMODE,    HARDCODED LSX32702 FOR TESTING     +04520000
               DRIVER=TERMDRIV,     HARDCODED TESTLU2  FOR TESTING     +04530000
               PLU=YES,             WE WILL BE PLU                     +04540000
               MF=(E,*$SESSSND)                                         04550000
                                                                        04560000
         BAS   R14,DISPSND          DIAGNOSTIC DISPLAY                  04570000
         B     SENDDATA                                                 04580000
                                                                        04590000
NOTPSESS DS    0H                                                       04600000
                                                                        04610000
*                                                                       04620000
* CHECK FOR AN INDEPENDENT "PLU SESSION" REQUEST (INDSESS-XXXXXXXX)     04630000
*---------------------------------------------------------------------- 04640000
                                                                        04650000
         CLC   WRK256(8),=C'INDSESS-' PLU SESSION REQUEST?              04660000
         BNE   NOTINDEP             BRANCH IF NOT                       04670000
         MVC   TERMNAME(8),8(R2)    COPY TERMNAME                       04680000
         OC    TERMNAME(8),=8C' '     UPPER CASE                        04690000
         MVC   NEWTOKEN(8),0(RTOKEN) COPY TOKEN                         04700000
                                                                        04710000
         $SESS $SESS_START_SESSION, START A NEW SESSION                +04720000
               LUNAME=TERMNAME,     NAME PROVIDED BY COMMAND           +04730000
               LOGMODE=HARDMODE,    HARDCODED LSX32702 FOR TESTING     +04740000
               DRIVER=TERMDRIV,     HARDCODED TESTLU2  FOR TESTING     +04750000
               PLU=YES,             WE WILL BE PLU                     +04760000
               MF=(E,*$SESSSND)                                         04770000
                                                                        04780000
         BAS   R14,DISPSND          DIAGNOSTIC DISPLAY                  04790000
         B     SENDDATA                                                 04800000
                                                                        04810000
HARDMODE DC    CL8'D4A32782'                                            04820000
TERMDRIV DC    CL8'TESTLU2'                                             04830000
SLUDATA  DC    CL25'TESTLU2,QUIET'                                      04840000
                                                                        04850000
NOTINDEP DS    0H                                                       04860000
                                                                        04870000
*                                                                       04880000
* CHECK FOR A DYNAMIC MODULE INVOCATION REQUEST (LOAD&GO-XXXXXXXX)      04890000
*---------------------------------------------------------------------- 04900000
                                                                        04910000
         CLC   WRK256(8),=C'LOAD&&GO-' DYNAMIC MODULE INVOCATION?       04920000
         BNE   NOLOADGO                BRANCH IF NOT                    04930000
         MVC   MODULENM(8),8(R2)       COPY MODULE NAME                 04940000
         OC    MODULENM(8),=8C' '      UPPER CASE                       04950000
                                                                        04960000
         LOAD  EPLOC=MODULENM,                                         +04970000
               ERRET=LOADFAIL                                           04980000
                                                                        04990000
         LR    R15,R0                  ENTRY ADDRESS                    05000000
         BASR  R14,R15                 LINK TO LOADED MODULE            05010000
                                                                        05020000
         DELETE EPLOC=MODULENM                                          05030000
                                                                        05040000
         B     SENDDATA                                                 05050000
                                                                        05060000
LOADFAIL DS    0H                                                       05070000
                                                                        05080000
         MVC   PROMPTLN(11),=C'LOAD FAILED'                             05090000
         B     SENDDATA                                                 05100000
                                                                        05110000
NOLOADGO DS    0H                                                       05120000
                                                                        05130000
*                                                                       05140000
* SEND SOME DATA                                                        05150000
*---------------------------------------------------------------------- 05160000
                                                                        05170000
SENDDATA DS    0H                                                       05180000
                                                                        05190000
                                                                        05200000
         $SESS $SESS_SEND_DATA,   SEND THE DATA                        +05210000
               SESSION=(RTOKEN),                                       +05220000
               AREA=PROMPT,                                            +05230000
               AREALEN=L'PROMPT,                                       +05240000
               AUTO_PROTOCOL=YES,                                      +05250000
               MF=(E,*$SESSSND)                                         05260000
                                                                        05270000
SENDCHK  DS    0H                                                       05280000
                                                                        05290000
         BAS   R14,DISPSND        DIAGNOSTIC DISPLAY                    05300000
                                                                        05310000
         CLC   S.SPLRETCD(4),=A(0)                                      05320000
         BE    SENDGOOD                                                 05330000
         L     R1,RETRIES                                               05340000
         LA    R1,1(,R1)                                                05350000
         ST    R1,RETRIES                                               05360000
         C     R1,=F'5'                                                 05370000
         BNH   RECOVER                                                  05380000
         B     ERR$SEND                                                 05390000
                                                                        05400000
SENDGOOD DS    0H                                                       05410000
                                                                        05420000
         MVI   PROMPTLN,C' '                                            05430000
         MVC   PROMPTLN+1(L'PROMPTLN-1),PROMPTLN                        05440000
         XC    RETRIES,RETRIES                                          05450000
         B     RCVISSUE                                                 05460000
                                                                        05470000
*                                                                       05480000
* TIMER POP ROUTINE                                                     05490000
*---------------------------------------------------------------------- 05500000
                                                                        05510000
TIMERPOP DS    0H                                                       05520000
                                                                        05530000
         MVC   PROMPTLN(12),=C'TIMER POPPED'                            05540000
         B     SENDDATA                                                 05550000
                                                                        05560000
*                                                                       05570000
* RE-ISSUE THE RECEIVE                                                  05580000
*---------------------------------------------------------------------- 05590000
                                                                        05600000
RCVISSUE DS    0H                                                       05610000
                                                                        05620000
         $TASK SETEPB,                                                 +05630000
               ECODE=1025,                                             +05640000
               ERRET=ERR$TASK,                                         +05650000
               MF=(E,$TASKMFL)    ALLOCATE AN XEPB                      05660000
                                                                        05670000
         ST    R1,RCVEPB          SAVE XEPB ADDRESS                     05680000
                                                                        05690000
         $SESS $SESS_RECEIVE,                                          +05700000
               SESSION=(RTOKEN),                                       +05710000
               EPB=*RCVEPB,                                            +05720000
               ERRET=ERR$RCV,                                          +05730000
               MF=(E,*$SESSRCV)                                         05740000
                                                                        05750000
         B     WAITWORK                                                 05760000
                                                                        05770000
*---------------------------------------------------------------------- 05780000
* A RESPONSE WAS RECEIVED. IF IT WAS POSITIVE, IGNORE IT. ELSE, RECOVER 05790000
*---------------------------------------------------------------------- 05800000
                                                                        05810000
RESPONSE DS    0H                                                       05820000
                                                                        05830000
         TM    SPLRH1,RHERI       EXCEPTION RESPONSE?                   05840000
         BNO   WAITWORK           BRANCH IF NOT TO IGNORE               05850000
                                                                        05860000
RECOVER  DS    0H                                                       05870000
                                                                        05880000
         $SESS $SESS_SEND_CLEAR,  CLEAR THE SESSION                    +05890000
               SESSION=(RTOKEN),                                       +05900000
               ERRET=ERR$SEND,                                         +05910000
               MF=(E,*$SESSSND)                                         05920000
         BAS   R14,DISPSND        DIAGNOSTIC DISPLAY                    05930000
                                                                        05940000
         $SESS $SESS_SEND_SDT,    MAKE DATA_TRAFFIC_ACTIVE             +05950000
               SESSION=(RTOKEN),                                       +05960000
               ERRET=ERR$SEND,                                         +05970000
               MF=(E,*$SESSSND)                                         05980000
         BAS   R14,DISPSND        DIAGNOSTIC DISPLAY                    05990000
                                                                        06000000
         $SESS $SESS_SEND_DATA,   SEND THE GREETING                    +06010000
               SESSION=(RTOKEN),                                       +06020000
               AREA=PROMPT,                                            +06030000
               AREALEN=L'PROMPT,                                       +06040000
               AUTO_PROTOCOL=YES,                                      +06050000
               MF=(E,*$SESSSND)                                         06060000
                                                                        06070000
         B     SENDCHK                                                  06080000
                                                                        06090000
*---------------------------------------------------------------------- 06100000
* PROCESS A PROC STOP REQUEST                                           06110000
*---------------------------------------------------------------------- 06120000
                                                                        06130000
PSTP     DS    0H                                                       06140000
                                                                        06150000
         TM    FLAGS,FLAGSQUI     QUIET MODE?                           06160000
         BO    EXIT               BRANCH IF YES                         06170000
                                                                        06180000
         $MSG  982,                 "DRIVER PROC STOP"                 +06190000
               FIELDS=(((RTOKEN),4), SESSION TOKEN                     +06200000
               (4(,RTOKEN),4),       SESSION TOKEN PART2               +06210000
               (RITASK),             ITASK ADDRESS                     +06220000
               (TSKPCBC,4),          IPROC ADDRESS                     +06230000
               (TSKNAME,8))          ITASK NAME                         06240000
                                                                        06250000
         B     EXIT               EXIT WHEN STOP REQUESTED              06260000
                                                                        06270000
*---------------------------------------------------------------------- 06280000
* PROCESS A PROC CANCEL REQUEST                                         06290000
*---------------------------------------------------------------------- 06300000
                                                                        06310000
PCAN     DS    0H                                                       06320000
                                                                        06330000
         TM    FLAGS,FLAGSQUI     QUIET MODE?                           06340000
         BO    EXIT               BRANCH IF YES                         06350000
                                                                        06360000
         $MSG  979,                 "DRIVER PROC CANCEL"               +06370000
               FIELDS=(((RTOKEN),4), SESSION TOKEN                     +06380000
               (4(,RTOKEN),4),       SESSION TOKEN PART2               +06390000
               (RITASK),             ITASK ADDRESS                     +06400000
               (TSKPCBC,4),          IPROC ADDRESS                     +06410000
               (TSKNAME,8))          ITASK NAME                         06420000
                                                                        06430000
         B     EXIT               END TASK IMMEDIATELY                  06440000
                                                                        06450000
*---------------------------------------------------------------------- 06460000
* SUBROUTINE: SENDPRSP                                                  06470000
*---------------------------------------------------------------------- 06480000
                                                                        06490000
SENDPRSP DS     0H                                                      06500000
                                                                        06510000
         STM   R14,R12,LV1SAVE                                          06520000
                                                                        06530000
         $SESS $SESS_SEND_POSRESP,  SEND A RESPONSE AS NEEDED          +06540000
               SESSION=(RTOKEN),                                       +06550000
               RH=*,                                                   +06560000
               SEQNO=*,                                                +06570000
               CNTRL=*,                                                +06580000
               SENSE=*,                                                +06590000
               ERRET=ERR$RCV,                                          +06600000
               MF=(E,*$SESSRCV)                                         06610000
                                                                        06620000
         BAS   R14,DISPRCV          DIAGNOSTIC DISPLAY                  06630000
                                                                        06640000
         LM    R14,R12,LV1SAVE                                          06650000
         BR    R14                                                      06660000
                                                                        06670000
*---------------------------------------------------------------------- 06680000
* SUBROUTINE: SENDNRSP                                                  06690000
*---------------------------------------------------------------------- 06700000
                                                                        06710000
SENDNRSP DS     0H                                                      06720000
                                                                        06730000
         STM   R14,R12,LV1SAVE                                          06740000
                                                                        06750000
         $SESS $SESS_SEND_NEGRESP,  SEND A NEGATIVE RESPONSE           +06760000
               SESSION=(RTOKEN),                                       +06770000
               RH=*,                                                   +06780000
               SEQNO=*,                                                +06790000
               CNTRL=*,                                                +06800000
               SENSE=SNS1005,                                          +06810000
               ERRET=ERR$RCV,                                          +06820000
               MF=(E,*$SESSRCV)                                         06830000
                                                                        06840000
         BAS   R14,DISPRCV          DIAGNOSTIC DISPLAY                  06850000
                                                                        06860000
         LM    R14,R12,LV1SAVE                                          06870000
         BR    R14                                                      06880000
                                                                        06890000
SNS1005  DC    XL4'10050000'                                            06900000
                                                                        06910000
*---------------------------------------------------------------------- 06920000
* SUBROUTINE: DISPSND                                                   06930000
*---------------------------------------------------------------------- 06940000
                                                                        06950000
DISPSND  DS     0H                                                      06960000
                                                                        06970000
         STM   R14,R12,LV0SAVE                                          06980000
         L     RSPLISTS,$SESSSND                                        06990000
                                                                        07000000
         TM    FLAGS,FLAGSQUI        QUIET MODE?                        07010000
         BO    DISPSEND              BRANCH IF YES                      07020000
                                                                        07030000
DISPSOK  DS     0H                                                      07040000
                                                                        07050000
         $SESS $SESS_EXTRACT,                                          +07060000
               SESSION=(RTOKEN),                                       +07070000
               FIELDS=((SNASTATE,SNASTATE,,4)),                        +07080000
               MF=(E,$SESSEX)                                           07090000
                                                                        07100000
         $MSG  978,                  "DRIVER RECEIVE COMPLETE"         +07110000
               FIELDS=(((RTOKEN),4), SESSION TOKEN                     +07120000
               (4(,RTOKEN),4),       SESSION TOKEN PART2               +07130000
               (RSPLISTS),           SPLIST ADDRESS                    +07140000
               (S.SPLSENSE,4),       SENSE                             +07150000
               (S.SPLF1,4),          FLAGS                             +07160000
               (SNASTATE,4),         SESSION STATE                     +07170000
               (S.SPLAREA,4),        AREA  ADDRESS                     +07180000
               (S.SPLAREAL,4),       AREA  LENGTH                      +07190000
               (S.SPLCNTRL,3),       RPL CNTRL FLAGS                   +07200000
               (S.SPLRH,3),          RPL USERRH                        +07210000
               (S.SPLSEQNO,2),       RPL SEQNO                         +07220000
               (S.SPLRETCD,4),       THE RETURN CODE                   +07230000
               (S.SPLRSNCD,4),       THE REASON CODE                   +07240000
               (S.SPLFUNC,4))        THE FUNCTION                       07250000
                                                                        07260000
DISPSEND DS     0H                                                      07270000
                                                                        07280000
         LM    R14,R12,LV0SAVE                                          07290000
         BR    R14                                                      07300000
                                                                        07310000
*---------------------------------------------------------------------- 07320000
* SUBROUTINE: DISPRCV                                                   07330000
*---------------------------------------------------------------------- 07340000
                                                                        07350000
DISPRCV  DS     0H                                                      07360000
                                                                        07370000
         STM   R14,R12,LV0SAVE                                          07380000
         L     RSPLISTR,$SESSRCV                                        07390000
                                                                        07400000
         TM    FLAGS,FLAGSQUI        QUIET MODE?                        07410000
         BO    DISPREND              BRANCH IF YES                      07420000
                                                                        07430000
DISPROK  DS     0H                                                      07440000
                                                                        07450000
                                                                        07460000
         $SESS $SESS_EXTRACT,                                          +07470000
               SESSION=(RTOKEN),                                       +07480000
               FIELDS=((SNASTATE,SNASTATE,,4)),                        +07490000
               MF=(E,$SESSEX)                                           07500000
                                                                        07510000
         $MSG  978,                  "DRIVER RECEIVE COMPLETE"         +07520000
               FIELDS=(((RTOKEN),4), SESSION TOKEN                     +07530000
               (4(,RTOKEN),4),       SESSION TOKEN PART2               +07540000
               (RSPLISTR),           SPLIST ADDRESS                    +07550000
               (SPLSENSE,4),         SENSE                             +07560000
               (SPLF1,4),            FLAGS                             +07570000
               (SNASTATE,4),         SESSION STATE                     +07580000
               (SPLAREA,4),          AREA  ADDRESS                     +07590000
               (SPLAREAL,4),         AREA  LENGTH                      +07600000
               (SPLCNTRL,3),         RPL CNTRL FLAGS                   +07610000
               (SPLRH,3),            RPL USERRH                        +07620000
               (SPLSEQNO,2),         RPL SEQNO                         +07630000
               (SPLRETCD,4),         THE RETURN CODE                   +07640000
               (SPLRSNCD,4),         THE REASON CODE                   +07650000
               (SPLFUNC,4))          THE FUNCTION                       07660000
                                                                        07670000
DISPREND DS     0H                                                      07680000
                                                                        07690000
         LM    R14,R12,LV0SAVE                                          07700000
         BR    R14                                                      07710000
                                                                        07720000
*---------------------------------------------------------------------- 07730000
* SUBROUTINE: QUIETEST                                                  07740000
*---------------------------------------------------------------------- 07750000
                                                                        07760000
QUIETEST DS     0H                                                      07770000
                                                                        07780000
         STM   R14,R12,LV0SAVE                                          07790000
         L     RSPLISTS,$SESSSND                                        07800000
                                                                        07810000
         $SESS $SESS_EXTRACT,                                          +07820000
               SESSION=(RTOKEN),                                       +07830000
               FIELDS=((USERDATA,WRK256,,256)),                        +07840000
               MF=(E,$SESSEX)                                           07850000
                                                                        07860000
         LA    R2,WRK256          START OF USERDATA                     07870000
         CLC   0(1,R2),C'('       PL/1 FORMAT?                          07880000
         BNE   QUICHECK           BRANCH IF NOT                         07890000
         LA    R2,1(,R2)          PAST '('                              07900000
                                                                        07910000
QUICHECK DS     0H                                                      07920000
                                                                        07930000
         CLC   8(5,R2),=C'QUIET'  QUIET MODE REQUESTED?                 07940000
         BNE   QUIDONE            BRANCH IF NOT                         07950000
         OI    FLAGS,FLAGSQUI     SET QUIET MODE                        07960000
                                                                        07970000
QUIDONE  DS     0H                                                      07980000
                                                                        07990000
         LM    R14,R12,LV0SAVE                                          08000000
         BR    R14                                                      08010000
                                                                        08020000
*---------------------------------------------------------------------- 08030000
* EXIT TO END DRIVER PROCESS                                            08040000
*---------------------------------------------------------------------- 08050000
                                                                        08060000
EXIT     DS    0H                                                       08070000
                                                                        08080000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 08090000
                                                                        08100000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    08110000
                                                                        08120000
*---------------------------------------------------------------------- 08130000
* ERROR ROUTINES                                                        08140000
*---------------------------------------------------------------------- 08150000
                                                                        08160000
ERR$TASK DS    0H                                                       08170000
                                                                        08180000
         MVC   SERVNAME,=CL8'$TASK'                                     08190000
         B     ERRABEND                                                 08200000
                                                                        08210000
ERR$RCV  DS    0H                                                       08220000
                                                                        08230000
         CLC   SPLRETCD,=A($SESS_RC_CANCELED)                           08240000
         BE    WAITWORK                                                 08250000
         MVC   SERVNAME,=CL8'$SESSRCV'                                  08260000
         B     ERRABEND                                                 08270000
                                                                        08280000
ERR$SEND DS    0H                                                       08290000
                                                                        08300000
         CLC   S.SPLRETCD,=A($SESS_RC_CANCELED)                         08310000
         BE    WAITWORK                                                 08320000
         MVC   SERVNAME,=CL8'$SESSSND'                                  08330000
         B     ERRABEND                                                 08340000
                                                                        08350000
ERRABEND DS    0H                                                       08360000
                                                                        08370000
         $ABEND ABE_VTDIAG,                                            +08380000
               SCOPE=PCB,                                              +08390000
               TITLE='SERVICE FAILURE'                                  08400000
                                                                        08410000
*---------------------------------------------------------------------- 08420000
*  CONSTANTS AND LITERALS                                               08430000
*---------------------------------------------------------------------- 08440000
                                                                        08450000
PMSGSTRT DC    X'7EC31D60',C'PLATINUM INTEGRATOR - '                    08460000
PMSGAREA DC    CL57' '                                                  08470000
         DC    X'1D4013'                                                08480000
PMSG     EQU   PMSGSTRT,*-PMSGSTRT                                      08490000
                                                                        08500000
         LTORG ,                                                        08510000
                                                                        08520000
*---------------------------------------------------------------------- 08530000
*  DSECTS                                                               08540000
*---------------------------------------------------------------------- 08550000
                                                                        08560000
         PRINT NOGEN                                                    08570000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                08580000
         ISTDBIND ,               VTAM BIND IMAGE                       08590000
         ISTRH ,                  VTAM REQUEST HEADER                   08600000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         08610000
         ICVT  ,                  INTEGRATOR CVT                        08620000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   08630000
         IRPL ,                   INTEGRATOR VTAM RPL+                  08640000
         IACB ,                   INTEGRATOR VTAM ACB+                  08650000
         INIB ,                   INTEGRATOR VTAM NIB+                  08660000
         ISESS ,                  INTEGRATOR SESSION BLOCK              08670000
         ISQE ,                   INTEGRATOR SESS INIT QUEUE ELEMENT    08680000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            08690000
         ITASK ,                  INTEGRATOR TASK BLOCK                 08700000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          08710000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       08720000
         EVCODES ,                INTEGRATOR EVENT CODES                08730000
         ABCODES ,                INTEGRATOR $ABEND CODES               08740000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     08750000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        08760000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             08770000
         $PROC DSECT=YES          INTEGRATOR $PROC SERVICES             08780000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             08790000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             08800000
         $SESSTMR DSECT=YES       INTEGRATOR $SESSTMR SERVICES          08810000
         SLUHANDL ,               INTEGRATOR SLUHANDL                   08820000
         SESSIMAG ,               INTEGRATOR SESSIMAGE                  08830000
         IFGEXLST ,               VTAM EXIT LIST                        08840000
         END   ,                                                        08850000

ITSKSEPB TITLE '- INITIALIZE EVENT PROCESS BLOCK (SETEPB)'              00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE: ITSKSEPB - Initialize Event Process Block (SETEPB)           00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This service routine will initialize the event process             00080000
*    block (EPB) for a specified event.  The ECB associated             00090000
*    with an event can be either internal (within the EPB)              00100000
*    or remote.  If an ECB is remote,  the EPB will be added            00110000
*    to the ITASK remote EPB list.  The ECB is then added to            00120000
*    the events table.  If no EPB address is specified, an              00130000
*    XEPB is allocated and queued from the ICVT.  This XEPB             00140000
*    is mananged internally by the task manager.                        00150000
*                                                                       00160000
*    Remote ECB's must be initialized by the caller/service             00170000
*    managing the ECB.  The ECB will only be cleared by                 00180000
*    SETEPB when it is internal to the EPB.                             00190000
*                                                                       00200000
*    When an event completes,  the ECB is tested to validate            00210000
*    whether it is internal or remote.  By architecture,                00220000
*    an EPB must reside on a doubleword boundary with the               00230000
*    first 4 bytes containing the EPB eyecatcher followed by            00240000
*    the ECB.  If the completed ECB is on a double word bdy             00250000
*    or 4 bytes preceeding the ECB is not equal to the EPB              00260000
*    eyecatcher, then the ECB is assumed to be remote and the           00270000
*    ITASK's EPB list is searched to locate the remote EPB.             00280000
*                                                                       00290000
*    For TCBAFF=NO tasks,  remote ECBs are chained off of               00300000
*    associated server ITASK, remove EPB list.                          00310000
*                                                                       00320000
*                                                                       00330000
* ON ENTRY:                                                             00340000
*                                                                       00350000
*    R1 contains the address of the parameter list mapped by            00360000
*    the TASKPL dsect generated by $TASK DSECT=YES.                     00370000
*                                                                       00380000
* ON EXIT:                                                              00390000
*                                                                       00400000
*    R15 will contain one of the following return codes:                00410000
*                                                                       00420000
*        RC00 - Normal Completion                                       00430000
*               R1 = EPB address or XEPB token                          00440000
*                                                                       00450000
*        RC12 - Service Failure                                         00460000
*               R0 = RSN04 - XEPB allocation Error                      00470000
*                                                                       00480000
*        RC20 - Request Error                                           00490000
*               R0 = RSN04 - Invalid EPB Address                        00500000
*                    RSN08 - XEPB not available to TASKMGR              00510000
*                    RSN12 - RMT ECB not available to TASKMGR           00520000
*                                                                       00530000
* MODE:                                                                 00540000
*                                                                       00550000
*    TASK                                                               00560000
*    APF/NON-APF                                                        00570000
*    SUP/PROB                                                           00580000
*    AMODE 31, RMODE ANY                                                00590000
*                                                                       00600000
**<DOC-OFF>*****************************************************        00610000
                                                                        00620000
         EJECT ,                                                        00630000
****************************************************************        00640000
*                                                                       00650000
* MAINTENANCE:                                                          00660000
*                                                                       00670000
*   04/21/93 Ron Colmone                                                00680000
*            Initial Version                                            00690000
*                                                                       00700000
*   12/20/94 Ron Colmone          Par# 159456                           00710000
*            Added support for Task Server.                             00720000
*                                                                       00730000
****************************************************************        00740000
                                                                        00750000
         EJECT ,                                                        00760000
         $TASK DSECT=YES          TASKMGR PLIST                         00770000
         EJECT ,                                                        00780000
         @EPB  TYPE=DSECT         EVENT PROCESS BLOCK                   00790000
         EJECT ,                                                        00800000
         XEPB  ,                  EXTENDED EPB                          00810000
         EJECT ,                                                        00820000
         EQUS  ,                  GENERAL EQUATES                       00830000
                                                                        00840000
         EJECT ,                                                        00850000
         #WORK LENGTH=512         READ/WRITE WORKAREA                   00860000
SAVEPCB  DS    A                  PCB ADDRESS ASSOCIATED WITH EPB       00870000
WRK256   DS    XL256              GENERAL WORKAREA                      00880000
FLAGS    DS    X                  FLAGS                          159456 00890000
$LLCL    EQU   X'80'                LOCAL LOCK ACQUIRED          159456 00900000
$TASKMFL $TASK MF=(L,*)           $TASK PLIST CONSTRUCTION AREA         00910000
         #ENDWORK                 END OF WORKAREA                       00920000
                                                                        00930000
         EJECT ,                                                        00940000
ITSKSEPB #ENTER BASE=R12,         ENTRY LINKAGE                        +00950000
               PREG=R8,                                                +00960000
               WAPASS=YES                                               00970000
                                                                        00980000
         USING TASKPL,R8          ESTABLISH ADDRESSABILITY              00990000
         USING ITASK,R10          ESTABLISH ADDRESSABILITY              01000000
                                                                        01010000
         EJECT ,                                                        01020000
****************************************************************        01030000
*                                                                       01040000
*  INITIALIZE EPB AND ADD EVENT TO EVENTS LIST                          01050000
*                                                                       01060000
****************************************************************        01070000
SETEPB   DS    0H                                                       01080000
         LR    R5,R10             ASSUME CURRENT TASK                   01090000
         TM    TPLSCOPE,TPLS$LCL  INTRA TASK EVENT                      01100000
         BO    SEPB_PCB           YES, MUST BE CURR FOR SCOPE=LOCAL     01110000
         ICM   R0,15,TPLTASK      ADDR OF TARGET (PROCESSING) TASK      01120000
         BZ    SEPB_PCB           TARGET SPECIFIED, GET PCB ADDR        01130000
         LR    R5,R0              ADDRESS OF TARGET TASK                01140000
TGT      USING ITASK,R5           ESTAB ADDR TO TARGET ITASK            01150000
                                                                        01160000
SEPB_PCB DS    0H                                                       01170000
         ICM   R0,15,TPLPCB       PCB ADDRESS PROVIDED?                 01180000
         BNZ   *+8                YES,  USE PCB                         01190000
         L     R0,TSKPCBC         ADDR OF CURRENT PCB                   01200000
         ST    R0,SAVEPCB         SAVE ASSOCIATED PCB ADDRESS           01210000
                                                                        01220000
*---------------------------------------------------------------        01230000
*  CHECK FOR VALID EPB ADDRESS, IF NO EPB SUPPLIED, ALLOC XEPB          01240000
*---------------------------------------------------------------        01250000
         ICM   R6,15,TPLEPB       ADDR OF EVENT PROCESS BLOCK           01260000
         BZ    SEPB_XND           NONE, USE XEPB                        01270000
         USING EPB,R6             ESTABLISH ADDRESSABILITY              01280000
         TM    =X'07',*-*         TEST FOR DOUBLE WORD                  01290000
         EX    R6,*-4             ALIGNMENT                             01300000
         BNZ   ERR_EPBA           INVALID EPB ADDRESS                   01310000
                                                                        01320000
*---------------------------------------------------------------        01330000
*  If an EPB is being reinitialized and notification of the             01340000
*  event completion (i.e. Dispatch) has not been performed, then        01350000
*  issue a REMEPB task manager request to attempt to withdraw the       01360000
*  EPB from the pending event notification queue associated with        01370000
*  the workunit.                                                        01380000
*---------------------------------------------------------------        01390000
         CLC   EPBID,=CL4'EPB '   HAS EPB BEEN PREVIOUSLY INITIALIZED   01400000
         BNE   SEPB_CLR           NO,  CONTINUE WITH EPB INIT           01410000
         TM    EPBFLGS,EPB$DISP   WAS EVENT DISPATCHED?                 01420000
         BO    SEPB_CLR           YES, CONTINUE WITH EPB INIT           01430000
         TM    EPBFLGS,EPB$FLSH   WAS EVENT FLUSHED?                    01440000
         BO    SEPB_CLR           YES, CONTINUE WITH EPB INIT           01450000
                                                                        01460000
         $TASK REMEPB,            ATTEMPT TO REMOVE EVENT FROM WU      +01470000
               EPB=EPB,                                                +01480000
               WORKA=0,                                                +01490000
               MF=(E,$TASKMFL)                                          01500000
                                                                        01510000
SEPB_CLR DS    0H                                                       01520000
         XC    EPB(EPBLENG),EPB   CLEAR EVENT PROCESS BLOCK             01530000
         B     SEPB_INT           INITIALIZE EPB                        01540000
                                                                        01550000
*---------------------------------------------------------------        01560000
*  XEPB REQUIRED FOR EVENT INITIALIZATION                               01570000
*---------------------------------------------------------------        01580000
SEPB_XND DS    0H                                                       01590000
         ICM   R9,15,SAVEPCB      ASSOCIATED PCB ADDRESS                01600000
         BZ    ERR_XETM           ERROR, XEPB NOT AVAILABLE TO TASKMGR  01610000
         USING IPCB,R9            ADDRESSABILITY                        01620000
                                                                        01630000
         $XEPB ALLOC,RTASK=ITASK,PTASK=TGT.ITASK,WKA=WRK256             01640000
         LTR   R15,R15            XEPB ALLOCATED?                       01650000
         BNZ   ERR_XEPB           ERROR                                 01660000
         LR    R6,R1              XEPB ADDRESS                          01670000
                                                                        01680000
         L     R1,PCBXUSEC        OBTAIN CURRENT XEPB USE COUNT         01690000
         LA    R0,1(,R1)          INCREMENT COUNT                       01700000
         CS    R1,R0,PCBXUSEC     UPDATE XEPB USE COUNT                 01710000
         BNE   *-8                RETRY                                 01720000
                                                                        01730000
*---------------------------------------------------------------        01740000
*  Initialize EPB                                                       01750000
*---------------------------------------------------------------        01760000
SEPB_INT DS    0H                                                       01770000
         MVC   EPBID,=CL4'EPB'    EVENT PROCESS BLOCK ID                01780000
         MVC   EPBRTN@,TPLRTN@    COPY PROCESS RTN ADDR                 01790000
         MVC   EPBPARM,TPLPARM    COPY PROCESS RTN PARM ADDR            01800000
         MVC   EPBEVNT,TPLECODE   COPY PROCESS RTN PARM ADDR            01810000
                                                                        01820000
         TM    TPLSCOPE,TPLS$LCL  INTRA TASK EVENT                      01830000
         BZ    SEPB_GBL           NO, CONTINUE                          01840000
         OI    EPBFLGS,EPB$NTRA   INTRA TASK EVENT                      01850000
         OI    EPBECB,X'80'       SIMULATE WAIT                         01860000
SEPB_GBL DS    0H                                                       01870000
                                                                        01880000
         ICM   R0,15,SAVEPCB      GET ASSOCIATED PCB ADDRESS            01890000
         BNZ   SEPB_WU            SET WORKUNIT ADDRESS           159456 01900000
         LA    R0,ITASK           ADDRESS OF ITASK WORKUNIT      159456 01910000
         OI    EPBFLGS,EPB$TASK   ITASK WORKUNIT TYPE            159456 01920000
                                                                        01930000
SEPB_WU  DS    0H                                                159456 01940000
         ST    R0,EPBWU@          WORKUNIT ADDRESS                      01950000
         LA    R3,EPBECB          ADDR OF ECB TO ADD                    01960000
                                                                        01970000
*---------------------------------------------------------------        01980000
*  REMOTE ECB SPECIFIED, ADD EPB TO REMOTE EPB QUEUE                    01990000
*---------------------------------------------------------------        02000000
         ICM   R0,15,TPLECB       ADDR OF REMOTE ECB                    02010000
         BZ    SEPB_ADD           NOT REMOTE,  ADD ECB TO EVENTS        02020000
         SH    R0,=AL2(EPBECB-EPB)    OFFSET TO EPB                     02030000
         CR    R0,R6              ECB CONTAINED WITHIN EPB?             02040000
         BE    SEPB_ADD           YES, ADD ECB TO EVENTS                02050000
         ICM   R0,15,SAVEPCB      ASSOCIATED PCB ADDRESS                02060000
         BZ    ERR_RMTM           ERROR, RMT ECB NOT AVAIL TO TASKMGR   02070000
                                                                        02080000
         LR    R2,R10             ADDRESS OF CURRENT ITASK       159456 02090000
         TM    TSKFLGS3,TSK3$AFF  CURRENT ITASK ASSOC W/ SERVER  159456 02100000
         BO    *+8                NO, USE CURRENT ITASK          159456 02110000
         L     R2,TSKSVTSK        YES, USE SERVER ITASK          159456 02120000
X        USING ITASK,R2           TEMP ITASK ADDRESSABILITY      159456 02130000
                                                                        02140000
SEPB_RMT DS    0H                                                       02150000
         L     R1,X.TSKEPBS       ADDR OF FIRST EPB ON RMT LIST  159456 02160000
         ST    R1,EPBNEXT         SET NEXT EPB ADDR ON RMT LIST         02170000
         CS    R1,R6,X.TSKEPBS    UPDATE REMOTE EPB LIST         159456 02180000
         BNZ   SEPB_RMT           RETRY                                 02190000
                                                                        02200000
         OI    EPBFLGS,EPB$RMT    INDICATE REMOTE ECB                   02210000
         L     R3,TPLECB          REMOTE ECB ADDRESS                    02220000
         ST    R3,EPBECB          SET ADDR OF REMOTE ECB                02230000
         DROP  X                  ITASK (SERVER)                 159456 02240000
                                                                        02250000
*---------------------------------------------------------------        02260000
*  ADD ECB TO EVENTS LIST (PROB STATE, SVC LINKAGE)                     02270000
*---------------------------------------------------------------        02280000
SEPB_ADD DS    0H                                                       02290000
         TM    EPBFLGS,EPB$NTRA   INTRA TASK EVENT?                     02300000
         BO    SEPB_RET           YES, DON'T ADD TO EVENTS TABLE        02310000
                                                                        02320000
         TM    ICTSTAT2,ICT2$SUP  RUNNING SUP STATE                     02330000
         BO    SEPB_SUP           YES, BRANCH ENTRY EVENTS              02340000
                                                                        02350000
         EVENTS TABLE=TSKEVNT,    ADD ECB TO EVENTS LIST               +02360000
               ECB=(R3)                                                 02370000
         B     SEPB_RET           RETURN                                02380000
                                                                        02390000
*---------------------------------------------------------------        02400000
*  ADD ECB TO EVENTS LIST (SUPV STATE, BRANCH LINKAGE)                  02410000
*---------------------------------------------------------------        02420000
SEPB_SUP DS    0H                                                       02430000
         TM    TPLCFLGS,TPLC$LLH  LOCAL LOCK HELD BY CALLER      159456 02440000
         BO    LOCK_HAV           LOCK ALREADY HELD              159456 02450000
                                                                        02460000
         $SER  OBTAIN,LOCAL       ACQUIRE THE MVS LOCAL LOCK            02470000
         B     *+4(R15)           BRANCH ON LOCK RETURN CODE     159456 02480000
         B     LOCK_ACQ           LOCAL LOCK ACQUIRED            159456 02490000
         B     LOCK_HAV           LOCAL LOCK ALREADY OWNED       159456 02500000
         EX    0,*                SHOULD NOT OCCUR WITH LCL LOCK 159456 02510000
                                                                        02520000
LOCK_ACQ DS    0H                                                159456 02530000
         OI    FLAGS,$LLCL        LOCAL LOCK ACQUIRED            159456 02540000
                                                                        02550000
LOCK_HAV DS    0H                                                159456 02560000
         MODESET EXTKEY=ZERO,     SWITCH TO KEY ZERO                   +02570000
               SAVEKEY=(2)                                              02580000
                                                                        02590000
         EVENTS TABLE=TSKEVNT,    ADD ECB TO EVENTS LIST               +02600000
               ECB=(R3),                                               +02610000
               BRANCH=YES                                               02620000
                                                                        02630000
         MODESET KEYADDR=(2)      RESTORE CALLERS KEY                   02640000
                                                                        02650000
         TM    FLAGS,$LLCL        LOCAL LOCK ACQUIRED?           159456 02660000
         BZ    SEPB_RET           NO, RETURN                     159456 02670000
         $SER  RELEASE,LOCAL      RELEASE THE MVS LOCAL LOCK            02680000
                                                                        02690000
*---------------------------------------------------------------        02700000
*  RETURN NORMAL COMPLETION STATUS AND EPB ADDR/XEPB TOKEN              02710000
*---------------------------------------------------------------        02720000
SEPB_RET DS    0H                                                       02730000
         LA    R1,EPB             RETURN EPB TOKEN                      02740000
         TM    EPBFLGS,EPB$XND    EXTENDED EPB?                         02750000
         BZ    *+8                NO, RETURN                            02760000
         LA    R1,1(,R1)          RETURN XEPB TOKEN                     02770000
                                                                        02780000
         LA    R15,RC00           NORMAL COMPLETION                     02790000
         B     RETURN             RETURN                                02800000
         DROP  R6,TGT             EPB, ITASK                            02810000
                                                                        02820000
         EJECT ,                                                        02830000
****************************************************************        02840000
*                                                                       02850000
*   ERROR EXIT                                                          02860000
*                                                                       02870000
****************************************************************        02880000
                                                                        02890000
ERR_XEPB DS    0H                                                       02900000
         LA    R0,RSN04           XEPB ALLOC ERROR                      02910000
         B     RET_RC12           SERVICE  ERROR                        02920000
                                                                        02930000
ERR_EPBA DS    0H                                                       02940000
         LA    R0,RSN04           INVALID EPB ADDRESS                   02950000
         B     RET_RC20           CALLING SEQUENCE ERROR                02960000
                                                                        02970000
ERR_XETM DS    0H                                                       02980000
         LA    R0,RSN08           XEPB NOT SUPPORTTED WITHIN TASKMGR    02990000
         B     RET_RC20           REQUEST ERROR                         03000000
                                                                        03010000
ERR_RMTM DS    0H                                                       03020000
         LA    R0,RSN12           RMT ECB NOT SUPPORTED FOR TASKMGR     03030000
         B     RET_RC20           REQUEST ERROR                         03040000
                                                                        03050000
         EJECT ,                                                        03060000
****************************************************************        03070000
*                                                                       03080000
*   RETURN                                                              03090000
*                                                                       03100000
****************************************************************        03110000
                                                                        03120000
RET_RC08 DS    0H                                                       03130000
         LA    R15,RC08           SUBTASK FAILURE                       03140000
         B     RETURN                                                   03150000
                                                                        03160000
RET_RC12 DS    0H                                                       03170000
         LA    R15,RC12           ABNORMAL RETURN (SERVICE FAIL)        03180000
         B     RETURN                                                   03190000
                                                                        03200000
RET_RC20 DS    0H                                                       03210000
         LA    R15,RC20           PARAMETER ERROR                       03220000
         B     RETURN                                                   03230000
                                                                        03240000
RETURN   DS    0H                                                       03250000
         #EXIT ,                  RETURN                                03260000
                                                                        03270000
         EJECT ,                                                        03280000
****************************************************************        03290000
*                                                                       03300000
*  CONSTANTS AND LITERALS                                               03310000
*                                                                       03320000
****************************************************************        03330000
                                                                        03340000
         LTORG ,                                                        03350000
                                                                        03360000
         PRINT NOGEN                                                    03370000
         ICVT  ,                                                        03380000
         ITASK ,                                                        03390000
         IPCB  ,                                                        03400000
                                                                        03410000
         IHAPSA ,                                                       03420000
         CVT   DSECT=YES,LIST=NO                                        03430000
         IKJTCB ,                                                       03440000
         PRINT GEN                                                      03450000
                                                                        03460000
         END   ,                                                        03470000

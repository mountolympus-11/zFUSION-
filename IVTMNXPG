IVTMNXPG TITLE 'INTEGRATOR - CPIC VTAM WU INITIATION'                   00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C SERVICES             00040000
         L62INCL ,                INTEGRATOR LU6.2 SERVICES             00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: IVTMNXPG - INTEGRATOR CPIC VTAM WU INITIATION                00100000
*                                                                       00110000
* DESCRIPTION:                                                          00120000
*                                                                       00130000
* ON ENTRY:                                                             00140000
*                                                                       00150000
*    R15 = ENTRY POINT ADDRESS                                          00160000
*    R14 = RETURN ADDRESS                                               00170000
*    R13 = AVAILABLE SAVE AREA                                          00180000
*    R11 = ICVT ADDRESS                                                 00190000
*    R10 = ITASK ADDRESS                                                00200000
*    R01 = XSP ADDRESS (TP STARTUP PARM LIST)                           00210000
*                                                                       00220000
* ON EXIT:                                                              00230000
*                                                                       00240000
*    R15 = ADDRESS OF NEW ITASK                                         00250000
*    R00 = 0                                                            00260000
*    R01 = 0                                                            00270000
*                                                                       00280000
*    ALL OTHER REGISTERS ARE RESTORED                                   00290000
*                                                                       00300000
**<DOC-OFF>************************************************************ 00310000
                                                                        00320000
         EJECT ,                                                        00330000
*********************************************************************** 00340000
*                                                                       00350000
* MAINTENANCE:                                                          00360000
*                                                                       00370000
*   12/31/95 RANDY WITEK - 2.1 TRANSACTION PROGRAM VTAM WU SUPPORT      00380000
*                                                                       00390000
*********************************************************************** 00400000
                                                                        00410000
         EQUS  ,                  GENERAL EQUATES                       00420000
                                                                        00430000
RICVT    EQU   R11                                                      00440000
RITASK   EQU   R10                                                      00450000
RIVTAM   EQU   R9                                                       00460000
RIVUSER  EQU   R8                                                       00470000
RIWE     EQU   R7                                                       00480000
RXSP     EQU   R6                                                       00490000
                                                                        00500000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00510000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00520000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00530000
         USING IVUSER,RIVUSER     ESTABLISH ADDRESSABILITY              00540000
         USING IWEVTAM,RIWE       ESTABLISH ADDRESSABILITY              00550000
         USING XSP,RXSP           ESTABLISH ADDRESSABILITY              00560000
                                                                        00570000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00580000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00590000
DWORK    DS    D                  DOUBLEWORD                            00600000
$TASKMFL $TASK MF=L               PLIST CONSTRUCTION                    00610000
$RMGRMFL $RESMGR MF=L             PLIST CONSTRUCTION                    00620000
WRK256   DS    XL256              GENERAL WORKAREA                      00630000
WUNAME   DS    CL8                NAME FOR NEW TASK                     00640000
RETR15   DS    F                                                        00650000
RETR0    DS    F                                                        00660000
RETR1    DS    F                                                        00670000
RETREGS  EQU   RETR15,*-RETR15                                          00680000
FLAG     DS    X                                                        00690000
FLAGLOCK EQU   X'80'              VTAM GLOBAL LOCK HELD                 00700000
FLAGLCKD EQU   X'40'              VTAM GLOBAL LOCK HELD ON ENTRY        00710000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00720000
                                                                        00730000
         $MSGDFT PREFIX=ICTPID,                                        +00740000
               COMPID='VTM',                                           +00750000
               TABLE=*#MSGS,                                           +00760000
               WORKA=0,                                                +00770000
               MF=(E,WRK256),                                          +00780000
               PRINT=NOGEN                                              00790000
                                                                        00800000
IVTMNXPG #ENTER BASE=R12,         ENTRY LINKAGE                        +00810000
               AMODE=31,                                               +00820000
               PREG=(RXSP),                                            +00830000
               RMODE=ANY                                                00840000
                                                                        00850000
         L     RIVTAM,ICTVTCVT    IVTAMCVT ADDRESSABILITY               00860000
                                                                        00870000
*---------------------------------------------------------------------- 00880000
* SERIALIZE WITH VTAM                                                   00890000
*---------------------------------------------------------------------- 00900000
                                                                        00910000
         BAS   R14,VTAMLOCK       GO SERIALIZE                          00920000
                                                                        00930000
*---------------------------------------------------------------------- 00940000
* CREATE THE TRANSACTION PROGRAM VTAM USER TASKNAME                     00950000
* - XVXXXXXX WHERE XXXXXX IS A SIMPLE USER COUNTER VALUE                00960000
*---------------------------------------------------------------------- 00970000
                                                                        00980000
         L     R2,IVTXTSEQ        TP TASK SEQ#                          00990000
                                                                        01000000
UPDTTSEQ DS    0H                                                       01010000
                                                                        01020000
         LR    R1,R2                                                    01030000
         AL    R1,=F'1'           BUMP IT BY ONE                        01040000
         CS    R2,R1,IVTXTSEQ     ATTEMPT TO UPDATE                     01050000
         BNE   UPDTTSEQ           RETRY UPDATE IF CONTENTION            01060000
                                                                        01070000
         CVD   R1,DWORK           MAKE IT PACKED                        01080000
         OI    DWORK+7,X'0F'      NICE SIGN FOR UNPACKING               01090000
         UNPK  WUNAME+1(7),DWORK+4(4) GET A NICE ZONED DECIMAL INT.     01100000
         MVC   WUNAME(2),=CL2'XV' NAME FOR TASK IS XVNNNNNN             01110000
                                                                        01120000
*---------------------------------------------------------------------- 01130000
* ALLOCATE THE IVUSER BLOCK FOR THE TRANSACTION PROGRAM                 01140000
*---------------------------------------------------------------------- 01150000
                                                                        01160000
         LA    R3,L'IVU           ALLOCATE AN IVUSER BLOCK              01170000
                                                                        01180000
         $GETSTOR (R3),                                                +01190000
               LOC=ANY,                                                +01200000
               OWNER=(RITASK)                                           01210000
                                                                        01220000
         LR    RIVUSER,R1         REFERENCE TO IVUSER BLOCK             01230000
         MVC   IVUID,=CL8'IVUSER' SET EYECATCHER                        01240000
         ST    R3,IVULEN          SET THE LENGTH                        01250000
                                                                        01260000
         L     R1,IVTTKUSR        LAST IVUSER TOKEN                     01270000
         AL    R1,=F'1'           NEXT IVUSER TOKEN                     01280000
         ST    R1,IVTTKUSR        UPDATE LAST IVUSER TOKEN              01290000
         ST    R1,IVUTKUSR        SET THE IVUSER TOKEN WORD             01300000
                                                                        01310000
         LA    R1,IVUIS1ST        INITIALIZE USER SESSION CHAIN         01320000
         S     R1,=A(ISENEXT-ISE) NORMALIZE THE NULL HEADER             01330000
         O     R1,=X'80000000'    HI BIT ON FOR NULL HEADER             01340000
         ST    R1,IVUIS1ST        SET HEADER                            01350000
         ST    R1,IVUISLST        SET HEADER                            01360000
                                                                        01370000
         OI    IVUF4,IVUF4XPG     SHOW IVUSER FOR CPIC TRANSACTION PGM  01380000
                                                                        01390000
         $VTAM ADDUSER,           ADD IVUSER TO LOOKUP TABLE           +01400000
               AREA=(RIVUSER),    PASS ADDRESS OF IVUSER BLOCK         +01410000
               ERRET=ERR$VTAM,    IF AN ERROR                          +01420000
               MF=(E,MFE_LIST)    USE STANDARD PARMLIST AREA            01430000
                                                                        01440000
*---------------------------------------------------------------------- 01450000
* RELEASE VTAM LOCK                                                     01460000
*---------------------------------------------------------------------- 01470000
                                                                        01480000
         BAS   R14,VTAMUNLK       RELEASE                               01490000
                                                                        01500000
*---------------------------------------------------------------------- 01510000
* CREATE A NEW SUBTASK FOR THE IVUSER                                   01520000
*---------------------------------------------------------------------- 01530000
                                                                        01540000
         $TASK SETEPB,            INITIALIZE TASK TERMINATION EPB      +01550000
               ECODE=EC$VTUT,     USER TERMINATION IS THE CODE         +01560000
               ERRET=ERR$TASK,                                         +01570000
               MF=(E,$TASKMFL)                                          01580000
                                                                        01590000
         LR    R3,R1              TASK TERMINATION EPB ADDRESS          01600000
         L     R2,=F'-1'          DPMOD VALUE FOR $TASK CREATE          01610000
                                                                        01620000
         $TASK CREATE,            CREATE THE IVUSER SUBTASK            +01630000
               EP=*IVT@USER,      PROC MAIN CODE FOR IVUSER SUBTASK    +01640000
               NAME=WUNAME,       NAME FOR NEW TASK                    +01650000
               PARM=(RIVUSER),    PASS IVUSER AS PARM                  +01660000
               SYNC=YES,          WAIT FOR SUBTASK TO START            +01670000
               TERMEPB=(R3),      POST THIS EPB WHEN SUBTASK IS GONE   +01680000
               DPMOD=(R2),        DISPATCH AT SLIGHTLY LOWER PRIORITY  +01690000
               ERRET=ERR$TASK,                                         +01700000
               MF=(E,$TASKMFL)                                          01710000
                                                                        01720000
         LR    R3,R1              NEW ITASK ADDRESS                     01730000
         ST    R3,RETR15          SAVE AS RETURN VALUE                  01740000
                                                                        01750000
         $SER  OBTAIN,                                                 +01760000
               DISP                                                     01770000
                                                                        01780000
         $RESMGR ADD,             ADD A RESOURCE MANAGER               +01790000
               TOKEN=IVURMTOK,    PLACE RESOURCE MANAGER TOKEN HERE    +01800000
               OWNER=(R3),        FOR THE NEW ITASK                    +01810000
               ROUTINE=*IVT@UMGR, RESOURCE MANAGER CODE IS IVTMUMGR    +01820000
               PARM=(RIVUSER),    R1 WILL POINT TO THE IVUSER BLOCK    +01830000
               MF=(E,$RMGRMFL)                                          01840000
                                                                        01850000
         $SER  RELEASE,                                                +01860000
               DISP                                                     01870000
                                                                        01880000
         ST    RIVUSER,TSKIVUSR-ITASK(,R3) LINK IVUSER TO ITASK         01890000
         ST    R3,IVUITASK        SET ITASK ADDRESS IN IVUSER BLOCK     01900000
         MVC   IVUITSKN,WUNAME    SET ITASK NAME    IN IVUSER BLOCK     01910000
                                                                        01920000
*---------------------------------------------------------------------- 01930000
* ALLOCATE THE CPIC TP LOGON WORK ELEMENT FOR IVUSER WORK               01940000
*---------------------------------------------------------------------- 01950000
                                                                        01960000
         $VTAMWE L'IWEYD,         SIZE                                 +01970000
               IWECXPGL           CODE                                  01980000
                                                                        01990000
         LR    RIWE,R1            ESTABLISH ADDRESSIBILITY              02000000
         ST    RXSP,IWEYDXSP      SET PARM LIST ADDRESS                 02010000
                                                                        02020000
*---------------------------------------------------------------------- 02030000
* POST THE NEW TASK FOR LOGON STARTUP                                   02040000
*---------------------------------------------------------------------- 02050000
                                                                        02060000
         ST    RIWE,IVUWEQ        SET WE FOR THE IVUSER TASK            02070000
         ST    RIWE,IVU1STWE      SET FIRST WORK ELEMENT ADDRESS        02080000
                                                                        02090000
         POST  IVUSTECB,LINKAGE=SYSTEM                                  02100000
                                                                        02110000
         B     RETURN                                                   02120000
                                                                        02130000
*---------------------------------------------------------------------- 02140000
* RETURN TO MAIN TASK MAINLINE                                          02150000
*---------------------------------------------------------------------- 02160000
                                                                        02170000
RETURN   DS    0H                                                       02180000
                                                                        02190000
         BAS   R14,VTAMUNLK       RELEASE THE LOCK IF NECESSARY         02200000
         LM    R15,R1,RETREGS     SET RETURN REGISTERS                  02210000
                                                                        02220000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    02230000
                                                                        02240000
*---------------------------------------------------------------------- 02250000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 02260000
*---------------------------------------------------------------------- 02270000
                                                                        02280000
VTAMLOCK DS    0H                                                       02290000
                                                                        02300000
         TM    FLAG,FLAGLOCK        WAS THE LOCK ALREADY OBTAINED?      02310000
         BOR   R14                  RETURN IF YES                       02320000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             02330000
                                                                        02340000
         $SER  OBTAIN,                                                 +02350000
               VTAM                                                     02360000
                                                                        02370000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              02380000
         BNE   VTAMLOEX             BRANCH IF NOT                       02390000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         02400000
                                                                        02410000
VTAMLOEX DS    0H                                                       02420000
                                                                        02430000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               02440000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          02450000
         BR    R14                  RETURN                              02460000
                                                                        02470000
*---------------------------------------------------------------------- 02480000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                02490000
*---------------------------------------------------------------------- 02500000
                                                                        02510000
VTAMUNLK DS    0H                                                       02520000
                                                                        02530000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       02540000
         BNOR  R14                  BRANCH IF NOT                       02550000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             02560000
         BOR   R14                  DON'T RELEASE IF IT WAS             02570000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             02580000
                                                                        02590000
         $SER  RELEASE,                                                +02600000
               VTAM                                                     02610000
                                                                        02620000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  02630000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          02640000
         BR    R14                  RETURN                              02650000
                                                                        02660000
*---------------------------------------------------------------------- 02670000
* ERROR ROUTINES                                                        02680000
*---------------------------------------------------------------------- 02690000
                                                                        02700000
ERR$TASK DS    0H                                                       02710000
                                                                        02720000
         $ABEND ABE_VTDIAG,                                            +02730000
               SCOPE=PCB,                                              +02740000
               TITLE='$TASK FAILURE'                                    02750000
                                                                        02760000
ERR$VTAM DS    0H                                                       02770000
                                                                        02780000
         $ABEND ABE_VTDIAG,                                            +02790000
               SCOPE=PCB,                                              +02800000
               TITLE='$VTAM FAILURE'                                    02810000
                                                                        02820000
*---------------------------------------------------------------------- 02830000
*  CONSTANTS AND LITERALS                                               02840000
*---------------------------------------------------------------------- 02850000
                                                                        02860000
         LTORG ,                                                        02870000
         PRINT NOGEN                                                    02880000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                02890000
         ISTDBIND ,               VTAM BIND IMAGE                       02900000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         02910000
         ICVT  ,                  INTEGRATOR CVT                        02920000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   02930000
         IRPL ,                   INTEGRATOR VTAM RPL+                  02940000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            02950000
         ISESS ,                  INTEGRATOR VTAM SESSION BLOCK         02960000
         ITASK ,                  INTEGRATOR TASK BLOCK                 02970000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          02980000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       02990000
         EVCODES ,                INTEGRATOR EVENT CODES                03000000
         ABCODES ,                INTEGRATOR $ABEND CODES               03010000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     03020000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        03030000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             03040000
         $PROC DSECT=YES          INTEGRATOR $PROC SERVICES             03050000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             03060000
         $RESMGR DSECT=YES        INTEGRATOR $RESMGR SERVICES           03070000
         END   ,                                                        03080000

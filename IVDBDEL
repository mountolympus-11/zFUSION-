IVDBDEL  TITLE '- VIRTUAL DATABASE (VDB) TABLE DELETE'                  00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: IVDBDEL - VDB table delete                                   00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine is invoked by a cooperative process to                00080000
*    delete all SYSTABLES and SYSCOLUMNS entries for a VDB              00090000
*    table named in the request. SYSTABLES contains at most             00100000
*    a single entry for the table. SYSCOLUMNS contains one              00110000
*    entry for each table column.                                       00120000
*                                                                       00130000
*                                                                       00140000
* ON ENTRY:                                                             00150000
*                                                                       00160000
*    R1  points to a parameter list described by the XVDB               00170000
*        mapping                                                        00180000
*                                                                       00190000
*                                                                       00200000
* ON EXIT:                                                              00210000
*                                                                       00220000
*    R15 contains the return code presented by the $XPBUFR              00230000
*        service                                                        00240000
*                                                                       00250000
*    The request response status is sent to coop in the format          00260000
*    described by the TMRESP mapping.                                   00270000
*                                                                       00280000
*    TMRSRC contains one of the following return codes. The             00290000
*    reason code (TMRSRSN), super code (TMRSUPRC), and info             00300000
*    code (TMRSINFO) contain additional completion status               00310000
*    when applicable as described below.                                00320000
*                                                                       00330000
*       RC00 - request completed without error                          00340000
*                                                                       00350000
*       RC04 - the table named did not exist                            00360000
*                                                                       00370000
*       RC08 - table services returned an error status when             00380000
*              presented with one of the source (input) rows.           00390000
*                                                                       00400000
*              SUPER    - 16 bit TBSERV RSN / 16 bit TBSERV RC          00410000
*              INFO     - table services diagnostic info                00420000
*                                                                       00430000
*       RC12 - reserved                                                 00440000
*                                                                       00450000
*       RC16 - insufficient storage                                     00460000
*                                                                       00470000
*       RC20 - response buffer service failure                          00480000
*                                                                       00490000
**<DOC-OFF>****************************************************         00500000
                                                                        00510000
         EJECT                                                          00520000
***************************************************************         00530000
*                                                                       00540000
* MAINTENANCE:                                                          00550000
*                                                                       00560000
*   11/xx/93 R. Turgeon                                                 00570000
*            Initial version                                            00580000
*                                                                       00590000
*   08/16/93 Ron Colmone                                                00600000
*            Converted to STDENV                                        00610000
*                                                                       00620000
*   10/05/95 R. Turgeon                                                 00630000
*            Raise SYSTABLES and SYSCOLUMNS update flags in             00640000
*            the IPROJ to indicate that changes have occurred           00650000
*            to those componens of the project catalog.                 00660000
*                                                                       00670000
***************************************************************         00680000
                                                                        00690000
         EJECT                                                          00700000
         #WORK LENGTH=1024                                              00710000
                                                                        00720000
ERRINFO  DS    0F            R14-R1 UPON SERVICE ROUTINE FAILURE        00730000
ERR_R14  DS    F                                                        00740000
ERR_R15  DS    F                                                        00750000
ERR_R0   DS    F                                                        00760000
ERR_R1   DS    F                                                        00770000
                                                                        00780000
BUFA     DS    A             RETRIEVAL BUFFER ORIGIN                    00790000
BUFL     DS    F             RETRIEVAL BUFFER LENGTH                    00800000
                                                                        00810000
RETC     DS    F             RETURN CODE                                00820000
RSNC     DS    F             REASON CODE                                00830000
DIAGNOSE DS    F             DIAGNOSTICS                                00840000
SUPER    DS    F             SUPER CODE                                 00850000
                                                                        00860000
MSGA     DS    A             MSG ADDRESS                                00870000
MSGLN    DS    F             MSG LENGTH                                 00880000
                                                                        00890000
VRESP    DS    A             ADDRESS OF VDB RESPONSE HEADER             00900000
                                                                        00910000
$RESPHDR DS    XL(YVDRSPLN)  RESPONSE HEADER                            00920000
                                                                        00930000
$SYSTABL DS    XL(STBLN)     SYSTABLE KEYROW CONSTRUCTION               00940000
SARGAREA DS    XL256         SEARCH ARGUMENT CONSTRUCTION AREA          00950000
                                                                        00960000
         #ENDWORK ,                                                     00970000
                                                                        00980000
         EJECT                                                          00990000
         REQHDR ,            REQUEST BLOCK HEADER                       01000000
                                                                        01010000
         EJECT                                                          01020000
         XVDB  ,             REQUEST BLOCK FORMAT                       01030000
                                                                        01040000
         EJECT                                                          01050000
         YVDBRESP ,          RESPONSE HEADER                            01060000
                                                                        01070000
         EJECT                                                          01080000
         IPROJ ,             PROJECT BLOCK                              01090000
                                                                        01100000
         EJECT                                                          01110000
         ICATALOG TABLE,COLUMN                                          01120000
                                                                        01130000
         EJECT                                                          01140000
         TBSERVIS DELETE,GET,SET                                        01150000
                                                                        01160000
         EJECT                                                          01170000
         EQUS  ,                                                        01180000
                                                                        01190000
         EJECT                                                          01200000
IVDBDEL  #ENTER BASE=R12,PREG=R8,WAPASS=YES                             01210000
                                                                        01220000
         USING ITASK,R10          ITASK ADDRESSABILITY                  01230000
         L     R9,TSKPCBC         ADDRESS OF CURRENT PCB                01240000
         USING IPCB,R9            IPCB  ADDRESSABILITY                  01250000
                                                                        01260000
         L     R7,PCBUSER         ADDRESS OF IUSER                      01270000
         USING IUSER,R7           ADDRESSABILITY                        01280000
                                                                        01290000
         L     R7,USRPROJ         PROJECT CONTROL AREA                  01300000
         USING IPROJ,R7           LIFE OF FUNCTION                      01310000
                                                                        01320000
*--------------------------------------------------------------         01330000
*  Define VDB response header in TXP buffer                             01340000
*--------------------------------------------------------------         01350000
                                                                        01360000
         USING XVDB,R8            LIFE OF FUNCTION                      01370000
                                                                        01380000
         LA    R4,$RESPHDR        ADDRESS OF RESPONSE HEADER            01390000
         USING YVDBRESP,R4        ADDRESSABILITY                        01400000
         XC    YVDBRESP(YVDRSPLN),YVDBRESP                              01410000
                                                                        01420000
         $XPBUFR ISRT,            ADD RESPONSE HEADER TO XPBUFR        +01430000
               NEWFUNC=(VDB,VDB$DEL),                                  +01440000
               DATA=YVDBRESP,                                          +01450000
               DATALEN=YVDRSPLN,                                       +01460000
               MF=(E,MFE_LIST)                                          01470000
         BNZ   ERR_ITXP           RESPONSE ERROR                        01480000
         ST    R1,VRESP           RESPONSE HEADER RETURN                01490000
                                                                        01500000
         EJECT                                                          01510000
***************************************************************         01520000
*                                                                       01530000
*   Prepare for SYSCOLUMNS table scan                                   01540000
*                                                                       01550000
***************************************************************         01560000
                                                                        01570000
         LA    R5,SARGAREA        SEARCH ARGUMENT CONSTRUCTION AREA     01580000
         USING TBSARGS,R5         SARG FORMAT                           01590000
         XC    TBSARGS(TBSAFIXL),TBSARGS                                01600000
         MVI   TBSAVER,TBSAV0     SEARCH ARGUMENT FORMAT                01610000
         MVI   TBSABOOL,TBSABAND  SATISFY ALL ARGUMENTS                 01620000
         LA    R0,1               NUMBER OF ARGUMENTS                   01630000
         STH   R0,TBSAENTS        POST APPROPRIATELY                    01640000
                                                                        01650000
         MVI   TBSAOPR,TBSAO$EQ   MATCHING TABLE NAMES ONLY             01660000
         MVI   TBSAARSV,0         RESERVED                              01670000
         MVC   TBSAACOL,=CL(L'TBSAACOL)'SCOLTBNM'                       01680000
         MVC   TBSAAVAL(L'XVDTNAME),XVDTNAME  TABLE NAME AS COMPARAND   01690000
                                                                        01700000
         LA    R0,TBSAFIXL+TBSANFXL+L'XVDTNAME                          01710000
         STH   R0,TBSALEN                                               01720000
                                                                        01730000
         LA    R2,XVDCOLTK        ASSUME SYSCOLUMNS TOKEN PROVIDED      01740000
         ICM   R0,15,XVDCOLTK     TOKEN PROVIDED?                       01750000
         LA    R2,PRJTKCOL        ELSE USE PROJECT SYSCOLUMNS           01760000
                                                                        01770000
*--------------------------------------------------------------         01780000
*   Prepare to scan entire table                                        01790000
*--------------------------------------------------------------         01800000
                                                                        01810000
         TBSET POS=TOP,           PREPARE FOR SEQUENTIAL SCAN          +01820000
               TTOKEN=(R2),                                            +01830000
               MF=(E,MFE_LIST)                                          01840000
                                                                        01850000
         LA    R3,SCOLN           COLUMN ROW LENGTH                     01860000
                                                                        01870000
         $GETSTOR (R3),COND=YES   ACQUIRE STORAGE FOR SYSCOLUMNS        01880000
         BNZ   ERR_STG            FAIL IF NOT                           01890000
                                                                        01900000
         ST    R3,BUFL            BUFFER LENGTH                         01910000
         ST    R1,BUFA            BUFFER ADDRESS                        01920000
                                                                        01930000
         EJECT                                                          01940000
***************************************************************         01950000
*                                                                       01960000
*   Locate (read) and delete next eligible column entry                 01970000
*                                                                       01980000
***************************************************************         01990000
                                                                        02000000
DELSCAN  DS    0H                                                       02010000
         TBGET *BUFA,             SET CRP TO MATCHING ROW              +02020000
               LENGTH=*BUFL,      ACQUIRE NEXT MATCHING SYSCOLUMN      +02030000
               POS=NEXT,          SEQUENTIAL SCAN USING SARGS          +02040000
               SARGS=TBSARGS,                                          +02050000
               TTOKEN=(R2),                                            +02060000
               MF=(E,MFE_LIST)                                          02070000
                                                                        02080000
         CH    R15,=AL2(RC04)     TEST SERVICE COMPLETION               02090000
         BL    DELCOL             ROW ACQUIRED, DELETE                  02100000
         BH    ETBSRV             TABLE SERVICES ERROR                  02110000
         LTR   R0,R0              EOF?                                  02120000
         BZ    DELTABLE           DONE IF SO                            02130000
                                                                        02140000
*--------------------------------------------------------------         02150000
*   Buffer inadequate for SYSCOLUMNS entry                              02160000
*--------------------------------------------------------------         02170000
                                                                        02180000
         LR    R3,R0              PRESERVE BUFFER SIZE                  02190000
         AL    R3,BUFL            SIZE REQUIRED, AND THEN SOME          02200000
                                                                        02210000
         $RETSTOR *BUFA           RELEASE PREVIOUSLY ACQUIRED STORAGE   02220000
                                                                        02230000
         $GETSTOR (R3),COND=YES   ACQUIRE MORE SUITABLE EXTENT          02240000
         BNZ   ERR_STG            FAIL IF NOT                           02250000
                                                                        02260000
         ST    R3,BUFL            BUFFER LENGTH                         02270000
         ST    R1,BUFA            BUFFER ADDRESS                        02280000
         B     DELSCAN            RETRY                                 02290000
                                                                        02300000
*--------------------------------------------------------------         02310000
*   Delete column entry                                                 02320000
*--------------------------------------------------------------         02330000
                                                                        02340000
DELCOL   DS    0H                 CRP SET TO ENTRY ELIGIBLE FOR DELETE  02350000
         TBDELETE TTOKEN=(R2),    DELETE CURRENT ENTRY AND REPOS CRP   +02360000
               POS=CURRENT,                                            +02370000
               MF=(E,MFE_LIST)                                          02380000
                                                                        02390000
         CH    R15,=AL2(RC04)     TEST SERVICE COMPLETION               02400000
         BH    ETBSRV             TABLE SERVICES ERROR                  02410000
                                                                        02420000
         OI    PRJMNTF1,PRJM1COL  SYSCOLUMNS UPDATED                    02430000
         B     DELSCAN            PROCESS ALL MATCHES                   02440000
                                                                        02450000
         EJECT                                                          02460000
***************************************************************         02470000
*                                                                       02480000
*   Delete SYSTABLES entry                                              02490000
*                                                                       02500000
***************************************************************         02510000
                                                                        02520000
DELTABLE DS    0H                                                       02530000
         LA    R4,$SYSTABL        KEY ROW CONSTRUCTION AREA             02540000
         USING SYSTABLE,R4        ROW FORMAT                            02550000
         XC    SYSTABLE(STBLN),SYSTABLE                                 02560000
         MVC   STBLNAME,XVDTNAME  TABLE NAME                            02570000
                                                                        02580000
         LA    R2,XVDTABTK        ASSUME SYSTABLES TOKEN PROVIDED       02590000
         ICM   R0,15,XVDTABTK     TABLE TOKEN PROVIDED?                 02600000
         LA    R2,PRJTKTAB        ELSE USE PROJECT SYSTABLES            02610000
                                                                        02620000
         TBDELETE KEYROW=SYSTABLE,                                     +02630000
               INDEX='PRIMARY',                                        +02640000
               TTOKEN=(R2),                                            +02650000
               MF=(E,MFE_LIST)                                          02660000
                                                                        02670000
         LTR   R15,R15            PRESERVE COMPLETION CODE              02680000
         CH    R15,=AL2(RC04)     NORMAL END (MORE OR LESS)?            02690000
         BH    ETBSRV             FAIL IF NOT                           02700000
                                                                        02710000
         OI    PRJMNTF1,PRJM1TAB  SYSTABLES UPDATED                     02720000
         DROP  R4                 SYSTABLES                             02730000
                                                                        02740000
         EJECT                                                          02750000
***************************************************************         02760000
*                                                                       02770000
*   Post completion codes                                               02780000
*                                                                       02790000
***************************************************************         02800000
                                                                        02810000
         LTR   R15,R15            AS PRESENTED BY SYSTABLES DELETE      02820000
         SR    R0,R0                                                    02830000
         SR    R1,R1                                                    02840000
         SR    R2,R2              NO MSG RETURNED                       02850000
         SR    R3,R3              NO MSG RETURNED                       02860000
         B     RESPOND                                                  02870000
                                                                        02880000
ETBSRV   DS    0H                 TABLE SERVICES ERROR                  02890000
         STM   R14,R1,ERRINFO     PRESERVE DIAGNOSTICS                  02900000
         L     R14,ERR_R0         TABLE SERVICE REASON CODE             02910000
         SLL   R14,16             SHIFT TO UPPER HALFWORD               02920000
         O     R14,ERR_R15        INSERT RETURN CODE                    02930000
         ST    R14,SUPER          SAVE AS SUPER CODE                    02940000
                                                                        02950000
         LA    R15,RC08           ALL ROWS NOT PROCESSED                02960000
         LA    R0,RSN00           NO REASON CODES DEFINED               02970000
         L     R1,ERR_R1          DIAGNOSTICS FROM SERVICE ROUTINE      02980000
         LA    R2,MSGTBSRV                                              02990000
         LA    R3,L'MSGTBSRV                                            03000000
         B     RESPOND                                                  03010000
                                                                        03020000
RESPOND  DS    0H                                                       03030000
         ST    R15,RETC                                                 03040000
         ST    R0,RSNC                                                  03050000
         ST    R1,DIAGNOSE                                              03060000
         ST    R2,MSGA            MSG ADDRESS OR ZERO                   03070000
         ST    R3,MSGLN           MSG LENGTH                            03080000
         B     RESPXMIT                                                 03090000
                                                                        03100000
*--------------------------------------------------------------         03110000
                                                                        03120000
ERR_STG  DS    0H                                                       03130000
         LA    R15,RC16           CATASTOPHIC FAILURE                   03140000
         ST    R15,RETC           PREPARE FOR EXIT                      03150000
         B     EXIT                                                     03160000
                                                                        03170000
ERR_ITXP DS    0H                                                       03180000
         LA    R15,RC20           CATASTOPHIC FAILURE                   03190000
         ST    R15,RETC           PREPARE FOR EXIT                      03200000
         B     EXIT                                                     03210000
                                                                        03220000
         DROP  R8                 XVDB                                  03230000
                                                                        03240000
         EJECT                                                          03250000
***************************************************************         03260000
*                                                                       03270000
*   Return completion status to cooperative process                     03280000
*                                                                       03290000
***************************************************************         03300000
                                                                        03310000
RESPXMIT DS    0H                                                       03320000
         L     R4,VRESP           ADDR OF RESPONSE HEADER               03330000
         USING YVDBRESP,R4        TABLE INTERFACE RESPONSE PREFIX       03340000
                                                                        03350000
         MVC   YVDRETC,RETC       POST RETURN CODE                      03360000
         MVC   YVDRSNC,RSNC       POST REASON CODE                      03370000
         MVC   YVDINFO,DIAGNOSE   DIAGNOSTIC CODES IF APPLICABLE        03380000
         MVC   YVDSUPRC,SUPER     SUPER CODE (TBSERV COMPLETION STATS)  03390000
                                                                        03400000
         ICM   R3,15,MSGA         MESSAGE TO RETURN?                    03410000
         BZ    EXIT               RESPONSE READY IF NOT                 03420000
                                                                        03430000
         $XPBUFR ISRT,            ADD MESSAGE TO BUFFER                +03440000
               DATA=(R3),                                              +03450000
               DATALEN=*MSGLN,                                         +03460000
               MF=(E,MFE_LIST)                                          03470000
                                                                        03480000
         BNZ   ERR_ITXP           XPBUFR SERVICE ERROR                  03490000
         B     EXIT               RETURN NORMAL                         03500000
                                                                        03510000
         DROP  R4                 YVDBRESP                              03520000
                                                                        03530000
         EJECT                                                          03540000
***************************************************************         03550000
*                                                                       03560000
*   Return to caller                                                    03570000
*                                                                       03580000
***************************************************************         03590000
                                                                        03600000
EXIT     DS    0H                                                       03610000
         ICM   R3,15,BUFL         ROW BUFFER ACQUIRED?                  03620000
         BZ    EXITRET            SKIP IF NOT                           03630000
                                                                        03640000
         $RETSTOR *BUFA           RELEASE PREVIOUSLY ACQUIRED STORAGE   03650000
                                                                        03660000
EXITRET  DS    0H                                                       03670000
         #EXIT ,                  RETURN                                03680000
                                                                        03690000
         EJECT                                                          03700000
***************************************************************         03710000
*                                                                       03720000
*   Local read only storage                                             03730000
*                                                                       03740000
***************************************************************         03750000
                                                                        03760000
MSGTBSRV DC    C'TABLE SERVICES REQUEST FAILED'                         03770000
                                                                        03780000
         LTORG ,                                                        03790000
                                                                        03800000
         PRINT NOGEN                                                    03810000
         ICVT  ,                                                        03820000
         ITASK ,                                                        03830000
         IPCB  ,                                                        03840000
         IUSER ,                                                        03850000
         END   ,                                                        03860000

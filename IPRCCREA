IPRCCREA TITLE '- PROCESS CREATE/INITIALIZATION'                        00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE: IPRCCREA - Process Create/Initialization                     00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine will create a process control block (PCB)             00080000
*    workunit.  The workunit will be properly initialized               00090000
*    and added to the ITASK/IPCB workunit queues.  The                  00100000
*    process workunit will then be added to the ITASK                   00110000
*    dispatch queue and marked ready for initial dispatch.              00120000
*                                                                       00130000
*                                                                       00140000
* ON ENTRY:                                                             00150000
*                                                                       00160000
*    R1 contains the address of the parameter list mapped by            00170000
*    the PROCPL dsect generated by $PROC DSECT=YES.                     00180000
*                                                                       00190000
* ON EXIT:                                                              00200000
*                                                                       00210000
*    R15 contains one of the following return codes:                    00220000
*                                                                       00230000
*        RC00 - Normal completion                                       00240000
*               R1 contains the address of the PCB                      00250000
*                                                                       00260000
*        RC12 - Service error                                           00270000
*               RSN04 - WORKUNIT LOCATOR FAILURE                        00280000
*                                                                       00290000
*        RC16 - Internal error                                          00300000
*               RSN04 - Storage error                                   00310000
*                                                                       00320000
*        RC20 - Request error                                           00330000
*               RSN04 - Process name required                           00340000
*                                                                       00350000
* MODE:                                                                 00360000
*                                                                       00370000
*    TASK                                                               00380000
*    APF/NON-APF                                                        00390000
*    SUP/PROB                                                           00400000
*    AMODE 31, RMODE ANY                                                00410000
*                                                                       00420000
**<DOC-OFF>*****************************************************        00430000
                                                                        00440000
         EJECT ,                                                        00450000
****************************************************************        00460000
*                                                                       00470000
* MAINTENANCE:                                                          00480000
*                                                                       00490000
*   04/21/93 Ron Colmone                                                00500000
*            Initial Version                                            00510000
*                                                                       00520000
*   01/03/95 Ron Colmone          Par# 159456                           00530000
*            Added support for task manager server                      00540000
*                                                                       00550000
*   09/12/95 Ron Colmone          Par# 159456                           00560000
*            Control limit of dispatch priority from 0-255.             00570000
*                                                                       00580000
****************************************************************        00590000
                                                                        00600000
         EJECT                                                          00610000
         IPCB  ,                                                        00620000
                                                                        00630000
         EJECT                                                          00640000
         $PROC  DSECT=YES         PROCESS MGR PLIST                     00650000
                                                                        00660000
         EJECT                                                          00670000
         $TASK  DSECT=YES         TASK    MGR PLIST                     00680000
                                                                        00690000
         EJECT                                                          00700000
         $WULOC DSECT=YES         WORKUNIT LOCATOR PLIST                00710000
                                                                        00720000
         EJECT ,                                                        00730000
         @CB   WORKUNIT=YES       STANDARD CB HEADER                    00740000
                                                                        00750000
         EJECT ,                                                        00760000
         @EPB  TYPE=DSECT         EVENT PROCESS BLOCK                   00770000
                                                                        00780000
         EJECT                                                          00790000
         $QLOCK ,                 LOCK QUEUE ENTRY                      00800000
                                                                        00810000
         EJECT ,                                                        00820000
         EQUS  ,                  GENERAL EQUATES                       00830000
*                                                                       00840000
         ABCODES ,                $ABEND CODES                          00850000
*                                                                       00860000
         EVCODES ,                EVENT COMPLETION CODES                00870000
                                                                        00880000
#STGBLK  EQU   10*1024            PCB STORAGE SIZE                      00890000
                                                                        00900000
         EJECT ,                                                        00910000
         #WORK LENGTH=512         READ/WRITE WORKAREA                   00920000
FLAGS    DS    X                  FLAGS                                 00930000
$LOCKED  EQU   X'80'              LOCK ACQUIRED                         00940000
OPTS     DS    X                  PATMATCH OPTIONS (SEE DRAW.H)         00950000
                                                                        00960000
         IWUENTUD DSECT=NO        WORKUNIT LOCATOR USERDATA             00970000
                                                                        00980000
$WUL_MFL $WULOC MF=(L,*)          WORKUNIT LOCATOR PLIST                00990000
$TSK_MFL $TASK  MF=(L,*)          TASK MANAGER PLIST                    01000000
         #ENDWORK                 END OF WORKAREA                       01010000
                                                                        01020000
         EJECT ,                                                        01030000
IPRCCREA #ENTER BASE=R12,         ENTRY LINKAGE                        +01040000
               PREG=R8,                                                +01050000
               WAPASS=YES                                               01060000
                                                                        01070000
         USING PROCPL,R8          ESTABLISH ADDRESSABILITY              01080000
         USING ITASK,R10          ESTABLISH ADDRESSABILITY              01090000
                                                                        01100000
         L     R7,TSKPCBC         ADDR OF REQUESTING PROCESS            01110000
P        USING IPCB,R7            OWNING PCB                            01120000
                                                                        01130000
*---------------------------------------------------------------        01140000
*                                                                       01150000
* PROCESS CREATE/INITIALIZATION                                         01160000
*                                                                       01170000
*---------------------------------------------------------------        01180000
CREA_PCB DS    0H                                                       01190000
         $GETSTOR PCBLENG,OWNER=ITASK,COND=YES ALLOC PCB                01200000
         BNZ   ERR_STG            STORAGE ALLOCATION FAILURE            01210000
         LR    R6,R1              ADDR OF PCB                           01220000
         USING IPCB,R6            ADDRESSABILITY                        01230000
                                                                        01240000
         MVC   PCBID,=CL8'IPCB'   PCB IDENTIFIER                        01250000
         MVC   PCBLEN,=A(PCBLENG) LENGTH  OF PCB CB                     01260000
         LA    R0,PCBWRKA         ADDRESS OF PCB WORKAREA               01270000
         ST    R0,PCB@WRKA        INITIALIZE WORKAREA PTR               01280000
                                                                        01290000
         L     R1,PPLNAME         PROCESS NAME ADDRESS                  01300000
         MVC   PCBNAME,0(R1)      COPY PROCESS NAME                     01310000
         MVC   PCBTEPB,PPLTEPB    TERMINATION EPB ADDRESS               01320000
                                                                        01330000
         MVI   PCBFLGS,PCB$INIT   INDICATE INITIAL DISPATCH             01340000
         ST    R10,PCBTASK        ASSOCIATED ITASK ADDRESS              01350000
                                                                        01360000
         LTR   R7,R7              PARENT PCB AVAILABLE?                 01370000
         BZ    CRE_ROOT           NO, ROOT LEVEL PCB                    01380000
         ST    R7,PCBMPCB         PARENT PCB ADDRESS                    01390000
         MVC   PCBUSER,P.PCBUSER  PROPAGATE IUSER ADDRESS               01400000
                                                                        01410000
CRE_ROOT DS    0H                                                       01420000
         LA    R0,PCBPCBQ-(PCBSIBL-IPCB)                                01430000
         ST    R0,PCBPCBQ+4       PROCESS SIBLING QUEUE HEADER          01440000
                                                                        01450000
         LA    R0,PCB$STOR        $ISTOR ACTIVE EXTENT LIST             01460000
         ST    R0,PCBSTORQ        COMMON LOCATOR FOR ALL WORKUNITS      01470000
                                                                        01480000
         LA    R0,PCBMSGQ         ADDR OF MESSAGE QUEUE (MSGQ)          01490000
         ST    R0,PCB@MSGQ        COMMON LOCATOR FOR ALL WORKUNITS      01500000
         LA    R0,PCBMSGL         ADDR OF MESSAGE LIST (MSGL)           01510000
         ST    R0,PCB@MSGL        COMMON LOCATOR FOR ALL WORKUNITS      01520000
                                                                        01530000
         LA    R0,PCBMEPB         ADDR OF MESSAGE EPB                   01540000
         ST    R0,PCB@MEPB        COMMON LOCATOR FOR ALL WORKUNITS      01550000
                                                                        01560000
         LA    R0,PCBFRCA         ADDR OF FRAME CONTROL AREA            01570000
         ST    R0,PCB@FRCA        COMMON LOCATOR FOR ALL WORKUNITS      01580000
                                                                        01590000
         EJECT ,                                                        01600000
*---------------------------------------------------------------        01610000
*  IF SAS/C DEBUGGING IS ENABLED,  DETERMINE IF THE TASK/PROCESS        01620000
*  IS ELIGIBLE FOR DEBUGGING.                                           01630000
*---------------------------------------------------------------        01640000
         TM    ICTSTAT2,ICT2$CDB  SAS/C DEBUGGING ENABLED               01650000
         BZ    NO_DEBUG           NO, SKIP SAS/C DEBUGGING FOR WU       01660000
         LA    R4,L'TSKNAME       LENGTH OF TASK NAME                   01670000
         MVI   OPTS,X'42'         SCAN_PATTERN | SCAN_IGNORECASE        01680000
*                                 (SEE DRAW.H FOR DEFINITIONS)          01690000
                                                                        01700000
         $CLINK FUNC=*#PATMTCH,   VERIFY MATCHING PAT FOR TASK NAME    +01710000
               (CHAR*,ICTCDTSK),                                       +01720000
               (CHAR*,TSKNAME),                                        +01730000
               (REGISTER_INT,(R4)),                                    +01740000
               (CHAR,OPTS),                                            +01750000
               (INT,ICTZERO),                                          +01760000
               (INT,ICTZERO)                                            01770000
                                                                        01780000
         LTR   R15,R15            TASK NAME MATCH PATTERN?              01790000
         BZ    NO_DEBUG           NO, SKIP C-DEBUGGING FOR WU           01800000
                                                                        01810000
         $CLINK FUNC=*#PATMTCH,   VERIFY MATCHING PAT FOR PROC NAME    +01820000
               (CHAR*,ICTCDPRC),                                       +01830000
               (CHAR*,PCBNAME),                                        +01840000
               (REGISTER_INT,(R4)),                                    +01850000
               (CHAR,OPTS),                                            +01860000
               (INT,ICTZERO),                                          +01870000
               (INT,ICTZERO)                                            01880000
                                                                        01890000
         LTR   R15,R15            PATTERN MATCH FOR BLANK PROCESS       01900000
         BZ    NO_DEBUG           NO, SKIP C-DEBUGGING FOR WU           01910000
                                                                        01920000
         OI    PCBFLGS2,PCB$CDBG  SAS/C DEBUGGING ENABLE FOR WU         01930000
NO_DEBUG DS    0H                                                       01940000
                                                                        01950000
*---------------------------------------------------------------        01960000
*  CREATE STATIC QLOCK ENTRY USED FOR PROCESS LEVEL LOCK REQS           01970000
*---------------------------------------------------------------        01980000
         $GETSTOR QLOCKLN,OWNER=IPCB                                    01990000
                                                                        02000000
         $QLOCK INIT,ENTRY=(R1),ASSOC=IPCB                              02010000
                                                                        02020000
*---------------------------------------------------------------        02030000
* INITIALIZE PCB STORAGE POOL                                           02040000
*---------------------------------------------------------------        02050000
         ICM   R2,15,PPLSTGSZ     PCB STORAGE BLKSIZE                   02060000
         BZ    CREA_DPY           SET DISPATCH PRIORITY                 02070000
                                                                        02080000
         L     R1,PPLEP           ENTRY ADDRESS                         02090000
         LA    R1,0(,R1)          CLEAR HOB                             02100000
         SRL   R1,24              REMOVE LOW ORDER 24 BITS              02110000
         LTR   R1,R1              TEST FOR RMODE=24                     02120000
         BZ    ALOC_24            ALLOC PCB POOL IN LOC=24 (RES)        02130000
                                                                        02140000
ALOC_31  DS    0H                                                       02150000
         STGINIT (R2),QH=PCBSTG   INITIAL PCB STORAGE QUEUE             02160000
         BNZ   ERR_STG            ERROR INITIALIZING STORAGE            02170000
         B     CREA_DPY           SET DISPATCHING PRIO                  02180000
                                                                        02190000
ALOC_24  DS    0H                                                       02200000
         STGINIT (R2),QH=PCBSTG,  INITIAL PCB STORAGE QUEUE            +02210000
               LOC=BELOW          RMODE=24 STORAGE                      02220000
         BNZ   ERR_STG            ERROR INITIALIZING STORAGE            02230000
                                                                        02240000
*---------------------------------------------------------------        02250000
* SET PCB DISPATCH PRIORITY                                             02260000
*---------------------------------------------------------------        02270000
CREA_DPY DS    0H                                                       02280000
         SR    R1,R1              PREPARE FOR INSERT             214761 02290000
         IC    R1,TSKPRTY         RETRIEVE TASK DISP PRIORITY    159456 02300000
         LTR   R7,R7              TASK MANAGER CREATE            159456 02310000
         BZ    *+8                YES,  CONTINUE                 159456 02320000
         IC    R1,P.PCBPRTY       GET PARENT PCB DISP PRIORITY   159456 02330000
         A     R1,PPLDPMOD        ADD DISPRIORITY MODIFIER       159456 02340000
         BM    CREA_DP0           NEGATIVE, RESET PRIO TO ZERO   214761 02350000
         C     R1,=A(255)         EXCEEDED LIMIT                 214761 02360000
         BNH   CREA_DP            NO, CONTINUE WITH DP SET       214761 02370000
         LA    R1,255             RESET PRIORITY TO LIMIT        214761 02380000
         B     CREA_DP            CONTINUE WITH DP SET           214761 02390000
                                                                        02400000
CREA_DP0 DS    0H                                                214761 02410000
         SR    R1,R1              RESET PRIORITY TO ZERO         214761 02420000
                                                                        02430000
CREA_DP  DS    0H                                                214761 02440000
         STC   R1,PCBPRTY         SAVE PCB DISPATCH PRIO         159456 02450000
                                                                        02460000
*---------------------------------------------------------------        02470000
* SET RESUME REGISTERS                                                  02480000
*---------------------------------------------------------------        02490000
         LR    R2,R13             SAVE CURRENT SAVE AREA ADDRESS        02500000
         LA    R13,PCBFSA         ADDR OF PROCESS FIRST SAVE AREA       02510000
         L     R14,#PRCEPLG       RETURN ADDR - PROCESS EPILOG   159456 02520000
         L     R15,PPLEP          ADDR OF PROCESS EP                    02530000
         L     R1,PPLPARM         ADDR OF PROCESS PARM                  02540000
         SR    R0,R0              CLEAR WORKAREA ADDRESS                02550000
         STM   R0,R15,PCBREGS     SAVE PROCESS INITIAL DISP REGS        02560000
         STM   R14,R12,PCBFSA+12  INITIALIZE FIRST SAVE AREA            02570000
         ST    R15,PCBEPA         SAVE ENTRY ADDRESS                    02580000
                                                                        02590000
         LR    R13,R2             RESTORE SAVE AREA ADDRESS             02600000
                                                                        02610000
         EJECT ,                                                        02620000
*---------------------------------------------------------------        02630000
* ADD PCB TO SIBLING CHAIN                                              02640000
*---------------------------------------------------------------        02650000
         $SER  OBTAIN,DISP        OBTAIN LOCK                           02660000
         B     *+4(R15)           BRANCH ON LOCK RETURN CODE            02670000
         B     LOCK_OBT           LOCK OBTAINED                         02680000
         B     LOCK_HAV           ALREADY OWN LOCK                      02690000
         B     ABN_LOCK           LOCK OBTAIN FAILED                    02700000
                                                                        02710000
LOCK_OBT DS    0H                                                       02720000
         OI    FLAGS,$LOCKED      INDICATE LOCKED OBTAINED              02730000
                                                                        02740000
LOCK_HAV DS    0H                                                       02750000
         LTR   R7,R7              IS THERE A PARENT PCB?                02760000
         BZ    CREA_LST           NO, ADD TO PCB LIST                   02770000
                                                                        02780000
         L     R1,P.PCBPCBQ+4     ADDR OF LAST PCB                      02790000
Q        USING IPCB,R1            TEMP ADDRESSABILITY                   02800000
         ST    R6,Q.PCBSIBL       ADDR NEW PCB TO SIBL CHAIN            02810000
         ST    R6,P.PCBPCBQ+4     ADDR OF NEW LAST PCB                  02820000
         DROP  Q                  PCB                                   02830000
                                                                        02840000
*---------------------------------------------------------------        02850000
* ADD PCB TO TASK PCB LIST                                              02860000
*---------------------------------------------------------------        02870000
CREA_LST DS    0H                                                       02880000
         LA    R3,TSKPCB          ADDR OF PCB HEADER                    02890000
         SH    R3,=AL2(PCBNEXT-IPCB)   BACKUP OFFSET OF PCBNEXT         02900000
L        USING IPCB,R3            ADDR OF PREV PCB                      02910000
                                                                        02920000
         ICM   R0,15,TSKPCBL      ADDRESS OF LAST PCB            159456 02930000
         BZ    CREA_ADD           ADD PCB TO TASK PCB LIST       159456 02940000
         LR    R3,R0              ADDRESS OF LAST PCB IN LIST    159456 02950000
         ST    R3,PCBPREV         SET PREVIOUS PCB ADDRESS       159456 02960000
                                                                        02970000
CREA_ADD DS    0H                                                159456 02980000
         ST    R6,L.PCBNEXT       ADDRESS NEW PCB TO PCB LIST    159456 02990000
         ST    R6,TSKPCBL         UPDATE LAST PCB ADDRESS        159456 03000000
                                                                        03010000
         DROP  L                  IPCB (LAST)                    159456 03020000
                                                                        03030000
*---------------------------------------------------------------        03040000
* INCREMENT PCB COUNT                                                   03050000
*---------------------------------------------------------------        03060000
         L     R1,TSKPCB#         COUNT OF PCBS ON TASK                 03070000
         LA    R1,1(,R1)          INCREMENT PCB COUNT                   03080000
         ST    R1,TSKPCB#         SAVE UPDATED COUNT                    03090000
                                                                        03100000
         L     R1,ICT#PROC        COUNT OF TOTAL PCBS                   03110000
         LA    R1,1(,R1)          INCREMENT TOTAL PCB COUNT             03120000
         ST    R1,ICT#PROC        SAVE UPDATED COUNT                    03130000
                                                                        03140000
*---------------------------------------------------------------        03150000
* ADD WORKUNIT LOCATOR ENTITY ENTRY FOR NEW PROCESS                     03160000
*---------------------------------------------------------------        03170000
         $WULOC POST,             ADD WORKUNIT LOCATOR FOR PROCESS     +03180000
               TSKNAME=TSKNAME,   TASK NAME                            +03190000
               PCBNAME=PCBNAME,   PROCESS NAME                         +03200000
               TOKEN=PCBENTKN,    RETURN LOCATOR TOKEN                 +03210000
               USERDATA=IWUENTUD, WORKAREA FOR USERDATA                +03220000
               TASK=ITASK,        ADDRESS OF ITASK                     +03230000
               PCB=IPCB,          ADDRESS OF IPCB                      +03240000
               DUP=ADD,           ADD ENTRY FOR DUPLICATE NAME         +03250000
               MF=(E,$WUL_MFL)                                          03260000
         BNZ   ERR_ENTY           ENTITY POST FAILURE                   03270000
                                                                        03280000
*---------------------------------------------------------------        03290000
* Release Dispatcher lock                                               03300000
*---------------------------------------------------------------        03310000
         TM    FLAGS,$LOCKED      LOCK PREVIOUSLY ACQUIRED              03320000
         BZ    CREA_ENV           INITIALIZE SAS/C ENV FOR PCB          03330000
         $SER  RELEASE,DISP       RELEASE LOCK                          03340000
                                                                        03350000
         EJECT ,                                                        03360000
*---------------------------------------------------------------        03370000
* Call dummy C function to build SAS/C environment for PCB              03380000
*---------------------------------------------------------------        03390000
CREA_ENV DS    0H                                                       03400000
         LR    R1,R6              WORKUNIT ADDRESS                      03410000
         @CALL ISASINIT,CTYPE=CVT INITIALIZE SAS-C FRAMEWORK            03420000
                                                                        03430000
         EJECT ,                                                        03440000
*---------------------------------------------------------------        03450000
* Initialize the Workunit Dispatch EPB                                  03460000
*---------------------------------------------------------------        03470000
         $TASK SETEPB,            INITIALIZE PCB DISPATCH EPB    159456+03480000
               EPB=PCBDEPB,                                      159456+03490000
               ECODE=EC$EVNT,                                    159456+03500000
               PCB=(R6),                                         159456+03510000
               RTN=*#PRCCDSP,                                    159456+03520000
               PARM=IPCB,                                        159456+03530000
               SCOPE=LOCAL,                                      159456+03540000
               WORKA=0,                                          159456+03550000
               MF=(E,$TSK_MFL)                                   159456 03560000
                                                                        03570000
         EJECT ,                                                        03580000
*---------------------------------------------------------------        03590000
* Add PCB to dispatch queue                                             03600000
*---------------------------------------------------------------        03610000
         @CALL ITSKDPNQ,(TSKDISPQ,IPCB),CTYPE=CVT,                     +03620000
               MF=(E,MFE_LIST)                                          03630000
                                                                        03640000
         LR    R1,R6              RETURN ADDR OF NEW PCB                03650000
         LA    R15,RC00           NORMAL COMPLETION                     03660000
         B     RETURN             RETURN                                03670000
                                                                        03680000
         EJECT ,                                                        03690000
****************************************************************        03700000
*                                                                       03710000
*   CATASTROPHIC ERRORS                                                 03720000
*                                                                       03730000
****************************************************************        03740000
                                                                        03750000
ABN_LOCK DS    0H                                                       03760000
         $ABEND ABE_DISPLOCK,                                          +03770000
               SCOPE=ITASK,                                            +03780000
               TITLE='UNABLE TO ACQUIRE DISPATCHER LOCK'                03790000
                                                                        03800000
         EJECT ,                                                        03810000
****************************************************************        03820000
*                                                                       03830000
*   ERROR EXIT                                                          03840000
*                                                                       03850000
****************************************************************        03860000
                                                                        03870000
ERR_ENTY DS    0H                                                       03880000
         LA    R0,RSN04           WORKUNIT LOCATOR FAILURE              03890000
         B     RET_RC12           SERVICE ERROR                         03900000
                                                                        03910000
ERR_STG  DS    0H                                                       03920000
         LA    R0,RSN04           STORAGE ALLOCATION ERROR              03930000
         B     RET_RC16           INTERNAL ERROR                        03940000
                                                                        03950000
ERR_NAME DS    0H                                                       03960000
         LA    R0,RSN04           PROCESS NAME REQUIRED                 03970000
         B     RET_RC20           REQUEST ERROR                         03980000
                                                                        03990000
         EJECT ,                                                        04000000
****************************************************************        04010000
*                                                                       04020000
*   RETURN                                                              04030000
*                                                                       04040000
****************************************************************        04050000
                                                                        04060000
RET_RC12 DS    0H                                                       04070000
         LA    R15,RC12           SERVICE ERROR                         04080000
         B     RETURN                                                   04090000
                                                                        04100000
RET_RC16 DS    0H                                                       04110000
         LA    R15,RC16           ABNORMAL RETURN (INTERNAL ERR)        04120000
         B     RETURN                                                   04130000
                                                                        04140000
RET_RC20 DS    0H                                                       04150000
         LA    R15,RC20           REQUEST ERROR                         04160000
         B     RETURN                                                   04170000
                                                                        04180000
RETURN   DS    0H                                                       04190000
         #EXIT ,                  RETURN                                04200000
                                                                        04210000
         EJECT ,                                                        04220000
****************************************************************        04230000
*                                                                       04240000
*  CONSTANTS AND LITERALS                                               04250000
*                                                                       04260000
****************************************************************        04270000
                                                                        04280000
         LTORG ,                                                        04290000
                                                                        04300000
         PRINT NOGEN                                                    04310000
         ICVT  ,                                                        04320000
         ITASK ,                                                        04330000
                                                                        04340000
         IHAPSA ,                                                       04350000
         CVT   DSECT=YES,LIST=NO                                        04360000
         IKJTCB ,                                                       04370000
         PRINT GEN                                                      04380000
                                                                        04390000
         END   ,                                                        04400000

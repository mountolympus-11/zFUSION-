ISRVDISP TITLE '- Task Manager Server Dispatcher'                       00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE: ISRVDISP - Task Manager Server Dispatcher                    00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine is entered from the task server SUSPEND and           00080000
*    CALLDSP functions.  The task manager dispatcher enters the         00090000
*    server dispatcher to allow the server to dispatch other            00100000
*    ITASKs running in the server.  When a task is about to             00110000
*    wait for event completion, the server dispatcher is called         00120000
*    to determine if any other ITASKs are ready to be                   00130000
*    dispatched.  If so,  the task is made current and the              00140000
*    appropriate task restart routine is called with the task           00150000
*    to be dispatched made current and reanchored in the                00160000
*    TCBFSA.                                                            00170000
*                                                                       00180000
*    If the server dispatch queue is empty, the start pending           00190000
*    queue is checked to see if any new tasks are awaiting              00200000
*    initial start.  If so, the first task is swapped off the           00210000
*    pending queue and branch entered for initial dispatch.             00220000
*                                                                       00230000
*    When there is no work to dispatch,  the task manager               00240000
*    dispatcher is reentered with the server ITASK as current.          00250000
*    The server will then enter an EVENTS wait until an event           00260000
*    occurs for any ITASK within the SERVER task.  This routine         00270000
*    will then be reentered to dispatch the ready task or start         00280000
*    pending task.                                                      00290000
*                                                                       00300000
* ON ENTRY:                                                             00310000
*                                                                       00320000
*    R1 Contains the address of the parameter list mapped by            00330000
*    the SRVPL dsect generated by $SERVER DSECT=YES.                    00340000
*                                                                       00350000
* ON EXIT:                                                              00360000
*                                                                       00370000
*    Control is passed onto the Task Manager Dispatcher via             00380000
*    the appropriate task restart routine address specified             00390000
*    the ITASK of the task to be  restarted.                            00400000
*                                                                       00410000
*    For tasks pending start, control is passed to the task's           00420000
*    entry address via branch entry.                                    00430000
*                                                                       00440000
* MODE:                                                                 00450000
*                                                                       00460000
*    TASK                                                               00470000
*    APF/NON-APF                                                        00480000
*    SUP/PROB                                                           00490000
*    AMODE 31, RMODE ANY                                                00500000
*                                                                       00510000
**<DOC-OFF>*****************************************************        00520000
                                                                        00530000
         EJECT ,                                                        00540000
****************************************************************        00550000
*                                                                       00560000
* MAINTENANCE:                                                          00570000
*                                                                       00580000
*   01/12/95 Ron Colmone          Par# 159456                           00590000
*            Initial Version                                            00600000
*                                                                       00610000
*   09/12/95 Ron Colmone          Par# 214761                           00620000
*            Added support for dispatch queue management                00630000
*            segmented by dispatching priority.                         00640000
*                                                                       00650000
****************************************************************        00660000
                                                                        00670000
         EJECT ,                                                        00680000
         $TASK   DSECT=YES        TASKMGR PLIST                         00690000
                                                                        00700000
         EJECT ,                                                        00710000
         EQUS  ,                  GENERAL EQUATES                       00720000
*                                                                       00730000
         TRACODES ,               TRACE CODES                           00740000
*                                                                       00750000
         ABCODES ,                ABEND CODES                           00760000
                                                                        00770000
         EJECT ,                                                        00780000
         #WORK LENGTH=512                                               00790000
WRKPASS  DS    0D                 WORKAREA TO PASS                      00800000
         #ENDWORK                                                       00810000
                                                                        00820000
         EJECT ,                                                        00830000
ISRVDISP #ENTER BASE=(R12),       ENTRY LINKAGE                        +00840000
               WAPASS=YES                                               00850000
                                                                        00860000
         USING ITASK,R10          ESTABLISH ADDRESSABILITY              00870000
                                                                        00880000
*---------------------------------------------------------------        00890000
*  Reset server task as current ITASK                                   00900000
*---------------------------------------------------------------        00910000
         ICM   R9,15,TSKSVTSK     ADDRESS OF SERVER ITASK               00920000
         BNZ   *+6                CONTINUE                              00930000
         LR    R9,R10             SERVER TASK IS ACTIVE                 00940000
S        USING ITASK,R9           ADDRESSABILITY (SERVER)               00950000
                                                                        00960000
         L     R6,S.TSKSRV        ADDRESS OF SERVER EXTENSION           00970000
         USING SERVERX,R6         ADDRESSABILITY                        00980000
                                                                        00990000
         XC    SRVTASKC,SRVTASKC  NO CURRENT TASK DISPATCHED            01000000
         LR    R10,R9             ADDRESS OF SERVER TASK                01010000
         @PRESENV ,               RESET SERVER AS CURRENT TASK          01020000
                                                                        01030000
         EJECT ,                                                        01040000
*---------------------------------------------------------------        01050000
*  Request the next ITASK ready to be dispatched from the               01060000
*  server dispatch queue.  If there are no tasks waiting to be          01070000
*  dispatched, then continue by checking the pending start queue.       01080000
*---------------------------------------------------------------        01090000
         @CALL ITSKDPDQ,(SRVDISPQ,0), SEL NEXT TASK TO BE DISP   214761+01100000
               MF=(E,MFE_LIST),CTYPE=CVT                         214761 01110000
         LTR   R5,R1              ADDR OF NEXT TASK TO DISPATCH  214761 01120000
         BZ    PEND_STR           NO TASK AVAIL, CHECK START PND 214761 01130000
                                                                        01140000
         ST    R5,SRVTASKC        ADDRESS OF CURRENT TASK               01150000
         B     DISPATCH           DISPATCH CURRENT TASK                 01160000
                                                                        01170000
         EJECT ,                                                        01180000
*---------------------------------------------------------------        01190000
*  Determine if any new tasks are pending start.  If so,                01200000
*  remove pending start task using compare-and-swap to                  01210000
*  maintain serialization on pending queue.  Initialize                 01220000
*  starting task register conventions and branch to task                01230000
*  entry address.                                                       01240000
*---------------------------------------------------------------        01250000
PEND_STR DS    0H                                                       01260000
         ICM   R2,15,SRVPEND      ANY TASKS PENDING START?              01270000
         BZ    DISPATCH           NO,  CALL TASKMGR DISPATCHER          01280000
         USING SRVATASK,R2        ADDRESSABILITY                        01290000
         L     R3,SATTASK         ADDRESS OF ATTACHED TASK              01300000
A        USING ITASK,R3           ADDRESSABILITY                        01310000
                                                                        01320000
         L     R1,SATPEND         ADDRESS OF NEXT PENDING TASK          01330000
         CS    R2,R1,SRVPEND      REMOVE PENDING TASK FROM QUEUE        01340000
         BNE   *-8                RETRY                                 01350000
         XC    SATPEND,SATPEND    CLEAR NEXT PENDING ADDRESS            01360000
                                                                        01370000
         $TRACE TRC_DISPSVSTRT,24 ALLOCATE TRACE ENTRY FOR TASKSTRT     01380000
         BNZ   PEND_NTR           TRACE NOT ACTIVE                      01390000
         MVC   0(4,R1),SATEP@     ENTRY ADDRESS                         01400000
         MVC   4(4,R1),SATPARM    TASK  ADDRESS                         01410000
         MVC   8(4,R1),SATTASK    ITASK ADDRESS                         01420000
         MVC   12(4,R1),SATTEPB   TERM EPB ADDRESS                      01430000
         MVC   16(8,R1),A.TSKNAME ITASK NAME                            01440000
PEND_NTR DS    0H                                                       01450000
                                                                        01460000
         MVC   SRVTASKC,SATTASK   ADDRESS OF CURRENT TASK               01470000
         L     R1,SATPARM         TASK PARM ADDRESS                     01480000
         LA    R13,SATFSA         SAVE AREA ADDRESS                     01490000
         L     R14,#SRVEPLG       SERVER TASK EPILOG (RETURN ADDR)      01500000
         L     R15,SATEP@         TASK ENTRY ADDRESS                    01510000
         BR    R15                START NEW ITASK                       01520000
                                                                        01530000
         DROP  R2,A               SRVATASK, ITASK (ATTACHED)            01540000
                                                                        01550000
         EJECT ,                                                        01560000
****************************************************************        01570000
*                                                                       01580000
*  Dispatch: Make task current and call task restart routine            01590000
*                                                                       01600000
****************************************************************        01610000
DISPATCH DS    0H                                                       01620000
         ICM   R5,15,SRVTASKC     TASK AVAILABLE TO DISPATCH            01630000
         BZ    DISPTASK           NO, DISPATCH SERVER TASK              01640000
                                                                        01650000
*---------------------------------------------------------------        01660000
*  Trace Server dispatcher                                              01670000
*---------------------------------------------------------------        01680000
         $TRACE TRC_DISPSVSWAP,16 ALLOCATE TRACE ENTRY FOR DISP         01690000
         BNZ   DISP_NTR           TRACE NOT ACTIVE                      01700000
         ST    R5,0(,R1)          ITASK ADDRESS                         01710000
         MVC   4(L'TSKNAME,R1),TSKNAME-ITASK(R5)                        01720000
DISP_NTR DS    0H                                                       01730000
                                                                        01740000
*---------------------------------------------------------------        01750000
*  Make task current                                                    01760000
*---------------------------------------------------------------        01770000
         LR    R10,R5             ADDRESS OF TASK TO DISPATCH           01780000
         @PRESENV ,               RESET SERVER AS CURRENT TASK          01790000
                                                                        01800000
*---------------------------------------------------------------        01810000
*  Call Task restart routine (No Return)                                01820000
*---------------------------------------------------------------        01830000
DISPTASK DS    0H                                                       01840000
         LA    R0,WRKPASS         WORKAREA TO PASS                      01850000
         ICM   R15,15,TSKRSRTN    ADDRESS OF RESTART RTN                01860000
         BZ    ABN_RSTR           FAILURE IF NOT SPECIFIED              01870000
         BASR  R14,R15            CALL RESTART ROUTINE                  01880000
                                                                        01890000
         EJECT ,                                                        01900000
****************************************************************        01910000
*                                                                       01920000
*  CATASTROPHIC FAILURES                                                01930000
*                                                                       01940000
****************************************************************        01950000
ABN_RSTR DS    0H                                                       01960000
         $ABEND ABE_DISPRTN,                                           +01970000
               TITLE='TASK RESTART ROUTINE NOT AVAILABLE'               01980000
                                                                        01990000
         EJECT ,                                                        02000000
****************************************************************        02010000
*                                                                       02020000
*  CONSTANTS AND LITERALS                                               02030000
*                                                                       02040000
****************************************************************        02050000
                                                                        02060000
         LTORG ,                                                        02070000
                                                                        02080000
         PRINT NOGEN                                                    02090000
         ICVT  ,                                                        02100000
         ITASK ,                                                        02110000
         SERVERX ,                                                      02120000
         SRVATASK ,                                                     02130000
                                                                        02140000
         IHAPSA ,                                                       02150000
         CVT   DSECT=YES,LIST=NO                                        02160000
         IKJTCB ,                                                       02170000
         PRINT GEN                                                      02180000
                                                                        02190000
         END   ,                                                        02200000

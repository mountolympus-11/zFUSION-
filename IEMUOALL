IEMUOALL TITLE '- EMULATOR OUTBOUND IMAGE/STATU NOTIFICATION'           00010000
***************************************************************         00020000
*                                                                       00030000
* ROUTINE:  IEMUOALL - EMULATOR OUTBOUND IMAGE/STATUS NOTIFICATION      00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THIS ROUTINE IS GIVEN CONTROL BY ISLUIMGO WHEN A NEW               00080000
*    IMAGE OR STATE CHANGE IS RECEIVED FROM THE HOST APPLICATION.       00090000
*    IF NO ERRORS WERE ENCOUNTERED, A STATECHG (XIMGSCHG) OR            00100000
*    STD IMAGE (XIMGSTD) RESPONSE IS COMPOSED AND SENT.                 00110000
*    OTHERWISE, THE VDEVICE IS INFORMED VIA RETCODE AND RSNCODE         00120000
*    IF AN IMPENDING SESSION TERMINATION.                               00130000
*                                                                       00140000
* ON ENTRY:                                                             00150000
*                                                                       00160000
*    R1  CONTAINS THE ADDRESS OF A PARAMETER LIST CONSTRUCTED           00170000
*        AS FOLLOWS                                                     00180000
*                                                                       00190000
*           +00 - ADDR OF SLUHANDL                                      00200000
*           +04 - ISLUIMGO RETURN CODE                                  00210000
*           +08 - ISLUIMGO REASON CODE                                  00220000
*                                                                       00230000
* ON EXIT:                                                              00240000
*                                                                       00250000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES                     00260000
*                                                                       00270000
*        RCNN - THE ISLUIMGO RETURN CODE PROVIDED AS INPUT              00280000
*                                                                       00290000
*        RC24 - THIS ROUTINE COULD NOT ACCESS THE VIRTUAL               00300000
*               DEVICE ($XPBUFR XMIT FAILURE).  THE LOGICAL             00310000
*               SESSION IS PRESUMED TO HAVE TERMINATED.                 00320000
*                                                                       00330000
***************************************************************         00340000
                                                                        00350000
         EJECT                                                          00360000
         #WORK ,                                                        00370000
                                                                        00380000
RETRSN   DS    0F                 ISLUIMGI RETURN AND REASON CODES      00390000
RETC     DS    F                     RETCODE                            00400000
RSNC     DS    F                     RSNCODE                            00410000
                                                                        00420000
LCLRETC  DS    F                  OUR RETURN CODE                       00430000
                                                                        00440000
STATREGS DS    3F                 R15-R1 STATUS AREA                    00450000
REGSAVE  DS    16F                LOCAL SAVEAREA                        00460000
                                                                        00470000
         @XH   TYPE=BLOCK         STANDARD RU (MODEL) HEADER            00480000
                                                                        00490000
         XIMAGE DSECT=NO          XIMAGE REQUEST/RESPONSE BLOCK         00500000
                                                                        00510000
         #ENDWORK ,                                                     00520000
                                                                        00530000
         EJECT                                                          00540000
         SLUHANDL ,               SLU SESSION HANDLE                    00550000
                                                                        00560000
         EJECT                                                          00570000
         SESSIMAG ,               SESSION IMAGING/RECORDING COMM AREA   00580000
                                                                        00590000
         EJECT                                                          00600000
         $TSEND DSECT=YES         CROSS WU MESSAGING PLIST              00610000
                                                                        00620000
         EJECT                                                          00630000
         REQHDR ,                 COMMUNICATION PROTOCOLS, CODES, ETC.  00640000
                                                                        00650000
         EJECT                                                          00660000
         ABCODES PRINT=NOGEN                                            00670000
                                                                        00680000
         MSGCODES ,                                                     00690000
                                                                        00700000
         EQUS ,                                                         00710000
                                                                        00720000
         EJECT                                                          00730000
IEMUOALL #ENTER PREG=R8                                                 00740000
                                                                        00750000
         USING ITASK,R10          TASK MODE OR BETTER                   00760000
                                                                        00770000
         EJECT                                                          00780000
***************************************************************         00790000
*                                                                       00800000
*   FETCH PASSED PARAMETERS, PREPARE FOR EMULATOR NOTIFICATION          00810000
*                                                                       00820000
***************************************************************         00830000
         LM    R2,R4,0(R8)        FETCH SLUHANDL, RETC, RSNC            00840000
         LR    R8,R2              ACCEPT SLUHANDL                       00850000
         USING SLUHANDL,R8        LIFE OF FUNCTION                      00860000
         STM   R3,R4,RETRSN       RETAIN RETC AND RSNC                  00870000
                                                                        00880000
         L     R9,SLHSIMAG        LOCATE SESSIMAG                       00890000
         USING SESSIMAG,R9                                              00900000
                                                                        00910000
*--------------------------------------------------------------         00920000
*   ANALYZE COMPLETION STATUS, TERMINATION NOTIFICATION ON ERROR        00930000
*--------------------------------------------------------------         00940000
         ICM   R15,15,RETC        SUCCESSFUL COMPLETION?                00950000
         ST    R15,LCLRETC        PREPARE FOR REFLECT BACK              00960000
         BNZ   EREQUEST                                                 00970000
                                                                        00980000
*--------------------------------------------------------------         00990000
*   STATE CHANGE WITHOUT IMAGE                                          01000000
*--------------------------------------------------------------         01010000
         TM    SEIONCE,SEIO_INP   IMAGE RECEIVED?                       01020000
         BO    SENDIMAG                                                 01030000
                                                                        01040000
         LA    R0,STATECHG        REFLECT STATE CHANGE TO OFFENDER      01050000
         LA    R1,256             EXTENSION SIZE                        01060000
         BAS   R14,RESPINIT       ALLOCATE RESPONSE BLOCK               01070000
         LR    R5,R1              ADDRESSABLE RESPONSE                  01080000
         USING XIMGDATA,R5                                              01090000
                                                                        01100000
         OC    XIMGSTA,SEIFSNA                                          01110000
         OC    XIMGSTA,SEIONCE                                          01120000
                                                                        01130000
         B     RESPOND                                                  01140000
         DROP  R5                                                       01150000
                                                                        01160000
*--------------------------------------------------------------         01170000
*   STATE CHANGES AND IMAGE                                             01180000
*--------------------------------------------------------------         01190000
SENDIMAG DS    0H                                                       01200000
         L     R1,SEIS1SIZ        EXTENSION SIZE IS IMAGE SIZE          01210000
         LA    R0,STD             IMAGE OUT                             01220000
         BAS   R14,RESPINIT       ALLOCATE RESPONSE BLOCK               01230000
         LR    R5,R1              ADDRESSABLE RESPONSE                  01240000
         USING XIMGDATA,R5                                              01250000
                                                                        01260000
         MVC   XIMGSEQ,SEISEQ#                                          01270000
         MVC   XIMGCROW,SEIS1ROW                                        01280000
         MVC   XIMGCCOL,SEIS1COL                                        01290000
         MVC   XIMGPROW,SEIPROWS                                        01300000
         MVC   XIMGPCOL,SEIPCOLS                                        01310000
         MVC   XIMGAROW,SEIAROWS                                        01320000
         MVC   XIMGACOL,SEIACOLS                                        01330000
         MVC   XIMGCSRP,SEISCSR+2                                       01340000
                                                                        01350000
         OC    XIMGSTA,SEIFSNA                                          01360000
         OC    XIMGSTA,SEIONCE                                          01370000
                                                                        01380000
         MVC   XIMGLENG,SEIS1SIZ  IMAGE LENGTH                          01390000
                                                                        01400000
         $XPBUFR ISRT,DATALEN=*SEIS1SIZ,DATA=*SEIS1IMG                  01410000
         BNZ   ABE_TXP                                                  01420000
                                                                        01430000
         B     RESPOND                                                  01440000
         DROP  R5                                                       01450000
                                                                        01460000
*--------------------------------------------------------------         01470000
*   SESSION FAILURE, NOTIFY VDEVICE OF TERMINATION                      01480000
*--------------------------------------------------------------         01490000
EREQUEST DS    0H                                                       01500000
         LA    R0,STATECHG        REFLECT STATE CHANGE TO OFFENDER      01510000
         LA    R1,256             EXTENSION SIZE                        01520000
         BAS   R14,RESPINIT       ALLOCATE RESPONSE BLOCK               01530000
         LR    R5,R1              ADDRESSABLE RESPONSE                  01540000
         USING XIMGDATA,R5                                              01550000
                                                                        01560000
         MVC   XIMGRETC,RETC      FAILING RETCODE                       01570000
         MVC   XIMGRSNC,RSNC      FAILING RSNCODE                       01580000
         MVI   XIMGSTA,SEIF_GNE   SESSION TERMINATING                   01590000
                                                                        01600000
         LA    R1,XIMAGE          RESPONSE BLOCK                        01610000
         B     RESPOND            FORMAT RESPONSE                       01620000
         DROP  R5                 XIMAGE                                01630000
                                                                        01640000
         EJECT                                                          01650000
***************************************************************         01660000
*                                                                       01670000
*   SEND RESPONSE TO REQUESTOR                                          01680000
*                                                                       01690000
***************************************************************         01700000
RESPOND  DS    0H                                                       01710000
         TM    SEISTATE,SEIS_DEV  COMMUNICATION W/ VDEVICE FAILED PREV? 01720000
         BO    COMMFAIL           BYPASS NOTIFICATION IF SO             01730000
                                                                        01740000
         $XPBUFR XMIT             TRANSMIT AND FREE                     01750000
         BZ    RETURN             NORMAL COMPLETION                     01760000
                                                                        01770000
         C     R15,=A(RC16)       LIKELY SESSION DISAPPEARANCE?         01780000
         BNE   ABE_TXP            SOME OTHER FAILURE OTHERWISE          01790000
         OI    SEISTATE,SEIS_DEV  COMMUNICATION WITH VDEVICE LOST       01800000
                                                                        01810000
COMMFAIL DS    0H                                                       01820000
         LA    R15,RC24           COMMUNICATION FAILURE                 01830000
         ST    R15,LCLRETC        RETAIN COMPLETION STATUS              01840000
                                                                        01850000
*--------------------------------------------------------------         01860000
*   RETURN COMPLETION STATUS TO REQUESTOR                               01870000
*--------------------------------------------------------------         01880000
RETURN   DS    0H                                                       01890000
         L     R15,LCLRETC        CONVEY CONTINUATION OPTION            01900000
         SR    R0,R0              REASON CODES NOT DEFINED              01910000
                                                                        01920000
         #EXIT ,                                                        01930000
                                                                        01940000
         EJECT                                                          01950000
***************************************************************         01960000
*                                                                       01970000
* ROUTINE: RESPINIT - INITIALIZE RESPONSE BUFFER                        01980000
*                                                                       01990000
* ON ENTRY:                                                             02000000
*                                                                       02010000
*    R0 - XIMG RESPONSE SUBFUNCTION                                     02020000
*    R1 - SIZE OF EXTENSION REQUIRED                                    02030000
*                                                                       02040000
* ON EXIT:                                                              02050000
*                                                                       02060000
*    R1 - XIMGDATA RESPONSE BLOCK ORIGIN (TXP BUFFER RESIDENT)          02070000
*                                                                       02080000
***************************************************************         02090000
RESPINIT DS    0H                                                       02100000
         STM   R0,R15,REGSAVE     SAVE MAINLINE REGS                    02110000
         LR    R2,R1              EXTENSION SIZE                        02120000
         LA    R2,7(,R2)          ROUND TO DWORD                        02130000
         SRL   R2,3                                                     02140000
         SLL   R2,3                                                     02150000
                                                                        02160000
         LA    R6,@XH             MODEL RU HEADER                       02170000
         USING @XH,R6                                                   02180000
         LA    R1,XIMG            FUNCTION CODE                         02190000
         ST    R1,@XHFUNC                                               02200000
         ST    R0,@XHSFNC         SUBFUNCTION CODE PROVIDED BY CALLER   02210000
         MVC   @XHSESH,SLHXPH     SESSION HANDLE                        02220000
                                                                        02230000
         $XPBUFR INIT,SIZE=XIMGLN(R2),XH=@XH                            02240000
         BNZ   ABE_TXP                                                  02250000
         DROP  R6                 MODEL TRANSACTION HDR                 02260000
                                                                        02270000
*--------------------------------------------------------------         02280000
*   CONSTRUCT RESPONSE BLOCK AND PREPARE FOR RETURN                     02290000
*--------------------------------------------------------------         02300000
         $XPBUFR ISRT,DATALEN=XIMGLN                                    02310000
         BNZ   ABE_TXP                                                  02320000
                                                                        02330000
         USING XIMGDATA,R1        LIFE OF FUNCTION ADDRESSABILITY       02340000
         XC    XIMGDATA(XIMGLN),XIMGDATA  REDUNDANT                     02350000
                                                                        02360000
*--------------------------------------------------------------         02370000
*   RETURN TO CALLER                                                    02380000
*--------------------------------------------------------------         02390000
         LM    R2,R14,REGSAVE+8   RESTORE MAINLINE REGS                 02400000
         SR    R15,R15            RETURN CODES NOT DEFINED              02410000
         BR    R14                EXIT                                  02420000
         DROP  R1                 XIMG                                  02430000
                                                                        02440000
         EJECT                                                          02450000
***************************************************************         02460000
*                                                                       02470000
* CATASTROPIC ERRORS                                                    02480000
*                                                                       02490000
***************************************************************         02500000
ABE_TXP  DS    0H                                                       02510000
         $ABEND ABE_TXPSERV,DUMP=YES,                                  X02520000
               TITLE='TXP BUFFER SERVICE FAILURE'                       02530000
                                                                        02540000
         EJECT                                                          02550000
***************************************************************         02560000
*                                                                       02570000
*   LOCAL READ-ONLY DATA AREAS                                          02580000
*                                                                       02590000
***************************************************************         02600000
         LTORG ,                                                        02610000
                                                                        02620000
         PRINT NOGEN                                                    02630000
         ICVT  ,                                                        02640000
         ITASK ,                                                        02650000
         END   ,                                                        02660000

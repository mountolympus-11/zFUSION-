ITSKRECV TITLE 'ITSKRECV - $TRECV ITASK MESSAGE RECEIVE SERVICE'        00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE:  ITSKRECV - $TRECV ITASK message recieve service             00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine implements the $TRECV service, the principle          00080000
*    mechanism used in STDENV to acquire messages from other            00090000
*    workunits.  Messages are 'stacked' in the MSGQ of the              00100000
*    target workunit (ITASK or IPCB) but messages are always            00110000
*    delivered to the $TRECV issuer in FIFO order, requiring a          00120000
*    scan of the MSGQ to locate the last entry.  If the                 00130000
*    workunit implements a message list (MSGL) as well,                 00140000
*    messages are staged from MSGQ into MSGL in FIFO order,             00150000
*    reducing the cost of retrieval of a large message list.            00160000
*                                                                       00170000
*                                                                       00180000
* ON ENTRY:                                                             00190000
*                                                                       00200000
*    R1  Contains the address of a parameter list constructed           00210000
*        as follows:                                                    00220000
*                                                                       00230000
*        +00 - message return area length                               00240000
*        +04 - message return area origin                               00250000
*        +08 - address of associated workunit                           00260000
*                                                                       00270000
* ON EXIT:                                                              00280000
*                                                                       00290000
*    R15 Contains one of the following return codes                     00300000
*                                                                       00310000
*        RC00 - message recieved                                        00320000
*        RC04 - no messages available                                   00330000
*        RC08 - message return area too small, min length in R1         00340000
*                                                                       00350000
**<DOC-OFF>****************************************************         00360000
                                                                        00370000
***************************************************************         00380000
*                                                                       00390000
* MAINTENANCE:                                                          00400000
*                                                                       00410000
*    04/15/93 R. TURGEON                                                00420000
*             INITIAL VERSION                                           00430000
*                                                                       00440000
***************************************************************         00450000
                                                                        00460000
         EJECT                                                          00470000
         @CB   WORKUNIT=YES       STANDARD CONTROL BLOCK HEADER         00480000
                                                                        00490000
         EJECT                                                          00500000
         TMSG  HDR=YES            INTER/INTRA ITASK MESSAGE FORMAT      00510000
                                                                        00520000
         EJECT                                                          00530000
         EQUS  ,                                                        00540000
                                                                        00550000
         EJECT                                                          00560000
ITSKRECV #ENTER PREG=R8,SAVE=NO                                         00570000
                                                                        00580000
         USING ITASK,R10          STDENV                                00590000
                                                                        00600000
         EJECT                                                          00610000
***************************************************************         00620000
*                                                                       00630000
*   Attempt to dequeue a message from the message list (MSGL)           00640000
*   If implemented by the workunit and currently populated.             00650000
*                                                                       00660000
***************************************************************         00670000
                                                                        00680000
         LM    R4,R6,0(R8)        FETCH RETURN AREA LENGTH, ADDR        00690000
         USING @CB,R6             STANDARD CB FORMAT                    00700000
                                                                        00710000
*--------------------------------------------------------------         00720000
*   Return message staged in MSGL                                       00730000
*--------------------------------------------------------------         00740000
                                                                        00750000
MSGL     DS    0H                                                       00760000
         ICM   R9,15,@CB@MSGL     MESSAGE LIST IMPLEMENTED BY WU?       00770000
         BZ    MSTACK             STANDARD FORM IF NOT                  00780000
         ICM   R8,15,0(R9)        MESSAGES PENDING RETURN?              00790000
         BZ    MSGQMSGL           NOTHING PENDING ON MSGL               00800000
                                                                        00810000
         USING TMSG,R8            TMSG FORMAT                           00820000
         LA    R1,TMSGSLN         LENGTH OF STANDARD MSG                00830000
         A     R1,TMSGINFL        PLUS LENGTH OF TEXT BLOCK             00840000
         CR    R1,R4              CALLERS RETURN AREA LARGE ENOUGH?     00850000
         BH    ERR_SIZE           ERROR OTHERWISE                       00860000
                                                                        00870000
         LA    R0,TMSGSTD         MESSAGE ORIGIN                        00880000
         LR    R14,R5             RETURN AREA ORIGIN                    00890000
         LR    R15,R1             PORTION OF RETURN AREA NEEDED         00900000
         MVCL  R14,R0             COPY MSG TO RETURN AREA               00910000
         MVC   0(4,R9),TMSGNEXT   DECHAIN DELIVERED MESSAGE             00920000
                                                                        00930000
         $RETSTOR (R8),OWNER=@CB  FREE DELIVERED MSGL ENTRY             00940000
                                                                        00950000
         L     R0,4(,R9)          FETCH MSGL COUNT                      00960000
         BCTR  R0,0               UPDATE                                00970000
         ST    R0,4(,R9)          AND SAVE                              00980000
         B     NORMRET                                                  00990000
                                                                        01000000
*--------------------------------------------------------------         01010000
*   Transfer MSGQ to MSGL converting LIFO stack to FIFO list            01020000
*--------------------------------------------------------------         01030000
                                                                        01040000
MSGQMSGL DS    0H                 DETACH VOLITILE MESSAGE STACK         01050000
         SR    R0,R0                                                    01060000
         SR    R1,R1                                                    01070000
         L     R2,@CB@MSGQ        MSGQ IS DEFINED FOR ALL WORKUNITS     01080000
         LM    R14,R15,0(R2)                                            01090000
         CDS   R14,R0,0(R2)                                             01100000
         BNE   *-4                                                      01110000
                                                                        01120000
         LTR   R14,R14            MESSAGES DEQUEUED FROM STACK?         01130000
         BZ    WRN_NMSG           NO MESSAGES PENDING                   01140000
                                                                        01150000
         ST    R15,4(,R9)         NUMBER OF SWAPPED MESSAGES            01160000
X        USING TMSG,R14           CHANGE PERSPECTIVE                    01170000
         SR    R0,R0              GROUND, AT FIRST                      01180000
                                                                        01190000
LF_TO_FF DS    0H                 STACK OF STACK YIELDS FIFO LIST       01200000
         ST    R14,0(,R9)         CURRENT MESSAGE IS FIRST MSG          01210000
         L     R1,X.TMSGNEXT      ACQUIRE PTR TO NEXT STACKED MSG       01220000
         ST    R0,X.TMSGNEXT      SET FORWARD LINK TO OLDER MSG         01230000
         LR    R0,R14             CURRENT MSG IS NOW THE OLDEST MSG     01240000
         LTR   R14,R1             STACKED MSGS REMAIN?                  01250000
         BNZ   LF_TO_FF           CONTINUE IF SO                        01260000
         B     MSGL               RETRY MSGL                            01270000
         DROP  X                  TMSG                                  01280000
                                                                        01290000
         EJECT                                                          01300000
***************************************************************         01310000
*                                                                       01320000
*   Messages must be dequeued from the shared (volitile) MSGQ           01330000
*                                                                       01340000
***************************************************************         01350000
                                                                        01360000
MSTACK   DS    0H                                                       01370000
         L     R9,@CB@MSGQ        ADDRESS OF MESSAGE WORK FOR WU        01380000
                                                                        01390000
         SR    R7,R7              TMSG PRIOR NODE PTR                   01400000
         ICM   R8,15,0(R9)        ANY MESSAGES QUEUED?                  01410000
         BZ    WRN_NMSG           WARN IF NOT                           01420000
                                                                        01430000
         USING TMSG,R8            TMSG FORMAT                           01440000
LNK      USING TMSG,R7            LINKING TMSG                          01450000
                                                                        01460000
LASTMSG  DS    0H                 LOCATE LAST MSG ON QUEUE              01470000
         ICM   R0,15,TMSGNEXT     ADDITIONAL MSGS?                      01480000
         BZ    SELECT             NO, USE LAST MSG                      01490000
         LR    R7,R8              ESTABLISH PRIOR NODE PTR              01500000
         LR    R8,R0              ADVANCE TO NEXT TMSG                  01510000
         B     LASTMSG            TRY AGAIN                             01520000
                                                                        01530000
*--------------------------------------------------------------         01540000
*   Move msg to callers return area                                     01550000
*--------------------------------------------------------------         01560000
                                                                        01570000
SELECT   DS    0H                 MESSAGE FOUND                         01580000
         LA    R1,TMSGSLN         LENGTH OF STANDARD MSG                01590000
         A     R1,TMSGINFL        PLUS LENGTH OF TEXT BLOCK             01600000
         CR    R1,R4              CALLERS RETURN AREA LARGE ENOUGH?     01610000
         BH    ERR_SIZE           ERROR OTHERWISE                       01620000
                                                                        01630000
         LA    R0,TMSGSTD         MESSAGE ORIGIN                        01640000
         LR    R14,R5             RETURN AREA ORIGIN                    01650000
         LR    R15,R1             PORTION OF RETURN AREA NEEDED         01660000
         MVCL  R14,R0             COPY MSG TO RETURN AREA               01670000
                                                                        01680000
*--------------------------------------------------------------         01690000
*   Dequeue the msg node - allow for recent additions to Q              01700000
*--------------------------------------------------------------         01710000
                                                                        01720000
         LTR   R7,R7              TMSG ANCHORED FROM ANOTHER TMSG?      01730000
         BNZ   DETACH             THIS PORTION OF Q IS STABLE IF SO     01740000
         SR    R0,R0              GROUND OUT THE LIST                   01750000
         LR    R7,R8              ASSUME DELIVERED TMSG IS ONLY TMSG    01760000
         CS    R7,R0,0(R9)        MAY STILL BE AT THE TOP               01770000
         BZ    USECOUNT           ADJUST THE MSGQ USE COUNT             01780000
                                                                        01790000
RESCAN   DS    0H                 MULTIPLE TMSG NODES ARE NOW PRESENT   01800000
         C     R8,LNK.TMSGNEXT    OUR TMSG NOW ANCHORED OFF THIS ONE?   01810000
         BE    DETACH             DETACH IT IF SO                       01820000
         L     R7,LNK.TMSGNEXT    ADVANCE TO NEXT ENTRY                 01830000
         B     RESCAN             CONTINUE, MATCH IS INEVITABLE         01840000
                                                                        01850000
DETACH   DS    0H                 DETACH MSG FROM PRIOR TMSG            01860000
         SR    R0,R0              GROUND VALUE                          01870000
         ST    R0,LNK.TMSGNEXT    END OF CHAIN IS STABLE                01880000
                                                                        01890000
USECOUNT DS    0H                                                       01900000
         L     R2,4(,R9)          FETCH MESSAGE ENTRY COUNT             01910000
                                                                        01920000
USECS    DS    0H                                                       01930000
         LR    R3,R2              USE COUNT                             01940000
         BCTR  R3,0               ACCOUNT FOR DELETION                  01950000
         CS    R2,R3,4(R9)        UPDATE ACCORDINGLY                    01960000
         BNZ   USECS              RETRY                                 01970000
         DROP  LNK                LINKING TMSG                          01980000
                                                                        01990000
*--------------------------------------------------------------         02000000
*   Release message node to its owners storage pool                     02010000
*--------------------------------------------------------------         02020000
                                                                        02030000
         $RETSTOR (R8),OWNER=@CB                                        02040000
                                                                        02050000
         DROP  R8                 TMSG                                  02060000
                                                                        02070000
         EJECT                                                          02080000
***************************************************************         02090000
*                                                                       02100000
*   Return completion status to caller                                  02110000
*                                                                       02120000
***************************************************************         02130000
                                                                        02140000
NORMRET  DS    0H                 MESSAGE DELIVERED                     02150000
         LA    R15,RC00                                                 02160000
         B     EXIT                                                     02170000
                                                                        02180000
WRN_NMSG DS    0H                 NO MESSAGES AVAILABLE                 02190000
         LA    R15,RC04                                                 02200000
         B     EXIT                                                     02210000
                                                                        02220000
ERR_SIZE DS    0H                 MESSAGE PROVIDED IS NOT VALID         02230000
         LA    R15,RC08           SIZE REQUIRED RETURNED IN R1          02240000
         B     EXIT                                                     02250000
                                                                        02260000
EXIT     DS    0H                                                       02270000
         #EXIT ,                                                        02280000
                                                                        02290000
         EJECT                                                          02300000
***************************************************************         02310000
*                                                                       02320000
*   LOCAL READ-ONLY DATA AREAS                                          02330000
*                                                                       02340000
***************************************************************         02350000
                                                                        02360000
         LTORG ,                                                        02370000
                                                                        02380000
         PRINT NOGEN                                                    02390000
         ICVT ,                                                         02400000
         ITASK ,                                                        02410000
         END                                                            02420000

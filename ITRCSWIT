ITRCSWIT TITLE '- SWITCH CURRENT TRACE TABLE'                           00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: ITRCSWIT - SWITCH CURRENT TRACE TABLE                        00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THE TRACE TABLE SWITCH ROUTINE ALLOWS REQUESTORS TO MOVE           00080000
*    FROM TABLE TO TABLE, USUALLY WITH THE INTENT OF PRESERVING         00090000
*    THE CONTENTS OF THE 'CURRENT' TABLE, OR RETURNING TO THE           00100000
*    'MAIN' TABLE AFTER THE 'CURRENT' TABLE HAS BEEN INSPECTED          00110000
*    OR CAPTURED.                                                       00120000
*                                                                       00130000
*    PUSH AND POP OPERATIONS ARE DEFINED. AN ATTEMPT TO PUSH            00140000
*    FROM THE LAST TABLE IS IGNORED.  SIMILARLY, POPS ARE               00150000
*    HONORED ONLY ON BEHALF OF THE ITASK/IPCB THAT PERFORMED            00160000
*    THE PUSH.  IN ADDITION, THE SWITCH-TO REQUEST SPECIFIES            00170000
*    THAT RECORDING IS TO BEGIN ON THE DESIGNATED TRACE TABLE,          00180000
*    AS IDENTIFIED BY TABLE NUMBER.                                     00190000
*                                                                       00200000
*    EXPLICIT PASSING OF THE ITASK AND IPCB ADDRESSES IS                00210000
*    INTENDED TO ALLOW TABLE PUSH AND POP ON BEHALF OF ANOTHER          00220000
*    WORK UNIT, AS CAN OCCUR IN WORKUNIT CREATE AND DESTROY             00230000
*    FUNCTIONS.                                                         00240000
*                                                                       00250000
*                                                                       00260000
* ON ENTRY:                                                             00270000
*                                                                       00280000
*    R1 - CONTAINS A PTR TO A PARAMETER LIST DESCRIBED BY THE           00290000
*         SWPLIST MAPPING                                               00300000
*                                                                       00310000
*                                                                       00320000
* ON EXIT:                                                              00330000
*                                                                       00340000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES                     00350000
*                                                                       00360000
*        RC00 - SWITCH COMPLETE                                         00370000
*                                                                       00380000
*        RC04 - REQUEST IGNORED                                         00390000
*                                                                       00400000
**<DOC-OFF>****************************************************         00410000
                                                                        00420000
         EJECT                                                          00430000
***************************************************************         00440000
*                                                                       00450000
* MAINTENANCE:                                                          00460000
*                                                                       00470000
*    12/12/94 R. Turgeon                                                00480000
*             Added FORCE=YES to all ABEND class $TRACE requests        00490000
*             ensuring that these diagnostic entries are always         00500000
*             generated.                                                00510000
*                                                                       00520000
***************************************************************         00530000
                                                                        00540000
         EJECT                                                          00550000
         #WORK ,                                                        00560000
         #ENDWORK ,                                                     00570000
                                                                        00580000
         EJECT                                                          00590000
         TRTABLE ,                TRACE TABLE MAPPINGS                  00600000
                                                                        00610000
         EJECT                                                          00620000
         TRACODES ,               TRACE TABLE ENTRY CODES               00630000
                                                                        00640000
         EJECT                                                          00650000
         EQUS  ,                                                        00660000
                                                                        00670000
         EJECT                                                          00680000
***************************************************************         00690000
*                                                                       00700000
* MAPPING: SWPLIST - ENTRANCE LIST                                      00710000
*                                                                       00720000
***************************************************************         00730000
SWPLIST  DSECT                                                          00740000
SWPFUNC  DS    F                  TRACE TABLE TRANSITION CODE           00750000
*                                    < 0 : POP TO PRIOR TABLE           00760000
*                                    = 0 : SWITCH-TO DESIGNATED TABLE   00770000
*                                    > 0 : PUSH TO NEXT TABLE           00780000
*                                                                       00790000
SWPTBLID DS    F                  SWITCH-TO TABLE IDENTIFIER (0-N)      00800000
SWPITSK  DS    A                  ITASK ASSOCIATED WITH REQUEST         00810000
SWPIPCB  DS    A                  IPCB  ASSOCIATED WITH REQUEST         00820000
SWPLISTL EQU   *-SWPLIST                                                00830000
                                                                        00840000
         EJECT                                                          00850000
ITRCSWIT #ENTER PREG=R9                                                 00860000
                                                                        00870000
         USING ICVT,R11           STANDARD ENVIRONMENT                  00880000
         USING ITASK,R10                                                00890000
                                                                        00900000
         EJECT                                                          00910000
*--------------------------------------------------------------         00920000
*   DETERMINE REQUEST TYPE, PROCESS PUSH AND POP                        00930000
*--------------------------------------------------------------         00940000
         USING SWPLIST,R9         ENTRANCE LIST                         00950000
         USING TRTHDR,R8          MAP TABLE HDR                         00960000
         USING TRTBDEF,R7         CONVENTION IN LOGIC TO FOLLOW         00970000
                                                                        00980000
         ICM   R8,15,ICTRTPTR     TRACE TABLE HDR                       00990000
         BZ    IGNORE             NEVER ALLOCATED                       01000000
                                                                        01010000
RETRY    DS    0H                                                       01020000
         L     R4,TRTHCP          CURRENT ENTRY VECTOR PTR              01030000
         L     R5,TRTHCN          CURRENT TABLE NUMBER (0-N)            01040000
         LR    R2,R4              PRESERVE CURRENT VALUE FOR CDS        01050000
         LR    R3,R5              DITTO                                 01060000
         ICM   R0,15,SWPFUNC      DETERMINE REQUEST TYPE                01070000
         BZ    EXPLICIT           EXPLICIT TABLE DESIGNATOR             01080000
         BM    POP                ACTIVATE PRIOR TABLE                  01090000
                                                                        01100000
PUSH     DS    0H                 ACTIVATE NEXT TABLE                   01110000
         LA    R5,1(,R5)          TABLE NUMBER                          01120000
         C     R5,TRTHNTAB        VALID OPERATION?                      01130000
         BNL   IGNORE             REJECT IF NOT                         01140000
         LA    R4,4(,R4)          ESTABLISH NEW CURRENT                 01150000
         B     SWITCH             COMMON LOGIC                          01160000
                                                                        01170000
POP      DS    0H                 ACTIVATE PRIOR TABLE                  01180000
         L     R7,0(,R4)          INSPECT CURRENT TABLE                 01190000
         CLC   TRTBTSKS,SWPITSK   CURRENT TASK PERFORMED PUSH?          01200000
         BNE   IGNORE             IGNORE IF NOT                         01210000
         CLC   TRTBPCBS,SWPIPCB   CURRENT PROCESS PERFORMED PUSH?       01220000
         BNE   IGNORE             IGNORE IF NOT                         01230000
         SH    R5,=H'1'           NEW TABLE NUMBER                      01240000
         BM    IGNORE             IGNORE IF AT TOP OF STACK             01250000
         SH    R4,=H'4'           VECTOR ENTRY PTR                      01260000
         B     SWITCH             COMMON LOGIC                          01270000
                                                                        01280000
*--------------------------------------------------------------         01290000
*   EXPLICIT TABLE DESIGNATED  (FUTURE API)                             01300000
*--------------------------------------------------------------         01310000
EXPLICIT DS    0H                                                       01320000
         ICM   R5,15,SWPTBLID     VALID DESIGNATION?                    01330000
         BM    IGNORE             REJECT OTHERWISE                      01340000
         C     R5,TRTHNTAB        WITHIN RANGE?                         01350000
         BNL   IGNORE             SKIP IF NOT                           01360000
         SLL   R5,2               VECTOR INDEX                          01370000
         LA    R4,TRTHVECT(R5)    ENTRY VECTOR PTR                      01380000
                                                                        01390000
*--------------------------------------------------------------         01400000
*   CUT A TRACE RECORD INDICATING DESIRE TO SWITCH                      01410000
*--------------------------------------------------------------         01420000
SWITCH   DS    0H                                                       01430000
         $TRACE *=A(TRC_SWITCHOUT),16, SWITCH-OUT (ATTEMPT) RECORD     X01440000
               FORCE=YES                                                01450000
                                                                        01460000
         BNZ   FAIL1              SOMETHING REALLY WRONG!               01470000
         MVI   0(R1),X'55'        SWITCH EYECATCHER                     01480000
         MVC   1(15,R1),0(R1)     PROPOGATE                             01490000
FAIL1    DS    0H                                                       01500000
                                                                        01510000
*--------------------------------------------------------------         01520000
*   COMPLETE THE SWITCH - IF PUSH, ESTABLISH TABLE OWNER                01530000
*--------------------------------------------------------------         01540000
         CDS   R2,R4,TRTHCURR     SWITCH TO NEW TABLE                   01550000
         BNE   RETRY              TRY AGAIN                             01560000
                                                                        01570000
         L     R7,0(,R4)          LOCATE TRACEDEF                       01580000
         XC    TRTBTSKS,TRTBTSKS  CLEAR OLD OWNERSHIP INFO              01590000
         XC    TRTBPCBS,TRTBPCBS                                        01600000
                                                                        01610000
         ICM   R0,15,SWPFUNC      PUSH FUNCTION?                        01620000
         BNP   OWNERSET           DONE IF NOT                           01630000
         MVC   TRTBTSKS,SWPITSK   IDENTIFY PUSHING TASK AND PCB         01640000
         MVC   TRTBPCBS,SWPIPCB                                         01650000
                                                                        01660000
OWNERSET DS    0H                                                       01670000
                                                                        01680000
*--------------------------------------------------------------         01690000
*   CUT A TRACE RECORD INDICATING RESUMPTION OF CURRENT TABLE           01700000
*--------------------------------------------------------------         01710000
         $TRACE *=A(TRC_SWITCHIN),16,  SWITCH RECORD                   X01720000
               FORCE=YES                                                01730000
                                                                        01740000
         BNZ   FAIL2              SOMETHING REALLY WRONG!               01750000
         MVI   0(R1),X'AA'        SWITCH EYECATCHER                     01760000
         MVC   1(15,R1),0(R1)     PROPOGATE                             01770000
FAIL2    DS    0H                                                       01780000
                                                                        01790000
*--------------------------------------------------------------         01800000
*   RETURN COMPLETION STATUS TO CALLER                                  01810000
*--------------------------------------------------------------         01820000
NORMRET  DS    0H                 REQUEST COMPLETE                      01830000
         LA    R15,RC00                                                 01840000
         B     RETURN                                                   01850000
                                                                        01860000
IGNORE   DS    0H                                                       01870000
         LA    R15,RC04           REQUEST REJECTED                      01880000
                                                                        01890000
RETURN   DS    0H                                                       01900000
         #EXIT ,                  RETURN                                01910000
                                                                        01920000
         EJECT ,                                                        01930000
***************************************************************         01940000
*                                                                       01950000
*   LOCAL READ ONLY WORKING STORAGE                                     01960000
*                                                                       01970000
***************************************************************         01980000
         LTORG ,                                                        01990000
                                                                        02000000
         PRINT NOGEN                                                    02010000
         ICVT  ,                                                        02020000
         ITASK ,                                                        02030000
         END   ,                                                        02040000

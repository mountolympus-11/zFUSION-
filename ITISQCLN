ITISQCLN TITLE '- SQL STMT PARSE / SEMANTIC SUMMARY CLEANUP'            00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE: ITISQCLN - SQL stmt parse / semantic summary cleanup         00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine is used to cleanup the workareas acquired             00080000
*    by the SQL statement parser (PPL#C*) and the semantic              00090000
*    analysis routines (ISQPARSE, et al) upon normal or                 00100000
*    abnormal termination of a SQL request.                             00110000
*                                                                       00120000
*                                                                       00130000
* ON ENTRY:                                                             00140000
*                                                                       00150000
*    R1  points to a parameter list described by the SQLCLNP            00160000
*        plist expanded below                                           00170000
*                                                                       00180000
*                                                                       00190000
* ON EXIT:                                                              00200000
*                                                                       00210000
*    R15 contains zero                                                  00220000
*                                                                       00230000
**<DOC-OFF>****************************************************         00240000
                                                                        00250000
         EJECT  ,                                                       00260000
         #WORK ,                                                        00270000
         #ENDWORK ,          END OF WORKAREA                            00280000
                                                                        00290000
         EJECT                                                          00300000
         SQLSEMAL ,          SEMANTIC ANALYSIS DATA FORMATS             00310000
                                                                        00320000
         EJECT                                                          00330000
         PPLRESP ,           PTI SQL PARSE RESPONSE BLOCK               00340000
                                                                        00350000
         EJECT                                                          00360000
         EQUS  ,                                                        00370000
                                                                        00380000
         EJECT                                                          00390000
***************************************************************         00400000
*                                                                       00410000
* MAPPING: SQLCLNP - SQL cleanup request parameter list                 00420000
*                                                                       00430000
***************************************************************         00440000
                                                                        00450000
SQLCLNP  DSECT ,                  PARAMETER LIST FORMAT                 00460000
SQLCSEMP DS    A                  ADDR OF SEMANTIC SUMMARY (SQLSEMAL)   00470000
SQLCPANC DS    A                  ADDR OF PPLRESP ANCHOR WORD           00480000
SQLCLNPL EQU   *-SQLCLNP          LENGTH OF PLIST                       00490000
                                                                        00500000
         EJECT                                                          00510000
ITISQCLN #ENTER PREG=R8                                                 00520000
                                                                        00530000
         USING ITASK,R10                                                00540000
                                                                        00550000
***************************************************************         00560000
*                                                                       00570000
*   Term the semantic summary and associated area storage pool          00580000
*                                                                       00590000
***************************************************************         00600000
                                                                        00610000
         USING SQLCLNP,R8         PLIST, LIFE OF FUNCTION               00620000
                                                                        00630000
         ICM   R7,15,SQLCSEMP     SEMANTIC SUMMARY CONSTRUCTED?         00640000
         BZ    SMRYFREE           DONE HERE IF NOT                      00650000
         USING SQSEMAL,R7         SEMANTIC SUMMARY DESCRIPTOR           00660000
         L     R2,SQSPOOL@        STGMGR QUEUE HEADER (QH) LOCATION     00670000
         MVC   DWORD,0(R2)        ENSURE NOT ATTACHED TO TERMING STG    00680000
         XC    0(8,R2),0(R2)      REFLECT TRANFER OF OWNERSHIP          00690000
                                                                        00700000
         STGTERM QH=DWORD                                               00710000
                                                                        00720000
SMRYFREE DS    0H                                                       00730000
                                                                        00740000
***************************************************************         00750000
*                                                                       00760000
*   Free the storage areas created by the SQL statement parse           00770000
*   including the #CTREE and #CLEX nodes, as well as the                00780000
*   PPL#C* workarea itself.                                             00790000
*                                                                       00800000
***************************************************************         00810000
                                                                        00820000
PARSFREE DS    0H                                                       00830000
         L     R6,SQLCPANC        PPL#C* WORKAREA PTR                   00840000
         ICM   R4,15,0(R6)        WORKAREA ALLOCATED?                   00850000
         BZ    FPARSER            PPA WORKAREA NOT ACQUIRED             00860000
         USING PPLRESP,R4         ADDRESSABILITY                        00870000
                                                                        00880000
*--------------------------------------------------------------         00890000
*   Free the #CTREE                                                     00900000
*--------------------------------------------------------------         00910000
                                                                        00920000
         ICM   R1,15,PPLRCTRE     R1 <== #CTREE ROOT NODE               00930000
         BZ    STGCTREE           SKIP IF N/A                           00940000
                                                                        00950000
         @CALL ISQFCTRE           RELEASE ALL ACQUIRED STORAGE          00960000
                                                                        00970000
STGCTREE DS    0H                                                       00980000
                                                                        00990000
*--------------------------------------------------------------         01000000
*   Free #CLEX nodes                                                    01010000
*--------------------------------------------------------------         01020000
                                                                        01030000
         ICM   R1,15,PPLRTLCB     LOCATE LCB                            01040000
         BZ    STGLCB             SKIP IF NOT PRESENT                   01050000
         ICM   R1,15,0(R1)        R1 <== #CLEX LIST ORIGIN              01060000
         BZ    STGLCB             SKIP IF NO #CLEX ENTRIES              01070000
                                                                        01080000
         @CALL ISQFCLEX           RELEASE ALL ASSOCIATED STORAGE        01090000
                                                                        01100000
STGLCB   DS    0H                                                       01110000
                                                                        01120000
*--------------------------------------------------------------         01130000
*   Release parse workarea                                              01140000
*--------------------------------------------------------------         01150000
                                                                        01160000
         L     R3,PPLRSIZE        LENGTH TO FREE                        01170000
                                                                        01180000
         STORAGE RELEASE,LENGTH=(R3),ADDR=(R4)                          01190000
                                                                        01200000
         XC    0(4,R6),0(R6)      HOUSEKEEPING COMPLETE                 01210000
         DROP  R4                 PPLRESP                               01220000
                                                                        01230000
FPARSER  DS    0H                                                       01240000
                                                                        01250000
***************************************************************         01260000
*                                                                       01270000
*   Return to caller                                                    01280000
*                                                                       01290000
***************************************************************         01300000
                                                                        01310000
         LA    R15,RC00           NORMAL COMPLETION                     01320000
         SR    R0,R0              REASON CODES NOT DEFINED              01330000
                                                                        01340000
         #EXIT                                                          01350000
                                                                        01360000
         EJECT                                                          01370000
***************************************************************         01380000
*                                                                       01390000
*   Local read-only working storage                                     01400000
*                                                                       01410000
***************************************************************         01420000
                                                                        01430000
         LTORG ,                                                        01440000
                                                                        01450000
         PRINT NOGEN                                                    01460000
         ICVT    ,                                                      01470000
         ITASK   ,                                                      01480000
         END   ,                                                        01490000

IVTMTPIN TITLE 'INTEGRATOR - PLU INTEGRATOR SESSION DRIVER (TEST)'      00010000
**<DOC-ON>************************************************************* 00020000
*                                                                       00030000
* ROUTINE: IVTMTPIN - PLU INTEGRATOR SESSION DRIVER (TEST)              00040000
*                                                                       00050000
* DESCRIPTION: THE SESSION DRIVER IS STARTED AS A NEW PROC UNDER        00060000
*              THE SESSION ITASK WHEN A NEW SESSION IS ESTABLISHED.     00070000
*                                                                       00080000
* ON ENTRY:                                                             00090000
*                                                                       00100000
*    R15 = ENTRY POINT ADDRESS                                          00110000
*    R14 = RETURN ADDRESS                                               00120000
*    R13 = AVAILABLE SAVE AREA                                          00130000
*    R11 = ICVT ADDRESS                                                 00140000
*    R10 = ITASK ADDRESS                                                00150000
*    R01 = ADDRESS OF THE SESSION TOKEN                                 00160000
*                                                                       00170000
* ON EXIT:                                                              00180000
*                                                                       00190000
*    R15 = 0                                                            00200000
*    R00 = 0                                                            00210000
*    R01 = 0                                                            00220000
*                                                                       00230000
*    ALL OTHER REGISTERS ARE RESTORED.                                  00240000
*                                                                       00250000
**<DOC-OFF>************************************************************ 00260000
                                                                        00270000
         EJECT ,                                                        00280000
*********************************************************************** 00290000
*                                                                       00300000
* MAINTENANCE:                                                          00310000
*                                                                       00320000
*   08/01/93 RANDY WITEK                                                00330000
*                                                                       00340000
*********************************************************************** 00350000
                                                                        00360000
         EQUS  ,                  GENERAL EQUATES                       00370000
                                                                        00380000
RICVT    EQU   R11                                                      00390000
RITASK   EQU   R10                                                      00400000
RIVTAM   EQU   R9                                                       00410000
RTOKEN   EQU   R8                                                       00420000
RSPLISTR EQU   R7                                                       00430000
RSPLISTS EQU   R6                                                       00440000
                                                                        00450000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00460000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00470000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00480000
         USING SPLIST,RSPLISTR    ESTABLISH ADDRESSABILITY              00490000
S        USING SPLIST,RSPLISTS    ESTABLISH ADDRESSABILITY              00500000
                                                                        00510000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00520000
WRK256   DS    XL256              GENERAL WORKAREA                      00530000
                                                                        00540000
LV1SAVE  DS    18F                SUBROUTINE SAVE AREA                  00550000
LV0SAVE  DS    18F                SUBROUTINE SAVE AREA                  00560000
                                                                        00570000
SNASTATE DS    F                  EXTRACT AREA                          00580000
                                                                        00590000
TERMNAME DS    CL8                TERMINAL NAME FOR PLUSESS COMMAND     00600000
NEWTOKEN DS    CL8                TOKEN AREA FOR NEW SESSION            00610000
                                                                        00620000
$TASKMFL $TASK MF=L               $TASK PLIST CONSTRUCTION              00630000
$SESSRCV DS    A                  $SESS PLIST ADDRESS                   00640000
$SESSSND DS    A                  $SESS PLIST ADDRESS                   00650000
$SESSEX  $SESS MF=L,FIELDS=((SNASTATE,SNASTATE,,4))                     00660000
                                                                        00670000
RCVEPB   DS    F                  RECEIVE EPB ADDRESS                   00680000
                                                                        00690000
ECODE    DS    F                  LAST EVENT CODE                       00700000
                                                                        00710000
RETR15   DS    F                                                        00720000
RETR0    DS    F                                                        00730000
RETR1    DS    F                                                        00740000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00750000
                                                                        00760000
FLAGS    DS    X                  FLAG BYTE                             00770000
FLAGSQUI EQU   X'80'              QUIET MODE                            00780000
                                                                        00790000
DATASAVE DS    XL4096                                                   00800000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00810000
                                                                        00820000
         $MSGDFT PREFIX=ICTPID,                                        +00830000
               COMPID='VTM',                                           +00840000
               TABLE=*#MSGS,                                           +00850000
               WORKA=0,                                                +00860000
               MF=(E,WRK256),                                          +00870000
               PRINT=NOGEN                                              00880000
                                                                        00890000
IVTMTPIN #ENTER BASE=R12,         ENTRY LINKAGE                        +00900000
               AMODE=31,                                               +00910000
               PREG=RTOKEN,                                            +00920000
               RMODE=ANY                                                00930000
                                                                        00940000
*---------------------------------------------------------------------- 00950000
* ESTABLISH ENVIRONMENT                                                 00960000
*---------------------------------------------------------------------- 00970000
                                                                        00980000
         L     RIVTAM,ICTVTCVT    IVTAMCVT ADDRESS                      00990000
         LA    RTOKEN,1(,RTOKEN)  POINT PAST LENGTH BYTE                01000000
                                                                        01010000
*---------------------------------------------------------------------- 01020000
* SET "QUIET MODE" IF REQUESTED                                         01030000
*---------------------------------------------------------------------- 01040000
                                                                        01050000
         BAS   R14,QUIETEST       CHECK FOR QUIET MODE                  01060000
                                                                        01070000
*---------------------------------------------------------------------- 01080000
* ISSUE AN INFORMATIVE MESSAGE                                          01090000
*---------------------------------------------------------------------- 01100000
                                                                        01110000
         TM    FLAGS,FLAGSQUI     QUIET MODE?                           01120000
         BO    SKIP12             BRANCH IF YES                         01130000
                                                                        01140000
         $MSG  012,               "VTAM DRIVER TOKEN...STARTING"       +01150000
               FIELDS=(((RTOKEN),4), SESSION TOKEN                     +01160000
               (4(,RTOKEN),4),       SESSION TOKEN PART2               +01170000
               (RITASK),             ITASK ADDRESS                     +01180000
               (TSKPCBC,4),          IPROC ADDRESS                     +01190000
               (TSKNAME,8))          ITASK NAME                         01200000
                                                                        01210000
SKIP12   DS    0H                                                       01220000
                                                                        01230000
*---------------------------------------------------------------------- 01240000
* INITIALIZE THE EPB FOR $SESS_RECEIVE OPERATIONS                       01250000
*---------------------------------------------------------------------- 01260000
                                                                        01270000
         $TASK SETEPB,                                                 +01280000
               ECODE=1025,                                             +01290000
               ERRET=ERR$TASK,                                         +01300000
               MF=(E,$TASKMFL)    ALLOCATE AN XEPB                      01310000
                                                                        01320000
         ST    R1,RCVEPB          SAVE XEPB ADDRESS                     01330000
                                                                        01340000
*---------------------------------------------------------------------- 01350000
* ALLOCATE SEND AND RECEIVE SPLISTS FROM ITASK STORAGE                  01360000
*---------------------------------------------------------------------- 01370000
                                                                        01380000
         $GETSTOR L'SPL,                                               +01390000
               LOC=ANY,                                                +01400000
               OWNER=(RITASK)                                           01410000
                                                                        01420000
         ST    R1,$SESSRCV                                              01430000
                                                                        01440000
         $GETSTOR L'SPL,                                               +01450000
               LOC=ANY,                                                +01460000
               OWNER=(RITASK)                                           01470000
                                                                        01480000
         ST    R1,$SESSSND                                              01490000
                                                                        01500000
*---------------------------------------------------------------------- 01510000
* START THE FIRST RECEIVE                                               01520000
*---------------------------------------------------------------------- 01530000
                                                                        01540000
         $SESS $SESS_RECEIVE,                                          +01550000
               SESSION=(RTOKEN),                                       +01560000
               EPB=*RCVEPB,                                            +01570000
               ERRET=ERR$RCV,                                          +01580000
               MF=(E,*$SESSRCV)                                         01590000
                                                                        01600000
*---------------------------------------------------------------------- 01610000
* WAIT FOR AN EVENT TO OCCUR AND JUMP TO THE PROCESSING ROUTINE         01620000
*---------------------------------------------------------------------- 01630000
                                                                        01640000
WAITWORK DS    0H                                                       01650000
                                                                        01660000
         $TASK WAIT,              WAIT FOR EVENT                       +01670000
               MF=(E,$TASKMFL)                                          01680000
                                                                        01690000
         ST    R15,ECODE          SAVE THE EVENT CODE                   01700000
                                                                        01710000
         C     R15,=A(1025)       IS A RCV COMPLETE?                    01720000
         BE    RCV                BRANCH IF YES                         01730000
                                                                        01740000
         C     R15,=A(EC$STOP)    IS PROC STOP REQUESTED?               01750000
         BE    PSTP               BRANCH IF YES                         01760000
                                                                        01770000
         C     R15,=A(EC$CNCL)    IS PROC CANCEL REQUESTED?             01780000
         BE    PCAN               BRANCH IF YES                         01790000
                                                                        01800000
         B     WAITWORK           IGNORE ANYTHING ELSE                  01810000
                                                                        01820000
*---------------------------------------------------------------------- 01830000
* PROCESS A $SESS_RECEIVE COMPLETION                                    01840000
*---------------------------------------------------------------------- 01850000
                                                                        01860000
RCV      DS    0H                                                       01870000
                                                                        01880000
         L     RSPLISTR,$SESSRCV  THE RECEIVE PARM LIST                 01890000
         L     RSPLISTS,$SESSSND  THE SEND    PARM LIST                 01900000
         BAS   R14,DISPRCV        DIAGNOSTIC DISPLAY                    01910000
                                                                        01920000
*                                                                       01930000
* TEST THE RETURN CODE                                                  01940000
*---------------------------------------------------------------------- 01950000
                                                                        01960000
         CLC   SPLRETCD,=A($SESS_RC_SUCCESS)                            01970000
         BE    RCVCONT                          CHECK WHAT WAS RECEIVED 01980000
                                                                        01990000
         CLC   SPLRETCD,=A($SESS_RC_FUNCTION)                           02000000
         BE    ERR$RCV                          HOW DID THIS HAPPEN     02010000
                                                                        02020000
         CLC   SPLRETCD,=A($SESS_RC_ENVIRONMENT)                        02030000
         BE    ERR$RCV                          HOW DID THIS HAPPEN     02040000
                                                                        02050000
         CLC   SPLRETCD,=A($SESS_RC_LENGTH)                             02060000
         BE    ERR$RCV                          HOW DID THIS HAPPEN     02070000
                                                                        02080000
         CLC   SPLRETCD,=A($SESS_RC_BUSY)                               02090000
         BE    ERR$RCV                          HOW DID THIS HAPPEN     02100000
                                                                        02110000
         CLC   SPLRETCD,=A($SESS_RC_CANCELED)                           02120000
         BE    WAITWORK                         WAIT FOR PROC STOP      02130000
                                                                        02140000
         CLC   SPLRETCD,=A($SESS_RC_VTAMRC)                             02150000
         BE    RECOVER                          TRY TO RECOVER          02160000
                                                                        02170000
         CLC   SPLRETCD,=A($SESS_RC_PROTOCOL)                           02180000
         BE    RECOVER                          TRY TO RECOVER          02190000
                                                                        02200000
*                                                                       02210000
* CHECK IF A RESPONSE WAS RECEIVED                                      02220000
*---------------------------------------------------------------------- 02230000
                                                                        02240000
RCVCONT  DS    0H                                                       02250000
                                                                        02260000
                                                                        02270000
         TM    SPLRH,RHQS         WAS IT A RESPONSE?                    02280000
         BO    RESPONSE           BRANCH IF YES                         02290000
                                                                        02300000
*                                                                       02310000
* COPY THE DATA AREA AND RELEASE IT IF THIS IS A DATA REQUEST           02320000
*---------------------------------------------------------------------- 02330000
                                                                        02340000
         TM    SPLCNTRL,RPLDATA   WAS IT A DATA REQUEST?                02350000
         BNO   RCVNAREA           BRANCH IF NOT                         02360000
         ICM   R3,15,SPLAREAL     WAS AN AREA RETURNED?                 02370000
         BZ    RCVNAREA           BRANCH IF NOT                         02380000
         L     R2,SPLAREA         ADDRESS OF DATA                       02390000
         LA    R0,DATASAVE        TEMP WORK AREA                        02400000
         L     R1,=F'4096'        SIZE OF TEMP AREA                     02410000
         MVCL  R0,R2              COPY DATA TO TEMP WORK AREA           02420000
                                                                        02430000
         $RETSTOR *SPLAREA,       RELEASE THE DATA AREA                +02440000
               OWNER=(RITASK)                                           02450000
                                                                        02460000
*                                                                       02470000
* A REQUEST WAS RECEIVED SO SEND A RESPONSE IF NEEDED                   02480000
*---------------------------------------------------------------------- 02490000
                                                                        02500000
RCVNAREA DS    0H                                                       02510000
                                                                        02520000
         BAS   R14,SENDPRSP       CALL THE RESPONSE ROUTINE             02530000
                                                                        02540000
*                                                                       02550000
* CHECK FOR A "LOGOFF"                                                  02560000
*---------------------------------------------------------------------- 02570000
                                                                        02580000
         LA    R2,DATASAVE+6      ADDRESS OF FIELD DATA                 02590000
         CLI   DATASAVE+3,X'11'   WAS SBA RECEIVED?                     02600000
         BE    CHECKOFF           BRANCH IF YES                         02610000
         LA    R2,DATASAVE+3      UNFORMATTED DATA BEGINS HERE          02620000
                                                                        02630000
CHECKOFF DS    0H                                                       02640000
                                                                        02650000
         MVC   WRK256(8),0(R2)      COPY POSSIBLE COMMAND               02660000
         OC    WRK256(8),=8C' '     UPPER CASE                          02670000
                                                                        02680000
         CLC   WRK256(6),=C'LOGOFF' LOGOFF REQUEST?                     02690000
         BNE   NOTOFF             BRANCH IF NOT                         02700000
                                                                        02710000
         $SESS $SESS_END_SESSION, END THE SESSION                      +02720000
               SESSION=(RTOKEN),                                       +02730000
               ERRET=ERR$SEND,                                         +02740000
               MF=(E,*$SESSSND)                                         02750000
         BAS   R14,DISPSND        DIAGNOSTIC DISPLAY                    02760000
         B     WAITWORK                                                 02770000
                                                                        02780000
NOTOFF   DS    0H                                                       02790000
                                                                        02800000
*                                                                       02810000
* CHECK FOR A "SLU SESSION" REQUEST   (SLUSESS-XXXXXXXX)                02820000
*---------------------------------------------------------------------- 02830000
                                                                        02840000
         CLC   WRK256(8),=C'SLUSESS-' SLU SESSION REQUEST?              02850000
         BNE   NOTSESS              BRANCH IF NOT                       02860000
         MVC   TERMNAME(8),8(R2)    COPY TERMNAME                       02870000
         OC    TERMNAME(8),=8C' '     UPPER CASE                        02880000
         MVC   NEWTOKEN(8),0(RTOKEN) COPY TOKEN                         02890000
                                                                        02900000
         $SESS $SESS_START_SESSION, START A NEW SESSION                +02910000
               SESSION=NEWTOKEN,    WE WILL RECEIVE TOKEN HERE         +02920000
               LUNAME=TERMNAME,     HARDCODED TMRLW003 FOR TESTING     +02930000
               LOGMODE=HARDMODE,    HARDCODED LSX32702 FOR TESTING     +02940000
               AREA=SLUDATA,        USERDATA                           +02950000
               AREALEN=L'SLUDATA,   USERDATA LENGTH                    +02960000
               MF=(E,*$SESSSND)                                         02970000
                                                                        02980000
         BAS   R14,DISPSND          DIAGNOSTIC DISPLAY                  02990000
         B     SENDDATA                                                 03000000
                                                                        03010000
NOTSESS  DS    0H                                                       03020000
                                                                        03030000
*                                                                       03040000
* CHECK FOR A PARALLEL "SLU SESSION" REQUEST   (PARSESS-XXXXXXXX)       03050000
*---------------------------------------------------------------------- 03060000
                                                                        03070000
         CLC   WRK256(8),=C'PARSESS-' PARALLEL SLU SESSION REQUEST?     03080000
         BNE   NOTPARL              BRANCH IF NOT                       03090000
         MVC   TERMNAME(8),8(R2)    COPY TERMNAME                       03100000
         OC    TERMNAME(8),=8C' '     UPPER CASE                        03110000
         MVC   NEWTOKEN(8),0(RTOKEN) COPY TOKEN                         03120000
                                                                        03130000
         $SESS $SESS_START_SESSION, START A NEW SESSION                +03140000
               SESSION=NEWTOKEN,    WE WILL RECEIVE TOKEN HERE         +03150000
               LUNAME=TERMNAME,     HARDCODED TMRLW003 FOR TESTING     +03160000
               LOGMODE=HARDMODE,    HARDCODED LSX32702 FOR TESTING     +03170000
               PARSESS=YES,         PARALLEL SESSIONS ARE OK           +03180000
               AREA=SLUDATA,        USERDATA                           +03190000
               AREALEN=L'SLUDATA,   USERDATA LENGTH                    +03200000
               MF=(E,*$SESSSND)                                         03210000
                                                                        03220000
         BAS   R14,DISPSND          DIAGNOSTIC DISPLAY                  03230000
         B     SENDDATA                                                 03240000
                                                                        03250000
NOTPARL  DS    0H                                                       03260000
                                                                        03270000
*                                                                       03280000
* CHECK FOR A "PLU SESSION" REQUEST (PLUSESS-XXXXXXXX)                  03290000
*---------------------------------------------------------------------- 03300000
                                                                        03310000
         CLC   WRK256(8),=C'PLUSESS-' PLU SESSION REQUEST?              03320000
         BNE   NOTPSESS             BRANCH IF NOT                       03330000
         MVC   TERMNAME(8),8(R2)    COPY TERMNAME                       03340000
         OC    TERMNAME(8),=8C' '     UPPER CASE                        03350000
         MVC   NEWTOKEN(8),0(RTOKEN) COPY TOKEN                         03360000
                                                                        03370000
         $SESS $SESS_START_SESSION, START A NEW SESSION                +03380000
               SESSION=NEWTOKEN,    WE WILL RECEIVE TOKEN HERE         +03390000
               LUNAME=TERMNAME,     NAME PROVIDED BY COMMAND           +03400000
               LOGMODE=HARDMODE,    HARDCODED LSX32702 FOR TESTING     +03410000
               DRIVER=TERMDRIV,     HARDCODED TESTLU2  FOR TESTING     +03420000
               PLU=YES,             WE WILL BE PLU                     +03430000
               MF=(E,*$SESSSND)                                         03440000
                                                                        03450000
         BAS   R14,DISPSND          DIAGNOSTIC DISPLAY                  03460000
         B     SENDDATA                                                 03470000
                                                                        03480000
NOTPSESS DS    0H                                                       03490000
                                                                        03500000
*                                                                       03510000
* CHECK FOR AN INDEPENDENT "PLU SESSION" REQUEST (INDSESS-XXXXXXXX)     03520000
*---------------------------------------------------------------------- 03530000
                                                                        03540000
         CLC   WRK256(8),=C'INDSESS-' PLU SESSION REQUEST?              03550000
         BNE   NOTINDEP             BRANCH IF NOT                       03560000
         MVC   TERMNAME(8),8(R2)    COPY TERMNAME                       03570000
         OC    TERMNAME(8),=8C' '     UPPER CASE                        03580000
         MVC   NEWTOKEN(8),0(RTOKEN) COPY TOKEN                         03590000
                                                                        03600000
         $SESS $SESS_START_SESSION, START A NEW SESSION                +03610000
               LUNAME=TERMNAME,     NAME PROVIDED BY COMMAND           +03620000
               LOGMODE=HARDMODE,    HARDCODED LSX32702 FOR TESTING     +03630000
               DRIVER=TERMDRIV,     HARDCODED TESTLU2  FOR TESTING     +03640000
               PLU=YES,             WE WILL BE PLU                     +03650000
               MF=(E,*$SESSSND)                                         03660000
                                                                        03670000
         BAS   R14,DISPSND          DIAGNOSTIC DISPLAY                  03680000
         B     SENDDATA                                                 03690000
                                                                        03700000
HARDMODE DC    CL8'LSX32702'                                            03710000
TERMDRIV DC    CL8'TESTLU2'                                             03720000
SLUDATA  DC    CL25'TESTLU2'                                            03730000
                                                                        03740000
NOTINDEP DS    0H                                                       03750000
                                                                        03760000
*                                                                       03770000
* SEND SOME DATA                                                        03780000
*---------------------------------------------------------------------- 03790000
                                                                        03800000
SENDDATA DS    0H                                                       03810000
                                                                        03820000
                                                                        03830000
         $SESS $SESS_SEND_DATA,   SEND THE DATA                        +03840000
               SESSION=(RTOKEN),                                       +03850000
               AREA=SENDMSG,                                           +03860000
               AREALEN=L'SENDMSG,                                      +03870000
               BC=YES,EC=YES,DR1=YES,CD=YES,                           +03880000
               MF=(E,*$SESSSND)                                         03890000
         BAS   R14,DISPSND        DIAGNOSTIC DISPLAY                    03900000
                                                                        03910000
         CLC   S.SPLRETCD(4),=A(0)                                      03920000
         BNE   RECOVER                                                  03930000
                                                                        03940000
         B     RCVISSUE                                                 03950000
                                                                        03960000
SENDMSG1 DC    X'F5C31D60',C'PLATINUM INTEGRATOR'                       03970000
         DC    X'1D4013'                                                03980000
SENDMSG  EQU   SENDMSG1,*-SENDMSG1                                      03990000
                                                                        04000000
*                                                                       04010000
* RE-ISSUE THE RECEIVE                                                  04020000
*---------------------------------------------------------------------- 04030000
                                                                        04040000
RCVISSUE DS    0H                                                       04050000
                                                                        04060000
         $TASK SETEPB,                                                 +04070000
               ECODE=1025,                                             +04080000
               ERRET=ERR$TASK,                                         +04090000
               MF=(E,$TASKMFL)    ALLOCATE AN XEPB                      04100000
                                                                        04110000
         ST    R1,RCVEPB          SAVE XEPB ADDRESS                     04120000
                                                                        04130000
         $SESS $SESS_RECEIVE,                                          +04140000
               SESSION=(RTOKEN),                                       +04150000
               EPB=*RCVEPB,                                            +04160000
               ERRET=ERR$RCV,                                          +04170000
               MF=(E,*$SESSRCV)                                         04180000
                                                                        04190000
         B     WAITWORK                                                 04200000
                                                                        04210000
*---------------------------------------------------------------------- 04220000
* A RESPONSE WAS RECEIVED. IF IT WAS POSITIVE, IGNORE IT. ELSE, RECOVER 04230000
*---------------------------------------------------------------------- 04240000
                                                                        04250000
RESPONSE DS    0H                                                       04260000
                                                                        04270000
         TM    SPLRH1,RHERI       EXCEPTION RESPONSE?                   04280000
         BNO   WAITWORK           BRANCH IF NOT TO IGNORE               04290000
                                                                        04300000
RECOVER  DS    0H                                                       04310000
                                                                        04320000
         $SESS $SESS_SEND_CLEAR,  CLEAR THE SESSION                    +04330000
               SESSION=(RTOKEN),                                       +04340000
               ERRET=ERR$SEND,                                         +04350000
               MF=(E,*$SESSSND)                                         04360000
         BAS   R14,DISPSND        DIAGNOSTIC DISPLAY                    04370000
                                                                        04380000
         $SESS $SESS_SEND_SDT,    MAKE DATA_TRAFFIC_ACTIVE             +04390000
               SESSION=(RTOKEN),                                       +04400000
               ERRET=ERR$SEND,                                         +04410000
               MF=(E,*$SESSSND)                                         04420000
         BAS   R14,DISPSND        DIAGNOSTIC DISPLAY                    04430000
                                                                        04440000
         $SESS $SESS_SEND_DATA,   SEND THE GREETING                    +04450000
               SESSION=(RTOKEN),                                       +04460000
               AREA=SENDMSG,                                           +04470000
               AREALEN=L'SENDMSG,                                      +04480000
               BC=YES,EC=YES,DR1=YES,CD=YES,BB=YES,                    +04490000
               ERRET=ERR$SEND,                                         +04500000
               MF=(E,*$SESSSND)                                         04510000
         BAS   R14,DISPSND        DIAGNOSTIC DISPLAY                    04520000
                                                                        04530000
         B     RCVISSUE                                                 04540000
                                                                        04550000
*---------------------------------------------------------------------- 04560000
* PROCESS A PROC STOP REQUEST                                           04570000
*---------------------------------------------------------------------- 04580000
                                                                        04590000
PSTP     DS    0H                                                       04600000
                                                                        04610000
         TM    FLAGS,FLAGSQUI     QUIET MODE?                           04620000
         BO    EXIT               BRANCH IF YES                         04630000
                                                                        04640000
         $MSG  982,                 "DRIVER PROC STOP"                 +04650000
               FIELDS=(((RTOKEN),4), SESSION TOKEN                     +04660000
               (4(,RTOKEN),4),       SESSION TOKEN PART2               +04670000
               (RITASK),             ITASK ADDRESS                     +04680000
               (TSKPCBC,4),          IPROC ADDRESS                     +04690000
               (TSKNAME,8))          ITASK NAME                         04700000
                                                                        04710000
         B     EXIT               EXIT WHEN STOP REQUESTED              04720000
                                                                        04730000
*---------------------------------------------------------------------- 04740000
* PROCESS A PROC CANCEL REQUEST                                         04750000
*---------------------------------------------------------------------- 04760000
                                                                        04770000
PCAN     DS    0H                                                       04780000
                                                                        04790000
         TM    FLAGS,FLAGSQUI     QUIET MODE?                           04800000
         BO    EXIT               BRANCH IF YES                         04810000
                                                                        04820000
         $MSG  979,                 "DRIVER PROC CANCEL"               +04830000
               FIELDS=(((RTOKEN),4), SESSION TOKEN                     +04840000
               (4(,RTOKEN),4),       SESSION TOKEN PART2               +04850000
               (RITASK),             ITASK ADDRESS                     +04860000
               (TSKPCBC,4),          IPROC ADDRESS                     +04870000
               (TSKNAME,8))          ITASK NAME                         04880000
                                                                        04890000
         B     EXIT               END TASK IMMEDIATELY                  04900000
                                                                        04910000
*---------------------------------------------------------------------- 04920000
* SUBROUTINE: SENDPRSP                                                  04930000
*---------------------------------------------------------------------- 04940000
                                                                        04950000
SENDPRSP DS     0H                                                      04960000
                                                                        04970000
         STM   R14,R12,LV1SAVE                                          04980000
                                                                        04990000
         $SESS $SESS_SEND_POSRESP,  SEND A RESPONSE AS NEEDED          +05000000
               SESSION=(RTOKEN),                                       +05010000
               RH=*,                                                   +05020000
               SEQNO=*,                                                +05030000
               CNTRL=*,                                                +05040000
               SENSE=*,                                                +05050000
               ERRET=ERR$RCV,                                          +05060000
               MF=(E,*$SESSRCV)                                         05070000
                                                                        05080000
         BAS   R14,DISPRCV          DIAGNOSTIC DISPLAY                  05090000
                                                                        05100000
         LM    R14,R12,LV1SAVE                                          05110000
         BR    R14                                                      05120000
                                                                        05130000
*---------------------------------------------------------------------- 05140000
* SUBROUTINE: SENDNRSP                                                  05150000
*---------------------------------------------------------------------- 05160000
                                                                        05170000
SENDNRSP DS     0H                                                      05180000
                                                                        05190000
         STM   R14,R12,LV1SAVE                                          05200000
                                                                        05210000
         $SESS $SESS_SEND_NEGRESP,  SEND A NEGATIVE RESPONSE           +05220000
               SESSION=(RTOKEN),                                       +05230000
               RH=*,                                                   +05240000
               SEQNO=*,                                                +05250000
               CNTRL=*,                                                +05260000
               SENSE=SNS1005,                                          +05270000
               ERRET=ERR$RCV,                                          +05280000
               MF=(E,*$SESSRCV)                                         05290000
                                                                        05300000
         BAS   R14,DISPRCV          DIAGNOSTIC DISPLAY                  05310000
                                                                        05320000
         LM    R14,R12,LV1SAVE                                          05330000
         BR    R14                                                      05340000
                                                                        05350000
SNS1005  DC    XL4'10050000'                                            05360000
                                                                        05370000
*---------------------------------------------------------------------- 05380000
* SUBROUTINE: DISPSND                                                   05390000
*---------------------------------------------------------------------- 05400000
                                                                        05410000
DISPSND  DS     0H                                                      05420000
                                                                        05430000
         STM   R14,R12,LV0SAVE                                          05440000
         L     RSPLISTS,$SESSSND                                        05450000
                                                                        05460000
         TM    FLAGS,FLAGSQUI        QUIET MODE?                        05470000
         BO    DISPSEND              BRANCH IF YES                      05480000
                                                                        05490000
DISPSOK  DS     0H                                                      05500000
                                                                        05510000
         $SESS $SESS_EXTRACT,                                          +05520000
               SESSION=(RTOKEN),                                       +05530000
               FIELDS=((SNASTATE,SNASTATE,,4)),                        +05540000
               MF=(E,$SESSEX)                                           05550000
                                                                        05560000
         $MSG  978,                  "DRIVER RECEIVE COMPLETE"         +05570000
               FIELDS=(((RTOKEN),4), SESSION TOKEN                     +05580000
               (4(,RTOKEN),4),       SESSION TOKEN PART2               +05590000
               (RSPLISTS),           SPLIST ADDRESS                    +05600000
               (S.SPLSENSE,4),       SENSE                             +05610000
               (S.SPLF1,4),          FLAGS                             +05620000
               (SNASTATE,4),         SESSION STATE                     +05630000
               (S.SPLAREA,4),        AREA  ADDRESS                     +05640000
               (S.SPLAREAL,4),       AREA  LENGTH                      +05650000
               (S.SPLCNTRL,3),       RPL CNTRL FLAGS                   +05660000
               (S.SPLRH,3),          RPL USERRH                        +05670000
               (S.SPLSEQNO,2),       RPL SEQNO                         +05680000
               (S.SPLRETCD,4),       THE RETURN CODE                   +05690000
               (S.SPLRSNCD,4),       THE REASON CODE                   +05700000
               (S.SPLFUNC,4))        THE FUNCTION                       05710000
                                                                        05720000
DISPSEND DS     0H                                                      05730000
                                                                        05740000
         LM    R14,R12,LV0SAVE                                          05750000
         BR    R14                                                      05760000
                                                                        05770000
*---------------------------------------------------------------------- 05780000
* SUBROUTINE: DISPRCV                                                   05790000
*---------------------------------------------------------------------- 05800000
                                                                        05810000
DISPRCV  DS     0H                                                      05820000
                                                                        05830000
         STM   R14,R12,LV0SAVE                                          05840000
         L     RSPLISTR,$SESSRCV                                        05850000
                                                                        05860000
         TM    FLAGS,FLAGSQUI        QUIET MODE?                        05870000
         BO    DISPREND              BRANCH IF YES                      05880000
                                                                        05890000
DISPROK  DS     0H                                                      05900000
                                                                        05910000
                                                                        05920000
         $SESS $SESS_EXTRACT,                                          +05930000
               SESSION=(RTOKEN),                                       +05940000
               FIELDS=((SNASTATE,SNASTATE,,4)),                        +05950000
               MF=(E,$SESSEX)                                           05960000
                                                                        05970000
         $MSG  978,                  "DRIVER RECEIVE COMPLETE"         +05980000
               FIELDS=(((RTOKEN),4), SESSION TOKEN                     +05990000
               (4(,RTOKEN),4),       SESSION TOKEN PART2               +06000000
               (RSPLISTR),           SPLIST ADDRESS                    +06010000
               (SPLSENSE,4),         SENSE                             +06020000
               (SPLF1,4),            FLAGS                             +06030000
               (SNASTATE,4),         SESSION STATE                     +06040000
               (SPLAREA,4),          AREA  ADDRESS                     +06050000
               (SPLAREAL,4),         AREA  LENGTH                      +06060000
               (SPLCNTRL,3),         RPL CNTRL FLAGS                   +06070000
               (SPLRH,3),            RPL USERRH                        +06080000
               (SPLSEQNO,2),         RPL SEQNO                         +06090000
               (SPLRETCD,4),         THE RETURN CODE                   +06100000
               (SPLRSNCD,4),         THE REASON CODE                   +06110000
               (SPLFUNC,4))          THE FUNCTION                       06120000
                                                                        06130000
DISPREND DS     0H                                                      06140000
                                                                        06150000
         LM    R14,R12,LV0SAVE                                          06160000
         BR    R14                                                      06170000
                                                                        06180000
*---------------------------------------------------------------------- 06190000
* SUBROUTINE: QUIETEST                                                  06200000
*---------------------------------------------------------------------- 06210000
                                                                        06220000
QUIETEST DS     0H                                                      06230000
                                                                        06240000
         STM   R14,R12,LV0SAVE                                          06250000
         L     RSPLISTS,$SESSSND                                        06260000
                                                                        06270000
         $SESS $SESS_EXTRACT,                                          +06280000
               SESSION=(RTOKEN),                                       +06290000
               FIELDS=((USERDATA,WRK256,,256)),                        +06300000
               MF=(E,$SESSEX)                                           06310000
                                                                        06320000
         LA    R2,WRK256          START OF USERDATA                     06330000
         CLC   0(1,R2),C'('       PL/1 FORMAT?                          06340000
         BNE   QUICHECK           BRANCH IF NOT                         06350000
         LA    R2,1(,R2)          PAST '('                              06360000
                                                                        06370000
QUICHECK DS     0H                                                      06380000
                                                                        06390000
         CLC   8(5,R2),=C'QUIET'  QUIET MODE REQUESTED?                 06400000
         BNE   QUIDONE            BRANCH IF NOT                         06410000
         OI    FLAGS,FLAGSQUI     SET QUIET MODE                        06420000
                                                                        06430000
QUIDONE  DS     0H                                                      06440000
                                                                        06450000
         LM    R14,R12,LV0SAVE                                          06460000
         BR    R14                                                      06470000
                                                                        06480000
*---------------------------------------------------------------------- 06490000
* EXIT TO END DRIVER PROCESS                                            06500000
*---------------------------------------------------------------------- 06510000
                                                                        06520000
EXIT     DS    0H                                                       06530000
                                                                        06540000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 06550000
                                                                        06560000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    06570000
                                                                        06580000
*---------------------------------------------------------------------- 06590000
* ERROR ROUTINES                                                        06600000
*---------------------------------------------------------------------- 06610000
                                                                        06620000
ERR$TASK DS    0H                                                       06630000
                                                                        06640000
         $ABEND ABE_VTDIAG,                                            +06650000
               SCOPE=PCB,                                              +06660000
               TITLE='$TASK FAILURE'                                    06670000
                                                                        06680000
ERR$RCV  DS    0H                                                       06690000
                                                                        06700000
         CLC   SPLRETCD,=A($SESS_RC_CANCELED)                           06710000
         BE    WAITWORK                                                 06720000
                                                                        06730000
         $ABEND ABE_VTDIAG,                                            +06740000
               SCOPE=PCB,                                              +06750000
               TITLE='$SESS RECEIVE FAILURE'                            06760000
                                                                        06770000
ERR$SEND DS    0H                                                       06780000
                                                                        06790000
         CLC   S.SPLRETCD,=A($SESS_RC_CANCELED)                         06800000
         BE    WAITWORK                                                 06810000
                                                                        06820000
         $ABEND ABE_VTDIAG,                                            +06830000
               SCOPE=PCB,                                              +06840000
               TITLE='$SESS SEND FAILURE'                               06850000
                                                                        06860000
                                                                        06870000
*---------------------------------------------------------------------- 06880000
*  CONSTANTS AND LITERALS                                               06890000
*---------------------------------------------------------------------- 06900000
                                                                        06910000
         LTORG ,                                                        06920000
         PRINT NOGEN                                                    06930000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                06940000
         ISTDBIND ,               VTAM BIND IMAGE                       06950000
         ISTRH ,                  VTAM SNA REQUEST HEADER               06960000
         ICVT  ,                  INTEGRATOR CVT                        06970000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   06980000
         IRPL ,                   INTEGRATOR VTAM RPL+                  06990000
         IACB ,                   INTEGRATOR VTAM ACB+                  07000000
         INIB ,                   INTEGRATOR VTAM NIB+                  07010000
         ISESS ,                  INTEGRATOR SESSION BLOCK              07020000
         IRQE ,                   INTEGRATOR RECEIVE QUEUE ELEMENT      07030000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            07040000
         ITASK ,                  INTEGRATOR TASK BLOCK                 07050000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          07060000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       07070000
         EVCODES ,                INTEGRATOR EVENT CODES                07080000
         ABCODES ,                INTEGRATOR $ABEND CODES               07090000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     07100000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        07110000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             07120000
         $PROC DSECT=YES          INTEGRATOR $PROC SERVICES             07130000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             07140000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             07150000
         IFGEXLST ,               VTAM EXIT LIST                        07160000
         END   ,                                                        07170000

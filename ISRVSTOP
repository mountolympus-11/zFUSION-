ISRVSTOP TITLE '- Stop Server Task(s)'                                  00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE: ISRVSTOP - Stop Server Task(s)                               00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine will notify the specified (or all) server             00080000
*    task(s) to terminate.  The Server task Halt EPB will               00090000
*    be posted to signal the server task completion.  Server            00100000
*    tasks ignore the standard Stop/cancel events to prevent            00110000
*    premature termination.  After posting the server halt              00120000
*    EPB,  this routine will wait for termination of the                00130000
*    server task.                                                       00140000
*                                                                       00150000
* ON ENTRY:                                                             00160000
*                                                                       00170000
*    R1 Contains the address of the parameter list mapped by            00180000
*    the SRVPL dsect generated by $SERVER DSECT=YES.                    00190000
*                                                                       00200000
* ON EXIT:                                                              00210000
*                                                                       00220000
*    R15 Contains one of the following return codes:                    00230000
*                                                                       00240000
*        RC00 - Normal completion                                       00250000
*                                                                       00260000
* MODE:                                                                 00270000
*                                                                       00280000
*    TASK                                                               00290000
*    APF/NON-APF                                                        00300000
*    SUP/PROB                                                           00310000
*    AMODE 31, RMODE ANY                                                00320000
*                                                                       00330000
**<DOC-OFF>*****************************************************        00340000
                                                                        00350000
         EJECT ,                                                        00360000
****************************************************************        00370000
*                                                                       00380000
* MAINTENANCE:                                                          00390000
*                                                                       00400000
*   01/06/95 Ron Colmone          Par# 159456                           00410000
*            Initial Version                                            00420000
*                                                                       00430000
****************************************************************        00440000
                                                                        00450000
         EJECT ,                                                        00460000
         $SERVER DSECT=YES        SERVER TASK MANAGER PLIST             00470000
                                                                        00480000
         EJECT ,                                                        00490000
         $TASK   DSECT=YES        TASKMGR PLIST                         00500000
                                                                        00510000
         EJECT ,                                                        00520000
         EQUS  ,                  GENERAL EQUATES                       00530000
                                                                        00540000
         EJECT ,                                                        00550000
         #WORK LENGTH=512         READ/WRITE WORKAREA                   00560000
TERMEPB  DS    A                  ADDRESS OF SERVER TERM EPB            00570000
                                                                        00580000
$TSK_MFL $TASK MF=(L,*)           $TASK PLIST CONSTRUCTION AREA         00590000
         #ENDWORK                 END OF WORKAREA                       00600000
                                                                        00610000
         EJECT ,                                                        00620000
ISRVSTOP #ENTER BASE=R12,         ENTRY LINKAGE                        +00630000
               PREG=R8,                                                +00640000
               WAPASS=YES                                               00650000
                                                                        00660000
         USING SRVPL,R8           ESTABLISH ADDRESSABILITY              00670000
         USING ITASK,R10          ESTABLISH ADDRESSABILITY              00680000
                                                                        00690000
         EJECT ,                                                        00700000
****************************************************************        00710000
*                                                                       00720000
*  Stop Server Task(s)                                                  00730000
*                                                                       00740000
****************************************************************        00750000
                                                                        00760000
         EJECT ,                                                        00770000
*---------------------------------------------------------------        00780000
*  If Server extension block address supplied,  then continue           00790000
*  with server task halt notification.  If a server is not              00800000
*  specified,  then delete all server created by this ITASK.            00810000
*---------------------------------------------------------------        00820000
         ICM   R6,15,SVPLSRV@     SERVER ADDRESS SUPPLIED               00830000
         BNZ   SRV_POST           YES, POST SERVER HALT EPB             00840000
         USING SERVERX,R6         ADDRESSABILITY                        00850000
                                                                        00860000
SRV_NEXT DS    0H                                                       00870000
         ICM   R6,15,TSKSRVQ      ADDRESS OF SERVER QUEUE               00880000
         BZ    STOP_RET           TERMINATION COMPLETION                00890000
                                                                        00900000
*---------------------------------------------------------------        00910000
*  Post server task halt EPB                                            00920000
*---------------------------------------------------------------        00930000
SRV_POST DS    0H                                                       00940000
         MVC   TERMEPB,SRVTEPB@   ADDRESS OF TERM EPB                   00950000
                                                                        00960000
         $TASK POST,EPB=SRVZEPB,PCODE=0,MF=(E,$TSK_MFL)                 00970000
                                                                        00980000
*---------------------------------------------------------------        00990000
*  Wait for completion of server task                                   01000000
*---------------------------------------------------------------        01010000
SRV_WAIT DS    0H                                                       01020000
         $TASK WAIT,MF=(E,$TSK_MFL)  WAIT FOR TASK TO COMPLETE          01030000
         C     R1,TERMEPB         TERM EPB POSTED?                      01040000
         BNE   SRV_WAIT           NO, WAIT AGAIN                        01050000
                                                                        01060000
         $RETSTOR *TERMEPB,OWNER=ITASK                                  01070000
                                                                        01080000
         ICM   R0,15,SVPLSRV@     ADDRESS OF SERVER SUPPLIED            01090000
         BZ    SRV_NEXT           STOP NEXT SERVER TASK                 01100000
                                                                        01110000
STOP_RET DS    0H                                                       01120000
         LA    R15,RC00           NORMAL COMPLETION                     01130000
         LA    R0,RSN00           NORMAL COMPLETION                     01140000
         B     RETURN             RETURN                                01150000
                                                                        01160000
         EJECT ,                                                        01170000
****************************************************************        01180000
*                                                                       01190000
*   RETURN                                                              01200000
*                                                                       01210000
****************************************************************        01220000
                                                                        01230000
RETURN   DS    0H                                                       01240000
         #EXIT ,                  RETURN                                01250000
                                                                        01260000
         EJECT ,                                                        01270000
****************************************************************        01280000
*                                                                       01290000
*  CONSTANTS AND LITERALS                                               01300000
*                                                                       01310000
****************************************************************        01320000
                                                                        01330000
         LTORG ,                                                        01340000
                                                                        01350000
         PRINT NOGEN                                                    01360000
         ICVT  ,                                                        01370000
         ITASK ,                                                        01380000
         SERVERX ,                                                      01390000
                                                                        01400000
         END   ,                                                        01410000

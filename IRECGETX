IRECGETX TITLE '- GET SCREEN / TRANSITION TRANSACTION'                  00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: IRECGETX - GET SCREEN / TRANSITION TRANSACTION               00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THIS TRANSACTION IS USED TO RETURN SYSIMAGE AND SYSSKS             00080000
*    INFORMATION FROM A PRE-RECORDED SESSION.  THE ENTRIES              00090000
*    IN BOTH TABLES ARE SPECFIED BY ROWID.  THE INFORMATION             00100000
*    RETURNED ALLOWS THE REQUESTOR TO EXAMINE A 3270 IMAGE              00110000
*    AND THE OPERATOR ACTIVITY THAT CAUSES TRANSITION TO THE            00120000
*    NEXT IMAGE.                                                        00130000
*                                                                       00140000
*                                                                       00150000
* ON ENTRY:                                                             00160000
*                                                                       00170000
*    R1 CONTAINS THE ADDRESS OF A TRANSACTION FORMAT PARAMETER          00180000
*       LIST MAPPED BY XSMSGET.                                         00190000
*                                                                       00200000
* ON EXIT:                                                              00210000
*                                                                       00220000
*    A RESPONSE BUFFER DESCRIBED BY YSMSGET IS CONSTRUCTED,             00230000
*    TANSMITTED, AND RELEASED.                                          00240000
*                                                                       00250000
**<DOC-OFF>****************************************************         00260000
                                                                        00270000
         EJECT                                                          00280000
***************************************************************         00290000
*                                                                       00300000
* MAINTENANCE:                                                          00310000
*                                                                       00320000
*   12/06/94 R. Turgeon                                                 00330000
*            Removed PAGE= / SHRPAGE= for $SPACE, $OBJECT,              00340000
*            and TB* service requests                                   00350000
*                                                                       00360000
***************************************************************         00370000
                                                                        00380000
         EJECT                                                          00390000
         #WORK ,                                                        00400000
                                                                        00410000
FLAGS    DS    X                 FLAG BYTE                              00420000
FIMAGE   EQU   X'80'                SYSIMAGE ACQUIRED                   00430000
FSKS     EQU   X'40'                SYSSKS   ACQUIRED                   00440000
                                                                        00450000
TOTLEN   DS    F                 VARIABLE LENGTH RESPONSE TOTAL SIZE    00460000
                                                                        00470000
IMAGEBFR DS    0A,0F             SYSIMAGE ROW BUFFER DESCRIPTOR         00480000
IMAGEP   DS    A                    ADDR OF SYSIMAGE BUFFER             00490000
IMAGELN  DS    F                    LENG OF SYSIMAGE BUFFER             00500000
                                                                        00510000
SKSBFR   DS    0A,0F             SYSSKS ROW BUFFER DESCRIPTOR           00520000
SKSP     DS    A                    ADDR OF SYSSKS BUFFER               00530000
SKSLN    DS    F                    LENG OF SYSSKS BUFFER               00540000
                                                                        00550000
WK256    DS    XL256              GENERAL PURPOSE WORKAREA              00560000
RETIMAG  DS    XL512              INITIAL SCREEN RETURN AREA            00570000
RETSKS   DS    XL128              INITIAL SKS RETURN AREA               00580000
                                                                        00590000
         YSMSGET TYPE=BLOCK       DIRECTLY ADDRESSABLE RESPONSE BLOCK   00600000
                                                                        00610000
         #ENDWORK ,                                                     00620000
                                                                        00630000
         EJECT                                                          00640000
         XSMSGET ,                REQUEST FORMAT                        00650000
                                                                        00660000
         EJECT                                                          00670000
         ICATALOG IMAGE,SKS       TABLE FORMATS                         00680000
                                                                        00690000
         EJECT                                                          00700000
         TBSERVIS GET,PRINT=NOGEN                                       00710000
                                                                        00720000
         EJECT                                                          00730000
         ABCODES ,                                                      00740000
                                                                        00750000
         EQUS  ,                                                        00760000
                                                                        00770000
         EJECT ,                                                        00780000
IRECGETX #ENTER PREG=R8                                                 00790000
                                                                        00800000
         USING ITASK,R10          PROCESS MODE                          00810000
         L     R9,TSKPCBC                                               00820000
         USING IPCB,R9                                                  00830000
         L     R7,PCBUSER         CURRENT USER                          00840000
         USING IUSER,R7           TEMP ADDRESSABILITY                   00850000
         L     R7,USRPROJ         LOCATE CURRENT PROJECT                00860000
         USING IPROJ,R7           LIFE OF FUNCTION                      00870000
                                                                        00880000
         USING XSMSGET,R8         GET SCREEN / TRANSITION REQUEST       00890000
                                                                        00900000
         EJECT                                                          00910000
***************************************************************         00920000
*                                                                       00930000
*   RETRIEVE DESIGNATED SYSIMAGE ENTRY IF SELECTED                      00940000
*                                                                       00950000
***************************************************************         00960000
         ICM   R2,15,XGSIMAGE     SYSIMAGE KEY                          00970000
         BZ    IMG_FIN            DONE                                  00980000
                                                                        00990000
         LA    R0,RETIMAG         LOCAL BUFFER FOR SYSIMAGE RETRIEVAL   01000000
         O     R0,=X'80000000'    INDICATE LOCALLY MANAGED STORAGE      01010000
         ST    R0,IMAGEP          PTR IN BUFFER STRUCTURE               01020000
         LA    R0,L'RETIMAG       LENGTH OF BUFFER                      01030000
         ST    R0,IMAGELN         POST IN BUFFER STRUCTURE              01040000
                                                                        01050000
IMG_GET  DS    0H                                                       01060000
         TBGET *IMAGEP,           ACQUIRE DESIGNATED SYSIMAGE          X01070000
               LENGTH=*IMAGELN,                                        X01080000
               POS=(R2),                                               X01090000
               TTOKEN=PRJTKIMG,                                        X01100000
               MF=(E,WK256)                                             01110000
                                                                        01120000
         ST    R15,YGSIMGRC       RETAIN DIAGNOSTIC RETCODE             01130000
         ST    R0,YGSIMGRS        RETAIN DIAGNOSTIC RSNCODE             01140000
                                                                        01150000
*--------------------------------------------------------------         01160000
*   ANALYZE COMPLETION STATUS, RETRY IF NECESSARY                       01170000
*--------------------------------------------------------------         01180000
         CH    R15,=AL2(RC04)     TEST COMPLETION STATUS                01190000
         BL    IMG_ACQ            ENTRY ACQUIRED                        01200000
         BH    IMG_NF             REQUEST FAILS                         01210000
                                                                        01220000
         $REALLOC IMAGEBFR,*YGSIMGRS,                                  X01230000
               MF=(E,MFE_LIST)    TBGET REASON CODE IS REQ BUFFER LEN   01240000
         B     IMG_GET            RETRY                                 01250000
                                                                        01260000
IMG_NF   DS    0H                 REQUEST FAILS, POTENTIALLY NOT FOUND  01270000
         CH    R15,=AL2(RC12)     TABLE SERVICES LOGICAL ERROR?         01280000
         BNE   ABE_TBSV           FAIL IF NOT                           01290000
         CH    R0,=AL2(RSN12)     ROW NOT FOUND?                        01300000
         BNE   ABE_TBSV           FAIL IF NOT                           01310000
                                                                        01320000
         MVC   YGSRETC,=A(RC04)   NO SUCH IMAGE                         01330000
         MVC   YGSSRVRC,YGSIMGRC                                        01340000
         MVC   YGSSRVRS,YGSIMGRS                                        01350000
         B     IMG_FIN                                                  01360000
                                                                        01370000
*--------------------------------------------------------------         01380000
*   ROLL SYSIMAGE DATA LENGTH INTO TOTAL RESPONSE RQMT                  01390000
*--------------------------------------------------------------         01400000
IMG_ACQ  DS    0H                                                       01410000
         OI    FLAGS,FIMAGE       ENTRY ACQUIRED                        01420000
                                                                        01430000
         L     R6,IMAGEP          SYSIMAGE ORIGIN                       01440000
         USING SYSIMAGE,R6        SHORT TERM ADDRESSABILITY             01450000
         ICM   R1,15,SIMGBUFR+0   VARX SCREEN LENGTH                    01460000
         BNZ   *+8                ASSERT ENTRY VALIDITY                 01470000
         EX    R0,*               DENIED                                01480000
                                                                        01490000
         LA    R1,3(,R1)          ROUND TO FWORD                        01500000
         SRL   R1,2                                                     01510000
         SLL   R1,2                                                     01520000
         AL    R1,TOTLEN                                                01530000
         ST    R1,TOTLEN                                                01540000
         DROP  R6                 SYSIMAGE                              01550000
                                                                        01560000
IMG_FIN  DS    0H                                                       01570000
                                                                        01580000
         EJECT                                                          01590000
***************************************************************         01600000
*                                                                       01610000
*   RETRIEVE DESIGNATED SYSSKS ENTRY IF SELECTED                        01620000
*                                                                       01630000
***************************************************************         01640000
         ICM   R2,15,XGSSKS       SKS KEY                               01650000
         BZ    SKS_FIN            DONE                                  01660000
                                                                        01670000
         LA    R0,RETSKS          LOCAL BUFFER FOR SYSSKS RETRIEVAL     01680000
         O     R0,=X'80000000'    INDICATE LOCALLY MANAGED STORAGE      01690000
         ST    R0,SKSP            PTR IN BUFFER STRUCTURE               01700000
         LA    R0,L'RETSKS        LENGTH OF BUFFER                      01710000
         ST    R0,SKSLN           POST IN BUFFER STRUCTURE              01720000
                                                                        01730000
SKS_GET  DS    0H                                                       01740000
         TBGET *SKSP,             ACQUIRE DESIGNATED SYSSKS            X01750000
               LENGTH=*SKSLN,                                          X01760000
               POS=(R2),                                               X01770000
               TTOKEN=PRJTKSKS,                                        X01780000
               MF=(E,WK256)                                             01790000
                                                                        01800000
         ST    R15,YGSSKSRC       RETAIN DIAGNOSTIC RETCODE             01810000
         ST    R0,YGSSKSRS        RETAIN DIAGNOSTIC RSNCODE             01820000
                                                                        01830000
*--------------------------------------------------------------         01840000
*   ANALYZE COMPLETION STATUS, RETRY IF NECESSARY                       01850000
*--------------------------------------------------------------         01860000
         CH    R15,=AL2(RC04)     TEST COMPLETION STATUS                01870000
         BL    SKS_ACQ            ENTRY ACQUIRED                        01880000
         BH    SKS_NF             REQUEST FAILS                         01890000
                                                                        01900000
         $REALLOC SKSBFR,*YGSSKSRS,                                    X01910000
               MF=(E,MFE_LIST)    TBGET REASON CODE IS REQ BUFFER LEN   01920000
         B     SKS_GET            RETRY                                 01930000
                                                                        01940000
SKS_NF   DS    0H                 REQUEST FAILS, POTENTIALLY NOT FOUND  01950000
         CH    R15,=AL2(RC12)     TABLE SERVICES LOGICAL ERROR?         01960000
         BNE   ABE_TBSV           FAIL IF NOT                           01970000
         CH    R0,=AL2(RSN12)     ROW NOT FOUND?                        01980000
         BNE   ABE_TBSV           FAIL IF NOT                           01990000
                                                                        02000000
         MVC   YGSRETC,=A(RC04)   NO SUCH IMAGE                         02010000
         MVC   YGSSRVRC,YGSIMGRC                                        02020000
         MVC   YGSSRVRS,YGSIMGRS                                        02030000
         B     SKS_FIN                                                  02040000
                                                                        02050000
SKS_ACQ  DS    0H                                                       02060000
         OI    FLAGS,FSKS         ENTRY ACQUIRED                        02070000
                                                                        02080000
         L     R6,SKSP            SYSSKS ORIGIN                         02090000
         USING SYSSKS,R6          SHORT TERM ADDRESSABILITY             02100000
         ICM   R1,15,SSKSCRPT+0   VARX SCRIPT LENGTH                    02110000
         BNZ   *+8                ASSERT ENTRY VALIDITY                 02120000
         EX    R0,*               DENIED                                02130000
                                                                        02140000
         LA    R1,3(,R1)          ROUND TO FWORD                        02150000
         SRL   R1,2                                                     02160000
         SLL   R1,2                                                     02170000
         AL    R1,TOTLEN                                                02180000
         ST    R1,TOTLEN                                                02190000
         DROP  R6                 SYSSKS                                02200000
                                                                        02210000
SKS_FIN  DS    0H                                                       02220000
                                                                        02230000
         EJECT                                                          02240000
***************************************************************         02250000
*                                                                       02260000
*   CONSTRUCT RESPONSE BLOCK FROM ACQUIRED DATA                         02270000
*                                                                       02280000
***************************************************************         02290000
         LA    R2,YSMSGETL        RESPONSE BLOCK                        02300000
         AL    R2,TOTLEN          PLUS VARIABLE LENGTH EXTENSIONS       02310000
                                                                        02320000
         $XPBUFR INIT,SIZE=(R2),XH=XSMSGET                              02330000
         BNZ   ABE_TXP                                                  02340000
                                                                        02350000
         $XPBUFR ISRT,DATALEN=YSMSGETL,NEWFUNC=(*XGSFUNC,*XGSSFNC)      02360000
         BNZ   ABE_TXP                                                  02370000
                                                                        02380000
         LR    R5,R1              RESPONSE BLOCK ADDR                   02390000
         USING YSMSGET,R5         LIFE OF FUNCTION ADDRESSBILITY        02400000
         XC    YSMSGET(YSMSGETL),YSMSGET                                02410000
                                                                        02420000
*--------------------------------------------------------------         02430000
*   RETURN SYSIMAGE INFORMATION                                         02440000
*--------------------------------------------------------------         02450000
         TM    FLAGS,FIMAGE       SYSIMAGE ACQUIRED FOR RETURN?         02460000
         BNO   NOIMAGE                                                  02470000
                                                                        02480000
         L     R6,IMAGEP          SYSIMAGE RECORD                       02490000
         USING SYSIMAGE,R6                                              02500000
         MVC   YGSIMGKY,XGSIMAGE  REFLECT SYSIMAGE KEY                  02510000
         MVC   YGSIMGSQ,SIMGSQSH  SQUISHED / UNSQUISHED INDICATOR       02520000
                                                                        02530000
         L     R1,SIMGROWS        RETURN # ROWS                         02540000
         STH   R1,YGSIMROW                                              02550000
         L     R2,SIMGCOLS        RETURN # COLS                         02560000
         STH   R2,YGSIMCOL                                              02570000
         MR    R0,R2              COMPUTE TOTAL SIZE                    02580000
         ST    R1,YGSIMSIZ        AND RETURN IT                         02590000
                                                                        02600000
         L     R2,SIMGBUFR+0      LENGTH OF IMAGE                       02610000
         STH   R2,YGSIMGLN        RETURNED                              02620000
                                                                        02630000
         $XPBUFR ISRT,DATA=*SIMGBUFR+4,DATALEN=(R2)                     02640000
         BNZ   ABE_TXP                                                  02650000
                                                                        02660000
         SR    R1,R5              OFFSET TO SCREEN                      02670000
         ST    R1,YGSIMG          RETAIN FOR REMOTE ACCESS              02680000
                                                                        02690000
NOIMAGE  DS    0H                                                       02700000
         DROP  R6                 SYSIMAGE                              02710000
                                                                        02720000
*--------------------------------------------------------------         02730000
*   RETURN SYSSKS INFORMATION                                           02740000
*--------------------------------------------------------------         02750000
         TM    FLAGS,FSKS         SYSSKS ACQUIRED FOR RETURN?           02760000
         BNO   NOSKS                                                    02770000
                                                                        02780000
         L     R6,SKSP            SYSSKS RECORD                         02790000
         USING SYSSKS,R6                                                02800000
         MVC   YGSSKSKY,XGSSKS    REFLECT SYSSKS KEY                    02810000
         MVI   YGSSKSSQ,0         NOT CURRENTLY COMPRESSED              02820000
         L     R2,SSKSCRPT+0      LENGTH OF SCRIPT                      02830000
         STH   R2,YGSSKSLN        RETURNED                              02840000
                                                                        02850000
         $XPBUFR ISRT,DATA=*SSKSCRPT+4,DATALEN=(R2)                     02860000
         BNZ   ABE_TXP                                                  02870000
                                                                        02880000
         SR    R1,R5              OFFSET TO SCRIPT                      02890000
         ST    R1,YGSSKS          RETAIN FOR REMOTE ACCESS              02900000
                                                                        02910000
NOSKS    DS    0H                                                       02920000
         DROP  R6                 SYSSKS                                02930000
                                                                        02940000
*--------------------------------------------------------------         02950000
*   TRANSMIT RESPONSE                                                   02960000
*--------------------------------------------------------------         02970000
         $XPBUFR XMIT             TRANSMIT AND FREE                     02980000
         BNZ   ABE_TXP                                                  02990000
                                                                        03000000
         EJECT                                                          03010000
***************************************************************         03020000
*                                                                       03030000
*   RETURN TO REQUEST SCHEDULER                                         03040000
*                                                                       03050000
***************************************************************         03060000
         LA    R15,RC00           NORMAL COMPLETION                     03070000
         #EXIT ,                                                        03080000
                                                                        03090000
         EJECT                                                          03100000
***************************************************************         03110000
*                                                                       03120000
* CATASTROPIC ERRORS                                                    03130000
*                                                                       03140000
***************************************************************         03150000
ABE_TBSV DS    0H                                                       03160000
         $ABEND ABE_TBSERV,DUMP=YES,                                   X03170000
               TITLE='TABLE SERVICE FAILURE'                            03180000
                                                                        03190000
ABE_TXP  DS    0H                                                       03200000
         $ABEND ABE_TXPSERV,DUMP=YES,                                  X03210000
               TITLE='TXP BUFFER SERVICE FAILURE'                       03220000
                                                                        03230000
         EJECT ,                                                        03240000
***************************************************************         03250000
*                                                                       03260000
*   LOCAL READ ONLY DATA AREAS, ETC.                                    03270000
*                                                                       03280000
***************************************************************         03290000
         LTORG ,                                                        03300000
                                                                        03310000
         EJECT                                                          03320000
         PRINT NOGEN                                                    03330000
         ICVT  ,                                                        03340000
         ITASK ,                                                        03350000
         IPCB  ,                                                        03360000
         IUSER ,                                                        03370000
         IPROJ ,                                                        03380000
         END   ,                                                        03390000

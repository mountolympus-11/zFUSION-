ITSKEPLG TITLE '- TASK EPILOG ROUTINE'                                  00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: ITSKEPLG - Task EPILOG Routine                               00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine receives control after all processes                  00080000
*    associated with a task are deleted or when the task                00090000
*    abnormally terminates while in task mode or $ABEND with            00100000
*    SCOPE=ITASK specified.  In the cases where this routine            00110000
*    runs and PCBs are still active,  all PCBs within the task          00120000
*    are scheduled to be drained (i.e. resource managers and            00130000
*    recovery routines are processed).                                  00140000
*                                                                       00150000
*    During termination processing,  all locks associated with          00160000
*    workunits in this task are released.  All XEPBs associated         00170000
*    with the terminated task are processed appropriatly.  Some         00180000
*    task related resources are release, suchas the events              00190000
*    table and SASC framework for the ITASK.  All other                 00200000
*    resources associated with the ITASK are released when the          00210000
*    Async EPB exit routine runs,  which deletes the ITASK and          00220000
*    associated control areas.  This processing occurs under            00230000
*    the parent task.                                                   00240000
*                                                                       00250000
*                                                                       00260000
* ON ENTRY:  N/A                                                        00270000
*                                                                       00280000
* ON EXIT:   N/A                                                        00290000
*                                                                       00300000
* MODE:                                                                 00310000
*                                                                       00320000
*    TASK                                                               00330000
*    APF/NON-APF                                                        00340000
*    SUP/PROB                                                           00350000
*    AMODE 31, RMODE ANY                                                00360000
*                                                                       00370000
**<DOC-OFF>****************************************************         00380000
                                                                        00390000
         EJECT ,                                                        00400000
***************************************************************         00410000
*                                                                       00420000
* MAINTENANCE:                                                          00430000
*                                                                       00440000
*   04/22/93 Ron Colmone                                                00450000
*            Initial Version                                            00460000
*                                                                       00470000
*   01/03/95 Ron Colmone          Par# 159456                           00480000
*            Added support for task manager server                      00490000
*                                                                       00500000
***************************************************************         00510000
                                                                        00520000
         EJECT ,                                                        00530000
         $TASK   DSECT=YES        TASK MANAGER PLIST                    00540000
         EJECT ,                                                        00550000
         $PROC   DSECT=YES        PROCESS MANAGER PLIST                 00560000
         EJECT ,                                                        00570000
         $WUSTAT DSECT=YES        WORKUNIT STATUS PLIST                 00580000
         EJECT ,                                                        00590000
         $RESMGR DSECT=YES        RESOURCE MANAGER PLIST                00600000
         EJECT ,                                                        00610000
         @EPB  ,                  EVENT PROCESS BLOCK MAPPING           00620000
         EJECT ,                                                        00630000
         EVCODES ,                EVENT COMPLETION CODES                00640000
         EJECT ,                                                        00650000
         TRACODES ,               TRACE EVENT CODES                     00660000
         EJECT ,                                                        00670000
         EQUS  ,                  GENERAL EQUATES                       00680000
                                                                        00690000
         $MSGDFT PREFIX=ICTPID,COMPID='TSK',TABLE=*#MSGS,              +00700000
               PRINT=NOGEN,MF=(E,WRK256)                                00710000
                                                                        00720000
         EJECT ,                                                        00730000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00740000
WRK256   DS    XL256              GENERAL WORKAREA                      00750000
$TASKMFL $TASK   MF=(L,*)         $TASK PARAMETER LIST AREA             00760000
$PROCMFL $PROC   MF=(L,*)         $PROC PARAMETER LIST AREA             00770000
$WST_MFL $WUSTAT MF=(L,*)         WORKUNIT STATIS PLIAST AREA           00780000
WRKPASS  DS    XL1024             WORKAREA TO PASS                      00790000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00800000
                                                                        00810000
         EJECT ,                                                        00820000
ITSKEPLG #ENTER BASE=R12          ENTRY LINKAGE                         00830000
                                                                        00840000
         USING ITASK,R10          ADDRESSABILITY                        00850000
                                                                        00860000
         EJECT ,                                                        00870000
*--------------------------------------------------------------         00880000
* TRACE TASK EPILOG EVENT                                               00890000
*--------------------------------------------------------------         00900000
         $TRACE TRC_TASKEPLG,L'TSKNAME                                  00910000
         BNZ   EPB_FLSH           EVENT NOT ACTIVE                      00920000
         MVC   0(L'TSKNAME,R1),TSKNAME                                  00930000
                                                                        00940000
*--------------------------------------------------------------         00950000
* TASK EPILOG - MARK TASK RELEATED EPB'S AS FLUSHED                     00960000
*--------------------------------------------------------------         00970000
EPB_FLSH DS    0H                                                       00980000
         $SER  OBTAIN,DISP        OBTAIN DISPATCHER LOCK                00990000
                                                                        01000000
         $WUSTAT TERM,WU=(R10),WKA=WRK256,MF=(E,$WST_MFL)               01010000
                                                                        01020000
         OI    TSKFLGS,TSK$TERM   INDICATE TASK TERMINATED              01030000
         USING EPB,R1             ADDRESSABILITY                        01040000
                                                                        01050000
         LA    R1,TSKDEPB         DISPATCH EPB                          01060000
         OI    EPBFLGS,EPB$FLSH   INVALIDATE EPB                        01070000
                                                                        01080000
         LA    R1,TSKZEPB         DISPATCH EPB                          01090000
         OI    EPBFLGS,EPB$FLSH   INVALIDATE EPB                        01100000
                                                                        01110000
         LA    R1,TSKMEPB         DISPATCH EPB                          01120000
         OI    EPBFLGS,EPB$FLSH   INVALIDATE EPB                        01130000
         DROP  R1                 EPB                                   01140000
                                                                        01150000
         EJECT ,                                                        01160000
*--------------------------------------------------------------         01170000
*  RELEASE ALL LOCKS HELD BY SUBORDINATE PROCESSES AND TASKMGR          01180000
*--------------------------------------------------------------         01190000
         L     R2,TSKPCBC         RETAIN PCB IF ABEND SCOPE=TASK        01200000
         ICM   R3,15,TSKPCB       ADDR OF REMAINING PCB                 01210000
         BZ    TSK_RELK           NONE, REL TASK ASSOCAITED LOCKS       01220000
         USING IPCB,R3            PCB ADDRESSABILITY                    01230000
                                                                        01240000
PCB_RELK DS    0H                                                       01250000
         L     R5,PCBNEXT         ADDRESS OF NEXT PCB                   01260000
         ST    R3,TSKPCBC         SIMULATE STD ENVIRONMENT              01270000
                                                                        01280000
         TM    PCBFLGS2,PCB2$TRM  PCB ALREADY TERMINATING?              01290000
         BO    *+8                YES, NO NEED TO SIGNAL                01300000
         OI    PCBFLGS2,PCB2$DRN  MARK BE TO BE DRAINED                 01310000
                                                                        01320000
         @CALL ITSKDPNQ,(TSKDISPQ,IPCB),CTYPE=CVT,               159456+01330000
               MF=(E,MFE_LIST)                                   159456 01340000
                                                                        01350000
         SR    R1,R1              RELEASE LOCKS OWNED BY WORKUNIT       01360000
         @CALL ISERFREE,CTYPE=CVT,WKA=WRK256                            01370000
         LTR   R3,R5              ADDRESS OF NEXT PCB                   01380000
         BNZ   PCB_RELK           RELEASE ANY HELD LOCKS                01390000
                                                                        01400000
TSK_RELK DS    0H                                                       01410000
         XC    TSKPCBC,TSKPCBC    RUNNING TASKMGR MODE                  01420000
         SR    R1,R1              RELEASE LOCKS OWNED BY WORKUNIT       01430000
         @CALL ISERFREE,CTYPE=CVT,WKA=WRK256                            01440000
         ST    R2,TSKPCBC         RESTORE PCB IF ABEND SCOPE=TASK       01450000
                                                                        01460000
         EJECT ,                                                        01470000
*--------------------------------------------------------------         01480000
*  IF PCBS STILL REMAINING, RELEASE SAVE AREA AND REENTER               01490000
*  DISPATCHER TO ALLOW PCBS TO DRAIN.                                   01500000
*--------------------------------------------------------------         01510000
         ICM   R0,15,TSKPCB       ANY PCBS LEFT ACTIVE?                 01520000
         BZ    TSK_RMGR           NO,  CALL ITASK RES MANAGER RTNS      01530000
         TM    TSKFLGS2,TSK2$DRN  ITASK ALREADY IN DRAIN MODE           01540000
         BO    PROC_DEL           YES,  JUST DELETE THEN                01550000
         OI    TSKFLGS2,TSK2$DRN  SET TASK IN DRAIN MODE                01560000
                                                                        01570000
         $RETSTOR (R13)                                                 01580000
         LA    R13,TSKDSPSA       USE DISPATCHER SAVEAREA               01590000
                                                                        01600000
         $TASK CALLDSP,           REDRIVE TASK DISPATCHER              +01610000
               WORKA=*TSK@WRKA,                                        +01620000
               MF=(E,TSKT_MFL)                                          01630000
                                                                        01640000
*--------------------------------------------------------------         01650000
*  ISSUE $PROC DELETE FOR ALL EXISTING PROCESSES                        01660000
*--------------------------------------------------------------         01670000
PROC_DEL DS    0H                                                       01680000
         ICM   R3,15,TSKPCB       PCB ON COMPLETED TASK DSPQ            01690000
         BZ    EVNT_DEL           NO, DELETE EVENTS TABLE               01700000
                                                                        01710000
         $PROC DELETE,            REMOVE TERMINATED PROCESS            +01720000
               PCB=(R3),                                               +01730000
               TASK=ITASK,                                             +01740000
               MF=(E,$PROCMFL)                                          01750000
                                                                        01760000
         B     PROC_DEL           ANY MORE PROCESSES?                   01770000
                                                                        01780000
         EJECT ,                                                        01790000
*--------------------------------------------------------------         01800000
*  CALL TASK RESOURCE MANAGER EXIT ROUTINES                             01810000
*--------------------------------------------------------------         01820000
TSK_RMGR DS    0H                                                       01830000
         $RESMGR CALL,OWNER=ITASK,MF=(E,MFE_LIST)                       01840000
                                                                        01850000
         EJECT ,                                                        01860000
*--------------------------------------------------------------         01870000
* DELETE EVENTS TABLE                                                   01880000
*--------------------------------------------------------------         01890000
EVNT_DEL DS    0H                                                       01900000
         $TASK EVDEL,             DELETE EVENTS TABLE FOR TASK         +01910000
               MF=(E,$TASKMFL)                                          01920000
                                                                        01930000
*--------------------------------------------------------------         01940000
* DELETE RECOVERY ENVIRONMENT                                           01950000
*--------------------------------------------------------------         01960000
         OI    TSKFLGS,TSK$NDSP   ITASK NO LONGER DISPATCHABLE   159456 01970000
         TM    TSKFLGS3,TSK3$AFF  TCB AFFINITY?                  159456 01980000
         BZ    EPLG_RET           NO, RETURN                     159456 01990000
         TM    ICTSTAT2,ICT2$RCV  RECOVERY ENABLED?                     02000000
         BZ    EPLG_RET           NO, RETURN                            02010000
                                                                        02020000
         ESTAEX 0                 DELETE RECOVERY ENVIRONMENT           02030000
                                                                        02040000
EPLG_RET DS    0H                                                       02050000
         LA    R15,RC00           NORMAL COMPLETION                     02060000
         B     RETURN             RETURN                                02070000
                                                                        02080000
         EJECT ,                                                        02090000
***************************************************************         02100000
*                                                                       02110000
*   RETURN                                                              02120000
*                                                                       02130000
***************************************************************         02140000
RETURN   DS    0H                                                       02150000
         #EXIT ,                  RETURN                                02160000
                                                                        02170000
         EJECT ,                                                        02180000
***************************************************************         02190000
*                                                                       02200000
*  CONSTANTS AND LITERALS                                               02210000
*                                                                       02220000
***************************************************************         02230000
                                                                        02240000
         LTORG ,                                                        02250000
                                                                        02260000
         PRINT NOGEN                                                    02270000
         ICVT  ,                                                        02280000
         ITASK ,                                                        02290000
         IPCB  ,                                                        02300000
                                                                        02310000
         IHAPSA ,                                                       02320000
         CVT   DSECT=YES,LIST=NO                                        02330000
         IKJTCB ,                                                       02340000
         PRINT GEN                                                      02350000
                                                                        02360000
         END   ,                                                        02370000

IVTMXTPN TITLE 'INTEGRATOR - VTAM TPEND EXIT'                           00010000
**<DOC-ON>************************************************************* 00020000
*                                                                       00030000
* ROUTINE: IVTMXTPN - INTEGRATOR VTAM TPEND EXIT                        00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THE TPEND EXIT IS DRIVEN BY VTAM WHEN:                             00080000
*       - THE VTAM OPERATOR ISSUES A HALT COMMAND                       00090000
*       - VTAM HALTS ITSELF IN AN ORDERLY FASHION DUE TO ERROR          00100000
*       - VTAM ABENDS                                                   00110000
*       - VARY NET INACT IS ISSUED FOR AN APPL (I.E. ACB)               00120000
*                                                                       00130000
*    A TPEND WORK ELEMENT IS CREATED AND QUEUED TO THE VTAM MAIN        00140000
*    TASK WORK QUEUE FOR PROCESSING.                                    00150000
*                                                                       00160000
* ON ENTRY:                                                             00170000
*                                                                       00180000
*    BAKR IS USED TO SAVE REGISTERS.                                    00190000
*                                                                       00200000
*    R15 = ENTRY POINT ADDRESS                                          00210000
*    R14 = RETURN ADDRESS                                               00220000
*    R01 = PARAMETER LIST ADDRESS                                       00230000
*          +00(4): ADDRESS OF ACB BEING SHUTDOWN                        00240000
*          +04(4): REASON CODE FOR THE SHUTDOWN                         00250000
*                  0  = HALT COMMAND                                    00260000
*                  4  = HALT QUICK                                      00270000
*                       VTAM INTERNALLY HALTING ITSELF                  00280000
*                       VARY INACT FOR APPL                             00290000
*                  8  = HALT CANCEL                                     00300000
*                       VTAM ABNORMAL TERMINATION                       00310000
*                  12 = ALTERNATE ACB OPENED (PERS. SESS.)              00320000
*          +08(4): RESERVED (UNUSED)                                    00330000
*          +0C(4): RESERVED (UNUSED)                                    00340000
*          +10(4): RESERVED (UNUSED)                                    00350000
*          +14(4): RESERVED (UNUSED)                                    00360000
*                                                                       00370000
* ON EXIT:                                                              00380000
*                                                                       00390000
*    R15 = 0                                                            00400000
*    R00 = 0                                                            00410000
*    R01 = 0                                                            00420000
*                                                                       00430000
*    ALL OTHER REGISTERS ARE RESTORED BY PR.                            00440000
*                                                                       00450000
**<DOC-OFF>************************************************************ 00460000
                                                                        00470000
         EJECT ,                                                        00480000
*********************************************************************** 00490000
*                                                                       00500000
* MAINTENANCE:                                                          00510000
*                                                                       00520000
*   08/01/93 RANDY WITEK                                                00530000
*                                                                       00540000
*********************************************************************** 00550000
         EQUS  ,                  GENERAL EQUATES                       00560000
                                                                        00570000
RICVT    EQU   R11                INTEGRATOR CVT POINTER                00580000
RITASK   EQU   R10                ASSOCIATED ITASK POINTER              00590000
RIVTAM   EQU   R9                 INTEGRATOR VTAM CVT POINTER           00600000
RIACB    EQU   R8                 ASSOCIATED IACB POINTER               00610000
RIRPL    EQU   R7                 ASSOCIATED RPL/IRPL POINTER           00620000
RISESS   EQU   R6                 ASSOCIATED ISESS POINTER              00630000
RIWE     EQU   R5                 WORK ELEMENT POINTER                  00640000
                                                                        00650000
         USING ICVT,RICVT         ESTABLISH ADDRESSIBILTY               00660000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSIBILTY               00670000
         USING ITASK,RITASK       ESTABLISH ADDRESSIBILTY               00680000
         USING IACB,RIACB         ESTABLISH ADDRESSIBILTY               00690000
         USING IRPL,RIRPL         ESTABLISH ADDRESSIBILTY               00700000
         USING IWEVTAM,RIWE       ESTABLISH ADDRESSIBILTY               00710000
         USING ISESS,RISESS       ESTABLISH ADDRESSIBILTY               00720000
                                                                        00730000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00740000
         DS    0D                                                       00750000
RCVPARMS DS    XL(L'IVR)          IVTAMRPA STORAGE                      00760000
ESTAEMFL DS    XL(L'ESTAEXPL)     PARMLIST CONSTRUCTION                 00770000
FRRPARM  DS    A                  RETURN AREA FOR FRR PARM ADDRESS      00780000
SAVER3   DS    F                  TEMPORARY SAVE AREA                   00790000
RETR15   DS    F                  RETURN CODE VALUE                     00800000
RETR0    DS    F                  RETURN REGISTER 0                     00810000
RETR1    DS    F                  RETURN REGISTER 1                     00820000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00830000
FLAG     DS    X                                                        00840000
FLESTAEX EQU   X'08'              ESTAEX ACTIVE                         00850000
FLFRR    EQU   X'04'              FRR    ACTIVE                         00860000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00870000
                                                                        00880000
IVTMXTPN #VTENTER BASE=R12,       VTAM EXIT ROUTINE LINKAGE            +00890000
               AMODE=31,                                               +00900000
               RMODE=ANY,                                              +00910000
               PREG=(R3),                                              +00920000
               EXITYPE=PLIST                                            00930000
                                                                        00940000
         USING IVTAMRPA,RCVPARMS  ESTABLISH ADDRESSIBILITY              00950000
                                                                        00960000
*---------------------------------------------------------------------- 00970000
* ESTABLISH RECOVERY ENVIRONMENT                                        00980000
*---------------------------------------------------------------------- 00990000
                                                                        01000000
         ST    R3,SAVER3          SAVE PARM REG                         01010000
         LA    R15,IVTXRTRY       RETRY ROUTINE ADDRESS                 01020000
         ST    R15,IVRRETAD       SET RETRY ROUTINE ADDRESS             01030000
         LA    R15,IVTAMRPA       PARAMETERS ADDRESS                    01040000
         ST    R15,IVRRPA@        SET ADDRESS FOR FRR                   01050000
         L     R0,=F'-1'          SHOW REGS RESTORED FROM PARM AREA     01060000
         STM   R0,R15,IVRR00      SAVE RETRY REGISTERS                  01070000
         MVC   IVRMOD,=CL8'IVTMTASK'                                    01080000
         MVC   IVRCSECT,=CL8'IVTMXTPN'                                  01090000
         MVC   IVRFRR,=CL8'IVTMXRCV'                                    01100000
         MVC   IVRTYPE,=CL8'ESTAEX'                                     01110000
         L     R3,=V(IVTMXRCV)    ADDR OF VTAM EXIT RECOVERY ROUTINE    01120000
         ICM   R0,15,PSATOLD      SRB MODE?                             01130000
         BZ    ESTFRR             BRANCH IF YES                         01140000
                                                                        01150000
         MVC   ESTAEMFL(L'ESTAEXPL),ESTAEXL                             01160000
                                                                        01170000
         ESTAEX (R3),                                                  +01180000
               CT,                                                     +01190000
               PARAM=RCVPARMS,                                         +01200000
               TERM=YES,                                               +01210000
               MF=(E,ESTAEMFL)    ESTABLISH RECOVERY                    01220000
                                                                        01230000
         OI    FLAG,FLESTAEX      RECOVERY ENVIRONMENT ESTABLISHED      01240000
         B     RECOVSET           AND CONTINUE                          01250000
                                                                        01260000
ESTFRR   DS    0H                                                       01270000
                                                                        01280000
         MVC   IVRTYPE,=CL8'FRR'                                        01290000
                                                                        01300000
         MODESET EXTKEY=ZERO,                                          +01310000
               SAVEKEY=(2)        SET KEY ZERO                          01320000
                                                                        01330000
         SETFRR A,                                                     +01340000
               FRRAD=(R3),                                             +01350000
               WRKREGS=(14,15),                                        +01360000
               PARMAD=FRRPARM     ESTABLISH RECOVERY                    01370000
                                                                        01380000
         L     R1,FRRPARM         PARM AREA FOR FRR                     01390000
         MVC   0(12,R1),RCVPARMS  SET TYPE & PARM AREA POINTER          01400000
                                                                        01410000
         MODESET KEYADDR=(2)      RESTORE PREVIOUS KEY                  01420000
                                                                        01430000
         OI    FLAG,FLFRR         RECOVERY ENVIRONMENT ESTABLISHED      01440000
         B     RECOVSET           AND CONTINUE                          01450000
                                                                        01460000
RECOVSET DS    0H                                                       01470000
                                                                        01480000
         L     R3,SAVER3          RESTORE PARM REG                      01490000
                                                                        01500000
*---------------------------------------------------------------------- 01510000
* ALLOCATE A TPEND WORK ELEMENT                                         01520000
*---------------------------------------------------------------------- 01530000
                                                                        01540000
         $VTAMWE L'IWEX9,         SIZE                                 +01550000
               IWECXTPN           CODE                                  01560000
                                                                        01570000
         LR    RIWE,R1                                                  01580000
                                                                        01590000
*---------------------------------------------------------------------- 01600000
* BUILD THE TPEND WORK ELEMENT                                          01610000
*---------------------------------------------------------------------- 01620000
                                                                        01630000
         ST    RIACB,IWEX9ACB     SET ADDR OF ACB                       01640000
         MVC   IWEX9RC,4(R3)      SET TPEND REASON CODE                 01650000
                                                                        01660000
*---------------------------------------------------------------------- 01670000
* SHOW THAT TPEND OCCURRED                                              01680000
*---------------------------------------------------------------------- 01690000
                                                                        01700000
         OI    IACF1,IACF1TPN     SET TPEND FLAG                        01710000
         OI    IACF1,IACF1UNU     SET OPEN FAIL/TPEND UNUSABLE FLAG     01720000
                                                                        01730000
*---------------------------------------------------------------------- 01740000
* TRACE THE MODULE ENTRY                                                01750000
*---------------------------------------------------------------------- 01760000
                                                                        01770000
         $TRACE *=A(TRC_IVTMXTPN),16,STDENV=NO        16 USER BYTES     01780000
                                                                        01790000
         BNZ   NOMTRACE           BRANCH IF TRACING NOT AVAILABLE       01800000
                                                                        01810000
         ST    RITASK,0(,R1)      TRACE ITASK                           01820000
         ST    RISESS,4(,R1)      TRACE ISESS                           01830000
         ST    RIACB,8(,R1)       TRACE IACB                            01840000
         MVC   12(4,R1),IWEX9RC   TRACE TPEND REASON CODE               01850000
                                                                        01860000
NOMTRACE DS    0H                                                       01870000
                                                                        01880000
*---------------------------------------------------------------------- 01890000
* QUEUE TPEND WORK ELEMENT TO VTAM MAIN ITASK                           01900000
*---------------------------------------------------------------------- 01910000
                                                                        01920000
         $VTAMQ (RIWE),           WORK ELEMENT                         +01930000
               IVTWEQ,            QUEUE                                +01940000
               STDENV=NO          EXIT ROUTINE                          01950000
                                                                        01960000
         B     RETURN                                                   01970000
                                                                        01980000
*---------------------------------------------------------------------- 01990000
* RETRY ROUTINE SCHEDULED BY RECOVERY                                   02000000
*---------------------------------------------------------------------- 02010000
                                                                        02020000
IVTXRTRY DS    0H                                                       02030000
                                                                        02040000
         LTR   R0,R0              WERE REGISTERS RESTORED FOR RETRY?    02050000
         BM    REGSOK             BRANCH IF YES, READY TO EXIT          02060000
X        USING IVTAMRPA,R1        PARM AREA ADDRESS MUST BE IN R1       02070000
         LM    R0,R15,X.IVRR00    RESTORE ALL THE REGISTERS             02080000
         DROP  X                                                        02090000
                                                                        02100000
REGSOK   DS    0H                                                       02110000
                                                                        02120000
         ICM   R0,15,PSATOLD      SRB MODE?                             02130000
         BNZ   RETURN             BRANCH IF NOT                         02140000
         ICM   R1,B'0001',=X'80'  KEY 8 IN BITS 24-27                   02150000
         MODESET KEYREG=(R1)      SET KEY 8                             02160000
         B     RETURN             AND WE ARE READY TO EXIT              02170000
                                                                        02180000
*---------------------------------------------------------------------- 02190000
* RETURN TO VTAM FROM EXIT ROUTINE                                      02200000
*---------------------------------------------------------------------- 02210000
                                                                        02220000
RETURN   DS    0H                                                       02230000
                                                                        02240000
         TM    FLAG,FLESTAEX      IS ESTAEX ESTABLISHED?                02250000
         BNO   RETFRR             BRANCH IF NOT                         02260000
                                                                        02270000
         ESTAEX 0                 DELETE RECOVERY ENVIRONMENT           02280000
                                                                        02290000
         NI    FLAG,255-FLESTAEX  CLEAR FLAG                            02300000
         B     EXITNOW            AND EXIT                              02310000
                                                                        02320000
RETFRR   DS    0H                                                       02330000
                                                                        02340000
         TM    FLAG,FLFRR         IS FRR ESTABLISHED?                   02350000
         BNO   EXITNOW            BRANCH IF NOT                         02360000
                                                                        02370000
         MODESET EXTKEY=ZERO,                                          +02380000
               SAVEKEY=(2)        SET KEY ZERO                          02390000
                                                                        02400000
         SETFRR D,                                                     +02410000
               WRKREGS=(14,15)    DELETE RECOVERY ENVIRONMENT           02420000
                                                                        02430000
         MODESET KEYADDR=(2)      RESTORE PREVIOUS KEY                  02440000
                                                                        02450000
         NI    FLAG,255-FLFRR     CLEAR FLAG                            02460000
         B     EXITNOW            AND EXIT                              02470000
                                                                        02480000
EXITNOW  DS    0H                                                       02490000
                                                                        02500000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 02510000
                                                                        02520000
         #VTEXIT ,                RETURN                                02530000
                                                                        02540000
*---------------------------------------------------------------------- 02550000
*  CONSTANTS AND LITERALS                                               02560000
*---------------------------------------------------------------------- 02570000
                                                                        02580000
ESTAEXL  ESTAEX *-*,CT,MF=L       ESTAEX PLIST                          02590000
ESTAEXPL EQU   ESTAEXL,*-ESTAEXL                                        02600000
                                                                        02610000
         LTORG ,                                                        02620000
         PRINT NOGEN                                                    02630000
         IVTAMRPA ,               INTEGRATOR VTAM RECOVERY PARAMETERS   02640000
         IHAFRRS ,                MVS FRR STACK                         02650000
         IHAPSA ,                 MVS PREFIXED STORAGE AREA             02660000
         ISTDBIND ,               VTAM BIND IMAGE                       02670000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         02680000
         ICVT  ,                  INTEGRATOR CVT                        02690000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   02700000
         ITASK ,                  INTEGRATOR TASK BLOCK                 02710000
         IACB ,                   INTEGRATOR VTAM ACB+                  02720000
         IRPL ,                   INTEGRATOR VTAM RPL+                  02730000
         INIB ,                   INTEGRATOR VTAM NIB+                  02740000
         ISESS ,                  INTEGRATOR SESSION BLOCK              02750000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            02760000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          02770000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       02780000
         EVCODES ,                INTEGRATOR EVENT CODES                02790000
         ABCODES ,                INTEGRATOR $ABEND CODES               02800000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     02810000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             02820000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             02830000
         IFGEXLST ,               VTAM EXIT LIST                        02840000
         END   ,                                                        02850000

IRMXSQLW TITLE '- SQL REQUEST CLEANUP / RESOURE MANAGEMENT'             00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE: IRMXSQLW - SQL request cleanup / resource management         00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine is a resource manager responsible for the             00080000
*    cleanup of data areas shared between the SQL execution             00090000
*    process and the cooperative SLU session driver (SLUDRV)            00100000
*    process.                                                           00110000
*                                                                       00120000
*    Primarily, this RESMGR is responsible for releasing all            00130000
*    resources documented in the Query Content Summary (QCS) as         00140000
*    either shared or global, particularly those that have been         00150000
*    allocated in ITASK storage to facilitate data sharing.             00160000
*                                                                       00170000
*                                                                       00180000
* ON ENTRY:                                                             00190000
*                                                                       00200000
*    R0  - addr of the terminating SQL process IPCB                     00210000
*    R1  - addr of the Query Content Summary (QCS)                      00220000
*                                                                       00230000
*                                                                       00240000
* ON EXIT:                                                              00250000
*                                                                       00260000
*    R15 contains zero                                                  00270000
*                                                                       00280000
**<DOC-ON>******************************************************        00290000
                                                                        00300000
         EJECT                                                          00310000
****************************************************************        00320000
*                                                                       00330000
* MAINTENANCE:                                                          00340000
*                                                                       00350000
*   09/23/94 Ron Colmone                                                00360000
*            Initial version                                            00370000
*                                                                       00380000
*   09/10/95 R. Turgeon                                                 00390000
*            ITIRSQL rewrite                                            00400000
*                                                                       00410000
*   12/15/95 R. Turgeon        Rel 2.1                                  00420000
*            Added cleanup call to INAVACLN to detach plans             00430000
*            not retained by SQLPrepare()                               00440000
*                                                                       00450000
****************************************************************        00460000
                                                                        00470000
         EJECT                                                          00480000
         #WORK ,                  READ/WRITE WORKAREA                   00490000
         #ENDWORK ,                                                     00500000
                                                                        00510000
         EJECT                                                          00520000
         QCS   ,                  QUERY CONTENT SUMMARY                 00530000
                                                                        00540000
         EJECT                                                          00550000
         NAV   ,                  NAVIGATIONAL STRUCTURES               00560000
                                                                        00570000
         EJECT                                                          00580000
         PSB   ,                  PREPARED STATEMENT BLOCK              00590000
                                                                        00600000
         EJECT                                                          00610000
         TBSERVIS CLOSE,DROP      TABLE CLEANUP                         00620000
                                                                        00630000
         EJECT                                                          00640000
         EQUS  ,                  GENERATE EQUATES                      00650000
                                                                        00660000
         EJECT                                                          00670000
IRMXSQLW #ENTER BASE=R12,PREG=(R8)                                      00680000
                                                                        00690000
         USING ITASK,R10          STDENV                                00700000
                                                                        00710000
         USING QCS,R8             QUERY CONTENT SUMMARY                 00720000
                                                                        00730000
         L     R6,QCSIUSER        LOCATE IUSER                          00740000
         USING IUSER,R6           LIFE OF FUNCTION ADDRESSABILITY       00750000
                                                                        00760000
         EJECT                                                          00770000
***************************************************************         00780000
*                                                                       00790000
*   The table description anchored in QCSDESC@, if any, was             00800000
*   acquired in itask owned storage on behalf of a table                00810000
*   services request.                                                   00820000
*                                                                       00830000
***************************************************************         00840000
                                                                        00850000
         ICM   R3,15,QCSDESC@     TABLE DESCRIPTION ACQUIRED?           00860000
         BZ    NODESC             SKIP IF NOT                           00870000
                                                                        00880000
         $RETSTOR (R3),OWNER=ITASK                                      00890000
                                                                        00900000
NODESC   DS    0H                                                       00910000
                                                                        00920000
***************************************************************         00930000
*                                                                       00940000
*   Delete the executor work area, including $NAVPARM                   00950000
*                                                                       00960000
***************************************************************         00970000
                                                                        00980000
         ICM   R3,15,QCSWORKA     EXECUTOR WORKAREA ACQUIRED?           00990000
         BZ    NOEXWORK           SKIP IF NOT                           01000000
                                                                        01010000
         $RETSTOR (R3),OWNER=ITASK                                      01020000
                                                                        01030000
NOEXWORK DS    0H                                                       01040000
                                                                        01050000
***************************************************************         01060000
*                                                                       01070000
*   When VDB data is collected, ITIQSEL preallocates a result           01080000
*   set row buffer of the appropriate size.                             01090000
*                                                                       01100000
***************************************************************         01110000
                                                                        01120000
         ICM   R3,15,QCSROBFR     ROW BUFFER ACQUIRED?                  01130000
         BZ    NOROWBFR           SKIP IF NOT                           01140000
                                                                        01150000
         $RETSTOR (R3),OWNER=ITASK                                      01160000
                                                                        01170000
NOROWBFR DS    0H                                                       01180000
                                                                        01190000
***************************************************************         01200000
*                                                                       01210000
*   If a VDB table definition is found in the QCS, detach it.           01220000
*                                                                       01230000
***************************************************************         01240000
                                                                        01250000
         ICM   R1,15,QCSAVDBL     R1 <== RESIDUAL VDB TABLE DEFINITION? 01260000
         BZ    NOVDBDEF           SKIP IF NOT                           01270000
                                                                        01280000
         @CALL IVDBDET,CTYPE=CVT                                        01290000
                                                                        01300000
NOVDBDEF DS    0H                                                       01310000
                                                                        01320000
***************************************************************         01330000
*                                                                       01340000
*   If a non-zero PSB pointer is found in the QCS, termination          01350000
*   occurred before an EXPORT operation could be performed.             01360000
*   The PSB is deleted.                                                 01370000
*                                                                       01380000
***************************************************************         01390000
                                                                        01400000
         ICM   R3,15,QCSEPSB      DANGLING PSB?                         01410000
         BZ    NOPSB              SKIP IF NOT                           01420000
         USING PSB,R3                                                   01430000
                                                                        01440000
         @CALL IPSBDEL,(*TSKPCBC,IUSER,PSBTOKEN,FALSE),                X01450000
               CTYPE=CVT,MF=(E,MFE_LIST)                                01460000
                                                                        01470000
NOPSB    DS    0H                                                       01480000
         DROP  R3                 PSB                                   01490000
                                                                        01500000
***************************************************************         01510000
*                                                                       01520000
*   Free the general purpose QCS workarea allocated for all             01530000
*   SQL executor routines.                                              01540000
*                                                                       01550000
***************************************************************         01560000
                                                                        01570000
         STGTERM QH=QCSGPSTG      RELEASE GENERAL PURPOSE STORAGE POOL  01580000
                                                                        01590000
***************************************************************         01600000
*                                                                       01610000
*   Messages may have been queued to the QCS for traces,                01620000
*   warnings, errors, etc.  The $FREMSG service deletes those           01630000
*   message buffers.                                                    01640000
*                                                                       01650000
***************************************************************         01660000
                                                                        01670000
         ICM   R0,15,QCSEMSGQ                                           01680000
         BZ    NOMSGS                                                   01690000
                                                                        01700000
         $FREMSG QCSEMSGQ,QH=*QCSQHMSG                                  01710000
                                                                        01720000
NOMSGS   DS    0H                                                       01730000
                                                                        01740000
***************************************************************         01750000
*                                                                       01760000
*   Free residual SQL stmt parse/semantic analysis workareas            01770000
*                                                                       01780000
***************************************************************         01790000
                                                                        01800000
         @CALL ITISQCLN,(*QCSSSMRY,QCSPARSE),                          X01810000
               CTYPE=CVT,                                              X01820000
               MF=(E,MFE_LIST)                                          01830000
                                                                        01840000
***************************************************************         01850000
*                                                                       01860000
*   Delete residual plans not retained by SQLPrepare()                  01870000
*                                                                       01880000
***************************************************************         01890000
                                                                        01900000
         @CALL INAVACLN,CTYPE=CVT                                       01910000
                                                                        01920000
***************************************************************         01930000
*                                                                       01940000
*   Discharge catalog or VDB table if still open                        01950000
*                                                                       01960000
***************************************************************         01970000
                                                                        01980000
         CLI   QCSTTYPE,QCST_CAT  CATALOG REFERENCE?                    01990000
         BNE   *+8                SKIP IF NOT                           02000000
         BAS   R14,TRETCLOS       CLOSE PERSISTENT TABLE                02010000
                                                                        02020000
         CLI   QCSTTYPE,QCST_CAT  CATALOG REFERENCE?                    02030000
         BE    *+8                SKIP IF SO                            02040000
         BAS   R14,TRETDROP       DROP NON-PERSISTENT TABLE             02050000
                                                                        02060000
***************************************************************         02070000
*                                                                       02080000
*   Free the QCS                                                        02090000
*                                                                       02100000
***************************************************************         02110000
                                                                        02120000
         $RETSTOR (R8),OWNER=ITASK                                      02130000
                                                                        02140000
***************************************************************         02150000
*                                                                       02160000
*   Complete                                                            02170000
*                                                                       02180000
***************************************************************         02190000
                                                                        02200000
         LA    R15,RC00           NORMAL COMPLETION                     02210000
                                                                        02220000
         #EXIT ,                  RETURN                                02230000
                                                                        02240000
         EJECT                                                          02250000
****************************************************************        02260000
*                                                                       02270000
* ROUTINE: TRETCLOS - Close open table                                  02280000
*                                                                       02290000
****************************************************************        02300000
                                                                        02310000
TRETCLOS DS    0H                                                       02320000
         ST    R14,FWORD                                                02330000
         ICM   R15,15,QCSTTOKN                                          02340000
         BZ    TRETCFIN                                                 02350000
                                                                        02360000
         TBCLOSE TTOKEN=QCSTTOKN,                                      X02370000
               MF=(E,MFE_LIST)                                          02380000
                                                                        02390000
TRETCFIN DS    0H                                                       02400000
         L     R14,FWORD                                                02410000
         LTR   R15,R15                                                  02420000
         BR    R14                                                      02430000
                                                                        02440000
****************************************************************        02450000
*                                                                       02460000
* ROUTINE: TRETDROP - DROP TABLE                                        02470000
*                                                                       02480000
****************************************************************        02490000
                                                                        02500000
TRETDROP DS    0H                                                       02510000
         ST    R14,FWORD                                                02520000
         ICM   R15,15,QCSTTOKN                                          02530000
         BZ    TRETDFIN                                                 02540000
                                                                        02550000
         TBDROP TTOKEN=QCSTTOKN,                                       X02560000
               MF=(E,MFE_LIST)                                          02570000
                                                                        02580000
TRETDFIN DS    0H                                                       02590000
         L     R14,FWORD                                                02600000
         LTR   R15,R15                                                  02610000
         BR    R14                                                      02620000
                                                                        02630000
         EJECT                                                          02640000
****************************************************************        02650000
*                                                                       02660000
*   Local read-only data areas                                          02670000
*                                                                       02680000
****************************************************************        02690000
                                                                        02700000
         LTORG ,                                                        02710000
                                                                        02720000
         PRINT NOGEN                                                    02730000
         ICVT  ,                                                        02740000
         ITASK ,                                                        02750000
         IUSER ,                                                        02760000
         END   ,                                                        02770000

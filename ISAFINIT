ISAFINIT TITLE '- SECURITY AUTHORIZATION FACILITY (SAF) INITIALIZATION' 00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE:  ISAFINIT - Security Authorization Facility Initialization   00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    The function of this routine is to construct the SAF CLASS         00080000
*    table and determine the status of the external security            00090000
*    system as well as the resource classes.  If the security           00100000
*    option is specified, APF authorization is required and             00110000
*    and a SAF based security product must be active otherwise          00120000
*    initialization will fail.                                          00130000
*                                                                       00140000
* Entry:  N/A                                                           00150000
*                                                                       00160000
* Exit:   Upon completion of the security request,  R15 will            00170000
*         contain one of the following return codes:                    00180000
*                                                                       00190000
*           RC00 - Security (SAF) initialization complete               00200000
*                                                                       00210000
*           RC08 - Security initialization failed                       00220000
*                                                                       00230000
*           RC12 - Storage allocation failure                           00240000
*                                                                       00250000
**<DOC-OFF>*****************************************************        00260000
                                                                        00270000
****************************************************************        00280000
*                                                                       00290000
* MAINTENANCE:                                                          00300000
*                                                                       00310000
*   08/20/93  R. Colmone                                                00320000
*             Initial Version                                           00330000
*                                                                       00340000
****************************************************************        00350000
                                                                        00360000
         EJECT ,                                                        00370000
         $SAF  DSECT=YES          PARAMETER LIST                        00380000
         EJECT ,                                                        00390000
         $SAFCLAS ,               SAF RESOURCE CLASS TABLE FORMAT       00400000
         EJECT ,                                                        00410000
         EQUS  ,                  GENERAL EQUATES                       00420000
                                                                        00430000
         EJECT ,                                                        00440000
         #WORK ,                  READ/WRITE WORKAREA                   00450000
REGSAVE  DS    16F                REGISTER SAVE AREA                    00460000
WRK256   DS    XL256              WORKAREA                              00470000
CLSTATUS DS    CL8                RESOURCE CLASS STATUS                 00480000
                                                                        00490000
$SAF_MFL $SAF  MF=L               $SAF PARAMETER LIST                   00500000
                                                                        00510000
         #ENDWORK ,               END OF WORKAREA                       00520000
                                                                        00530000
         $MSGDFT PREFIX=ICTPID,COMPID='SAF',TABLE=*#MSGS,              +00540000
               PRINT=NOGEN,MF=(E,WRK256)                                00550000
                                                                        00560000
         EJECT ,                                                        00570000
ISAFINIT #ENTER BASE=R12                                                00580000
                                                                        00590000
         USING ITASK,R10          ITASK ADDRESSABILITY                  00600000
                                                                        00610000
         EJECT ,                                                        00620000
*---------------------------------------------------------------        00630000
*  ALLOCATE STORAGE FOR $SAFCLAS TABLE STRUCTURE                        00640000
*---------------------------------------------------------------        00650000
         LA    R2,$SCLLN          GET  LENGTH OF $SAFCLAS ENTRY         00660000
         MH    R2,=AL2($RCLTAB#)  MULT BY NUMBER OF ENTRIES             00670000
         LA    R2,$SCHLN(,R2)     PLUS LENGTH OF $SAFCLAS HEADER        00680000
                                                                        00690000
         STGGET (R2),QH=ICTSTG    ALLOCATE STORAGE FOR CLASS TABLE      00700000
         BNZ   ERR_STG            STORAGE ALLOCATION ERROR              00710000
                                                                        00720000
         LR    R9,R1              ADDRESS OF $SAFCLAS HEADER            00730000
         USING $SCHDR,R9          ADDRESSABILITY                        00740000
                                                                        00750000
*---------------------------------------------------------------        00760000
*  INITIALIZE SAF CLASS TABLE HEADER                                    00770000
*---------------------------------------------------------------        00780000
         ST    R9,ICTCLAS@        ADDRESS OF CLASS TABLE                00790000
         MVC   $SCHID,=CL8'$SAFCLAS'  SAF CLASS TABLE ID                00800000
                                                                        00810000
         LA    R7,$SCHLN(,R9)     ORIGIN OF CLASS ENTRIES               00820000
         USING $SCLENT,R7         ADDRESSABILITY                        00830000
         ST    R7,$SCHFRST        ADDRESS OF FIRST ENTRY                00840000
                                                                        00850000
         LA    R3,$RCLTAB#        GET NUMBER OF RESOURCE ENTRIES        00860000
         ST    R3,$SCHCNT         SAVE COUNT OF ENTRIES                 00870000
                                                                        00880000
*---------------------------------------------------------------        00890000
*  PROCESS EACH ENTRY IN RESOURCE CLASS TABLE AND INITIALIZE            00900000
*  SAF CLASS TABLE.                                                     00910000
*---------------------------------------------------------------        00920000
         LA    R4,$RCLTAB         ORIGIN OF RESOURCE CLASS TABLE        00930000
                                                                        00940000
CLASINIT DS    0H                                                       00950000
         MVC   $SCLRSRC,0(R4)     COPY INTERNAL RESOURCE NAME           00960000
         L     R1,8(,R4)          OFFSET TO SAF CLASS NAME              00970000
         LA    R1,ICVT(R1)        CONVERT TO ADDRESS                    00980000
         MVC   $SCLNAME,BLANKS    INITIALIZE SAF CLASS NAME             00990000
         CLC   $DISABLE,0(R1)     RESOURCE CLASS DISABLED?              01000000
         BE    CLASNEXT           YES, PROCESS NEXT CLASS               01010000
         MVC   $SCLNAME,0(R1)     COPY RESOURCE CLASS NAME              01020000
                                                                        01030000
         TM    ICTSAFOP,ICTS$ENA  SECURITY ENABLED                      01040000
         BZ    CLASNEXT           NO,  ASSUME CLASS DISABLED            01050000
         OI    $SCLFLAG,$SCL$ACT  SET RESOURCE CLASS ACTIVE             01060000
                                                                        01070000
CLASNEXT DS    0H                                                       01080000
         LA    R4,L'$RCLTAB(,R4)  ADDRESS OF NEXT RESOURCE ENTRY        01090000
         LA    R7,$SCLLN(,R7)     ADDRESS OF NEXT SAFCLASS ENTRY        01100000
         BCT   R3,CLASINIT        PROCESS NEXT ENTRY                    01110000
                                                                        01120000
         EJECT ,                                                        01130000
*---------------------------------------------------------------        01140000
*  IF EXTERNAL SECURITY IS ENABLED, VERIFY APF AUTHORIZATION            01150000
*  AND THAT SAF INTERFACE IS ACTIVE.                                    01160000
*---------------------------------------------------------------        01170000
         TM    ICTSAFOP,ICTS$ENA  EXTERNAL SECURITY ENABLED             01180000
         BZ    NO_SECUR           NO,  ISSUE MESSAGE AND RETURN         01190000
                                                                        01200000
         TM    ICTSTAT2,ICT2$APF  RUNNING APF AUTHORIZED?               01210000
         BZ    NO_APF             NO,  ISSUE MESSAGE AND RETURN         01220000
                                                                        01230000
         $SAF  STAT,MF=(E,$SAF_MFL)  EXTERNAL SECURITY ACTIVE           01240000
         BNZ   NOT_ACT            NO,  ISSUE MESSAGE AND RETURN         01250000
                                                                        01260000
         $MSG  900                EXTERNAL SECURITY ACTIVE              01270000
         B     CHECKCLS           CHECK CLASS STATUS                    01280000
                                                                        01290000
NO_SECUR DS    0H                                                       01300000
         $MSG  901                EXTERNAL SECURITY NOT ACTIVE          01310000
         B     RET_OK             RETURN NORMAL                         01320000
                                                                        01330000
NO_APF   DS    0H                                                       01340000
         $MSG  902                APF AUTHORIZATION REQUIRED            01350000
         B     ERR_INIT           INITIALIZATION FAILURE                01360000
                                                                        01370000
NOT_ACT  DS    0H                                                       01380000
         $MSG  903                EXTERNAL SECURITY NOT ACTIVE          01390000
         B     ERR_INIT           INITIALIZATION FAILURE                01400000
                                                                        01410000
         EJECT ,                                                        01420000
*---------------------------------------------------------------        01430000
*  PROCESS SAF CLASS TABLE AND DETERMINE IF THE SPECIFIED               01440000
*  RESOURCE CLASSES ARE ACTIVE.                                         01450000
*---------------------------------------------------------------        01460000
CHECKCLS DS    0H                                                       01470000
         L     R3,$SCHCNT         GET COUNT OF SAF CLASS ENTRIES        01480000
         L     R7,$SCHFRST        ADDRESS OF FIRST SAFCLASS ENTRY       01490000
         USING $SCLENT,R7         ADDRESSABILITY                        01500000
                                                                        01510000
CLASSTAT DS    0H                                                       01520000
         MVC   CLSTATUS,=c'active' ASSUME CLASS IS ACTIVE               01530000
         TM    $SCLFLAG,$SCL$ACT  RESOURCE CLASS DISABLED BY DFT        01540000
         BZ    CLS_NACT           YES, ISSUE MESSAGE                    01550000
                                                                        01560000
         $SAF  STAT,CLASS=$SCLRSRC,MF=(E,$SAF_MFL)                      01570000
         BZ    CLS_ACT            RESOURCE CLASS IS ACTIVE              01580000
                                                                        01590000
CLS_NACT DS    0H                                                       01600000
         NI    $SCLFLAG,FF-$SCL$ACT  RESET ACTIVE CLASS FLAG            01610000
         MVC   CLSTATUS,=c'inactive' SET RESOURCE CLASS STATUS          01620000
                                                                        01630000
CLS_ACT  DS    0H                                                       01640000
         $MSG  904,FIELDS=($SCLRSRC,$SCLNAME,CLSTATUS)                  01650000
                                                                        01660000
         LA    R7,$SCLLN(,R7)     ADDRESS OF NEXT ENTRY                 01670000
         BCT   R3,CLASSTAT        CHECK STATUS OF NEXT CLASS            01680000
                                                                        01690000
         B     RET_OK             NORMAL COMPLETION                     01700000
                                                                        01710000
         EJECT ,                                                        01720000
****************************************************************        01730000
*                                                                       01740000
*  RETURN                                                               01750000
*                                                                       01760000
****************************************************************        01770000
                                                                        01780000
RET_OK   DS    0H                                                       01790000
         LA    R15,RC00           NORMAL COMPLETION                     01800000
         B     RETURN             RETURN                                01810000
                                                                        01820000
ERR_INIT DS    0H                                                       01830000
         LA    R15,RC08           INITIALIZATION ERROR                  01840000
         B     RETURN             RETURN                                01850000
                                                                        01860000
ERR_STG  DS    0H                                                       01870000
         LA    R15,RC12           STORAGE ALLOCATION FAILURE            01880000
         B     RETURN             RETURN                                01890000
                                                                        01900000
RETURN   DS    0H                                                       01910000
         #EXIT ,                  RETURN                                01920000
                                                                        01930000
                                                                        01940000
         EJECT ,                                                        01950000
****************************************************************        01960000
*                                                                       01970000
*  CONSTANTS, LITERALS, AND MAPPINGS                                    01980000
*                                                                       01990000
****************************************************************        02000000
$DISABLE DC    CL8'DISABLE'       RESOURCE CLASS DISABLE INDICATOR      02010000
BLANKS   DC    CL8' '                                                   02020000
                                                                        02030000
*---------------------------------------------------------------        02040000
*  INTEGRATOR RESOURCE CLASS TABLE                                      02050000
*---------------------------------------------------------------        02060000
         DS    0F                                                       02070000
$RCLTAB  EQU   *,8+4                                                    02080000
         DC    CL8'INTEGRAT',A(ICTINTCL-ICVT)                           02090000
         DC    CL8'PROJECT ',A(ICTPRJCL-ICVT)                           02100000
         DC    CL8'APPL    ',A(ICTAPLCL-ICVT)                           02110000
         DC    CL8'TABLE   ',A(ICTTBLCL-ICVT)                           02120000
$RCLTAB# EQU   (*-$RCLTAB)/L'$RCLTAB                                    02130000
                                                                        02140000
         LTORG ,                                                        02150000
                                                                        02160000
         PRINT NOGEN                                                    02170000
         ICVT  ,                                                        02180000
         ITASK ,                                                        02190000
         PRINT GEN                                                      02200000
                                                                        02210000
         END   ,                                                        02220000

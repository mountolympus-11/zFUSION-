         TITLE 'ICMDTPU - TPUSER CMDPROC'                               00010000
         #WORK ,             BEGIN WORKAREA                             00020000
                                                                        00030000
MAJID    DS    X             MAJOR KEYWORD ID (MUTEXC)                  00040000
                                                                        00050000
MINOPTS  DS    X             MINOR KEYWORD ID (MUTEXC)                  00060000
MINSESS  EQU   X'80'            SESSION DETAIL REQUESTED                00070000
                                                                        00080000
FLAGS    DS    X             LOCAL CONTROL FLAGS                        00090000
FOUTPUT  EQU   X'80'            IVUSER FORMATTING OCCCURRED             00100000
FLOCKED  EQU   X'40'            VTAM LOCK ACQUIRED                      00110000
                                                                        00120000
RESERVED DS    X             RESERVED                                   00130000
TASKNAME DS    CL8           TASK() DESIGNATION                         00140000
                                                                        00150000
REGSAVE  DS    16F           LOCAL ROUTINE SAVEAREA                     00160000
WK256    DS    XL256         LARGE PLIST CONSTRUCTION, ETC.             00170000
                                                                        00180000
         #ENDWORK ,          END WORKAREA                               00190000
                                                                        00200000
         EJECT                                                          00210000
         CMDREQ  ,           COMMAND REQUEST BLOCK                      00220000
         EJECT                                                          00230000
         CCSUMRY ,           COMMAND OPERAND PREPARSE SUMMARY           00240000
         EJECT                                                          00250000
         KEYCODES COMMANDSET=TPUSER                                     00260000
                                                                        00270000
         CMDCODES ,                                                     00280000
                                                                        00290000
         EQUS  ,                                                        00300000
                                                                        00310000
         $MSGDFT PREFIX=ICTPID,COMPID='CMD',TABLE=*#MSGS,              X00320000
               CONID=*CMRQCNID,CONNAME=CMRQCNAM,CART=CMRQCART,         X00330000
               DESTADD=*CMRQDMSK,                                      X00340000
               MSGQA=*CMRQMQA,STGQH=*CMRQSTGQ,                         X00350000
               MF=(E,WK256),                                           X00360000
               PRINT=NOGEN                                              00370000
         EJECT                                                          00380000
                                                                        00390000
**<DOC-ON>*****************************************************         00400000
*                                                                       00410000
* ROUTINE: ICMDTPU - TPUSER CMDPROC                                     00420000
*                                                                       00430000
* DESCRIPTION:                                                          00440000
*                                                                       00450000
*    THIS ROUTINE PROCESSES THE VARIOUS FORMS OF THE                    00460000
*    'TPUSER' COMMAND WHICH IS USED TO PRESENT INFORMATION              00470000
*    DESCRIBING ACTIVE VTAM SESSIONS.                                   00480000
*                                                                       00490000
* SYNTAX:                                                               00500000
*                                                                       00510000
*    TPUSER                                                             00520000
*    TPUSER  NAMES / TASK(...) / SESSIONS                               00530000
*    TPU       "   /   LU(...) / SESS                                   00540000
*                                                                       00550000
* ON ENTRY:                                                             00560000
*                                                                       00570000
*    R1  ADDR OF COMMAND REQUEST BLOCK (CMDREQ) IN LOCAL                00580000
*        CMDPROC FORMAT                                                 00590000
*                                                                       00600000
**<DOC-OFF>****************************************************         00610000
                                                                        00620000
                                                                        00630000
***************************************************************         00640000
*                                                                       00650000
* MAINTENANCE:                                                          00660000
*                                                                       00670000
*    09/22/93 R. TURGEON                                                00680000
*             INITIAL VERSION                                           00690000
*                                                                       00700000
***************************************************************         00710000
                                                                        00720000
         EJECT ,                                                        00730000
ICMDTPU  #ENTER PREG=R8                                                 00740000
                                                                        00750000
         USING ICVT,R11                                                 00760000
                                                                        00770000
*--------------------------------------------------------------         00780000
*    LOCATE COMMAND REQUEST BLOCK, COMMAND SUMMARY, AND OPS             00790000
*--------------------------------------------------------------         00800000
         USING CMDREQ,R8          COMMAND REQUEST BLOCK                 00810000
         ICM   R7,15,CMRQSMRY     ASSOC COMMAND SUMMARY                 00820000
         BZ    PROCESS            AMBIGUOUS REQUEST                     00830000
         USING CCSUMRY,R7         COMMAND OPERAND SUMMARY FORMAT        00840000
         ICM   R5,15,CMRQSMR#     TOTAL NUMBER OF OPERAND ENTRIES       00850000
         BZ    PROCESS            AMBIGUOUS REQUEST IF ZERO             00860000
         L     R6,CMRQOPST        OPERAND STRING ORIGIN                 00870000
                                                                        00880000
*--------------------------------------------------------------         00890000
*   IDENTIFY THE OPERANDS PROVIDED AND VALIDATE                         00900000
*--------------------------------------------------------------         00910000
PARSENXT DS    0H                                                       00920000
         LA    R1,TPUSER_NAMES    ALL TASK / LU NAMES                   00930000
         CH    R1,CCSID           CURRENT KEYWORD?                      00940000
         BE    MAJKEY             BREAK IF SO                           00950000
                                                                        00960000
         LA    R15,MINSESS        LOCAL MINOR OPTION SUMMARY BIT        00970000
         LA    R1,TPUSER_SESS     DETAILED SESSION INFO REQUEST         00980000
         CH    R1,CCSID           CURRENT KEYWORD?                      00990000
         BE    MINKEY             BREAK IF SO                           01000000
                                                                        01010000
         LA    R1,TPUSER_TASK     ZOOM SPECIFIC TASK / LUNAME           01020000
         CH    R1,CCSID           CURRENT KEYWORD?                      01030000
         BE    PTSKNM             PROCESS IF SO                         01040000
         B     ERREJECT           REJECT OTHERWISE                      01050000
                                                                        01060000
*--------------------------------------------------------------         01070000
*   POST SENTINELS AND VALUES FOR MAJOR AND MINOR KEYS FOUND            01080000
*--------------------------------------------------------------         01090000
MAJKEY   DS    0H                                                       01100000
         CLI   MAJID,0            ONLY KEYWORD OF MAJOR GROUP?          01110000
         BNE   ERRCNFLC           CONFLICTING OPERANDS OTHERWISE        01120000
         STC   R1,MAJID           POST REQUEST TYPE                     01130000
         B     ADVANCE            ADVANCE TO NEXT OPERAND               01140000
                                                                        01150000
MINKEY   DS    0H                                                       01160000
         OI    MINOPTS,*-*        BIT INSERTED                          01170000
         EX    R15,*-4            INSERT OPTION FLAG                    01180000
         B     ADVANCE            ADVANCE TO NEXT OPERAND               01190000
                                                                        01200000
                                                                        01210000
*------- TASK(<TASKNAME>) -------------------------------------         01220000
                                                                        01230000
PTSKNM   DS    0H                 TASK(<TASKNAME>)                      01240000
         TM    TASKNAME,BF        ALREADY VISITED THIS OPERAND?         01250000
         BNZ   ERRCNFLC           PREVIOUSLY GIVEN LU()/TASK()          01260000
         CLC   CCSVALCT,=H'1'     SINGLE VALUE?                         01270000
         BNE   ERRSYNTX           SYNTAX PROBLEM OTHERWISE              01280000
         LH    R2,CCSVLEN         FETCH VALUE LENGTH                    01290000
         LTR   R2,R2              LENGTH OF STRING                      01300000
         BNP   ERRSYNTX           SYNTAX ERROR                          01310000
         CH    R2,=AL2(L'TASKNAME)   CORRECT LENGTH?                    01320000
         BH    ERRSYNTX           ERROR IF NOT                          01330000
                                                                        01340000
         MVC   TASKNAME,BLANKS    BLANK PAD                             01350000
         L     R3,CCSVDISP        OFFSET TO TASKNAME IN CMD LINE        01360000
         AR    R3,R6              CONVERT OFFSET TO ADDRESS             01370000
         BCTR  R2,0               PREPARE FOR EX                        01380000
         EX    R2,*+4             LOCAL COPY OF TASKNAME                01390000
         MVC   TASKNAME(*-*),0(R3)                                      01400000
                                                                        01410000
*--------------------------------------------------------------         01420000
*   PROCESS ALL KEYWORDS, VALIDATE REQUEST COMPLETENESS                 01430000
*--------------------------------------------------------------         01440000
ADVANCE  DS    0H                                                       01450000
         LA    R15,CCSVSLN        LENGTH OF EACH VALUE ENTRY            01460000
         MH    R15,CCSVALCT       TOTAL SIZE CONSUMED BY VALUES         01470000
         LA    R7,CCSUMRY+CCSPFXL(R15)                                  01480000
         BCT   R5,PARSENXT        EXAMINE ALL OPERANDS                  01490000
                                                                        01500000
         TM    MINOPTS,MINSESS    DETAILED SESSION INFORMATION?         01510000
         BNO   *+8                SKIP IF NOT                           01520000
         MVI   MAJID,TPUSER_NAMES   ENSURE TASK/LU NAMES LISTED         01530000
         DROP  R7                 CCSUMRY                               01540000
                                                                        01550000
         EJECT ,                                                        01560000
***************************************************************         01570000
*                                                                       01580000
*   IF ALL TASKS OR NAMED TASK, ACQUIRE VTAM LOCK AND DRIVE THE         01590000
*   DISPLAY BY RUNNING THE IVUSER LOOKUP TABLE SEQUENTIALLY,            01600000
*   AND INVOKING THE DETAILED SESSION DISPLAY IF REQUESTED.             01610000
*                                                                       01620000
***************************************************************         01630000
PROCESS  DS    0H                                                       01640000
         L     R9,ICTVTCVT        LOCATE THE VTAM CVT                   01650000
         USING IVTAMCVT,R9        LIFE OF FUNCTION ADDRESSABILITY       01660000
                                                                        01670000
         $SER  OBTAIN,VTAM        ACQUIRE VTAM LOCK                     01680000
                                                                        01690000
         BNZ   *+8                SKIP IF SO                            01700000
         OI    FLAGS,FLOCKED      ELSE INDICATE LOCK OWNERSHIP          01710000
                                                                        01720000
         ICM   R0,15,IVT#USER     ACTIVE USERS?                         01730000
         BZ    SUMMARY            AVOID UNPRODUCTIVE SERIALIZATION      01740000
         CLI   MAJID,TPUSER_NAMES   TASK(S) DISPLAY?                    01750000
         BNE   SUMMARY            DONE HERE IF NOT                      01760000
                                                                        01770000
***************************************************************         01780000
*                                                                       01790000
*   SERIAL SCAN OF IVUSER HASH TABLE BEGINS.  CURRENTLY, THE            01800000
*   TABLE CONTAINS 1024 FULLWORD PTRS (FBA).                            01810000
*                                                                       01820000
***************************************************************         01830000
                                                                        01840000
         $MSG  325                INTRO MSG                             01850000
                                                                        01860000
         ICM   R7,15,IVT@UTBL     IVUSER HASH TABLE ORIGIN              01870000
         BZ    HIVFAIL            UNEXPECTED CONFIGURATION              01880000
         LA    R6,1024            NUMBER OF ENTRIES                     01890000
                                                                        01900000
*--------------------------------------------------------------         01910000
*   RUN ALL IVUSERS (TASK/LU NAMES CAN BE DUPLICATED)                   01920000
*--------------------------------------------------------------         01930000
HIVSCAN  DS    0H                                                       01940000
         ICM   R5,15,0(R7)        IVUSER CHAIN ANCHORED HERE?           01950000
         BZ    HIVADV             ADVANCE OTHERWISE                     01960000
         USING IVUSER,R5          SHORT TERM ADDRESSABILITY             01970000
                                                                        01980000
HIVNEXT  DS    0H                                                       01990000
         TM    TASKNAME,BF        SELECTED TASK NAME ONLY?              02000000
         BZ    HIVFMT             FORMAT THE IVUSER OTHERWISE           02010000
         CLC   TASKNAME,IVUITSKN  MATCHING TASK/LU                      02020000
         BNE   HIVWALK            SKIP IT IF NOT                        02030000
                                                                        02040000
HIVFMT   DS    0H                 FORMAT SELECTED IVUSER BLOCKS         02050000
         LA    R1,IVUSER          IVUSER PTR IN PARM REG                02060000
         BAS   R14,FMTIVUSR       PROCESS IVUSER                        02070000
         OI    FLAGS,FOUTPUT      INDICATE IVUSER HAS BEEN FORMATTED    02080000
                                                                        02090000
HIVWALK  DS    0H                                                       02100000
         ICM   R5,15,IVUNEXT      WALK IVUSER SYNONYM CHAIN             02110000
         BNZ   HIVNEXT            PROCESS ENTIRE CHAIN                  02120000
                                                                        02130000
HIVADV   DS    0H                                                       02140000
         LA    R7,4(,R7)          ADVANCE TO NEXT IVUSER ANCHOR ORIGIN  02150000
         BCT   R6,HIVSCAN         PROCESS ENTIRE TABLE                  02160000
         DROP  R5                 IVUSER                                02170000
                                                                        02180000
*--------------------------------------------------------------         02190000
*   GENERATE 'NOT FOUND' MESSAGE IF APPLICABLE AND CLEANUP              02200000
*--------------------------------------------------------------         02210000
HIVFAIL  DS    0H                                                       02220000
         TM    FLAGS,FOUTPUT      IVUSER MATCHED?                       02230000
         BO    HIVFIN             SKIP IF SO                            02240000
                                                                        02250000
         $MSG  326,FIELDS=(TASKNAME)  APPROP ALSO IF TASKNAME=''        02260000
                                                                        02270000
HIVFIN   DS    0H                                                       02280000
                                                                        02290000
***************************************************************         02300000
*                                                                       02310000
*   CLEANUP AND TERMINATION                                             02320000
*                                                                       02330000
***************************************************************         02340000
SUMMARY  DS    0H                                                       02350000
         $MSG  330,FIELDS=(IVT#USER)                                    02360000
                                                                        02370000
         TM    FLAGS,FLOCKED      LOCK OWNED BY CMDPROC?                02380000
         BNO   CLEANFIN           SKIP IF NOT                           02390000
                                                                        02400000
         $SER  RELEASE,VTAM       RELEASE VTAM LOCK                     02410000
                                                                        02420000
CLEANFIN DS    0H                                                       02430000
         B     NORMRET                                                  02440000
                                                                        02450000
         EJECT ,                                                        02460000
***************************************************************         02470000
*                                                                       02480000
*   RETURN COMPLETION STATUS TO REQUESTOR                               02490000
*                                                                       02500000
***************************************************************         02510000
NORMRET  DS    0H                                                       02520000
         LA    R15,CCODE_NORESP   NO ADDITIONAL RESPONSE REQUIRED       02530000
         B     CMDRET                                                   02540000
                                                                        02550000
ERRSYNTX DS    0H                                                       02560000
         LA    R15,CCODE_SYNTAX   SYNTAX ERROR                          02570000
         B     CMDRET             DONE                                  02580000
                                                                        02590000
ERRAMBIG DS    0H                                                       02600000
         LA    R15,CCODE_AMBIG    AMBIGUOUS REQUEST                     02610000
         B     CMDRET             DONE                                  02620000
                                                                        02630000
ERRCNFLC DS    0H                                                       02640000
         LA    R15,CCODE_CONFLICT CONFLICTING OPERANDS                  02650000
         B     CMDRET             DONE                                  02660000
                                                                        02670000
ERREJECT DS    0H                                                       02680000
         LA    R15,CCODE_REJECT   COMMAND REJECTED                      02690000
         B     CMDRET             DONE                                  02700000
                                                                        02710000
CMDRET   DS    0H                                                       02720000
         ST    R15,CMRQCOMP       POST COMPLETION CODE PER CONVENTION   02730000
         #EXIT ,                                                        02740000
                                                                        02750000
         EJECT ,                                                        02760000
***************************************************************         02770000
*                                                                       02780000
* ROUTINE: FMTIVUSR - GENERATE IVUSER INFORMATION GROUP                 02790000
*                                                                       02800000
***************************************************************         02810000
FMTIVUSR DS    0H                                                       02820000
         STM   R0,R15,REGSAVE     SAVE MAINLINE REGS                    02830000
         LR    R5,R1              ACCEPT PASSED PARMS                   02840000
         USING IVUSER,R5          MAPPED                                02850000
                                                                        02860000
         $MSG  327,FIELDS=(IVUITSKN,IVUTKUSR,(IVUF1,4),IVU#SESS)        02870000
                                                                        02880000
*--------------------------------------------------------------         02890000
*   DETAILED SESSION INFORMATION, IF REQUESTED                          02900000
*--------------------------------------------------------------         02910000
         TM    MINOPTS,MINSESS    DETAILED SESSION INFO REQUIRED?       02920000
         BNO   FMTIVFIN           SKIP IF NOT                           02930000
                                                                        02940000
         ICM   R4,15,IVUIS1ST     LOCATE FIRST ISESS                    02950000
         BM    FMTIVFIN           DONE IF N/A                           02960000
         USING ISESS,R4           SESSION INFO                          02970000
                                                                        02980000
FMTISESS DS    0H                                                       02990000
                                                                        03000000
         $MSG  328,FIELDS=(ISERLUNM,ISEILUNM,ISECID,                   X03010000
               ISETKUSR,ISETKSES,ISELOGMD,ISEDRIVE,                    X03020000
               ISE#MSGI,ISE#BYTI,ISE#MSGO,ISE#BYTO)                     03030000
                                                                        03040000
         $MSG  329,FIELDS=(ISESTATE,ISEFLAGS,ISERU,ISERRU,             X03050000
               (ISEBIND,4),(ISEBIND+4,4),(ISEBIND+8,4),                X03060000
               (ISEBIND+12,4),(ISEBIND+16,4),(ISEBIND+20,4),           X03070000
               (ISEBIND+24,1))                                          03080000
                                                                        03090000
         ICM   R4,15,ISENEXT      ADVANCE TO NEXT SESS                  03100000
         BP    FMTISESS           AGAIN                                 03110000
                                                                        03120000
         DROP  R4,R5              ISESS, IVUSER                         03130000
                                                                        03140000
*--------------------------------------------------------------         03150000
*   RETURN TO REQUESTOR                                                 03160000
*--------------------------------------------------------------         03170000
FMTIVFIN DS    0H                                                       03180000
         LM    R0,R14,REGSAVE     RESTORE MAINLINE REGS                 03190000
         SR    R15,R15            NO RETCODES DEFINED                   03200000
         BR    R14                RETURN                                03210000
                                                                        03220000
         EJECT ,                                                        03230000
***************************************************************         03240000
*                                                                       03250000
*   LOCAL READ/ONLY DATA AREAS, ETC.                                    03260000
*                                                                       03270000
***************************************************************         03280000
BLANKS   DC    CL16' '                                                  03290000
                                                                        03300000
         LTORG ,                                                        03310000
                                                                        03320000
         PRINT NOGEN                                                    03330000
         ICVT  ,                                                        03340000
                                                                        03350000
         ISTDBIND ,                                                     03360000
         IVTAMCVT ,                                                     03370000
         IVUSER ,                                                       03380000
         ISESS  ,                                                       03390000
         END   ,                                                        03400000

ITSKINIT TITLE '- ITASK INITIALIZATION SERVICE'                         00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE: ITSKINIT - ITASK INITIALIZATION SERVICE                      00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine will allocate and initialize the ITASK                00080000
*    control block associated with the new task being created.          00090000
*    This request is internally called from the TASK create             00100000
*    service as well as during initialization from the MAIN             00110000
*    task.  Optionally,  a storage area may be provided to              00120000
*    construct the ITASK.                                               00130000
*                                                                       00140000
* ON ENTRY:                                                             00150000
*                                                                       00160000
*    R1 Contains the address of the parameter list mapped by            00170000
*    the TASKPL dsect generated by $TASK DSECT=YES.                     00180000
*                                                                       00190000
* ON EXIT:                                                              00200000
*                                                                       00210000
*    R15 Contains one of the following return codes:                    00220000
*                                                                       00230000
*        RC00 - Normal completion                                       00240000
*               R1 - Addr of initialized ITASK                          00250000
*                                                                       00260000
*        RC16 - Internal failure                                        00270000
*               R0 = RSN04 - Storage allocation failure                 00280000
*                                                                       00290000
* MODE:                                                                 00300000
*                                                                       00310000
*    TASK                                                               00320000
*    APF/NON-APF                                                        00330000
*    SUP/PROB                                                           00340000
*    AMODE 31, RMODE ANY                                                00350000
*                                                                       00360000
**<DOC-OFF>*****************************************************        00370000
                                                                        00380000
         EJECT ,                                                        00390000
****************************************************************        00400000
*                                                                       00410000
* MAINTENANCE:                                                          00420000
*                                                                       00430000
*   04/21/93 Ron Colmone                                                00440000
*            Initial Version                                            00450000
*                                                                       00460000
*   09/12/95 Ron Colmone          Par #214761                           00470000
*            Added support for Dispatch queue initialization            00480000
*                                                                       00490000
*   09/14/95 Ron Colmone          Par #215477                           00500000
*            Added support to initial XEPB queue headers                00510000
*                                                                       00520000
****************************************************************        00530000
                                                                        00540000
         EJECT ,                                                        00550000
         ITASK ,                                                        00560000
                                                                        00570000
         EJECT ,                                                        00580000
         $TASK DSECT=YES          TASKMGR PLIST                         00590000
                                                                        00600000
         EJECT ,                                                        00610000
         XEPB   ,                 EXTEND EVENT PROCESS BLOCK MAPPING    00620000
                                                                        00630000
         EJECT ,                                                        00640000
         $QLOCK ,                 LOCK QUEUE ENTRY                      00650000
                                                                        00660000
         EJECT ,                                                        00670000
         @CB   WORKUNIT=YES       STANDARD CONTROL BLOCK HEADER         00680000
                                                                        00690000
         EJECT ,                                                        00700000
         EQUS  ,                  GENERAL EQUATES                       00710000
                                                                        00720000
         EJECT ,                                                        00730000
         ABCODES ,                $ABEND CODES                          00740000
                                                                        00750000
#STGBLK  EQU   1024               STORAGE BLK INIT SIZE                 00760000
                                                                        00770000
         EJECT ,                                                        00780000
         #WORK LENGTH=512         READ/WRITE WORKAREA                   00790000
FLAGS    DS    XL1                FLAGS                                 00800000
$LOCKED  EQU   X'80'                DISP LOCK OBTAINED                  00810000
         #ENDWORK                 END OF WORKAREA                       00820000
                                                                        00830000
         EJECT ,                                                        00840000
ITSKINIT #ENTER BASE=R12,         ENTRY LINKAGE                        +00850000
               PREG=R8,                                                +00860000
               WAPASS=YES                                               00870000
                                                                        00880000
         USING TASKPL,R8          ESTABLISH ADDRESSABILITY              00890000
         USING ITASK,R10          ESTABLISH ADDRESSABILITY              00900000
                                                                        00910000
         EJECT ,                                                        00920000
****************************************************************        00930000
*                                                                       00940000
*  ALLOCATE/INITIALIZE ITASK.  IF AREA AND AREALEN ARE SPECIFIED        00950000
*  THE AREA PROVIDED MUST BE LARGE ENOUGH FOR AN ITASK CONTROL          00960000
*  BLOCK AND MUST BE INITIALIZED TO HEX ZEROS.                          00970000
*                                                                       00980000
****************************************************************        00990000
INIT     DS    0H                                                       01000000
         ICM   R1,15,TPLAREA      AREA PROVIDE FOR PCB?                 01010000
         BZ    INIT_STG           NO, ALLOC REQUIRED STORAGE            01020000
         L     R0,TPLAREAL        GET LENGTH OF AREA                    01030000
         C     R0,=A(TSKLENG)     SUFFICIENT LENGTH                     01040000
         BNL   INIT_PCB           CONTINUE PCB INITIALIZATION           01050000
                                                                        01060000
INIT_STG DS    0H                                                       01070000
         $GETSTOR TSKLENG,OWNER=ITASK,COND=YES  ALLOC ITASK STG  159456 01080000
         BNZ   ERR_STG                          STG ERROR               01090000
                                                                        01100000
INIT_PCB DS    0H                                                       01110000
         LR    R5,R1              ADDR OF ITASK BLOCK                   01120000
N        USING ITASK,R5           ESTAB ADDR TO NEW ITASK               01130000
                                                                        01140000
         MVC   N.TSKID,=CL8'ITASK'  CONTROL BLOCK ID                    01150000
         MVC   N.TSKLEN,=A(TSKLENG) LENGTH  OF ITASK CB                 01160000
         LA    R0,N.TSKWRKA       ADDR OF TASK WORKAREA                 01170000
         ST    R0,N.TSK@WRKA      SET TASK WORKAREA ADDR                01180000
                                                                        01190000
         MVC   N.TSKNAME,=CL8'$INTTASK'   DEFAULT TASK NAME             01200000
         ICM   R1,R15,TPLNAME     ADDR OF TASK NAME                     01210000
         BZ    *+10               NONE, ASSUME DEFAULT                  01220000
         MVC   N.TSKNAME,0(R1)    INITIALIZE TASK NAME                  01230000
                                                                        01240000
         LA    R0,N.TSKERR        ADDR OF ERROR RECOVERY INFO           01250000
         ST    R0,N.TSK@ERR       SET ERROR RECOVERY ADDR               01260000
                                                                        01270000
         LA    R0,N.TSK$STOR      $ISTOR ACTIVE EXTENT LIST             01280000
         ST    R0,N.TSKSTORQ      COMMON LOCATOR FOR ALL WORKUNITS      01290000
                                                                        01300000
         LA    R0,N.TSKMSGQ       ADDR OF MESSAGE QUEUE                 01310000
         ST    R0,N.TSK@MSGQ      COMMON LOCATOR FOR ALL WORKUNITS      01320000
         LA    R0,N.TSKMSGL       ADDR OF MESSAGE LIST AFTER DEQUEUE    01330000
         ST    R0,N.TSK@MSGL      COMMON LOCATOR FOR ALL WORKUNITS      01340000
                                                                        01350000
         LA    R0,N.TSKMEPB       ADDR OF MESSAGE EPB                   01360000
         ST    R0,N.TSK@MEPB      COMMON LOCATOR FOR ALL WORKUNITS      01370000
                                                                        01380000
         LA    R0,N.TSKFRCA       ADDR OF FRAME CONTROL AREA            01390000
         ST    R0,N.TSK@FRCA      COMMON LOCATOR FOR ALL WORKUNITS      01400000
                                                                        01410000
         TM    TPLCFLGS,TPLC$AFF  TCB AFFINITY REQUIRED          159456 01420000
         BZ    *+8                NO, CONTINUE                   159456 01430000
         OI    N.TSKFLGS3,TSK3$AFF    TCB AFFINITY               159456 01440000
         ST    R11,N.TSKICVT      ICVT ADDRESS                   159456 01450000
                                                                        01460000
         C     R10,ICTTSKMN       IS THIS $INTMAIN ISSUING CREATE       01470000
         BNE   *+8                NO, NOT A 1ST LEVEL TASK              01480000
         OI    N.TSKFLGS3,TSK3$1LV SET AS 1ST LEVEL (SYSTEM) ITASK      01490000
                                                                        01500000
*---------------------------------------------------------------        01510000
*  CREATE STATIC QLOCK ENTRY USED FOR TASK LEVEL LOCK REQS              01520000
*---------------------------------------------------------------        01530000
         $GETSTOR QLOCKLN,OWNER=N.ITASK                                 01540000
                                                                        01550000
         $QLOCK INIT,ENTRY=(R1),ASSOC=N.ITASK                           01560000
                                                                        01570000
*---------------------------------------------------------------        01580000
*  Initialize task manager dispatch queue header                        01590000
*---------------------------------------------------------------        01600000
         @CALL ITSKDPIQ,(N.TSKDISPQ,FALSE,N.ITASK),              214761+01610000
               CTYPE=CVT,MF=(E,MFE_LIST)                         214761 01620000
                                                                        01630000
*---------------------------------------------------------------        01640000
*  INITIALIZE QUEUE HEADERS                                             01650000
*---------------------------------------------------------------        01660000
         LA    R1,N.TSKUSRQ-(USRNEXT-IUSER)                             01670000
         ST    R1,N.TSKUSRQ+4     USER    QUEUE LAST ENTRY              01680000
         LA    R1,N.TSKSUBQ-(TSKSIBL-ITASK)                             01690000
         ST    R1,N.TSKSUBQ+4     SUBTASK QUEUE LAST ENTRY              01700000
                                                                        01710000
         LA    R1,N.TSKXEPQR-(XEPBRNXT-XEPB)  REQUESTOR XEPB QUEUE      01720000
         ST    R1,N.TSKXEPQR+4                                          01730000
         LA    R1,N.TSKXEPQP-(XEPBPNXT-XEPB)  PROCESSOR XEPB QUEUE      01740000
         ST    R1,N.TSKXEPQP+4                                          01750000
                                                                        01760000
         L     R2,=A(#STGBLK)     LENGTH OF STG BLOCK                   01770000
         STGINIT (R2),QH=N.TSKSTG INITIALIZE ITASK STGQ                 01780000
         BNZ   ERR_STG            STG ERROR                             01790000
                                                                        01800000
*---------------------------------------------------------------        01810000
*  IF PARENT ITASK SUPPLIED,  ADD NEW ITASK TO PARENTS TASKQ            01820000
*---------------------------------------------------------------        01830000
         $SER  OBTAIN,DISP        OBTAIN DISP LOCK                      01840000
         B     *+4(R15)           BRANCH ON LOCK RETURN CODE            01850000
         B     LOCK_OBT           0 - LOCK OBTAINED                     01860000
         B     LOCK_HAV           4 - LOCK ALREADY OWNED                01870000
         B     ABN_LOCK           8 - LOCK OBTAIN FAILED                01880000
                                                                        01890000
LOCK_OBT DS    0H                                                       01900000
         OI    FLAGS,$LOCKED      INDICATE LOCK ACQUIRED                01910000
                                                                        01920000
LOCK_HAV DS    0H                                                       01930000
         ICM   R4,15,TPLTASK      ADDR OF REQUESTING ITASK              01940000
         BZ    INIT_QUE           NONE, SKIP                            01950000
P        USING ITASK,R4           ESTAB ADDR TO PARENT ITASK            01960000
                                                                        01970000
         L     R6,P.TSKSUBQ+4     ADDR OF LAST SUBTASK (SIBL)           01980000
L        USING ITASK,R6           ESTAB ADDR TO LAST SUBTASK            01990000
                                                                        02000000
         ST    R5,L.TSKSIBL       SET FORWARD POINTER                   02010000
         ST    R5,P.TSKSUBQ+4     SET LAST TASK POINTER                 02020000
         ST    R4,N.TSKOWNR       ADDR OF OWNING SUBTASK                02030000
                                                                        02040000
*---------------------------------------------------------------        02050000
*  ADD ITASK TO GLOBAL TASK QUEUE                                       02060000
*---------------------------------------------------------------        02070000
INIT_QUE DS    0H                                                       02080000
         L     R6,ICTTASKQ+4      ADDR OF LAST ITASK                    02090000
L        USING ITASK,R6           ESTAB ADDR TO LAST ITASK              02100000
         ST    R5,L.TSKNEXT       ADD NEW TASK TO QUEUE                 02110000
         ST    R5,ICTTASKQ+4      RESET NEW LAST TASK ADDR              02120000
                                                                        02130000
*---------------------------------------------------------------        02140000
*  INCREMENT TASK COUNTER                                               02150000
*---------------------------------------------------------------        02160000
INIT_CNT DS    0H                                                       02170000
         L     R1,ICT#TASK        CURRENT TASK COUNT                    02180000
         LA    R2,1(,R1)          INCREMENT TASK COUNT                  02190000
         CS    R1,R2,ICT#TASK     SAVE NEW TASK COUNT                   02200000
         BNE   INIT_CNT           RETRY                                 02210000
                                                                        02220000
         TM    FLAGS,$LOCKED      LOCK PREVIOUSLY ACQUIRED?             02230000
         BZ    INIT_SER                                                 02240000
         $SER  RELEASE,DISP       RELEASE DISP LOCK                     02250000
                                                                        02260000
INIT_SER DS    0H                                                       02270000
         LR    R1,R5              RETURN ITASK ADDRESS                  02280000
         LA    R15,RC00           NORMAL COMPLETION                     02290000
         B     RETURN             RETURN                                02300000
         DROP  N,L,P              DROP ITASK OCCURRANCES                02310000
                                                                        02320000
         EJECT ,                                                        02330000
****************************************************************        02340000
*                                                                       02350000
*   CATASTROPHIC ERRORS                                                 02360000
*                                                                       02370000
****************************************************************        02380000
                                                                        02390000
ABN_LOCK DS    0H                                                       02400000
         $ABEND ABE_DISPLOCK,                                          +02410000
               SCOPE=ITASK,                                            +02420000
               TITLE='UNABLE TO OBTAIN DISPATCHER LOCK'                 02430000
                                                                        02440000
         EJECT ,                                                        02450000
****************************************************************        02460000
*                                                                       02470000
*   ERROR EXIT                                                          02480000
*                                                                       02490000
****************************************************************        02500000
                                                                        02510000
ERR_STG  DS    0H                                                       02520000
         LA    R0,RSN04           STORAGE ALLOCATION ERROR              02530000
         B     RET_RC16           INTERNAL ERROR                        02540000
                                                                        02550000
         EJECT ,                                                        02560000
****************************************************************        02570000
*                                                                       02580000
*   RETURN                                                              02590000
*                                                                       02600000
****************************************************************        02610000
                                                                        02620000
                                                                        02630000
RET_RC16 DS    0H                                                       02640000
         LA    R15,RC16           ABNORMAL RETURN (INTERNAL ERR)        02650000
         B     RETURN                                                   02660000
                                                                        02670000
RETURN   DS    0H                                                       02680000
         #EXIT ,                  RETURN                                02690000
                                                                        02700000
         EJECT ,                                                        02710000
****************************************************************        02720000
*                                                                       02730000
*  CONSTANTS AND LITERALS                                               02740000
*                                                                       02750000
****************************************************************        02760000
                                                                        02770000
         LTORG ,                                                        02780000
                                                                        02790000
         PRINT NOGEN                                                    02800000
         ICVT  ,                                                        02810000
         IUSER ,                                                        02820000
                                                                        02830000
         END   ,                                                        02840000

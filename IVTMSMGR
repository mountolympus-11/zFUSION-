IVTMSMGR TITLE 'INTEGRATOR - VTAM ISESS RESOURCE MANAGER'               00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: IVTMSMGR - INTEGRATOR VTAM ISESS RESOURCE MANAGER            00100000
*                                                                       00110000
* DESCRIPTION: RESOURCE MANAGER CLEANUP FOR ISESS RESOURCES             00120000
*                                                                       00130000
* ON ENTRY:                                                             00140000
*                                                                       00150000
*    R15 = ENTRY POINT ADDRESS                                          00160000
*    R14 = RETURN ADDRESS                                               00170000
*    R13 = AVAILABLE SAVE AREA                                          00180000
*    R11 = ICVT ADDRESS                                                 00190000
*    R10 = ITASK ADDRESS                                                00200000
*    R01 = ISESS ADDRESS                                                00210000
*                                                                       00220000
* ON EXIT:                                                              00230000
*                                                                       00240000
*    R15 = 0                                                            00250000
*    R00 = 0                                                            00260000
*    R01 = 0                                                            00270000
*                                                                       00280000
*    ALL OTHER REGISTERS ARE RESTORED                                   00290000
*                                                                       00300000
*                                                                       00310000
**<DOC-OFF>************************************************************ 00320000
                                                                        00330000
         EJECT ,                                                        00340000
*********************************************************************** 00350000
*                                                                       00360000
* MAINTENANCE:                                                          00370000
*                                                                       00380000
*   08/01/93 RANDY WITEK                                                00390000
*   07/01/94 RANDY WITEK - LU6.2 SUPPORT                                00400000
*                                                                       00410000
*********************************************************************** 00420000
                                                                        00430000
         EQUS  ,                  GENERAL EQUATES                       00440000
                                                                        00450000
RICVT    EQU   R11                                                      00460000
RITASK   EQU   R10                                                      00470000
RIVTAM   EQU   R9                                                       00480000
RIVUSER  EQU   R8                                                       00490000
RISESS   EQU   R7                                                       00500000
RIWE     EQU   R6                                                       00510000
                                                                        00520000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00530000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00540000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00550000
         USING IVUSER,RIVUSER     ESTABLISH ADDRESSABILITY              00560000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00570000
         USING IWEVTAM,RIWE       ESTABLISH ADDRESSABILITY              00580000
         USING ISTDBIND,ISEBIND   ESTABLISH ADDRESSABILITY              00590000
                                                                        00600000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00610000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00620000
SUB1SAVE DS    18F                SUBROUTINE SAVE AREA                  00630000
WRK256   DS    XL256              GENERAL WORKAREA                      00640000
$TASKMFL $TASK MF=L               PLIST CONSTRUCTION                    00650000
$SESSMFL $SESS MF=L               PLIST CONSTRUCTION                    00660000
$WUMFL   $WULOC MF=L              PLIST CONSTRUCTION                    00670000
L62MFL   L62DFMD MF=L             PLIST CONSTRUCTION                    00680000
L62RETRC DS    F                  LU6.2 RETURN CODE RETURN AREA         00690000
CPI62ENT DS    XL(L'PCBENTKN)     ENTITY TOKEN OF PENDING CPIC CALL     00700000
CPI62EPB DS    A                  EPB ADDRESS  OF PENDING CPIC CALL     00710000
CPI62CDE DS    F                  POST CODE FOR   PENDING CPIC CALL     00720000
DESC@    DS    F                  USED FOR TRACE FUNCTION               00730000
DESCLEN  DS    F                  USED FOR TRACE FUNCTION               00740000
TRACE@   DS    F                  USED FOR TRACE FUNCTION               00750000
TRACELEN DS    F                  USED FOR TRACE FUNCTION               00760000
WUDATA   DS    XL16               $WULOC USERDATA RETURN AREA           00770000
SQEATOK  DS    CL8                ASSOCIATED SESSION TOKEN              00780000
SQEENT   DS    XL8                ASSOCIATED ENTITY TOKEN               00790000
SQESPL   DS    A                  ASSOCIATED SPL ADDRESS                00800000
RETR15   DS    F                  RETURN CODE VALUE                     00810000
RETR0    DS    F                  RETURN REGISTER 0                     00820000
RETR1    DS    F                  RETURN REGISTER 1                     00830000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00840000
FLAG     DS    X                                                        00850000
FLAGLOCK EQU   X'80'              VTAM LOCK IS HELD                     00860000
FLAGLCKD EQU   X'40'              VTAM LOCK WAS HELD ON ENTRY           00870000
FLAGDLCK EQU   X'20'              DISP LOCK HELD                        00880000
FLAGDLKD EQU   X'10'              DISP LOCK WAS HELD ON ENTRY           00890000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00900000
                                                                        00910000
         $MSGDFT PREFIX=ICTPID,                                        +00920000
               COMPID='VTM',                                           +00930000
               TABLE=*#MSGS,                                           +00940000
               WORKA=0,                                                +00950000
               MF=(E,WRK256),                                          +00960000
               PRINT=NOGEN                                              00970000
                                                                        00980000
IVTMSMGR #ENTER BASE=R12,         ENTRY LINKAGE                        +00990000
               PREG=RISESS,                                            +01000000
               AMODE=31,                                               +01010000
               RMODE=ANY                                                01020000
                                                                        01030000
*---------------------------------------------------------------------- 01040000
* RESOURCE MANAGER CLEANUP FOR ISESS PROC                               01050000
*---------------------------------------------------------------------- 01060000
                                                                        01070000
*                                                                       01080000
* VERIFY ISESS BLOCK ON ENTRY                                           01090000
*---------------------------------------------------------------------- 01100000
                                                                        01110000
         CLC   ISEID,=CL8'ISESS'  VALID ISESS BLOCK?                    01120000
         BNE   ERRSTERM           BRANCH IF NOT                         01130000
                                                                        01140000
*                                                                       01150000
* ESTABLISH ENVIRONMENT                                                 01160000
*---------------------------------------------------------------------- 01170000
                                                                        01180000
         L     RIVTAM,ICTVTCVT    IVTAMCVT ADDRESSIBILITY               01190000
         L     RIVUSER,ISEIVUSR   IVUSER   ADDRESSIBILITY               01200000
                                                                        01210000
*                                                                       01220000
* ISSUE AN INFORMATIVE MESSAGE AND CUT A TRACE RECORD                   01230000
*---------------------------------------------------------------------- 01240000
                                                                        01250000
         $TRACE *=A(TRC_ISESS_END),32    TRACE ENTRY WITH 32 USER BYTES 01260000
                                                                        01270000
         BNZ   NOSTRACE                  BRANCH IF NOT TRACING          01280000
                                                                        01290000
         ST    RISESS,0(,R1)             TRACE ISESS ADDRESS            01300000
         MVC   4(4,R1),ISECID            TRACE VTAM CID                 01310000
         MVC   8(8,R1),ISETK             TRACE SESSION TOKEN            01320000
         MVC   16(8,R1),TSKNAME          TRACE TASK NAME (I.E. PLUNAME) 01330000
         L     R15,ISEACB@               ADDRESS OF IACB                01340000
         MVC   24(8,R1),IACNAME-IAC(R15) TRACE IACB NAME                01350000
                                                                        01360000
NOSTRACE DS    0H                                                       01370000
                                                                        01380000
                                                                        01390000
         $MSG  983,                                                    +01400000
               FIELDS=((RISESS),         "ISESS HAS ENDED" MESSAGE     +01410000
               (ISETKUSR,4),             IVUSER TOKEN                  +01420000
               (ISETKSES,4),             ISESS  TOKEN                  +01430000
               ISE#MSGI,ISE#BYTI,ISE#MSGO,ISE#BYTO)                     01440000
                                                                        01450000
*                                                                       01460000
* DELETE SESSION INITIATION QUEUE ELEMENT IF THERE IS ONE               01470000
*---------------------------------------------------------------------- 01480000
                                                                        01490000
         BAS   R14,VTAMLOCK                                             01500000
                                                                        01510000
         $VTAM FINDISQE,                                               +01520000
               AREA=ISETK,                                             +01530000
               ERRET=NOISQE,                                           +01540000
               MF=(E,MFE_LIST)       CHECK FOR AN ISQE FOR THIS SESS    01550000
                                                                        01560000
         LR    R3,R1                   R3 HAS ISQE ADDRESS              01570000
         MVC   SQEATOK,ISQATOK-ISQ(R3) SAVE ASSC. SESSION TOKEN IF ANY  01580000
         MVC   SQEENT,ISQENT-ISQ(R3)   SAVE ASSC. ENTITY TOKEN IF ANY   01590000
         MVC   SQESPL,ISQSPL-ISQ(R3)   SAVE ASSC. SPL ADDR IF ANY       01600000
                                                                        01610000
         $VTAM RETISQE,                                                +01620000
               AREA=ISQTOKEN-ISQ(,R3),                                 +01630000
               MF=(E,MFE_LIST)    DELETE THE ISQE FROM CHAIN            01640000
                                                                        01650000
         OC    SQEATOK,SQEATOK    IS THERE AN ASSOCIATED REQUESTOR?     01660000
         BZ    CKENTITY           BRANCH IF NOT                         01670000
                                                                        01680000
         $SESS $SESS_FIND_SESSION,                                     +01690000
               SESSION=SQEATOK,                                        +01700000
               ERRET=NOISQE,                                           +01710000
               MF=(E,$SESSMFL)    LOCATE ASSOCIATED ISESS, IF ANY       01720000
                                                                        01730000
X        USING SPLIST,$SESSMFL                                          01740000
         L     R4,X.SPLAREA       ADDRESS OF ASSOCIATED ISESS BLOCK     01750000
         DROP  X                                                        01760000
                                                                        01770000
         LA    R4,ISEWEQ-ISE(,R4) ADDRESS OF ASSOCIATED WORK QUEUE      01780000
                                                                        01790000
         $VTAMWE L'IWEXM,         SIZE                                 +01800000
               IWECSICM           CODE (SESS INIT COMPLETION)           01810000
                                                                        01820000
         LR    RIWE,R1            ADDRESS OF WORK ELEMENT               01830000
                                                                        01840000
         MVC   IWEXMRET,=A($SESS_RC_CANCELED)                           01850000
         MVC   IWEXMATK,SQEATOK   SET ASSOCIATED SESSION TOKEN          01860000
                                                                        01870000
         LR    R1,R4              QUEUE ADDRESS                         01880000
         BAS   R14,QWE            GO QUEUE THE WORK ELEMENT             01890000
         B     NOISQE                                                   01900000
                                                                        01910000
CKENTITY DS    0H                                                       01920000
                                                                        01930000
         OC    SQEENT,SQEENT      IS THERE AN ASSOCIATED REQUESTOR?     01940000
         BZ    NOISQE             BRANCH IF NOT                         01950000
         BAS   R14,DISPLOCK       SERIALIZE                             01960000
                                                                        01970000
         $WULOC LOCATE,           FIND THE WORK UNIT                   +01980000
               TOKEN=SQEENT,      WORK UNIT TOKEN ADDRESS              +01990000
               USERDATA=WUDATA,   XL16 AREA TO RECEIVE USER DATA       +02000000
               MF=(E,$WUMFL)      VALIDATE WORK UNIT                    02010000
                                                                        02020000
         LTR   R15,R15            LOCATE SUCCESS?                       02030000
         BNZ   L62POST            BRANCH IF NOT                         02040000
                                                                        02050000
         L     R1,SQESPL          ASSOC. SPL ADDRESS                    02060000
X        USING SPLIST,R1                                                02070000
         MVC   X.SPLRETCD,=A($SESS_RC_CANCELED)                         02080000
         L     R2,X.SPLEPB                                              02090000
         L     R15,IVT@ATSP       $SESS TRACE ROUTINE                   02100000
         BASR  R14,R15            TRACE IT                              02110000
         DROP  X                                                        02120000
                                                                        02130000
L62POST  DS    0H                                                       02140000
                                                                        02150000
         L62POST (R2),            ADDRESS OF EPB TO BE POSTED          +02160000
               =F'0',             ADDRESS OF POST CODE                 +02170000
               SQEENT,            ADDRESS OF ENTITY TOKEN              +02180000
               L62RETRC,          RETURN CODE AREA                     +02190000
               MF=(E,L62MFL)                                            02200000
                                                                        02210000
         BAS   R14,DISPUNLK           RELEASE THE LOCK IF NECESSARY     02220000
                                                                        02230000
NOISQE   DS    0H                                                       02240000
                                                                        02250000
*                                                                       02260000
* REMOVE ISESS FROM THE CHAIN OF ALL ISESS'S                            02270000
*---------------------------------------------------------------------- 02280000
                                                                        02290000
         $SESS $SESS_DELETE_SESSION, DELETE ISESS FROM IVUSER CHAIN    +02300000
               SESSION=ISETK,        THIS IS THE TOKEN                 +02310000
               AREA=(RISESS),        THIS IS THE ISESS BLOCK           +02320000
               ERRET=ERR$SESS,                                         +02330000
               MF=(E,$SESSMFL)                                          02340000
                                                                        02350000
         ICM   R1,15,ISEACB@         IS SESSION ASSOCIATED WITH IACB?   02360000
         BZ    PTRMNACB              BRANCH IF NOT                      02370000
                                                                        02380000
         $VTAM DELISESS,                                               +02390000
               AREA=(RISESS),                                          +02400000
               ERRET=ERR$VTAM,                                         +02410000
               MF=(E,MFE_LIST)       DELETE ISESS FROM IACB CHAIN       02420000
                                                                        02430000
PTRMNACB DS    0H                                                       02440000
                                                                        02450000
*                                                                       02460000
* REMOVE LU6.2 SESSION FROM THE FREE SESSION QUEUE...IF QUEUED          02470000
*---------------------------------------------------------------------- 02480000
                                                                        02490000
         CLC   BINLUP(2),=X'0602'       LU TYPE 6.2?                    02500000
         BNE   NOT62FRE                 BRANCH IF NOT                   02510000
                                                                        02520000
         LM    R14,R15,ISE62FSN         FREE SESSION QUEUE LINKS        02530000
         LTR   R14,R14                  IS SESSION ON THE QUEUE?        02540000
         BZ    NOT62FRE                 BRANCH IF NOT                   02550000
         ST    R15,ISE62FSP-ISESS(,R14) LINK NEXT TO PREVIOUS           02560000
         ST    R14,ISE62FSN-ISESS(,R15) LINK PREVIOUS TO NEXT           02570000
         XC    ISE62FSN,ISE62FSN        NO LONGER ON QUEUE              02580000
         XC    ISE62FSP,ISE62FSP        NO LONGER ON QUEUE              02590000
                                                                        02600000
NOT62FRE DS    0H                                                       02610000
                                                                        02620000
         BAS   R14,VTAMUNLK                                             02630000
                                                                        02640000
*                                                                       02650000
* CANCEL ANY ACTIVE SESSION TIMERS                                      02660000
*---------------------------------------------------------------------- 02670000
                                                                        02680000
         $SESSTMR CANCEL,                                              +02690000
               SESSION=(RISESS),                                       +02700000
               CLASS=$SESSTMR_CLASS_BIND,                              +02710000
               MF=(E,MFE_LIST)                                          02720000
                                                                        02730000
         $SESSTMR CANCEL,                                              +02740000
               SESSION=(RISESS),                                       +02750000
               CLASS=$SESSTMR_CLASS_RECEIVE_DATA,                      +02760000
               MF=(E,MFE_LIST)                                          02770000
                                                                        02780000
*                                                                       02790000
* FREE ANY USERDATA COPY                                                02800000
*---------------------------------------------------------------------- 02810000
                                                                        02820000
         ICM   R3,15,ISEUDAT@      IS THERE ANY USER DATA?              02830000
         BZ    PTRMNOUD            BRANCH IF NOT                        02840000
                                                                        02850000
         $RETSTOR (R3),                                                +02860000
               OWNER=(RITASK)      FREE THE USERDATA COPY               02870000
                                                                        02880000
         XC    ISEUDAT@,ISEUDAT@   SHOW IT IS RELEASED                  02890000
         XC    ISEUDATL,ISEUDATL   SHOW IT IS RELEASED                  02900000
                                                                        02910000
PTRMNOUD DS    0H                                                       02920000
                                                                        02930000
*                                                                       02940000
* FREE ANY CONTROL VECTORS COPY                                         02950000
*---------------------------------------------------------------------- 02960000
                                                                        02970000
         ICM   R3,15,ISECVEC@      ARE THERE ANY CONTROL VECTORS?       02980000
         BZ    PTRMNOCV            BRANCH IF NOT                        02990000
                                                                        03000000
         $RETSTOR (R3),                                                +03010000
               OWNER=(RITASK)      FREE THE CONTROL VECTORS COPY        03020000
                                                                        03030000
         XC    ISECVEC@,ISECVEC@   SHOW IT IS RELEASED                  03040000
         XC    ISECVECL,ISECVECL   SHOW IT IS RELEASED                  03050000
                                                                        03060000
PTRMNOCV DS    0H                                                       03070000
                                                                        03080000
*                                                                       03090000
* FREE ANY QUERY DATA                                                   03100000
*---------------------------------------------------------------------- 03110000
                                                                        03120000
         CLI   BINLUP,BINLUP2C    LU2 SESSION?                          03130000
         BE    PTRMFRQR           BRANCH IF YES                         03140000
         CLI   BINLUP,BINLUP0C    LU0 SESSION?                          03150000
         BNE   PTRMNOQR           BRANCH IF NOT                         03160000
                                                                        03170000
PTRMFRQR DS    0H                                                       03180000
                                                                        03190000
         ICM   R3,15,ISEQRP        QUERY REPLY COPY?                    03200000
         BZ    PTRMNOQR            BRANCH IF NOT                        03210000
                                                                        03220000
         $RETSTOR (R3),                                                +03230000
               OWNER=(RITASK)      FREE THE QUERY REPLY COPY            03240000
                                                                        03250000
         XC    ISEQRP,ISEQRP       SHOW IT IS RELEASED                  03260000
         XC    ISEQRPL,ISEQRPL     SHOW IT IS RELEASED                  03270000
                                                                        03280000
PTRMNOQR DS    0H                                                       03290000
                                                                        03300000
*                                                                       03310000
* FREE ANY OUTSTANDING REQUEST SPLISTS THAT ARE QUEUED                  03320000
*---------------------------------------------------------------------- 03330000
                                                                        03340000
         ICM   R2,15,ISEISPL       ANY INTERNAL SPLIST DANGLING?        03350000
         BZ    PTRMFREE            BRANCH IF NOT                        03360000
                                                                        03370000
         $RETSTOR (R2),                                                +03380000
               OWNER=(RITASK)      FREE THE SPLIST                      03390000
                                                                        03400000
PTRMFRER DS    0H                                                       03410000
                                                                        03420000
         XC    ISEISPL,ISEISPL     SHOW IT IS RELEASED                  03430000
         ICM   R3,15,ISERQRCV      ANY RECEIVE REQUEST PENDING?         03440000
         BZ    PTRMFRES            BRANCH IF NO                         03450000
         CR    R2,R3               IS IT THE INTERNAL SPLIST?           03460000
         BE    PTRMFRES            BRANCH IF YES                        03470000
                                                                        03480000
         $RETSTOR (R3),                                                +03490000
               OWNER=(RITASK)      FREE THE SPLIST                      03500000
                                                                        03510000
PTRMFRES DS    0H                                                       03520000
                                                                        03530000
         XC    ISERQRCV,ISERQRCV   SHOW IT IS RELEASED                  03540000
         ICM   R3,15,ISERQSND      ANY SEND REQUEST PENDING?            03550000
         BZ    PTRMFREI            BRANCH IF NOT                        03560000
         CR    R2,R3               IS IT THE INTERNAL SPLIST?           03570000
         BE    PTRMFREI            BRANCH IF YES                        03580000
                                                                        03590000
         $RETSTOR (R3),                                                +03600000
               OWNER=(RITASK)      FREE THE SPLIST                      03610000
                                                                        03620000
PTRMFREI DS    0H                                                       03630000
                                                                        03640000
         XC    ISERQSND,ISERQSND   SHOW IT IS RELEASED                  03650000
         ICM   R3,15,ISERQSIR      ANY SESS INIT REQUEST PENDING?       03660000
         BZ    PTRMFREP            BRANCH IF NOT                        03670000
         CR    R2,R3               IS IT THE INTERNAL SPLIST?           03680000
         BE    PTRMFREP            BRANCH IF YES                        03690000
                                                                        03700000
         $RETSTOR (R3),                                                +03710000
               OWNER=(RITASK)      FREE THE SPLIST                      03720000
                                                                        03730000
PTRMFREP DS    0H                                                       03740000
                                                                        03750000
         XC    ISERQSIR,ISERQSIR   SHOW IT IS RELEASED                  03760000
         ICM   R3,15,ISERQRSP      ANY SEND RESP REQUEST PENDING?       03770000
         BZ    PTRMFREE            BRANCH IF NOT                        03780000
         CR    R2,R3               IS IT THE INTERNAL SPLIST?           03790000
         BE    PTRMFREE            BRANCH IF YES                        03800000
                                                                        03810000
         $RETSTOR (R3),                                                +03820000
               OWNER=(RITASK)      FREE THE SPLIST                      03830000
                                                                        03840000
PTRMFREE DS    0H                                                       03850000
                                                                        03860000
         XC    ISERQRSP,ISERQRSP   SHOW IT IS RELEASED                  03870000
                                                                        03880000
*                                                                       03890000
* FREE ANY RECEIVE QUEUE ELEMENTS THAT ARE PRESENT                      03900000
*---------------------------------------------------------------------- 03910000
                                                                        03920000
         L     R3,ISERCVQ          FIRST ELEMENT IN RECEIVE QUEUE       03930000
                                                                        03940000
PTRMFRQE DS    0H                                                       03950000
                                                                        03960000
         LTR   R3,R3               END OF IRQE CHAIN?                   03970000
         BNP   PTRMFRQD            BRANCH IF YES                        03980000
         LR    R4,R3               IRQE TO BE FREED                     03990000
         L     R3,IRQNEXT-IRQ(,R3) NEXT IRQE                            04000000
                                                                        04010000
X        USING IRQE,R4                                                  04020000
                                                                        04030000
         TM    X.IRQF1,IRQF1SHP+IRQF1CFM+IRQF1RTS+IRQF1REC+IRQF1SER     04040000
         BNZ   POSTREQ1                                                 04050000
         TM    X.IRQF1,IRQF1BID    BID REQUEST?                         04060000
         BO    POSTREQ2            BRANCH IF YES                        04070000
         TM    X.IRQF2,IRQF2BS     BID SYNC?                            04080000
         BO    POSTREQ2            BRANCH IF YES                        04090000
         TM    X.IRQF2,IRQF2CLP    TP CLEANUP?                          04100000
         BO    POSTREQ1            BRANCH IF YES                        04110000
         B     FREEIRQE                                                 04120000
                                                                        04130000
POSTREQ1 DS    0H                                                       04140000
                                                                        04150000
         MVC   CPI62ENT,X.IRQ62ENT COPY POSTING INFORMATION             04160000
         MVC   CPI62EPB,X.IRQ62EPB COPY POSTING INFORMATION             04170000
         MVI   CPI62CDE+(L'CPI62CDE-1),CM_RESOURCE_FAILURE_NO_RETRY     04180000
         BAS   R14,POSTCPIC        POST THE USER                        04190000
         B     FREEIRQE                                                 04200000
                                                                        04210000
POSTREQ2 DS    0H                                                       04220000
                                                                        04230000
Y        USING AQE,R2                                                   04240000
                                                                        04250000
         L     R2,X.IRQ62AQE       GET AQE ADDRESS                      04260000
         MVC   CPI62ENT,Y.AQEENT   COPY POSTING INFORMATION             04270000
         MVC   CPI62EPB,Y.AQEEPB   COPY POSTING INFORMATION             04280000
         MVI   CPI62CDE+(L'CPI62CDE-1),4                                04290000
         BAS   R14,POSTCPIC        POST THE USER                        04300000
         B     FREEIRQE                                                 04310000
                                                                        04320000
         DROP  Y                                                        04330000
         DROP  X                                                        04340000
                                                                        04350000
FREEIRQE DS    0H                                                       04360000
                                                                        04370000
         $RETSTOR (R4),                                                +04380000
               OWNER=(RITASK)      RELEASE THE IRQE                     04390000
                                                                        04400000
         B     PTRMFRQE            GO RELEASE THE NEXT                  04410000
                                                                        04420000
PTRMFRQD DS    0H                                                       04430000
                                                                        04440000
*                                                                       04450000
* REMOVE THE REMOTE EPB USED FOR WORK ELEMENTS                          04460000
*---------------------------------------------------------------------- 04470000
                                                                        04480000
         $TASK REMEPB,                                                 +04490000
               EPB=ISEWEEPB,                                           +04500000
               MF=(E,$TASKMFL)    REMOVE WORK EPB                       04510000
                                                                        04520000
*                                                                       04530000
* RELEASE ANY DANGLING WORK ELEMENTS ON THE ISEWEQ                      04540000
*---------------------------------------------------------------------- 04550000
                                                                        04560000
*                                                                       04570000
* RELEASE RPLS, DATA BUFFERS, ETC.                                      04580000
*---------------------------------------------------------------------- 04590000
                                                                        04600000
         L     RIWE,ISELASTW         ADDRESS OF LAST WORK PROCESSED     04610000
                                                                        04620000
PTRMFRWE DS    0H                                                       04630000
                                                                        04640000
         LTR   RIWE,RIWE             IS THERE AN IWE?                   04650000
         BZ    PTRMFRED              BRANCH IF NOT                      04660000
         LR    R2,RIWE               IWE TO BE FREED                    04670000
         L     RIWE,IWELINK          LINK TO NEXT IWE                   04680000
                                                                        04690000
         $VTAMFWE (R2)               RELEASE THE DANGLING WORK ELEMENT  04700000
                                                                        04710000
         B     PTRMFRWE              RELEASE THE NEXT ONE               04720000
                                                                        04730000
PTRMFRED DS    0H                                                       04740000
                                                                        04750000
*                                                                       04760000
* IF THE SESSION IS STILL ACTIVE, QUEUE A KILL SESSION TO MAIN TASK     04770000
*---------------------------------------------------------------------- 04780000
                                                                        04790000
         TM    ISEF1,ISEF1ACT     IS THE SESSION ACTIVE?                04800000
         BNO   PTRMNACT           BRANCH IF NOT                         04810000
                                                                        04820000
         $VTAMWE L'IWEXL,                                              +04830000
               IWECKILL           ALLOCATE "KILL SESSION" WORK ELEMENT  04840000
                                                                        04850000
         LR    RIWE,R1            SAVE WORK ELEMENT ADDRESS             04860000
         MVC   IWEXLCID,ISECID    PASS THE SESSION CID TO KILL          04870000
         MVC   IWEXLACB,ISEACB@   PASS THE SESSION ACB ADDRESS          04880000
         TM    ISEF2,ISEF2SLU     ARE WE THE SLU PARTNER?               04890000
         BNO   PTRMNSLU           BRANCH IF NOT                         04900000
         MVC   IWEXLSLU,=F'-1'    NON-ZERO --> WE ARE SLU PARTNER       04910000
         MVC   IWEXLPNM,ISERLUNM  PASS PLU NAME                         04920000
         MVC   IWEXLSNM,ISEILUNM  PASS SLU NAME                         04930000
         B     PTRMQKIL                                                 04940000
                                                                        04950000
PTRMNSLU DS    0H                                                       04960000
                                                                        04970000
         MVC   IWEXLPNM,ISEILUNM  PASS PLU NAME                         04980000
         MVC   IWEXLSNM,ISERLUNM  PASS SLU NAME                         04990000
                                                                        05000000
PTRMQKIL DS    0H                                                       05010000
                                                                        05020000
         LA    R1,IVTWEQ          WORK QUEUE ADDRESS                    05030000
         BAS   R14,QWE            QUEUE KILL SESSION ELEMENT TO MAIN    05040000
                                                                        05050000
PTRMNACT DS    0H                                                       05060000
                                                                        05070000
*                                                                       05080000
* IF THERE ARE PENDING BINDS, QUEUE A KILL SESSION TO MAIN TASK         05090000
*---------------------------------------------------------------------- 05100000
                                                                        05110000
         ICM   R3,15,ISEBQSIM     QUEUED SIMLOGON BIND?                 05120000
         BZ    PTRMNSIM           BRANCH IF NOT                         05130000
                                                                        05140000
         $VTAMWE L'IWEXL,                                              +05150000
               IWECKILL           ALLOCATE "KILL SESSION" WORK ELEMENT  05160000
                                                                        05170000
X        USING IBQE,R3                                                  05180000
         LR    RIWE,R1            SAVE WORK ELEMENT ADDRESS             05190000
         OI    ILF1,ILF1BIND      SHOW PENDING BIND IS TO BE KILLED     05200000
         MVC   IWEXLCID,X.IBQCID  PASS THE SESSION CID TO KILL          05210000
         MVC   IWEXLACB,X.IBQACB  PASS THE SESSION ACB ADDRESS          05220000
         MVC   IWEXLPNM,X.IBQLU   PASS PLU NAME                         05230000
         MVC   IWEXLSNM,ISEILUNM  PASS SLU NAME                         05240000
         LA    R1,IVTWEQ          WORK QUEUE ADDRESS                    05250000
         BAS   R14,QWE            QUEUE KILL SESSION ELEMENT TO MAIN    05260000
         DROP  X                                                        05270000
                                                                        05280000
         $RETSTOR (R3),                                                +05290000
               OWNER=(RITASK)     RELEASE THE IBQE                      05300000
                                                                        05310000
         XC    ISEBQSIM,ISEBQSIM  SHOW NO SIMLOGON BIND QUEUED          05320000
                                                                        05330000
PTRMNSIM DS    0H                                                       05340000
                                                                        05350000
         ICM   R3,15,ISEBQPAS     QUEUED CLSDST PASS BIND?              05360000
         BZ    PTRMNPAS           BRANCH IF NOT                         05370000
                                                                        05380000
         $VTAMWE L'IWEXL,                                              +05390000
               IWECKILL           ALLOCATE "KILL SESSION" WORK ELEMENT  05400000
                                                                        05410000
X        USING IBQE,R3                                                  05420000
         LR    RIWE,R1            SAVE WORK ELEMENT ADDRESS             05430000
         OI    ILF1,ILF1BIND      SHOW PENDING BIND IS TO BE KILLED     05440000
         MVC   IWEXLCID,X.IBQCID  PASS THE SESSION CID TO KILL          05450000
         MVC   IWEXLACB,X.IBQACB  PASS THE SESSION ACB ADDRESS          05460000
         MVC   IWEXLPNM,X.IBQLU   PASS PLU NAME                         05470000
         MVC   IWEXLSNM,ISEILUNM  PASS SLU NAME                         05480000
         LA    R1,IVTWEQ          WORK QUEUE ADDRESS                    05490000
         BAS   R14,QWE            QUEUE KILL SESSION ELEMENT TO MAIN    05500000
         DROP  X                                                        05510000
                                                                        05520000
         $RETSTOR (R3),                                                +05530000
               OWNER=(RITASK)     RELEASE THE IBQE                      05540000
                                                                        05550000
         XC    ISEBQPAS,ISEBQPAS  SHOW NO CLSDST PASS BIND QUEUED       05560000
                                                                        05570000
PTRMNPAS DS    0H                                                       05580000
                                                                        05590000
*                                                                       05600000
* IF THE "LOGON SESSION" IS TERMINATING, STOP THE IVUSER COMPLETELY     05610000
*---------------------------------------------------------------------- 05620000
                                                                        05630000
         TM    ISEF1,ISEF1LGN     IS THIS THE "LOGON" SESSION?          05640000
         BNO   PTRMNLGN           BRANCH IF NOT                         05650000
                                                                        05660000
         $VTAMWE L'IWEXI,                                              +05670000
               IWECSTPU           ALLOCATE "STOP USER" WORK ELEMENT     05680000
                                                                        05690000
         LR    RIWE,R1            SAVE WORK ELEMENT ADDRESS             05700000
         LA    R1,IVUWEQ          WORK QUEUE ADDRESS                    05710000
         BAS   R14,QWE            QUEUE STOP WORK ELEMENT TO IVUSER     05720000
                                                                        05730000
PTRMNLGN DS    0H                                                       05740000
                                                                        05750000
*                                                                       05760000
* START LU6.2 CLEANUP                                                   05770000
*---------------------------------------------------------------------- 05780000
                                                                        05790000
         CLC   BINLUP(2),=X'0602' LU TYPE 6.2?                          05800000
         BNE   PTRMNO62           BRANCH IF NOT                         05810000
                                                                        05820000
*                                                                       05830000
* IF THERE IS AN SBUF PLIST, RELEASE THE BUFFER & THE SBUF PLIST        05840000
*---------------------------------------------------------------------- 05850000
                                                                        05860000
         ICM   R3,15,ISE62SBF     IS THERE AN SBUF PLIST?               05870000
         BZ    PTRMNSBF           BRANCH IF NOT                         05880000
                                                                        05890000
         SBUF  RELEASE,                                                +05900000
               ERRET=ERRSBUF,                                          +05910000
               MF=(E,(R3))        RELEASE CURRENT BUFFER...IF ANY       05920000
                                                                        05930000
         $RETSTOR (R3),                                                +05940000
               OWNER=(RITASK)     RELEASE THE SBUF PLIST                05950000
                                                                        05960000
PTRMNSBF DS    0H                                                       05970000
                                                                        05980000
*                                                                       05990000
* IF AN LU6.2 SESSION IS TERMINATING, QUEUE A SESSION DEACTIVATED       06000000
*---------------------------------------------------------------------- 06010000
                                                                        06020000
         OC    ISE62MDE,ISE62MDE  SESSION TIED TO LU6.2 MDE?            06030000
         BZ    PTRMNMDE           BRANCH IF NOT                         06040000
                                                                        06050000
         $VTAMWE L'IWEXT,                                              +06060000
               IWECSDAC           ALLOCATE "SESSION DEACTIVATED" WE     06070000
                                                                        06080000
         LR    RIWE,R1            SAVE WORK ELEMENT ADDRESS             06090000
         MVC   IWEXTMDE,ISE62MDE  SET MDE ADDRESS                       06100000
         MVC   IWEXTNME,ISELOGMD  SET MODE NAME                         06110000
         MVC   IWEXTTKN,ISETK     SET SESSION TOKEN                     06120000
                                                                        06130000
         TM    BINCMNP2,BINBKFS   IS THIS A CONWINNER SESSION?          06140000
         BNO   *+8                BRANCH IF NOT                         06150000
         OI    ITF1,ITF1CNWN      FLAG CONWINNER ENDED                  06160000
                                                                        06170000
         TM    ISE62FL3,ISE62TRM  WAS SESSION PENDING TERMINATION?      06180000
         BNO   *+8                BRANCH IF NOT                         06190000
         OI    ITF1,ITF1PEND      FLAG THAT SESSION WAS PENDING TERM    06200000
                                                                        06210000
         LA    R1,IVUWEQ          WORK QUEUE ADDRESS                    06220000
         BAS   R14,QWE            QUEUE STOP WORK ELEMENT TO IVUSER     06230000
                                                                        06240000
PTRMNMDE DS    0H                                                       06250000
                                                                        06260000
*                                                                       06270000
* POST PENDING CPI-C RECEIVE COMPLETE                                   06280000
*---------------------------------------------------------------------- 06290000
                                                                        06300000
X        USING SPLIST,R1                                                06310000
                                                                        06320000
         ICM   R1,15,ISE62RRQ               PENDING RECEIVE?            06330000
         BNP   NO62RCV                      BRANCH IF NOT               06340000
         MVC   CPI62ENT,X.SPL62ENT          COPY POSTING INFORMATION    06350000
         MVC   CPI62EPB,X.SPL62EPB          COPY POSTING INFORMATION    06360000
         MVI   CPI62CDE+(L'CPI62CDE-1),CM_RESOURCE_FAILURE_NO_RETRY     06370000
         BAS   R14,POSTCPIC                 POST THE USER               06380000
         XC    X.SPLAREA,X.SPLAREA          AREA NOT USED FOR CPIC RCV  06390000
         XC    X.SPLAREAL,X.SPLAREAL        AREA NOT USED FOR CPIC RCV  06400000
         BAS   R14,SPLFREE                  RELEASE THE SPLIST          06410000
                                                                        06420000
         DROP  X                                                        06430000
                                                                        06440000
NO62RCV  DS    0H                                                       06450000
                                                                        06460000
*                                                                       06470000
* POST PENDING CPI-C SHIP COMPLETE                                      06480000
*---------------------------------------------------------------------- 06490000
                                                                        06500000
X        USING SPLIST,R1                                                06510000
                                                                        06520000
         ICM   R1,15,ISE62SRQ               PENDING SHIP?               06530000
         BNP   NO62SHP                      BRANCH IF NOT               06540000
         MVC   CPI62ENT,X.SPL62ENT          COPY POSTING INFORMATION    06550000
         MVC   CPI62EPB,X.SPL62EPB          COPY POSTING INFORMATION    06560000
         MVI   CPI62CDE+(L'CPI62CDE-1),CM_RESOURCE_FAILURE_NO_RETRY     06570000
         BAS   R14,POSTCPIC                 POST THE USER               06580000
         XC    X.SPLAREA,X.SPLAREA          AREA WAS FREED AS SBUF      06590000
         XC    X.SPLAREAL,X.SPLAREAL        AREA WAS FREED AS SBUF      06600000
         BAS   R14,SPLFREE                  RELEASE THE SPLIST          06610000
                                                                        06620000
         DROP  X                                                        06630000
                                                                        06640000
NO62SHP  DS    0H                                                       06650000
                                                                        06660000
*                                                                       06670000
* POST PENDING CPI-C BID COMPLETE                                       06680000
*---------------------------------------------------------------------- 06690000
                                                                        06700000
X        USING SPLIST,R1                                                06710000
Y        USING AQE,R2                                                   06720000
                                                                        06730000
         ICM   R1,15,ISE62BRQ               PENDING BID?                06740000
         BNP   NO62BID                      BRANCH IF NOT               06750000
         L     R2,X.SPL62AQE                GET AQE ADDRESS             06760000
         MVC   CPI62ENT,Y.AQEENT            COPY POSTING INFORMATION    06770000
         MVC   CPI62EPB,Y.AQEEPB            COPY POSTING INFORMATION    06780000
         MVI   CPI62CDE+(L'CPI62CDE-1),4    REQUEST FAILURE             06790000
         BAS   R14,POSTCPIC                 POST THE USER               06800000
         XC    X.SPLAREA,X.SPLAREA          AREA WAS FREED AS SBUF      06810000
         XC    X.SPLAREAL,X.SPLAREAL        AREA WAS FREED AS SBUF      06820000
         BAS   R14,SPLFREE                  RELEASE THE SPLIST          06830000
                                                                        06840000
         DROP  Y                                                        06850000
         DROP  X                                                        06860000
                                                                        06870000
NO62BID  DS    0H                                                       06880000
                                                                        06890000
*                                                                       06900000
* POST PENDING CPI-C CLEANUP COMPLETE                                   06910000
*---------------------------------------------------------------------- 06920000
                                                                        06930000
X        USING SPLIST,R1                                                06940000
                                                                        06950000
         ICM   R1,15,ISE62CRQ               PENDING CLEANUP?            06960000
         BNP   NO62CLUP                     BRANCH IF NOT               06970000
         MVC   CPI62ENT,X.SPL62ENT          COPY POSTING INFORMATION    06980000
         MVC   CPI62EPB,X.SPL62EPB          COPY POSTING INFORMATION    06990000
         MVI   CPI62CDE+(L'CPI62CDE-1),CM_RESOURCE_FAILURE_NO_RETRY     07000000
         BAS   R14,POSTCPIC                 POST THE USER               07010000
         XC    X.SPLAREA,X.SPLAREA          AREA WAS FREED AS SBUF      07020000
         XC    X.SPLAREAL,X.SPLAREAL        AREA WAS FREED AS SBUF      07030000
         BAS   R14,SPLFREE                  RELEASE THE SPLIST          07040000
                                                                        07050000
         DROP  X                                                        07060000
                                                                        07070000
NO62CLUP DS    0H                                                       07080000
                                                                        07090000
*                                                                       07100000
* POST ALLOCATE REQUEST THAT IS WAITING FOR RTR                         07110000
*---------------------------------------------------------------------- 07120000
                                                                        07130000
X        USING AQE,R1                                                   07140000
                                                                        07150000
         ICM   R1,15,ISE62AQE               WAITING FOR RTR?            07160000
         BNP   NO62RTR                      BRANCH IF NOT               07170000
         MVC   CPI62ENT,X.AQEENT            COPY POSTING INFORMATION    07180000
         MVC   CPI62EPB,X.AQEEPB            COPY POSTING INFORMATION    07190000
         MVI   CPI62CDE+(L'CPI62CDE-1),CM_ALLOCATE_FAILURE_NO_RETRY     07200000
         BAS   R14,POSTCPIC                 POST THE USER               07210000
         XC    ISE62AQE,ISE62AQE            AREA WAS FREED AS SBUF      07220000
                                                                        07230000
         DROP  X                                                        07240000
                                                                        07250000
NO62RTR  DS    0H                                                       07260000
                                                                        07270000
*                                                                       07280000
* RELEASE BUFFERS LINGERING IN THE LU6.2 RECEIVE QUEUE                  07290000
*---------------------------------------------------------------------- 07300000
                                                                        07310000
REL62RCV DS    0H                                                       07320000
                                                                        07330000
         ICM   R1,15,ISE62RB1              HEAD OF RECEIVE QUEUE        07340000
         BNP   NO62BUF                     BRANCH IF NO MORE LEFT       07350000
         BAS   R14,SPLDQ                   DEQUEUE THE RECEIVE BUFFER   07360000
         BAS   R14,SPLFREE                 RELEASE THE STORAGE          07370000
         B     REL62RCV                    AND FREE THE NEXT ONE        07380000
                                                                        07390000
NO62BUF  DS    0H                                                       07400000
                                                                        07410000
*                                                                       07420000
* END OF LU6.2 CLEANUP                                                  07430000
*---------------------------------------------------------------------- 07440000
                                                                        07450000
PTRMNO62 DS    0H                                                       07460000
                                                                        07470000
*                                                                       07480000
* TRIGGER SESSION DEACTIVATE IF THIS IS NON-6.2 SESSION FOR A 6.2 USER  07490000
*---------------------------------------------------------------------- 07500000
                                                                        07510000
         TM    IVUF1,IVUF1L62     IS THIS A 6.2 USER?                   07520000
         BNO   RETISESS           BRANCH IF NOT                         07530000
                                                                        07540000
         CLC   BINLUP(2),=X'0602' LU TYPE 6.2 SESSION?                  07550000
         BE    RETISESS           BRANCH IF YES                         07560000
                                                                        07570000
         $VTAMWE L'IWEXT,                                              +07580000
               IWECSDAC           ALLOCATE "SESSION DEACTIVATED" WE     07590000
                                                                        07600000
         LR    RIWE,R1            SAVE WORK ELEMENT ADDRESS             07610000
         XC    IWEXTMDE,IWEXTMDE  NO MDE ADDRESS FOR NON-6.2 SESSION    07620000
         XC    IWEXTNME,IWEXTNME  NO MODE NAME FOR NON-6.2 SESSION      07630000
         XC    IWEXTTKN,IWEXTTKN  NO TOKEN FOR NON-6.2 SESSION          07640000
         LA    R1,IVUWEQ          WORK QUEUE ADDRESS                    07650000
         BAS   R14,QWE            QUEUE STOP WORK ELEMENT TO IVUSER     07660000
                                                                        07670000
*                                                                       07680000
* RELEASE THE STORAGE FOR THE ISESS BLOCK                               07690000
*---------------------------------------------------------------------- 07700000
                                                                        07710000
RETISESS DS    0H                                                       07720000
                                                                        07730000
         $RETSTOR (RISESS),                                            +07740000
               OWNER=(RITASK)     RELEASE THE ISESS BLOCK               07750000
                                                                        07760000
*---------------------------------------------------------------------- 07770000
* RETURN TO CALLER                                                      07780000
*---------------------------------------------------------------------- 07790000
                                                                        07800000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 07810000
                                                                        07820000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    07830000
                                                                        07840000
*---------------------------------------------------------------------- 07850000
* SUBROUTINE: POSTCPIC - POST THE CPIC OPERATION                        07860000
*                                                                       07870000
*      ENTRY: CPI62ENT = WORK UNIT TOKEN                                07880000
*             CPI62EPB = EPB ADDRESS                                    07890000
*             CPI62CDE = POST CODE                                      07900000
*                                                                       07910000
*       EXIT: R15      = RETURN CODE FROM L62POST                       07920000
*---------------------------------------------------------------------- 07930000
                                                                        07940000
POSTCPIC DS     0H                                                      07950000
                                                                        07960000
         STM   R14,R12,SUB0SAVE                                         07970000
                                                                        07980000
         L62POST *CPI62EPB,         ADDRESS OF EPB TO POST             +07990000
               CPI62CDE,            ADDRESS OF POST CODE               +08000000
               CPI62ENT,            ADDRESS OF ENTITY TOKEN            +08010000
               L62RETRC,            ADDRESS OF RETURN CODE AREA        +08020000
               MF=(E,L62MFL)                                            08030000
                                                                        08040000
         LM    R14,R12,SUB0SAVE                                         08050000
         L     R15,L62RETRC                                             08060000
         BR    R14                                                      08070000
                                                                        08080000
*---------------------------------------------------------------------- 08090000
* SUBROUTINE: SPLDQ                                                     08100000
*      ENTRY: R1 = ADDRESS OF SPLIST TO BE DEQUEUED                     08110000
*       EXIT: ALL REGISTERS ARE RESTORED                                08120000
*---------------------------------------------------------------------- 08130000
                                                                        08140000
SPLDQ    DS     0H                                                      08150000
                                                                        08160000
         STM   R14,R1,SUB0SAVE                                          08170000
                                                                        08180000
         LM    R14,R15,SPL62RBN-SPLIST(R1) R14=NEXT BFR R15=PREV BFR    08190000
         ST    R15,SPL62RBP-SPLIST(,R14)   LINK PREV TO NEXT            08200000
         ST    R14,SPL62RBN-SPLIST(,R15)   LINK NEXT TO PREV            08210000
                                                                        08220000
         LA    R15,=CL34'RCV DQ (CLEANUP)'                              08230000
         ST    R15,DESC@                                                08240000
         MVI   DESCLEN+(L'DESCLEN-1),16                                 08250000
         SR    R15,R15                                                  08260000
         ST    R15,TRACE@                                               08270000
         ST    R15,TRACELEN                                             08280000
         BAS   R14,TRACESPL                                             08290000
                                                                        08300000
         LM    R14,R1,SUB0SAVE                                          08310000
         BR    R14                                                      08320000
                                                                        08330000
*---------------------------------------------------------------------- 08340000
* SUBROUTINE: SPLFREE                                                   08350000
*      ENTRY: R1 = ADDRESS OF SPLIST TO BE RELEASED                     08360000
*       EXIT: ALL REGISTERS ARE RESTORED                                08370000
*---------------------------------------------------------------------- 08380000
                                                                        08390000
SPLFREE  DS     0H                                                      08400000
                                                                        08410000
         STM   R14,R12,SUB0SAVE                                         08420000
         LR    R3,R1                     SPLIST ADDRESS                 08430000
         ICM   R2,15,SPLAREAL-SPLIST(R3) IS THERE A DATA AREA?          08440000
         BNP   SPLFLIST                  BRANCH IF NOT                  08450000
         ICM   R4,15,SPLAREA-SPLIST(R3)  AREA TO BE FREED               08460000
         BNP   SPLFLIST                  BRANCH IF NO AREA              08470000
                                                                        08480000
         $RETSTOR (R4),                                                +08490000
               OWNER=(RITASK)                                           08500000
                                                                        08510000
SPLFLIST DS    0H                                                       08520000
                                                                        08530000
         $RETSTOR (R3),                                                +08540000
               OWNER=(RITASK)                                           08550000
                                                                        08560000
         LM    R14,R12,SUB0SAVE                                         08570000
         BR    R14                                                      08580000
                                                                        08590000
*---------------------------------------------------------------------- 08600000
* SUBROUTINE: TRACESPL                                                  08610000
*      ENTRY: R1 = ADDRESS OF SPLIST TO BE TRACED                       08620000
*             DESC@ = ADDRESS OF TRACE POINT DESCRIPTION                08630000
*             DESCLEN = LENGTH OF TRACE POINT DESCRIPTION               08640000
*             TRACE@ = ADDRESS OF ADDITIONAL DATA TO BE TRACED          08650000
*             TRACELEN = LENGTH OF ADDITIONAL DATA TO BE TRACED         08660000
*---------------------------------------------------------------------- 08670000
                                                                        08680000
TRACESPL DS     0H                                                      08690000
                                                                        08700000
         STM   R14,R12,SUB1SAVE                                         08710000
         LR    R4,R1                    SPLIST TO BE TRACED             08720000
         L     R2,DESC@                 TRACE POINT DESC. ADDRESS       08730000
         L     R3,TRACE@                ADDITIONAL DATA   ADDRESS       08740000
                                                                        08750000
         L62TRCS (R4),                         @ SPLIST                +08760000
               (RISESS),                       @ ISESS                 +08770000
               (R2),                           @ DESCRIPTION           +08780000
               DESCLEN,                        @ DESCRIPTION LEN       +08790000
               (R3),                           @ ADDITIONAL DATA       +08800000
               TRACELEN,                       @ ADDITIONAL DATA LEN   +08810000
               L62RETRC,                       @ RETURN CODE AREA      +08820000
               MF=(E,L62MFL)                                            08830000
                                                                        08840000
         LM    R14,R12,SUB1SAVE                                         08850000
         BR    R14                                                      08860000
                                                                        08870000
*---------------------------------------------------------------------- 08880000
* SUBROUTINE QWE - QUEUE A WORK ELEMENT TO A GIVEN WORK QUEUE           08890000
*                                                                       08900000
*                  R14 = RETURN ADDRESS                                 08910000
*                  R1  = QUEUE ADDRESS                                  08920000
*                  RIWE= WORK ELEMENT                                   08930000
*---------------------------------------------------------------------- 08940000
                                                                        08950000
QWE      DS    0H                                                       08960000
                                                                        08970000
         STM   R14,R3,SUB0SAVE    SAVE REGISTERS                        08980000
         LR    R3,R1              SAVE QUEUE ADDRESS                    08990000
                                                                        09000000
         $VTAMQ (RIWE),           WORK ELEMENT                         +09010000
               (R3)               QUEUE                                 09020000
                                                                        09030000
         LM    R14,R3,SUB0SAVE    RESTORE REGISTERS                     09040000
         BR    R14                AND RETURN TO CALLER                  09050000
                                                                        09060000
*---------------------------------------------------------------------- 09070000
* SUBROUTINE VTAMLOCK - OBTAIN VTAM GLOBAL LOCK                         09080000
*---------------------------------------------------------------------- 09090000
                                                                        09100000
VTAMLOCK DS    0H                                                       09110000
                                                                        09120000
         TM    FLAG,FLAGLOCK        HAVE WE ALREADY OBTAINED THE LOCK?  09130000
         BOR   R14                  RETURN IF YES                       09140000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             09150000
                                                                        09160000
         $SER  OBTAIN,                                                 +09170000
               VTAM                                                     09180000
                                                                        09190000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              09200000
         BNE   VTAMLOEX             BRANCH IF NOT                       09210000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         09220000
                                                                        09230000
VTAMLOEX DS    0H                                                       09240000
                                                                        09250000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               09260000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          09270000
         BR    R14                  RETURN                              09280000
                                                                        09290000
*---------------------------------------------------------------------- 09300000
* SUBROUTINE VTAMUNLK - RELEASE VTAM GLOBAL LOCK                        09310000
*---------------------------------------------------------------------- 09320000
                                                                        09330000
VTAMUNLK DS    0H                                                       09340000
                                                                        09350000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       09360000
         BNOR  R14                  BRANCH IF NOT                       09370000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             09380000
         BOR   R14                  DON'T RELEASE IF IT WAS             09390000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             09400000
                                                                        09410000
         $SER  RELEASE,                                                +09420000
               VTAM                                                     09430000
                                                                        09440000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  09450000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          09460000
         BR    R14                  RETURN                              09470000
                                                                        09480000
*---------------------------------------------------------------------- 09490000
*   SUBROUTINE: OBTAIN DISP GLOBAL LOCK                                 09500000
*---------------------------------------------------------------------- 09510000
                                                                        09520000
DISPLOCK DS    0H                                                       09530000
                                                                        09540000
         TM    FLAG,FLAGDLCK        WAS THE LOCK ALREADY OBTAINED?      09550000
         BOR   R14                  RETURN IF YES                       09560000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             09570000
                                                                        09580000
         $SER  OBTAIN,                                                 +09590000
               DISP                                                     09600000
                                                                        09610000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              09620000
         BNE   DISPLOEX             BRANCH IF NOT                       09630000
         OI    FLAG,FLAGDLKD        REMEMBER LOCK HELD ON ENTRY         09640000
                                                                        09650000
DISPLOEX DS    0H                                                       09660000
                                                                        09670000
         OI    FLAG,FLAGDLCK        REMEMBER LOCK IS HELD               09680000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          09690000
         BR    R14                  RETURN                              09700000
                                                                        09710000
*---------------------------------------------------------------------- 09720000
*   SUBROUTINE: RELEASE DISP GLOBAL LOCK                                09730000
*---------------------------------------------------------------------- 09740000
                                                                        09750000
DISPUNLK DS    0H                                                       09760000
                                                                        09770000
         TM    FLAG,FLAGDLCK        IS LOCK HELD?                       09780000
         BNOR  R14                  BRANCH IF NOT                       09790000
         TM    FLAG,FLAGDLKD        WAS LOCK HELD ON ENTRY?             09800000
         BOR   R14                  DON'T RELEASE IF IT WAS             09810000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             09820000
                                                                        09830000
         $SER  RELEASE,                                                +09840000
               DISP                                                     09850000
                                                                        09860000
         NI    FLAG,255-FLAGDLCK    SHOW LOCK NOT HELD                  09870000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          09880000
         BR    R14                  RETURN                              09890000
                                                                        09900000
*---------------------------------------------------------------------- 09910000
* ERROR ROUTINES                                                        09920000
*---------------------------------------------------------------------- 09930000
                                                                        09940000
ERRSBUF  $ABEND ABE_VTDIAG,                                            +09950000
               SCOPE=PCB,                                              +09960000
               TITLE='SBUF FAILURE'                                     09970000
                                                                        09980000
ERR$SESS $ABEND ABE_VTDIAG,                                            +09990000
               SCOPE=PCB,                                              +10000000
               TITLE='$SESS FAILURE'                                    10010000
                                                                        10020000
ERR$VTAM $ABEND ABE_VTDIAG,                                            +10030000
               SCOPE=PCB,                                              +10040000
               TITLE='$VTAM FAILURE'                                    10050000
                                                                        10060000
ERRSTERM $ABEND ABE_VTDIAG,                                            +10070000
               SCOPE=PCB,                                              +10080000
               TITLE='INVALID ISESS AT SESSION TERMINATION'             10090000
                                                                        10100000
*---------------------------------------------------------------------- 10110000
*  CONSTANTS AND LITERALS                                               10120000
*---------------------------------------------------------------------- 10130000
                                                                        10140000
         LTORG ,                                                        10150000
         PRINT NOGEN                                                    10160000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                10170000
         ISTDBIND ,               VTAM BIND IMAGE                       10180000
         ISTRH ,                  VTAM SNA REQUEST HEADER               10190000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         10200000
         ICVT  ,                  INTEGRATOR CVT                        10210000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   10220000
         IRPL ,                   INTEGRATOR VTAM RPL+                  10230000
         IACB ,                   INTEGRATOR VTAM ACB+                  10240000
         INIB ,                   INTEGRATOR VTAM NIB+                  10250000
         ISESS ,                  INTEGRATOR SESSION BLOCK              10260000
         IRQE ,                   INTEGRATOR RECEIVE QUEUE ELEMENT      10270000
         ISQE ,                   INTEGRATOR SESS INIT QUEUE ELEMENT    10280000
         IBQE ,                   INTEGRATOR BIND QUEUE ELEMENT         10290000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            10300000
         ITASK ,                  INTEGRATOR TASK BLOCK                 10310000
         IPCB ,                   INTEGRATOR PROCESS BLOCK              10320000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          10330000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       10340000
         EVCODES ,                INTEGRATOR EVENT CODES                10350000
         ABCODES ,                INTEGRATOR $ABEND CODES               10360000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     10370000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        10380000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             10390000
         $PROC DSECT=YES          INTEGRATOR $PROC SERVICES             10400000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             10410000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             10420000
         $SESSTMR DSECT=YES       INTEGRATOR $SESSTMR SERVICES          10430000
         $WULOC DSECT=YES         INTEGRATOR $WULOC SERVICES            10440000
         SBUF  DSECT=YES          INTEGRATOR SBUF SERVICES              10450000
         IFGEXLST ,               VTAM EXIT LIST                        10460000
         END   ,                                                        10470000

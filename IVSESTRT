IVSESTRT TITLE '- START VIRTUAL SESSION COMMON LOGIC'                   00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: IVSESTRT - Start virtual session common logic                00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    $SESS is invoked to start the session represented by the           00080000
*    partially completed SLU hanlde provided as input.  If the          00090000
*    session is established without error, SLU handle init init         00100000
*    is completed by the SLU session driver.  In particular, it         00110000
*    places the driver's IPCB address in that handle allowing           00120000
*    subsequent requests from remote users to address that              00130000
*    driver directly ($TSEND PCB=).                                     00140000
*                                                                       00150000
*    Upon completion of the session start, onwership of the             00160000
*    session entity and the SLUHANDL is surrendered to the SLU          00170000
*    session driver, who assumes all responsibility for its             00180000
*    cleanup.                                                           00190000
*                                                                       00200000
*    Two types of failures may occur.  If $SESS encounters an           00210000
*    error, ISESDIAG is invoked to acquire diagnostic messages.         00220000
*    If the SLU driver fails to sync up or posts an error,              00230000
*    diagnostics are generated inline.                                  00240000
*                                                                       00250000
*                                                                       00260000
* ON ENTRY:                                                             00270000
*                                                                       00280000
*    R1  contains the address of a parameter list described             00290000
*        by VSESTRTP                                                    00300000
*                                                                       00310000
*                                                                       00320000
* ON EXIT:                                                              00330000
*                                                                       00340000
*    R15 contains one of the following return codes                     00350000
*                                                                       00360000
*        RC00 - session started; the SNA state flags and                00370000
*               SLU session token have been returned in                 00380000
*               the data areas provided in the VSESTRTP.                00390000
*                                                                       00400000
*        RC04 - reserved                                                00410000
*                                                                       00420000
*        RC08 - $SESS service failure                                   00430000
*                                                                       00440000
*               R0 - $SESS service return code                          00450000
*               R1 - $SESS service reason code                          00460000
*                                                                       00470000
*        RC12 - SLU session driver failure                              00480000
*                                                                       00490000
*               R0 - SLU driver failure post code                       00500000
*                                                                       00510000
*                                                                       00520000
* MESSAGES:                                                             00530000
*                                                                       00540000
*    003 - SLU driver initialization failed - RC: <I>                   00550000
*    007 - unsupported logmode, LU2 sessions only                       00560000
*                                                                       00570000
*    In the event of a $SESS service routine failure,                   00580000
*    additional diagnostic messages are acquired from ISESDIAG.         00590000
*                                                                       00600000
**<DOC-OFF>****************************************************         00610000
                                                                        00620000
         EJECT                                                          00630000
***************************************************************         00640000
*                                                                       00650000
* MAINTENANCE:                                                          00660000
*                                                                       00670000
*    07/25/94 R. Colmone      PAR# 134222                               00680000
*                                                                       00690000
*             Changed $SESS Start session to use the EPB=               00700000
*             form of the macro when starting session.                  00710000
*             The Session token seed value now used for                 00720000
*             starting session is not always the PLU session            00730000
*             token in the case of LU 6.2 sessions.  Therefore,         00740000
*             the token seed value used is the first 4 bytes            00750000
*             of the Session token in the IVTUSER block.                00760000
*             This special token does not notify the $SESS              00770000
*             requestor of the completion status of the request.        00780000
*             To obtain the completion status, one must specify         00790000
*             the async form of the macro (EPB=) and wait for           00800000
*             service to complete.  The completion code is then         00810000
*             available in the SESSPL.                                  00820000
*                                                                       00830000
*    04/20/95 R. Turgeon                                                00840000
*                                                                       00850000
*             Session start common logic consolidation                  00860000
*                                                                       00870000
***************************************************************         00880000
                                                                        00890000
         EJECT                                                          00900000
         VSESTRTP ,               REQUEST FORMAT                        00910000
                                                                        00920000
         EJECT                                                          00930000
         SLUHANDL ,               APPLICATION SESSION HANDLE            00940000
                                                                        00950000
         EJECT                                                          00960000
         ICATALOG APPLS           SYSTEM CATALOG TABLES                 00970000
                                                                        00980000
         EJECT                                                          00990000
         $SESS DSECT=YES          SESSION MANAGEMENT REQUEST PLISTS     01000000
                                                                        01010000
         EJECT                                                          01020000
         $TASK DSECT=YES          $TASK REQUEST PLIST                   01030000
                                                                        01040000
         EJECT                                                          01050000
         ABCODES ,                                                      01060000
                                                                        01070000
         EQUS  ,                                                        01080000
                                                                        01090000
         EJECT                                                          01100000
         $MSGDFT PREFIX=ICTPID,COMPID='VSE',TABLE=*#MSGS,              X01110000
               CONID=*ICTCONID,CONNAME=ICTCONNM,                       X01120000
               BUFR=*VSSTMSGB,BUFL=*VSSTMSGL,DEST=$BUFFER,             X01130000
               PRINT=NOGEN,MF=(E,$MSGMFL)                               01140000
                                                                        01150000
         EJECT                                                          01160000
         #WORK ,                                                        01170000
                                                                        01180000
@SESSPL  DS    A                  ADDR OF $SESS PLIST CONSTRUCTION AREA 01190000
@SYNCEPB DS    A                  SLU DRIVER SYNC EPB                   01200000
@SESSEPB DS    A                  ASYNC $SESS COMPLETION EPB            01210000
                                                                        01220000
#PARSESS DS    F                  OPT - PARTNER USES PARALLEL SESSIONS  01230000
#ACBNSHR DS    F                  OPT - START SESS USING NON-SHR ACB    01240000
#SCLSDST DS    F                  OPT - APPL ISSUES SINGLE CLSDST PASS  01250000
#MCLSDST DS    F                  OPT - APPL ISSUES MULT CLSDST PASS    01260000
                                                                        01270000
RETSTATS DS    0F,0F,0F           COMPLETION CODES                      01280000
RETC     DS    F                     RETURN CODE                        01290000
RSNC     DS    F                     REASON CODE                        01300000
INFOC    DS    F                     INFO CODE                          01310000
                                                                        01320000
PLUTOKEN DS    XL8                REMOTE REQUESTERS PLU SESSION TOKEN   01330000
*                                 THIS FIELD WILL BE REPLACED BY THE    01340000
*                                 SLU TOKEN REPRESENTING THE NEW SESS   01350000
                                                                        01360000
$TASKMFL $TASK MF=(L,*)           $TASK PLIST CONSTRUCTION AREA         01370000
$MSGMFL  $MSG  MF=(L,*),FIELDS=(,,,,)   $MSG PLIST CONSTRUCTION AREA    01380000
                                                                        01390000
         #ENDWORK ,                                                     01400000
                                                                        01410000
         EJECT ,                                                        01420000
IVSESTRT #ENTER PREG=R8                                                 01430000
                                                                        01440000
         USING ITASK,R10          STDENV                                01450000
                                                                        01460000
         EJECT                                                          01470000
***************************************************************         01480000
*                                                                       01490000
*   GENERAL INITIALIZATION                                              01500000
*                                                                       01510000
***************************************************************         01520000
                                                                        01530000
         USING VSESTRTP,R8        PARAMETER LIST                        01540000
                                                                        01550000
         L     R7,VSSTAPPL        APPLICATION DEFINITION ENTRY          01560000
         USING SYSAPPLS,R7                                              01570000
                                                                        01580000
         L     R6,VSSTSLH         SLU HANDLE                            01590000
         USING SLUHANDL,R6                                              01600000
                                                                        01610000
         ICM   R2,15,VSSTPLU      PLU OF REMOTE REQUESTER               01620000
         BZ    *+10               SKIP IF NOT PROVIDED                  01630000
         MVC   PLUTOKEN,0(R2)     RETAIN LOCAL COPY                     01640000
                                                                        01650000
*--------------------------------------------------------------         01660000
*   PUT APPLICATION ATTRIBUTES IN $SESS FORMAT                          01670000
*--------------------------------------------------------------         01680000
                                                                        01690000
         SR    R0,R0              PREPARE FOR INSERT                    01700000
         IC    R0,SAPLFLG1        FETCH APPL ATTRIBUTES                 01710000
         ST    R0,#PARSESS        PARTNER USES PARALLEL SESSIONS        01720000
         ST    R0,#ACBNSHR        START SESS USING NON-SHR ACB          01730000
         ST    R0,#SCLSDST        APPL ISSUES SINGLE CLSDST PASS        01740000
         ST    R0,#MCLSDST        APPL ISSUES MULTIPLE CLSDST PASS      01750000
                                                                        01760000
         NC    #PARSESS,=A(SAPLF1PA)                                    01770000
         NC    #ACBNSHR,=A(SAPLF1EX)                                    01780000
         NC    #SCLSDST,=A(SAPLF1PS)                                    01790000
         NC    #MCLSDST,=A(SAPLF1MP)                                    01800000
                                                                        01810000
***************************************************************         01820000
*                                                                       01830000
*   CREATE AN EPB USED TO SYNC UP WITH NEW SLU DRIVER                   01840000
*                                                                       01850000
***************************************************************         01860000
                                                                        01870000
         $TASK SETEPB,            CREATE AN XEPB                       X01880000
               SCOPE=LOCAL,       INTRATASK MESSAGING                  X01890000
               MF=(E,$TASKMFL)                                          01900000
                                                                        01910000
         BZ    *+8                ASSERT NORMAL SYSTEM OPERATION        01920000
         EX    R0,*               DENIED                                01930000
                                                                        01940000
         LR    R3,R1              RETAIN XEPB TOKEN                     01950000
         ST    R3,SLHRQEPB        PASS TO SLU DRIVER                    01960000
         ST    R3,@SYNCEPB        SYNC EPB                              01970000
                                                                        01980000
***************************************************************         01990000
*                                                                       02000000
*   ESTABLISH SESSION WITH DESIGNATED APPLICATION                       02010000
*                                                                       02020000
***************************************************************         02030000
                                                                        02040000
         $GETSTOR $SESSPLN,OWNER=ITASK  ACQUIRE SHARED ACCESS PLIST     02050000
                                                                        02060000
         ST    R1,@SESSPL         SAVE PTR                              02070000
                                                                        02080000
*--------------------------------------------------------------         02090000
*   ACQUIRE A $SESS EPB, SEE COMMENTS PAR 134222                        02100000
*--------------------------------------------------------------         02110000
                                                                        02120000
         $TASK SETEPB,SCOPE=LOCAL,MF=(E,$TASKMFL)              134222   02130000
                                                                        02140000
         BZ    *+8                ASSERT NORMAL SYSTEM OPER    134222   02150000
         EX    R0,*               DENIED                       134222   02160000
                                                                        02170000
         LR    R3,R1              RETAIN XEPB TOKEN            134222   02180000
         ST    R3,@SESSEPB        SYNC EPB                              02190000
                                                                        02200000
*--------------------------------------------------------------         02210000
*   START THE SESSION                                                   02220000
*--------------------------------------------------------------         02230000
                                                                        02240000
         $SESS $SESS_START_SESSION,                                    X02250000
               SESSION=PLUTOKEN,  $SESS TOKEN RETURN AREA              X02260000
               POOL=SAPPOOLN,     VIRTUAL TERMINAL POOL NAME           X02270000
               LUNAME=SLHAPPL,    SESSION PARTNER (APPL) NAME          X02280000
               LOGMODE=SLHLOGMD,  LOGMODE                              X02290000
               PARM=SLUHANDL,     SLU HANDLE IS DRIVER PARM            X02300000
               DRIVER=$SLUDRV,    SLU SESSION DRIVER                   X02310000
               EXCLUSIVE=*#ACBNSHR,     ACB SHARING                    X02320000
               PARSESS=*#PARSESS,       PARTNER USES PARALLEL SESSIONS X02330000
               CLSDST_PASS=*#SCLSDST,   APPL ISSUES SINGLE CLSDST PASS X02340000
               MULTI_PASS=*#MCLSDST,    APPL ISSUES MULT CLSDST PASS   X02350000
               EPB=(R3),          ASYNCH NOTIFICATION           134222 X02360000
               ERRET=ERR_SESS,    ERROR RETURN                         X02370000
               MF=(E,*@SESSPL)                                          02380000
                                                                        02390000
*--------------------------------------------------------------         02400000
*   AWAIT COMPLETION OF $SESS SERVICE, EXTRACT COMPLETION INFO          02410000
*--------------------------------------------------------------         02420000
                                                                        02430000
         $TASK WAIT,EPB=(R3),MF=(E,$TASKMFL)                    134222  02440000
                                                                        02450000
         XC    @SESSEPB,@SESSEPB  RECIND EPB                            02460000
                                                                        02470000
         L     R2,@SESSPL         ADDR OF $SESS PLIST           134222  02480000
         USING SPLIST,R2          TEMPORARY ADDRESSABILITY      134222  02490000
         ICM   R15,15,SPLRETCD    $SESS COMPLETION CODE         134222  02500000
         BNZ   ERR_SESS           FAILURE NOTIFICATION          134222  02510000
                                                                        02520000
         ICM   R1,15,VSSTRSNA     INITIAL SNA STATE RETURN REQ?         02530000
         BZ    *+10               SKIP IF NOT                           02540000
         MVC   0(4,R1),SPLSTATE   CAPTURE SNA STATE FLAGS               02550000
                                                                        02560000
         ICM   R1,15,VSSTRTKN     SLU SESSION TOKEN RETURN REQ?         02570000
         BZ    *+10               SKIP IF NOT                           02580000
         MVC   0(L'PLUTOKEN,R1),SPLTOKEN                                02590000
                                                                        02600000
         DROP  R2                 SPLIST                        134222  02610000
                                                                        02620000
***************************************************************         02630000
*                                                                       02640000
*   AWAIT SLU DRIVER INITIALIZATION                                     02650000
*                                                                       02660000
***************************************************************         02670000
                                                                        02680000
         $TASK WAIT,              AWAIT POST OF NEW EPB                X02690000
               EPB=*@SYNCEPB,                                          X02700000
               MF=(E,$TASKMFL)                                          02710000
                                                                        02720000
         XC    @SYNCEPB,@SYNCEPB  XEPB HAS BEEN FREED                   02730000
                                                                        02740000
         LTR   R0,R0              INITIALIZATION COMPLETED NORMALLY?    02750000
         BNZ   ERR_SLU            CONVEY FAILURE TO REQUESTOR           02760000
                                                                        02770000
         EJECT                                                          02780000
***************************************************************         02790000
*                                                                       02800000
*   POST COMPLETION STATUS AND MESSAGES FOR RETURN                      02810000
*                                                                       02820000
***************************************************************         02830000
                                                                        02840000
NORMRET  DS    0H                 NORMAL COMPLETION                     02850000
         LA    R15,RC00           INDICATE SUCCESS                      02860000
         SR    R0,R0              REASON CODE NOT DEFINED               02870000
         SR    R1,R1              INFO CODE NOT DEFINED                 02880000
         STM   R15,R1,RETSTATS    PRESERVE COMPLETION CODES             02890000
         B     CLEANUP            DONE                                  02900000
                                                                        02910000
*--------------------------------------------------------------         02920000
*   ERROR: SESSION START FAILED - ACQUIRE DIAGNOSTIC MSGS               02930000
*--------------------------------------------------------------         02940000
                                                                        02950000
ERR_SESS DS    0H                                                       02960000
         LR    R1,R0              R1 <== $SESS RSN CODE AS INFO CODE    02970000
         LR    R0,R15             R0 <== $SESS COMPLETION CODE AS RSN   02980000
         LA    R15,RC08           INDICATE $SESS ERROR                  02990000
         STM   R15,R1,RETSTATS    PRESERVE COMPLETION CODES             03000000
                                                                        03010000
         @CALL ISESDIAG,(*@SESSPL,*VSSTMSGB,*VSSTMSGL,$BUFFER),        X03020000
               CTYPE=CVT,                                              X03030000
               MF=(E,MFE_LIST)                                          03040000
                                                                        03050000
         B     CLEANUP                                                  03060000
                                                                        03070000
*--------------------------------------------------------------         03080000
*   ERROR: SLU SESSION DRIVER FAILED                                    03090000
*--------------------------------------------------------------         03100000
                                                                        03110000
ERR_SLU  DS    0H                 R0 CONTAINS SLU DRIVER POST CODE      03120000
         LA    R15,RC12           INDICATE SLU DRIVER FAILURE           03130000
         STM   R15,R1,RETSTATS    PRESERVE COMPLETION CODES             03140000
                                                                        03150000
         C     R0,=A(RC04)        UNSUPPORTED SESSION TYPE?             03160000
         BNE   ESLUDIAG           UNKNOWN COMPLETION OTHERWISE          03170000
                                                                        03180000
         $MSG  007                INVALID LOGMODE, LU2 REQUIRED         03190000
                                                                        03200000
         B     CLEANUP                                                  03210000
                                                                        03220000
ESLUDIAG DS    0H                                                       03230000
         $MSG  003,FIELDS=(RSNC),DESTADD=$LOGFILE                       03240000
                                                                        03250000
         B     CLEANUP                                                  03260000
                                                                        03270000
         EJECT                                                          03280000
***************************************************************         03290000
*                                                                       03300000
*   CLEANUP. RELEASE THE $SESS ASYNC COMPLETION NOTIFICATION            03310000
*   EPB IF $SESS FAILED.  SLU SYNCHRONIZATION EPB IF THE SLU            03320000
*   DRIVER WAS NOT REACHED.  FINALLY, DELETE THE SPLIST $SESS           03330000
*   PARAMETER LIST.                                                     03340000
*                                                                       03350000
***************************************************************         03360000
                                                                        03370000
CLEANUP  DS    0H                                                       03380000
         ICM   R3,15,@SESSEPB     DANGLING EPB?                         03390000
         BZ    ESESSEPB           SKIP IF NOT                           03400000
                                                                        03410000
         $TASK REMEPB,            RETRACT THE REQUEST                  X03420000
               EPB=(R3),                                               X03430000
               MF=(E,$TASKMFL)                                          03440000
                                                                        03450000
ESESSEPB DS    0H                                                       03460000
                                                                        03470000
*--------------------------------------------------------------         03480000
*   REMOVE SLU DRIVER SYNC EPB                                          03490000
*--------------------------------------------------------------         03500000
                                                                        03510000
         ICM   R3,15,@SYNCEPB     DANGLING EPB?                         03520000
         BZ    ESYNCEPB           SKIP IF NOT                           03530000
                                                                        03540000
         $TASK REMEPB,            RETRACT THE REQUEST                  X03550000
               EPB=(R3),                                               X03560000
               MF=(E,$TASKMFL)                                          03570000
                                                                        03580000
ESYNCEPB DS    0H                                                       03590000
                                                                        03600000
*--------------------------------------------------------------         03610000
*   RELEASE $SESS PARAMETER LIST                                        03620000
*--------------------------------------------------------------         03630000
                                                                        03640000
         ICM   R2,15,@SESSPL      $SESS PLIST ALLOCATED?                03650000
         BZ    ERETSPL            SKIP FREE IF NOT                      03660000
                                                                        03670000
         $RETSTOR (R2),OWNER=ITASK   RELEASE ACQUIRED STORAGE           03680000
                                                                        03690000
ERETSPL  DS    0H                                                       03700000
                                                                        03710000
*--------------------------------------------------------------         03720000
*   RETURN TO REQUESTER                                                 03730000
*--------------------------------------------------------------         03740000
                                                                        03750000
         LM    R15,R1,RETSTATS    RESTORE COMPLETION CODES              03760000
                                                                        03770000
         #EXIT ,                                                        03780000
                                                                        03790000
         EJECT                                                          03800000
***************************************************************         03810000
*                                                                       03820000
*   LOCAL READ ONLY DATA AREAS, ETC.                                    03830000
*                                                                       03840000
***************************************************************         03850000
                                                                        03860000
$SLUDRV  DC    CL8'ISLUDRV'                                             03870000
                                                                        03880000
$SESSPL  $SESS MF=L,FIELDS=(,,,,) MODEL $SESS PLIST                     03890000
$SESSPLN EQU   *-$SESSPL          LENGTH OF PLIST                       03900000
                                                                        03910000
         LTORG ,                                                        03920000
                                                                        03930000
         EJECT                                                          03940000
         PRINT NOGEN                                                    03950000
         ICVT  ,                                                        03960000
         ITASK ,                                                        03970000
         IPCB  ,                                                        03980000
         IUSER ,                                                        03990000
         IVTAMCVT ,                                                     04000000
         ISTDBIND ,                                                     04010000
         ISESS ,                                                        04020000
         END   ,                                                        04030000

IL62TPMG TITLE 'INTEGRATOR - LU6.2 TP RESOURCE MANAGER'                 00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: IL62TPMG - INTEGRATOR LU6.2 TP RESOURCE MANAGER              00100000
*                                                                       00110000
* DESCRIPTION: RESOURCE MANAGER CLEANUP FOR TP RESOURCES                00120000
*                                                                       00130000
* ON ENTRY:                                                             00140000
*                                                                       00150000
*    R15 = ENTRY POINT ADDRESS                                          00160000
*    R14 = RETURN      ADDRESS                                          00170000
*    R13 = SAVE AREA   ADDRESS                                          00180000
*    R11 = ICVT        ADDRESS                                          00190000
*    R10 = ITASK       ADDRESS                                          00200000
*    R01 = TKB         ADDRESS                                          00210000
*                                                                       00220000
* ON EXIT:                                                              00230000
*                                                                       00240000
*    R15 = 0                                                            00250000
*    R00 = 0                                                            00260000
*    R01 = 0                                                            00270000
*                                                                       00280000
*    ALL OTHER REGISTERS ARE RESTORED                                   00290000
*                                                                       00300000
*                                                                       00310000
**<DOC-OFF>************************************************************ 00320000
                                                                        00330000
         EJECT ,                                                        00340000
*********************************************************************** 00350000
*                                                                       00360000
* MAINTENANCE:                                                          00370000
*                                                                       00380000
*   07/01/94 RANDY WITEK                                                00390000
*   08/17/95 RANDY WITEK - NEW STOP TESTS TO BYPASS SYNCHRONIZATION     00400000
*   12/31/95 RANDY WITEK - 2.1 TRANSACTION PROGRAM VTAM WU SUPPORT      00410000
*                                                                       00420000
*********************************************************************** 00430000
                                                                        00440000
         EQUS  ,                  GENERAL EQUATES                       00450000
                                                                        00460000
RICVT    EQU   R11                                                      00470000
RITASK   EQU   R10                                                      00480000
RIVTAM   EQU   R9                                                       00490000
RIPCB    EQU   R8                                                       00500000
RTKB     EQU   R7                                                       00510000
RRCB     EQU   R6                                                       00520000
RISESS   EQU   R5                                                       00530000
RIVUSER  EQU   R4                                                       00540000
                                                                        00550000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00560000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00570000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00580000
         USING IPCB,RIPCB         ESTABLISH ADDRESSABILITY              00590000
         USING TKB,RTKB           ESTABLISH ADDRESSABILITY              00600000
         USING RCB,RRCB           ESTABLISH ADDRESSABILITY              00610000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00620000
         USING IVUSER,RIVUSER     ESTABLISH ADDRESSABILITY              00630000
                                                                        00640000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00650000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00660000
$TASKMFL $TASK MF=L               PLIST CONSTRUCTION                    00670000
$SESSMFL $SESS MF=L               PLIST CONSTRUCTION                    00680000
CMMFL    CMDEAL MF=L              PLIST CONSTRUCTION                    00690000
L62MFL   L62DLRC MF=L             PLIST CONSTRUCTION                    00700000
L62RETCD DS    F                  SERVICE RETURN CODE AREA              00710000
CMRETCD  DS    F                  SERVICE RETURN CODE AREA              00720000
CMCONVID DS    XL8                CURRENT CONVERSATION ID               00730000
WRK256   DS    XL256              GENERAL WORKAREA                      00740000
SAVEEPB  DS    F                  TEMPORARY SAVE AREA                   00750000
RETR15   DS    F                  RETURN CODE VALUE                     00760000
RETR0    DS    F                  RETURN REGISTER 0                     00770000
RETR1    DS    F                  RETURN REGISTER 1                     00780000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00790000
FLAG     DS    X                                                        00800000
FLAGLOCK EQU   X'80'              VTAM LOCK IS HELD                     00810000
FLAGLCKD EQU   X'40'              VTAM LOCK WAS HELD ON ENTRY           00820000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00830000
                                                                        00840000
         $MSGDFT PREFIX=ICTPID,                                        +00850000
               COMPID='L62',                                           +00860000
               TABLE=*#MSGS,                                           +00870000
               WORKA=0,                                                +00880000
               MF=(E,WRK256),                                          +00890000
               PRINT=NOGEN                                              00900000
                                                                        00910000
IL62TPMG #ENTER BASE=R12,         ENTRY LINKAGE                        +00920000
               PREG=RTKB,                                              +00930000
               AMODE=31,                                               +00940000
               RMODE=ANY                                                00950000
                                                                        00960000
*---------------------------------------------------------------------- 00970000
* RESOURCE MANAGER CLEANUP FOR LU6.2 TRANSACTION PROGRAMS               00980000
*---------------------------------------------------------------------- 00990000
                                                                        01000000
*---------------------------------------------------------------------- 01010000
* VERIFY TKB BLOCK ON ENTRY                                             01020000
*---------------------------------------------------------------------- 01030000
                                                                        01040000
         CLC   TKBID,=CL8'TKB'    VALID TKB?                            01050000
         BNE   ERRTKB             BRANCH IF NOT                         01060000
                                                                        01070000
*---------------------------------------------------------------------- 01080000
* ESTABLISH ENVIRONMENT                                                 01090000
*---------------------------------------------------------------------- 01100000
                                                                        01110000
         L     RIPCB,TSKPCBC      CURRENT IPCB                          01120000
         L     RIVTAM,ICTVTCVT    IVTAMCVT ADDRESSIBILITY               01130000
         SR    RIVUSER,RIVUSER    NO IVUSER YET                         01140000
         TM    TKBF1,TKBF1VTM     IS THIS A VTAM USER ENVIRONMENT?      01150000
         BNO   NOIVUSER           BRANCH IF NOT                         01160000
         L     RIVUSER,TSKIVUSR   IVUSER ADDRESSIBILITY                 01170000
                                                                        01180000
NOIVUSER DS    0H                                                       01190000
                                                                        01200000
*---------------------------------------------------------------------- 01210000
* ISSUE AN INFORMATIVE MESSAGE AND CUT A TRACE RECORD                   01220000
*---------------------------------------------------------------------- 01230000
                                                                        01240000
         $TRACE *=A(TRC_LU62_IL62TPMG),80 TRACE ENTRY W/80 USER BYTES   01250000
                                                                        01260000
         BNZ   NOTRACE                   BRANCH IF NOT TRACING          01270000
                                                                        01280000
         ST    RTKB,0(,R1)               TRACE TKB ADDRESS              01290000
         ST    RITASK,4(,R1)             TRACE ITASK ADDRESS            01300000
         ST    RIPCB,8(,R1)              TRACE IPCB ADDRESS             01310000
         MVC   12(64,R1),TKBTPN          TRACE TP NAME                  01320000
                                                                        01330000
NOTRACE  DS    0H                                                       01340000
                                                                        01350000
         $MSG  998,                     "TPN END.......'               +01360000
               FIELDS=((RTKB),          TKB ADDRESS                    +01370000
               (TSKNAME,8),             ITASK NAME                     +01380000
               (RITASK),                ITASK ADDRESS                  +01390000
               (PCBNAME,8),             IPCB  NAME                     +01400000
               (RIPCB),                 IPCB  ADDRESS                  +01410000
               (TKBTPN,64))             TP NAME                         01420000
                                                                        01430000
*---------------------------------------------------------------------- 01440000
* LOCATE A LINGERING CONVERSATION                                       01450000
*---------------------------------------------------------------------- 01460000
                                                                        01470000
NEXTCONV DS    0H                                                       01480000
                                                                        01490000
         ICM   RRCB,15,TKBRC1ST   ANY RCB'S LEFT?                       01500000
         BNP   CHECKENV           EXIT IF NOT                           01510000
         MVC   CMCONVID,RCBCNVID  SET THE CURRENT CONVERSATION ID       01520000
                                                                        01530000
*---------------------------------------------------------------------- 01540000
* IF CONVERSATION IS WAITING TO BE ACCEPTED...ACCEPT IT & THEN DEALLOC  01550000
*---------------------------------------------------------------------- 01560000
                                                                        01570000
         CLC   RCBCONVS,=A(CM_NULL_STATE)                               01580000
         BNE   NOTNULL                                                  01590000
         MVC   RCBCONVS,=A(CM_RECEIVE_STATE)                            01600000
                                                                        01610000
NOTNULL  DS    0H                                                       01620000
                                                                        01630000
*---------------------------------------------------------------------- 01640000
* IF CONVERSATION IS IN RESET OR INIT STATE...JUST RELEASE THE RCB      01650000
*---------------------------------------------------------------------- 01660000
                                                                        01670000
         CLC   RCBCONVS,=A(CM_RESET_STATE)                              01680000
         BE    DELETE                                                   01690000
         CLC   RCBCONVS,=A(CM_INITIALIZE_STATE)                         01700000
         BE    DELETE                                                   01710000
         B     NODELETE                                                 01720000
                                                                        01730000
DELETE   DS    0H                                                       01740000
                                                                        01750000
         L62DLRC (RRCB),                                               +01760000
               L62RETCD,                                               +01770000
               MF=(E,L62MFL)      DELETE THE RCB                        01780000
                                                                        01790000
         B     NEXTCONV                                                 01800000
                                                                        01810000
NODELETE DS    0H                                                       01820000
                                                                        01830000
*---------------------------------------------------------------------- 01840000
* SYNCHRONIZE WITH SESSION ACTIVITY TO ALLOW ACTIVE REQUESTS TO END     01850000
*---------------------------------------------------------------------- 01860000
                                                                        01870000
         BAS   R14,VTAMLOCK                                             01880000
                                                                        01890000
         $SESS $SESS_FIND_SESSION,                                     +01900000
               SESSION=RCBHSID,                                        +01910000
               ERRET=RQSYNCD,                                          +01920000
               MF=(E,$SESSMFL)    LOCATE ASSOCIATED ISESS, IF ANY       01930000
                                                                        01940000
X        USING SPLIST,$SESSMFL                                          01950000
         L     RISESS,X.SPLAREA   ADDRESS OF ASSOCIATED ISESS BLOCK     01960000
         DROP  X                                                        01970000
                                                                        01980000
*                                                                       01990000
* IF SESSION IS TERMINATING OR DRIVER IS DOWN...SKIP THE SYNC           02000000
*---------------------------------------------------------------------- 02010000
                                                                        02020000
         TM    ICTSTAT3,ICT3$P+ICT3$PX                                  02030000
         BNZ   SKIPCLUP           BRANCH IF SYSTEM TERMINATING          02040000
                                                                        02050000
         ICM   R14,15,ISEITASK                                          02060000
X        USING ITASK,R14                                                02070000
         TM    X.TSKFLGS,TSK$CNCL+TSK$STOP                              02080000
         BNZ   SKIPCLUP           BRANCH IF TASK   TERMINATING          02090000
         DROP  X                                                        02100000
                                                                        02110000
         TM    IVTF1,IVTF1TRM                                           02120000
         BO    SKIPCLUP           BRANCH IF VTAM MAIN TASK TERMINATING  02130000
                                                                        02140000
         TM    ISEF1,ISEF1TRM     IS SESSION TERMINATING?               02150000
         BO    SKIPCLUP           BRANCH IF YES                         02160000
                                                                        02170000
         TM    ISE62FL2,ISE62DRD  IS THE LU6.2 DRIVER DOWN?             02180000
         BO    SKIPCLUP           BRANCH IF YES                         02190000
                                                                        02200000
*                                                                       02210000
* ALLOCATE A TP CLEANUP WORK ELEMENT                                    02220000
*---------------------------------------------------------------------- 02230000
                                                                        02240000
         $VTAMWE L'IWEYB,         SIZE                                 +02250000
               IWECCLUP           CODE                                  02260000
                                                                        02270000
         LR    R3,R1              ESTABLISH ADDRESSABILITY              02280000
                                                                        02290000
*                                                                       02300000
* ALLOCATE AN XEPB                                                      02310000
*---------------------------------------------------------------------- 02320000
                                                                        02330000
         $TASK SETEPB,            INITIALIZE EPB FOR TP CLEANUP        +02340000
               ECODE=EC$LU62_CLUP,                                     +02350000
               ERRET=ERR$TASK,                                         +02360000
               MF=(E,$TASKMFL)                                          02370000
                                                                        02380000
         ST    R1,SAVEEPB         SAVE THE XEPB ADDRESS                 02390000
                                                                        02400000
*                                                                       02410000
* FILL IN THE TP CLEANUP WORK ELEMENT                                   02420000
*---------------------------------------------------------------------- 02430000
                                                                        02440000
         USING IWEVTAM,R3                                               02450000
         MVC   IWEYBENT,TKBTCBID  ENTITY TOKEN                          02460000
         MVC   IWEYBEPB,SAVEEPB   EPB ADDRESS                           02470000
         ST    RRCB,IWEYBRCB      RCB ADDRESS                           02480000
         DROP  R3                                                       02490000
                                                                        02500000
*                                                                       02510000
* QUEUE THE TP CLEANUP WORK ELEMENT TO THE SESSION QUEUE                02520000
*---------------------------------------------------------------------- 02530000
                                                                        02540000
         $VTAMQ (R3),             WORK ELEMENT                         +02550000
               ISEWEQ             QUEUE                                 02560000
                                                                        02570000
         LTR   R15,R15            QUEUING SUCCESSFUL?                   02580000
         BNZ   RQSYNCD            BRANCH IF NOT, SESSION MUST BE ENDING 02590000
                                                                        02600000
*                                                                       02610000
* RELEASE SERIALIZATION & WAIT FOR POSTING OF THE TP CLEANUP WE         02620000
*---------------------------------------------------------------------- 02630000
                                                                        02640000
         BAS   R14,VTAMUNLK       RELEASE LOCK                          02650000
                                                                        02660000
         $TASK WAIT,              WAIT FOR REQUEST COMPLETION          +02670000
               EPB=*SAVEEPB,      XEPB ADDRESS                         +02680000
               MF=(E,$TASKMFL)                                          02690000
                                                                        02700000
         B     RQSYNCD            AND CONTINUE ON                       02710000
                                                                        02720000
SKIPCLUP DS    0H                                                       02730000
                                                                        02740000
         BAS   R14,VTAMUNLK       RELEASE THE LOCK                      02750000
         B     NOTACTIV           BYPASS THE CMDEAL ALSO                02760000
                                                                        02770000
RQSYNCD  DS    0H                                                       02780000
                                                                        02790000
         BAS   R14,VTAMUNLK                                             02800000
                                                                        02810000
*---------------------------------------------------------------------- 02820000
* IF CONVERSATION IS IN AN ACTIVE STATE...ISSUE DEALLOCATE ABEND        02830000
*---------------------------------------------------------------------- 02840000
                                                                        02850000
         TM    ICTSTAT3,ICT3$P+ICT3$PX                                  02860000
         BNZ   NOTACTIV           BRANCH IF SYSTEM TERMINATING          02870000
                                                                        02880000
         TM    IVTF1,IVTF1TRM                                           02890000
         BO    NOTACTIV           BRANCH IF VTAM MAIN TASK TERMINATING  02900000
                                                                        02910000
         CLC   RCBCONVS,=A(CM_SEND_STATE)                               02920000
         BE    DEALABND                                                 02930000
         CLC   RCBCONVS,=A(CM_RECEIVE_STATE)                            02940000
         BE    DEALABND                                                 02950000
         CLC   RCBCONVS,=A(CM_SEND_PENDING_STATE)                       02960000
         BE    DEALABND                                                 02970000
         CLC   RCBCONVS,=A(CM_CONFIRM_STATE)                            02980000
         BE    DEALABND                                                 02990000
         CLC   RCBCONVS,=A(CM_CONFIRM_SEND_STATE)                       03000000
         BE    DEALABND                                                 03010000
         CLC   RCBCONVS,=A(CM_CONFIRM_DEALLOCATE_STATE)                 03020000
         BE    DEALABND                                                 03030000
         B     NOTACTIV                                                 03040000
                                                                        03050000
DEALABND DS    0H                                                       03060000
                                                                        03070000
         MVC   RCBDEAL,=A(CM_DEALLOCATE_ABEND)                          03080000
                                                                        03090000
         CMDEAL CMCONVID,                                              +03100000
               CMRETCD,                                                +03110000
               MF=(E,CMMFL)       ISSUE DEALLOCATE ABEND                03120000
                                                                        03130000
         B     NEXTCONV                                                 03140000
                                                                        03150000
NOTACTIV DS    0H                                                       03160000
                                                                        03170000
*---------------------------------------------------------------------- 03180000
* IF CONVERSATION IS IN AN "UNKNOWN" STATE...JUST RELEASE THE RCB       03190000
*---------------------------------------------------------------------- 03200000
                                                                        03210000
         L62DLRC (RRCB),                                               +03220000
               L62RETCD,                                               +03230000
               MF=(E,L62MFL)      DELETE THE RCB                        03240000
                                                                        03250000
         B     NEXTCONV                                                 03260000
                                                                        03270000
*---------------------------------------------------------------------- 03280000
* IF THIS TP INITIATED A VTAM ENVIRONMENT...                            03290000
* STOP THE ASSOCIATED VTAM USER.                                        03300000
*---------------------------------------------------------------------- 03310000
                                                                        03320000
CHECKENV DS    0H                                                       03330000
                                                                        03340000
         TM    TKBF1,TKBF1VTM     DID TP INITIATE VTAM ENVIRONMENT?     03350000
         BNO   RETURN             BRANCH IF NOT                         03360000
                                                                        03370000
         $VTAMWE L'IWEXI,                                              +03380000
               IWECSTPU           ALLOCATE "STOP USER" WORK ELEMENT     03390000
                                                                        03400000
         LR    R3,R1              WORK ELEMENT ADDRESS                  03410000
                                                                        03420000
         $VTAMQ (R3),             WORK ELEMENT                         +03430000
               IVUWEQ             QUEUE                                 03440000
                                                                        03450000
         B     RETURN                                                   03460000
                                                                        03470000
*---------------------------------------------------------------------- 03480000
* RETURN TO CALLER                                                      03490000
*---------------------------------------------------------------------- 03500000
                                                                        03510000
RETURN   DS    0H                                                       03520000
                                                                        03530000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 03540000
                                                                        03550000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    03560000
                                                                        03570000
*---------------------------------------------------------------------- 03580000
* SUBROUTINE VTAMLOCK - OBTAIN VTAM GLOBAL LOCK                         03590000
*---------------------------------------------------------------------- 03600000
                                                                        03610000
VTAMLOCK DS    0H                                                       03620000
                                                                        03630000
         TM    FLAG,FLAGLOCK        HAVE WE ALREADY OBTAINED THE LOCK?  03640000
         BOR   R14                  RETURN IF YES                       03650000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             03660000
                                                                        03670000
         $SER  OBTAIN,                                                 +03680000
               VTAM                                                     03690000
                                                                        03700000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              03710000
         BNE   VTAMLOEX             BRANCH IF NOT                       03720000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         03730000
                                                                        03740000
VTAMLOEX DS    0H                                                       03750000
                                                                        03760000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               03770000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          03780000
         BR    R14                  RETURN                              03790000
                                                                        03800000
*---------------------------------------------------------------------- 03810000
* SUBROUTINE VTAMUNLK - RELEASE VTAM GLOBAL LOCK                        03820000
*---------------------------------------------------------------------- 03830000
                                                                        03840000
VTAMUNLK DS    0H                                                       03850000
                                                                        03860000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       03870000
         BNOR  R14                  BRANCH IF NOT                       03880000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             03890000
         BOR   R14                  DON'T RELEASE IF IT WAS             03900000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             03910000
                                                                        03920000
         $SER  RELEASE,                                                +03930000
               VTAM                                                     03940000
                                                                        03950000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  03960000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          03970000
         BR    R14                  RETURN                              03980000
                                                                        03990000
*---------------------------------------------------------------------- 04000000
* ERROR ROUTINES                                                        04010000
*---------------------------------------------------------------------- 04020000
                                                                        04030000
ERRTKB   $ABEND ABE_VTDIAG,                                            +04040000
               SCOPE=PCB,                                              +04050000
               TITLE='INVALID TKB AT PROCESS CLEANUP'                   04060000
                                                                        04070000
ERR$TASK $ABEND ABE_VTDIAG,                                            +04080000
               SCOPE=PCB,                                              +04090000
               TITLE='$TASK FAILURE'                                    04100000
                                                                        04110000
*---------------------------------------------------------------------- 04120000
*  CONSTANTS AND LITERALS                                               04130000
*---------------------------------------------------------------------- 04140000
                                                                        04150000
         LTORG ,                                                        04160000
         PRINT NOGEN                                                    04170000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                04180000
         ISTDBIND ,               VTAM BIND IMAGE                       04190000
         ISTRH ,                  VTAM SNA REQUEST HEADER               04200000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         04210000
         ICVT  ,                  INTEGRATOR CVT                        04220000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   04230000
         IRPL ,                   INTEGRATOR VTAM RPL+                  04240000
         IACB ,                   INTEGRATOR VTAM ACB+                  04250000
         INIB ,                   INTEGRATOR VTAM NIB+                  04260000
         ISESS ,                  INTEGRATOR SESSION BLOCK              04270000
         IRQE ,                   INTEGRATOR RECEIVE QUEUE ELEMENT      04280000
         ISQE ,                   INTEGRATOR SESS INIT QUEUE ELEMENT    04290000
         IBQE ,                   INTEGRATOR BIND QUEUE ELEMENT         04300000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            04310000
         ITASK ,                  INTEGRATOR TASK BLOCK                 04320000
         IPCB ,                   INTEGRATOR PROCESS BLOCK              04330000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          04340000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       04350000
         EVCODES ,                INTEGRATOR EVENT CODES                04360000
         ABCODES ,                INTEGRATOR $ABEND CODES               04370000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     04380000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        04390000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             04400000
         $PROC DSECT=YES          INTEGRATOR $PROC SERVICES             04410000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             04420000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             04430000
         IFGEXLST ,               VTAM EXIT LIST                        04440000
         END   ,                                                        04450000

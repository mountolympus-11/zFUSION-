IVDBDET  TITLE '- DETACH VDB TABLE DEFINITION'                          00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: IVDBDET - Detach VDB table definition                        00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine is used to detach a user from a VDB table             00080000
*    definition acquired by IVDBGET.  The table definition use          00090000
*    count maintained in the RVD (ref VDBREFNT) is decremented.         00100000
*    If the use count goes to zero, the table definition                00110000
*    becomes eligible for delete.  The actual deletion may be           00120000
*    deferred depending on the use of VDBCACHE(), etc.                  00130000
*                                                                       00140000
*                                                                       00150000
* NOTES:                                                                00160000
*                                                                       00170000
*    Direct callers of IVDBLOAD must invoke IVDBRET to delete           00180000
*    their VDB table definitions, not this routine.                     00190000
*                                                                       00200000
*    PRJIRVDB, the current VDBCACHE value, must be updated              00210000
*    anytime that an active entry is deactivated but retained.          00220000
*                                                                       00230000
*                                                                       00240000
* ON ENTRY:                                                             00250000
*                                                                       00260000
*    R1  contains the address of a VDBLRET previously acquired          00270000
*        from IVDBGET                                                   00280000
*                                                                       00290000
*                                                                       00300000
* ON EXIT:                                                              00310000
*                                                                       00320000
*    R15 contains one of the following return codes                     00330000
*                                                                       00340000
*        RC00 - detach complete                                         00350000
*                                                                       00360000
*        RC04 - VDB table RVD not found                                 00370000
*                                                                       00380000
*        RC08 - VDB table not owned (programming error)                 00390000
*                                                                       00400000
*        RC12 - the VDBLRET anchored in the RVD is not the              00410000
*               same as the VDBLRET provided as input                   00420000
*                                                                       00430000
*        RC16 - reserved                                                00440000
*                                                                       00450000
*        RC20 - invalid query type (programming error)                  00460000
*                                                                       00470000
**<DOC-OFF>****************************************************         00480000
                                                                        00490000
         EJECT                                                          00500000
***************************************************************         00510000
*                                                                       00520000
* MAINTENANCE:                                                          00530000
*                                                                       00540000
*    08/28/95 R. Turgeon                                                00550000
*             Initial version                                           00560000
*                                                                       00570000
***************************************************************         00580000
                                                                        00590000
         EJECT                                                          00600000
         #WORK ,                                                        00610000
                                                                        00620000
REGSAVE  DS    16F           LOCAL SUBROUTINE SAVEAREA                  00630000
WK256    DS    0F,XL256      GENERAL PURPOSE WORKAREA                   00640000
                                                                        00650000
         #ENDWORK ,                                                     00660000
                                                                        00670000
         EJECT                                                          00680000
         VDBLOADP ,          IVDBLOAD REQUEST / RETURN LISTS            00690000
                                                                        00700000
         EJECT                                                          00710000
         VDBREFNT ,          VDB TABLE DEF REFERENCE ENTRY              00720000
                                                                        00730000
         EJECT                                                          00740000
         IPROJ ,             PROJECT                                    00750000
                                                                        00760000
         EJECT                                                          00770000
         EQUS ,                                                         00780000
                                                                        00790000
         EJECT                                                          00800000
IVDBDET  #ENTER BASE=R12,PREG=R8                                        00810000
                                                                        00820000
         USING ITASK,R10          ITASK ADDRESSABILITY                  00830000
                                                                        00840000
         EJECT                                                          00850000
***************************************************************         00860000
*                                                                       00870000
*   General initialization, locate the IPROJ                            00880000
*                                                                       00890000
***************************************************************         00900000
                                                                        00910000
         USING VDBLRET,R8         VDB TABLE DEFINITION                  00920000
                                                                        00930000
         L     R2,TSKPCBC         ADDRESS OF CURRENT PCB                00940000
         USING IPCB,R2            IPCB ADDRESSABILITY                   00950000
                                                                        00960000
         L     R9,PCBUSER         ADDRESS OF IUSER BLOCK                00970000
         USING IUSER,R9           LIFE OF FUNCTION                      00980000
                                                                        00990000
         L     R7,USRPROJ         ADDRESS OF IPROJ                      01000000
         USING IPROJ,R7           LIFE OF FUNCTION                      01010000
         DROP  R2                 IPCB                                  01020000
                                                                        01030000
***************************************************************         01040000
*                                                                       01050000
*   VDBLRET contains both the VDB table name and a DML statement        01060000
*   type identifier.  Using VDBLRET as a search argument, locate        01070000
*   the corresponding RVD entry and the DML RVDE.                       01080000
*                                                                       01090000
***************************************************************         01100000
                                                                        01110000
         LA    R0,VDBLRET         R0 <== VDB TABLE DEFINITION           01120000
         L     R1,PRJEXRTR        R1 <== RVD TREE ROOT                  01130000
         BAS   R14,LOCRVD         LOCATE THE ASSOCIATED RVD             01140000
         LTR   R9,R15             RVD LOCATED?                          01150000
         BZ    ERR_RVD            ERROR IF NOT                          01160000
                                                                        01170000
         USING VDBREFNT,R9        RVD FORMAT                            01180000
                                                                        01190000
         LA    R2,0               SELECT?                               01200000
         CLI   LVDBQTYP,C'S'                                            01210000
         BE    QTYPE                                                    01220000
                                                                        01230000
         LA    R2,1               INSERT?                               01240000
         CLI   LVDBQTYP,C'I'                                            01250000
         BE    QTYPE                                                    01260000
                                                                        01270000
         LA    R2,2               UPDATE?                               01280000
         CLI   LVDBQTYP,C'U'                                            01290000
         BE    QTYPE                                                    01300000
                                                                        01310000
         LA    R2,3               DELETE?                               01320000
         CLI   LVDBQTYP,C'D'                                            01330000
         BNE   ERR_QTYP           ERROR OTHERWISE                       01340000
                                                                        01350000
QTYPE    DS    0H                                                       01360000
         MH    R2,=AL2(RVDELN)    OFFSET TO DML ORIENTED INFO           01370000
         LA    R6,RVDLOAD(R2)     ADDR OF DML SECTION ENTRY             01380000
         USING RVDENTRY,R6                                              01390000
                                                                        01400000
         C     R8,RVDELRET        ARGUMENT VDBLRET MATCHES RVDE COPY?   01410000
         BNE   ERR_LRET           SOMETHING IS WRONG IF NOT             01420000
         DROP  R8                 VDBLRET                               01430000
                                                                        01440000
***************************************************************         01450000
*                                                                       01460000
*   Relinquish shared ownership of the VDB table definition             01470000
*   by swapping down the use count. If the use count is not             01480000
*   greater than zero, the caller does not have claim to it.            01490000
*                                                                       01500000
***************************************************************         01510000
                                                                        01520000
         LM    R0,R1,RVDESYNC     USE COUNT AND VDBLRET PTR             01530000
                                                                        01540000
RELEASE  DS    0H                                                       01550000
         LTR   R2,R0              CURRENT USE COUNT                     01560000
         BNP   ERR_OWN            OWNERSHIP CONFLICT (PGMING ERROR)     01570000
         BCTR  R2,0               RELINQUISH SHARED USE                 01580000
         LR    R3,R1              TABLE DEFINITION REMAINS INTACT       01590000
         CDS   R0,R2,RVDESYNC     UPDATE USAGE, RETAIN TABLE DESC       01600000
         BNE   RELEASE            PERSISTENCE                           01610000
                                                                        01620000
         LTR   R2,R2              TABLE REMAINS IN USE?                 01630000
         BNZ   NORMRET            DONE IF SO                            01640000
                                                                        01650000
         EJECT                                                          01660000
****************************************************************        01670000
*                                                                       01680000
*   The VDB table definition embodied in the VDBLRET anchored           01690000
*   in the RVDE is eligible for delete.  The VDBCACHE() value           01700000
*   determines which table definitions must actually be deleted         01710000
*   using an LRU approach.                                              01720000
*                                                                       01730000
****************************************************************        01740000
                                                                        01750000
         SR    R0,R0              RESET THE UNREFERRENCED INTERVAL ...  01760000
         ST    R0,RVDELRU         COUNTER ASSOC WITH AN INACTIVE ENTRY  01770000
                                                                        01780000
*---------------------------------------------------------------        01790000
*   post total inactive def size - done if not excessive                01800000
*---------------------------------------------------------------        01810000
                                                                        01820000
         L     R1,RVDESIZE        SIZE OF ATTACHED VDB DEFINITION       01830000
                                                                        01840000
LRUAGE   DS    0H                                                       01850000
         L     R2,PRJIRVDB        CURRENT VDBCACHE STG COMMITMENT       01860000
         LA    R0,0(R1,R2)        ACCOUNT FOR CURRENT AS NEWLY INACTIVE 01870000
         CS    R2,R0,PRJIRVDB     UPDATE TOTAL INACTIVE                 01880000
         BNE   LRUAGE             PERSISTENT UPDATE, CLEANUP FOLLOWS    01890000
                                                                        01900000
         C     R0,PRJCSVDB        TOTAL INACTIVE EXCEEDS VDBCACHE()?    01910000
         BNH   NORMRET            DONE IF NOT                           01920000
                                                                        01930000
*---------------------------------------------------------------        01940000
*   scan all RVDEs to identify the least recently used entry            01950000
*---------------------------------------------------------------        01960000
                                                                        01970000
LRUSCAN  DS    0H                                                       01980000
         SR    R0,R0              HIGHEST UIC ENCOUNTERED BY RVDE SCAN  01990000
         SR    R6,R6              DESELECT CURRENT RVDE, BEGIN SEARCH   02000000
         USING RVDENTRY,R6        JUST A REMINDER                       02010000
                                                                        02020000
         L     R9,PRJEXRFQ        BEGIN SCAN OF VDB REQUEST ENTRIES     02030000
         USING VDBREFNT,R9        AGAIN, JUST A REMINDER                02040000
                                                                        02050000
LRUNEXT  DS    0H                                                       02060000
         LA    R3,RVDLOAD         VDB DEF RVDE ARRAY ORIGIN             02070000
C        USING RVDENTRY,R3        JUST A REMINDER                       02080000
         LA    R4,RVDELN          LENGTH OF EACH RVDE                   02090000
         LA    R5,RVDLOADE-1      END OF ARRAY, BXLE FORMAT             02100000
                                                                        02110000
LRURVDE  DS    0H                                                       02120000
         LM    R14,R15,C.RVDESYNC FETCH USE COUNT / VDBLRET PTR         02130000
         LTR   R14,R14            INACTIVE?                             02140000
         BNZ   LRUADV             SKIP IF NOT                           02150000
         LTR   R15,R15            DEFINITION RETAINED?                  02160000
         BZ    LRUADV             SKIP IF NOT                           02170000
                                                                        02180000
         L     R14,C.RVDELRU      FETCH ASSOCIATED UIC                  02190000
         LA    R14,1(,R14)        REFLECT THIS EVALUATION PASS          02200000
         ST    R14,C.RVDELRU      UPDATE THE RVDE ACCORDINGLY           02210000
         CR    R0,R14             OLDEST RVDE ENCOUNTERED SO FAR?       02220000
         BNL   LRUADV             SKIP IF NOT                           02230000
                                                                        02240000
         LR    R0,R14             CANDIDATE UIC                         02250000
         LR    R6,R3              CANDIDATE RVDE ADDRESS                02260000
                                                                        02270000
LRUADV   DS    0H                 ADVANCE TO NEXT RVD DML ENTRY         02280000
         BXLE  R3,R4,LRURVDE      CONSIDER EACH DML USAGE               02290000
         ICM   R9,15,RVDNEXT      NEXT VDB REFERENCE NODE               02300000
         BNZ   LRUNEXT            CONTINUE                              02310000
         DROP  C                  CANDIDATE RVDENTRY                    02320000
                                                                        02330000
*---------------------------------------------------------------        02340000
*   free least active VDB def and reeval VDBCACHE() compliance          02350000
*---------------------------------------------------------------        02360000
                                                                        02370000
         L     R2,PRJIRVDB        CURRENT VDBCACHE STG COMMITMENT       02380000
         C     R2,PRJCSVDB        INACTIVE STILL EXCEEDS VDBCACHE()?    02390000
         BNH   NORMRET            DONE NAUGHT IF NOT                    02400000
                                                                        02410000
         LTR   R1,R6              R1 <== CANDIDATE FOR DELETE           02420000
         BZ    NORMRET            UNUSUAL ACTIVITY, BAIL OUT            02430000
         BAS   R14,RETVDB         ATTEMPT RELEASE OF OVERCOMMITTED STG  02440000
         BNZ   LRUSCAN            IF UNSUCCESSFUL, RESCAN               02450000
                                                                        02460000
LRUREMOV DS    0H                 WU IS ACCOUNTABLE                     02470000
         L     R2,PRJIRVDB        CURRENT VDBCACHE STG COMMITMENT       02480000
         LR    R0,R2              PREPARE FOR UPDATE                    02490000
         S     R0,RVDESIZE        ACCOUNT FOR CURRENT AS NEWLY ACTIVE   02500000
         CS    R2,R0,PRJIRVDB     UPDATE TOTAL INACTIVE                 02510000
         BNE   LRUREMOV           PERSISTENT UPDATE                     02520000
                                                                        02530000
         C     R0,PRJCSVDB        STILL CARRYING EXCESSIVE BAGGAGE?     02540000
         BH    LRUSCAN            AGEING REPEATS IF SO                  02550000
         DROP  R6,R9              RVDENTRY, VDBREFNT                    02560000
                                                                        02570000
         EJECT                                                          02580000
****************************************************************        02590000
*                                                                       02600000
*   Normal and abnormal termination                                     02610000
*                                                                       02620000
****************************************************************        02630000
                                                                        02640000
NORMRET  DS    0H                                                       02650000
         LA    R15,RC00           NORMAL COMPLETION                     02660000
         SR    R0,R0              REASON CODES NOT DEFINED              02670000
         B     EXIT                                                     02680000
                                                                        02690000
ERR_RVD  DS    0H                 VDB TABLE RVD NOT FOUND               02700000
         LA    R15,RC04           LOGIC ERROR                           02710000
         SR    R0,R0              REASON CODES NOT DEFINED              02720000
         B     EXIT                                                     02730000
                                                                        02740000
ERR_OWN  DS    0H                 TABLE NOT OWNED (SHARED)              02750000
         LA    R15,RC08           PROGRAMMING ERROR LIKELY              02760000
         SR    R0,R0              REASON CODES NOT DEFINED              02770000
         B     EXIT                                                     02780000
                                                                        02790000
ERR_LRET DS    0H                 VDBLRET MISMATCH                      02800000
         LA    R15,RC12           PROGRAMMING ERROR LIKELY              02810000
         SR    R0,R0              REASON CODES NOT DEFINED              02820000
         B     EXIT                                                     02830000
                                                                        02840000
ERR_QTYP DS    0H                 INVALID OR OMITTED DML STATEMENT TYPE 02850000
         LA    R15,RC20           PROGRAMMING ERROR LIKELY              02860000
         SR    R0,R0              RSN CODE UNDEFINED                    02870000
                                                                        02880000
*--------------------------------------------------------------         02890000
*   Return completion status to caller                                  02900000
*--------------------------------------------------------------         02910000
                                                                        02920000
EXIT     DS    0H                                                       02930000
         #EXIT                                                          02940000
                                                                        02950000
         EJECT                                                          02960000
****************************************************************        02970000
*                                                                       02980000
* ROUTINE:  RETVDB                                                      02990000
*                                                                       03000000
* DESCRIPTION:                                                          03010000
*                                                                       03020000
*    Swap the presumably inactive VDBLRET off the RVDE and delete       03030000
*    it and all associated data areas.  If the VDB definition           03040000
*    is active, the delete is not performed.                            03050000
*                                                                       03060000
*                                                                       03070000
* ON ENTRY:                                                             03080000
*                                                                       03090000
*    R1  contains the address of an RVD DML statement entry             03100000
*                                                                       03110000
*                                                                       03120000
* ON EXIT:                                                              03130000
*                                                                       03140000
*    R15 contains one of the following return codes                     03150000
*        The condition code is set accordingly                          03160000
*                                                                       03170000
*        RC00 - VDB table definition deleted                            03180000
*                                                                       03190000
*        RC04 - VDB table definition is active and not deleted          03200000
*                                                                       03210000
****************************************************************        03220000
                                                                        03230000
RETVDB   DS    0H                                                       03240000
         STM   R1,R14,REGSAVE+4   PRESERVE MAINLINE REGS                03250000
         LR    R6,R1              DML ORIENTED RVD ENTRY                03260000
         USING RVDENTRY,R6        RVDE                                  03270000
         LA    R15,RC04           PRESUME ACTIVE                        03280000
                                                                        03290000
         SR    R0,R0              TABLE MUST REMAIN INACTIVE            03300000
         L     R1,RVDELRET        R1 <== VDBLRET PTR (AS PARM)          03310000
         SR    R2,R2              GUARANTEE INACTIVE                    03320000
         SR    R3,R3              VDBLRET PTR REMOVAL                   03330000
         CDS   R0,R2,RVDESYNC     SWAP IT OUT                           03340000
         BNE   RETVXIT            LOOSE INTEREST IF RENEWED ACTIVITY    03350000
                                                                        03360000
         @CALL IVDBRET,CTYPE=CVT,WKA=WK256                              03370000
                                                                        03380000
         SR    R15,R15            INDICATE SUCCESS                      03390000
                                                                        03400000
RETVXIT  DS    0H                                                       03410000
         LM    R1,R14,REGSAVE+4   RESTORE MAINLINE REGS                 03420000
         LTR   R15,R15            REFLECT DELETION STATUS               03430000
         BR    R14                RETURN                                03440000
         DROP  R6                 RVDENTRY                              03450000
                                                                        03460000
         EJECT                                                          03470000
***************************************************************         03480000
*                                                                       03490000
* ROUTINE:  LOCRVD - Search RVD tree by table name                      03500000
*                                                                       03510000
* DESCRIPTION:                                                          03520000
*                                                                       03530000
*    This routine is used to search an RVD (ref VDBREFNT)               03540000
*    subtree for the occurrence of the VDB table referenced in          03550000
*    the VDBLRET table definition return area.                          03560000
*                                                                       03570000
*    The RVD tree is a binary tree.  The left subtree of the            03580000
*    the current RVD contains entries for tables whose names            03590000
*    are "smaller" than the current.  The right subtree contains        03600000
*    entries for those table names "bigger" than the current,           03610000
*    etc.                                                               03620000
*                                                                       03630000
*                                                                       03640000
* ON ENTRY:                                                             03650000
*                                                                       03660000
*    R1  contains the address of the root RVD entry (VDBREFNT)          03670000
*    R0  contains the address of an VDBLRET VDB table definition        03680000
*                                                                       03690000
*                                                                       03700000
* ON EXIT:                                                              03710000
*                                                                       03720000
*    R15 contains the address of the matched RVD or zero                03730000
*                                                                       03740000
***************************************************************         03750000
                                                                        03760000
LOCRVD   DS    0H                                                       03770000
         LTR   R15,R1             RVD ROOT AVAILABLE?                   03780000
         BZR   R14                DONE IF NOT                           03790000
                                                                        03800000
         ST    R14,FWORD          PRESERVE RETURN ADDRESS               03810000
         LR    R14,R0             VDBLRET AS SEARCH ARGUMENT            03820000
                                                                        03830000
R        USING VDBREFNT,R15       CURRENT ENTRY                         03840000
V        USING VDBLRET,R14                                              03850000
                                                                        03860000
*--------------------------------------------------------------         03870000
*   Search the ordered btree for a matching RVD entry                   03880000
*--------------------------------------------------------------         03890000
                                                                        03900000
LOCSRCH  DS    0H                                                       03910000
         CLC   R.RVDTBLNM,V.LVDBTABL   MATCHING TABLE NAME?             03920000
         BE    LOCXIT             RETURN CURRENT RVD IF SO              03930000
         LA    R1,R.RVDLEFT       ASSUME LEFT SUBTREE                   03940000
         BH    *+8                IT CONTAINS THE SMALLER NAMES         03950000
         LA    R1,R.RVDRIGHT      ELSE RIGHT SUBTREE FOR BIGGER NAMES   03960000
         ICM   R15,15,0(R1)       ADVANCE DOWN THE APPROPRIATE SUBTREE  03970000
         BNZ   LOCSRCH            AND CONTINUE THE SEARCH               03980000
         DROP  R,V                VDBREFNT, VDBLRET                     03990000
                                                                        04000000
*--------------------------------------------------------------         04010000
*   Return matching RVD (*RVD) or RVD subtree root addr (**RVD)         04020000
*--------------------------------------------------------------         04030000
                                                                        04040000
LOCXIT   DS    0H                                                       04050000
         L     R14,FWORD          RESTORE RETURN ADDR                   04060000
         BR    R14                RETURN                                04070000
                                                                        04080000
         EJECT                                                          04090000
***************************************************************         04100000
*                                                                       04110000
*   Local read only storage                                             04120000
*                                                                       04130000
***************************************************************         04140000
                                                                        04150000
         LTORG ,                                                        04160000
                                                                        04170000
         EJECT                                                          04180000
         PRINT NOGEN                                                    04190000
         ICVT  ,                                                        04200000
         ITASK ,                                                        04210000
         IPCB  ,                                                        04220000
         IUSER ,                                                        04230000
         END   ,                                                        04240000

IRECON   TITLE '- START SESSION RECORDING'                              00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: IRECON - Start session recording                             00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine is used to begin a recording of a session             00080000
*    beginning with the current state displayed at the time the         00090000
*    start request is received.  The requester (workbench)              00100000
*    provides a recording name which must be unique within the          00110000
*    current project.  This is verified by attempting to insert         00120000
*    a SYSRECORDINGS catalog row having the given recording             00130000
*    name.  Note that this is the only true catalog table               00140000
*    updated until the recording is actually stored.  This              00150000
*    update is done at the outset to ensure that concurrent             00160000
*    recordings begun on parallell sessions do not reuse the            00170000
*    selected name.  The "invalid" bit is set in the new row to         00180000
*    indicate that the recording is incomplete.  Later, when            00190000
*    the recording is saved, the row is updated to remove that          00200000
*    indication.                                                        00210000
*                                                                       00220000
*    Additionally, to avoid conflicts with project catalog              00230000
*    tables, recording names may not begin with "SYS".                  00240000
*                                                                       00250000
*    The recording itself consists of candidate SYSIMAGE,               00260000
*    SYSSKS, and SYSNAVIGATION entries which are written to a           00270000
*    temporary table created for that purpose. When the                 00280000
*    recording is saved, the temporary table is used to post            00290000
*    permanent entries to the project catalog.                          00300000
*                                                                       00310000
*                                                                       00320000
* ON ENTRY:                                                             00330000
*                                                                       00340000
*    R1  contains the address of the sessimag defining the              00350000
*        current session                                                00360000
*                                                                       00370000
*    R0  contains the address of the candidate recording name           00380000
*        (CL16)                                                         00390000
*                                                                       00400000
*                                                                       00410000
* ON EXIT:                                                              00420000
*                                                                       00430000
*    R15 contains one of the following return codes. Reason             00440000
*        codes, when defined, are returned in R0.                       00450000
*                                                                       00460000
*           RC00 - recording initialization complete                    00470000
*           RC04 - recording name already defined                       00480000
*           RC08 - recording already active                             00490000
*           RC12 - invalid recording name                               00500000
*                                                                       00510000
**<DOC-OFF>****************************************************         00520000
                                                                        00530000
         EJECT                                                          00540000
***************************************************************         00550000
*                                                                       00560000
* MAINTENANCE:                                                          00570000
*                                                                       00580000
*    03/30/95 R. Turgeon                                                00590000
*             Disallow recording names begining with "SYS" to           00600000
*             prevent conflicts between temporary table and             00610000
*             catalog table names.                                      00620000
*                                                                       00630000
*    07/11/95 R. Turgeon      PAR 198778                         198778 00640000
*             Test for existance of candidate recording name     198778 00650000
*             in SYSRECORDINGs corrected after change to TBADD   198778 00660000
*             return and reason codes.                           198778 00670000
*                                                                       00680000
***************************************************************         00690000
                                                                        00700000
         EJECT                                                          00710000
         #WORK ,                                                        00720000
                                                                        00730000
RECNAME  DS    CL16               RECORDING NAME                        00740000
$SYSREC  DS    0D,XL(SRECLN)      SYSRECORDINGS ROW CONSTRUCTION AREA   00750000
WK256    DS    0D,XL256           GENERAL PURPOSE WORKAREA              00760000
                                                                        00770000
         #ENDWORK ,                                                     00780000
                                                                        00790000
         EJECT                                                          00800000
         ICATALOG RECORDING       SYSRECORDINGS ROW FORMAT              00810000
                                                                        00820000
         EJECT                                                          00830000
         IPROJ ,                                                        00840000
                                                                        00850000
         EJECT                                                          00860000
         SESSIMAG ,               EMULATOR SESS / RECORDING AREA        00870000
                                                                        00880000
         EJECT                                                          00890000
         TRECAUX ,                TEMP TABLE FOR CANDIDATE RECORDINGS   00900000
                                                                        00910000
         EJECT                                                          00920000
         ABCODES ,                                                      00930000
                                                                        00940000
         EQUS  ,                                                        00950000
                                                                        00960000
         TBSERVIS ADD,CREATE,PRINT=NOGEN                                00970000
                                                                        00980000
         EJECT                                                          00990000
IRECON   #ENTER PREG=(R8,R7)                                            01000000
                                                                        01010000
         USING ITASK,R10                                                01020000
         USING IPCB,R9            PROCESS MODE                          01030000
         L     R9,TSKPCBC                                               01040000
                                                                        01050000
         EJECT                                                          01060000
***************************************************************         01070000
*                                                                       01080000
*   Fetch parameters, validate request sequence                         01090000
*                                                                       01100000
***************************************************************         01110000
                                                                        01120000
         USING SESSIMAG,R8        LIFE OF FUNCTION                      01130000
         MVC   RECNAME,0(R7)      ACCEPT CANDIDATE RECORDING NAME       01140000
         CLC   =C'SYS',RECNAME    RECORDING NAME SATISFIES CONSTRAINTS? 01150000
         BE    ERR_NAME           REJECT IF NOT                         01160000
                                                                        01170000
         TM    SEIRECFL,SEIR_ACT  RECORDING ALREADY ACTIVE              01180000
         BO    ERR_SEQ            REJECT REQUEST IF SO                  01190000
                                                                        01200000
*--------------------------------------------------------------         01210000
*   Format SYSRECORDING row from source parms                           01220000
*--------------------------------------------------------------         01230000
                                                                        01240000
         L     R7,SEIIPROJ        LOCATE PROJECT                        01250000
         USING IPROJ,R7           MAPPED                                01260000
                                                                        01270000
         LA    R6,$SYSREC         SYSRECORINGS ROW I/O AREA             01280000
         USING SRECSECT,R6        MAPPED                                01290000
         MVC   SRECNAME,RECNAME   RECORDING NAME                        01300000
         MVC   SRECAPPL,SEIAPPL   VTAM APPLICATION NAME                 01310000
         MVC   SRECMODE,SEILMODE  LOGMODE                               01320000
         MVI   SRECFLG1,SRECFINV  INCOMPLETE RECORDING                  01330000
                                                                        01340000
         TBADD $SYSREC,           REGISTER THE PENDING RECORDING       X01350000
               TTOKEN=PRJTKREC,                                        X01360000
               MF=(E,WK256)                                             01370000
                                                                        01380000
         CH    R15,=AL2(RC08)     REQUEST COMPLETE?                     01390000
         BE    ERR_DUP            NAME ALREADY IN USE IF SO             01400000
         BH    ABN_TBSV           SERIOUS PROBLEM                       01410000
                                                                        01420000
*--------------------------------------------------------------         01430000
*   Create a temp table to house candidate recording                    01440000
*--------------------------------------------------------------         01450000
                                                                        01460000
RECDEF   DS    0H                                                       01470000
         ST    R0,SEISREC         SAVE ROWID OF SYSRECORDINGS ENTRY     01480000
         LA    R0,WK256           WORKAREA                              01490000
         SR    R1,R1              PARMS NOT DEFINED                     01500000
                                                                        01510000
         @CALL IPRJTBNM,CTYPE=CVT ACQUIRE TEMPORARY TABLE NAME          01520000
                                                                        01530000
         MVC   SEIAUXTB,0(R1)     SAVE TABLE NAME                       01540000
         MVC   SEIRECNM,RECNAME   RETAIN NAME OF RECORDING              01550000
                                                                        01560000
         TBCREATE SEIRECNM,       CREATE TEMPORARY TABLE               X01570000
               DESC='SESSION RECORDING',                               X01580000
               COLS=(RTYPE,RCNTL,RVARX),                               X01590000
               OPTS=REPLACE,                                           X01600000
               STOKEN=PRJTOKEN,                                        X01610000
               TTOKEN=SEIAUXTK,                                        X01620000
               MF=(E,WK256)                                             01630000
                                                                        01640000
         LTR   R15,R15            NORMAL COMPLETION?                    01650000
         BNZ   ABN_TBSV           FAIL IF NOT                           01660000
                                                                        01670000
         XC    SEIMAGES,SEIMAGES  RESET IMAGE # ASSIGNMENT BASE         01680000
         OI    SEIRECFL,SEIR_ACT  INDICATE RECORDING IN PROGRESS        01690000
                                                                        01700000
*--------------------------------------------------------------         01710000
*   Return completion status to requester                               01720000
*--------------------------------------------------------------         01730000
                                                                        01740000
         LA    R15,RC00           NORMAL COMPLETION                     01750000
         SR    R0,R0              REASON CODES NOT DEFINED              01760000
         B     RETURN             DONE                                  01770000
                                                                        01780000
ERR_DUP  DS    0H                 RECORDING NAME ALREADY IN USE         01790000
         LA    R15,RC04                                                 01800000
         SR    R0,R0              REASON CODES NOT DEFINED              01810000
         B     RETURN                                                   01820000
                                                                        01830000
ERR_SEQ  DS    0H                 RECORDING ALREADY ACTIVE ON THIS SESS 01840000
         LA    R15,RC08                                                 01850000
         SR    R0,R0              REASON CODES NOT DEFINED              01860000
         B     RETURN                                                   01870000
                                                                        01880000
ERR_NAME DS    0H                 INVALID RECORDING NAME                01890000
         LA    R15,RC12                                                 01900000
         SR    R0,R0              REASON CODES NOT DEFINED              01910000
         B     RETURN                                                   01920000
                                                                        01930000
RETURN   DS    0H                                                       01940000
         #EXIT ,                                                        01950000
                                                                        01960000
         EJECT                                                          01970000
***************************************************************         01980000
*                                                                       01990000
*   Catastrophic failures                                               02000000
*                                                                       02010000
***************************************************************         02020000
                                                                        02030000
ABN_TBSV DS    0H                 CATALOG / TABLE SERVICE FAILURE       02040000
                                                                        02050000
         $ABEND ABE_TBSERV,DUMP=YES,                                   X02060000
               TITLE='TABLE SERVICE FAILURE'                            02070000
                                                                        02080000
         EJECT                                                          02090000
***************************************************************         02100000
*                                                                       02110000
*   Local read-only data areas                                          02120000
*                                                                       02130000
***************************************************************         02140000
                                                                        02150000
         TBCOLDEF TYPE=DECLARE,BASE=TRECAUX                             02160000
                                                                        02170000
RTYPE    TBCOLDEF TRECTYPE,DATATYP=CHAR                                 02180000
RCNTL    TBCOLDEF TRECCNTL,DATATYP=BIN                                  02190000
RVARX    TBCOLDEF TRECVARX,DATATYP=VARBINX                              02200000
                                                                        02210000
         TBCOLDEF TYPE=END                                              02220000
                                                                        02230000
*--------------------------------------------------------------         02240000
                                                                        02250000
         LTORG ,                                                        02260000
                                                                        02270000
         EJECT                                                          02280000
         PRINT NOGEN                                                    02290000
         ICVT  ,                                                        02300000
         ITASK ,                                                        02310000
         IPCB  ,                                                        02320000
         END   ,                                                        02330000

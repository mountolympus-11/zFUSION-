IVTMNTPN TITLE 'INTEGRATOR - TPEND MAIN TASK EXTENSION'                 00010000
**<DOC-ON>************************************************************* 00020000
*                                                                       00030000
* ROUTINE: IVTMNTPN - INTEGRATOR TPEND MAIN TASK EXTENSION              00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
* ON ENTRY:                                                             00080000
*                                                                       00090000
*    R15 = ENTRY POINT ADDRESS                                          00100000
*    R14 = RETURN ADDRESS                                               00110000
*    R13 = AVAILABLE SAVE AREA                                          00120000
*    R11 = ICVT ADDRESS                                                 00130000
*    R10 = ITASK ADDRESS                                                00140000
*    R01 = IWE ADDRESS (WORK ELEMENT)                                   00150000
*                                                                       00160000
* ON EXIT:                                                              00170000
*                                                                       00180000
*    R15 = 0                                                            00190000
*    R00 = 0                                                            00200000
*    R01 = 0                                                            00210000
*                                                                       00220000
*    ALL OTHER REGISTERS ARE RESTORED                                   00230000
*                                                                       00240000
**<DOC-OFF>************************************************************ 00250000
                                                                        00260000
         EJECT ,                                                        00270000
*********************************************************************** 00280000
*                                                                       00290000
* MAINTENANCE:                                                          00300000
*                                                                       00310000
*   08/01/93 RANDY WITEK                                                00320000
*                                                                       00330000
*********************************************************************** 00340000
                                                                        00350000
         EQUS  ,                  GENERAL EQUATES                       00360000
                                                                        00370000
RICVT    EQU   R11                                                      00380000
RITASK   EQU   R10                                                      00390000
RIVTAM   EQU   R9                                                       00400000
RIACB    EQU   R8                                                       00410000
RIRPL    EQU   R7                                                       00420000
RIWE     EQU   R6                                                       00430000
RISESS   EQU   R5                                                       00440000
                                                                        00450000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00460000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00470000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00480000
         USING IACB,RIACB         ESTABLISH ADDRESSABILITY              00490000
         USING IRPL,RIRPL         ESTABLISH ADDRESSABILITY              00500000
         USING IWEVTAM,RIWE       ESTABLISH ADDRESSABILITY              00510000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00520000
                                                                        00530000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00540000
                                                                        00550000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00560000
                                                                        00570000
WRK256   DS    XL256              GENERAL WORKAREA                      00580000
                                                                        00590000
RETR15   DS    F                  RETURN CODE VALUE                     00600000
RETR0    DS    F                  RETURN REGISTER 0                     00610000
RETR1    DS    F                  RETURN REGISTER 1                     00620000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00630000
                                                                        00640000
FLAG     DS    X                                                        00650000
FLAGLOCK EQU   X'80'              VTAM GLOBAL LOCK HELD                 00660000
FLAGLCKD EQU   X'40'              VTAM GLOBAL LOCK HELD ON ENTRY        00670000
                                                                        00680000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00690000
                                                                        00700000
         $MSGDFT PREFIX=ICTPID,                                        +00710000
               COMPID='VTM',                                           +00720000
               TABLE=*#MSGS,                                           +00730000
               WORKA=0,                                                +00740000
               MF=(E,WRK256),                                          +00750000
               PRINT=NOGEN                                              00760000
                                                                        00770000
IVTMNTPN #ENTER BASE=R12,         ENTRY LINKAGE                        +00780000
               AMODE=31,                                               +00790000
               PREG=(RIWE),                                            +00800000
               RMODE=ANY                                                00810000
                                                                        00820000
         L     RIACB,IWEX9ACB     REFERENCE TO ACB                      00830000
                                                                        00840000
*---------------------------------------------------------------------- 00850000
* TPEND EXIT WORK ELEMENT IS BEING PROCESSED                            00860000
*---------------------------------------------------------------------- 00870000
                                                                        00880000
         ICM   R1,15,IWEX9RC      CHECK FOR INTERNAL REASON CODE (-1)   00890000
         BM    SKIPMSG            BRANCH IF INTERNALLY GENERATED TPEND  00900000
                                                                        00910000
         $MSG  992,                                                    +00920000
               FIELDS=((IACNAME,8),                                    +00930000
               (IWEX9RC,4))       "TPEND EXIT FOR..."                   00940000
                                                                        00950000
SKIPMSG  DS    0H                                                       00960000
                                                                        00970000
*---------------------------------------------------------------------- 00980000
* SHOW THAT TERMINATION IS STARTED                                      00990000
*---------------------------------------------------------------------- 01000000
                                                                        01010000
         TM    IACF1,IACF1TRM     IS TERMINATION ALREADY STARTED?       01020000
         BO    RETURN             BRANCH IF YES                         01030000
         OI    IACF1,IACF1TRM     TERMINATION IS STARTED                01040000
         TM    IACF1,IACF1OPN     IS ACB OPEN?                          01050000
         BNO   RETURN             BRANCH IF NOT, ALL DONE               01060000
                                                                        01070000
*---------------------------------------------------------------------- 01080000
* ISSUE SETLOGON QUIESCE                                                01090000
*---------------------------------------------------------------------- 01100000
                                                                        01110000
         TM    IACF1,IACF1UNU     IS ACB USABLE?                        01120000
         BO    SKIPSLGN           BRANCH IF NOT                         01130000
                                                                        01140000
         $VTAM GETRPL,                                                 +01150000
               AREA=IVTRPACT,                                          +01160000
               ERRET=ERR$VTAM,                                         +01170000
               MF=(E,MFE_LIST)    ACQUIRE AN IRPL                       01180000
                                                                        01190000
         LR    RIRPL,R1           ESTABLISH ADDRESSIBILITY              01200000
         MVC   IRPWTGOK,=A(QUIEND) OK COMPLETION ROUTINE                01210000
         LA    R1,IVTWEQ          MAIN TASK WORK QUEUE                  01220000
         ST    R1,IRP@WEQ         WILL RECEIVE THE RPL COMPLETION       01230000
                                                                        01240000
         SETLOGON RPL=(RIRPL),                                         +01250000
               ACB=(RIACB),                                            +01260000
               OPTCD=(QUIESCE,ASY) STOP LOGON EXIT SCHEDULING           01270000
                                                                        01280000
         STM   R15,R0,IRPR15      SAVE VTAM RETURN CODES                01290000
                                                                        01300000
         $VTAM CHECKPH1,                                               +01310000
               AREA=(RIRPL),      CHECK ACCEPTANCE OF THIS RPL         +01320000
               MF=(E,MFE_LIST)                                          01330000
                                                                        01340000
         B     RETURN             OPEN IS COMPLETE, RETURN TO CALLER    01350000
                                                                        01360000
SKIPSLGN DS    0H                                                       01370000
                                                                        01380000
         OI    IACF1,IACF1QUI     SHOW THAT IACB IS QUIESCED            01390000
                                                                        01400000
*---------------------------------------------------------------------- 01410000
* OBTAIN VTAM GLOBAL SERIALIZATION                                      01420000
*---------------------------------------------------------------------- 01430000
                                                                        01440000
         BAS   R14,VTAMLOCK       OBTAIN VTAM GLOBAL SERIALIZATION      01450000
                                                                        01460000
*---------------------------------------------------------------------- 01470000
* LOCATE THE GIVEN IACB IN THE GLOBAL CHAIN OF ALL IACB'S               01480000
*---------------------------------------------------------------------- 01490000
                                                                        01500000
         LA    R14,IVTIA1ST                ADDRESS OF IACB CHAIN HEAD   01510000
         S     R14,=A(IACNEXT-IAC)         NORMALIZE FOR CHAIN RUN      01520000
                                                                        01530000
LOCANEXT DS    0H                                                       01540000
                                                                        01550000
         ICM   R14,15,IACNEXT-IAC(R14)     LINK TO NEXT IACB            01560000
         BM    LOCAFAIL                    BRANCH IF IACB NOT PRESENT   01570000
         CR    RIACB,R14                   COMPARE IACB POINTERS        01580000
         BNE   LOCANEXT                    BRANCH TO CONTINUE SEARCH    01590000
         B     LOCATED                     BRANCH IF THIS IS THE ONE    01600000
                                                                        01610000
LOCAFAIL DS    0H                                                       01620000
                                                                        01630000
         $MSG  991,                                                    +01640000
               FIELDS=((IACNAME,8))        "FAILED TO FIND ..."         01650000
                                                                        01660000
         B     TPNDUNLK                    DESERIALIZE AND EXIT         01670000
                                                                        01680000
LOCATED  DS    0H                                                       01690000
                                                                        01700000
*---------------------------------------------------------------------- 01710000
* RUN THE CHAIN OF ALL SESSIONS ON THE IACB AND SIGNAL AN END_SESSION   01720000
*---------------------------------------------------------------------- 01730000
                                                                        01740000
         LA    RISESS,IACIS1ST             ADDRESS OF ISESS HEADER      01750000
         S     RISESS,=A(ISEISNXT-ISESS)   NORMALIZE FOR CHAIN RUN      01760000
                                                                        01770000
LOCSNEXT DS    0H                                                       01780000
                                                                        01790000
         ICM   RISESS,15,ISEISNXT          LINK TO NEXT ISESS           01800000
         BM    TPNDUNLK                    EXIT AT END OF CHAIN         01810000
                                                                        01820000
         $VTAMWE L'IWEXH,                  LENGTH                      +01830000
               IWECENDS                    CODE                         01840000
                                                                        01850000
         LR    R4,R1                       SAVE WORK ELEMENT ADDRESS    01860000
                                                                        01870000
         $VTAMQ (R4),                      WORK ELEMENT                +01880000
               ISEWEQ                      QUEUE                        01890000
                                                                        01900000
         B     LOCSNEXT                    DO THE SAME FOR THE NEXT ONE 01910000
                                                                        01920000
*---------------------------------------------------------------------- 01930000
* DESERIALIZE AND EXIT                                                  01940000
*---------------------------------------------------------------------- 01950000
                                                                        01960000
TPNDUNLK DS    0H                                                       01970000
                                                                        01980000
         BAS   R14,VTAMUNLK       RELEASE VTAM GLOBAL SERIALIZATION     01990000
                                                                        02000000
*---------------------------------------------------------------------- 02010000
* IF THERE ARE NO ACTIVE SESSIONS ISSUE THE CLOSEACB NOW                02020000
*---------------------------------------------------------------------- 02030000
                                                                        02040000
         ICM   RISESS,15,IACIS1ST PICK UP HEAD OF CHAIN                 02050000
         BNM   RETURN             BRANCH IF THERE ARE ACTIVE SESSIONS   02060000
                                                                        02070000
         $VTAM CLOSEACB,                                               +02080000
               AREA=(RIACB),                                           +02090000
               MF=(E,MFE_LIST)                                          02100000
                                                                        02110000
*---------------------------------------------------------------------- 02120000
* RETURN TO MAIN TASK MAINLINE                                          02130000
*---------------------------------------------------------------------- 02140000
                                                                        02150000
RETURN   DS    0H                                                       02160000
                                                                        02170000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 02180000
                                                                        02190000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    02200000
                                                                        02210000
*---------------------------------------------------------------------- 02220000
* ERROR ROUTINES                                                        02230000
*---------------------------------------------------------------------- 02240000
                                                                        02250000
ERR$VTAM DS    0H                                                       02260000
                                                                        02270000
         $ABEND ABE_VTDIAG,                                            +02280000
               SCOPE=PCB,                                              +02290000
               TITLE='$VTAM FAILURE'                                    02300000
                                                                        02310000
*---------------------------------------------------------------------- 02320000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 02330000
*---------------------------------------------------------------------- 02340000
                                                                        02350000
VTAMLOCK DS    0H                                                       02360000
                                                                        02370000
         TM    FLAG,FLAGLOCK        HAVE WE ALREADY GOTTEN THE LOCK?    02380000
         BOR   R14                  BRANCH IF YES                       02390000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             02400000
                                                                        02410000
         $SER  OBTAIN,                                                 +02420000
               VTAM                                                     02430000
                                                                        02440000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              02450000
         BNE   VTAMLOEX             BRANCH IF NOT                       02460000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         02470000
                                                                        02480000
VTAMLOEX DS    0H                                                       02490000
                                                                        02500000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               02510000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          02520000
         BR    R14                  RETURN                              02530000
                                                                        02540000
*---------------------------------------------------------------------- 02550000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                02560000
*---------------------------------------------------------------------- 02570000
                                                                        02580000
VTAMUNLK DS    0H                                                       02590000
                                                                        02600000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       02610000
         BNOR  R14                  BRANCH IF NOT                       02620000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             02630000
         BOR   R14                  DON'T RELEASE IF IT WAS             02640000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             02650000
                                                                        02660000
         $SER  RELEASE,                                                +02670000
               VTAM                                                     02680000
                                                                        02690000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  02700000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          02710000
         BR    R14                  RETURN                              02720000
                                                                        02730000
*---------------------------------------------------------------------- 02740000
* THIS IS THE RPL COMPLETION ROUTINE FOR THE VTAM SETLOGON QUIESCE      02750000
*                                                                       02760000
* ON ENTRY:                                                             02770000
*                                                                       02780000
*    R15 = ENTRY POINT ADDRESS                                          02790000
*    R14 = RETURN ADDRESS                                               02800000
*    R13 = AVAILABLE SAVE AREA                                          02810000
*    R11 = ICVT ADDRESS                                                 02820000
*    R10 = ITASK ADDRESS                                                02830000
*    R09 = IVTAMCVT ADDRESS                                             02840000
*    R01 = ADDRESS OF COMPLETED IRPL                                    02850000
*---------------------------------------------------------------------- 02860000
                                                                        02870000
QUIEND   #ENTER BASE=R12,         ENTRY LINKAGE                        +02880000
               PREG=RIRPL,                                             +02890000
               EP=YES             THIS IS AN ENTRY POINT                02900000
                                                                        02910000
         L     RIACB,RPLDACB      RESTORE IACB POINTER                  02920000
         CLI   RPLRTNCD,0         GOOD COMPLETION?                      02930000
         BE    QUIFREE            BRANCH IF YES                         02940000
                                                                        02950000
         $MSG  011,               SHOW SETLOGON ERROR                  +02960000
               FIELDS=(IACNAME,                                        +02970000
               RPLRTNCD,                                               +02980000
               RPLFDB2)                                                 02990000
                                                                        03000000
QUIFREE  DS    0H                                                       03010000
                                                                        03020000
         $VTAM RETRPL,            FREE RPL                             +03030000
               AREA=(RIRPL),      IRPL ADDRESS                         +03040000
               ERRET=ERR$VTAM,                                         +03050000
               MF=(E,MFE_LIST)                                          03060000
                                                                        03070000
         B     SKIPSLGN           AND RE-JOIN TPEND PROCESSING          03080000
                                                                        03090000
*---------------------------------------------------------------------- 03100000
*  CONSTANTS AND LITERALS                                               03110000
*---------------------------------------------------------------------- 03120000
                                                                        03130000
         LTORG ,                                                        03140000
         PRINT NOGEN                                                    03150000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                03160000
         ISTDBIND ,               VTAM BIND IMAGE                       03170000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         03180000
         ICVT  ,                  INTEGRATOR CVT                        03190000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   03200000
         IRPL ,                   INTEGRATOR VTAM RPL+                  03210000
         IACB ,                   INTEGRATOR VTAM ACB+                  03220000
         INIB ,                   INTEGRATOR VTAM NIB+                  03230000
         ISESS ,                  INTEGRATOR SESSION BLOCK              03240000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            03250000
         ITASK ,                  INTEGRATOR TASK BLOCK                 03260000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          03270000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       03280000
         EVCODES ,                INTEGRATOR EVENT CODES                03290000
         ABCODES ,                INTEGRATOR $ABEND CODES               03300000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     03310000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        03320000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             03330000
         $PROC DSECT=YES          INTEGRATOR $PROC SERVICES             03340000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             03350000
         IFGEXLST ,               VTAM EXIT LIST                        03360000
         END   ,                                                        03370000

IGETFUNC TITLE 'RETRIEVE REMOTE FUNCTION ADDRESS'                       00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE:  IGETFUNC - Retrieve remote function address                 00040000
*                                                                       00050000
* FUNCTION:                                                             00060000
*                                                                       00070000
*   void * getfunc( char *funcname ) ;                                  00080000
*                                                                       00090000
* DESCRIPTION:                                                          00100000
*                                                                       00110000
*   This routine will locate and return the address of the              00120000
*   function pointer loaded during ICVT initialization.                 00130000
*   Function calls by address in SASC may be either remote              00140000
*   or local specified by using the __remote or __local.                00150000
*   The default in SASC is __remote which indicates that the            00160000
*   function pointer is actually a pointer to the function              00170000
*   address.  Since this is the compiler default,  this routine         00180000
*   will return the address of the function pointer.                    00190000
*                                                                       00200000
*                                                                       00210000
* NOTES:  This routine uses standard SASC linkage conventions,          00220000
*         provided by the CENTRY and CEXIT macros.                      00230000
*                                                                       00240000
* ENTRY:  Upon entry to this routine R1 contains the address            00250000
*         of the parameter list as follows.                             00260000
*                                                                       00270000
*             +0 - A( function name )                                   00280000
*                                                                       00290000
* EXIT:   Upon return from this routine R15 will contain one            00300000
*         of the following values:                                      00310000
*                                                                       00320000
*             0 - Function not found                                    00330000
*            \0 - Address of Function pointer                           00340000
*                                                                       00350000
**<DOC-OFF>*****************************************************        00360000
                                                                        00370000
         EJECT ,                                                        00380000
****************************************************************        00390000
*                                                                       00400000
* MAINTENANCE:                                                          00410000
*                                                                       00420000
*   10/13/93 Ron Colmone                                                00430000
*            Initial version                                            00440000
*                                                                       00450000
*   07/24/94 Ron Colmone           Par# 134222                          00460000
*            Fixed loop when entry not found in Mod table               00470000
*                                                                       00480000
****************************************************************        00490000
                                                                        00500000
         EJECT ,                                                        00510000
         $MODNTRY TYPE=DSECT      MODULE TABLE MAPPING                  00520000
                                                                        00530000
         EJECT ,                                                        00540000
         EQUS  ,                  GENERAL EQUATES                       00550000
                                                                        00560000
         EJECT ,                                                        00570000
         COPY  CRAB               "C"  RUNTIME ANCHOR BLOCK             00580000
         USING CRAB,R12           LIFETIME ADDRESSABILITY               00590000
                                                                        00600000
         EJECT ,                                                        00610000
         COPY  DSA                DYNAMIC SAVE AREA                     00620000
WORKDSA  DS    0D                 DSA USER SECTION                      00630000
MFE_LIST DS    10F                FUNCTION CALL PLIST AREA              00640000
                                                                        00650000
FUNCNAME DS    CL8                FUNCTION NAME                         00660000
                                                                        00670000
WORKLEN  EQU   *-WORKDSA          LENGTH OF DSA USER SECTION            00680000
DSALEN   EQU   *-DSA              LENGTH OF DSA                         00690000
                                                                        00700000
         EJECT ,                                                        00710000
IGETFUNC CSECT ,                                                        00720000
GETFUNC  CENTRY DSA=DSALEN                                              00730000
         USING DSA,R13            ADDRESSABILITY                        00740000
                                                                        00750000
         LR    R8,R1              SAVE PARM ADDRESS                     00760000
                                                                        00770000
         LA    R0,WORKDSA         WORKAREA ORIGIN                       00780000
         LA    R1,WORKLEN         LENGTH OF WORKAREA                    00790000
         SR    R15,R15            PREPAREA FOR CLEAR                    00800000
         MVCL  R0,R14             CLEAR WORKAREA                        00810000
                                                                        00820000
         ICM   R3,15,0(R8)        FUNCTION NAME ADDRESS                 00830000
         BZ    NOFUNC             FUNCTION NOT AVAILABLE                00840000
                                                                        00850000
         TRT   0(L'FUNCNAME+1,R3),ZEROTRM LOCATE NULL TERM              00860000
         BC    HITS,*+12          NULL FOUND                            00870000
         LA    R1,L'FUNCNAME      MAXIMUM FUNCTION NAME LENGTH          00880000
         B     *+6                CONTINUE WITH COPY                    00890000
         SR    R1,R3              LENGTH OF STRING                      00900000
                                                                        00910000
         MVC   FUNCNAME,=CL8' '   INITIALIZE FUNCTION NAME              00920000
         BCTR  R1,0               PREPARE FOR EX INSTR                  00930000
         EX    R1,*+4             COPY FUNCTION NAME                    00940000
         MVC   FUNCNAME(*-*),0(R3)  *** EX OBJECT ***                   00950000
                                                                        00960000
*---------------------------------------------------------------        00970000
*  RESTORE STANDARD ENVIRONMENT                                         00980000
*---------------------------------------------------------------        00990000
         @RESTENV ,                                                     01000000
         USING ICVT,R11           ADDRESSABILITY                        01010000
         USING ITASK,R10          ADDRESSABILITY                        01020000
                                                                        01030000
         EJECT ,                                                        01040000
***************************************************************         01050000
*                                                                       01060000
*  PROCESS MODULE TABLE TO LOCATE REQUESTED FUNCTION NAME               01070000
*                                                                       01080000
***************************************************************         01090000
                                                                        01100000
         L     R5,ICTMODT@        ADDRESS OF MODULE TABLE ORGIN         01110000
         USING MODHEAD,R5         TEMP ADDRESSABILITY                   01120000
                                                                        01130000
         LA    R2,1               INITIAL LOW  ENTRY INDEX              01140000
         L     R3,MODCOUNT        INITIAL HIGH ENTRY INDEX              01150000
         L     R6,MODFIRST        ADDRESS OF FIRST ENTRY                01160000
         USING MODNTRY,R5         ADDRESSABILITY                        01170000
                                                                        01180000
LOC_MOD  DS    0H                                                       01190000
         LR    R4,R3              COPY HIGH INDEX                       01200000
         SR    R4,R2              REMAINING ENTRIES IN RANGE            01210000
         SRA   R4,1               DIVIDE REMAINING ENTRIES BY 2         01220000
         AR    R4,R2              INDEX IF MIDDLE ENTRY                 01230000
         LR    R5,R4              COPY INDEX                            01240000
         BCTR  R5,0               DECREMENT FOR OFFSET CONV             01250000
         MH    R5,=AL2(MODLENG)   OFFSET TO ENTRY                       01260000
         LA    R5,0(R5,R6)        ADDRESS OF ENTRY                      01270000
                                                                        01280000
         CLC   MODNAME,FUNCNAME   FUNCTION NAME MATCH?                  01290000
         BE    FUNCADDR           YES, RETRIEVE FUNCTION ADDRESS        01300000
         BL    LOC_LOW            SET NEW STARTING ENTRY                01310000
                                                                        01320000
LOC_HIGH CR    R2,R3              HIGH/LOW EQUAL?                       01330000
         BNL   NOFUNC             NO MORE ENTRIES TO CHECK      134222  01340000
         LR    R3,R4              NEW HIGH WATER MARK                   01350000
         BCTR  R3,0               PREVIOUS ENTRY                        01360000
         B     LOC_MOD            TRY AGAIN                             01370000
                                                                        01380000
LOC_LOW  CR    R2,R3              HIGH/LOW EQUAL?                       01390000
         BNL   NOFUNC             NO MORE ENTRIES TO CHECK      134222  01400000
         LA    R2,1(,R4)          NEW LOW  WATER MARK                   01410000
         B     LOC_MOD            TRY AGAIN                             01420000
                                                                        01430000
*--------------------------------------------------------------         01440000
*  FUNCTION NOT FOUND IN TABLE                                          01450000
*--------------------------------------------------------------         01460000
NOFUNC   DS    0H                                                       01470000
         LA    R15,0              FUNCTION NOT FOUND                    01480000
         B     RETURN             RETURN                                01490000
                                                                        01500000
*--------------------------------------------------------------         01510000
*  RETRIEVE FUNCTION REMOTE ADDRESS                                     01520000
*--------------------------------------------------------------         01530000
FUNCADDR DS    0H                                                       01540000
         LH    R1,MODOFFST        OFFSET TO MODULE IN MODTBL            01550000
         LA    R15,ICTMODTB(R1)   ADDRESS OF FUNCTION PTR               01560000
         B     RETURN             RETURN                                01570000
                                                                        01580000
         EJECT ,                                                        01590000
***************************************************************         01600000
*                                                                       01610000
*  RETURN                                                               01620000
*                                                                       01630000
***************************************************************         01640000
RETURN   DS    0H                                                       01650000
         CEXIT RC=(R15)           RETURN                                01660000
                                                                        01670000
         EJECT ,                                                        01680000
****************************************************************        01690000
*                                                                       01700000
*  LITERALS AND CONSTANTS                                               01710000
*                                                                       01720000
****************************************************************        01730000
         LTORG ,                                                        01740000
                                                                        01750000
ZEROTRM  DC    X'FF',255AL1(0)                                          01760000
                                                                        01770000
         PRINT NOGEN                                                    01780000
         ICVT  ,                                                        01790000
         ITASK ,                                                        01800000
         IHAPSA ,                                                       01810000
         IKJTCB ,                                                       01820000
         PRINT GEN                                                      01830000
                                                                        01840000
         END   ,                                                        01850000

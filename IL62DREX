IL62DREX TITLE 'INTEGRATOR - LU6.2 DRIVER RECEIVE COMPLETION (EX)'      00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: IL62DREX - INTEGRATOR LU6.2 DRIVER RECEIVE COMPLETION (EX)   00100000
*                                                                       00110000
* DESCRIPTION: THIS ROUTINE IS CALLED TO MATCH LU6.2 DATA WITH          00120000
*              A CPIC REQUEST WHEN AN EXCEPTION CONDITION IS ACTIVE.    00130000
*                                                                       00140000
* ON ENTRY:                                                             00150000
*                                                                       00160000
*    R15 = ENTRY POINT ADDRESS                                          00170000
*    R14 = RETURN      ADDRESS                                          00180000
*    R13 = SAVE AREA   ADDRESS                                          00190000
*    R11 = ICVT        ADDRESS                                          00200000
*    R10 = ITASK       ADDRESS                                          00210000
*    R09 = IVTAMCVT    ADDRESS                                          00220000
*    R08 = ISESS       ADDRESS                                          00230000
*                                                                       00240000
* ON EXIT:                                                              00250000
*                                                                       00260000
*    R15 = 0                                                            00270000
*    R00 = 0                                                            00280000
*    R01 = 0                                                            00290000
*                                                                       00300000
*    ALL OTHER REGISTERS ARE RESTORED.                                  00310000
*                                                                       00320000
**<DOC-OFF>************************************************************ 00330000
                                                                        00340000
*********************************************************************** 00350000
*                                                                       00360000
* MAINTENANCE:                                                          00370000
*                                                                       00380000
*   07/01/94 RANDY WITEK                                                00390000
*                                                                       00400000
*********************************************************************** 00410000
                                                                        00420000
         EQUS  ,                  GENERAL EQUATES                       00430000
                                                                        00440000
RICVT    EQU   R11                                                      00450000
RITASK   EQU   R10                                                      00460000
RIVTAM   EQU   R9                                                       00470000
RISESS   EQU   R8                                                       00480000
RSPLIST  EQU   R7                                                       00490000
RRCB     EQU   R6                                                       00500000
                                                                        00510000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00520000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00530000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00540000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00550000
         USING SPLIST,RSPLIST     ESTABLISH ADDRESSABILITY              00560000
         USING RCB,RRCB           ESTABLISH ADDRESSABILITY              00570000
                                                                        00580000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00590000
WRK256   DS    XL256              GENERAL WORKAREA                      00600000
$WUMFL   $WULOC MF=L              PLIST CONSTRUCTION                    00610000
L62MFL   L62POST MF=L             PLIST CONSTRUCTION                    00620000
L62RETCD DS    F                  RETURN CODE RETURN AREA               00630000
SAVEWUR1 DS    F                  R1 FROM SUCCESSFUL (RC=0) $WULOC      00640000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00650000
SUB1SAVE DS    18F                SUBROUTINE SAVE AREA                  00660000
WUDATA   DS    XL16               WULOC RETURN AREA                     00670000
                                                                        00680000
RCV62ENT DS    XL(L'PCBENTKN)     ENTITY TOKEN OF CURRENT RCV/SHIP/SERR 00690000
RCV62EPB DS    A                  EPB ADDRESS  OF CURRENT RCV/SHIP/SERR 00700000
RCV62RCB DS    A                  RCB ADDRESS  OF CURRENT RCV/SHIP/SERR 00710000
RCV62PLA DS    A                  PARMLIST @   OF CURRENT RCV           00720000
                                                                        00730000
POSTCODE DS    F                  CPIC REQUEST POSTCODE                 00740000
FMH7SNS  DS    XL4                SENSE INFO FROM FMH7                  00750000
                                                                        00760000
DESC@    DS    F                  USED FOR TRACE FUNCTION               00770000
DESCLEN  DS    F                  USED FOR TRACE FUNCTION               00780000
TRACE@   DS    F                  USED FOR TRACE FUNCTION               00790000
TRACELEN DS    F                  USED FOR TRACE FUNCTION               00800000
                                                                        00810000
#RETCODE DS    F                  TEMPORARY RETURN_CODE AREA            00820000
RETR15   DS    F                                                        00830000
RETR0    DS    F                                                        00840000
RETR1    DS    F                                                        00850000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00860000
NRSPSNS  DS    XL4                SENSE FOR NEGATIVE RESPONSE           00870000
FLAG     DS    X                                                        00880000
FLAGDLCK EQU   X'80'              DISP LOCK HELD                        00890000
FLAGDLKD EQU   X'40'              DISP LOCK HELD ON ENTRY               00900000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00910000
                                                                        00920000
         $MSGDFT PREFIX=ICTPID,                                        +00930000
               COMPID='L62',                                           +00940000
               TABLE=*#MSGS,                                           +00950000
               WORKA=0,                                                +00960000
               MF=(E,WRK256),                                          +00970000
               PRINT=NOGEN                                              00980000
                                                                        00990000
IL62DREX #ENTER BASE=R12,                                              +01000000
               AMODE=31,                                               +01010000
               RMODE=ANY                                                01020000
                                                                        01030000
*---------------------------------------------------------------------- 01040000
* IS THERE AN ACTIVE CONVERSATION?                                      01050000
*---------------------------------------------------------------------- 01060000
                                                                        01070000
         ICM   R1,15,ISE62RCB        ASSOCIATED RCB?                    01080000
         BNP   ERR$LOST              BRANCH IF NOT                      01090000
                                                                        01100000
*---------------------------------------------------------------------- 01110000
* IS THERE AN ACTIVE RECEIVE/SHIP/SEND_ERROR REQUEST?                   01120000
*---------------------------------------------------------------------- 01130000
                                                                        01140000
RESTART  DS    0H                                                       01150000
                                                                        01160000
         ICM   R1,15,ISE62RRQ        ACTIVE RECEIVE?                    01170000
         BNZ   COPYRCV               BRANCH IF YES                      01180000
         ICM   R1,15,ISE62SRQ        ACTIVE SHIP/SEND_ERROR?            01190000
         BNZ   COPYSHIP              BRANCH IF YES                      01200000
         BZ    RETURN                RETURN IF NOT                      01210000
                                                                        01220000
COPYRCV  DS    0H                                                       01230000
                                                                        01240000
         MVC   RCV62PLA,SPL62PLA-SPLIST(R1) COPY PARM LIST ADDRESS      01250000
                                                                        01260000
COPYSHIP DS    0H                                                       01270000
                                                                        01280000
         MVC   RCV62ENT,SPL62ENT-SPLIST(R1) COPY                        01290000
         MVC   RCV62EPB,SPL62EPB-SPLIST(R1)  POSTING                    01300000
         MVC   RCV62RCB,SPL62RCB-SPLIST(R1)   INFORMATION               01310000
                                                                        01320000
*---------------------------------------------------------------------- 01330000
* SERIALIZE AND LOCATE CPIC USER'S WORK UNIT                            01340000
*---------------------------------------------------------------------- 01350000
                                                                        01360000
LOCATRCB DS    0H                                                       01370000
                                                                        01380000
         BAS   R14,DISPLOCK       SERIALIZE                             01390000
                                                                        01400000
         $WULOC LOCATE,           FIND THE WORK UNIT                   +01410000
               TOKEN=RCV62ENT,    WORK UNIT TOKEN ADDRESS              +01420000
               USERDATA=WUDATA,   XL16 AREA TO RECEIVE USER DATA       +01430000
               LOCKED=YES,        DISP LOCK LOCALLY ACQUIRED           +01440000
               MF=(E,$WUMFL)      VALIDATE WORK UNIT                    01450000
                                                                        01460000
         ST    R1,SAVEWUR1        SAVE FOR LATER                        01470000
         LTR   R15,R15            LOCATE SUCCESS?                       01480000
         BZ    LOCTDRCB           BRANCH IF YES, LOOK FOR SOME DATA     01490000
         OC    ISE62RRQ,ISE62RRQ  WAS IT A RECEIVE REQUEST?             01500000
         BZ    CLEARSRQ           BRANCH IF NOT                         01510000
         XC    ISE62RRQ,ISE62RRQ  CLEAR THE REQUEST                     01520000
         B     RESTART            AND RESTART THE PROCESS               01530000
                                                                        01540000
CLEARSRQ DS    0H                                                       01550000
                                                                        01560000
         OC    ISE62SRQ,ISE62SRQ  WAS IT A SHIP/SEND?                   01570000
         BZ    RETURN             BRANCH IF NOT                         01580000
         XC    ISE62SRQ,ISE62SRQ  CLEAR THE REQUEST                     01590000
         B     RESTART            AND RESTART THE PROCESS               01600000
                                                                        01610000
LOCTDRCB DS    0H                                                       01620000
                                                                        01630000
         L     RRCB,RCV62RCB         RCB SHOULD BE VALID                01640000
                                                                        01650000
*---------------------------------------------------------------------- 01660000
* IF THERE IS NOTHING IN THE RECEIVE QUEUE...JUST RETURN                01670000
*---------------------------------------------------------------------- 01680000
                                                                        01690000
RCVNEXT  DS    0H                                                       01700000
                                                                        01710000
         ICM   RSPLIST,15,ISE62RB1   FIRST BUFFER IN THE RECEIVE QUEUE  01720000
         BNP   RETURN                RETURN IF NOT DATA                 01730000
                                                                        01740000
*---------------------------------------------------------------------- 01750000
* QUEUED SPLIST MAY BE AN EARLY SIGNAL.                                 01760000
*---------------------------------------------------------------------- 01770000
                                                                        01780000
ARECDATA DS    0H                                                       01790000
                                                                        01800000
         TM    SPLCNTDC,RPLSIGNL  IS IT A SIGNAL?                       01810000
         BNO   ARECNSIG           BRANCH IF NOT                         01820000
         CLC   SPLSEQNO,ISE62CBS  IS IT FOR THE CURRENT BRACKET?        01830000
         BNE   PRGSIGNL           BRANCH IF NOT                         01840000
         OI    ISE62FL1,ISE62SIG  SHOW RTS RECEIVED                     01850000
                                                                        01860000
PRGSIGNL DS    0H                                                       01870000
                                                                        01880000
         LR    R1,RSPLIST         CURRENT BUFFER                        01890000
         BAS   R14,SPLDQ          REMOVE BUFFER FROM THE QUEUE          01900000
         BAS   R14,SPLFREE        RELEASE THE BUFFER                    01910000
         B     RCVNEXT            AND CHECK FOR MORE DATA               01920000
                                                                        01930000
ARECNSIG DS    0H                                                       01940000
                                                                        01950000
*---------------------------------------------------------------------- 01960000
* BEGIN PROCESSING AN RU.                                               01970000
* SEND A NEGATIVE RESPONSE IF ONE IS OWED.                              01980000
*---------------------------------------------------------------------- 01990000
                                                                        02000000
         TM    SPLRH0,RHBCI          IS THIS A BEGIN CHAIN?             02010000
         BNO   ARECNOBC              BRANCH IF NOT                      02020000
         MVI   ISE62FRC,ISE62FRC_INC                                    02030000
                                                                        02040000
         TM    ISE62FL1,ISE62NRO     -RSP OWED?                         02050000
         BNO   ARECNOBC              BRANCH IF NOT                      02060000
         NI    ISE62FL1,255-ISE62NRO NO LONGER OWED                     02070000
         OI    ISE62FL1,ISE62SER     NOW WE ARE IN SEND_ERROR MODE      02080000
         BAS   R14,COPYSPL           COPY THAT SPLIST                   02090000
         LR    RSPLIST,R1            AND USE THE COPY                   02100000
         BAS   R14,DISPUNLK          RELEASE THE SERIALIZATION          02110000
                                                                        02120000
         $SESS $SESS_SEND_NEGRESP,                                     +02130000
               SESSION=ISETK,                                          +02140000
               RH=RH0846,                                              +02150000
               SEQNO=ISE62CBS,                                         +02160000
               SENSE=SNS0846,                                          +02170000
               CNTRL=CNT0846,                                          +02180000
               MF=(E,(RSPLIST))                                         02190000
                                                                        02200000
         LA    R1,=CL16'-RSP SENT (OWED)'                               02210000
         ST    R1,DESC@                                                 02220000
         MVC   DESCLEN,=F'16'                                           02230000
         SR    R1,R1                                                    02240000
         ST    R1,TRACE@                                                02250000
         ST    R1,TRACELEN                                              02260000
         LR    R1,RSPLIST                                               02270000
         BAS   R14,TRACESPL                                             02280000
                                                                        02290000
         $RETSTOR (RSPLIST),                                           +02300000
               OWNER=(RITASK)                                           02310000
                                                                        02320000
         B     LOCATRCB              NOW GO LOOK FOR CD                 02330000
                                                                        02340000
RH0846   DC    XL3'039000'                                              02350000
SNS0846  DC    XL4'08460000'                                            02360000
CNT0846  DC    XL3'800000'                                              02370000
                                                                        02380000
ARECNOBC DS    0H                                                       02390000
                                                                        02400000
*---------------------------------------------------------------------- 02410000
* QUEUED SPLIST SHOULD BE DATA OR LUSTAT. REJECT ANYTHING ELSE.         02420000
*---------------------------------------------------------------------- 02430000
                                                                        02440000
         TM    SPLCNTRL,RPLDATA       IS IT DATA?                       02450000
         BO    RECEIVE                BRANCH IF YES                     02460000
                                                                        02470000
         TM    SPLCNTDC,RPLLUS        LUSTAT RU?                        02480000
         BO    RCVEC                  BRANCH IF YES                     02490000
                                                                        02500000
         MVC   NRSPSNS,=XL4'10010003' "CONV RU IS NOT DATA OR LUSTAT"   02510000
         BAS   R14,DISPUNLK           RELEASE SERIALIZATION             02520000
         LR    R1,RSPLIST             PASS SPLIST IN R1                 02530000
         BAS   R14,SPLDQ              DEQUEUE THE SPLIST                02540000
         BAS   R14,SENDNRSP           SEND THE RESPONSE                 02550000
         BAS   R14,SPLFREE            RELEASE THE SPLIST                02560000
         B     LOCATRCB               RE-VERIFY THE RCB                 02570000
                                                                        02580000
*---------------------------------------------------------------------- 02590000
* IF WE ARE LOOKING FOR AN ERROR FMH...CHECK FOR DATA                   02600000
*---------------------------------------------------------------------- 02610000
                                                                        02620000
RECEIVE  DS    0H                                                       02630000
                                                                        02640000
         TM    ISE62FL1,ISE62RER  LOOKING FOR AN ERROR FMH?             02650000
         BNO   RCVEC              BRANCH IF NOT                         02660000
                                                                        02670000
         ICM   R1,15,SPLAREAL     IS THERE DATA?                        02680000
         BNP   RCVEC              BRANCH IF NOT                         02690000
         C     R1,=F'7'           AT LEAST ENOUGH DATA FOR FMH7?        02700000
         BL    RCVEC              BRANCH IF NOT                         02710000
         TM    SPLRH0,RHFI        IS THERE AN FMH?                      02720000
         BNO   RCVEC              BRANCH IF NOT                         02730000
         ICM   R2,15,SPLAREA      IS THERE A BUFFER ADDRESS             02740000
         BNP   RCVEC              BRANCH IF NOT???                      02750000
         CLI   0(R2),X'07'        IS IT AN FMH7? (LENGTH = 7)           02760000
         BNE   RCVEC              BRANCH IF NOT???                      02770000
         CLI   1(R2),X'07'        IS IT AN FMH7? (ID = 7)               02780000
         BNE   RCVEC              BRANCH IF NOT???                      02790000
         MVC   FMH7SNS,2(R2)      COPY THE FMH7 SENSE INFO              02800000
         MVC   SPL62OFF,=F'7'     SET OFFSET OF REMAINING DATA          02810000
         LA    R1,FMH7SNS         ADDRESS OF FMH7 SENSE INFO            02820000
         L     R15,IL6@TSNS       CONVERT SENSE TO RC ROUTINE           02830000
         BASR  R14,R15            LINK TO ROUTINE                       02840000
                                                                        02850000
         C     R0,=A(CM_PROGRAM_ERROR_NO_TRUNC)                         02860000
         BNE   *+8                                                      02870000
         L     R0,=A(CM_PROGRAM_ERROR_PURGING)                          02880000
         C     R0,=A(CM_SVC_ERROR_NO_TRUNC)                             02890000
         BNE   *+8                                                      02900000
         L     R0,=A(CM_SVC_ERROR_PURGING)                              02910000
                                                                        02920000
         ST    R0,POSTCODE        SAVE CONVERTED SENSE                  02930000
         BAS   R14,POSTUSER       POST THE SHIP/RECEIVE                 02940000
                                                                        02950000
         TM    6(R2),X'80'        IS THERE AN ERROR LOG GDS VARIABLE?   02960000
         BNO   NOELOG             BRANCH IF NOT                         02970000
         ICM   R15,15,SPLAREAL    LENGTH OF RU                          02980000
         S     R15,=F'7'          MINUS THE FMH7                        02990000
         BNP   NOELOG             FOR US...LOG DATA MUST BE IN THIS RU  03000000
         C     R15,=F'4'          AT LEAST 4 BYTES IN RU?               03010000
         BL    NOELOG             BRANCH IF NOT                         03020000
         LA    R1,7(,R2)          ADDRESS OF LOG DATA                   03030000
         SR    R2,R2              CLEAR FOR ICM                         03040000
         ICM   R2,B'0011',0(R1)   GET LOG DATA LENGTH                   03050000
         BNP   NOELOG             BRANCH IF NO LENGTH                   03060000
         N     R2,=X'00007FFF'    CLEAR CONTINUATION BIT                03070000
         C     R2,=F'4'           AT LEAST 4 BYTES?                     03080000
         BL    NOELOG             BRANCH IF NOT                         03090000
         CLC   2(2,R1),=X'12E1'   CORRECT ID?                           03100000
         BNE   NOELOG             BRANCH IF NOT                         03110000
         LR    R3,R2              COPY LENGTH                           03120000
         SR    R15,R3             LENGTH OF RU AFTER ERROR LOG REMOVED  03130000
         BM    NOELOG             SKIP IT IF NOT ALL IN THIS RU         03140000
         A     R3,SPL62OFF        COMPUTE NEW DATA OFFSET               03150000
         ST    R3,SPL62OFF        SAVE UPDATED DATA OFFSET              03160000
         LR    R3,R1              ADDRESS OF ERROR LOG DATA             03170000
                                                                        03180000
         L62LOGD (R3),                                                 +03190000
               (RISESS),                                               +03200000
               =CL8'RECEIVED',                                         +03210000
               =F'8',                                                  +03220000
               L62RETCD,                                               +03230000
               MF=(E,L62MFL)      LOG THE ERROR LOG DATA                03240000
                                                                        03250000
NOELOG   DS    0H                                                       03260000
                                                                        03270000
                                                                        03280000
         CLC   POSTCODE,=A(CM_DEALLOCATED_ABEND)                        03290000
         BNE   RETURN             BRANCH IF NOT                         03300000
         B     RCVEC              THIS SHOULD BE A CEB RU               03310000
                                                                        03320000
*---------------------------------------------------------------------- 03330000
* TRY TO COMPLETE THE EXCEPTION CONDITION BASED ON EC INDICATORS        03340000
*---------------------------------------------------------------------- 03350000
                                                                        03360000
RCVEC    DS    0H                                                       03370000
                                                                        03380000
         TM    SPLRH0,RHECI       IS THIS AN END CHAIN RU?              03390000
         BO    RCVSTAT            BRANCH YES, IT IS INTERESTING TO US   03400000
                                                                        03410000
RCVPURGE DS    0H                                                       03420000
                                                                        03430000
         LR    R1,RSPLIST         PASS PLIST ADDRESS IN R1              03440000
         BAS   R14,SPLDQ          DEQUEUE THAT SPLIST                   03450000
         BAS   R14,SPLFREE        RELEASE THE SPLIST                    03460000
         B     RCVNEXT            GO GET ANOTHER RU                     03470000
                                                                        03480000
RCVSTAT  DS    0H                                                       03490000
                                                                        03500000
         MVI   ISE62FRC,ISE62FRC_BETC                                   03510000
                                                                        03520000
         TM    SPLRH2,RHCEBI      IS THIS A CEB?                        03530000
         BO    RCVSCEBI           BRANCH IF YES                         03540000
                                                                        03550000
         TM    ISE62FL1,ISE62RER  ARE WE WAITING FOR FMH7?              03560000
         BO    RCVPURGE           BRANCH IF YES TO PURGE AND LOOK       03570000
                                                                        03580000
RCVCD    DS    0H                                                       03590000
                                                                        03600000
         OI    ISES1,ISES1DIR     WE GRAB THE DIRECTION IN THIS CASE    03610000
         MVI   ISE62FCD,ISE62FCD_CD                                     03620000
         BAS   R14,POSTUSER       POST THE SEND_ERROR COMPLETE          03630000
         LR    R1,RSPLIST         PASS PLIST ADDRESS IN R1              03640000
         BAS   R14,SPLDQ          DEQUEUE THAT SPLIST                   03650000
         BAS   R14,SPLFREE        RELEASE THE SPLIST                    03660000
         B     RETURN             AND RETURN                            03670000
                                                                        03680000
RCVSCEBI DS    0H                                                       03690000
                                                                        03700000
         TM    SPLRH1,RHERI       WAS THIS AN ER?                       03710000
         BO    RCVCEB             BRANCH IF YES                         03720000
         TM    SPLRH1,RHDR2       WAS THIS A DR2/3?                     03730000
         BNO   RCVCEB             BRANCH IF NOT, THE BRACKET ENDS       03740000
         B     RCVCD              BRANCH IF YES, THE BRACKET CONTINUES  03750000
                                                                        03760000
RCVCEB   DS    0H                                                       03770000
                                                                        03780000
         MVI   ISE62FBR,ISE62FBR_BETB                                   03790000
         MVI   ISE62FCD,ISE62FCD_NOCD                                   03800000
         CLC   POSTCODE,=A(CM_DEALLOCATED_ABEND)                        03810000
         BE    *+10               BRANCH IF POSTCODE ALREADY SET        03820000
         MVC   POSTCODE,=A(CM_DEALLOCATED_NORMAL)                       03830000
         BAS   R14,POSTUSER       POST THE USER                         03840000
         BAS   R14,DISPUNLK       RELEASE SERIALIZATION                 03850000
         LR    R1,RSPLIST         PASS SPLIST IN R1                     03860000
         BAS   R14,SPLDQ          REMOVE BUFFER FROM THE QUEUE          03870000
         BAS   R14,SENDPRSP       SEND A RESPONSE IF REQUESTED          03880000
         BAS   R14,SPLFREE        RELEASE THE BUFFER                    03890000
         B     RETURN             AND RETURN                            03900000
                                                                        03910000
*---------------------------------------------------------------------- 03920000
* RETURN TO CALLER                                                      03930000
*---------------------------------------------------------------------- 03940000
                                                                        03950000
RETURN   DS    0H                                                       03960000
                                                                        03970000
         BAS   R14,DISPUNLK       RELEASE SERIALIZATION                 03980000
                                                                        03990000
         LM    R15,R1,RETREGS     LOAD RETURN VALUES                    04000000
                                                                        04010000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    04020000
                                                                        04030000
*---------------------------------------------------------------------- 04040000
* SUBROUTINE: POSTUSER - POST THE CPIC OPERATION                        04050000
*                                                                       04060000
*      ENTRY: RCV62ENT = WORK UNIT TOKEN                                04070000
*             RCV62EPB = EPB ADDRESS                                    04080000
*             RISESS   = ISESS ADDRESS                                  04090000
*            +DISP LOCK IS HELD AND WORK UNIT WAS VERIFIED              04100000
*                                                                       04110000
*       EXIT: R15      = RETURN CODE FROM L62POST                       04120000
*---------------------------------------------------------------------- 04130000
                                                                        04140000
POSTUSER DS     0H                                                      04150000
                                                                        04160000
         STM   R14,R12,SUB0SAVE                                         04170000
                                                                        04180000
         OC    RCV62EPB,RCV62EPB    HAS USER BEEN POSTED ALREADY?       04190000
         BZR   R14                  RETURN IF YES                       04200000
                                                                        04210000
         ICM   R3,15,RCV62PLA       IS THERE A RCV PARM LIST ADDRESS?   04220000
         BZ    POSTGO               BRANCH IF NOT                       04230000
         ICM   R1,15,SAVEWUR1       IS WORKUNIT TERMINATING?            04240000
         BNZ   POSTGO               SKIP RETURN_CODE UPDATE IF YES      04250000
Y        USING CMLIST,R3                                                04260000
         L     R3,RCV62PLA          CMLIST ADDRESS                      04270000
         L     R1,Y.CMLPARM8        ADDRESS OF RETURN_CODE AREA         04280000
         MVC   0(4,R1),POSTCODE     SET THE VARIABLE                    04290000
         DROP  Y                                                        04300000
                                                                        04310000
POSTGO   DS    0H                                                       04320000
                                                                        04330000
         L62POST *RCV62EPB,         ADDRESS OF EPB TO POST             +04340000
               POSTCODE,            ADDRESS OF POST CODE               +04350000
               RCV62ENT,            ADDRESS OF ENTITY TOKEN            +04360000
               L62RETCD,            ADDRESS OF RETURN CODE AREA        +04370000
               MF=(E,L62MFL)                                            04380000
                                                                        04390000
         NI    ISE62FL1,255-ISE62RER NO EXCEPTION REMAINS               04400000
         NI    ISE62FL1,255-ISE62SER NO EXCEPTION REMAINS               04410000
         NI    ISE62FL1,255-ISE62NRO NO EXCEPTION REMAINS               04420000
         XC    ISE62RRQ,ISE62RRQ  NO REQUEST REMAINS                    04430000
         XC    ISE62SRQ,ISE62SRQ  NO REQUEST REMAINS                    04440000
         XC    RCV62EPB,RCV62EPB  USER HAS BEEN POSTED                  04450000
         XC    RCV62ENT,RCV62ENT  USER HAS BEEN POSTED                  04460000
         XC    RCV62PLA,RCV62PLA  USER HAS BEEN POSTED                  04470000
         XC    RCV62RCB,RCV62RCB  USER HAS BEEN POSTED                  04480000
                                                                        04490000
         ICM   RSPLIST,15,ISE62CRQ  IS THERE A CLEANUP PENDING?         04500000
         BZ    POSTUEND             RETURN IF NOT                       04510000
         XC    ISE62CRQ,ISE62CRQ    CLEAR THE REQUEST                   04520000
                                                                        04530000
         L62POST *SPL62EPB,         ADDRESS OF EPB TO POST             +04540000
               =F'0',               ADDRESS OF POST CODE               +04550000
               SPL62ENT,            ADDRESS OF ENTITY TOKEN            +04560000
               L62RETCD,            ADDRESS OF RETURN CODE AREA        +04570000
               MF=(E,L62MFL)                                            04580000
                                                                        04590000
         LR    R1,RSPLIST           PASS SPLIST IN R1                   04600000
         BAS   R14,SPLFREE          RELEASE THE BUFFER                  04610000
                                                                        04620000
POSTUEND DS    0H                                                       04630000
                                                                        04640000
         LM    R14,R12,SUB0SAVE                                         04650000
         L     R15,L62RETCD                                             04660000
         BR    R14                                                      04670000
                                                                        04680000
*---------------------------------------------------------------------- 04690000
* SUBROUTINE: SPLDQ                                                     04700000
*      ENTRY: R1 = ADDRESS OF SPLIST TO BE DEQUEUED                     04710000
*       EXIT: ALL REGISTERS ARE RESTORED                                04720000
*---------------------------------------------------------------------- 04730000
                                                                        04740000
SPLDQ    DS     0H                                                      04750000
                                                                        04760000
         STM   R14,R1,SUB0SAVE                                          04770000
                                                                        04780000
         LM    R14,R15,SPL62RBN-SPLIST(R1) R14=NEXT BFR R15=PREV BFR    04790000
         ST    R15,SPL62RBP-SPLIST(,R14)   LINK PREV TO NEXT            04800000
         ST    R14,SPL62RBN-SPLIST(,R15)   LINK NEXT TO PREV            04810000
                                                                        04820000
         LA    R15,=CL14'SPLIST FLUSHED'                                04830000
         ST    R15,DESC@                                                04840000
         MVI   DESCLEN+(L'DESCLEN-1),14                                 04850000
         SR    R15,R15                                                  04860000
         ST    R15,TRACE@                                               04870000
         ST    R15,TRACELEN                                             04880000
         BAS   R14,TRACESPL                                             04890000
                                                                        04900000
         LM    R14,R1,SUB0SAVE                                          04910000
         BR    R14                                                      04920000
                                                                        04930000
*---------------------------------------------------------------------- 04940000
* SUBROUTINE: SPLFREE                                                   04950000
*      ENTRY: R1 = ADDRESS OF SPLIST TO BE RELEASED                     04960000
*       EXIT: ALL REGISTERS ARE RESTORED                                04970000
*---------------------------------------------------------------------- 04980000
                                                                        04990000
SPLFREE  DS     0H                                                      05000000
                                                                        05010000
         STM   R14,R12,SUB1SAVE                                         05020000
         LR    R3,R1                     SPLIST ADDRESS                 05030000
         ICM   R2,15,SPLAREAL-SPLIST(R3) IS THERE A DATA AREA?          05040000
         BNP   SPLFLIST                  BRANCH IF NOT                  05050000
                                                                        05060000
         $RETSTOR *SPLAREA,                                            +05070000
               OWNER=(RITASK)                                           05080000
                                                                        05090000
SPLFLIST DS    0H                                                       05100000
                                                                        05110000
         $RETSTOR (R3),                                                +05120000
               OWNER=(RITASK)                                           05130000
                                                                        05140000
         LM    R14,R12,SUB1SAVE                                         05150000
         BR    R14                                                      05160000
                                                                        05170000
*---------------------------------------------------------------------- 05180000
* SUBROUTINE: COPYSPL                                                   05190000
*      ENTRY: RSPLIST = ADDRESS OF SPLIST TO BE COPIED                  05200000
*       EXIT: R1      = ADDRESS OF THE COPY                             05210000
*---------------------------------------------------------------------- 05220000
                                                                        05230000
COPYSPL  DS     0H                                                      05240000
                                                                        05250000
         STM   R14,R12,SUB0SAVE                                         05260000
                                                                        05270000
         $GETSTOR L'SPL,                                               +05280000
               LOC=ANY,                                                +05290000
               OWNER=(RITASK)                                           05300000
                                                                        05310000
         LR    R2,R1                ADDRESS OF SPL COPY                 05320000
         LA    R3,L'SPL             SIZE OF SPL                         05330000
         LR    R14,RSPLIST          ORIGINAL SPL                        05340000
         LR    R15,R3               SIZE OF SPL                         05350000
         MVCL  R2,R14               COPY THE SPL                        05360000
                                                                        05370000
         LM    R14,R0,SUB0SAVE                                          05380000
         LM    R2,R12,SUB0SAVE+16                                       05390000
         BR    R14                                                      05400000
                                                                        05410000
*---------------------------------------------------------------------- 05420000
* SUBROUTINE: SENDPRSP                                                  05430000
*      ENTRY: R1 = ADDRESS OF SPLIST TO BE RESPONDED TO                 05440000
*       EXIT: ALL REGISTERS ARE RESTORED                                05450000
*---------------------------------------------------------------------- 05460000
                                                                        05470000
SENDPRSP DS     0H                                                      05480000
                                                                        05490000
                                                                        05500000
         STM   R14,R12,SUB0SAVE                                         05510000
         LR    RSPLIST,R1                                               05520000
         TM    SPLRH0,RHQSRSP       WAS A RESPONSE SENT ALREADY?        05530000
         BO    SENDPRET             BRANCH IF YES                       05540000
                                                                        05550000
         $SESS $SESS_SEND_POSRESP,  SEND A RESPONSE AS NEEDED          +05560000
               SESSION=ISETK,                                          +05570000
               RH=*,                                                   +05580000
               AREA=*,              PRESERVE DATA ADDRESS              +05590000
               AREALEN=*,           PRESERVE DATA LENGTH               +05600000
               SEQNO=ISE62CBS,                                         +05610000
               CNTRL=*,                                                +05620000
               SENSE=*,                                                +05630000
               MF=(E,(RSPLIST))                                         05640000
                                                                        05650000
         LA    R1,=CL9'+RSP SENT'                                       05660000
         ST    R1,DESC@                                                 05670000
         MVI   DESCLEN+(L'DESCLEN-1),9                                  05680000
         SR    R1,R1                                                    05690000
         ST    R1,TRACE@                                                05700000
         ST    R1,TRACELEN                                              05710000
         LR    R1,RSPLIST                                               05720000
         BAS   R14,TRACESPL                                             05730000
                                                                        05740000
SENDPRET DS    0H                                                       05750000
                                                                        05760000
         LM    R14,R12,SUB0SAVE                                         05770000
         BR    R14                                                      05780000
                                                                        05790000
*---------------------------------------------------------------------- 05800000
* SUBROUTINE: SENDNRSP                                                  05810000
*      ENTRY: R1 = ADDRESS OF SPLIST TO BE RESPONDED TO                 05820000
*       EXIT: ALL REGISTERS ARE RESTORED                                05830000
*---------------------------------------------------------------------- 05840000
                                                                        05850000
SENDNRSP DS     0H                                                      05860000
                                                                        05870000
         STM   R14,R12,SUB0SAVE                                         05880000
         LR    RSPLIST,R1                                               05890000
         TM    SPLRH0,RHQSRSP       WAS A RESPONSE SENT ALREADY?        05900000
         BO    SENDNRET             BRANCH IF YES                       05910000
                                                                        05920000
         $SESS $SESS_SEND_NEGRESP,  SEND A NEGATIVE RESPONSE           +05930000
               SESSION=ISETK,                                          +05940000
               RH=*,                                                   +05950000
               AREA=*,              PRESERVE DATA ADDRESS              +05960000
               AREALEN=*,           PRESERVE DATA LENGTH               +05970000
               SEQNO=ISE62CBS,                                         +05980000
               CNTRL=*,                                                +05990000
               SENSE=NRSPSNS,                                          +06000000
               MF=(E,(RSPLIST))                                         06010000
                                                                        06020000
         LA    R1,=CL9'-RSP SENT'                                       06030000
         ST    R1,DESC@                                                 06040000
         MVI   DESCLEN+(L'DESCLEN-1),9                                  06050000
         SR    R1,R1                                                    06060000
         ST    R1,TRACE@                                                06070000
         ST    R1,TRACELEN                                              06080000
         LR    R1,RSPLIST                                               06090000
         BAS   R14,TRACESPL                                             06100000
                                                                        06110000
SENDNRET DS     0H                                                      06120000
                                                                        06130000
         LM    R14,R12,SUB0SAVE                                         06140000
         BR    R14                                                      06150000
                                                                        06160000
*---------------------------------------------------------------------- 06170000
* SUBROUTINE: TRACESPL                                                  06180000
*      ENTRY: R1 = ADDRESS OF SPLIST TO BE TRACED                       06190000
*             DESC@ = ADDRESS OF TRACE POINT DESCRIPTION                06200000
*             DESCLEN = LENGTH OF TRACE POINT DESCRIPTION               06210000
*             TRACE@ = ADDRESS OF ADDITIONAL DATA TO BE TRACED          06220000
*             TRACELEN = LENGTH OF ADDITIONAL DATA TO BE TRACED         06230000
*---------------------------------------------------------------------- 06240000
                                                                        06250000
TRACESPL DS     0H                                                      06260000
                                                                        06270000
         STM   R14,R12,SUB1SAVE                                         06280000
         LR    RSPLIST,R1               SPLIST TO BE TRACED             06290000
         L     R2,DESC@                 TRACE POINT DESC. ADDRESS       06300000
         L     R3,TRACE@                ADDITIONAL DATA   ADDRESS       06310000
                                                                        06320000
         L62TRCS (RSPLIST),                    @ SPLIST                +06330000
               (RISESS),                       @ ISESS                 +06340000
               (R2),                           @ DESCRIPTION           +06350000
               DESCLEN,                        @ DESCRIPTION LEN       +06360000
               (R3),                           @ ADDITIONAL DATA       +06370000
               TRACELEN,                       @ ADDITIONAL DATA LEN   +06380000
               L62RETCD,                       @ RETURN CODE AREA      +06390000
               MF=(E,L62MFL)                                            06400000
                                                                        06410000
         LM    R14,R12,SUB1SAVE                                         06420000
         BR    R14                                                      06430000
                                                                        06440000
*---------------------------------------------------------------------- 06450000
*   SUBROUTINE: OBTAIN DISP GLOBAL LOCK                                 06460000
*---------------------------------------------------------------------- 06470000
                                                                        06480000
DISPLOCK DS    0H                                                       06490000
                                                                        06500000
         TM    FLAG,FLAGDLCK        WAS THE LOCK ALREADY OBTAINED?      06510000
         BOR   R14                  RETURN IF YES                       06520000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             06530000
                                                                        06540000
         $SER  OBTAIN,                                                 +06550000
               DISP                                                     06560000
                                                                        06570000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              06580000
         BNE   DISPLOEX             BRANCH IF NOT                       06590000
         OI    FLAG,FLAGDLKD        REMEMBER LOCK HELD ON ENTRY         06600000
                                                                        06610000
DISPLOEX DS    0H                                                       06620000
                                                                        06630000
         OI    FLAG,FLAGDLCK        REMEMBER LOCK IS HELD               06640000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          06650000
         BR    R14                  RETURN                              06660000
                                                                        06670000
*---------------------------------------------------------------------- 06680000
*   SUBROUTINE: RELEASE DISP GLOBAL LOCK                                06690000
*---------------------------------------------------------------------- 06700000
                                                                        06710000
DISPUNLK DS    0H                                                       06720000
                                                                        06730000
         TM    FLAG,FLAGDLCK        IS LOCK HELD?                       06740000
         BNOR  R14                  BRANCH IF NOT                       06750000
         TM    FLAG,FLAGDLKD        WAS LOCK HELD ON ENTRY?             06760000
         BOR   R14                  DON'T RELEASE IF IT WAS             06770000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             06780000
                                                                        06790000
         $SER  RELEASE,                                                +06800000
               DISP                                                     06810000
                                                                        06820000
         NI    FLAG,255-FLAGDLCK    SHOW LOCK NOT HELD                  06830000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          06840000
         BR    R14                  RETURN                              06850000
                                                                        06860000
*---------------------------------------------------------------------- 06870000
* ERROR ROUTINES                                                        06880000
*---------------------------------------------------------------------- 06890000
                                                                        06900000
ERR$LOST DS    0H                                                       06910000
                                                                        06920000
         $ABEND ABE_VTDIAG,                                            +06930000
               SCOPE=PCB,                                              +06940000
               TITLE='LU6.2 LOST'                                       06950000
                                                                        06960000
*---------------------------------------------------------------------- 06970000
*  CONSTANTS AND LITERALS                                               06980000
*---------------------------------------------------------------------- 06990000
                                                                        07000000
         LTORG ,                                                        07010000
         PRINT NOGEN                                                    07020000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                07030000
         ISTRH ,                  VTAM REQUEST HEADER                   07040000
         ISTDBIND ,               VTAM BIND IMAGE                       07050000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         07060000
         ICVT  ,                  INTEGRATOR CVT                        07070000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   07080000
         ITASK ,                  INTEGRATOR TASK BLOCK                 07090000
         IPCB ,                   INTEGRATOR PROC BLOCK                 07100000
         ISESS ,                  INTEGRATOR ISESS BLOCK                07110000
         IVUSER ,                 INTEGRATOR IVUSER BLOCK               07120000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       07130000
         EVCODES ,                INTEGRATOR EVENT CODES                07140000
         ABCODES ,                INTEGRATOR $ABEND CODES               07150000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     07160000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        07170000
         IRPL ,                   INTEGRATOR ISESS BLOCK                07180000
         IWEVTAM ,                INTEGRATOR VTAM CVT                   07190000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             07200000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             07210000
         $WULOC DSECT=YES         INTEGRATOR $WULOC SERVICES            07220000
         END   ,                                                        07230000

ICLINK   TITLE '- "C" LANGUAGE LINKAGE ASSISTANCE ROUTINE'              00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE: ICLINK - "C" LANGUAGE LINKAGE ASSITANCE ROUTINE              00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THE FUNCUNCTION OF THIS ROUTINE IS TO PROVIDE LINKAGE              00080000
*    ASSISTANCE FROM ASSEMBLER LANGUAGE TO SASC "C" LANGUAGE.           00090000
*                                                                       00100000
*    THE $CLINK MACRO IS USED TO INTERFACE WITH ANY "C" LANGUAGE        00110000
*    FUNCTION WRITTEN IN SASC.  THIS MACRO WILL CREATE AN SCON          00120000
*    PARAMETER LIST USED TO RESOLVE THE "C" FUNCTION STACK.             00130000
*                                                                       00140000
*                                                                       00150000
* ON ENTRY:                                                             00160000
*                                                                       00170000
*    R0 - ADDRESS OF "C" FUNCTION TO CALL                               00180000
*    R1 - ADDRESS OF SCON PLIST GENERATED BY $CLINK MACRO               00190000
*                                                                       00200000
*    PLIST FORMAT:                                                      00210000
*                                                                       00220000
*       +0 - AL2(COUNT)            COUNT  OF ENTRIES                    00230000
*       +2 - PLIST ENTRY           ORIGIN OF ENTRIES                    00240000
*            +0 - S(PARM)          SCON OF PARM                         00250000
*            +2 - AL1(TYPE)        VARIABLE TYPE                        00260000
*                                     0 - VOID                          00270000
*                                     1 - CHAR                          00280000
*                                     2 - INT                           00290000
*                                     3 - SHORT                         00300000
*                                     4 - STRUCT                        00310000
*            +3 - XL1 FMT OPTS     FORMAT OPTIONS                       00320000
*                                   X'80' - POINTER TO VAR              00330000
*                                   X'40' - POINTER TO PTR              00340000
*                                   X'20' - VALUE IN REG                00350000
*                                                                       00360000
* ON EXIT:                                                              00370000
*                                                                       00380000
*    R15 CONTAINS THE RETURN CODE FROM THE "C" FUNCTION                 00390000
*                                                                       00400000
* NOTES:                                                                00410000
*                                                                       00420000
*    THIS MODULE MUST BE ASSEMBLED USING THE SASA.MACLIBA               00430000
*    LIBRARY AND LINKEDIT USING THE SASC.SPELIB.                        00440000
*                                                                       00450000
**<DOC-OFF>*****************************************************        00460000
                                                                        00470000
         EJECT ,                                                        00480000
****************************************************************        00490000
*                                                                       00500000
* MAINTENANCE:                                                          00510000
*                                                                       00520000
*    07/14/92  RON COLMONE                                              00530000
*              INITIAL VERSION                                          00540000
*                                                                       00550000
****************************************************************        00560000
                                                                        00570000
         EJECT ,                                                        00580000
         EQUS  ,                                                        00590000
                                                                        00600000
         EJECT ,                                                        00610000
*---------------------------------------------------------------        00620000
*  VARIABLE TYPE EQUATES                                                00630000
*---------------------------------------------------------------        00640000
$VOID    EQU   0                  VOID   (POINTER ONLY)                 00650000
$CHAR    EQU   1                  CHARACTER                             00660000
$INT     EQU   2                  FULLWORD                              00670000
$SHORT   EQU   3                  HALFWORD                              00680000
$STRUCT  EQU   4                  STRUCT (POINTER ONLY)                 00690000
*                                                                       00700000
$PTR     EQU   X'80'              POINTER TO VARIABLE                   00710000
$PTR2    EQU   X'40'              POINTER TO POINTER                    00720000
$REG     EQU   X'20'              VALUE CONTAINED IN REG                00730000
                                                                        00740000
         EJECT ,                                                        00750000
         #WORK PLIST=(PARMAREA,80)                                      00760000
                                                                        00770000
REGSAVE  DS    16F                REG SAVE AREA                         00780000
SAVEPTR  DS    A                  POINTER TO CALLERS SAVEAREA           00790000
                                                                        00800000
         #ENDWORK ,               WORKAREA TRAILER                      00810000
                                                                        00820000
         EJECT ,                                                        00830000
ICLINK   #ENTER PREG=(R3,R2)      PREFORM ENTRY LINKAGE                 00840000
*                                                                       00850000
         L     R0,4(,R13)         SET SA OF CALLER                      00860000
         LR    R1,R3              ADDR OF PARMS                         00870000
*                                                                       00880000
         BAS   R14,BLDPARMS       CALL PARAMETER BLD RTN                00890000
*                                                                       00900000
         LR    R15,R2             ADDR OF "C" FUNCTION                  00910000
         BASR  R14,R15            CALL "C" FUNCTION                     00920000
*                                                                       00930000
         #EXIT ,                  RETURN                                00940000
                                                                        00950000
         EJECT ,                                                        00960000
*---------------------------------------------------------------        00970000
*                                                                       00980000
*  ROUTINE:  BLDPARMS                                                   00990000
*                                                                       01000000
*  THIS ROUTINE IS CALLED TO FORMAT THE PARMS TO BE PASSED              01010000
*  TO THE "C" FUNCTION BEING CALLED.  THE PARMS ARE PASSED              01020000
*  TO THE LINKAGE ASSISTANCE ROUTINE (ICLINK) IN SCON FORMAT            01030000
*  WITH A TYPE INDICATOR SPECIFYING THE FORMAT OF THE PARMS             01040000
*  AND THE INTENDED FORMAT OF THE CALLING FUNCTION.                     01050000
*                                                                       01060000
*  UPON ENTRY:  R1 - ADDRESS OF PLIST                                   01070000
*                    +0 - AL2(COUNT)                                    01080000
*                    +2 - ORIGIN OF PARM ENTRIES                        01090000
*                         SCON, TYPE, FLAGS                             01100000
*               R0 - ADDRESS OF CALLER'S SAVE AREA                      01110000
*                                                                       01120000
*  UPON EXIT:   R1 - ADDRESS OF "C" FUNCTION PARMS                      01130000
*                                                                       01140000
*---------------------------------------------------------------        01150000
*                                                                       01160000
BLDPARMS DS    0H                                                       01170000
         STM   R0,R15,REGSAVE     SAVE REGISTERS                        01180000
*                                                                       01190000
         LR    R5,R1              ADDR OF PARMS                         01200000
         ST    R0,SAVEPTR         ADDR OF CALLER'S SA                   01210000
*                                                                       01220000
         SR    R4,R4              PREPARE FOR INSERT                    01230000
         ICM   R4,3,0(R5)         GET COUNT OF PARMS                    01240000
         BZ    BLDEXIT            NONE, JUST EXIT                       01250000
         LA    R5,2(,R5)          ADDR OF FIRST ENTRY                   01260000
         LA    R6,PARMAREA        GET ADDRESS OF PARMAREA               01270000
*                                                                       01280000
*---------------------------------------------------------------        01290000
*   PROCESS EACH ENTRY IN THE PLIST PASSED TO THE "C" LINKAGE           01300000
*   ASSISTANCE ROUTINE.  RESOLVE THE RS-EXP IN THE LIST USING           01310000
*   THE CALLER'S SAVE AREA.                                             01320000
*---------------------------------------------------------------        01330000
BLDNEXT  DS    0H                                                       01340000
         RSEXP (R5),SAVE=*SAVEPTR CONVERT RS-EXP TO ADDRESS             01350000
         LR    R1,R15             ADDR OF VALUE                         01360000
*                                                                       01370000
         TM    3(R5),$REG         VALUE SPECIFIED IN REG                01380000
         BO    BLDREG             YES, USE REGISTER VALUE               01390000
         TM    3(R5),$PTR         VALUE A POINTER TO VAR                01400000
         BO    BLDREG             YES, USE VALUE                        01410000
*                                                                       01420000
*---------------------------------------------------------------        01430000
*  DETERMINE VARIABLE TYPE AND RETRIEVE VALUE TO BE ADDED TO            01440000
*  PARAMETER STACK.                                                     01450000
*---------------------------------------------------------------        01460000
         SR    R14,R14            PREPARE FOR INSERT                    01470000
         IC    R14,2(R5)          GET VARIABLE TYPE                     01480000
         SLL   R14,2              OFFSET TO BRANCH                      01490000
         B     *+4(R14)           BRANCH ON TYPE                        01500000
         B     BLDREG             TYPE - VOID                           01510000
         B     BLDCHAR            TYPE - CHAR                           01520000
         B     BLDINT             TYPE - INT, LONG                      01530000
         B     BLDSHORT           TYPE - SHORT                          01540000
         B     BLDREG             TYPE - STRUCT                         01550000
*                                                                       01560000
BLDCHAR  DS    0H                                                       01570000
         SR    R0,R0              PREPARE FOR INSERT                    01580000
         IC    R0,0(,R1)          GET CHARACTER VALUE                   01590000
         B     SETPARM            GO SET PARM IN PLIST                  01600000
*                                                                       01610000
BLDINT   DS    0H                                                       01620000
         L     R0,0(,R1)          GET LONG INT VALUE                    01630000
         B     SETPARM            GO SET PARM IN PLIST                  01640000
*                                                                       01650000
BLDSHORT DS    0H                                                       01660000
         SR    R0,R0              PREPARE FOR INSERT                    01670000
         ICM   R0,3,0(R1)         GET SHORT INTEGER VALUE               01680000
         B     SETPARM            GO SET PARM IN PLIST                  01690000
*                                                                       01700000
BLDREG   DS    0H                                                       01710000
         LR    R0,R1              GET REGISTER VALUE                    01720000
         B     SETPARM            GO SET PARM IN PLIST                  01730000
*                                                                       01740000
SETPARM  DS    0H                                                       01750000
         ST    R0,0(R6)           SET PARM ADDRESS                      01760000
         LA    R6,4(,R6)          ADDR OF ENXT STACK ENTRY              01770000
         LA    R5,4(,R5)          ADDR OF NEXT PARM                     01780000
         BCT   R4,BLDNEXT         PROCESS NEXT ENTRY                    01790000
*                                                                       01800000
BLDEXIT  DS    0H                                                       01810000
         LM    R0,R15,REGSAVE     RESTORE REGISTERS                     01820000
         LA    R1,PARMAREA        ADDRESS OF "C" FUNC PARMS             01830000
         BR    R14                RETURN                                01840000
                                                                        01850000
         EJECT ,                                                        01860000
*---------------------------------------------------------------        01870000
*  CONSTANTS AND LITERALS                                               01880000
*---------------------------------------------------------------        01890000
                                                                        01900000
         LTORG ,                                                        01910000
         PRINT NOGEN                                                    01920000
                                                                        01930000
         ICVT  ,                                                        01940000
                                                                        01950000
         END   ICLINK                                                   01960000

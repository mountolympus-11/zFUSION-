IODBSCOL TITLE '- ODBC SQLSpecialColumns() RESULT SET GENERATOR'        00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: IODBSCOL - ODBC SQLSpecialColumns() result set generator     00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    That QCS is expected to contain the semantic information           00080000
*    information acquired from a SQL                                    00090000
*                                                                       00100000
*       SELECT <col-list> FROM SYSVCAT_ODBC_SCVER                       00110000
*                                                                       00120000
*    or                                                                 00130000
*                                                                       00140000
*       SELECT <col-list> FROM SYSVCAT_ODBC_SCR<scope><nullable>        00150000
*                                                                       00160000
*    statement.  The result set generated by these queries can          00170000
*    be fashioned to conform to the ODBC SQLSpecialColumns()            00180000
*    function by appropriate composition of the <col-list> and          00190000
*    the use of an ORDER BY clause.                                     00200000
*                                                                       00210000
*    ----------------------------------------------------------         00220000
*                                                                       00230000
*    The first form (_SCVER) is used to satisfy requests that           00240000
*    designate FColType = SQL_ROWVER which returns a list of            00250000
*    columns that are automatically updated by the data source          00260000
*    when any value in a row is updated.  Because no such               00270000
*    facility exists in the product, an empty result set is             00280000
*    always returned, regardless of the type of table or other          00290000
*    input.                                                             00300000
*                                                                       00310000
*    ----------------------------------------------------------         00320000
*                                                                       00330000
*    The second form (_SCR--) is used to satisfy requests that          00340000
*    designate fColType = SQL_BEST_ROWID which returns a column         00350000
*    or list of columns that ... allows any row in the                  00360000
*    specified table to be uniquely identified.  The ODBC               00370000
*    commentary stipulates that when specific values for these          00380000
*    columns are provided in a SELECT statement WHERE clause,           00390000
*    exactly zero or one rows will be returned.  Tables                 00400000
*    currently defined and populated in the target space may            00410000
*    include one or more DENSE, UNIQUE indexes that identify a          00420000
*    column or set of columns satisfying this criterea allowing         00430000
*    full support for catalog tables.  However, no such                 00440000
*    guarantee can be made for VDB tables. Thus, requests               00450000
*    directed against VDB tables, and all undefined tables,             00460000
*    cause the return of an empty result set.                           00470000
*                                                                       00480000
*    Suffixes are appended to the base table name (_SCR) to             00490000
*    convey additional input / constraints as follows:                  00500000
*                                                                       00510000
*    <scope>     one character C, T, or S conveying the value           00520000
*                of the fScope input argument as either                 00530000
*                SQL_SCOPE_CURROW, SQL_SCOPE_TRANSACTION, or            00540000
*                SQL_SCOPE_SESSION, respectively.  Note that            00550000
*                this information is not currently used (refer          00560000
*                to IMPLEMENTATION NOTES below).                        00570000
*                                                                       00580000
*    <nullable>  one character, either N or blank, conveying the        00590000
*                value of the fNullable input argument as either        00600000
*                SQL_NO_NULLS or SQL_NULLABLE.                          00610000
*                                                                       00620000
*                                                                       00630000
* IMPLEMENTATION NOTES:                                                 00640000
*                                                                       00650000
*    SCOPE            - Index / key definitions persist for             00660000
*                       the life of the table. SQL_SCOPE_SESSION        00670000
*                       is always returned.                             00680000
*                                                                       00690000
*    PSEUDO_COLUMN    - The product does not include the pseudo         00700000
*                       column concept.  SQL_PC_NO_PSEUDO is            00710000
*                       always returned.                                00720000
*                                                                       00730000
*    PRECISION        - NULL is never returned for this column          00740000
*                                                                       00750000
*    Input to the SQLSpecialColumns() function includes a single        00760000
*    unmasked table name included in the result set.  Although          00770000
*    it would be far more efficient to structure this routine           00780000
*    around this behavior, we chose instead to adhere to the            00790000
*    SQL SELECT model and examine all tables registered in the          00800000
*    target space, understanding that only one will stick.              00810000
*    Thus, this implementation is a bit more versitile than             00820000
*    called for in the ODBC definition.                                 00830000
*                                                                       00840000
*                                                                       00850000
* ON ENTRY                                                              00860000
*                                                                       00870000
*    R1  contains the address of the Query Content Summary              00880000
*                                                                       00890000
*    R0  contains the address of a preallocated savearea                00900000
*        not less than 1K in length or zero                             00910000
*                                                                       00920000
*                                                                       00930000
* ON EXIT:                                                              00940000
*                                                                       00950000
*    R15 contains zero or a return code acquired from SQLCODES          00960000
*        if an error is encountered.  R0 and R1 contain reason          00970000
*        and info codes respectively.  The QCSESTAT words are           00980000
*        updated accordingly.                                           00990000
*                                                                       01000000
**<DOC-OFF>****************************************************         01010000
                                                                        01020000
         EJECT                                                          01030000
***************************************************************         01040000
*                                                                       01050000
* MAINTENANCE:                                                          01060000
*                                                                       01070000
*    01/25/95  R. Turgeon    Int 2.0  ODCB Support                      01080000
*              Initial version                                          01090000
*                                                                       01100000
*    10/31/95  R. Turgeon    Rel 2.1                                    01110000
*              Create transient result set with NOLOCATOR               01120000
*              option                                                   01130000
*                                                                       01140000
***************************************************************         01150000
                                                                        01160000
         EJECT                                                          01170000
         QCS   ,                  QUERY CONTENT SUMMARY                 01180000
                                                                        01190000
         EJECT                                                          01200000
         SQLSEMAL ,               SQL SEMANTIC SUMMARY                  01210000
                                                                        01220000
         EJECT                                                          01230000
         KYNDXRET ,               RESULT SET NDX DEFINITION RETURN AREA 01240000
                                                                        01250000
         EJECT                                                          01260000
         SPACETYP DSECT=YES       OBJECT SPACE DEFINITION BLOCK         01270000
                                                                        01280000
         EJECT                                                          01290000
         TBSERVIS CREATE,OPEN,CLOSE,ADD,PSARG,COLUMN,DESC               01300000
                                                                        01310000
         EJECT                                                          01320000
         VCATALOG ODBC_SCOLS      VIRTUAL CATALOG TABLE COMPOSITION     01330000
                                                                        01340000
         EJECT                                                          01350000
         CATINFO ,                COLUMN AND INDEX DEFINTION HEADER     01360000
                                                                        01370000
         EJECT                                                          01380000
         DDENTRY ,                SYSDICTIONARY ROW FORMAT              01390000
                                                                        01400000
         EJECT                                                          01410000
         ODBCSQLH ,               ODBC CONSTANTS, DEFINITIONS, ETC.     01420000
                                                                        01430000
         EJECT                                                          01440000
         CRSDP ,                  CREATE RESULT SET REQUEST/RESPONSE    01450000
                                                                        01460000
         EJECT                                                          01470000
         DTQUERY ,                DATA TYPE INFO REQUEST/RESPONSE BLOCK 01480000
                                                                        01490000
         EJECT                                                          01500000
         EQUS  ,                                                        01510000
                                                                        01520000
         ABCODES ,                                                      01530000
                                                                        01540000
         EJECT                                                          01550000
         #WORK ,                                                        01560000
                                                                        01570000
FCOLTYPE DS    C             SQLSpecialColumns FColType ARGUMENT        01580000
*                               V - SQL_ROWVER                          01590000
*                               R - SQL_BEST_ROWID                      01600000
                                                                        01610000
FSCOPE   DS    C             SQLSpecialColumns fScope ARGUMENT          01620000
*                               C - SQL_SCOPE_CURROW                    01630000
*                               T - SQL_SCOPE_TRANSACTION               01640000
*                               S - SQL_SCOPE_SESSION                   01650000
                                                                        01660000
FNULLABL DS    C             SQLSpecialColumns fNullable ARGUMENT       01670000
*                               N - SQL_NULLABLE                        01680000
*                                 - SQL_NO_NULLS                        01690000
                                                                        01700000
RESERVE1 DS    X             RESERVED                                   01710000
                                                                        01720000
@NDXDEF  DS    A             RESULT SET INDEX DEFINITION (KYNDXRET)     01730000
CURTABTK DS    F             CURRENT TABLE - TABLE TOKEN                01740000
                                                                        01750000
RET_CRSD DS    F             RESULT SET DEFINITION SERVICE RTN RETCODE  01760000
$SCNCKPT DS    XL8           ICAT$SCN CHECKPOINT AREA                   01770000
                                                                        01780000
RETCODES DS    0F,0F,0F      COMPLETION STATUS                          01790000
RETCODE  DS    F                RETURN CODE                             01800000
RSNCODE  DS    F                REASON CODE                             01810000
INFCODE  DS    F                INFO CODE                               01820000
                                                                        01830000
REGSAVE  DS    16F           LOCAL SUBROUTINE SAVEAREA #1               01840000
WK256    DS    XL256         GENERAL PURPOSE WORKAREA                   01850000
                                                                        01860000
*--------------------------------------------------------------         01870000
*   TABLE COLUMN STATUS MAINTAINED FOR NULLABLE COLUMNS                 01880000
*--------------------------------------------------------------         01890000
                                                                        01900000
STASCALE DS    F             SCALE                                      01910000
                                                                        01920000
NULL_IND DS    XL4           NULL INDICATORS FOR 32 COLUMNS             01930000
                                                                        01940000
*--------------------------------------------------------------         01950000
*   PLIST CONSTRUCTION AREAS                                            01960000
*--------------------------------------------------------------         01970000
                                                                        01980000
$DTQUERY DS    0F,XL(DTQLN)      DATA TYPE INFO REQUEST/RESPONSE        01990000
$CRSDP   DS    0F,XL(CRSDPLN)    CREATE RESULT SET DEFINITION REQ/RESP  02000000
$CRSTREF DS    0F,XL(CRSTREFL)   CREATE RESULT SET - TABLE REFERENCE    02010000
                                                                        02020000
*--------------------------------------------------------------         02030000
*   VARDATA COLUMN COLLECTION AND CONSTRUCTION AREA                     02040000
*--------------------------------------------------------------         02050000
                                                                        02060000
VCHAR@   DS    A             FREE AREA PTR IN VARDATA COLLECTION AREA   02070000
VCHAR#   DS    F             FREE STG LEFT IN VARDATA COLLECTION AREA   02080000
VCHAR@T  DS    A             VCHAR@ AFTER TABLE VARDATA POSTED          02090000
VCHAR#T  DS    F             VCHAR# AFTER TABLE VARDATA POSTED          02100000
                                                                        02110000
VCHARBUF DS    XL256         VARDATA COLLECTION AREA                    02120000
                                                                        02130000
*--------------------------------------------------------------         02140000
*   TABLE SERVICES ROW BUFFERS                                          02150000
*--------------------------------------------------------------         02160000
                                                                        02170000
$ODBCROW DS    XL(ODBSCOLS_LENGTH)  SYSVCAT_ODBC_SC* SOURCE ROW BUFFER  02180000
                                                                        02190000
$DDEROW  DS    XL(DDELN)     SYSDICTIONARY ROW BUFFER                   02200000
$DDEVX   DS    XL256         VARDATAX EXTENSION AREA                    02210000
                                                                        02220000
RETDESC  DS    A,F           ADDRESS LENGTH OF TBDESC  RETURN AREA      02230000
RTBDESC  DS    XL256         TBFMT RETURN AREA                          02240000
                                                                        02250000
         #ENDWORK                                                       02260000
                                                                        02270000
         EJECT                                                          02280000
IODBSCOL #ENTER PREG=R8                                                 02290000
                                                                        02300000
         USING ITASK,R10                                                02310000
         EJECT                                                          02320000
***************************************************************         02330000
*                                                                       02340000
*   Validate the table name suffix that is used to select               02350000
*   the content of the result set.                                      02360000
*                                                                       02370000
***************************************************************         02380000
                                                                        02390000
TABNAME  DS    0C'SYSVCAT_ODBC_SC'                                      02400000
                                                                        02410000
         USING QCS,R8             LIFE OF FUNCTION                      02420000
                                                                        02430000
         LA    R2,QCSTABLE+L'TABNAME                                    02440000
         MVC   FCOLTYPE,0(R2)     COLUMN TYPE                           02450000
         CLC   =C'VER',0(R2)      FCOLTYPE = SQL_ROWVER?                02460000
         BE    EVALIDAT           ALTERNATE FORMAT OTHERWISE            02470000
                                                                        02480000
ROWID    DS    0H                                                       02490000
         CLI   FCOLTYPE,C'R'      SQL_BEST_ROWID REQUEST TYPE?          02500000
         BNE   ERR_CTAB           INVALID FORMAT OTHERWISE              02510000
                                                                        02520000
         MVC   FSCOPE,1(R2)       EXTRACT SCOPE CODE                    02530000
         CLI   FSCOPE,C'C'        SQL_SCOPE_CURROW?                     02540000
         BE    NULLCOL                                                  02550000
         CLI   FSCOPE,C'T'        SQL_SCOPE_TRANSACTION?                02560000
         BE    NULLCOL                                                  02570000
         CLI   FSCOPE,C'S'        SQL_SCOPE_SESSION?                    02580000
         BNE   ERR_CTAB                                                 02590000
                                                                        02600000
NULLCOL  DS    0H                                                       02610000
         MVC   FNULLABL,2(R2)     EXTRACT NULLABLE ACCEPTANCE FLAG      02620000
         CLI   FNULLABL,C'N'      SQL_NULLABLE?                         02630000
         BE    EVALIDAT                                                 02640000
         CLI   FNULLABL,C' '      SQL_NO_NULLS?                         02650000
         BNE   ERR_CTAB                                                 02660000
                                                                        02670000
EVALIDAT DS    0H                                                       02680000
                                                                        02690000
         EJECT                                                          02700000
***************************************************************         02710000
*                                                                       02720000
*   First, prepare to materialize the ODBC-defined result set           02730000
*   by initializing a SYSVCAT_ODBC_SC* table in the execution           02740000
*   space.  We leave it to coop to determine the proper                 02750000
*   ordering and row admittance criterea via the use of                 02760000
*   ALL/DISTINCT and ORDER BY in the source SELECT statement.           02770000
*                                                                       02780000
***************************************************************         02790000
                                                                        02800000
         GENTBLNM QCSTABLE        GENERATE A NAME FOR THE RESULT SET    02810000
                                                                        02820000
C        USING ODBSCOLS,$ODBCROW  SYSVCAT_ODBC_COLS ROW                 02830000
                                                                        02840000
*--------------------------------------------------------------         02850000
*   GENERATE A RESULT SET DEFINITION FROM THE BASE TABLE                02860000
*--------------------------------------------------------------         02870000
                                                                        02880000
         L     R7,=V(IVCASCOL)    SYSVCAT_ODBC_SC* TABLE FORMAT         02890000
         USING CATINFO,R7         DEFINITION FORMAT                     02900000
                                                                        02910000
TREF     USING CRSTREF,$CRSTREF   SINGLE VIRTUAL TABLE REFERENCE        02920000
         L     R6,QCSSSMRY        LOCATE THE SEMANTIC SUMMARY           02930000
         USING SQSEMAL,R6                                               02940000
         MVC   TREF.CRSTAB,SQSATBLS    RETAIN PTR TO TABLE IDENTIFIER   02950000
         MVC   TREF.CRSTCOL@,CATCOLS   TBCOLDEF PTR ARRAY ORIGIN        02960000
         MVC   TREF.CRSTCOL#,CAT#COLS  NUMBER OF COLUMNS IN BASE TABLE  02970000
         DROP  R7                 CATINFO                               02980000
                                                                        02990000
CRSD     USING CRSDP,$CRSDP       CREATE RESULT SET DEFINITION REQ/RESP 03000000
         ST    R6,CRSD.CRSDSMRY   PROVIDE SEMANTIC SUMMARY AS PARM      03010000
         LA    R0,TREF.CRSTREF    TABLE REFERENCE LIST ORIGIN           03020000
         ST    R0,CRSD.CRSDTBL@   ANCHOR IN CRSDP                       03030000
         LA    R0,1               TABLE REFERENCE IS A SINGLETON        03040000
         ST    R0,CRSD.CRSDTBL#   ANCHOR IN CRSDP                       03050000
         DROP  TREF,R6            CRSDP TABLE REFERENCE, SQSEMAL        03060000
                                                                        03070000
         LA    R1,CRSD.CRSDP      R1 <== RESULT SET DEFINITION REQ/RESP 03080000
         @CALL ISQLCRSD,CTYPE=STD                                       03090000
                                                                        03100000
         ST    R15,RET_CRSD       RETAIN RESULT SET DEFINITION RETCODE  03110000
         CH    R15,=AL2(RC08)     ANALYZE RETURN CODE                   03120000
         BE    ERR_CREF           INVALID COLUMN REFERENCE              03130000
         BH    ERR_RSD            REQUEST IN ERROR                      03140000
                                                                        03150000
*--------------------------------------------------------------         03160000
*   BUILD RESULT SET INDEX DEFINITIONS, RETURN KYNDXRET IN R1           03170000
*--------------------------------------------------------------         03180000
                                                                        03190000
         @CALL ISQKYNDX,(QCS,*CRSD.CRSDPTR@,*CRSD.CRSDRSC#),           X03200000
               MF=(E,MFE_LIST)                                          03210000
                                                                        03220000
         B     *+4(R15)           ANALYZE COMPLETION CODE               03230000
         B     TBLCRE                RC00 - INDEX DEFINITION RETURNED   03240000
         B     TBLCRE                RC04 - NO INDICIES REQUIRED        03250000
         B     ERR_ORD               RC08 - ORDER-BY CLAUSE IN ERROR    03260000
         B     ERR_DIST              RC12 - ERROR RELATED TO DISTINCT   03270000
         EX    R0,*                  RC16 - DEFINED / NOT ANTICIPATED   03280000
                                                                        03290000
*--------------------------------------------------------------         03300000
*   CREATE THE RESULT SET                                               03310000
*--------------------------------------------------------------         03320000
                                                                        03330000
TBLCRE   DS    0H                                                       03340000
         XC    DWORD,DWORD        TBKEYDEF LIST AND ENTRY COUNT         03350000
         ST    R1,@NDXDEF         INDEX DEFINITION BLOCK OR ZERO        03360000
         LTR   R1,R1              INDEX DEFINITIONS PRESENTED?          03370000
         BZ    TBLCRETB           DONE HERE IF NOT                      03380000
                                                                        03390000
         USING KYNDXRET,R1        INDEX DEFINITION RETURN AREA          03400000
         LA    R0,KYNDXLST        TBKEYDEF LIST ORIGIN                  03410000
         ST    R0,DWORD+0         SAVE IN PARAMETER WORKAREA            03420000
         L     R0,KYNDXCNT        TBKEYDEF LIST ENTRY COUNT             03430000
         ST    R0,DWORD+4         SAVE IN PARAMETER WORKAREA            03440000
         DROP  R1                 KYNDXRET                              03450000
                                                                        03460000
TBLCRETB DS    0H                                                       03470000
         TBCREATE QCSTABLE,       PROVIDE GENERATED TABLE NAME         X03480000
               STOKEN=*ICTXSPT@,  EXECUTION SPACE                      X03490000
               TTOKEN=QCSTTOKN,   TABLE TOKEN IS GLOBAL SQL RESOURCE   X03500000
               COLCNT=*CRSD.CRSDTOT#,   COLUMN COUNT                   X03510000
               COLLST=*CRSD.CRSDPTR@,   COLUMN POINTER ARRAY           X03520000
               KEYCNT=*DWORD+4,   KEY COUNT                            X03530000
               KEYLST=*DWORD+0,   KEY LIST                             X03540000
               OPTS=(REPLACE,NOLOCATOR),                               X03550000
               MF=(E,WK256)                                             03560000
                                                                        03570000
*--------------------------------------------------------------         03580000
*   ANALYZE TBCREATE STATUS, RELEASE INDEX & RSD DEFINITIONS            03590000
*--------------------------------------------------------------         03600000
                                                                        03610000
         STM   R15,R1,RETCODES    PRESERVE TBCREATE COMPLETION STATUS   03620000
         ICM   R2,15,@NDXDEF      INDEX DEFINITION WORKAREA PENDING?    03630000
         BZ    TBLNONDX           SKIP IF NOT                           03640000
                                                                        03650000
         $RETSTOR (R2)            STORAGE OBLIGATION                    03660000
                                                                        03670000
TBLNONDX DS    0H                                                       03680000
                                                                        03690000
         CLC   RET_CRSD,=A(RC00)  RESULT SET DEFINITION CREATED?        03700000
         BNE   TBLNORSD           SKIP IF BASE TABLE DEFINITION USED    03710000
                                                                        03720000
         $RETSTOR *CRSD.CRSDPTR@                                        03730000
                                                                        03740000
TBLNORSD DS    0H                                                       03750000
                                                                        03760000
         LM    R15,R1,RETCODES    RESTORE TBCREATE COMPLETION STATUS    03770000
         LTR   R15,R15            TABLE CREATED WITHOUT INCIDENT?       03780000
         BNZ   ERR_TBSV           TERMINATING ERROR OTHERWISE           03790000
                                                                        03800000
         MVI   QCSTDROP,TRUE      AUTO DROP UPON CLOSE                  03810000
         DROP  CRSD               CREATE RESULT SET DEFINITION REQ/RESP 03820000
                                                                        03830000
*--------------------------------------------------------------         03840000
*   TERMINATE AT THIS POINT IF SQLPREPARE() OR SQL_ROWVER REQ           03850000
*--------------------------------------------------------------         03860000
                                                                        03870000
         CLI   QCSCLI,QCSC_PRP    SQLPREPARE()?                         03880000
         BE    NORMRET            DONE IF SO                            03890000
                                                                        03900000
         CLI   FCOLTYPE,C'V'      SQL_ROWVER REQUEST?                   03910000
         BE    NORMRET            RETURN AN EMPTY RESULT SET IF SO      03920000
                                                                        03930000
         EJECT                                                          03940000
***************************************************************         03950000
*                                                                       03960000
*   Identify columns that accept nulls included in result set           03970000
*                                                                       03980000
***************************************************************         03990000
                                                                        04000000
         TBCOLUMN BYNAME,         IDENTIFY COLUMNS BY NAME             X04010000
               (('SCALE',STASCALE)),                                   X04020000
               TTOKEN=QCSTTOKN,                                        X04030000
               MF=(E,WK256)                                             04040000
                                                                        04050000
         EJECT                                                          04060000
***************************************************************         04070000
*                                                                       04080000
*   Complete the predicate tree.  TBPSARG is issued to complete         04090000
*   the saearch argument passed to this routine, if any, with           04100000
*   references to the result set table created above.  The              04110000
*   near-ready tree is passed in via QCSSITRE and the TBPSARGed         04120000
*   tree is generally returned via QCSSATRE when it will be             04130000
*   used as a true TBGET search argument.  However, because we          04140000
*   will use it instead as a TBADD filter we leave QCSSATRE             04150000
*   null - all of the result set trimming will be accomplished          04160000
*   up front at TBADD time.                                             04170000
*                                                                       04180000
***************************************************************         04190000
                                                                        04200000
         ICM   R2,15,QCSSITRE     SEARCH ARGUMENT TREE PROVIDED?        04210000
         BZ    SARG_FIN           NO FURTHER PROCESSING IF NOT          04220000
                                                                        04230000
         TBPSARG TTOKEN=QCSTTOKN, CONVERT TO TABLE SERVICES EXEC FORM  X04240000
               SARGS=(R2),                                             X04250000
               XSTGMGR=(IGENCSTG,QCSGPSTG,WK256),                      X04260000
               MF=(E,MFE_LIST)                                          04270000
                                                                        04280000
         ST    R15,QCSPSARC       POST TBPSARG RETCODE                  04290000
         ST    R0,QCSPSARS        POST TBPSARG RSNCODE                  04300000
         LTR   R15,R15            NORMAL COMPLETION?                    04310000
         BNZ   ERR_ANAL           QCS ANALYSIS REQUIRED IF NOT          04320000
                                                                        04330000
         CLM   R0,1,=AL1(TRUE)    SEARCH ARG IS CATEGORICALLY TRUE?     04340000
         BNE   *+10               SKIP IF NOT                           04350000
         XC    QCSSITRE,QCSSITRE  SEARCH ARGUMENT / FILTER WITHDRAWN    04360000
                                                                        04370000
SARG_FIN DS    0H                                                       04380000
                                                                        04390000
         EJECT                                                          04400000
***************************************************************         04410000
*                                                                       04420000
*   SYSDICTIONARY SCAN                                                  04430000
*                                                                       04440000
*   Acquire the SYSDICTIONARY entry of each table residing in           04450000
*   the selected object space via repeated calls to ICAT$SCN,           04460000
*   retrieving one table descriptor per call. If EOT is                 04470000
*   returned on the first call, we assume that SYSDICTIONARY            04480000
*   does not exist in the target space, and therefore no                04490000
*   contents information is available.                                  04500000
*                                                                       04510000
***************************************************************         04520000
                                                                        04530000
         LA    R0,RTBDESC         TBDESC RETURN AREA                    04540000
         O     R0,=X'80000000'    SUGGESTED AREA IS NOT FREEABLE        04550000
         LA    R1,L'RTBDESC       RETURN AREA LENGTH                    04560000
         STM   R0,R1,RETDESC      EXPANDABLE RETURN AREA                04570000
                                                                        04580000
CCATSCAN DS    0H                                                       04590000
         @CALL ICAT$SCN,(*QCSTSPAC,$SCNCKPT,$DDEROW),                  X04600000
               CTYPE=CVT,                                              X04610000
               MF=(E,MFE_LIST)                                          04620000
                                                                        04630000
         CH    R15,=AL2(RC04)     CATALOG TABLE DESCRIPTORS RETURNED?   04640000
         BE    CCATEOT            END OF TABLE                          04650000
         BH    ERR_CSCN           TERMINATING ERROR WHILE SCANNING CAT  04660000
                                                                        04670000
D        USING DDENTRY,$DDEROW    SYSDICTIONARY ROW                     04680000
                                                                        04690000
         EJECT                                                          04700000
***************************************************************         04710000
*                                                                       04720000
*   Issue TBDESC to acquire information about the base table            04730000
*   and all of its indicies.  The TBDESC service requires that          04740000
*   the table be opened.                                                04750000
*                                                                       04760000
*   TBDESC is capable of acquiring its own (TBFMT) return area          04770000
*   but that storage is not owned and would require RMX                 04780000
*   protection.  To simplify recovery, we provide the return            04790000
*   area in workunit-owned storage.                                     04800000
*                                                                       04810000
*   If this service is extended to fully support multiuser              04820000
*   execution spaces, serialization or some other form of table         04830000
*   locking will be required.                                           04840000
*                                                                       04850000
**************************************************************          04860000
                                                                        04870000
         TBOPEN D.DDETABNM,                                            X04880000
               STOKEN=*QCSTSPAC,                                       X04890000
               TTOKEN=CURTABTK,                                        X04900000
               MF=(E,MFE_LIST)                                          04910000
                                                                        04920000
         LTR   R15,R15            NORMAL COMPLETION                     04930000
         BNZ   CCATSCAN           PROBABLE ERROR, BUT ATTEMPT CONTINUE  04940000
                                                                        04950000
*--------------------------------------------------------------         04960000
*   ACQUIRE TABLE DESCRIPTION                                           04970000
*--------------------------------------------------------------         04980000
                                                                        04990000
REDESC   DS    0H                                                       05000000
         TBDESC RETURN=*RETDESC+0,                                     X05010000
               LENGTH=*RETDESC+4,                                      X05020000
               TTOKEN=CURTABTK,                                        X05030000
               MF=(E,MFE_LIST)                                          05040000
                                                                        05050000
         CH    R15,=AL2(RC04)     ANALYZE COMPLETION                    05060000
         BL    RECLOSE            DESCRIPTION ACQUIRED                  05070000
         BH    ERR_TBSV           TABLE SERVICES FAILURE                05080000
                                                                        05090000
         LA    R1,RETDESC         R1 <== RETURN AREA DESCRIPTOR         05100000
         BAS   R14,REALLOC        R0 <== MINIMUM LENGTH REQUIRED        05110000
         B     REDESC             TRY AGAIN                             05120000
                                                                        05130000
*--------------------------------------------------------------         05140000
*   CLOSE OPENED CATALOG TABLE                                          05150000
*--------------------------------------------------------------         05160000
                                                                        05170000
RECLOSE  DS    0H                                                       05180000
         TBCLOSE TTOKEN=CURTABTK,                                      X05190000
               MF=(E,MFE_LIST)                                          05200000
                                                                        05210000
         EJECT                                                          05220000
***************************************************************         05230000
*                                                                       05240000
*   Determine whether the table described is indexed and, if            05250000
*   so, locate the first index defined that is both UNIQUE and          05260000
*   DENSE.  If such an index is defined, the associated columns         05270000
*   define a unique rowid.                                              05280000
*                                                                       05290000
***************************************************************         05300000
                                                                        05310000
         L     R6,RETDESC+0       LOCATE RETURNED DESCRIPTION           05320000
         USING TBFMT,R6           TBDESC RETURN AREA FORMAT             05330000
         SR    R5,R5              PREPARE FOR INSERT                    05340000
         ICM   R5,3,TBF#KEYS      NUMBER OF KEY (INDEX) DEFINITIONS     05350000
         BZ    NDXFIN             TABLE HAS NO INDICIES                 05360000
         L     R6,TBFKOFF         SCAN INDEX DEFINITIONS                05370000
         USING TBKEYDEF,R6        INDEX DEFINITION FORMAT               05380000
                                                                        05390000
NDXNEXT  DS    0H                                                       05400000
         CLI   TBKTYPE,$DENSE     DENSE INDEX?                          05410000
         BNE   NDXADV             NOT ELIGIBLE OTHERWISE                05420000
         CLI   TBKTYPE2,$UNIQUE   UNIQUE INDEX?                         05430000
         BE    NDXSEL             INDEX DEFINES ROWID COMPONENTS        05440000
                                                                        05450000
NDXADV   DS    0H                                                       05460000
         LH    R2,TBKCOUNT        NUMBER OF COLUMNS SPANNED BY NDX      05470000
         SLL   R2,2               FOUR BYTE ENTRY FOR EACH              05480000
         LA    R6,TBKEYDEF+TBKEYDFL(R2)                                 05490000
         BCT   R5,NDXNEXT         PROCESS NEXT INDEX ON CURRENT TABLE   05500000
                                                                        05510000
NDXFIN   DS    0H                 NO ELIGIBLE INDEX FOUND               05520000
         B     CCATSCAN                                                 05530000
                                                                        05540000
NDXSEL   DS    0H                                                       05550000
                                                                        05560000
         EJECT                                                          05570000
***************************************************************         05580000
*                                                                       05590000
*   An eligible index on the current table has been identified.         05600000
*   Retain the table name in each generated row.                        05610000
*                                                                       05620000
***************************************************************         05630000
                                                                        05640000
         LA    R0,VCHARBUF        VARDATA COLLECTION AREA               05650000
         ST    R0,VCHAR@          ENTIRE AREA AVAILABLE FOR USE         05660000
         LA    R0,L'VCHARBUF      VARDATA COLLECTION AREA LENGTH        05670000
         ST    R0,VCHAR#          INITIAL AMOUNT AVAILABLE FOR USE      05680000
                                                                        05690000
         $VARTRMC D.DDETABNM,VCHAR@,VCHAR#                              05700000
                                                                        05710000
         BZ    *+8                                                      05720000
         EX    R0,*               ASSERT SPACE AVAILABLE                05730000
         ST    R1,C.ODBSCOL_TABLE_NAME                                  05740000
                                                                        05750000
         MVC   VCHAR@T,VCHAR@     PRESERVE TABLE LEVEL VARDATA          05760000
         MVC   VCHAR#T,VCHAR#     INSERTION ADDR AND REMAINING SPACE    05770000
                                                                        05780000
***************************************************************         05790000
*                                                                       05800000
*   Run the list of columns spanned by the index extracting             05810000
*   column names and data type information and generate a row           05820000
*   for each.                                                           05830000
*                                                                       05840000
***************************************************************         05850000
                                                                        05860000
         LH    R4,TBKCOUNT        NUMBER OF COLUMNS SPANNED BY INDEX    05870000
         LA    R5,TBKCOLS         TBCOLDEF PTR ARRAY                    05880000
                                                                        05890000
COLNEXT  DS    0H                                                       05900000
         L     R6,0(,R5)          LOCATE NEXT TBCOLDEF ENTRY            05910000
         USING TBCOLDEF,R6        COLUMN DEFINITION FORMAT              05920000
                                                                        05930000
*--------------------------------------------------------------         05940000
*   INCLUDE OR EXCLUDE NULLABLE COLUMNS PER REQUEST FORMAT              05950000
*--------------------------------------------------------------         05960000
                                                                        05970000
         TM    TBCATTRS,$ATNULL   COLUMN ADMITS NULLS?                  05980000
         BNO   COLNULL            ALWAYS SELECTED IF NOT                05990000
         CLI   FNULLABL,C'N'      NULLABLE COLUMN INFO REQUESTED?       06000000
         BNE   COLADV             SKIP IT IF NOT                        06010000
                                                                        06020000
COLNULL  DS    0H                                                       06030000
                                                                        06040000
*--------------------------------------------------------------         06050000
*   IMPLEMENTATION SPECIFIC DATA (LIMITATIONS)                          06060000
*--------------------------------------------------------------         06070000
                                                                        06080000
         MVC   VCHAR@,VCHAR@T     RESTORE TABLE LEVEL VARDATA           06090000
         MVC   VCHAR#,VCHAR#T     INSERTION ADDR AND REMAINING SPACE    06100000
                                                                        06110000
         XC    NULL_IND,NULL_IND  RESET NULL INDICATORS                 06120000
                                                                        06130000
         LA    R0,SQL_SCOPE_SESSION   SCOPE IS INVARIANT                06140000
         STH   R0,C.ODBSCOL_SCOPE                                       06150000
                                                                        06160000
         LA    R0,SQL_PC_NOT_PSEUDO   NO PSEUDO-COLUMNS                 06170000
         STH   R0,C.ODBSCOL_PSEUDO_COLUMN                               06180000
                                                                        06190000
*--------------------------------------------------------------         06200000
*   COLUMN NAME                                                         06210000
*--------------------------------------------------------------         06220000
                                                                        06230000
         $VARTRMC TBCNAME,VCHAR@,VCHAR#                                 06240000
                                                                        06250000
         BZ    *+8                                                      06260000
         EX    R0,*               ASSERT SPACE AVAILABLE                06270000
         ST    R1,C.ODBSCOL_COLUMN_NAME                                 06280000
                                                                        06290000
*--------------------------------------------------------------         06300000
*   ACQUIRE DATA TYPE INFORMATION                                       06310000
*--------------------------------------------------------------         06320000
                                                                        06330000
DQ       USING DTQUERY,$DTQUERY                                         06340000
         XC    DQ.DTQUERY(DTQREQL),DQ.DTQUERY                           06350000
                                                                        06360000
         MVC   DQ.DTQDTYPE,TBCDTYPE  PRIMARY DATA TYPE CODE             06370000
         MVC   DQ.DTQNTYPE,TBCNTYPE  NUMERIC DATA TYPE SUBCODE          06380000
         L     R0,TBCLENG            ACTUAL COLUMN LENGTH               06390000
         ST    R0,DQ.DTQSTGLN                                           06400000
         LH    R0,TBCMAXLN           MAX DATA LENGTH IF APPLICABLE      06410000
         ST    R0,DQ.DTQSTGMX                                           06420000
         MVC   DQ.DTQNULL,TBCATTRS   COLUMN ATTRIBUTES                  06430000
         NI    DQ.DTQNULL,$ATNULL    ISOLATE NULLABILITY ATTRIBUTE      06440000
                                                                        06450000
         LA    R1,$DTQUERY        R1 <== DTQUERY PARM BLOCK             06460000
         @CALL IODBTYPS,MF=(E,DQ.DTQUERY)                               06470000
                                                                        06480000
         ST    R15,FWORD          PRESERVE RETURN CODE FOR RETURN       06490000
                                                                        06500000
*--------------------------------------------------------------         06510000
*   TRANSFER DATA TYPE INFORMATION TO ODBSCOL ROW                       06520000
*--------------------------------------------------------------         06530000
                                                                        06540000
         MVC   C.ODBSCOL_DATA_TYPE,DQ.DTQRCODE                          06550000
         MVC   C.ODBSCOL_PRECISION,DQ.DTQRPREC                          06560000
         MVC   C.ODBSCOL_LENGTH,DQ.DTQRLEN                              06570000
         MVC   C.ODBSCOL_SCALE,DQ.DTQRSCAL                              06580000
                                                                        06590000
*--------------------------------------------------------------         06600000
*   SET NULL INDICATORS FOR OMITTED, NON-APPLICABLE ITEMS               06610000
*--------------------------------------------------------------         06620000
                                                                        06630000
         SR    R2,R2              R2 <== COLUMN NUMBER                  06640000
         LA    R3,NULL_IND        R3 <== NULL INDICATOR MASK ORIGIN     06650000
                                                                        06660000
         ICM   R2,3,STASCALE      SCALE REQUIRES NULL IF N/A            06670000
         BZ    COLSCALE                                                 06680000
         CLC   DQ.DTQRSCAL,=AL2(SQL_NULL_DATA)                          06690000
         BNE   COLSCALE                                                 06700000
         BAS   R14,SETNULL                                              06710000
                                                                        06720000
COLSCALE DS    0H                                                       06730000
                                                                        06740000
*--------------------------------------------------------------         06750000
*   REFORMAT ZERO DELIMITTED DATA TYPE NAME RETURNED                    06760000
*--------------------------------------------------------------         06770000
                                                                        06780000
         ICM   R3,15,DQ.DTQRNAME  DATA TYPE NAME RETURNED?              06790000
         BZ    COLTYPNM           DONE IF NOT                           06800000
                                                                        06810000
         MVI   WK256,0                                                  06820000
         MVC   WK256+1(L'WK256-1),WK256                                 06830000
         MVI   WK256,4                                                  06840000
                                                                        06850000
         TRT   0(256,R3),WK256    FIND END OF NAME                      06860000
         BC    MISSES,COLTYPNM    UNEXPECTED AND PROBABLY BROKEN        06870000
         LR    R2,R1              END OF STRING                         06880000
         SR    R2,R3              LENGTH OF NAME                        06890000
                                                                        06900000
         $VARTRMC ((R3),(R2)),VCHAR@,VCHAR#                             06910000
                                                                        06920000
         BZ    *+8                ASSERT SUCCESS                        06930000
         EX    R0,*               DENIED                                06940000
         ST    R1,C.ODBSCOL_TYPE_NAME                                   06950000
                                                                        06960000
COLTYPNM DS    0H                                                       06970000
         DROP  DQ                 DTQUERY                               06980000
                                                                        06990000
*--------------------------------------------------------------         07000000
*   ADD THE COMPLETED ROW TO THE RESULT SET                             07010000
*--------------------------------------------------------------         07020000
                                                                        07030000
         TBADD C.ODBSCOLS,        INSERT ROW IN RESULT SET             X07040000
               TTOKEN=QCSTTOKN,                                        X07050000
               FILTER=*QCSSITRE,  SEARCH ARGUMENT AS FILTER            X07060000
               NULLMASK=NULL_IND, NULL INDICATORS                      X07070000
               MF=(E,MFE_LIST)                                          07080000
                                                                        07090000
         CH    R15,=AL2(RC08)     ADDED OR SUPPRESSED PER REQUEST?      07100000
         BH    ERR_TBSV           ERROR OTHERWISE                       07110000
                                                                        07120000
*--------------------------------------------------------------         07130000
*   ADVANCE TO NEXT COLUMN DESCRIPTOR AND REPEAT                        07140000
*--------------------------------------------------------------         07150000
                                                                        07160000
COLADV   DS    0H                                                       07170000
         LA    R5,4(,R5)          ADVANCE TO NEXT TBCOLDEF PTR          07180000
         BCT   R4,COLNEXT         PROCESS ALL COLUMNS                   07190000
         B     CCATSCAN           NEXT TABLE                            07200000
         DROP  D,R6               DDENTRY, TBCOLDEF                     07210000
                                                                        07220000
CCATEOT  DS    0H                 CATALOG SWEEP COMPLETED               07230000
                                                                        07240000
         EJECT                                                          07250000
***************************************************************         07260000
*                                                                       07270000
*   Return result set and/or completion status to requester             07280000
*                                                                       07290000
***************************************************************         07300000
                                                                        07310000
NORMRET  DS    0H                 FORMAT DATA FOR RETURN                07320000
         MVC   QCSTSPAC,ICTXSPT@  RETURN EXECUTION SPACE TOKEN          07330000
         B     RETURN             DONE                                  07340000
                                                                        07350000
*--------------------------------------------------------------         07360000
*   REFERENCE TO UNDEFINED COLUMN                                       07370000
*--------------------------------------------------------------         07380000
                                                                        07390000
ERR_CREF DS    0H                 INVALID COLUMN REFERENCE              07400000
CREF     USING SQCOLREF,R1        COLUMN OCCURRENCE                     07410000
         MVC   QCSECLEX,CREF.SQCOL@C   #CLEX ADDRESS                    07420000
                                                                        07430000
         SQLSTAT ERC_CREF                                               07440000
                                                                        07450000
         B     RETURN                                                   07460000
         DROP  CREF               SQCOLREF                              07470000
                                                                        07480000
*--------------------------------------------------------------         07490000
*   ORDER BY CLAUSE ERROR                                               07500000
*--------------------------------------------------------------         07510000
                                                                        07520000
ERR_ORD  DS    0H                 ERROR IN 'ORDER BY' CLAUSE            07530000
         LR    R2,R1              SUPPLEMENTAL MESSAGE                  07540000
                                                                        07550000
         SQLSTAT ERC_ORD,INFO=(R15)                                     07560000
                                                                        07570000
         SQLMSG 170,(R2)                                                07580000
                                                                        07590000
         B     RETURN                                                   07600000
                                                                        07610000
*--------------------------------------------------------------         07620000
*   DISTINCT KEYDEF BUILD ERROR                                         07630000
*--------------------------------------------------------------         07640000
                                                                        07650000
ERR_DIST DS    0H                 ERROR BUILDING INDEX serving DISTINCT 07660000
         SQLSTAT ERC_DIST,INFO=(R15)                                    07670000
                                                                        07680000
         B     RETURN                                                   07690000
                                                                        07700000
*--------------------------------------------------------------         07710000
*   RESULT SET DEFINITION - CONSTRUCTION ERROR                          07720000
*--------------------------------------------------------------         07730000
                                                                        07740000
ERR_RSD  DS    0H                 ERROR CONSTRUCTING RSD                07750000
         SQLSTAT ERC_RSD,INFO=(R15)                                     07760000
                                                                        07770000
         B     RETURN                                                   07780000
                                                                        07790000
*--------------------------------------------------------------         07800000
*   INVALID TABLE NAME                                                  07810000
*--------------------------------------------------------------         07820000
                                                                        07830000
ERR_CTAB DS    0H                 TABLE NAME SUFFIX IS INVALID          07840000
         SQLSTAT ERC_CTAB                                               07850000
                                                                        07860000
         B     RETURN                                                   07870000
                                                                        07880000
*--------------------------------------------------------------         07890000
*   CATALOG SCAN FAILURE                                                07900000
*--------------------------------------------------------------         07910000
                                                                        07920000
ERR_CSCN DS    0H                                                       07930000
         SQLIDCMP COMPONENT='CATALOG SCAN'                              07940000
                                                                        07950000
         SQLSTAT ERC_CSCN,INFO=(R15)                                    07960000
                                                                        07970000
         B     RETURN                                                   07980000
                                                                        07990000
*--------------------------------------------------------------         08000000
*   TABLE SERVICE FAILURE                                               08010000
*--------------------------------------------------------------         08020000
                                                                        08030000
ERR_TBSV DS    0H                                                       08040000
         SQLIDCMP COMPONENT='TABLE SERVICES'                            08050000
                                                                        08060000
         SQLSTAT ERC_TBSV,INFO=(R15)                                    08070000
                                                                        08080000
         B     RETURN                                                   08090000
                                                                        08100000
*--------------------------------------------------------------         08110000
*   SERVICE FAILURE, QCS ANALYSIS REQUIRED FOR DETAIL                   08120000
*--------------------------------------------------------------         08130000
                                                                        08140000
ERR_ANAL DS    0H                 QCS ANALYSIS REQUIRED                 08150000
         SQLSTAT ERC_ANALYZE                                            08160000
                                                                        08170000
         B     RETURN                                                   08180000
                                                                        08190000
*--------------------------------------------------------------         08200000
*   RETURN                                                              08210000
*--------------------------------------------------------------         08220000
                                                                        08230000
RETURN   DS    0H                                                       08240000
         STM   R15,R1,RETCODES    PRESERVE RETURN REGS                  08250000
                                                                        08260000
         ICM   R2,15,RETDESC+0    AUX TBFMT (TBDESC) RETURN AREA ALLOC? 08270000
         BNP   RET_DESC           SKIP IF NOT                           08280000
                                                                        08290000
         $RETSTOR (R2)                                                  08300000
                                                                        08310000
RET_DESC DS    0H                                                       08320000
         LM    R15,R1,RETCODES    RESTORE RETURN REGS                   08330000
                                                                        08340000
         #EXIT ,                                                        08350000
                                                                        08360000
         EJECT                                                          08370000
***************************************************************         08380000
*                                                                       08390000
*   CATASTROPHIC FAILURES, PROGRAMMING ERRORS, ETC.                     08400000
*                                                                       08410000
***************************************************************         08420000
                                                                        08430000
ABN_FAIL $ABEND ABE_ENV,DUMP=YES,                                      X08440000
               TITLE='RESULT SET DEFINITION - GENERATION ERROR'         08450000
                                                                        08460000
         EJECT                                                          08470000
***************************************************************         08480000
*                                                                       08490000
* ROUTINE: REALLOC - REALLOCATE DATA RETURN AREA                        08500000
*                                                                       08510000
* ON ENTRY:                                                             08520000
*                                                                       08530000
*    R1 - DATA AREA DESCRIPTOR IN $REALLOC FORMAT                       08540000
*    R0 - LENGTH OF DATA AREA REQUIRED                                  08550000
*                                                                       08560000
* ON EXIT:                                                              08570000
*                                                                       08580000
*    RETURN AREA REPLACED AND ITS DESCRIPTOR UPDATED                    08590000
*                                                                       08600000
***************************************************************         08610000
                                                                        08620000
REALLOC  DS    0H                                                       08630000
         STM   R0,R15,REGSAVE     PRESERVE MAINLINE REGS                08640000
                                                                        08650000
         LR    R2,R1              DATA AREA (PTR,LENGTH)                08660000
         LR    R3,R0              LENGTH REQUIRED                       08670000
                                                                        08680000
         $REALLOC (R2),(R3),                                           X08690000
               COND=NO,                                                X08700000
               MF=(E,MFE_LIST)                                          08710000
                                                                        08720000
         LM    R0,R14,REGSAVE     RESTORE MAINLINE REGS                 08730000
         BR    R14                RETURN                                08740000
                                                                        08750000
         EJECT                                                          08760000
***************************************************************         08770000
*                                                                       08780000
* ROUTINE: SETNULL - SET NULL MASK BIT FOR GIVEN COLUMN                 08790000
*                                                                       08800000
* ON ENTRY:                                                             08810000
*                                                                       08820000
*    R3 - MASK ORIGIN                                                   08830000
*    R2 - COLUMN NUMBER (1 TO N)                                        08840000
*                                                                       08850000
***************************************************************         08860000
                                                                        08870000
SETNULL  DS    0H                                                       08880000
         ST    R14,FWORD          PRESERVE RETURN ADDRESS               08890000
                                                                        08900000
         SETBIT (R3),(R2)                                               08910000
                                                                        08920000
         L     R14,FWORD          RESTORE RETURN ADDRESS                08930000
         BR    R14                RETURN                                08940000
                                                                        08950000
         EJECT                                                          08960000
***************************************************************         08970000
*                                                                       08980000
*   LOCAL READ-ONLY WORKING STORAGE                                     08990000
*                                                                       09000000
***************************************************************         09010000
                                                                        09020000
         LTORG ,                                                        09030000
                                                                        09040000
         EJECT                                                          09050000
         SQLCODES ,                                                     09060000
                                                                        09070000
         EJECT                                                          09080000
         PRINT NOGEN                                                    09090000
         ICVT ,              ICVT                                       09100000
         ITASK ,             ITASK                                      09110000
         END   ,                                                        09120000

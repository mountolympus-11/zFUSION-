IFLDCMP  TITLE '- 3270 FIELD DIFFERENCE IDENTIFICATION'                 00010000
         #WORK LENGTH=1024                                              00020000
*                                                                       00030000
FIEPART1 DS    0A,0F,0A           FIRST THREE FIELDS ACCESSED BY LM/STM 00040000
FIP1ADRB DS    A                     PART 1 ORIGIN, BUFFER B            00050000
FIP1LEN  DS    F                     PART 1 LENGTH                      00060000
FIP1ADRA DS    A                     PART 1 ORIGIN, BUFFER A            00070000
FIP1LZER DS    F                  # LEADING ZEROS                       00080000
FIP1PAD  DS    A                  REPEATED PAD CHAR PTR                 00090000
FIP1PADL DS    A                  PAD CHAR REPETITION (0 OR >1)         00100000
FIEPLN   EQU   *-FIEPART1         LENGTH OF BLOCK                       00110000
*                                                                       00120000
FIEPART2 DS    0A,0F,0A           FIRST THREE FIELDS ACCESSED BY LM/STM 00130000
FIP2ADRB DS    A                     PART 1 ORIGIN, BUFFER B            00140000
FIP2LEN  DS    F                     PART 1 LENGTH                      00150000
FIP2ADRA DS    A                     PART 1 ORIGIN, BUFFER A            00160000
FIP2LZER DS    F                  # LEADING ZEROS                       00170000
FIP2PAD  DS    A                  REPEATED PAD CHAR PTR                 00180000
FIP2PADL DS    A                  PAD CHAR REPETITION (0 OR >1)         00190000
*                                                                       00200000
WK512    DS    XL512              GENERAL PURPOSE WORKAREA              00210000
*                                                                       00220000
         #ENDWORK ,                                                     00230000
                                                                        00240000
         EJECT                                                          00250000
         FLDCMPRM ,                                                     00260000
                                                                        00270000
         EJECT                                                          00280000
         EQUS  ,                                                        00290000
                                                                        00300000
         EJECT                                                          00310000
***************************************************************         00320000
*                                                                       00330000
* ROUTINE: IFLDCMP - 3270 FIELD DIFFERENCE IDENTIFICATION               00340000
*                                                                       00350000
* DESCRIPTION:                                                          00360000
*                                                                       00370000
*    THIS ROUTINE COMPARES TWO TEXT AREAS EXPRESSED AS OFFSET           00380000
*    AND LENGTH FROM TWO BUFFER ORIGINS AND RETURNS A COMPACT           00390000
*    REPRESENTATION OF THE 'NEW' TEXT WHEN THE TWO FIELDS               00400000
*    DIFFER.                                                            00410000
*                                                                       00420000
*    BECAUSE 3270 FIELDS MAY WRAP AND OCCUPY DISCONTIGUOUS              00430000
*    STORAGE WITHIN THE SCREEN BUFFER, AND BECAUSE NO BIND              00440000
*    DEPENDENT WORKAREAS ARE USED IN THIS ROUTINE, THE                  00450000
*    REPLACMENT STRING MAY RETURNED AS A SINGLE STRING, OR AS           00460000
*    TWO STRINGS THAT MAY BE APPENDED BY THE CALLER.  IN                00470000
*    EITHER RETURN FORMAT, A FIELD PAD CHARACTER MAY ALSO BE            00480000
*    IDENTIFIED.                                                        00490000
*                                                                       00500000
*                                                                       00510000
* ON ENTRY:                                                             00520000
*                                                                       00530000
*    R1  CONTAINS THE ADDRESS OF A PARAMETER LIST DESCRIBED BY          00540000
*        THE FLDCMPRM MAPPING MACRO.                                    00550000
*                                                                       00560000
*    R0  CONTAINS THE ADDRESS OF 1K WORKAREA, OR ZERO                   00570000
*                                                                       00580000
*                                                                       00590000
* ON EXIT:                                                              00600000
*                                                                       00610000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES                     00620000
*                                                                       00630000
*          RC00 - FIELDS ARE EQUAL                                      00640000
*                                                                       00650000
*          RC04 - FIELDS ARE NOT EQUAL. THE BUFFER B VERSION IS         00660000
*                 NULL (ALL ZERO)                                       00670000
*                                                                       00680000
*          RC08 - FIELDS ARE NOT EQUAL. THE COMPACTED BUFFER (B)        00690000
*                 REPLACEMENT TEXT AND/OR PAD CHARACTERS ARE            00700000
*                 REFLECTED IN FLDCMPRM.FRETAREA                        00710000
*                                                                       00720000
***************************************************************         00730000
         EJECT ,                                                        00740000
IFLDCMP  #ENTER PREG=R8,WAPASS=YES                                      00750000
                                                                        00760000
         USING ICVT,R11           STANDARD ENVIRONMENT                  00770000
         USING ITASK,R10                                                00780000
                                                                        00790000
         EJECT                                                          00800000
***************************************************************         00810000
*                                                                       00820000
*   COMPARE THE TWO FIELDS.  IF THEY CONTAIN DIFFERENT TEXT             00830000
*   FURTHER DESCRIBE THE COMPOSITION OF THE (ONE OR TWO) PARTS          00840000
*   OF FIELD (B) BY COMPLETING THE FIEPART1 AND FIEPART2                00850000
*   STRUCTURES.                                                         00860000
*                                                                       00870000
***************************************************************         00880000
         USING FLDCMPRM,R8        FORMAT                                00890000
         XC    FRETAREA(FRETSLN),FRETAREA                               00900000
                                                                        00910000
         SR    R9,R9              NUMBER OF PARTS                       00920000
         LA    R4,FIEPART1        PART 1 / BUF B FIELD RESOLUTION       00930000
         ICM   R1,15,FLEN1        PART 1 DEFINED?                       00940000
         BZ    FLCP2              PROVIDED AS PART2                     00950000
                                                                        00960000
         L     R0,FOFF1           OFFSET, BOTH BUFFERS                  00970000
         LR    R2,R0              ADDRESS CONVERSION                    00980000
         AL    R0,FBUFRB          ORIGIN ADDR IN BUFFER B               00990000
         AL    R2,FBUFRA          ORIGIN ADDR IN BUFFER A               01000000
         STM   R0,R2,0(R4)        IDENTIFY PART 1                       01010000
         LA    R9,1               # PARTS COMPRISING FIELD              01020000
         LA    R4,FIEPART2        ADVANCE FOR NEXT PART                 01030000
                                                                        01040000
FLCP2    DS    0H                                                       01050000
         ICM   R1,15,FLEN2        PART 2 DEFINED?                       01060000
         BZ    FLCPX              DONE IF NOT                           01070000
                                                                        01080000
         L     R0,FOFF2           ITS OFFSET                            01090000
         LR    R2,R0              ADDRESS CONVERSION                    01100000
         AL    R0,FBUFRB          ORIGIN ADDR IN BUFFER B               01110000
         AL    R2,FBUFRA          ORIGIN ADDR IN BUFFER A               01120000
         STM   R0,R2,0(R4)        IDENTIFY PART 2                       01130000
         LA    R9,1(,R9)          # PARTS COMPRISING FIELD              01140000
                                                                        01150000
FLCPX    DS    0H                                                       01160000
         LTR   R9,R9              FIELD PROPERLY DEFINED?               01170000
         BNZ   *+8                CONTINUE IF SO                        01180000
         EX    R0,*               ASSERTION DENIED                      01190000
         BCTR  R9,0               (0,1) FORMAT EASIER TO TEST           01200000
                                                                        01210000
*--------------------------------------------------------------         01220000
*   TEST FOR EXACT FIELD MATCH                                          01230000
*--------------------------------------------------------------         01240000
         LM    R0,R2,FIEPART1     PART 1 ALWAYS PROVIDED                01250000
         LR    R3,R1              LENGTHS SAME IN BOTH BUFFERS          01260000
         CLCL  R0,R2              DIFFERENCES?                          01270000
         BNE   FLCMISS            MISMATCH IF SO                        01280000
                                                                        01290000
         LTR   R9,R9              MULTIPART FIELD?                      01300000
         BZ    FLC_EQ             MATCH IF NOT                          01310000
                                                                        01320000
         LM    R0,R2,FIEPART2     PART 1 ALWAYS PROVIDED                01330000
         LR    R3,R1              LENGTHS SAME IN BOTH BUFFERS          01340000
         CLCL  R0,R2              DIFFERENCES?                          01350000
         BE    FLC_EQ             MATCH IF NOT                          01360000
                                                                        01370000
*--------------------------------------------------------------         01380000
*   DISCARD LEADING ZEROS IN REPLACEMENT FIELD                          01390000
*--------------------------------------------------------------         01400000
FLCMISS  DS    0H                                                       01410000
         LM    R2,R3,FIEPART1     R2 - ORIGIN, R3 - LENGTH              01420000
         CLI   0(R2),0            LEADING ZEROS PRESENT?                01430000
         BNE   FLCEXTR            SKIP IF NOT                           01440000
                                                                        01450000
         $REPS FWD,(R2),(R3),WORKAREA=WK512                             01460000
                                                                        01470000
         ST    R15,FIP1LZER       SAVE RESULT                           01480000
         C     R15,FIP1LEN        ENTIRE PORTION NULLED?                01490000
         BNE   FLCEXTR            EXTRACT REPLACEMENT DATA IF NOT       01500000
                                                                        01510000
         SH    R9,=H'1'           PART 2 PRESENT?                       01520000
         BM    FLC_NULL           RESULT IS NULL OTHERWISE              01530000
         MVC   FIEPART1(FIEPLN),FIEPART2                                01540000
         B     FLCMISS            AGAIN                                 01550000
                                                                        01560000
*--------------------------------------------------------------         01570000
*   IDENTIFY REPEATING PAD CHARS IN BOTH COMPONENT PARTS                01580000
*--------------------------------------------------------------         01590000
FLCEXTR  DS    0H                                                       01600000
         $REPS BWD,*FIP1ADRB,*FIP1LEN,WORKAREA=WK512                    01610000
                                                                        01620000
         C     R15,=F'1'          MULTIPLE OCCURRENCES?                 01630000
         BNH   *+12               SKIP IF NOT                           01640000
         ST    R15,FIP1PADL       # OF REPEATERS                        01650000
         ST    R1,FIP1PAD         IDENTIFY REPEATING BYTE               01660000
                                                                        01670000
         LTR   R9,R9              MULTIPART FIELD?                      01680000
         BZ    FLCINFO            DONE IF NOT                           01690000
                                                                        01700000
         $REPS BWD,*FIP2ADRB,*FIP2LEN,WORKAREA=WK512                    01710000
                                                                        01720000
         C     R15,=F'1'          MULTIPLE OCCURRENCES?                 01730000
         BNH   *+12               SKIP IF NOT                           01740000
         ST    R15,FIP2PADL       # OF REPEATERS                        01750000
         ST    R1,FIP2PAD         IDENTIFY REPEATING BYTE               01760000
                                                                        01770000
         EJECT                                                          01780000
***************************************************************         01790000
*                                                                       01800000
*   CREATE A COMPOSITE RETURN STRING POSSIBLY EXPRESSED AS TWO          01810000
*   ADJACENT TEXT STRINGS AND AN OPTIONAL PAD USED TO FILL THE          01820000
*   REMAINDER OF THE FIELD.                                             01830000
*                                                                       01840000
***************************************************************         01850000
FLCINFO  DS    0H                                                       01860000
         L     R1,FIP1ADRB        PART 1 ORIGIN                         01870000
         A     R1,FIP1LZER        BYPASS LEADING ZEROS                  01880000
         ST    R1,FRETEX1         RETURN EXTENT 1 ORIGIN                01890000
         L     R2,FIP1LEN         PART 1 LENGTH                         01900000
         S     R2,FIP1LZER        LESS LEADING ZEROS                    01910000
         ST    R2,FRETEX1L        PRELIM LENGTH OF EXTENT 1             01920000
                                                                        01930000
         LTR   R9,R9              PART 2 PRESENT?                       01940000
         BZ    FLCEX1             PART 1 PERSPECTIVE ONLY               01950000
                                                                        01960000
*--------------------------------------------------------------         01970000
*   DETERMINE WHETHER RESULT MUST BE RETURNED AS TWO EXTENTS            01980000
*--------------------------------------------------------------         01990000
         L     R3,FIP2LEN         LENGTH OF PART 2                      02000000
         S     R3,FIP2PADL        LENGTH OMITTING PAD                   02010000
         BP    FLCEX2             SKIP IF PART 2 IS SIGNIFICANT         02020000
                                                                        02030000
         L     R5,FIP2PAD         ADDR OF PART 2 PAD CHAR               02040000
         ICM   R6,15,FIP1PAD      ADDR OF PART 1 PAD CHAR               02050000
         BZ    FLCEX2             PADDING NOT SIMILAR                   02060000
         CLC   0(1,R5),0(R6)      MATCHING PAD?                         02070000
         BE    FLCEX1             REASSESS SIZE OF PART 1 IF SO         02080000
                                                                        02090000
FLCEX2   DS    0H                                                       02100000
         ST    R3,FRETEX2L        EXTENT 2 LENGTH                       02110000
         MVC   FRETEX2,FIP2ADRB   EXTENT 2 ORIGIN                       02120000
         MVC   FRETPAD,FIP2PAD    PAD CHAR PTR OR ZERO                  02130000
         B     FLC_NE             FIELD NOT EQUAL                       02140000
                                                                        02150000
*--------------------------------------------------------------         02160000
*   ONLY EXTENT 1 IS RELEVANT                                           02170000
*--------------------------------------------------------------         02180000
FLCEX1   DS    0H                                                       02190000
         L     R2,FRETEX1L        REFRESH STRING LENGTH                 02200000
         S     R2,FIP1PADL        MINUS PART 1 PAD STRING LENGTH        02210000
         ST    R2,FRETEX1L        ADJUST EXTENT 1 STRING LENGTH         02220000
         MVC   FRETPAD,FIP1PAD    PAD CHAR PTR                          02230000
                                                                        02240000
         EJECT                                                          02250000
***************************************************************         02260000
*                                                                       02270000
*   RETURN COMPLETION STATUS TO CALLER                                  02280000
*                                                                       02290000
***************************************************************         02300000
FLC_NE   DS    0H                 FIELDS UNEQUAL, REPLACEMENT PROVIDED  02310000
         LA    R15,RC08                                                 02320000
         B     FLCXIT                                                   02330000
                                                                        02340000
FLC_NULL DS    0H                 FIELDS UNEQUAL, REPLACMENT IS NULL    02350000
         LA    R15,RC04                                                 02360000
         B     FLCXIT                                                   02370000
                                                                        02380000
FLC_EQ   DS    0H                 FIELDS ARE EQUAL                      02390000
         LA    R15,RC00                                                 02400000
         B     FLCXIT                                                   02410000
                                                                        02420000
FLCXIT   DS    0H                                                       02430000
         #EXIT ,                  RETURN                                02440000
                                                                        02450000
***************************************************************         02460000
*                                                                       02470000
*   LOCAL READ ONLY WORKING STORAGE                                     02480000
*                                                                       02490000
***************************************************************         02500000
         LTORG ,                                                        02510000
                                                                        02520000
         PRINT NOGEN                                                    02530000
         ICVT  ,                                                        02540000
         ITASK ,                                                        02550000
         END   ,                                                        02560000

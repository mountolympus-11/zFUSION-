ITSKPRLG TITLE '- TASK PROLOG ROUTINE'                                  00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE: ITSKPRLG - Task Prolog Routine                               00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine is the prolog for all ITASKs created via the          00080000
*    $TASK CREATE service.  There are two methods this routine          00090000
*    will receive control:                                              00100000
*                                                                       00110000
*        1)  MVS dispatch will pass control to this routine             00120000
*            from the ATTACH issued in ITSKCREA for ITASK               00130000
*            created with TCBAFF=YES.                                   00140000
*                                                                       00150000
*        2)  The task manager server will create an environment         00160000
*            similar to that of MVS and call this routine               00170000
*            to initialize the new task.                                00180000
*                                                                       00190000
*    Tasks created with TCB affinity will establish a recovery          00200000
*    environment and initialize the events table for the task.          00210000
*                                                                       00220000
*    If a standard task is being created,  the $MAIN process            00230000
*    is created and initially dispatched.  Server tasks do              00240000
*    not contain PCBs therefore no process is created.  Although        00250000
*    in both cases the task manager will receive control                00260000
*    through the $TASK CALLDSP service.                                 00270000
*                                                                       00280000
*                                                                       00290000
* ON ENTRY:                                                             00300000
*                                                                       00310000
*    R1 contains the address of the parameter list mapped by            00320000
*    the ITSKPARM mapping macro.                                        00330000
*                                                                       00340000
* ON EXIT:                                                              00350000
*                                                                       00360000
*    R15 contains one of the following return codes:                    00370000
*                                                                       00380000
*        RC00 - Normal completion                                       00390000
*                                                                       00400000
*        RC24 - Task prolog failure                                     00410000
*               R0 = RSN04 - Events initialization failure              00420000
*                    RSN08 - SETEPB failure                             00430000
*                    RSN12 - $PROC CREATE failure                       00440000
*                                                                       00450000
* MODE:                                                                 00460000
*                                                                       00470000
*    TASK                                                               00480000
*    APF/NON-APF                                                        00490000
*    SUP/PROB                                                           00500000
*    AMODE 31, RMODE ANY                                                00510000
*                                                                       00520000
**<DOC-OFF>*****************************************************        00530000
                                                                        00540000
         EJECT ,                                                        00550000
****************************************************************        00560000
*                                                                       00570000
* MAINTENANCE:                                                          00580000
*                                                                       00590000
*   04/22/93 RON COLMONE                                                00600000
*            INITIAL VERSION                                            00610000
*                                                                       00620000
*   07/02/93 R. TURGEON                                                 00630000
*            CAPTURE TCBTOKEN IN ITASK                                  00640000
*                                                                       00650000
*   01/01/95 Ron Colmone                                                00660000
*            Added support for Server task                              00670000
*                                                                       00680000
*   03/21/95 R. Turgeon                                                 00690000
*            Extended the size of the linkage stack                     00700000
*                                                                       00710000
*   07/12/95 R. Colmone                                                 00720000
*            Changed ITASK Dispatch priority to 1 byte.                 00730000
*                                                                       00740000
****************************************************************        00750000
                                                                        00760000
         EJECT ,                                                        00770000
         ITASKPRM ,               TASK PROLOG PLIST                     00780000
         EJECT ,                                                        00790000
         $TASK DSECT=YES          TASK MANAGER PLIST                    00800000
         EJECT ,                                                        00810000
         $PROC DSECT=YES          PROCESS MANAGER PLIST                 00820000
         EJECT ,                                                        00830000
         EQUS  ,                  GENERAL EQUATES                       00840000
         EJECT ,                                                        00850000
         EVCODES ,                EVENT COMPLETION CODES                00860000
         EJECT ,                                                        00870000
         TRACODES ,               TRACE EVENT CODES                     00880000
                                                                        00890000
         EJECT ,                                                        00900000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00910000
REGSAVE  DS    16F                REGISTER SAVE AREA                    00920000
*                                                                       00930000
FLAGS    DS    X                  TASK PROLOG FLAGS                     00940000
$ESTAE   EQU   X'80'                RECOVERY ENV ESTABLISHED            00950000
         DS    XL3                RESERVED                              00960000
*                                                                       00970000
ESTAELST ESTAEX *-*,CT,MF=L       ESTAEX PLIST                          00980000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00990000
                                                                        01000000
         EJECT ,                                                        01010000
ITSKPRLG #ENTER BASE=R12,         ENTRY LINKAGE                        +01020000
               SAVE=NO,                                                +01030000
               PREG=R8                                                 +01040000
                                                                        01050000
         LA    R0,WORKLEN         LENGTH OF WORKAREA                    01060000
         STORAGE OBTAIN,LENGTH=(R0)                                     01070000
                                                                        01080000
         LR    R3,R1              SAVE SAVE AREA ADDRESS                01090000
         LR    R0,R1              ADDR OF AREA TO CLEAR                 01100000
         LA    R1,WORKLEN         LENGTH OF AREA TO CLEAR               01110000
         SR    R15,R15            PREPAREA FOR CLEAR                    01120000
         MVCL  R0,R14             CLEAR WORKAREA                        01130000
                                                                        01140000
         ST    R13,4(,R3)         ADDRESS OF CALLER'S SAVE AREA         01150000
         ST    R3,8(,R13)         FORWARD CHAIN SAVE AREA               01160000
         LR    R13,R3             ADDRESS OF SAVEAREA                   01170000
         USING WORKAREA,R13       ESTABLISH ADDRESSABILITY              01180000
                                                                        01190000
         USING ITASKPRM,R8        ESTABLISH ADDRESSABILITY              01200000
         USING PSA,0              LIFETIME  ADDRESSABILITY              01210000
                                                                        01220000
         EJECT ,                                                        01230000
****************************************************************        01240000
*                                                                       01250000
* TASK PROLOG - ESTABLISH/PRESERVE standard environment                 01260000
*                                                                       01270000
****************************************************************        01280000
         L     R10,ITPITASK       ADDR OF ITASK CB                      01290000
         USING ITASK,R10          LIFETIME ADDRESSABILITY               01300000
                                                                        01310000
         L     R11,ITPICVT        ADDR OF ICVT  CB                      01320000
         USING ICVT,R11           LIFETIME ADDRESSABILITY               01330000
                                                                        01340000
         @PRESENV ,               PRESERVE STANDARD ENVIRONMENT         01350000
                                                                        01360000
*---------------------------------------------------------------        01370000
* Trace Task initialization                                             01380000
*---------------------------------------------------------------        01390000
         $TRACE TRC_TASKPRLG,L'TSKNAME                                  01400000
         BNZ   TSK_INIT           TRACE EVENT NOT ACTIVE                01410000
         MVC   0(L'TSKNAME,R1),TSKNAME                                  01420000
                                                                        01430000
*---------------------------------------------------------------        01440000
* Continue ITASK initialization.                                        01450000
*---------------------------------------------------------------        01460000
TSK_INIT DS    0H                                                       01470000
         TCBTOKEN TYPE=CURRENT,TTOKEN=TSKTTOKN,MF=(E,MFE_LIST)          01480000
                                                                        01490000
         L     R1,PSATOLD         CURRENT TCB ADDRESS            159456 01500000
         USING TCB,R1             TEMP ADDRESSABILITY            159456 01510000
         ST    R1,TSKTCB@         SET ITASK ASSOC TCB ADDR       159456 01520000
                                                                        01530000
         TM    TSKFLGS3,TSK3$AFF  TCB AFFINITY                   159456 01540000
         BZ    TSK_NAFF           NO, CONTINUE                   159456 01550000
         MVC   TSKPRTY,TCBDSP     COPY DISPATCH PRIORITY FROM TCB214761 01560000
TSK_NAFF DS    0H                                                159456 01570000
         DROP  R1                                                159456 01580000
                                                                        01590000
         MVC   TSKSAVE@,4(R13)    COPY CALLER'S SAVE AREA ADDR          01600000
                                                                        01610000
         TM    ITPFLGS,ITP$SYNC   TASK SYNC REQUIRED                    01620000
         BZ    *+8                NO, CONTINUE                          01630000
         OI    TSKFLGS,TSK$SYNC   SET SYNC REQUIRED FLAG                01640000
                                                                        01650000
         LR    R1,R10             WORKUNIT ADDRESS                      01660000
         @CALL ISASINIT,CTYPE=CVT  BUILD SAS/C ENVIRONMENT              01670000
                                                                        01680000
         EJECT ,                                                        01690000
*---------------------------------------------------------------        01700000
* Establish recovery environment for task created with TCBAFF=YES       01710000
*---------------------------------------------------------------        01720000
         TM    TSKFLGS3,TSK3$AFF  TCB AFFINITY                   159456 01730000
         BZ    PRLG_EVN           NO, SERVER TASK ISSUED SERVICE 159456 01740000
                                                                        01750000
         LSEXPAND NORMAL=256                                            01760000
                                                                        01770000
         TM    ICTSTAT2,ICT2$RCV  RECOVERY ENABLED                      01780000
         BZ    PRLG_EVN           NO, CONTINUE                          01790000
                                                                        01800000
         L     R2,#RCVESTA        ADDR OF TASK ESTAE EXIT               01810000
         MVC   ESTAELST($ESTAELN),$ESTAEL                               01820000
                                                                        01830000
         ESTAEX (R2),CT,TERM=YES, ESTABLISH RECOVERY ENV               +01840000
               MF=(E,ESTAELST)                                          01850000
                                                                        01860000
         OI    FLAGS,$ESTAE       RECOVERY ENVIRONMENT ESTAB            01870000
                                                                        01880000
         EJECT ,                                                        01890000
*---------------------------------------------------------------        01900000
* Initialize events table                                               01910000
*---------------------------------------------------------------        01920000
PRLG_EVN DS    0H                                                       01930000
         $TASK EVINIT,            INITIALIZE TASK EVENTS TABLE         +01940000
               MF=(E,TSKT_MFL)                                          01950000
         BNZ   ERR_EVIN           EVENTS INITIALIZATION ERROR           01960000
                                                                        01970000
         EJECT ,                                                        01980000
*---------------------------------------------------------------        01990000
* Create Main process                                                   02000000
*---------------------------------------------------------------        02010000
         $PROC CREATE,            CREATE INITIAL PROCESS               +02020000
               NAME='$MAIN$',                                          +02030000
               EP=*ITPRTN@,                                            +02040000
               PARM=*ITPPARM,                                          +02050000
               STGSIZE=*=A(1*1024),                                    +02060000
               DPRTY=1,                                                +02070000
               MF=(E,TSKP_MFL)                                          02080000
         BNZ   ERR_CREA           CREATE FAILED                         02090000
                                                                        02100000
         ST    R1,TSKPCB$M        SAVE $$MAIN$$ PCB ADDRESS             02110000
                                                                        02120000
         EJECT ,                                                        02130000
*---------------------------------------------------------------        02140000
* Initialize Stop/Cancel Event                                          02150000
*---------------------------------------------------------------        02160000
PRLG_EPB DS    0H                                                159456 02170000
         $TASK SETEPB,            INITIALIZE STOP EPB                  +02180000
               EPB=TSKZEPB,                                            +02190000
               ECODE=EC$STOP,                                          +02200000
               PCB=*TSKPCB$M,                                          +02210000
               RTN=*#TSKTSTP,                                          +02220000
               PARM=0,                                                 +02230000
               MF=(E,TSKT_MFL)                                          02240000
                                                                        02250000
         EJECT ,                                                        02260000
*---------------------------------------------------------------        02270000
* Initialize Dispatch EPB                                               02280000
*---------------------------------------------------------------        02290000
         $TASK SETEPB,            INITIALIZE DISPATCH EPB              +02300000
               EPB=TSKDEPB,                                            +02310000
               ECODE=EC$EVNT,                                          +02320000
               PCB=*TSKPCB$M,                                          +02330000
               RTN=*#TSKCDSP,                                          +02340000
               PARM=0,                                                 +02350000
               MF=(E,TSKT_MFL)                                          02360000
                                                                        02370000
         EJECT ,                                                        02380000
*---------------------------------------------------------------        02390000
* If parent ITASK has been stopped or cancelled since this              02400000
* ITASK was scheduled, then mark the ITASK as terminating               02410000
* but allow processing to continue normally.                            02420000
*---------------------------------------------------------------        02430000
PRLG_STP DS    0H                                                159456 02440000
         ICM   R1,15,TSKOWNR      ADDRESS OF PARENT ITASK               02450000
         BZ    PRLG_DSP           NO PARENT, DISPATCH $MAIN      159456 02460000
P        USING ITASK,R1           ESTABLISH ADDRESSABILITY              02470000
                                                                        02480000
         TM    P.TSKFLGS,TSK$STOP PARENT TASK STOPPED                   02490000
         BZ    *+8                NO, CONTINUE                          02500000
         OI    TSKFLGS,TSK$STOP   NOTIFY CURRENT TASK OF STOP           02510000
                                                                        02520000
         TM    P.TSKFLGS,TSK$CNCL PARENT TASK CANCEL                    02530000
         BZ    *+8                NO, CONTINUE                          02540000
         OI    TSKFLGS,TSK$CNCL   NOTIFY CURRENT TASK OF CANCEL         02550000
                                                                        02560000
         EJECT ,                                                        02570000
*---------------------------------------------------------------        02580000
* Pass control to task manager dispatcher.  If this is a                02590000
* standard task create,  the $MAIN process will be dispatched.          02600000
* For server tasks,  the task will be wait for TCBAFF=NO                02610000
* tasks to be attached to it.                                           02620000
*---------------------------------------------------------------        02630000
PRLG_DSP DS    0H                                                159456 02640000
         LR    R1,R13             SAVE AREA ADDRESS                     02650000
         LA    R0,WORKLEN         WORKAREA LENGTH                       02660000
         STORAGE RELEASE,ADDR=(R1),LENGTH=(R0)                          02670000
                                                                        02680000
         LA    R13,TSKDSPSA       SAVE AREA ADDRESS                     02690000
         $TASK CALLDSP,           DISPATCH PROCESS AND GIVE UP         +02700000
               MF=(E,TSKT_MFL)    CONTROL                               02710000
                                                                        02720000
         EJECT ,                                                        02730000
****************************************************************        02740000
*                                                                       02750000
*   ERROR EXIT                                                          02760000
*                                                                       02770000
****************************************************************        02780000
                                                                        02790000
ERR_EVIN DS    0H                                                       02800000
         LA    R0,RSN04           EVENTS INITIALIZATION ERROR           02810000
         B     RET_RC24           TASK PROLOG FAILED                    02820000
                                                                        02830000
ERR_SEPB DS    0H                                                       02840000
         LA    R0,RSN08           SETEPB FAILED                         02850000
         B     RET_RC24           TASK PROLOG FAILED                    02860000
                                                                        02870000
ERR_CREA DS    0H                                                       02880000
         LA    R0,RSN12           $PROC CREATE FAILED                   02890000
         B     RET_RC24           TASK PROLOG FAILED                    02900000
                                                                        02910000
         EJECT ,                                                        02920000
****************************************************************        02930000
*                                                                       02940000
*   RETURN                                                              02950000
*                                                                       02960000
****************************************************************        02970000
                                                                        02980000
RET_RC24 DS    0H                                                       02990000
         LA    R15,RC24           TASK PROLOG FAILURE                   03000000
         B     RET                                                      03010000
                                                                        03020000
RET      DS    0H                                                       03030000
         BAS   R14,CLEANUP        RELEASE HELD RESOURCES                03040000
                                                                        03050000
         LR    R3,R0              SAVE REASON CODE                      03060000
         LR    R4,R15             SAVE RETURN CODE                      03070000
         LA    R0,WORKLEN         LENGTH  OF WORKAREA                   03080000
         LR    R1,R13             ADDRESS OF WORKAREA                   03090000
         L     R13,4(,R13)        ADDRESS OF CALLER'S SAVEAREA          03100000
                                                                        03110000
         STORAGE RELEASE,LENGTH=(R0),ADDR=(R1)                          03120000
                                                                        03130000
         LR    R0,R3              RESTORE REASON CODE                   03140000
         LR    R15,R4             RESTORE RETURN CODE                   03150000
                                                                        03160000
         #EXIT R1=NO              RETURN                                03170000
                                                                        03180000
         EJECT ,                                                        03190000
****************************************************************        03200000
*                                                                       03210000
* ROUTINE: CLEANUP - RELEASE HELD RESOURCES                             03220000
*                                                                       03230000
* ON ENTRY: N/A                                                         03240000
*                                                                       03250000
* ON EXIT:  N/A                                                         03260000
*                                                                       03270000
****************************************************************        03280000
CLEANUP  DS    0H                                                       03290000
         STM   R0,R15,REGSAVE     SAVE CALLER'S REGISTERS               03300000
                                                                        03310000
*---------------------------------------------------------------        03320000
* IF CREATING TASK IS WAITING ON SYNC EPB, THEN POST COMPLETION         03330000
*---------------------------------------------------------------        03340000
CLN_SYNC DS    0H                                                       03350000
         TM    TSKFLGS,TSK$SYNC   SYNC EPB NEED POSTED                  03360000
         BZ    CLN_ESTA           RETURN                                03370000
         NI    TSKFLGS,FF-TSK$SYNC RESET SYNC FLAG                      03380000
                                                                        03390000
         LR    R3,R15             COMPLETION CODE                       03400000
                                                                        03410000
         $TASK POST,              POST SYNC CODE                       +03420000
               EPB=*TSKSEPB@,                                          +03430000
               PCODE=(R3),                                             +03440000
               MF=(E,TSKT_MFL)                                          03450000
                                                                        03460000
*---------------------------------------------------------------        03470000
*  DELETE ESTAE                                                         03480000
*---------------------------------------------------------------        03490000
CLN_ESTA DS    0H                                                       03500000
         TM    FLAGS,$ESTAE       RECOVERY ENV ESTABLISH                03510000
         BZ    CLN_EXIT           NO EXIT                               03520000
         ESTAEX 0                 DELETE RECOVERY ENVIRONMENT           03530000
                                                                        03540000
CLN_EXIT DS    0H                                                       03550000
         LM    R0,R15,REGSAVE     RESTORE CALLER'S REGISTERS            03560000
         BR    R14                RETURN                                03570000
                                                                        03580000
         EJECT ,                                                        03590000
****************************************************************        03600000
*                                                                       03610000
*  CONSTANTS AND LITERALS                                               03620000
*                                                                       03630000
****************************************************************        03640000
$ESTAEL  ESTAEX *-*,CT,MF=L       ESTAE PLIST                           03650000
$ESTAELN EQU   *-$ESTAEL                                                03660000
                                                                        03670000
         LTORG ,                                                        03680000
                                                                        03690000
         PRINT NOGEN                                                    03700000
         ICVT  ,                                                        03710000
         ITASK ,                                                        03720000
         SERVERX ,                                                      03730000
                                                                        03740000
         IHAPSA ,                                                       03750000
         CVT   DSECT=YES,LIST=NO                                        03760000
         IKJTCB ,                                                       03770000
         PRINT GEN                                                      03780000
                                                                        03790000
         END   ,                                                        03800000

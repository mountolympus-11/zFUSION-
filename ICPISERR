ICPISERR TITLE 'INTEGRATOR - CPIC CMSERR API - SEND ERROR'              00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: ICPISERR - CPIC CMSERR API                                   00100000
*                                                                       00110000
* DESCRIPTION:                                                          00120000
*                                                                       00130000
*    THIS ROUTINE IS CALLED TO PROCESS THE CMSERR VERB.                 00140000
*                                                                       00150000
* ON ENTRY:                                                             00160000
*                                                                       00170000
*    R15 = ENTRY POINT ADDRESS                                          00180000
*    R14 = RETURN      ADDRESS                                          00190000
*    R13 = SAVE AREA   ADDRESS                                          00200000
*    R01 = PARM LIST   ADDRESS                                          00210000
*                                                                       00220000
*          +00 = ADDRESS OF CONVERSATION_ID                             00230000
*          +04 = ADDRESS OF REQUEST_TO_SEND_RECEIVED RETURN AREA        00240000
*          +08 = ADDRESS OF RETURN_CODE RETURN AREA                     00250000
*                                                                       00260000
* ON EXIT:                                                              00270000
*                                                                       00280000
*    R15 = 0                                                            00290000
*                                                                       00300000
*    RETURN_CODE = CM_OK                      --> CMSERR SUCCESSFUL     00310000
*                = CM_PROGRAM_PARAMETER_CHECK --> INVALID CONV_ID, ETC. 00320000
*                = CM_PROGRAM_STATE_CHECK     --> INVALID STATE         00330000
*                = CM_PRODUCT_SPECIFIC_ERROR  --> BAD PARM              00340000
*                = CM_RESOURCE_FAILURE_NO_RETRY > SESSION FAILURE       00350000
*                = CM_OPERATION_NOT_ACCEPTED  --> N/A                   00360000
*                                                                       00370000
**<DOC-OFF>************************************************************ 00380000
         EJECT ,                                                        00390000
*********************************************************************** 00400000
*                                                                       00410000
* MAINTENANCE:                                                          00420000
*                                                                       00430000
*   07/01/94 RANDY WITEK                                                00440000
*                                                                       00450000
*********************************************************************** 00460000
                                                                        00470000
         EQUS  ,                  GENERAL EQUATES                       00480000
                                                                        00490000
RICVT    EQU   R11                                                      00500000
RITASK   EQU   R10                                                      00510000
RBASE    EQU   R9                                                       00520000
RIVTAM   EQU   R8                                                       00530000
RCMLIST  EQU   R7                                                       00540000
RTKB     EQU   R6                                                       00550000
RRCB     EQU   R5                                                       00560000
RISESS   EQU   R4                                                       00570000
                                                                        00580000
         USING DSA,R13            ESTABLISH ADDRESSABILITY              00590000
         USING CRAB,R12           ESTABLISH ADDRESSABILITY              00600000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00610000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00620000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00630000
         USING CMLIST,RCMLIST     ESTABLISH ADDRESSABILITY              00640000
         USING TKB,RTKB           ESTABLISH ADDRESSABILITY              00650000
         USING RCB,RRCB           ESTABLISH ADDRESSABILITY              00660000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00670000
                                                                        00680000
         COPY  CRAB               "C" RUNTIME ANCHOR BLOCK              00690000
         COPY  DSA                DYNAMIC SAVE AREA                     00700000
WORKAREA DS    0H                 READ/WRITE WORKAREA                   00710000
WRK256   DS    XL256              GENERAL WORKAREA                      00720000
$SESSMFL $SESS MF=L               PLIST CONSTRUCTION                    00730000
$TASKMFL $TASK MF=L               PLIST CONSTRUCTION                    00740000
L62MFL   L62DLRC MF=L             PLIST CONSTRUCTION                    00750000
L62RETCD DS    F                  RETURN CODE AREA                      00760000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00770000
SUB1SAVE DS    18F                SUBROUTINE SAVE AREA                  00780000
SAVEEPB  DS    A                  XEPB ADDRESS                          00790000
CONVID   DS    XL8                TEMPORARY CONVERSATION ID AREA        00800000
RETCODE  DS    F                  TEMPORARY RETURN_CODE     AREA        00810000
RETRTSR  DS    F                  TEMPORARY RTS_RECEIVED    AREA        00820000
CONVS    DS    F                  TEMPORARY CONV STATE      AREA        00830000
TRUNC#   DS    F                  OFFSET OF LOG. REC. IF TRUNCATED      00840000
                                                                        00850000
FM7LEN   DS    X                                                        00860000
FM7TYPE  DS    X                                                        00870000
FM7SENSE DS    XL4                                                      00880000
FM7FLAGS DS    X                                                        00890000
FM7      EQU   FM7LEN,*-FM7LEN                                          00900000
                                                                        00910000
FLAG     DS    X                                                        00920000
FLAGIERR EQU   X'80'                                                    00930000
FLAGLOCK EQU   X'40'                                                    00940000
FLAGLCKD EQU   X'20'                                                    00950000
FLAGFREE EQU   X'10'                                                    00960000
WORKLEN  EQU   *-WORKAREA         LENGTH OF USER DSA AREA               00970000
DSALEN   EQU   *-DSA              LENGTH OF DSA                         00980000
                                                                        00990000
         $MSGDFT PREFIX=ICTPID,                                        +01000000
               COMPID='CPI',                                           +01010000
               TABLE=*#MSGS,                                           +01020000
               WORKA=0,                                                +01030000
               MF=(E,WRK256),                                          +01040000
               PRINT=NOGEN                                              01050000
                                                                        01060000
ICPSERR@ CSECT ,                                                        01070000
ICPISERR CENTRY DSA=DSALEN,BASE=RBASE,INDEP=YES                         01080000
                                                                        01090000
*---------------------------------------------------------------------- 01100000
* ENTRY                                                                 01110000
*---------------------------------------------------------------------- 01120000
                                                                        01130000
         LR    RCMLIST,R1         SAVE ADDRESS OF PLIST                 01140000
                                                                        01150000
         LA    R0,WORKAREA        ADDRESS OF USER DSA SECTION           01160000
         LA    R1,WORKLEN         LENGTH  OF USER DSA SECTION           01170000
         SR    R15,R15            PREPARE FOR CLEAR                     01180000
         MVCL  R0,R14             CLEAR USER DSA SECTION                01190000
                                                                        01200000
*---------------------------------------------------------------------- 01210000
* INITIALIZATION                                                        01220000
*---------------------------------------------------------------------- 01230000
                                                                        01240000
         @RESTENV ,               ENSURE ENVIRONMENT                    01250000
                                                                        01260000
         L     RIVTAM,ICTVTCVT    ESTABLISH IVTAMCVT POINTER            01270000
                                                                        01280000
         MVC   CONVID,=XL8'55AA55AA55AA55AA'                            01290000
         MVC   CONVS,=XL4'55AA55AA'                                     01300000
                                                                        01310000
         L     R1,CMLPARM3        ADDRESS OF RETURN_CODE AREA           01320000
         MVC   0(4,R1),0(R1)      TEST MOVEMENT                         01330000
                                                                        01340000
         ICM   R1,15,CMLPARM1     ADDRESS OF CONVERSATION ID            01350000
         BNP   INITERR            BRANCH IF BAD                         01360000
         MVC   CONVID,0(R1)       COPY CONVID                           01370000
                                                                        01380000
         ICM   R1,15,CMLPARM2     ADDRESS OF RTS_RECEIVED RETURN AREA   01390000
         BNP   INITERR            BRANCH IF BAD                         01400000
         MVC   0(4,R1),0(R1)      TEST MOVEMENT                         01410000
                                                                        01420000
         B     INITEND                                                  01430000
                                                                        01440000
INITERR  DS    0H                                                       01450000
                                                                        01460000
         OI    FLAG,FLAGIERR      REMEMBER ERROR DETECTED               01470000
                                                                        01480000
INITEND  DS    0H                                                       01490000
                                                                        01500000
*---------------------------------------------------------------------- 01510000
* ENTRY TRACE                                                           01520000
*---------------------------------------------------------------------- 01530000
                                                                        01540000
         $TRACE *=A(TRC_CPIC_ICPISERR),48 TRACE ENTRY W/ 48 USER BYTES  01550000
         BNZ   NOETRACE                   BRANCH IF NOT TRACING         01560000
         $APITRC ICPISERR                 TRACE COMMON STUFF            01570000
         ST    RCMLIST,24(,R1)            TRACE PARMLIST ADDRESS        01580000
         MVC   32(8,R1),CONVID            TRACE CONVERSATION ID         01590000
NOETRACE DS    0H                                                       01600000
                                                                        01610000
*---------------------------------------------------------------------- 01620000
* LOCATE SPECIFIED CONVERSATION                                         01630000
*---------------------------------------------------------------------- 01640000
                                                                        01650000
         TM    FLAG,FLAGIERR             ERROR DETECTED ALREADY?        01660000
         BO    ERRPROD                   BRANCH IF YES                  01670000
                                                                        01680000
         LA    R1,CONVID                 ADDRESS OF CONVERSATION ID     01690000
         L     R15,ICP@LOC               ENTRY POINT OF TKB/RCB LOCATE  01700000
         BASR  R14,R15                   LOCATE THE TKB/RCB             01710000
         LTR   RTKB,R1                   TKB ADDRESS                    01720000
         BNP   ERRPARM                   BRANCH IF BAD                  01730000
         LTR   RRCB,R0                   RCB ADDRESS                    01740000
         BNP   ERRPARM                   BRANCH IF BAD                  01750000
                                                                        01760000
         MVC   CONVS,RCBCONVS            COPY CONV STATE                01770000
                                                                        01780000
*---------------------------------------------------------------------- 01790000
* STATE CHECK                                                           01800000
*---------------------------------------------------------------------- 01810000
                                                                        01820000
         CLC   CONVS,=A(CM_INITIALIZE_STATE)                            01830000
         BE    ERRSTATE                                                 01840000
         CLC   CONVS,=A(CM_DEFER_RECEIVE_STATE)                         01850000
         BE    ERRSTATE                                                 01860000
         CLC   CONVS,=A(CM_DEFER_DEALLOCATE_STATE)                      01870000
         BE    ERRSTATE                                                 01880000
                                                                        01890000
*---------------------------------------------------------------------- 01900000
* GET INTO SEND STATE                                                   01910000
*---------------------------------------------------------------------- 01920000
                                                                        01930000
*                                                                       01940000
* RESERVE THE SESSION                                                   01950000
*---------------------------------------------------------------------- 01960000
                                                                        01970000
         BAS   R14,VTAMLOCK                                             01980000
                                                                        01990000
         $SESS $SESS_FIND_SESSION,                                     +02000000
               SESSION=RCBHSID,                                        +02010000
               ERRET=ERRRFNR,                                          +02020000
               MF=(E,$SESSMFL)    LOCATE ASSOCIATED ISESS, IF ANY       02030000
                                                                        02040000
X        USING SPLIST,$SESSMFL                                          02050000
         L     RISESS,X.SPLAREA   ADDRESS OF ASSOCIATED ISESS BLOCK     02060000
         DROP  X                                                        02070000
                                                                        02080000
         TM    ISEF1,ISEF1TRM     SESS TERM STARTED?                    02090000
         BO    ERRRFNR            BRANCH IF YES                         02100000
         TM    ISE62FL2,ISE62DRD  IS DRIVER DOWN?                       02110000
         BO    ERRRFNR            BRANCH IF YES                         02120000
                                                                        02130000
*                                                                       02140000
* SEND A NEGATIVE RESPONSE AND WAIT FOR DIRECTION                       02150000
*---------------------------------------------------------------------- 02160000
                                                                        02170000
         BAS   R14,SERR                                                 02180000
         LTR   R15,R15            DO WE HAVE DIRECTION?                 02190000
         BZ    UPSTATE            BRANCH IF YES                         02200000
         C     R15,=A(CM_DEALLOCATED_NORMAL)                            02210000
         BNE   ERRRFNR            BRANCH IF UNEXPECTED RC               02220000
         ST    R15,RETCODE        PASS THIS TO THE USER                 02230000
         B     DEALLOCN           AND RELEASE THE SESSION               02240000
                                                                        02250000
*                                                                       02260000
* UPDATE THE CONVERSATION STATE                                         02270000
*---------------------------------------------------------------------- 02280000
                                                                        02290000
UPSTATE  DS    0H                                                       02300000
                                                                        02310000
         MVC   RCBCONVS,=A(CM_SEND_STATE)                               02320000
                                                                        02330000
*---------------------------------------------------------------------- 02340000
* FLUSH THE SEND BUFFER                                                 02350000
*---------------------------------------------------------------------- 02360000
                                                                        02370000
*                                                                       02380000
* RESERVE THE SESSION                                                   02390000
*---------------------------------------------------------------------- 02400000
                                                                        02410000
         BAS   R14,VTAMLOCK                                             02420000
                                                                        02430000
         $SESS $SESS_FIND_SESSION,                                     +02440000
               SESSION=RCBHSID,                                        +02450000
               ERRET=ERRRFNR,                                          +02460000
               MF=(E,$SESSMFL)    LOCATE ASSOCIATED ISESS, IF ANY       02470000
                                                                        02480000
X        USING SPLIST,$SESSMFL                                          02490000
         L     RISESS,X.SPLAREA   ADDRESS OF ASSOCIATED ISESS BLOCK     02500000
         DROP  X                                                        02510000
                                                                        02520000
         TM    ISEF1,ISEF1TRM     SESS TERM STARTED?                    02530000
         BO    ERRRFNR            BRANCH IF YES                         02540000
         TM    ISE62FL2,ISE62DRD  IS DRIVER DOWN?                       02550000
         BO    ERRRFNR            BRANCH IF YES                         02560000
                                                                        02570000
*                                                                       02580000
* LOCATE THE SBUF                                                       02590000
*---------------------------------------------------------------------- 02600000
                                                                        02610000
         ST    RISESS,SUB0SAVE    MAKE A PLIST                          02620000
         LA    R1,SUB0SAVE        PASS ADDRESS OF PLIST                 02630000
         L     R15,ICP@SBUF       CALL THE SBUF SERVICE                 02640000
         BASR  R14,R15            LINK TO SERVICE                       02650000
                                                                        02660000
*                                                                       02670000
* REMEMBER IF THERE IS AN INCOMPLETE LOGICAL RECORD                     02680000
*---------------------------------------------------------------------- 02690000
                                                                        02700000
         MVC   TRUNC#,RCBSLLRM    REMAINDER OF CURRENT LOG. REC.        02710000
                                                                        02720000
*                                                                       02730000
* IF THERE IS NO DATA IN THE SEND BUFFER THERE IS NOTHING TO FLUSH      02740000
*---------------------------------------------------------------------- 02750000
                                                                        02760000
         L     R3,ISE62SBF        SBUF CONTROL AREA                     02770000
X        USING SBFLIST,R3                                               02780000
         OC    X.SBFBUFO,X.SBFBUFO ANY DATA?                            02790000
         DROP  X                                                        02800000
         BZ    SENDFMH7           BRANCH IF NOT                         02810000
                                                                        02820000
*                                                                       02830000
* FLUSH THE CURRENT SEND BUFFER IF THERE IS SEND DATA.                  02840000
* COMPLETE THE RH, SEND IT, & WAIT FOR SEND TO COMPLETE.                02850000
*---------------------------------------------------------------------- 02860000
                                                                        02870000
         CLI   ISE62FSC,ISE62FSC_BETC ARE WE IN-CHAIN?                  02880000
         BNE   FLSHNOBC               BRANCH IF YES                     02890000
         OI    ISE62RH0,RHBCI         SET BEGIN CHAIN                   02900000
                                                                        02910000
         CLI   ISE62FBR,ISE62FBR_BETB ARE WE IN-BRACKETS?               02920000
         BNE   FLSHNOBC               BRANCH IF YES                     02930000
         OI    ISE62RH2,RHBBI         SET BEGIN BRACKET                 02940000
                                                                        02950000
FLSHNOBC DS    0H                                                       02960000
                                                                        02970000
         OI    ISE62RH1,RHDR1+RHERI ASK FOR ER1                         02980000
         NI    ISE62RH1,255-RHDR2   ASK FOR ER1                         02990000
                                                                        03000000
         BAS   R14,SHIPIT          SEND OUT THE DATA                    03010000
         LTR   R15,R15             WAS SHIP SUCCESSFUL?                 03020000
         BNZ   ERRRFNR             BRANCH IF NOT                        03030000
                                                                        03040000
*---------------------------------------------------------------------- 03050000
* BUILD AND SEND THE FMH7                                               03060000
*---------------------------------------------------------------------- 03070000
                                                                        03080000
*                                                                       03090000
* RESERVE THE SESSION                                                   03100000
*---------------------------------------------------------------------- 03110000
                                                                        03120000
         BAS   R14,VTAMLOCK                                             03130000
                                                                        03140000
         $SESS $SESS_FIND_SESSION,                                     +03150000
               SESSION=RCBHSID,                                        +03160000
               ERRET=ERRRFNR,                                          +03170000
               MF=(E,$SESSMFL)    LOCATE ASSOCIATED ISESS, IF ANY       03180000
                                                                        03190000
X        USING SPLIST,$SESSMFL                                          03200000
         L     RISESS,X.SPLAREA   ADDRESS OF ASSOCIATED ISESS BLOCK     03210000
         DROP  X                                                        03220000
                                                                        03230000
         TM    ISEF1,ISEF1TRM     SESS TERM STARTED?                    03240000
         BO    ERRRFNR            BRANCH IF YES                         03250000
         TM    ISE62FL2,ISE62DRD  IS DRIVER DOWN?                       03260000
         BO    ERRRFNR            BRANCH IF YES                         03270000
                                                                        03280000
*                                                                       03290000
* BUILD AN FMH-7 AND SEND IT.                                           03300000
*---------------------------------------------------------------------- 03310000
                                                                        03320000
SENDFMH7 DS    0H                                                       03330000
                                                                        03340000
         CLI   ISE62FSC,ISE62FSC_BETC  ARE WE IN-CHAIN?                 03350000
         BNE   FMH7NOBC                BRANCH IF YES                    03360000
         OI    ISE62RH0,RHBCI          SET BEGIN CHAIN                  03370000
                                                                        03380000
         CLI   ISE62FBR,ISE62FBR_BETB  ARE WE IN-BRACKETS?              03390000
         BNE   FMH7NOBC                BRANCH IF YES                    03400000
         OI    ISE62RH2,RHBBI          SET BEGIN BRACKET                03410000
                                                                        03420000
FMH7NOBC DS    0H                                                       03430000
                                                                        03440000
         OI    ISE62RH1,RHDR1+RHERI    ASK FOR ER1                      03450000
         NI    ISE62RH1,255-RHDR2      ASK FOR ER1                      03460000
         OI    ISE62RH0,RHFI           INCLUDES AN FMH                  03470000
                                                                        03480000
         MVI   FM7LEN,7                FMH7 IS SEVEN BYTES              03490000
         MVI   FM7TYPE,7               FMH7 TYPE IS '7'                 03500000
         MVC   FM7SENSE,=XL4'08890000' PROGRAM_ERROR_PURGING/NO_TRUNC   03510000
         MVI   FM7FLAGS,0     ???????? NO ERROR LOG SUPPORT YET ??????  03520000
         OC    TRUNC#,TRUNC#           DID WE TRUNCATE?                 03530000
         BZ    FMH7SHIP                BRANCH IF NOT                    03540000
         MVI   FM7SENSE+3,X'01'        PROGRAM_ERROR_TRUNC              03550000
                                                                        03560000
FMH7SHIP DS    0H                                                       03570000
                                                                        03580000
         SBUF  PACK,                                                   +03590000
               AREA=FM7,                                               +03600000
               AREALEN=7,                                              +03610000
               MF=(E,*ISE62SBF)        PLACE FMH7 IN SEND BUFFER        03620000
         BZ    *+12                    BRANCH IF PACK SUCCESSFUL        03630000
         BAS   R14,SBUFBUMP            GET A LARGER SBUF                03640000
         B     FMH7SHIP                AND PACK IT AGAIN                03650000
                                                                        03660000
         BAS   R14,SHIPIT              SEND OUT THE DATA                03670000
         LTR   R15,R15                 WAS SHIP SUCCESSFUL?             03680000
         BNZ   ERRRFNR                 BRANCH IF NOT                    03690000
                                                                        03700000
*---------------------------------------------------------------------- 03710000
* COMPLETE THE REQUEST                                                  03720000
*---------------------------------------------------------------------- 03730000
                                                                        03740000
*                                                                       03750000
* RESERVE THE SESSION                                                   03760000
*---------------------------------------------------------------------- 03770000
                                                                        03780000
         BAS   R14,VTAMLOCK                                             03790000
                                                                        03800000
         $SESS $SESS_FIND_SESSION,                                     +03810000
               SESSION=RCBHSID,                                        +03820000
               ERRET=ERRRFNR,                                          +03830000
               MF=(E,$SESSMFL)    LOCATE ASSOCIATED ISESS, IF ANY       03840000
                                                                        03850000
X        USING SPLIST,$SESSMFL                                          03860000
         L     RISESS,X.SPLAREA   ADDRESS OF ASSOCIATED ISESS BLOCK     03870000
         DROP  X                                                        03880000
                                                                        03890000
         TM    ISEF1,ISEF1TRM     SESS TERM STARTED?                    03900000
         BO    ERRRFNR            BRANCH IF YES                         03910000
         TM    ISE62FL2,ISE62DRD  IS DRIVER DOWN?                       03920000
         BO    ERRRFNR            BRANCH IF YES                         03930000
                                                                        03940000
*                                                                       03950000
* COMPLETE THE REQUEST-TO-SEND-RECEIVED VARIABLE                        03960000
*---------------------------------------------------------------------- 03970000
                                                                        03980000
         MVC   RETRTSR,=A(CM_REQUEST_TO_SEND_NOT_RECEIVED)              03990000
         TM    ISE62FL1,ISE62SIG     WAS A SIGNAL RECEIVED?             04000000
         BNO   RETURN                ALL DONE IF NOT                    04010000
         NI    ISE62FL1,255-ISE62SIG CLEAR THE FLAG                     04020000
         MVC   RETRTSR,=A(CM_REQUEST_TO_SEND_RECEIVED)                  04030000
         B     RETURN                ALL DONE                           04040000
                                                                        04050000
*---------------------------------------------------------------------- 04060000
* EXCEPTION ROUTINES                                                    04070000
*---------------------------------------------------------------------- 04080000
                                                                        04090000
ERRPROD  DS    0H                                                       04100000
                                                                        04110000
         MVC   RETCODE,=A(CM_PRODUCT_SPECIFIC_ERROR)                    04120000
         B     RETURN                                                   04130000
                                                                        04140000
ERRSTATE DS    0H                                                       04150000
                                                                        04160000
         MVC   RETCODE,=A(CM_PROGRAM_STATE_CHECK)                       04170000
         B     RETURN                                                   04180000
                                                                        04190000
ERRPARM  DS    0H                                                       04200000
                                                                        04210000
         MVC   RETCODE,=A(CM_PROGRAM_PARAMETER_CHECK)                   04220000
         B     RETURN                                                   04230000
                                                                        04240000
ERRRFNR  DS    0H                                                       04250000
                                                                        04260000
         MVC   RETCODE,=A(CM_RESOURCE_FAILURE_NO_RETRY)                 04270000
                                                                        04280000
DEALLOCN DS    0H                                                       04290000
                                                                        04300000
         MVC   RCBCONVS,=A(CM_RESET_STATE)                              04310000
         OI    FLAG,FLAGFREE                                            04320000
         B     RETURN                                                   04330000
                                                                        04340000
*---------------------------------------------------------------------- 04350000
* EXIT TRACE AND RETURN TO CALLER                                       04360000
*---------------------------------------------------------------------- 04370000
                                                                        04380000
RETURN   DS    0H                                                       04390000
                                                                        04400000
         TM    FLAG,FLAGFREE                                            04410000
         BNO   RETURNX                                                  04420000
                                                                        04430000
         L62DLRC (RRCB),                                               +04440000
               L62RETCD,                                               +04450000
               MF=(E,L62MFL)      DELETE THE RCB                        04460000
                                                                        04470000
RETURNX  DS    0H                                                       04480000
                                                                        04490000
         BAS   R14,VTAMUNLK           RELEASE THE LOCK IF NECESSARY     04500000
                                                                        04510000
         $TRACE *=A(TRC_CPIC_EXIT),48 TRACE ENTRY                       04520000
         BNZ   NOXTRACE               BRANCH IF TRACING NOT AVAILABLE   04530000
         MVC   0(8,R1),=CL8'ICPISERR' MODULE NAME                       04540000
         MVC   8(4,R1),RETCODE        RETURN_CODE VALUE                 04550000
         MVC   12(8,R1),CONVID        CONVERSATION ID                   04560000
         MVC   20(4,R1),CONVS         CONVERSATION STATE                04570000
NOXTRACE DS    0H                                                       04580000
                                                                        04590000
         L     R1,CMLPARM2        ADDRESS OF RTS_RECEIVED AREA          04600000
         MVC   0(4,R1),RETRTSR    SET RTS_RECEIVED VARIABLE             04610000
                                                                        04620000
         L     R1,CMLPARM3        ADDRESS OF RETURN_CODE AREA           04630000
         MVC   0(4,R1),RETCODE    SET RETURN_CODE VARIABLE              04640000
                                                                        04650000
         SR    R15,R15            FUNCTION RETURN CODE = 0              04660000
         CEXIT RC=(R15),INDEP=YES RETURN                                04670000
                                                                        04680000
*---------------------------------------------------------------------- 04690000
* SUBROUTINE SBUFBUMP: INCREASE THE SIZE OF THE SBUF                    04700000
*                                                                       04710000
* ENTRY:  R1 = SBFLIST ADDRESS                                          04720000
*                                                                       04730000
* RETURN: ALL REGISTERS ARE RESTORED.                                   04740000
*---------------------------------------------------------------------- 04750000
                                                                        04760000
SBUFBUMP DS    0H                                                       04770000
                                                                        04780000
         STM   R14,R2,SUB0SAVE    SAVE REGISTERS                        04790000
         LR    R2,R1              SBFLIST ADDRESS                       04800000
                                                                        04810000
         SBUF  OBTAIN,                                                 +04820000
               OWNER=*ISEITASK,                                        +04830000
               ERRET=ERRSBUF,                                          +04840000
               MF=(E,(R2))                                              04850000
                                                                        04860000
         LM    R14,R2,SUB0SAVE    RELOAD REGISTER                       04870000
         BR    R14                RETURN                                04880000
                                                                        04890000
*---------------------------------------------------------------------- 04900000
* SUBROUTINE SERR: TRIGGER THE SESSION DRIVER TO SEND A NEGATIVE RESP.  04910000
*                  AND WAIT FOR DIRECTION.                              04920000
*                                                                       04930000
* RETURN: R15 = POST CODE FROM SERR REQUEST                             04940000
*---------------------------------------------------------------------- 04950000
                                                                        04960000
SERR     DS    0H                                                       04970000
                                                                        04980000
         STM   R14,R3,SUB1SAVE    SAVE REGISTERS                        04990000
                                                                        05000000
*                                                                       05010000
* ALLOCATE A CPIC REQUEST WORK ELEMENT                                  05020000
*---------------------------------------------------------------------- 05030000
                                                                        05040000
         $VTAMWE L'IWEY2,         SIZE                                 +05050000
               IWECSERR           CODE                                  05060000
                                                                        05070000
         LR    R3,R1              ESTABLISH ADDRESSABILITY              05080000
                                                                        05090000
*                                                                       05100000
* ALLOCATE AN XEPB                                                      05110000
*---------------------------------------------------------------------- 05120000
                                                                        05130000
         $TASK SETEPB,            INITIALIZE EPB FOR SYNCH REQUEST     +05140000
               ECODE=EC$SERR,     EVENT CODE                           +05150000
               ERRET=ERR$TASK,                                         +05160000
               MF=(E,$TASKMFL)                                          05170000
                                                                        05180000
         ST    R1,SAVEEPB         SAVE THE XEPB ADDRESS                 05190000
                                                                        05200000
*                                                                       05210000
* FILL IN THE CPIC SERR REQUEST WORK ELEMENT                            05220000
*---------------------------------------------------------------------- 05230000
                                                                        05240000
         USING IWEVTAM,R3                                               05250000
         MVC   IWEY2ENT,TKBTCBID  ENTITY TOKEN                          05260000
         MVC   IWEY2EPB,SAVEEPB   EPB ADDRESS                           05270000
         ST    RRCB,IWEY2RCB      RCB ADDRESS                           05280000
         DROP  R3                                                       05290000
                                                                        05300000
*                                                                       05310000
* QUEUE THE CPIC SERR REQUEST WORK ELEMENT TO THE SESSION QUEUE         05320000
*---------------------------------------------------------------------- 05330000
                                                                        05340000
         $VTAMQ (R3),             WORK ELEMENT                         +05350000
               ISEWEQ             QUEUE                                 05360000
                                                                        05370000
*                                                                       05380000
* RELEASE SERIALIZATION & WAIT FOR POSTING OF THE CPIC SERR REQUEST     05390000
*---------------------------------------------------------------------- 05400000
                                                                        05410000
         BAS   R14,VTAMUNLK       RELEASE LOCK                          05420000
                                                                        05430000
         $TASK WAIT,              WAIT FOR REQUEST COMPLETION          +05440000
               EPB=*SAVEEPB,      XEPB ADDRESS                         +05450000
               MF=(E,$TASKMFL)                                          05460000
                                                                        05470000
         ST    R0,SUB1SAVE+4      POST CODE (R0) IS RETURNED IN R15     05480000
         LM    R14,R3,SUB1SAVE    RELOAD REGISTER                       05490000
         BR    R14                RETURN                                05500000
                                                                        05510000
*---------------------------------------------------------------------- 05520000
* SUBROUTINE SHIPIT: TRIGGER THE SESSION DRIVER TO SEND CURRENT BUFFER  05530000
*                    AND WAIT FOR COMPLETION OF SEND.                   05540000
*                                                                       05550000
* RETURN: R15 = POST CODE FROM SHIP REQUEST                             05560000
*---------------------------------------------------------------------- 05570000
                                                                        05580000
SHIPIT   DS    0H                                                       05590000
                                                                        05600000
         STM   R14,R3,SUB1SAVE    SAVE REGISTERS                        05610000
                                                                        05620000
*                                                                       05630000
* ALLOCATE A CPIC REQUEST WORK ELEMENT                                  05640000
*---------------------------------------------------------------------- 05650000
                                                                        05660000
         $VTAMWE L'IWEXX,         SIZE                                 +05670000
               IWECSHIP           CODE                                  05680000
                                                                        05690000
         LR    R3,R1              ESTABLISH ADDRESSABILITY              05700000
                                                                        05710000
*                                                                       05720000
* ALLOCATE AN XEPB                                                      05730000
*---------------------------------------------------------------------- 05740000
                                                                        05750000
         $TASK SETEPB,            INITIALIZE EPB FOR SYNCH REQUEST     +05760000
               ECODE=EC$SHIP,     EVENT CODE                           +05770000
               ERRET=ERR$TASK,                                         +05780000
               MF=(E,$TASKMFL)                                          05790000
                                                                        05800000
         ST    R1,SAVEEPB         SAVE THE XEPB ADDRESS                 05810000
                                                                        05820000
*                                                                       05830000
* FILL IN THE CPIC SHIP REQUEST WORK ELEMENT                            05840000
*---------------------------------------------------------------------- 05850000
                                                                        05860000
         USING IWEVTAM,R3                                               05870000
         MVC   IWEXXENT,TKBTCBID  ENTITY TOKEN                          05880000
         MVC   IWEXXEPB,SAVEEPB   EPB ADDRESS                           05890000
         ST    RRCB,IWEXXRCB      RCB ADDRESS                           05900000
         DROP  R3                                                       05910000
                                                                        05920000
*                                                                       05930000
* QUEUE THE CPIC SHIP REQUEST WORK ELEMENT TO THE SESSION QUEUE         05940000
*---------------------------------------------------------------------- 05950000
                                                                        05960000
         $VTAMQ (R3),             WORK ELEMENT                         +05970000
               ISEWEQ             QUEUE                                 05980000
                                                                        05990000
*                                                                       06000000
* RELEASE SERIALIZATION & WAIT FOR POSTING OF THE CPIC SHIP REQUEST     06010000
*---------------------------------------------------------------------- 06020000
                                                                        06030000
         BAS   R14,VTAMUNLK       RELEASE LOCK                          06040000
                                                                        06050000
         $TASK WAIT,              WAIT FOR REQUEST COMPLETION          +06060000
               EPB=*SAVEEPB,      XEPB ADDRESS                         +06070000
               MF=(E,$TASKMFL)                                          06080000
                                                                        06090000
         ST    R0,SUB1SAVE+4      POST CODE (R0) IS RETURNED IN R15     06100000
         LM    R14,R3,SUB1SAVE    RELOAD REGISTER                       06110000
         BR    R14                RETURN                                06120000
                                                                        06130000
*---------------------------------------------------------------------- 06140000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 06150000
*---------------------------------------------------------------------- 06160000
                                                                        06170000
VTAMLOCK DS    0H                                                       06180000
                                                                        06190000
         TM    FLAG,FLAGLOCK        WAS THE LOCK ALREADY OBTAINED?      06200000
         BOR   R14                  RETURN IF YES                       06210000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             06220000
                                                                        06230000
         $SER  OBTAIN,                                                 +06240000
               VTAM                                                     06250000
                                                                        06260000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              06270000
         BNE   VTAMLOEX             BRANCH IF NOT                       06280000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         06290000
                                                                        06300000
VTAMLOEX DS    0H                                                       06310000
                                                                        06320000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               06330000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          06340000
         BR    R14                  RETURN                              06350000
                                                                        06360000
*---------------------------------------------------------------------- 06370000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                06380000
*---------------------------------------------------------------------- 06390000
                                                                        06400000
VTAMUNLK DS    0H                                                       06410000
                                                                        06420000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       06430000
         BNOR  R14                  BRANCH IF NOT                       06440000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             06450000
         BOR   R14                  DON'T RELEASE IF IT WAS             06460000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             06470000
                                                                        06480000
         $SER  RELEASE,                                                +06490000
               VTAM                                                     06500000
                                                                        06510000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  06520000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          06530000
         BR    R14                  RETURN                              06540000
                                                                        06550000
*---------------------------------------------------------------------- 06560000
* ERROR ROUTINES                                                        06570000
*---------------------------------------------------------------------- 06580000
                                                                        06590000
ERR$TASK DS    0H                                                       06600000
                                                                        06610000
         $ABEND ABE_VTDIAG,                                            +06620000
               SCOPE=PCB,                                              +06630000
               TITLE='$TASK FAILURE'                                    06640000
                                                                        06650000
ERRSBUF  DS    0H                                                       06660000
                                                                        06670000
         $ABEND ABE_VTDIAG,                                            +06680000
               SCOPE=PCB,                                              +06690000
               TITLE='SBUF FAILURE'                                     06700000
                                                                        06710000
*---------------------------------------------------------------------- 06720000
* LITERALS AND CONSTANTS                                                06730000
*---------------------------------------------------------------------- 06740000
                                                                        06750000
         LTORG ,                                                        06760000
                                                                        06770000
         PRINT NOGEN                                                    06780000
         ISTDBIND ,               VTAM BIND IMAGE                       06790000
         ISTRH ,                  VTAM SNA REQUEST HEADER               06800000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                06810000
         IKJTCB ,                 MVS TASK CONTROL BLOCK                06820000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         06830000
         ICVT  ,                  INTEGRATOR CVT                        06840000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   06850000
         ITASK ,                  INTEGRATOR TASK BLOCK                 06860000
         IPCB ,                   INTEGRATOR PROCESS BLOCK              06870000
         IACB ,                   INTEGRATOR VTAM ACB                   06880000
         ABCODES ,                INTEGRATOR $ABEND CODES               06890000
         EVCODES ,                INTEGRATOR EVENT CODES                06900000
         ISESS ,                  INTEGRATOR SESSION BLOCK              06910000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            06920000
         IRPL ,                   INTEGRATOR VTAM RPL                   06930000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          06940000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             06950000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             06960000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             06970000
         SBUF  DSECT=YES          INTEGRATOR SBUF  SERVICES             06980000
         END   ,                                                        06990000

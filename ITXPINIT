ITXPINIT TITLE '- ALLOCATE AND INITIALIZE TXP BUFFER'                   00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: ITXPINIT - ALLOCATE AND INITIALIZE TXP BUFFER                00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THIS ROUTINE IS USED TO ALLOCATE A RESPONSE BUFFFER                00080000
*    COMPLETE WITH THE APPROPRIATE CONTROL INFORMATION NEEDED           00090000
*    TO ROUTE A TRANSACTION RESPONSE TO A REMOTE REQUESTOR.             00100000
*    SUBSEQUENT ITXPISRT REQUESTS QUEUE INFORMATION IN THE              00110000
*    RESPONSE BUFFER WITHOUT REQUIRING BUFFER FORMAT AWARENESS          00120000
*    ON THE PART OF THE REQUESTOR.                                      00130000
*                                                                       00140000
*    NORMALLY, A SINGLE INPUT TRANSACTION PRODUCES A SINGLE             00150000
*    RESPONSE.  HOWEVER, SOME INPUT TRANSACTIONS MAY CONSTRUCT          00160000
*    A COMPOSITE RESULT BY INSERTING RESPONSES FROM SEVERAL             00170000
*    DISTINCT TRANSACTION SERVERS.  OPTIONALLY, THE BUFFER MAY          00180000
*    BE STRUCTURED TO HOUSE MULTIPLE RELATED RESPONSES BY               00190000
*    ESTABLISHING A "FUNCTION RESPONSE ARRAY" NEAR ITS ORIGIN.          00200000
*                                                                       00210000
*    THE RESPONSE BUFFER ALLOCATED IS ANCHORED IN THE IPCB              00220000
*    TO ALLOW CONVENIENT, GLOBAL ACCESS TO ALL RESPONDENTS              00230000
*    RUNNING UNDER THE PROCESS.                                         00240000
*                                                                       00250000
*                                                                       00260000
* ON ENTRY:                                                             00270000
*                                                                       00280000
*    R1  CONTAINS THE ADDR OF A PARAMETER LIST CONSTRUCTED AS           00290000
*        FOLLOWS:                                                       00300000
*                                                                       00310000
*        +00 - SIZE OF TXP BUFFER REQUIRED                              00320000
*        +04 - NUMBER OF ENTRIES IN FUNCTION ARRAY OR ZERO              00330000
*        +08 - ADDR OF STANDARD TRANSACTION REQUEST HDR                 00340000
*                                                                       00350000
*                                                                       00360000
* ON EXIT:                                                              00370000
*                                                                       00380000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES                     00390000
*                                                                       00400000
*        RC00 - TXB BUFFER ACQUIRED / INITIALIZED                       00410000
*        RC12 - REQUEST IN ERROR                                        00420000
*                                                                       00430000
**<DOC-OFF>****************************************************         00440000
                                                                        00450000
         EJECT                                                          00460000
         #WORK ,                                                        00470000
                                                                        00480000
PBUFLEN  DS    F                  LENGTH OF TXP BUFFER                  00490000
PSFCOUNT DS    F                  NUMBER OF FUNCTION ARRAY ENTRIES      00500000
PXH      DS    A                  REQUEST PARAMETER LIST COMMON HDR     00510000
                                                                        00520000
         #ENDWORK ,                                                     00530000
                                                                        00540000
         EJECT                                                          00550000
         @XH   ,                  STANDARD TRANSACTION REQUEST HEADER   00560000
                                                                        00570000
         EJECT                                                          00580000
         REQHDR ,                 TRANSMISSION DESCRIPTOR FORMAT        00590000
                                                                        00600000
         EJECT                                                          00610000
         TXPHDR ,                 TXP BUFFER / FUNCTION ARRAY FORMAT    00620000
                                                                        00630000
         EJECT                                                          00640000
         EQUS  ,                                                        00650000
                                                                        00660000
         EJECT                                                          00670000
ITXPINIT #ENTER PREG=R8                                                 00680000
                                                                        00690000
         USING ITASK,R10          STDENV                                00700000
         USING IPCB,R9                                                  00710000
                                                                        00720000
         L     R9,TSKPCBC         PROCESS MODE                          00730000
                                                                        00740000
*--------------------------------------------------------------         00750000
*   RELEASE RESIDUAL BUFFER                                             00760000
*--------------------------------------------------------------         00770000
         ICM   R0,15,PCBXPBUF     BUFFER ALREADY PRESENT?               00780000
         BZ    CLRBUFR            NO RESIDUALS                          00790000
                                                                        00800000
         @CALL ITXPFREE,CTYPE=CVT RELEASE BUFFER                        00810000
                                                                        00820000
CLRBUFR  DS    0H                                                       00830000
                                                                        00840000
*--------------------------------------------------------------         00850000
*   ACQUIRE STORAGE FOR BUFFER                                          00860000
*--------------------------------------------------------------         00870000
         LM    R5,R7,0(R8)        FETCH PASSED PARAMETERS               00880000
         ST    R5,PBUFLEN         BUFFER LENGTH REQUIRED                00890000
         ST    R6,PSFCOUNT        FUNCTION ARRAY ENTRY COUNT            00900000
         ST    R7,PXH             REQUEST PLIST COMMON HDR              00910000
                                                                        00920000
         L     R2,MINSIZE         REASONABLE DATA SIZE                  00930000
         SH    R2,OVHDTXP         LESS TXP OVERHEAD                     00940000
         SH    R2,ICTOVSTG        LESS $GETSTOR OVERHEAD                00950000
                                                                        00960000
         L     R5,PBUFLEN         SIZE OF DATA AREA REQUIRED            00970000
         CR    R5,R2              ACCEPTABLE?                           00980000
         BH    *+6                ONWARD IF SO                          00990000
         LR    R5,R2              ELSE USE ROUNDED VALUE                01000000
         LR    R2,R5              BASE REQUEST                          01010000
         AH    R2,OVHDTXP         DATA AREA PLUS TXP OVERHEAD           01020000
                                                                        01030000
         $GETSTOR (R2)            LONG TERM STORAGE                     01040000
                                                                        01050000
*--------------------------------------------------------------         01060000
*   INITIALIZE TXP PREFIX AREA                                          01070000
*--------------------------------------------------------------         01080000
         LR    R7,R1              ACQUIRED STORAGE                      01090000
         USING TXPHDR,R7          PREFIX FORMAT                         01100000
         ST    R7,PCBXPBUF        BUFFER ANCHORED IN PROCESS            01110000
         ST    R2,PCBXPBLN        BUFFER LENGTH                         01120000
         ST    R2,TXPTOTLN        SIZE OF ACQUIRED STORAGE              01130000
         ST    R2,TXPITLN         INITIAL SIZE OF ACQUIRED STORAGE      01140000
                                                                        01150000
         LA    R0,TXPIBPL#        NUMBER OF LOCAL BOUND PTR SLOTS       01160000
         ST    R0,TXPRESL#        ALL ARE AVAILABLE                     01170000
         LA    R14,TXPIBPL        LOCAL BOUND PTR LIST ORIGIN           01180000
         O     R14,=X'80000000'   NON-FREEABLE STORAGE                  01190000
         LA    R15,TXPIBPLN       LENGTH OF BOUND PTR LIST              01200000
         STM   R14,R15,TXPRELOC   INITIALIZE BOUND PTR LIST             01210000
                                                                        01220000
         LA    R5,TXPHDR+TXPHDRLN FIRST BYTE OF BULK AREA               01230000
         ST    R5,TXPXPH          XMIT AREA                             01240000
                                                                        01250000
*--------------------------------------------------------------         01260000
*   INITIALIZE REQUEST/RESPONSE HEADER                                  01270000
*--------------------------------------------------------------         01280000
         USING REQHDR,R5          REQUEST/RESPONSE HEADER               01290000
                                                                        01300000
         L     R6,PXH             FETCH PLIST PTR                       01310000
         USING @XH,R6             INBOUND TRANSACTION REQUEST HEADER    01320000
         MVI   REQHTYPE,REQHTRSP  RESPONDING                            01330000
         L     R0,@XHFUNC         FUNCTION CODE                         01340000
         STC   R0,REQHFUNC        BRIDGE OLD FORMAT                     01350000
         L     R0,@XHSFNC         SUBFUNCTION CODE                      01360000
         STC   R0,REQHSFNC        BRIDGE OLD FORMAT                     01370000
         LA    R0,TXPHDR+TXPHDRLN+REQHDRLN                              01380000
         ST    R0,TXPAVAIL        FREE STORAGE AREA                     01390000
         MVC   TXPRSESH,@XHSESH   SESSION HANDLE                        01400000
         DROP  R6                 INBOUND TRANSACTION HDR               01410000
                                                                        01420000
*--------------------------------------------------------------         01430000
*   INITIALIZE FUNCTION ARRAY IF REQUESTED                              01440000
*--------------------------------------------------------------         01450000
         ICM   R1,15,PSFCOUNT     NUMBER OF FUNCTION ARRAY ENTRIES REQ  01460000
         BZ    NOSFSEG            MULTIPLE RESPONSE PACKETS ONLY        01470000
                                                                        01480000
         OI    REQOPTNS,REQOSTAK  STACKED RESPONSE                      01490000
                                                                        01500000
         L     R2,TXPAVAIL        FREE STORAGE AREA                     01510000
         ST    R2,TXPSFORG        FUNCTION ARRAY ORIGIN                 01520000
         LA    R2,4(,R2)          ARRAY PREFIX IS USED ENTRY COUNT      01530000
         ST    R2,TXPSFNXT        NEXT AVAILABLE FUNCTION ARRAY ENTRY   01540000
         STH   R1,TXPSFLIM        ONE ENTRY REQUIRED FOR DLM            01550000
         MH    R1,=AL2(TSFHDRLN)  COMPUTE SIZE OF FUNCTION ARRAY        01560000
         LA    R0,0(R1,R2)        RECALC FREE STORAGE AREA PTR          01570000
         ST    R0,TXPAVAIL        FREE STORAGE AREA                     01580000
                                                                        01590000
         LA    R1,4(,R1)          FUNCTION ARRAY ENTRY COUNT AND        01600000
         AH    R1,REQHLEN         FUNCTION ARRAY RESIDE IN USER DATA    01610000
         STH   R1,REQHLEN         LENGTH CONSUMED BY STACK MECHANISM    01620000
                                                                        01630000
NOSFSEG  DS    0H                                                       01640000
         DROP  R5                 REQHDR                                01650000
                                                                        01660000
*--------------------------------------------------------------         01670000
*   ESTABLISH STORAGE AVAILABILITY FOR SUBSEQUENT REQUESTS              01680000
*--------------------------------------------------------------         01690000
         L     R3,TXPAVAIL        FREE STORAGE PTR                      01700000
         SR    R3,R7              TOTAL OVERHEAD CONSUMPTION            01710000
         BNP   ERR_REQ            INTOLERABLE                           01720000
                                                                        01730000
         S     R3,TXPTOTLN        COMPUTE SIZE                          01740000
         LPR   R3,R3              ... OF FREE AREA                      01750000
         ST    R3,TXPAVREM        AND RETAIN FOR INSERT REQUESTS        01760000
                                                                        01770000
*--------------------------------------------------------------         01780000
*   RETURN COMPLETION STATUS TO REQUESTOR                               01790000
*--------------------------------------------------------------         01800000
         LA    R15,RC00           NORMAL COMPLETION                     01810000
         LA    R1,TXPHDR          RETURN BLOCK PTR                      01820000
         B     STDRET             DONE                                  01830000
                                                                        01840000
ERR_REQ  DS    0H                 REQUEST INCOMPATIBLE WITH STG         01850000
         @CALL ITXPFREE,CTYPE=CVT RELEASE BUFFER                        01860000
                                                                        01870000
         LA    R15,RC12           ERROR                                 01880000
         B     STDRET                                                   01890000
                                                                        01900000
STDRET   DS    0H                                                       01910000
         #EXIT ,                  REQUEST COMPLETE                      01920000
                                                                        01930000
         EJECT                                                          01940000
***************************************************************         01950000
*                                                                       01960000
*   LOCAL READ/ONLY STORAGE AREAS                                       01970000
*                                                                       01980000
***************************************************************         01990000
MINSIZE  DC    A(1024)            MINIMUM BUFFER STORAGE SIZE           02000000
OVHDTXP  DC    AL2((TXPHDRLN+REQHDRLN+7)/8*8)                           02010000
                                                                        02020000
         LTORG ,                                                        02030000
                                                                        02040000
         PRINT NOGEN                                                    02050000
         ICVT  ,                                                        02060000
         ITASK ,                                                        02070000
         IPCB  ,                                                        02080000
         END   ,                                                        02090000

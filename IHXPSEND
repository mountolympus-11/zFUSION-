IHXPSEND TITLE 'HOST XPORT SEND SERVICE'                                00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE:  IHXPSEND - Host XPORT Send Service                          00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    The function of this macro is to send a request/response           00080000
*    data packet to the XPORT process to be delivered to the            00090000
*    specified client logical session.                                  00100000
*                                                                       00110000
*    If WAIT=YES is specified,  the $TSEND is issued with reply         00120000
*    and the current process is placed in a task wait for the           00130000
*    reply epb.  In this case the XPSEND completion status is           00140000
*    reflected to caller.                                               00150000
*                                                                       00160000
*    If STOP= or CANCEL= are coded on the $XPSEND macro,  then          00170000
*    a cancel and/or stop address are also specfied on the              00180000
*    $TASK WAIT.  Therefore a stop/cancel notification will             00190000
*    be returned to the caller.                                         00200000
*                                                                       00210000
*                                                                       00220000
* ENTRY:                                                                00230000
*                                                                       00240000
*    UPON ENTRY R1 CONTAINS THE ADDRESS OF THE PARAMETER LIST           00250000
*    MAPPED BY THE XPSENDPL DSECT.                                      00260000
*                                                                       00270000
* EXIT:                                                                 00280000
*                                                                       00290000
*    Upon Exit R15 will contain one of the following return codes:      00300000
*                                                                       00310000
*      R15 = RC00 - Normal Completion                                   00320000
*                                                                       00330000
*            RC04 - TASK STOP/CANCEL                                    00340000
*                   RSN04 - Task stop received                          00350000
*                   RSN08 - Task cancel received                        00360000
*                                                                       00370000
*                   R1 - Contains resume address                        00380000
*                                                                       00390000
*            RC08 - XPSEND failure                                      00400000
*                   R0 - Return code from XPSEND                        00410000
*                                                                       00420000
*            RC12 - Service failure                                     00430000
*                   RSN04 - Xport process not found                     00440000
*                   RSN08 - $TSEND failure                              00450000
*                                                                       00460000
**<DOC-OFF>****************************************************         00470000
                                                                        00480000
         EJECT ,                                                        00490000
***************************************************************         00500000
*                                                                       00510000
* MAINTENANCE:                                                          00520000
*                                                                       00530000
*   08/10/94  Ron Colmone         Par# 134222                           00540000
*             Initial Version                                           00550000
*                                                                       00560000
***************************************************************         00570000
                                                                        00580000
         EJECT ,                                                        00590000
         EQUS  ,                  GENERAL EQUATES                       00600000
                                                                        00610000
         EJECT ,                                                        00620000
         MSGCODES ,               INTERTASK MESSAGE CODES               00630000
                                                                        00640000
         EJECT ,                                                        00650000
         $TASK    DSECT=YES       TASK MANAGEMENT PLIST                 00660000
                                                                        00670000
         EJECT ,                                                        00680000
         $TSEND   DSECT=YES       $TSEND PLIST                          00690000
                                                                        00700000
         EJECT ,                                                        00710000
         $WULOC   DSECT=YES       WORKUNIT LOCATOR PLIST                00720000
                                                                        00730000
         EJECT ,                                                        00740000
         $XPSEND  DSECT=YES       $XPSEND PARAMETER LIST                00750000
                                                                        00760000
         EJECT ,                                                        00770000
         $MSGDFT PREFIX=ICTPID,COMPID='HXP',TABLE=*#MSGS,              +00780000
               CONID=*ICTCONID,CONNAME=ICTCONNM,                       +00790000
               MF=(E,$MSGMFL)                                           00800000
                                                                        00810000
         EJECT ,                                                        00820000
WORKAREA #WORK ,                  GENERAL WORKAREA                      00830000
                                                                        00840000
         IWUENTUD DSECT=NO        $WULOC USER DATA                      00850000
                                                                        00860000
$WUL_MFL $WULOC MF=(L,*)          $WULOC REQUEST PLIST                  00870000
$TASKMFL $TASK  MF=(L,*)          $TASK REQUEST PLIST                   00880000
$TSNDMFL $TSEND MF=(L,*)          $TSEND REQUEST PLIST                  00890000
$MSGMFL  $MSG   MF=(L,*),FIELDS=(,,,,)                                  00900000
                                                                        00910000
WORKLEN  #ENDWORK ,               WORKAREA END                          00920000
                                                                        00930000
         EJECT ,                                                        00940000
***************************************************************         00950000
*                                                                       00960000
*  XPSEND ENTRY LINKAGE                                                 00970000
*                                                                       00980000
***************************************************************         00990000
                                                                        01000000
IHXPSEND #ENTER BASE=R12,PREG=R8  ENTRY LINKAGE                         01010000
                                                                        01020000
         USING XPSENDPL,R8        ADDRESSABILITY  PLIST                 01030000
         USING ITASK,R10          ADDRESSABILITY (ITASK)                01040000
                                                                        01050000
         L     R9,TSKPCBC         PROCESS MODE                          01060000
         USING IPCB,R9            ADDRESSABILITY (IPCB)                 01070000
                                                                        01080000
         L     R7,PCBUSER         ADDRESS OF IUSER BLOCK                01090000
         USING IUSER,R7           ADDRESSABILITY (IUSER)                01100000
                                                                        01110000
*----------------------------------------------------------------       01120000
*  LOCATE XPORT DRIVER WORKUNIT                                         01130000
*----------------------------------------------------------------       01140000
         $WULOC LOCATE,           LOCATE XPORT IPCB WORKUNIT           +01150000
               TOKEN=USRXPWUT,                                         +01160000
               USERDATA=IWUENTUD,                                      +01170000
               MF=(E,$WUL_MFL)                                          01180000
                                                                        01190000
         BNZ   ERR_WUL            NO, FAILURE                           01200000
                                                                        01210000
*----------------------------------------------------------------       01220000
*  IF SEND NOTIFICATION REQUESTED,  UPDATE EPB WITH PROCESSOR PCB       01230000
*----------------------------------------------------------------       01240000
         ICM   R3,15,XPSNTFY      SEND COMPLETE NOTIFICATION REQ        01250000
         BZ    SENDCHK            NO, CONTINUE WITH SEND                01260000
                                                                        01270000
         $TASK PCSEPB,EPB=(R3),PCB=*WUDIPCB,MF=(E,$TASKMFL)             01280000
                                                                        01290000
*----------------------------------------------------------------       01300000
*  IF WAIT=NO IS SPECIFIED,  ISSUE TSEND WITH REPLY=NO OPTION           01310000
*----------------------------------------------------------------       01320000
SENDCHK  DS    0H                                                       01330000
         ICM   R1,15,XPSWAIT      WAIT=YES SPECIFIED                    01340000
         BNZ   SENDWAIT                                                 01350000
                                                                        01360000
         $TSEND *,                SEND MSG TO HOST XPORT PROCESS       +01370000
               PCB=*WUDIPCB,                                           +01380000
               TYPE=ITM_HXP_SEND,                                      +01390000
               INFO=(*XPSADDR,*XPSLEN),                                +01400000
               PARMS=(*XPSSHNDL,*XPSNTFY),                             +01410000
               REPLY=NO,                                               +01420000
               MF=(E,$TSNDMFL)                                          01430000
                                                                        01440000
         BNZ   ERR_SEND           TSEND FAILURE                         01450000
         B     RETURN             NORMAL COMPLETION                     01460000
                                                                        01470000
*----------------------------------------------------------------       01480000
*  ISSUE MESSAGE TO XPORT PROCESS AND WAIT FOR COMPLETION STATUS        01490000
*----------------------------------------------------------------       01500000
SENDWAIT DS    0H                                                       01510000
         $TSEND *,                SEND MSG TO HOST XPORT PROCESS       +01520000
               PCB=*WUDIPCB,                                           +01530000
               TYPE=ITM_HXP_SEND,                                      +01540000
               INFO=(*XPSADDR,*XPSLEN),                                +01550000
               PARMS=(*XPSSHNDL,*XPSNTFY),                             +01560000
               REPLY=YES,                                              +01570000
               MF=(E,$TSNDMFL)                                          01580000
                                                                        01590000
         BNZ   ERR_SEND           TSEND FAILURE                         01600000
         LR    R3,R1              REPLY EPB                             01610000
                                                                        01620000
         LA    R4,0               ASSUME STOP=0 SPECIFIED               01630000
         C     R4,XPSSTOP         STOP=0 SPECIFIED                      01640000
         BE    *+8                YES, CONTINUE                         01650000
         LA    R4,TSK_STOP        TASK STOP SPECIFIED                   01660000
                                                                        01670000
         LA    R5,0               ASSUME CANCEL=0 SPECIFIED             01680000
         C     R5,XPSCNCL         CANCEL=0 SPECIFIED                    01690000
         BE    *+8                YES, CONTINUE                         01700000
         LA    R5,TSK_CNCL        TASK CANCEL SPECIFIED                 01710000
                                                                        01720000
         $TASK WAIT,              WAIT FOR XPSEND COMPLETION           +01730000
               EPB=(R3),                                               +01740000
               STOP=(R4),                                              +01750000
               CANCEL=(R5),                                            +01760000
               MF=(E,$TASKMFL)                                          01770000
                                                                        01780000
         LTR   R15,R0             XPSEND COMPLETION STATUS              01790000
         BZ    RETURN             NORMAL COMPLETION                     01800000
         LA    R15,RC08           XPSEND FAILURE                        01810000
         B     RETURN             RETURN                                01820000
                                                                        01830000
*----------------------------------------------------------------       01840000
*  STOP / CANCEL RECEIVED                                               01850000
*----------------------------------------------------------------       01860000
TSK_STOP DS    0H                                                       01870000
         LA    R15,RC04           SEND COPLETE / TASK TERMINATING       01880000
         LA    R0,RSN04           TASK STOP RECEIVED                    01890000
         L     R1,XPSSTOP         STOP RESUME ADDRESS                   01900000
         B     RETURN             RETURN                                01910000
                                                                        01920000
TSK_CNCL DS    0H                                                       01930000
         LA    R15,RC04           SEND COPLETE / TASK TERMINATING       01940000
         LA    R0,RSN08           TASK CANCEL RECEIVED                  01950000
         L     R1,XPSCNCL         CANCEL RESUME ADDRESS                 01960000
         B     RETURN             RETURN                                01970000
                                                                        01980000
         EJECT ,                                                        01990000
***************************************************************         02000000
*  EXIT  /  ERRORS                                                      02010000
***************************************************************         02020000
ERR_WUL  DS    0H                                                       02030000
         LA    R15,RC12           SET RETURN CODE  - FAILURE            02040000
         LA    R0,RSN04           WORKUNIT LOCATOR                      02050000
         B     RETURN             RETURN                                02060000
                                                                        02070000
ERR_SEND DS    0H                                                       02080000
         LA    R15,RC12           SET RETURN CODE  - FAILURE            02090000
         LA    R0,RSN08           TSEND FAILURE                         02100000
         B     RETURN             RETURN                                02110000
                                                                        02120000
***************************************************************         02130000
*  RETURN                                                               02140000
***************************************************************         02150000
RETURN   DS    0H                                                       02160000
         #EXIT ,                  RETURN                                02170000
                                                                        02180000
         EJECT ,                                                        02190000
***************************************************************         02200000
*  LITERALS AND CONSTANTS                                               02210000
***************************************************************         02220000
                                                                        02230000
         LTORG ,                  LITERALS                              02240000
                                                                        02250000
         PRINT NOGEN                                                    02260000
         ICVT  ,                                                        02270000
         ITASK ,                                                        02280000
         IPCB  ,                                                        02290000
         IUSER ,                                                        02300000
         PRINT GEN                                                      02310000
                                                                        02320000
         END   ,                                                        02330000

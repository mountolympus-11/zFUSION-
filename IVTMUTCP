IVTMUTCP TITLE 'INTEGRATOR - IVUSER TCP LOGON PROCESSOR'                00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         SOCKINCL ,               INTEGRATOR SOCKETS                    00060000
         TCPINCL ,                INTEGRATOR TCP/IP                     00070000
         PRINT GEN                                                      00080000
                                                                        00090000
**<DOC-ON>************************************************************* 00100000
*                                                                       00110000
* ROUTINE: IVTMUTCP - IVUSER LOGON PROCESSOR                            00120000
*                                                                       00130000
* DESCRIPTION:                                                          00140000
*                                                                       00150000
* ON ENTRY:                                                             00160000
*                                                                       00170000
*    R15 = ENTRY POINT ADDRESS                                          00180000
*    R14 = RETURN ADDRESS                                               00190000
*    R13 = AVAILABLE SAVE AREA                                          00200000
*    R11 = ICVT ADDRESS                                                 00210000
*    R10 = ITASK ADDRESS                                                00220000
*    R09 = IVTAMCVT ADDRESS                                             00230000
*    R08 = IVUSER ADDRESS                                               00240000
*    R01 = ADDRESS OF LOGON WORK ELEMENT (IWE)                          00250000
*                                                                       00260000
* ON EXIT:                                                              00270000
*                                                                       00280000
*    R15 = 0                                                            00290000
*    R00 = 0                                                            00300000
*    R01 = 0                                                            00310000
*                                                                       00320000
*    ALL OTHER REGISTERS ARE RESTORED.                                  00330000
*                                                                       00340000
**<DOC-OFF>************************************************************ 00350000
                                                                        00360000
         EJECT ,                                                        00370000
*********************************************************************** 00380000
*                                                                       00390000
* MAINTENANCE:                                                          00400000
*                                                                       00410000
*   04/01/95 RANDY WITEK                                                00420000
*                                                                       00430000
*********************************************************************** 00440000
                                                                        00450000
         EQUS  ,                  GENERAL EQUATES                       00460000
                                                                        00470000
RICVT    EQU   R11                                                      00480000
RITASK   EQU   R10                                                      00490000
RIVTAM   EQU   R9                                                       00500000
RIVUSER  EQU   R8                                                       00510000
RIWE     EQU   R7                                                       00520000
RITC     EQU   R6                                                       00530000
RASP     EQU   R5                                                       00540000
                                                                        00550000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00560000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00570000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00580000
         USING IVUSER,RIVUSER     ESTABLISH ADDRESSABILITY              00590000
         USING IWEVTAM,RIWE       ESTABLISH ADDRESSABILITY              00600000
         USING ITC,RITC           ESTABLISH ADDRESSABILITY              00610000
         USING ASP,RASP           ESTABLISH ADDRESSABILITY              00620000
                                                                        00630000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00640000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00650000
SUB1SAVE DS    18F                SUBROUTINE SAVE AREA                  00660000
$PROCMFL $PROC MF=L               PLIST CONSTRUCTION                    00670000
WUNAME   DS    CL8                NAME FOR NEW PROCESS                  00680000
WRK256   DS    XL256              GENERAL WORKAREA                      00690000
TCPRETCD DS    F                  API RETURN CODE AREA                  00700000
TCPLOCKM DS    F                  API LOCK MANAGEMENT WORD              00710000
FLAG     DS    X                                                        00720000
FLAGLOCK EQU   X'80'                                                    00730000
FLAGLCKD EQU   X'40'                                                    00740000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00750000
                                                                        00760000
         $MSGDFT PREFIX=ICTPID,                                        +00770000
               COMPID='VTM',                                           +00780000
               TABLE=*#MSGS,                                           +00790000
               WORKA=0,                                                +00800000
               MF=(E,WRK256),                                          +00810000
               PRINT=NOGEN                                              00820000
                                                                        00830000
IVTMUTCP #ENTER BASE=R12,         ENTRY LINKAGE                        +00840000
               PREG=RIWE,                                              +00850000
               AMODE=31,                                               +00860000
               RMODE=ANY                                                00870000
                                                                        00880000
         CLC   IWELCODE,=A(IWECTCPL) IS IT A TCP "LOGON"                00890000
         BNE   ERRWORK               BRANCH IF NOT, ERROR               00900000
                                                                        00910000
*---------------------------------------------------------------------- 00920000
* SERIALIZE WITH TCP/IP                                                 00930000
*---------------------------------------------------------------------- 00940000
                                                                        00950000
         LA    R1,TCPLOCKM        LOCK MANAGEMENT WORD                  00960000
         BAS   R14,TCPLOCK        GO SERIALIZE                          00970000
         ICM   RITC,15,ICTTCPVT   GET ITC                               00980000
         BNP   ERRTCPIP           HALT IF NO ITC                        00990000
                                                                        01000000
*---------------------------------------------------------------------- 01010000
* SERIALIZE WITH VTAM                                                   01020000
*---------------------------------------------------------------------- 01030000
                                                                        01040000
         BAS   R14,VTAMLOCK       GO SERIALIZE                          01050000
                                                                        01060000
*---------------------------------------------------------------------- 01070000
* REJECT THE LOGON IF SHUTDOWN IS IN PROGRESS                           01080000
*---------------------------------------------------------------------- 01090000
                                                                        01100000
         ICM   RASP,15,IWEYCASP   ASP ADDRESS                           01110000
         BNP   ERRTCPIP           BRANCH IF NO ASP                      01120000
                                                                        01130000
         TM    ICTSTAT3,ICT3$P+ICT3$PX SYSTEM SHUTDOWN?                 01140000
         BNZ   REJECT             BRANCH IF YES                         01150000
         TM    IVTF1,IVTF1TRM     IS TERMINATION UNDERWAY?              01160000
         BO    REJECT             BRANCH IF YES                         01170000
         TM    ITCF1,ITCF1STP+ITCF1CAN+ITCF1TRM                         01180000
         BNZ   REJECT             REJECT IF TCP SHUTDOWN OCCURING       01190000
                                                                        01200000
*---------------------------------------------------------------------- 01210000
* USE TASK NAME FOR PROCESS NAME                                        01220000
*---------------------------------------------------------------------- 01230000
                                                                        01240000
         MVC   WUNAME,TSKNAME     SIMPLY REUSE THE TASK NAME            01250000
                                                                        01260000
*---------------------------------------------------------------------- 01270000
* RELEASE TCP AND VTAM LOCKS                                            01280000
*---------------------------------------------------------------------- 01290000
                                                                        01300000
         LA    R1,TCPLOCKM        LOCK MANAGEMENT WORD                  01310000
         BAS   R14,TCPUNLK        RELEASE                               01320000
         BAS   R14,VTAMUNLK       RELEASE                               01330000
                                                                        01340000
*---------------------------------------------------------------------- 01350000
* CREATE A NEW PROCESS TO EXECUTE THE TCP/IP-VTAM APPLICATION           01360000
*---------------------------------------------------------------------- 01370000
                                                                        01380000
         $PROC CREATE,                  CREATE PROCESS TO INITIATE APPL+01390000
               EP=*ITC@XINI,            ITCPXINI IS THE ENTRY POINT    +01400000
               NAME=WUNAME,             IPROC NAME                     +01410000
               PARM=*IWEYCASP,          ASP IS THE PARM                +01420000
               MF=(E,$PROCMFL)                                          01430000
                                                                        01440000
         LTR   R15,R15                                                  01450000
         BNZ   ERR$PROC                 BRANCH IF SERVICE ERROR         01460000
         LR    R3,R1                    NEW IPCB ADDRESS                01470000
         B     RETURN                   WAIT FOR WORK                   01480000
                                                                        01490000
*---------------------------------------------------------------------- 01500000
* THE TCP USER "LOGON" MUST BE REJECTED...STOP USER & NOTIFY TCP TASK   01510000
*---------------------------------------------------------------------- 01520000
                                                                        01530000
REJECT   DS    0H                                                       01540000
                                                                        01550000
         $VTAMWE L'IWEXI,                                              +01560000
               IWECSTPU           ALLOCATE "STOP USER" WORK ELEMENT     01570000
                                                                        01580000
         LR    R3,R1              WORK ELEMENT ADDRESS                  01590000
                                                                        01600000
         $VTAMQ (R3),             WORK ELEMENT                         +01610000
               IVUWEQ             QUEUE                                 01620000
                                                                        01630000
         $TCPWE L'ITW03MAX,       SIZE                                 +01640000
               ITW03SCU           CODE                                  01650000
                                                                        01660000
X        USING ITW,R3                                                   01670000
         LR    R3,R1              ESTABLISH ADDRESSABILITY              01680000
         MVC   X.ITW03ENT,ASPSKENT ENTITY TOKEN                         01690000
         MVC   X.ITW03US#,ASPSOCK# USER-SOCKET#                         01700000
         DROP  X                                                        01710000
                                                                        01720000
         $TCPRET (RASP)           QUEUE PARM AREA FOR MAINTASK RELEASE  01730000
                                                                        01740000
         $TCPQ (R3),              WORK ELEMENT                         +01750000
               ITCWEQ             QUEUE                                 01760000
                                                                        01770000
         LTR   R15,R15            SUCCESSFULLY QUEUED?                  01780000
         BNZ   ERRTCPIP           BRANCH IF NOT                         01790000
         B     RETURN                                                   01800000
                                                                        01810000
*---------------------------------------------------------------------- 01820000
* RETURN TO CALLER                                                      01830000
*---------------------------------------------------------------------- 01840000
                                                                        01850000
RETURN   DS    0H                                                       01860000
                                                                        01870000
         BAS   R14,VTAMUNLK             RELEASE THE LOCK IF NECESSARY   01880000
                                                                        01890000
         SR    R15,R15                  CLEAR R15                       01900000
         SR    R0,R0                    CLEAR R0                        01910000
         SR    R1,R1                    CLEAR R1                        01920000
                                                                        01930000
         #EXIT R1=YES                   RETURN W/R15,R0,R1              01940000
                                                                        01950000
*---------------------------------------------------------------------- 01960000
*   SUBROUTINE: TCPLOCK                                                 01970000
*        ENTRY: R1 = ADDRESS OF LOCK MANAGEMENT WORD                    01980000
*         EXIT: LOCK MANAGEMENT WORD UPDATED                            01990000
*               ALL REGISTERS ARE RESTORED                              02000000
*---------------------------------------------------------------------- 02010000
                                                                        02020000
TCPLOCK  DS    0H                                                       02030000
                                                                        02040000
         STM   R0,R15,SUB0SAVE    SAVE CALLER'S REGISTERS               02050000
         LR    R2,R1              LOCK MANAGEMENT WORD                  02060000
                                                                        02070000
         TCPLOCK (R2),            LOCK MANAGEMENT WORD                 +02080000
               TCPRETCD,          RETURN CODE ADDRESS                  +02090000
               MF=(E,MFE_LIST)    OBTAIN TCPG LOCK                      02100000
                                                                        02110000
         LM    R0,R15,SUB0SAVE    RESTORE CALLER'S REGISTERS            02120000
         BR    R14                RETURN                                02130000
                                                                        02140000
*---------------------------------------------------------------------- 02150000
*   SUBROUTINE: TCPUNLK                                                 02160000
*        ENTRY: R1 = ADDRESS OF LOCK MANAGEMENT WORD                    02170000
*         EXIT: LOCK MANAGEMENT WORD UPDATED                            02180000
*               ALL REGISTERS ARE RESTORED                              02190000
*---------------------------------------------------------------------- 02200000
                                                                        02210000
TCPUNLK  DS    0H                                                       02220000
                                                                        02230000
         STM   R0,R15,SUB0SAVE    SAVE CALLER'S REGISTERS               02240000
         LR    R2,R1              LOCK MANAGEMENT WORD                  02250000
                                                                        02260000
         TCPUNLK (R2),            LOCK MANAGEMENT WORD                 +02270000
               TCPRETCD,          RETURN CODE ADDRESS                  +02280000
               MF=(E,MFE_LIST)    RELEASE TCPG LOCK                     02290000
                                                                        02300000
         LM    R0,R15,SUB0SAVE    RESTORE CALLER'S REGISTERS            02310000
         BR    R14                RETURN                                02320000
                                                                        02330000
*---------------------------------------------------------------------- 02340000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 02350000
*---------------------------------------------------------------------- 02360000
                                                                        02370000
VTAMLOCK DS    0H                                                       02380000
                                                                        02390000
         TM    FLAG,FLAGLOCK        WAS THE LOCK ALREADY OBTAINED?      02400000
         BOR   R14                  RETURN IF YES                       02410000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             02420000
                                                                        02430000
         $SER  OBTAIN,                                                 +02440000
               VTAM                                                     02450000
                                                                        02460000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              02470000
         BNE   VTAMLOEX             BRANCH IF NOT                       02480000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         02490000
                                                                        02500000
VTAMLOEX DS    0H                                                       02510000
                                                                        02520000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               02530000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          02540000
         BR    R14                  RETURN                              02550000
                                                                        02560000
*---------------------------------------------------------------------- 02570000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                02580000
*---------------------------------------------------------------------- 02590000
                                                                        02600000
VTAMUNLK DS    0H                                                       02610000
                                                                        02620000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       02630000
         BNOR  R14                  BRANCH IF NOT                       02640000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             02650000
         BOR   R14                  DON'T RELEASE IF IT WAS             02660000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             02670000
                                                                        02680000
         $SER  RELEASE,                                                +02690000
               VTAM                                                     02700000
                                                                        02710000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  02720000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          02730000
         BR    R14                  RETURN                              02740000
                                                                        02750000
*---------------------------------------------------------------------- 02760000
* ERROR ROUTINES                                                        02770000
*---------------------------------------------------------------------- 02780000
                                                                        02790000
ERRTCPIP DS    0H                                                       02800000
                                                                        02810000
         $ABEND ABE_VTDIAG,                                            +02820000
               SCOPE=PCB,                                              +02830000
               TITLE='TCP ENVIRONMENT FAILURE'                          02840000
                                                                        02850000
ERR$PROC DS    0H                                                       02860000
                                                                        02870000
         $ABEND ABE_VTDIAG,                                            +02880000
               SCOPE=PCB,                                              +02890000
               TITLE='$PROC FAILURE'                                    02900000
                                                                        02910000
ERRWORK  DS    0H                                                       02920000
                                                                        02930000
         $ABEND ABE_VTDIAG,                                            +02940000
               SCOPE=PCB,                                              +02950000
               TITLE='UNKNOWN WORK ELEMENT'                             02960000
                                                                        02970000
*---------------------------------------------------------------------- 02980000
*  CONSTANTS AND LITERALS                                               02990000
*---------------------------------------------------------------------- 03000000
                                                                        03010000
         LTORG ,                                                        03020000
         PRINT NOGEN                                                    03030000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                03040000
         ISTDBIND ,               VTAM BIND IMAGE                       03050000
         TRACODES ,               INTEGRATOR TRACE CODES                03060000
         ICVT  ,                  INTEGRATOR CVT                        03070000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   03080000
         IRPL ,                   INTEGRATOR VTAM RPL+                  03090000
         ISESS ,                  INTEGRATOR SESSION BLOCK              03100000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            03110000
         ITASK ,                  INTEGRATOR TASK BLOCK                 03120000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          03130000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       03140000
         EVCODES ,                INTEGRATOR EVENT CODES                03150000
         ABCODES ,                INTEGRATOR $ABEND CODES               03160000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     03170000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        03180000
         $PROC DSECT=YES          INTEGRATOR $PROC SERVICES             03190000
         END   ,                                                        03200000

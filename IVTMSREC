IVTMSREC TITLE 'INTEGRATOR - ISESS $SESS_RECEIVE PROCESSOR'             00010000
**<DOC-ON>************************************************************* 00020000
*                                                                       00030000
* ROUTINE: IVTMSREC - ISESS $SESS_RECEIVE PROCESSOR                     00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
* ON ENTRY:                                                             00080000
*                                                                       00090000
*    R15 = ENTRY POINT ADDRESS                                          00100000
*    R14 = RETURN ADDRESS                                               00110000
*    R13 = AVAILABLE SAVE AREA                                          00120000
*    R11 = ICVT ADDRESS                                                 00130000
*    R10 = ITASK ADDRESS                                                00140000
*    R09 = IVTAMCVT ADDRESS                                             00150000
*    R08 = ISESS ADDRESS                                                00160000
*                                                                       00170000
* ON EXIT:                                                              00180000
*                                                                       00190000
*    R15 = 0                                                            00200000
*    R00 = 0                                                            00210000
*    R01 = 0                                                            00220000
*                                                                       00230000
*    ALL OTHER REGISTERS ARE RESTORED.                                  00240000
*                                                                       00250000
**<DOC-OFF>************************************************************ 00260000
                                                                        00270000
         EJECT ,                                                        00280000
*********************************************************************** 00290000
*                                                                       00300000
* MAINTENANCE:                                                          00310000
*                                                                       00320000
*   08/01/93 RANDY WITEK                                                00330000
*   07/01/94 RANDY WITEK - LU6.2 SUPPORT                                00340000
*                                                                       00350000
*********************************************************************** 00360000
                                                                        00370000
         EQUS  ,                  GENERAL EQUATES                       00380000
                                                                        00390000
RICVT    EQU   R11                                                      00400000
RITASK   EQU   R10                                                      00410000
RIVTAM   EQU   R9                                                       00420000
RISESS   EQU   R8                                                       00430000
RIRQE    EQU   R7                                                       00440000
RSPLIST  EQU   R6                                                       00450000
RIRPL    EQU   R5                                                       00460000
                                                                        00470000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00480000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00490000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00500000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00510000
         USING SPLIST,RSPLIST     ESTABLISH ADDRESSABILITY              00520000
         USING IRQE,RIRQE         ESTABLISH ADDRESSABILITY              00530000
         USING IRPL,RIRPL         ESTABLISH ADDRESSABILITY              00540000
                                                                        00550000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00560000
WRK256   DS    XL256              GENERAL WORKAREA                      00570000
RETR15   DS    F                                                        00580000
RETR0    DS    F                                                        00590000
RETR1    DS    F                                                        00600000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00610000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00620000
                                                                        00630000
         $MSGDFT PREFIX=ICTPID,                                        +00640000
               COMPID='VTM',                                           +00650000
               TABLE=*#MSGS,                                           +00660000
               WORKA=0,                                                +00670000
               MF=(E,WRK256),                                          +00680000
               PRINT=NOGEN                                              00690000
                                                                        00700000
IVTMSREC #ENTER BASE=R12,         ENTRY LINKAGE                        +00710000
               AMODE=31,                                               +00720000
               RMODE=ANY                                                00730000
                                                                        00740000
*---------------------------------------------------------------------- 00750000
* CHECK FOR OUTSTANDING $SESS_RECEIVE                                   00760000
*---------------------------------------------------------------------- 00770000
                                                                        00780000
         ICM   RSPLIST,15,ISERQRCV IS A RECEIVE QUEUED?                 00790000
         BZ    RETURN              BRANCH IF NOT                        00800000
                                                                        00810000
*---------------------------------------------------------------------- 00820000
* CHECK FOR AN AVAILABLE RECEIVE QUEUE ELEMENT                          00830000
*---------------------------------------------------------------------- 00840000
                                                                        00850000
         ICM   RIRQE,15,ISERCVHD   FIRST ELEMENT ON THE QUEUE           00860000
         BM    RETURN              BRANCH IF QUEUE IS EMPTY             00870000
                                                                        00880000
*---------------------------------------------------------------------- 00890000
* DEQUEUE THE RECEIVE QUEUE ELEMENT AND THE RECEIVE REQUEST.            00900000
*---------------------------------------------------------------------- 00910000
                                                                        00920000
         XC    ISERQRCV,ISERQRCV   SHOW RECEIVE IS DEQUEUED             00930000
         L     R2,IRQNEXT          NEXT RECEIVE QUEUE ELEMENT           00940000
         L     R3,IRQPREV          PREVIOUS (NORMALIZED ISERCVHD)       00950000
         ST    R2,IRQNEXT-IRQ(,R3) LINK PREVIOUS --> NEXT               00960000
         ST    R3,IRQPREV-IRQ(,R2) LINK NEXT --> PREVIOUS               00970000
                                                                        00980000
*---------------------------------------------------------------------- 00990000
* COMPLETE THE $SESS_RECEIVE SPLIST WITH INFO FROM THE IRQE             01000000
*---------------------------------------------------------------------- 01010000
                                                                        01020000
         MVC   SPLAREA(4),IRQAREA    SET RECEIVE-TYPE INFORMATION       01030000
         MVC   SPLAREAL(4),IRQAREAL  SET RECEIVE-TYPE INFORMATION       01040000
         MVC   SPLCNTRL(3),IRQCNTRL  SET RECEIVE-TYPE INFORMATION       01050000
         MVC   SPLRH(3),IRQRH        SET RECEIVE-TYPE INFORMATION       01060000
         MVC   SPLSEQNO(2),IRQSEQNO  SET RECEIVE-TYPE INFORMATION       01070000
         MVC   SPLSENSE(4),IRQSENSE  SET RECEIVE-TYPE INFORMATION       01080000
         MVC   SPLUBTYP(1),IRQUBTYP  SET RECEIVE-TYPE INFORMATION       01090000
                                                                        01100000
*---------------------------------------------------------------------- 01110000
* CHECK FOR RECEIVE_DATA TIMEOUT EVENT                                  01120000
*---------------------------------------------------------------------- 01130000
                                                                        01140000
         TM    IRQF1,IRQF1TOT     IS THIS A SPECIAL TIMEOUT IRQE?       01150000
         BNO   NOTTOT             BRANCH IF NOT                         01160000
         MVC   SPLRETCD,=A($SESS_RC_TOT_RECEIVE_DATA)                   01170000
         B     POSTRCV            POST THE TIMEOUT                      01180000
NOTTOT   DS    0H                                                       01190000
                                                                        01200000
*---------------------------------------------------------------------- 01210000
* CHECK FOR CPIC REQUESTS                                               01220000
*---------------------------------------------------------------------- 01230000
                                                                        01240000
         TM    IRQF1,IRQF1SHP+IRQF1CFM+IRQF1RTS+IRQF1REC+IRQF1SER+IRQF1+01250000
               BID                                                      01260000
         BNZ   CPIC                                                     01270000
         TM    IRQF2,IRQF2YLD+IRQF2BS+IRQF2BIR+IRQF2BIQ+IRQF2CLP        01280000
         BNZ   CPIC                                                     01290000
         B     NOTCPIC                                                  01300000
                                                                        01310000
CPIC     DS    0H                                                       01320000
                                                                        01330000
         MVC   SPLRETCD,=A($SESS_RC_CPIC_REQUEST)                       01340000
                                                                        01350000
*                                                                       01360000
* CHECK FOR CPIC SHIP REQUEST                                           01370000
*---------------------------------------------------------------------- 01380000
                                                                        01390000
         TM    IRQF1,IRQF1SHP     IS THIS A SPECIAL SHIP IRQE?          01400000
         BNO   NOTSHIP            BRANCH IF NOT                         01410000
         MVC   SPLRSNCD,=A($SESS_RSN_CPIC_SHIP)                         01420000
         B     CPICREQ                                                  01430000
NOTSHIP  DS    0H                                                       01440000
                                                                        01450000
*                                                                       01460000
* CHECK FOR CPIC RECEIVE REQUEST                                        01470000
*---------------------------------------------------------------------- 01480000
                                                                        01490000
         TM    IRQF1,IRQF1REC     IS THIS A SPECIAL RECEIVE IRQE?       01500000
         BNO   NOTRECV            BRANCH IF NOT                         01510000
         MVC   SPLRSNCD,=A($SESS_RSN_CPIC_RECEIVE)                      01520000
         B     CPICREQ                                                  01530000
NOTRECV  DS    0H                                                       01540000
                                                                        01550000
*                                                                       01560000
* CHECK FOR CPIC SEND CONFIRMED REQUEST                                 01570000
*---------------------------------------------------------------------- 01580000
                                                                        01590000
         TM    IRQF1,IRQF1CFM     IS THIS A SPECIAL SEND CFMD IRQE?     01600000
         BNO   NOTCFMD            BRANCH IF NOT                         01610000
         MVC   SPLRSNCD,=A($SESS_RSN_CPIC_SEND_CFMD)                    01620000
         B     CPICREQ                                                  01630000
NOTCFMD  DS    0H                                                       01640000
                                                                        01650000
*                                                                       01660000
* CHECK FOR CPIC SEND RTS REQUEST                                       01670000
*---------------------------------------------------------------------- 01680000
                                                                        01690000
         TM    IRQF1,IRQF1RTS     IS THIS A SPECIAL SEND RTS IRQE?      01700000
         BNO   NOTRTS             BRANCH IF NOT                         01710000
         MVC   SPLRSNCD,=A($SESS_RSN_CPIC_SEND_RTS)                     01720000
         B     CPICREQ                                                  01730000
NOTRTS   DS    0H                                                       01740000
                                                                        01750000
*                                                                       01760000
* CHECK FOR CPIC SEND ERROR REQUEST                                     01770000
*---------------------------------------------------------------------- 01780000
                                                                        01790000
         TM    IRQF1,IRQF1SER     IS THIS A SPECIAL SEND ERR IRQE?      01800000
         BNO   NOTSERR            BRANCH IF NOT                         01810000
         MVC   SPLRSNCD,=A($SESS_RSN_CPIC_SEND_ERROR)                   01820000
         B     CPICREQ                                                  01830000
NOTSERR  DS    0H                                                       01840000
                                                                        01850000
*                                                                       01860000
* CHECK FOR CPIC BID REQUEST                                            01870000
*---------------------------------------------------------------------- 01880000
                                                                        01890000
         TM    IRQF1,IRQF1BID     IS THIS A SPECIAL BID IRQE?           01900000
         BNO   NOTBID             BRANCH IF NOT                         01910000
         MVC   SPLRSNCD,=A($SESS_RSN_CPIC_BID)                          01920000
         B     CPICREQ                                                  01930000
NOTBID   DS    0H                                                       01940000
                                                                        01950000
*                                                                       01960000
* CHECK FOR CPIC BID SYNC                                               01970000
*---------------------------------------------------------------------- 01980000
                                                                        01990000
         TM    IRQF2,IRQF2BS      IS THIS A SPECIAL BID SYNC?           02000000
         BNO   NOTBS              BRANCH IF NOT                         02010000
         MVC   SPLRSNCD,=A($SESS_RSN_CPIC_BID_SYNC)                     02020000
         B     CPICREQ                                                  02030000
NOTBS    DS    0H                                                       02040000
                                                                        02050000
*                                                                       02060000
* CHECK FOR CPIC BIS REQUEST                                            02070000
*---------------------------------------------------------------------- 02080000
                                                                        02090000
         TM    IRQF2,IRQF2BIQ     IS THIS A SPECIAL BIS REQ?            02100000
         BNO   NOTBIQ             BRANCH IF NOT                         02110000
         MVC   SPLRSNCD,=A($SESS_RSN_CPIC_BIS_REQUEST)                  02120000
         B     CPICREQ                                                  02130000
NOTBIQ   DS    0H                                                       02140000
                                                                        02150000
*                                                                       02160000
* CHECK FOR CPIC BIS RESPONSE                                           02170000
*---------------------------------------------------------------------- 02180000
                                                                        02190000
         TM    IRQF2,IRQF2BIR     IS THIS A SPECIAL BIS RSP?            02200000
         BNO   NOTBIR             BRANCH IF NOT                         02210000
         MVC   SPLRSNCD,=A($SESS_RSN_CPIC_BIS_RESPONSE)                 02220000
         B     CPICREQ                                                  02230000
NOTBIR   DS    0H                                                       02240000
                                                                        02250000
*                                                                       02260000
* CHECK FOR CPIC YIELD REQUEST                                          02270000
*---------------------------------------------------------------------- 02280000
                                                                        02290000
         TM    IRQF2,IRQF2YLD     IS THIS A SPECIAL YIELD IRQE?         02300000
         BNO   NOTYIELD           BRANCH IF NOT                         02310000
         MVC   SPLRSNCD,=A($SESS_RSN_CPIC_YIELD)                        02320000
         B     CPICREQ                                                  02330000
NOTYIELD DS    0H                                                       02340000
                                                                        02350000
*                                                                       02360000
* CHECK FOR LU6.2 TP CLEANUP REQUEST                                    02370000
*---------------------------------------------------------------------- 02380000
                                                                        02390000
         TM    IRQF2,IRQF2CLP     IS THIS A SPECIAL TP CLUP IRQE?       02400000
         BNO   NOTCPIC            BRANCH IF NOT                         02410000
         MVC   SPLRSNCD,=A($SESS_RSN_CPIC_CLEANUP)                      02420000
         B     CPICREQ                                                  02430000
                                                                        02440000
*                                                                       02450000
* COMPLETE SPECIAL CPIC REQUEST                                         02460000
*---------------------------------------------------------------------- 02470000
                                                                        02480000
CPICREQ  DS    0H                                                       02490000
                                                                        02500000
         MVC   SPL62ENT,IRQ62ENT  SET THE WORK UNIT TOKEN               02510000
         MVC   SPL62EPB,IRQ62EPB  SET THE EPB ADDRESS                   02520000
         MVC   SPL62RCB,IRQ62RCB  SET THE RCB ADDRESS                   02530000
         MVC   SPL62PLA,IRQ62PLA  SET THE PARMLIST ADDRESS              02540000
         B     POSTRCV            POST THE SHIP REQUEST                 02550000
NOTCPIC  DS    0H                                                       02560000
                                                                        02570000
*---------------------------------------------------------------------- 02580000
* PERFORM PROTOCOL CHECKS AND UPDATE SESSION STATE INFORMATION          02590000
*---------------------------------------------------------------------- 02600000
                                                                        02610000
         TM    SPLRH0,X'80'       RESPONSE?                             02620000
         BO    POSTRCV            BRANCH IF RESPONSE                    02630000
                                                                        02640000
         LR    R0,RSPLIST         PASS SPLIST IN R0                     02650000
         LR    R1,RISESS          PASS ISESS IN R1                      02660000
         L     R15,IVT@SRIP       RECEIVE INITIAL PROTOCOL CHECKS       02670000
         BASR  R14,R15            LINK TO PROTOCOL CHECKS               02680000
                                                                        02690000
*---------------------------------------------------------------------- 02700000
* POST THE $SESS_RECEIVE COMPLETE                                       02710000
*---------------------------------------------------------------------- 02720000
                                                                        02730000
POSTRCV  DS    0H                                                       02740000
                                                                        02750000
         MVC   SPLSTATE,ISESTATE  PASS THE CURRENT SESSION STATE FLAGS  02760000
                                                                        02770000
         LR    R1,RSPLIST         PASS SPLIST ADDRESS IN R1             02780000
         L     R15,IVT@SPST       SPLIST  TRACE/POST ROUTINE            02790000
         BASR  R14,R15            LINK TO TRACE/POST ROUTINE            02800000
                                                                        02810000
*---------------------------------------------------------------------- 02820000
* IF A RESETSR IS REQUIRED, ISSUE IT                                    02830000
*---------------------------------------------------------------------- 02840000
                                                                        02850000
         TM    IRQF1,IRQF1RSR     IS A RESETSR REQUIRED?                02860000
         BNO   RELEASE            BRANCH IF NOT                         02870000
                                                                        02880000
         $VTAM GETRPL,                                                 +02890000
               AREA=ISERPACT,                                          +02900000
               ERRET=ERR$VTAM,                                         +02910000
               MF=(E,MFE_LIST)    ACQUIRE AN IRPL                       02920000
                                                                        02930000
         LR    RIRPL,R1           ESTABLISH ADDRESSIBILITY              02940000
         LA    R1,ISEWEQ          SESSION QUEUE                         02950000
         ST    R1,IRP@WEQ         WILL RECEIVE THE RPL COMPLETION       02960000
         L     R2,ISEACB@         SESSION ACB ADDRESS                   02970000
         L     R3,ISECID          SESSION CID                           02980000
         ST    R3,IRPARG          SET CID COPY                          02990000
         ST    RISESS,IRPISESS    SET ISESS ADDRESS                     03000000
         MVC   IRPTOKEN,ISETK     SET TOKEN                             03010000
                                                                        03020000
         RESETSR RPL=(RIRPL),     PUT DFSYN BACK IN CA MODE            +03030000
               ACB=(R2),                                               +03040000
               ARG=(R3),                                               +03050000
               OPTCD=CA,                                               +03060000
               RTYPE=DFSYN                                              03070000
                                                                        03080000
         STM   R15,R0,IRPR15      SAVE VTAM RETURN REGISTERS            03090000
                                                                        03100000
         $VTAM CHECKPH1,          PHASE-1 RETURN CODE CHECK            +03110000
               AREA=(RIRPL),      IRPL TO BE CHECKED                   +03120000
               MF=(E,MFE_LIST)                                          03130000
                                                                        03140000
                                                                        03150000
*---------------------------------------------------------------------- 03160000
* RELEASE THE IRQE                                                      03170000
*---------------------------------------------------------------------- 03180000
                                                                        03190000
RELEASE  DS    0H                                                       03200000
                                                                        03210000
         $RETSTOR (RIRQE),        RELEASE THE IRQE                     +03220000
               OWNER=(RITASK)                                           03230000
                                                                        03240000
*---------------------------------------------------------------------- 03250000
* RETURN TO CALLER                                                      03260000
*---------------------------------------------------------------------- 03270000
                                                                        03280000
RETURN   DS    0H                                                       03290000
                                                                        03300000
         LM    R15,R1,RETREGS     LOAD RETURN VALUES                    03310000
                                                                        03320000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    03330000
                                                                        03340000
*---------------------------------------------------------------------- 03350000
* ERROR ROUTINES                                                        03360000
*---------------------------------------------------------------------- 03370000
                                                                        03380000
ERR$VTAM DS    0H                                                       03390000
                                                                        03400000
         $ABEND ABE_VTDIAG,                                            +03410000
               SCOPE=PCB,                                              +03420000
               TITLE='$VTAM FAILURE'                                    03430000
                                                                        03440000
*---------------------------------------------------------------------- 03450000
*  CONSTANTS AND LITERALS                                               03460000
*---------------------------------------------------------------------- 03470000
                                                                        03480000
         LTORG ,                                                        03490000
         PRINT NOGEN                                                    03500000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                03510000
         ISTDBIND ,               VTAM BIND IMAGE                       03520000
         ISTRH ,                  VTAM SNA REQUEST HEADER               03530000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         03540000
         ICVT  ,                  INTEGRATOR CVT                        03550000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   03560000
         IRPL ,                   INTEGRATOR VTAM RPL+                  03570000
         IACB ,                   INTEGRATOR VTAM ACB+                  03580000
         INIB ,                   INTEGRATOR VTAM NIB+                  03590000
         ISESS ,                  INTEGRATOR SESSION BLOCK              03600000
         IRQE ,                   INTEGRATOR RECEIVE QUEUE ELEMENT      03610000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            03620000
         ITASK ,                  INTEGRATOR TASK BLOCK                 03630000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          03640000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       03650000
         EVCODES ,                INTEGRATOR EVENT CODES                03660000
         ABCODES ,                INTEGRATOR $ABEND CODES               03670000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     03680000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        03690000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             03700000
         $PROC DSECT=YES          INTEGRATOR $PROC SERVICES             03710000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             03720000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             03730000
         IFGEXLST ,               VTAM EXIT LIST                        03740000
         END   ,                                                        03750000

ISQLDRV  TITLE '- SQL INTERFACE AND DRIVER'                             00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE: ISQLDRV - SQL Interface and Driver                           00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*   This routine serves as the entry point for the product SQL          00080000
*   API.  It accepts requests in @TIRSQL parameter format,              00090000
*   determines the proper sequence of execution depending on            00100000
*   the type of request and type of SQL statement, and                  00110000
*   transmits the results to the cooperative process (coop)             00120000
*   making the request.                                                 00130000
*                                                                       00140000
*   The product does not implement any form of DDL. It does             00150000
*   support the standard SELECT, INSERT, UPDATE, and DELETE             00160000
*   statements as well as the SET CURRENT SQLID = statements,           00170000
*   all in DB2 dialect.  The SET CURRENT SQLID statement can            00180000
*   be used in run-time programs to select a project to which           00190000
*   all subsequent DML statements will be directed.                     00200000
*                                                                       00210000
*   The Call Level Interface (CLI) functions coded in coop              00220000
*   provide for three distinct types of SQL request, as                 00230000
*   described below.  In each a unique identifier referred to           00240000
*   as a "handle" is provided by coop to coordinate multiple            00250000
*   references to a single statement.                                   00260000
*                                                                       00270000
*   SQLPrepare() - The SQL statement provided is analyzed for           00280000
*                  validity. The "compliled" form of the                00290000
*                  statement is retained for future reference.          00300000
*                  The statement may can contain "placeholders"         00310000
*                  for values that will be provided by                  00320000
*                  SQLExecute(). The statement remains available        00330000
*                  for use until implicitly or explicitly freed         00340000
*                  (discussed later).                                   00350000
*                                                                       00360000
*   SQLExecute() - A SQL statement previously "compliled" using         00370000
*                  SQLPrepare() is executed.  The parameter list        00380000
*                  contains instantiations for all of the               00390000
*                  placeholders present in the original SQL             00400000
*                  statement.                                           00410000
*                                                                       00420000
*   SQLExecDirect() - The SQL statement provided is analyzed,           00430000
*                  compliled, executed and freed as a single            00440000
*                  operation.                                           00450000
*                                                                       00460000
*   A SQLPrepare() followed by multiple SQLExecute() requests           00470000
*   is the most efficient manner to request multiple executions         00480000
*   of a single (parameterized) SQL statement. Those two                00490000
*   functions used together proivde a capability analogous to           00500000
*   traditional RDBMS static SQL.  SQLExecDirect() is the               00510000
*   simplest means to execute a single SQL statement - and the          00520000
*   most costly.  That function is analogous to traditional             00530000
*   RDBMS dynamic SQL.  Refer to the X/OPEN Call Level                  00540000
*   Interface specification for a more complete description of          00550000
*   these three functions.                                              00560000
*                                                                       00570000
*   Coop can also request the return of the plan associated with        00580000
*   the compiled form of the SQL statement.  This is not a              00590000
*   standard X/Open or ODBC capability.  In any case where plan         00600000
*   return is requested the statement is not executed.                  00610000
*                                                                       00620000
*   This routine and its services are structured as a series of         00630000
*   phases referred to as the INITIAL, PREPARE, VALIDATE,               00640000
*   EXECUTE, RETRIEVE and RELEASE phases. All request types             00650000
*   flow through the INITIAL, VALIDATE and RELEASE phases.              00660000
*   SQLExecDirect() and workbench SQL requests flow through all         00670000
*   phases, etc.  The diagram below depicts the flow for the            00680000
*   more common request types.                                          00690000
*                                                                       00700000
*                 <<< INSERT DIAGRAM >>>                                00710000
*                                                                       00720000
*   Any @TIRSQL request can identify statement handles that             00730000
*   have been dropped by coop since the last request.  All of           00740000
*   the resources associated with those handles, particularly           00750000
*   prepared SQL statements, are released. The same logic is            00760000
*   invoked via other mechanisms if coop terminates or becomes          00770000
*   disconnected, etc.                                                  00780000
*                                                                       00790000
*   Like a traditional RDBMS, this product has a catalog to             00800000
*   which SQL (SELECT) requests may be directed.  However, when         00810000
*   a SQL statement targets a virtual (VDB) table or virtual            00820000
*   catalog (SYSVCAT) table, that table must first be built /           00830000
*   materialized in some other way.  This routine distinguishes         00840000
*   between the two types of request.                                   00850000
*                                                                       00860000
*   Some SQL capabilities are restricted to either workbench            00870000
*   or run-time based coops.  For example, a workbench cannot           00880000
*   issue a SET CURRENT SQLID statement.  Workbench SQL most            00890000
*   closely fits the SQLExecDirect() model but does not                 00900000
*   actually use that interface.                                        00910000
*                                                                       00920000
*   Thus, the SQL API operates as a supervisory function of the         00930000
*   four major variables discussed above and drives the                 00940000
*   subordinate execution logic accordingly, as follows:                00950000
*                                                                       00960000
*                                                                       00970000
*      SQLAPI( CLI statement type,   - Prep(), Exec(), ExecDirect()     00980000
*              SQL statement,        - DML, SET, ...                    00990000
*              coop type,            - Workbench or Runtime             01000000
*              table type )          - Persistent, SYSVCAT, or VDB      01010000
*                                                                       01020000
*                                                                       01030000
*   When a SQL SELECT statement is successfully executed,               01040000
*   ITIOPEN and ITIREAD are invoked directly from this routine          01050000
*   to preload the response area (ref DSQLRESP) with an initial         01060000
*   number of rows from the result set.  Subsequent ITIREADs            01070000
*   can be issued from coop to acquire the rest of the table.           01080000
*                                                                       01090000
*                                                                       01100000
* TABLE TYPES:                                                          01110000
*                                                                       01120000
*   The routine currently recognizes three distinct types of            01130000
*   table, all of which are implemented using table objects             01140000
*   managed using the table services APIs.                              01150000
*                                                                       01160000
*      1) PERSISTENT tables are those which are permanently             01170000
*         resident and continually maintined within their               01180000
*         object space.  The only implmentation of persistent           01190000
*         tables in the product today is the tables making              01200000
*         up the various object space "catalogs", and as such,          01210000
*         are usually referred to as CATALOG tables.                    01220000
*                                                                       01230000
*      2) VIRTUAL DATABASE (VDB) tables are those which are             01240000
*         materialized upon demand when a SQL statement targets         01250000
*         a table mapping 3270-based host applications to a             01260000
*         table definition.  VDB definitions reside only in             01270000
*         PROJECT object spaces.                                        01280000
*                                                                       01290000
*      3) VIRTUAL CATALOG (SYSVCAT) tables are similar to VDB           01300000
*         tables - they are materialized on demand.  However,           01310000
*         they may be defined and populated outside of the              01320000
*         product's VDB definition mechanisms, providing a              01330000
*         useful mechanism for providing SQL-like responses             01340000
*         to transactions, etc.                                         01350000
*                                                                       01360000
*                                                                       01370000
* NOTES:                                                                01380000
*                                                                       01390000
*   ISQLDRV is intended to run as a process (under its own PCB).        01400000
*                                                                       01410000
*   SQL executors are always invoked with a 1024 byte workarea          01420000
*   provided in R0 - the standard @CALL WKA= interface.                 01430000
*                                                                       01440000
*   Table names beginning with SYSVCAT are reserved for the             01450000
*   product specific virtual catalog.  Tables whose names begin         01460000
*   with SYS (but not SYSVCAT) are reserved for InfoSession in          01470000
*   all InfoSession object spaces, but have no special meaning          01480000
*   in non-InfoSession spaces.                                          01490000
*                                                                       01500000
*   The SQL statement is always provided in text format by       156358 01510000
*   workbench (dynamic SQL) calls and can be journalled          156358 01520000
*   immediately.  Run time requests may either provide the       156358 01530000
*   statement via SQLExecDirect() or may have previously shipped 156358 01540000
*   the statement via SQLPrepare(). In the latter case, the      156358 01550000
*   statement is not available until the PSB is retrieved via    156358 01560000
*   PREPINIT.                                                    156358 01570000
*                                                                       01580000
*                                                                       01590000
* ON ENTRY:                                                             01600000
*                                                                       01610000
*    R1  contains the address of a parameter list described by          01620000
*        the @TIRSQL mapping macro                                      01630000
*                                                                       01640000
*                                                                       01650000
* ON EXIT:                                                              01660000
*                                                                       01670000
*    A DSQLRESP response block is built for the requester to            01680000
*    convey the results of the request.  When the return code is        01690000
*    non-zero, messages describing the source of error are              01700000
*    returned in RUMSGS format.  DSQLRC, DSQLRSN, DSQLSUPR and          01710000
*    DSQLINFO contain the return, reason, SQL (super) and info          01720000
*    (diagnostic) codes respectively.  A summary of return and          01730000
*    reason code values is shown below.                                 01740000
*                                                                       01750000
*       RC00 - request completed without error                          01760000
*                                                                       01770000
*       RC04 - unable to access the PPL#CR SQL parse routine            01780000
*                                                                       01790000
*       RC08 - SQL statement executor routine encountered error         01800000
*                                                                       01810000
*       RC12 - SQL statement executor routine encountered a             01820000
*              component failure                                        01830000
*                                                                       01840000
*       RC16 - SQL statement does not conform to requirements           01850000
*                                                                       01860000
*              RSN00: SQL statement rejected by PPL#CR                  01870000
*              RSN04: invalid SET CURRENT SQLID = statement             01880000
*              RSN08: SQL subset grammar violation (ISQPARSE)           01890000
*                                                                       01900000
*       RC20 - TXP response buffer service failure                      01910000
*                                                                       01920000
*       RC24 - insufficient storage                                     01930000
*                                                                       01940000
*       RC28 - table services failure                                   01950000
*                                                                       01960000
**<DOC-OFF>****************************************************         01970000
                                                                        01980000
         EJECT                                                          01990000
***************************************************************         02000000
*                                                                       02010000
* MAINTENANCE:                                                          02020000
*                                                                       02030000
*   xx/xx/92  R. Turgeon                                                02040000
*             Initial version                                           02050000
*                                                                       02060000
*   08/03/94  R. Turgeon          PAR# 135096                    135096 02070000
*             Accept version 1 TIREAD plist extending the        135096 02080000
*             number of table columns from 64 to 512.            135096 02090000
*                                                                       02100000
*   11/09/94  Su-fen Wu           PAR# 153987                    153987 02110000
*         1)  Do not allow SQLPrepare() of SET CURRENT SQLID     153987 02120000
*             statements.  Add msg SQL025 to describe the error. 153987 02130000
*                                                                       02140000
*         2)  Remove checking for WorkBench doing project        153987 02150000
*             switch (in PROJ_NEW) since Platinum Parser does    153987 02160000
*             not allow 'SET' statement.                         153987 02170000
*                                                                       02180000
*   11/22/94  R. Turgeon          PAR #156358                    156358 02190000
*             Retain SQL statement upon receipt of SQLPrepare()  156358 02200000
*             and acquire it for tracing purposes, etc. from     156358 02210000
*             the PSB via PREPINIT.                              156358 02220000
*                                                                       02230000
*   12/06/94  R. Turgeon                                                02240000
*             Removed PAGE= / SHRPAGE= for $SPACE, $OBJECT,             02250000
*             and TB* service requests                                  02260000
*                                                                       02270000
*   12/14/94  Su-fen Wu           PAR #157382                    157382 02280000
*             @TIREAD pointer needs to be re-calculated using    157382 02290000
*             the offset. Column list offset needs to be         157382 02300000
*             calculated right after the 1st column is built.    157382 02310000
*                                                                       02320000
*   10/05/95  R. Turgeon    Rel 2.1 - VDBCACHE, PLANCACHE               02330000
*             Cache implementations move previously private             02340000
*             copies of VDB definitions and plans to shared             02350000
*             IPROJ storage areas which are deleted and/or              02360000
*             rebuilt whenever certain project catalog tables           02370000
*             are upated.  Previously, the $NAVBLD was issued           02380000
*             in ISQLVDB but has been promoted into this                02390000
*             routine.                                                  02400000
*                                                                       02410000
*   10/16/95  R. Turgeon    Rel 2.1                                     02420000
*             Add semantic interpretation / validation of column        02430000
*             names with prepended table identifiers.  Support          02440000
*             is rather limitted at this time.                          02450000
*                                                                       02460000
*   11/13/95  R. Turgeon    Rel 2.1                                     02470000
*             Implement FORMAT=TERSE column descriptor allowing         02480000
*             the return of TBCOLDV1 blocks rather than the             02490000
*             larger TBCOLDEF blocks.                                   02500000
*                                                                231496 02510000
*   01/06/96  R. Turgeon      Rel 2.1 - PAR# 231496              231496 02520000
*             Significantly restructured to allow VDB column /   231496 02530000
*             variable usage (input or output) determination     231496 02540000
*             to be deferred to this routine (from ISQLDRV).     231496 02550000
*                                                                       02560000
*    01/12/96  R. Turgeon      Rel 2.1                                  02570000
*              Return application / states visited during               02580000
*              the execution of a VDB request.                          02590000
*                                                                       02600000
***************************************************************         02610000
                                                                        02620000
         EJECT                                                          02630000
WORKAREA #WORK ,                                                        02640000
                                                                        02650000
QFLAGS   DS    X             FLAG BYTE                                  02660000
Q$JRNL   EQU   X'80'            SQL STATEMENT JOURNALING IS ACTIVE      02670000
Q$NODESC EQU   X'40'            SUPPRESS TABLE DESCRIBE FOR EXECUTE()   02680000
                                                                        02690000
RFLAGS   DS    X             RESULT SET FLAGS                           02700000
R$NODATA EQU   X'80'            NO DATA ELIGIBLE FOR RETURN             02710000
R$RDVER0 EQU   X'40'            USE 10A LEVEL OF TIREAD PLIST    135096 02720000
                                                                        02730000
RCVFLAGS DS    X             RECOVERY FLAGS                             02740000
RCVF$ENV EQU   X'80'            RECOVERY ENVIRONMENT ESTABLISHED        02750000
RCVF$ABE EQU   X'40'            ABEND ENCOUNTERED                       02760000
                                                                        02770000
REQLEVEL DS    X             TIRSQL REQUEST UNIT LEVEL                  02780000
RESERVE1 DS    H             AVAILABLE                                  02790000
DESCFMT  DS    F             DESCRIBE FORMAT: 0 - STD, /0 - TERSE       02800000
                                                                        02810000
@QCS     DS    A             ADDR OF ITASK OWNER QCS                    02820000
SQLPLIST DS    A             ADDR OF TIRSQL PLIST UPON ENTRY            02830000
DROPSNO  DS    F             NUMBER OF DROPPED STATEMENT HANDLES        02840000
DROPSVEC DS    A             DROPPED STATEMENT HANDLE ARRAY ORIGIN      02850000
                                                                        02860000
RMXTOKEN DS    F             SQL WORKAREA RMX TOKEN                     02870000
TABLTOKN DS    F             TEMPORARY COPY OF TABLE TOKEN              02880000
STMTHNDL DS    XL16          PREPARE / EXECUTE(PREP) STATEMENT HANDLE   02890000
CURRPROJ DS    CL16          CURRENT PROJECT NAME                       02900000
TABLNAME DS    CL18,CL2      TABLE NAME AND PAD                         02910000
                                                                        02920000
ROWCOUNT DS    F             NUMBER OF ROWS IN RESULT SET (ITIOPEN)     02930000
COLCOUNT DS    F             NUMBER OF COLUMN NAME LIST ENTRIES         02940000
DESCRIBE DS    A             ADDR OF PORTABLE TABLE DESCRIPTION         02950000
                                                                        02960000
COSQLEOF DS    H             SQL ERROR TOKEN OFFSET                     02970000
COSQLELN DS    H             SQL ERROR TOKEN LENGTH                     02980000
                                                                        02990000
SARGTREE DS    A             ADDR OF SEARCH ARGUMENT PRED TREE ROOT     03000000
SARGPRC  DS    F             TBPSARG RETCODE                            03010000
SARGPRSN DS    F             TBPSARG REASON CODE                        03020000
                                                                        03030000
HARGNO   DS    F             NUMBER OF HOST VARIABLES #                 03040000
HARGVEC  DS    A             HOST VARIABLE ARRAY ORIGIN (TIRPARAM)      03050000
HOSVRC   DS    F             ISQLHOSV RETCODE                           03060000
HOSVRSN  DS    F             ISQLHOSV REASON CODE                       03070000
                                                                        03080000
STATREGS DS    0F,0F,0F      R15-R1 SERVICE RETURN STAT RETENTION       03090000
STATRC   DS    F                RETCODE                                 03100000
STATRSN  DS    F                RSNCODE                                 03110000
STATINFO DS    F                INFOCODE                                03120000
                                                                        03130000
*--------------------------------------------------------------         03140000
*   Plist construction workareas, row buffers, etc.                     03150000
*--------------------------------------------------------------         03160000
                                                                        03170000
$VDBGET  DS    0F,XL(GVDBPLN)   VDB GET PLIST                           03180000
$VDBLOAD DS    0F,XL(PVDBPLN)   VDB LOAD PLIST                          03190000
$TIOPEN  DS    0F,XL(TIOPENLN)  TABLE OPEN REQUEST BLOCK                03200000
$TIREAD  DS    0F,XL(TIREADLN)  TABLE READ REQUEST BLOCK                03210000
                                                                        03220000
*---------------------------------------------------------------        03230000
*   Bulk data buffers, etc.                                             03240000
*---------------------------------------------------------------        03250000
                                                                        03260000
REGSAVE  DS    16F           LOCAL REGISTER SAVEAREA #1                 03270000
REGSAVE2 DS    16F           LOCAL REGISTER SAVEAREA #2                 03280000
REGSAVEX DS    16F           LOCAL REGISTER SAVEAREA, LOWEST LEVEL      03290000
                                                                        03300000
WRK256   DS    XL256         GENERAL PURPOSE WORKAREA                   03310000
WRK1K    DS    XL1024        GENERAL PURPOSE WORKAREA                   03320000
                                                                        03330000
         #ENDWORK ,          END OF WORKAREA                            03340000
                                                                        03350000
         EJECT                                                          03360000
         QCS   ,             QUERY CONTENT SUMMARY                      03370000
                                                                        03380000
         EJECT                                                          03390000
         ICATALOG VARIABLE,COLUMN,TABLE                                 03400000
                                                                        03410000
         EJECT                                                          03420000
         @TIRSQL ,           SQL REQUEST BLOCK FORMAT                   03430000
                                                                        03440000
         EJECT                                                          03450000
         DSQLRESP ,          SQL REQUEST RESPONSE                       03460000
                                                                        03470000
         EJECT                                                          03480000
         SQLSEMAL ,          SEMANTIC ANALYSIS DATA FORMATS             03490000
                                                                        03500000
         EJECT                                                          03510000
         @TIOPEN ,           TABLE OPEN REQUEST                         03520000
                                                                        03530000
         EJECT                                                          03540000
         @TIREAD ,           TABLE READ REQUEST                         03550000
                                                                        03560000
         EJECT                                                          03570000
         TMRESP ,            TABLE RESPONSE HEADER                      03580000
                                                                        03590000
         EJECT                                                          03600000
         TIRDRET ,           TIREAD RETURN INFORMATION                  03610000
                                                                        03620000
         EJECT                                                          03630000
         TIBLOCK ,           REMOTE ACCESS TO TABLE SERVICES            03640000
                                                                        03650000
         EJECT                                                          03660000
         VDBGETP ,           VDB GET REQUEST                            03670000
                                                                        03680000
         EJECT                                                          03690000
         VDBLOADP ,          VDB LOAD REQUEST/RETURN LISTS              03700000
                                                                        03710000
         EJECT                                                          03720000
         RUMSGS ,            RU-FORMAT MESSAGE RESPONSE AREA            03730000
                                                                        03740000
         EJECT                                                          03750000
         @TBCOLDF ,          TABLE COLUMN DESCRIPTION                   03760000
                                                                        03770000
         EJECT                                                          03780000
         TBSERVIS OPEN,DESC,PSARG                                       03790000
                                                                        03800000
         EJECT                                                          03810000
         PREPSQL EQUS        SQL STATEMENT PREPARE INTERFACE CODES      03820000
                                                                        03830000
         EJECT                                                          03840000
         PREPPLAN EQUS       PLAN PREPARE INTERFACE CODES               03850000
                                                                        03860000
         EJECT                                                          03870000
         $INCR TYPE=DSECT    REQUEST PROCESSING STATISTICS              03880000
                                                                        03890000
         EJECT                                                          03900000
         $RESMGR DSECT=YES   RESOURCE MANAGER PLIST                     03910000
                                                                        03920000
         EJECT                                                          03930000
         EQUS  ,                                                        03940000
                                                                        03950000
         EJECT                                                          03960000
         $MSGDFT PREFIX=ICTPID,COMPID='SQL',TABLE=*#MSGS,              X03970000
               PRINT=NOGEN,MF=(E,WRK256)                                03980000
                                                                        03990000
         EJECT                                                          04000000
ISQLDRV  #ENTER BASE=(R12,R9),PREG=R5,SAVE=(YES,FRAME)                  04010000
                                                                        04020000
         USING ITASK,R10                                                04030000
                                                                        04040000
         EJECT                                                          04050000
**<DOC-ON>*****************************************************         04060000
*                                                                       04070000
*   Establish a recovery environment. Then acquire the QCS data         04080000
*   area and an associated general purpose STGMGR storage pool          04090000
*   for use by all SQL processing components.  A resource               04100000
*   manager is established for the QCS and all areas queued to          04110000
*   it by this rtn (the SQL driver) and all SQL processing rtns.        04120000
*                                                                       04130000
*   Because many of these data areas are used by both the SQL           04140000
*   process and the navigation (SLU) process, the $RESMGR               04150000
*   USECOUNT= facility is used to ensure that the last sharing          04160000
*   process to terminate schedules the cleanup.                         04170000
*                                                                       04180000
**<DOC-OFF>****************************************************         04190000
                                                                        04200000
         L     R2,=A(RECOVRTN)                                          04210000
         $RCVRY CREATE,(R2),PARM=(R13),MF=(E,MFE_LIST)                  04220000
                                                                        04230000
         OI    RCVFLAGS,RCVF$ENV  INDICATE RECOVERY ENVIRON ESTABLISHED 04240000
                                                                        04250000
*--------------------------------------------------------------         04260000
*   Acquire the Query Content Summary (QCS)                             04270000
*--------------------------------------------------------------         04280000
                                                                        04290000
         $GETSTOR QCSLN,OWNER=ITASK,COND=YES                            04300000
         BNZ   ERR_STG            STORAGE FAILURE                       04310000
                                                                        04320000
         LR    R8,R1              LIFE OF FUNCTION                      04330000
         ST    R8,@QCS            RETAIN RECOVERABLE QCS POINTER        04340000
         USING QCS,R8             QCS ADDRESSABILITY                    04350000
         MVC   QCSEYE,=CL4'QCS'   QUERY CONTENT SUMMARY TAG             04360000
                                                                        04370000
*--------------------------------------------------------------         04380000
*   Establish resource manager for QCS and related areas                04390000
*--------------------------------------------------------------         04400000
                                                                        04410000
         $RESMGR ADD,             ADD QCS/ASSOCIATED DATA AREAS RSMGR  X04420000
               TOKEN=RMXTOKEN,                                         X04430000
               OWNER=*TSKPCBC,                                         X04440000
               ROUTINE=*#RMXSQLW,                                      X04450000
               PARM=(R8),                                              X04460000
               USECOUNT=QCSUSECT,                                      X04470000
               MF=(E,MFE_LIST)                                          04480000
                                                                        04490000
*--------------------------------------------------------------         04500000
*   Acquire a QCS owned storage pool for SARG nodes, etc.               04510000
*--------------------------------------------------------------         04520000
                                                                        04530000
         STGINIT 512,QH=QCSGPSTG  INIT A STORAGE POOL FOR SARGS         04540000
         BNZ   ERR_STG            STORAGE FAILURE                       04550000
                                                                        04560000
         EJECT                                                          04570000
***************************************************************         04580000
*                                                                       04590000
*   Phase: INITIAL - accept versioned request plist                     04600000
*                                                                       04610000
***************************************************************         04620000
                                                                        04630000
         USING TIRSQL,R5          LIFE OF FUNCTION                      04640000
         ST    R5,SQLPLIST        RETAIN ADDR OF PLIST                  04650000
         MVC   REQLEVEL,TIRFLAG1  EXTRACT TIRSQL REQUEST LEVEL          04660000
         NI    REQLEVEL,TIRF1VER  ISOLATE IT                            04670000
                                                                        04680000
         CLI   REQLEVEL,TIRF1V11  VERSION 3 OR GREATER?                 04690000
         BL    *+10               SKIP IF NOT                           04700000
         MVC   DESCFMT(1),REQLEVEL   REQ FORMAT=TERSE TABLE DESCRIBE    04710000
                                                                        04720000
*--------------------------------------------------------------         04730000
*   extract host variable array                                         04740000
*--------------------------------------------------------------         04750000
                                                                        04760000
         LH    R0,TIRARGNO        NUMBER OF HOST VARIABLES              04770000
         ST    R0,HARGNO          RETAIN FOR LATER REFERENCE            04780000
         LA    R2,TIRSQEND        HOST VAR ARRAY ORIGIN - VER0          04790000
         ST    R2,HARGVEC         PRESUME VER0                          04800000
                                                                        04810000
         CLI   REQLEVEL,0         VERSION 0 PLIST?                      04820000
         BE    FINPLIST           DONE IF SO                            04830000
         LH    R3,TIRARGOF        OFFSET TO HOST VAR ARRAY ORIGIN       04840000
         LA    R3,TIRSQL(R3)      CONVERT OFFSET TO ADDRESS             04850000
         ST    R3,HARGVEC         HOST VAR ARRAY ORIGIN - VER1          04860000
                                                                        04870000
*--------------------------------------------------------------         04880000
*   extract dropped statement handle array                              04890000
*--------------------------------------------------------------         04900000
                                                                        04910000
         LH    R0,TIRDSNO         NUMBER OF DROPPED STATEMENT HANDLES   04920000
         ST    R0,DROPSNO         RETAIN FOR LATER REFERENCE            04930000
         LH    R3,TIRDSOF         OFFSET TO DROPPED STMT ARRAY ORIGIN   04940000
         LA    R3,TIRSQL(R3)      CONVERT OFFSET TO ADDRESS             04950000
         ST    R3,DROPSVEC        DROPPED STATMENT HANDLE ARRAY         04960000
                                                                        04970000
         MVC   STMTHNDL,TIRPHNDL  STATEMENT HANDLE, PREPARE / EXECUTE   04980000
                                                                        04990000
FINPLIST DS    0H                                                       05000000
                                                                        05010000
*--------------------------------------------------------------         05020000
*   Identify current user and project                                   05030000
*--------------------------------------------------------------         05040000
                                                                        05050000
         MVC   QCSPRJNM,BLANKS    PREPARE FOR PROJ NAME EXPANSION       05060000
         MVC   CURRPROJ,BLANKS    PROJECT NAME AT ENTRY                 05070000
                                                                        05080000
         L     R6,TSKPCBC         CURRENT PROCESS                       05090000
         USING IPCB,R6            SHORT TERM ADDRESSABILITY             05100000
         L     R7,PCBUSER         IDENTIFY THE USER                     05110000
         USING IUSER,R7           USER FORMAT                           05120000
         ST    R7,QCSIUSER        ADDR OF IUSER                         05130000
         LA    R0,USRSTG          USER STORAGE POOL ANCHOR              05140000
         ST    R0,QCSQHMSG        STORAGE POOL AVAIL FOR MESSAGING      05150000
                                                                        05160000
         MVC   QCSUSRID,USRNAME   EXTRACT USERID                        05170000
         TM    QCSUSRID,BF        USERID AVAILABLE?                     05180000
         BNZ   *+10               SKIP IF SO                            05190000
         MVC   QCSUSRID,=CL8'N/A' NOT AVAILABLE                         05200000
                                                                        05210000
         CLC   @VERXCOL,USRCLVER  TEST RELEASE LEVEL REQUIREMENT 135096 05220000
         BNH   *+8                SKIP IF ACCEPTS EXTENDED COLS  135096 05230000
         OI    RFLAGS,R$RDVER0    ELSE CONSTRAINED TO 64 COLS    135096 05240000
                                                                        05250000
         ICM   R7,15,USRPROJ      ASSOCIATED PROJECT, IF ANY            05260000
         BZ    NO_PROJ            NOT YET ESTABLISHED                   05270000
         USING IPROJ,R7           CURRENT PROJECT                       05280000
         ST    R7,QCSIPROJ        RETAIN PROJECT BLOCK ADDR             05290000
         MVC   CURRPROJ(L'PRJNAME),PRJNAME   RETAIN PROJECT NAME        05300000
         MVC   QCSPRJNM,CURRPROJ  NEW PROJ = CURR PROJ                  05310000
         LA    R0,PRJTOKEN        PROJECT SPACE TOKEN                   05320000
         ST    R0,QCSTSPAC        ASSUME ACCESS OF CURR PROJ            05330000
         DROP  R6,R7              IPCB, IPROJ                           05340000
                                                                        05350000
NO_PROJ  DS    0H                                                       05360000
                                                                        05370000
*--------------------------------------------------------------         05380000
*   drop prepared SQL statements identified in COOP RU                  05390000
*--------------------------------------------------------------         05400000
                                                                        05410000
         ICM   R0,15,DROPSNO      R0 <== NUMBER OF STATEMENTS TO DROP   05420000
         BZ    FINDROP            SKIP IF NOT                           05430000
         L     R1,DROPSVEC        STATEMENT HANDLE ARRAY ORIGIN         05440000
                                                                        05450000
         @CALL IPSBDROP,CTYPE=CVT                                       05460000
                                                                        05470000
FINDROP  DS    0H                                                       05480000
                                                                        05490000
         EJECT                                                          05500000
**<DOC-ON>*****************************************************         05510000
*                                                                       05520000
*   Phase: INITIAL (continued)                                          05530000
*                                                                       05540000
*   Plist format differs depending on the request source                05550000
*   (workbench or runtime).  In this segment, the source is             05560000
*   identified and the variable length SQL statement is located         05570000
*   and framed in QCSTMTVL, QCSTMTLN, and QCSTMTP.                      05580000
*                                                                       05590000
**<DOC-OFF>****************************************************         05600000
                                                                        05610000
         MVC   QCSCLI,TIRFUNC     REQUEST TYPE IS GLOBAL PARAMETER      05620000
         MVI   QCSOURCE,QCSS_WB   ASSUME SOURCE IS WORKBENCH            05630000
         CLI   QCSCLI,QCSC_DYN    DYNAMIC SQL (WORKBENCH)?              05640000
         BE    *+8                RUN TIME OTHERWISE                    05650000
         MVI   QCSOURCE,QCSS_RT   SOURCE IS RUNTIME                     05660000
                                                                        05670000
*--------------------------------------------------------------         05680000
*   set execution suppression / plan generation flags                   05690000
*--------------------------------------------------------------         05700000
                                                                        05710000
         CLI   QCSCLI,QCSC_PRP    PREPARE STATEMENT (DEFERRED EXEC)?    05720000
         BNE   *+8                SKIP IF NOT                           05730000
         OI    QCSEFLG2,QCS2_NXE  ELSE SUPPRESS EXECUTION               05740000
                                                                        05750000
         TM    TIRFLAG1,TIRF1PLN  PLAN RETURN?                          05760000
         BNO   *+8                                                      05770000
         OI    QCSEFLG2,QCS2_NXE+QCS2_PLN                               05780000
                                                                        05790000
         TM    TIRFLAG1,TIRF1PDE  DETAILED PLAN RETURN                  05800000
         BNO   *+8                                                      05810000
         OI    QCSEFLG2,QCS2_NXE+QCS2_PLN+QCS2_PDE                      05820000
                                                                        05830000
         LH    R2,TIRSOFST        OFFSET TO STATEMENT IF RUNTIME        05840000
         LA    R2,TIRSQL(R2)      HWORD LENGTH FOLLOWED BY TEXT         05850000
         LH    R0,0(,R2)          RETRIEVE STATEMENT LENGTH             05860000
         LTR   R0,R0              STATEMENT PROVIDED?                   05870000
         BZ    SRUNEXEC           EXPECTING SQLEXECUTE() IF NOT         05880000
                                                                        05890000
         ST    R0,QCSTMTLN        SAVED                                 05900000
         ST    R2,QCSTMTVL        USEFUL FORMAT                         05910000
         LA    R2,2(,R2)          SKIP PAST LENGTH                      05920000
         ST    R2,QCSTMTP         SAVED                                 05930000
                                                                        05940000
         BAS   R14,JRNLSQL        JOURNAL INPUT SQL STATEMENT           05950000
                                                                        05960000
*--------------------------------------------------------------         05970000
*   Determine whether table description is required in response         05980000
*--------------------------------------------------------------         05990000
                                                                        06000000
SRUNEXEC DS    0H                                                       06010000
         CLI   QCSCLI,QCSC_DYN    WORKBENCH ?                           06020000
         BE    FIN_STMT           RUN TIME OTHERWISE                    06030000
         CLI   QCSCLI,QCSC_EXE    SQLExecute() OF PREPARED STMT?        06040000
         BNE   FIN_STMT           ONWARD IF NOT                         06050000
         CLI   REQLEVEL,TIRF1V10  COOP RETAINS PREPARE() OUTPUT?        06060000
         BL    FIN_STMT           CANT SUPPRESS DESCRIBE OTHERWISE      06070000
                                                                        06080000
         OI    QFLAGS,Q$NODESC    DESCRIBE / COLUMN LIST NOT REQUIRED   06090000
                                                                        06100000
FIN_STMT DS    0H                                                       06110000
         DROP  R5                 SQL REQUEST PLIST (TIRSQL)            06120000
                                                                        06130000
**<DOC_ON>*****************************************************         06140000
*                                                                       06150000
*   Phase: INITIAL (continued)                                          06160000
*                                                                       06170000
*   Initialize the primary SQL response block in the TXP buffer         06180000
*   provided by the SQL service scheduler.  Because the proper          06190000
*   size of the buffer depends on a number of factors not yet           06200000
*   known, many of the $XPBUFR ISRT calls made in this routine          06210000
*   and its subroutines specify EXPAND=YES.  After any such             06220000
*   request, and after calling any routine that might perform           06230000
*   an ISRT, ensure that QCSRESP@ is reloaded into the                  06240000
*   appropriate base register.                                          06250000
*                                                                       06260000
**<DOC-OFF>****************************************************         06270000
                                                                        06280000
         $XPBUFR ISRT,DATALEN=DSQLLN                                    06290000
         BZ    *+8                ASSERT MINIMUM REQUIREMENT            06300000
         EX    R0,*               DENIED                                06310000
                                                                        06320000
         ST    R1,QCSRESP@        SAVE FOR LATER RECALL                 06330000
                                                                        06340000
         $XPBUFR ADDPTR,PTRS=(QCSRESP@)                                 06350000
         BZ    *+8                ASSERT MINIMUM REQUIREMENT            06360000
         EX    R0,*               DENIED                                06370000
                                                                        06380000
         EJECT                                                          06390000
**<DOC-ON>*****************************************************         06400000
*                                                                       06410000
*   Phase: PREPARE - Prepare statement for execution                    06420000
*                                                                       06430000
*   Acquire the SQL statement parse tree from ISQLPREP, or in           06440000
*   the case of an SQLExecute() of a previously prepared                06450000
*   statement, IMPORT the previously generated grammar tree and         06460000
*   semantic analysis workareas.  If the statement comes from           06470000
*   the workbench dynamic SQL facility, a runtime                       06480000
*   SQLExecDirect(), or a SQLPrepare(), statement parse and             06490000
*   semantic analysis is required.                                      06500000
*                                                                       06510000
**<DOC-OFF>****************************************************         06520000
                                                                        06530000
         CLI   REQLEVEL,0         VERSION 0 PLIST?                      06540000
         BE    PARSE              PREPARE() NOT AVAILABLE THEN          06550000
         CLI   QCSCLI,QCSC_EXE    SQLEXECUTE() ?                        06560000
         BNE   PARSE              FULL PARSE/ANALYSIS REQUIRED IF NOT   06570000
                                                                        06580000
*---------------------------------------------------------------        06590000
*   SQLExecute() of a prepared statement - locate the PSB               06600000
*---------------------------------------------------------------        06610000
                                                                        06620000
         PREPLOC STMTHNDL,NF=IMPORT_ERR                                 06630000
                                                                        06640000
         ST    R1,QCSEPSB                                               06650000
                                                                        06660000
         PREPSQL IMPORT,                                               X06670000
               PARSEINFO=QCSPARSE,                                     X06680000
               SEMANTICS=QCSSSMRY,                                     X06690000
               VDBTABLE=QCSAVDBL,                                      X06700000
               PSB=*QCSEPSB,                                           X06710000
               MF=(E,MFE_LIST)                                          06720000
                                                                        06730000
         BNZ   IMPORT_ERR         IMPORT ERROR                          06740000
                                                                        06750000
         ST    R0,QCSTMTLN        SQL STATEMENT LENGTH                  06760000
         ST    R1,QCSTMTP         SQL STATEMENT ORIGIN                  06770000
         BAS   R14,JRNLSQL        JOURNAL RECEIPT OF STATEMENT          06780000
         B     PPREPEND           RESUME AFTER INITIAL PARSE PHASE      06790000
                                                                        06800000
*---------------------------------------------------------------        06810000
*   statement parse and semantic analysis                               06820000
*---------------------------------------------------------------        06830000
                                                                        06840000
PARSE    DS    0H                                                       06850000
         LA    R1,QCS             QUERY CONTENT SUMMARY                 06860000
                                                                        06870000
         @CALL ISQLPREP           SQL STATEMENT PARSE AND ANALYSIS      06880000
                                                                        06890000
         CH    R15,=AL2(RC08)     TEST COMPLETION STATUS                06900000
         BE    PREPRESP           ERROR PREVENTS CONTINUATION           06910000
         BH    ERR_STG            STORAGE FAILURES HANDLED GENERICALLY  06920000
         B     PPREPEND                                                 06930000
                                                                        06940000
*---------------------------------------------------------------        06950000
*   SQLExecute() PSB IMPORT error encountered                           06960000
*---------------------------------------------------------------        06970000
                                                                        06980000
IMPORT_ERR     DS  0H                                                   06990000
         SQLIDCMP COMPONENT='PSB LOC-IMPORT',INFOCODE=(R15)             07000000
                                                                        07010000
         SQLSTAT ERC_PSBI                                               07020000
                                                                        07030000
         B     PREPRESP           PREPARE FOR UPDATE SQL RESPONSE BLK   07040000
                                                                        07050000
*---------------------------------------------------------------        07060000
*   statement import / parse completed without error                    07070000
*---------------------------------------------------------------        07080000
                                                                        07090000
PPREPEND DS    0H                                                       07100000
                                                                        07110000
         EJECT                                                          07120000
**<DOC-ON>******************************************************        07130000
*                                                                       07140000
*   Phase: VALIDATE - Request validation / preexecution process         07150000
*                                                                       07160000
*   In this phase, the semantic summary generated in the INITIAL        07170000
*   phase is used to identify the target project and table              07180000
*   beginning the validation and preexecution process which             07190000
*   proceeds as described below.  The order is chosen                   07200000
*   specifically to delay the project switch and/or VDB table           07210000
*   load until all validations that can be made independently           07220000
*   are performed.                                                      07230000
*                                                                       07240000
*   1) Validations that can be performed without reference to           07250000
*      the table definition are performed first.  If an error           07260000
*      is detected at this time the current project is retained.        07270000
*                                                                       07280000
*         A. SELECT joins and unions are not supported                  07290000
*         B. Updates to CATALOG tables are not permitted                07300000
*                                                                       07310000
*   2) Perform a project switch if the target project is                07320000
*      different from the current project.  In the case of a            07330000
*      SET CURRENT SQLID = statement this step alone completes          07340000
*      the request.                                                     07350000
*                                                                       07360000
*      --------                                                         07370000
*      VDB only                                                         07380000
*      --------                                                         07390000
*                                                                       07400000
*   3) If a VDB access, rebuild STN if catalog updates have             07410000
*      occurred since the last request                                  07420000
*                                                                       07430000
*   4) Load, cross-reference, and validate the VDB table definition     07440000
*                                                                       07450000
*   5) If the request is an INSERT, ISQPINS is invoked to               07460000
*      reconcile the various formats of that statement, allowing        07470000
*      the remaining code to operate on an semantic summary in          07480000
*      a single format.                                                 07490000
*                                                                       07500000
*   6) Ensure the UPDATE statement SET clause assigns only a single     07510000
*      value to each column designated.                                 07520000
*                                                                       07530000
*   7) Host variables are extracted from the SQL request block,         07540000
*      and are expanded replacing parameter markers in the              07550000
*      original statement.                                              07560000
*                                                                       07570000
*      -------------------                                              07580000
*      SYSVCAT tables only                                              07590000
*      -------------------                                              07600000
*                                                                       07610000
*   8) The predicates supplied in a WHERE clause are converted          07620000
*      to table services search argument format.                        07630000
*                                                                       07640000
**<DOC-OFF>*****************************************************        07650000
                                                                        07660000
         CLI   QCSQUERY,QCSQ_SET  SET CURRENT SQLID = STATEMENT?        07670000
         BE    PROJSET            EXPLICIT PROJECT SELECTION (ONLY)     07680000
                                                                        07690000
         L     R6,QCSSSMRY        GET SEMANTIC RESULT PTR               07700000
         USING SQSEMAL,R6         LOCAL CONVENTION                      07710000
         MVC   QCSQUERY,SQSQUERY  IDENTIFY QUERY (DML) TYPE             07720000
                                                                        07730000
         CLI   QCSQUERY,QCSQ_SEL  SELECT?                               07740000
         BNE   *+8                SKIP IF NOT                           07750000
         OI    QCSRSF,QCSR_REQ    INDICATE RESULT SET REQUESTED         07760000
                                                                        07770000
         BAS   R14,GETQOFF        ACQUIRE SYSCOLS.SCOLUSE BYTE OFFSET   07780000
         BNZ   ERR_IMPL           USED TO LINK SYSCOL TO QUERY TYPE     07790000
         STH   R1,QCSSCUSE        RETAIN BYTE # (0-3) FOR LATER USE     07800000
                                                                        07810000
*---------------------------------------------------------------        07820000
*   SQL join and union operations are not currently supported           07830000
*---------------------------------------------------------------        07840000
                                                                        07850000
         CLC   SQSATBLS+0,SQSATBLS+4                                    07860000
         BE    VTABREF            SINGLE TABLE REFERENCE                07870000
                                                                        07880000
         SQLSTAT ERC_MTRF                                               07890000
                                                                        07900000
         B     PREPRESP           PREPARE FOR UPDATE SQL RESPONSE BLK   07910000
                                                                        07920000
*---------------------------------------------------------------        07930000
*   ensure table pfxs to column names refer to the curr tables          07940000
*---------------------------------------------------------------        07950000
                                                                        07960000
VTABREF  DS    0H                                                       07970000
         L     R1,SQSATBLS        SINGLE TABLE REFERENCE                07980000
         USING SQTABREF,R1                                              07990000
                                                                        08000000
         LA    R4,SQSACOLS-(SQCOLINK-SQCOLREF)                          08010000
         USING SQCOLREF,R4        COLUMN REFERENCE                      08020000
                                                                        08030000
VTBCPFX  DS    0H                                                       08040000
         ICM   R4,15,SQCOLINK     TRAVERSE ALL REFERENCED COLUMNS       08050000
         BZ    VTBCPFXE           DONE WHEN NONE REMAIN                 08060000
                                                                        08070000
         ICM   R2,15,SQCTQ@C      TABLE NAME PREFIXES COLUMN NAME       08080000
         BZ    VTBCPFX            NO PREFIX                             08090000
         USING #CLEX_NODE_S,R2    #CLEX FORMAT                          08100000
         LH    R14,#CLEX_LENGTH   LENGTH OF TOKEN                       08110000
         CH    R14,SQTNLEN                                              08120000
         BNE   VTBNAME            TABLE NAME LENGTH MISMATCH            08130000
         LA    R15,#CLEX_TOKEN    PREFIX STRING ORIGIN                  08140000
                                                                        08150000
         CLI   0(R15),C'"'        EXTENDED FORMAT?                      08160000
         BNE   VTBCMPR            SKIP IF NOT                           08170000
         LA    R15,1(,R15)        DISCARD DLMS                          08180000
         SH    R14,=H'2'                                                08190000
         BNP   VTBCPFX                                                  08200000
                                                                        08210000
VTBCMPR  DS    0H                                                       08220000
         BCTR  R14,0              PREPARE FOR EX COPY                   08230000
         EX    R14,*+4            TABLE NAME COPY AND PAD               08240000
         MVC   TABLNAME(*-*),0(R15)  EX OBJECT                          08250000
         OC    TABLNAME,BLANKS    FOLD AND BLANK PAD TABLE NAME         08260000
         CLC   TABLNAME,SQTNAME   MATCHING TABLE NAMES?                 08270000
         BE    VTBCPFX            ALL IS WELL IF SO                     08280000
                                                                        08290000
VTBNAME  DS    0H                                                       08300000
         ST    R2,QCSECLEX        POST PROBLEM #CLEX                    08310000
                                                                        08320000
         SQLSTAT ERC_CPFX                                               08330000
                                                                        08340000
         B     PREPRESP           PREPARE FOR UPDATE SQL RESPONSE BLK   08350000
                                                                        08360000
VTBCPFXE DS    0H                                                       08370000
         DROP  R1,R4,R2           SQTABREF, SQCOLREF, #CLEX NODE        08380000
                                                                        08390000
*---------------------------------------------------------------        08400000
*   identify target table - CATALOG, SYSVCAT, or VDB                    08410000
*---------------------------------------------------------------        08420000
                                                                        08430000
         L     R1,SQSATBLS        R1 <== TABLE DESCRIPTOR               08440000
         USING SQTABREF,R1        IS A TABLE REFERENCE                  08450000
         MVC   QCSTABLE,SQTNAME   COPY/TRUNCATE TABLE NAME              08460000
         TM    SQTPROJ,BF         TABLE NAME IS QUALIFIED?              08470000
         BZ    *+10               DONE HERE IF NOT                      08480000
         MVC   QCSPRJNM(L'SQTPROJ),SQTPROJ   RETAIN LOCAL COPY          08490000
         DROP  R1                 SQTABREF                              08500000
                                                                        08510000
         MVI   QCSTTYPE,QCST_VDB  ASSUME VDB REFERENCE                  08520000
                                                                        08530000
         CLC   =C'SYS',QCSTABLE                                         08540000
         BNE   *+8                                                      08550000
         MVI   QCSTTYPE,QCST_CAT  CATALOG REFERENCE                     08560000
                                                                        08570000
         CLC   =C'SYSVCAT',QCSTABLE                                     08580000
         BNE   *+8                                                      08590000
         MVI   QCSTTYPE,QCST_VCA  VIRTUAL CATALOG REFERENCE             08600000
                                                                        08610000
*---------------------------------------------------------------        08620000
*   CATALOG tables are read only - SELECT statements only               08630000
*---------------------------------------------------------------        08640000
                                                                        08650000
         CLI   QCSTTYPE,QCST_CAT  CATALOG IS READ-ONLY                  08660000
         BNE   VTABVERF           DONE IF NON-PERSISTENT TABLE          08670000
         CLI   SQSQUERY,SQSQ_SEL  READ/ONLY REFERENCE?                  08680000
         BE    VTABVERF           CATALOG INSPECTION ALLOWED ONLY       08690000
                                                                        08700000
         SQLSTAT ERC_CATU                                               08710000
                                                                        08720000
         B     PREPRESP           PREPARE FOR UPDATE SQL RESPONSE BLK   08730000
                                                                        08740000
VTABVERF DS    0H                                                       08750000
                                                                        08760000
         EJECT                                                          08770000
**<DOC-ON>******************************************************        08780000
*                                                                       08790000
*   Run time requesters may switch projects at will.  Workbench         08800000
*   users are constrained to the current project, SYSCATLG, and         08810000
*   the execution space INTEXSPC.  When a project switch is             08820000
*   encountered the current project, if any, is closed and the          08830000
*   new project is opened.                                              08840000
*                                                                       08850000
*   Prepared statements retain pointers to entries in the STN           08860000
*   and other data areas residing in project owned storage.             08870000
*   When a project switch occurs the STN is discarded and               08880000
*   rebuilt.  This requires us to delete the prepared plans.            08890000
*   Thus, there is a performance impact when an application             08900000
*   switches frequently between projects.                               08910000
*                                                                       08920000
**<DOC-OFF>*****************************************************        08930000
                                                                        08940000
PROJSET  DS    0H                                                       08950000
         CLC   =CL8'SYSCATLG',QCSPRJNM  SYSTEM CATALOG REFERENCE?       08960000
         BNE   PROJ$EXE           SKIP IF NOT                           08970000
         MVC   QCSTSPAC,ICTSYSP@  TARGET SPACE IS SYSTEM SPACE          08980000
         B     PROJ_CPT           POST PROJECT REFERENCE                08990000
                                                                        09000000
PROJ$EXE DS    0H                                                       09010000
         CLC   =CL8'INTEXSPC',QCSPRJNM  EXECUTION SPACE?                09020000
         BNE   PROJCURR                                                 09030000
         MVC   QCSTSPAC,ICTXSPT@  TARGET SPACE IS EXECUTION SPACE       09040000
         B     PROJ_CPT           POST PROJECT REFERENCE                09050000
                                                                        09060000
PROJCURR DS    0H                                                       09070000
         CLC   QCSPRJNM,CURRPROJ  EXPLICIT REF TO CURRENT PROJ?         09080000
         BNE   PROJ_NEW           NEW PROJECT OTHERWISE                 09090000
         TM    CURRPROJ,BF        PROJECT DEFINED?                      09100000
         BZ    PROJ_ERR           ERROR IF NOT                          09110000
         B     PROJ_CPT           DONE                                  09120000
                                                                        09130000
*---------------------------------------------------------------        09140000
*   perform project switch                                              09150000
*---------------------------------------------------------------        09160000
                                                                        09170000
PROJ_NEW DS    0H                                                       09180000
         CLI   QCSOURCE,QCSS_RT   RUN-TIME REQUESTER?                   09190000
         BNE   PROJ_ERR           ONLY RUN-TIME MAY SWITCH AT WILL      09200000
                                                                        09210000
         PREPSQL PURGE            DISCARD ALL VDB REFERENCES, ETC.      09220000
                                                                        09230000
         PREPPLAN PURGE           DISCARD ALL PROJECT STORAGE REFS      09240000
                                                                        09250000
         TM    CURRPROJ,BF        PROJECT CURRENTLY ATTACHED?           09260000
         BZ    PROJ_OPEN          SKIP CLOSE IF NOT                     09270000
                                                                        09280000
         LA    R0,4               CLOSE REQUEST                         09290000
         LA    R1,CURRPROJ        CURRENT PROJECT                       09300000
                                                                        09310000
         @CALL IPRJRTA,CTYPE=CVT  INVOKE SERVICE ROUTINE                09320000
                                                                        09330000
         LTR   R15,R15            SUCCESSFUL COMPLETION?                09340000
         BNZ   PROJ_REJ           ERROR IF NOT, R1 CONTAINS RUMSGS PTR  09350000
                                                                        09360000
PROJ_OPEN DS   0H                                                       09370000
         SR    R0,R0              OPEN REQUEST                          09380000
         LA    R1,QCSPRJNM        CURRENT PROJECT                       09390000
                                                                        09400000
         @CALL IPRJRTA,CTYPE=CVT  INVOKE SERVICE ROUTINE                09410000
                                                                        09420000
         LTR   R15,R15            SUCCESSFUL COMPLETION?                09430000
         BNZ   PROJ_REJ           ERROR IF NOT, R1 CONTAINS RUMSGS PTR  09440000
                                                                        09450000
*---------------------------------------------------------------        09460000
*   extract project information, particularly its stoken                09470000
*---------------------------------------------------------------        09480000
                                                                        09490000
         L     R7,QCSIUSER        ADDRESS OF IUSER                      09500000
         ICM   R7,15,USRPROJ-IUSER(R7)  ASSOCIATED PROJECT, IF ANY      09510000
         BZ    PROJ_ERR           NOT YET ESTABLISHED                   09520000
         ST    R7,QCSIPROJ        REFRESH PROJECT POINTER               09530000
         LA    R0,PRJTOKEN-IPROJ(R7)    PROJECT SPACE TOKEN             09540000
         ST    R0,QCSTSPAC                                              09550000
         B     PROJ_CPT                                                 09560000
                                                                        09570000
*---------------------------------------------------------------        09580000
*   the project provided in a SET or DML statement is not valid         09590000
*---------------------------------------------------------------        09600000
                                                                        09610000
PROJ_ERR DS    0H                                                       09620000
         SQLSTAT ERC_PROJ                                               09630000
                                                                        09640000
         B     PROJCOMN           PREPARE FOR UPDATE SQL RESPONSE BLK   09650000
                                                                        09660000
**<DOC-ON>******************************************************        09670000
*                                                                       09680000
*   The project switch did not complete because of a failure            09690000
*   in the project manager.  Attempt to reopen the project that         09700000
*   was current at the time the request was received, if any.           09710000
*                                                                       09720000
**<DOC-OFF>*****************************************************        09730000
                                                                        09740000
PROJ_REJ DS    0H                 R1 <== ADDR OF RUMSGS OR ZERO         09750000
         LR    R5,R1              PRESERVE RUMSGS                       09760000
                                                                        09770000
*---------------------------------------------------------------        09780000
*   attempt to reestablish previous project                             09790000
*---------------------------------------------------------------        09800000
                                                                        09810000
         TM    CURRPROJ,BF        PROJECT PREVIOUSLY ATTACHED?          09820000
         BZ    PROJRCVR           SKIP RE-OPEN IF NOT                   09830000
         SR    R0,R0              OPEN REQUEST (RECOVERY)               09840000
         LA    R1,CURRPROJ        CURRENT PROJECT                       09850000
                                                                        09860000
         @CALL IPRJRTA,CTYPE=CVT  INVOKE SERVICE ROUTINE                09870000
                                                                        09880000
*---------------------------------------------------------------        09890000
*   transfer diagnostic messages provided                               09900000
*---------------------------------------------------------------        09910000
                                                                        09920000
PROJRCVR DS    0H                                                       09930000
         SQLSTAT ERC_REJP                                               09940000
                                                                        09950000
         LTR   R1,R5              RUMSGS PROVIDED?                      09960000
         BZ    PROJRCVE           DONE IF NOT                           09970000
         BAS   R14,URUMSGS        ELSE UNLOAD RU-STYLE MESSAGES         09980000
                                                                        09990000
         $RETSTOR (R5)            RELEASE MESSAGE RETURN AREA           10000000
                                                                        10010000
PROJRCVE DS    0H                                                       10020000
                                                                        10030000
**<DOC-ON>******************************************************        10040000
*                                                                       10050000
*   If the project reference was included in a standard SQL DML         10060000
*   statement, identify the #CLEX defining the project name.            10070000
*   However, the SET statement is not parsed with the same              10080000
*   facility and no #CLEX is available in that case.                    10090000
*                                                                       10100000
**<DOC-OFF>*****************************************************        10110000
                                                                        10120000
PROJCOMN DS    0H                 COMMON PROJECT ERROR HANDLING         10130000
         CLI   QCSQUERY,QCSQ_SET  SET STATEMENT?                        10140000
         BE    PROJEFIN           NO PPL#CR INFO IF SO                  10150000
                                                                        10160000
         L     R6,QCSSSMRY        SEMANTIC SUMMARY ORIGIN               10170000
         USING SQSEMAL,R6         SEMANTIC SUMMARY HEADER FORMAT        10180000
         L     R2,SQSATBLS        TABLE REFERENECE                      10190000
         MVC   QCSECLEX,SQTPRJ@C-SQTABREF(R2)  TABLE QUAL #CLEX OR ZERO 10200000
         DROP  R6                 SQSEMAL (SEMANTIC SUMMARY)            10210000
                                                                        10220000
PROJEFIN DS    0H                                                       10230000
         B     PREPRESP                                                 10240000
                                                                        10250000
**<DOC-ON>******************************************************        10260000
*                                                                       10270000
*   The project switch completed without error.  Establish the          10280000
*   new project as the current project.  If the project switch          10290000
*   was performed on behalf of a SET CURRENT SQLID statement,           10300000
*   processing is complete.                                             10310000
*                                                                       10320000
**<DOC-OFF>*****************************************************        10330000
                                                                        10340000
PROJ_CPT DS    0H                                                       10350000
         MVC   CURRPROJ,QCSPRJNM  ESTABLISH CURRENT PROJECT             10360000
         CLI   QCSQUERY,QCSQ_SET  SET CURRENT SQLID = ?                 10370000
         BE    NORMRET            DONE IF SO                            10380000
                                                                        10390000
         EJECT                                                          10400000
**<DOC-ON>*****************************************************         10410000
*                                                                       10420000
*   Initial build or refresh of the STN is required if it has           10430000
*   either not yet been built or if a project catalog update            10440000
*   impacts the structures built previously.                            10450000
*                                                                       10460000
**<DOC-OFF>****************************************************         10470000
                                                                        10480000
         CLI   QCSTTYPE,QCST_CAT  CATALOG REFERENCE?                    10490000
         BE    BLDSTFIN           NO STN DEPENDENCE IF SO               10500000
                                                                        10510000
         $NAVBLD STN,MF=(E,MFE_LIST)  CONSTRUCT THE STN                 10520000
                                                                        10530000
         BNZ   ERR_NBLD           STN CONSTRUCTION ERROR                10540000
                                                                        10550000
BLDSTFIN DS    0H                                                       10560000
                                                                        10570000
         EJECT                                                          10580000
****************************************************************        10590000
*                                                                       10600000
*   Identify table type and begin target-specific validation.           10610000
*   Validation is complete for persistent (catalog) tables.             10620000
*   Transient table types (VDB and virtual catalog) minimally           10630000
*   require resolution of host variables and SARG construction.         10640000
*                                                                       10650000
****************************************************************        10660000
                                                                        10670000
         L     R6,QCSSSMRY        SEMANTIC SUMMARY ORIGIN               10680000
         USING SQSEMAL,R6         SEMANTIC SUMMARY HEADER FORMAT        10690000
                                                                        10700000
         CLI   QCSTTYPE,QCST_CAT  CATALOG REFERENCE?                    10710000
         BE    VALIDATE_CPT       VALIDATION COMPLETE IF SO             10720000
                                                                        10730000
         CLI   QCSTTYPE,QCST_VDB  VDB REFERENCE?                        10740000
         BE    VDBSTART                                                 10750000
                                                                        10760000
         EJECT                                                          10770000
****************************************************************        10780000
*                                                                       10790000
*   Begin SYSVCAT-specific validation                                   10800000
*                                                                       10810000
****************************************************************        10820000
                                                                        10830000
*---------------------------------------------------------------        10840000
*   Resolve host variables                                              10850000
*---------------------------------------------------------------        10860000
                                                                        10870000
         BAS   R14,$HOSTVAR       RESOLVE HOST VARIABLES                10880000
         LTR   R15,R15            ERRORS ENCOUNTERED?                   10890000
         BNZ   PREPRESP           TERMINATE AND RESPOND IF SO           10900000
                                                                        10910000
*---------------------------------------------------------------        10920000
*   Convert the where clause to a table services SARG                   10930000
*---------------------------------------------------------------        10940000
                                                                        10950000
         LA    R1,SQSEMAL         R1 <== SEMANTIC SUMMARY               10960000
         BAS   R14,$SARG          GENERATE TABLE SERVICES SARG          10970000
         LTR   R15,R15            COMPLETED WITHOUT ERROR?              10980000
         BNZ   ERR_STG            STORAGE FAILURE OTHERWISE             10990000
                                                                        11000000
         ST    R1,SARGTREE        SEARCH ARGUMENT TREE ORIGIN           11010000
                                                                        11020000
         B     VALIDATE_CPT       VALIDATION COMPLETE                   11030000
                                                                        11040000
         EJECT                                                          11050000
**<DOC-ON>******************************************************        11060000
*                                                                       11070000
*   Begin VDB-specific validation                                       11080000
*                                                                       11090000
*   Acquire shared access to the referenced VDB table definition        11100000
*   if it was not previously acquired via import of a prepared          11110000
*   statement.  Not that VDBGET may, in turn, invoke VDBLOAD so         11120000
*   a suitable VBDBLOAD parameter list must be constructed.             11130000
*                                                                       11140000
**<DOC-OFF>*****************************************************        11150000
                                                                        11160000
VDBSTART DS    0H                                                       11170000
         ICM   R0,15,QCSAVDBL     VDB DEFINITION REUSE?                 11180000
         BNZ   VDBHOSTV           SQLPrepare ACQUIRED/VALIDATED IF SO   11190000
                                                                        11200000
         LA    R5,$VDBLOAD        VDB LOAD PLIST                        11210000
         USING VDBLOADP,R5        FORMAT                                11220000
         LA    R0,QCSPRJNM        PROJECT NAME                          11230000
         ST    R0,PVDBPROJ                                              11240000
         LA    R0,QCSTABLE        TABLE NAME                            11250000
         ST    R0,PVDBTABL                                              11260000
         MVC   PVDBQTYP,SQSQUERY  QUERY TYPE                            11270000
                                                                        11280000
         LA    R1,$VDBGET         R1 <== VDB GET PLIST                  11290000
         USING VDBGETP,R1         PLIST CONSTRUCTION                    11300000
         ST    R5,GVDBLOAD        VDBLOADP REQUEST BLOCK AS PARM        11310000
         LA    R0,WRK1K           MESSAGE CONSTRUCTION AREA             11320000
         ST    R0,GVDBMSGA                                              11330000
         LA    R0,L'WRK1K         MESSAGE CONSTRUCTION AREA LENGTH      11340000
         ST    R0,GVDBMSGL                                              11350000
         DROP  R1,R5              VDBGETP, VDBLOADP                     11360000
                                                                        11370000
         @CALL IVDBGET,CTYPE=CVT,WKA=WRK256   PLIST IN R1               11380000
                                                                        11390000
         B     *+4(R15)           ANALYZE COMPLETION STATUS             11400000
         B     VDBAVAIL              RC00 - VDB GET COMPLETE            11410000
         B     VDB_ERR1              RC04 - INVALID PROJECT REF         11420000
         B     VDB_ERR2              RC08 - VDB MISSING OR INVALID      11430000
         B     ERR_TBSV              RC12 - TABLE SERVICES FAILURE      11440000
         B     ERR_STG               RC16 - STORAGE FAILURE             11450000
         EX    R0,*                  RC20 - CANNOT OCCUR                11460000
         B     VDB_EXRF              RC24 - VDB COL/VAR XREF ERROR      11470000
                                                                        11480000
VDBAVAIL DS    0H                                                       11490000
         ST    R1,QCSAVDBL        ANCHOR RETURNED VDBLRET IN THE QCS    11500000
         B     VDBCPT             VDB GET COMPLETE                      11510000
                                                                        11520000
*---------------------------------------------------------------        11530000
*   VDB definition load failure  - invalid project reference            11540000
*---------------------------------------------------------------        11550000
                                                                        11560000
VDB_ERR1 DS    0H                                                       11570000
         LR    R2,R0              RETAIN REASON CODE                    11580000
         SLL   R2,16              IVDBLOAD RSN CODE                     11590000
         OR    R2,R15             COMBINE WITH RETCODE                  11600000
         ST    R2,QCSEINFO        USEFUL DIAGNOSTIC                     11610000
                                                                        11620000
         SQLSTAT ERC_PROJ,INFO=(R2)                                     11630000
                                                                        11640000
         SQLMSG 030,031                                                 11650000
                                                                        11660000
         B     VDB_ERRX           COMMON MSG LOGIC                      11670000
                                                                        11680000
*---------------------------------------------------------------        11690000
*   VDB definition load failure - VDB missing or invalid                11700000
*---------------------------------------------------------------        11710000
                                                                        11720000
VDB_ERR2 DS    0H                                                       11730000
         LR    R2,R0              PRESERVE IVDBLOAD REASON CODE         11740000
         SLL   R0,16              MOVE TO HIGH ORDER                    11750000
         OR    R0,R15             COMBINE WITH RETCODE                  11760000
         ST    R0,QCSEINFO        USEFUL DIAGNOSTIC                     11770000
                                                                        11780000
         SQLSTAT ERC_VDB,INFO=(R0)                                      11790000
                                                                        11800000
         SQLMSG 030,*MSGLVDBX(R2)                                       11810000
                                                                        11820000
*---------------------------------------------------------------        11830000
*   common VDB error analysis                                           11840000
*---------------------------------------------------------------        11850000
                                                                        11860000
VDB_ERRX DS    0H                 POST MSGS FOR RETURN                  11870000
         L     R1,SQSATBLS        TABLE DESCRIPTOR                      11880000
         MVC   QCSECLEX,SQT@C-SQTABREF(R1) IDENTIFY OFFENDING #CLEX     11890000
         B     PREPRESP           COMPLETE                              11900000
                                                                        11910000
*---------------------------------------------------------------        11920000
*   XREF failure - variables missing for one or more columns            11930000
*---------------------------------------------------------------        11940000
                                                                        11950000
VDB_EXRF DS    0H                                                       11960000
         SQLSTAT ERC_CLVR                                               11970000
                                                                        11980000
         LA    R1,WRK1K           MESSAGES IN $MSGBUF FORMAT            11990000
         BAS   R14,MSGBPROC       DELIVER MESSAGE LIST                  12000000
         B     PREPRESP           PREPARE FOR UPDATE SQL RESPONSE BLK   12010000
                                                                        12020000
VDBCPT   DS    0H                                                       12030000
                                                                        12040000
         EJECT                                                          12050000
**<DOC-ON>******************************************************        12060000
*                                                                       12070000
*   SQL INSERT only                                                     12080000
*                                                                       12090000
*   The INSERT statement has two forms.  ISQPINS ensures that           12100000
*   the internal representations for the two are consistent by          12110000
*   associating column values from the VALUES clause with the           12120000
*   corresponding column names.  The result is a single semantic        12130000
*   summary format.  Note that ISQPINS may modify (add to) the          12140000
*   list of all referenced colums (SQSACOLS).                           12150000
*                                                                       12160000
**<DOC-OFF>*****************************************************        12170000
                                                                        12180000
         CLI   QCSQUERY,QCSQ_INS  INSERT STATEMENT?                     12190000
         BNE   SAINSEND           DOES NOT APPLY OTHERWISE              12200000
                                                                        12210000
         @CALL ISQPINS,(SQSEMAL,*QCSAVDBL),                            X12220000
               WKA=WRK256,                                             X12230000
               MF=(E,MFE_LIST)                                          12240000
                                                                        12250000
         B     *+4(R15)           ANALYZE COMPLETION                    12260000
         B     SAINSEND           INSERT STATEMENT ANALYSIS COMPLETE    12270000
         EX    R0,*               NOT DEFINED                           12280000
         B     SAINSERR           INVALID INSERT REQUEST                12290000
         B     ERR_STG            STORAGE MANAGEMENT ERROR              12300000
                                                                        12310000
SAINSERR DS    0H                 INVALID INSERT REQUEST                12320000
         LR    R2,R0              REASON CODE AS BRANCH BASE            12330000
         B     *+4(R2)            DETERMINE REASON FOR FAILURE          12340000
         B     INS_ERR_VALUES        RSN00: VALUES OMITTED OR TOO LARGE 12350000
         B     INS_ERR_MISMATCH      RSN04: VALUES / COLUMNS MISMATCH   12360000
         B     INS_ERR_DUPCOL        RSN08: MULT REFS TO SAME COLUMN    12370000
                                                                        12380000
*---------------------------------------------------------------        12390000
*   insert statement completion or termination                          12400000
*---------------------------------------------------------------        12410000
                                                                        12420000
INS_ERR_VALUES   DS 0H            MISSING OR EXCESSIVE VALUES() CLAUSE  12430000
         SQLSTAT ERC_IVAL                                               12440000
                                                                        12450000
         B     PREPRESP                                                 12460000
                                                                        12470000
INS_ERR_MISMATCH DS 0H            VALUES CLAUSE MISMATCHES COLUMN LIST  12480000
         SQLSTAT ERC_IMAT                                               12490000
                                                                        12500000
         B     PREPRESP                                                 12510000
                                                                        12520000
INS_ERR_DUPCOL   DS 0H            COLUMN NAME DUPLICATED IN COLUMN LIST 12530000
         SQLSTAT ERC_ICOL                                               12540000
                                                                        12550000
         B     PREPRESP                                                 12560000
                                                                        12570000
SAINSEND DS    0H                                                       12580000
                                                                        12590000
         EJECT                                                          12600000
**<DOC-ON>*****************************************************         12610000
*                                                                       12620000
*   Validate all VDB column references made in the query and            12630000
*   associate their column summary nodes (SQCOLREF) with the            12640000
*   addresses of the corresponding SYSVARIABLE and SYSCOLUMNs           12650000
*   entries brought in by VDBGET.                                       12660000
*                                                                       12670000
**<DOC-OFF>****************************************************         12680000
                                                                        12690000
         ICM   R4,15,SQSACOLS     LIST OF ALL REFERENCED COLUMNS        12700000
         BZ    VDBVFIN            ALL REFERENCES ARE IMPLICIT           12710000
         USING SQCOLREF,R4        COLUMN REFERENCE                      12720000
                                                                        12730000
*--------------------------------------------------------------         12740000
*   validate all columns referenced by name                             12750000
*--------------------------------------------------------------         12760000
                                                                        12770000
VDBVCOL  DS    0H                                                       12780000
         LA    R1,SQCOLNM         R1 <== COLUMN NAME FROM STMT          12790000
         BAS   R14,$FCOL          FIND COLUMN, DEFER RETCODE TEST       12800000
                                                                        12810000
         LR    R2,R1              ATTACH SYSCOLUMNS ENTRY               12820000
         ST    R2,SQCSYSC                                               12830000
         USING SYSCOLS,R2                                               12840000
                                                                        12850000
         LR    R5,R0                                                    12860000
         ST    R5,SQCSYSV         ATTACH SYSVARIABLES ENTRY             12870000
         USING SVARSECT,R5                                              12880000
                                                                        12890000
         L     R1,SQCOL@C         #CLEX OF FIRST ENCOUNTER WITH COLUMN  12900000
         LTR   R15,R15            COLUMN LOCATED?                       12910000
         BNZ   ERR_CREF           POST ERROR AND EXIT                   12920000
                                                                        12930000
*--------------------------------------------------------------         12940000
*   summarize the data type                                             12950000
*--------------------------------------------------------------         12960000
                                                                        12970000
         MVI   SQCDTYPE,$CHAR     ASSUME CHARACTER DATATYPE             12980000
         CLI   SCOLTYPE,SC$CHAR   ASSUMPTION CORRECT?                   12990000
         BE    VDBDTYPE           SKIP IF SO                            13000000
                                                                        13010000
         MVI   SQCDTYPE,$NUMBR    GENERIC NUMERIC DATATYPE              13020000
         MVI   SQCNTYPE,$NTINT    AN INTEGER IN PARTICULAR              13030000
                                                                        13040000
VDBDTYPE DS    0H                                                       13050000
                                                                        13060000
*--------------------------------------------------------------         13070000
*   scan all referenced columns                                         13080000
*--------------------------------------------------------------         13090000
                                                                        13100000
         ICM   R4,15,SQCOLINK     ADVANCE TO NEXT COLUMN ENTRY          13110000
         BNZ   VDBVCOL            VALIDATE ALL COLUMN REFERENCES        13120000
         DROP  R4,R2,R5           SQCOLREF, SYSCOLUMN, SYSVARIABLE      13130000
                                                                        13140000
VDBVFIN  DS    0H                 END OF VDB COL VALIDATION             13150000
                                                                        13160000
         EJECT                                                          13170000
**<DOC-ON>*****************************************************         13180000
*                                                                       13190000
*   SQL UPDATE - VDB SQLPrepare() and SQLExecDirect() only              13200000
*                                                                       13210000
*   Validate the content of the SET clause in the UPDATE                13220000
*   statement.  Tag all columns that appear in the SET clause           13230000
*   ensuring that a column is referred to at most once.                 13240000
*                                                                       13250000
**<DOC-OFF>****************************************************         13260000
                                                                        13270000
         ICM   R5,15,SQSASETS     LIST OF COLUMN VALUE ASSIGNMENTS      13280000
         BZ    USETFIN            CLAUSE OMITTED (PGMERROR)             13290000
         USING SBPTERM,R5         PREDICATE FORMAT                      13300000
                                                                        13310000
USETVERF DS    0H                 ENSURE 'SET' OF INPUT COL VARS ONLY   13320000
         L     R1,SBPCOL@C        R1 <== #CLEX IN EVENT OF ERROR        13330000
         L     R4,SBPACOL         LOCATE REFERENCED COLUMN              13340000
         USING SQCOLREF,R4        COLUMN SUMMARY                        13350000
                                                                        13360000
         TM    SQCFLAGS,SQCF$SET  VALUE ASSIGNMENT PREVIOUSLY SET?      13370000
         BO    UPD_ERR_CNFL       ERROR IF SO                           13380000
         OI    SQCFLAGS,SQCF$SET  VALUE ASSIGNMENT ESTABLISHED          13390000
                                                                        13400000
         ICM   R5,15,SBPLINK      ADVANCE TO NEXT COLUMN ASSIGNMENT     13410000
         BNZ   USETVERF           INSPECT ALL ASSIGNMENTS               13420000
         B     USETFIN            COMPLETE                              13430000
                                                                        13440000
*--------------------------------------------------------------         13450000
*   Update statement completion or termination                          13460000
*--------------------------------------------------------------         13470000
                                                                        13480000
UPD_ERR_CNFL   DS  0H             CONFLICTING COLUMN VALUES             13490000
         ST    R1,QCSECLEX        RETURN CLEX ENTRY IF AVAILABLE        13500000
                                                                        13510000
         SQLSTAT ERC_CNFL                                               13520000
                                                                        13530000
         B     PREPRESP                                                 13540000
                                                                        13550000
USETFIN  DS    0H                                                       13560000
         DROP  R4,R5              SQCOLREF, SBPTERM                     13570000
                                                                        13580000
         EJECT                                                          13590000
***************************************************************         13600000
*                                                                       13610000
*   Replace host variable markers delivered from a run-time             13620000
*   SQLExecute() or SQLExecDirect() with the instantiations             13630000
*   provided in the request plist.                                      13640000
*                                                                       13650000
***************************************************************         13660000
                                                                        13670000
VDBHOSTV DS    0H                                                       13680000
         BAS   R14,$HOSTVAR       RESOLVE HOST VARIABLES                13690000
         LTR   R15,R15            ERRORS ENCOUNTERED?                   13700000
         BNZ   PREPRESP           TERMINATE AND RESPOND IF SO           13710000
                                                                        13720000
VALIDATE_CPT   DS  0H                                                   13730000
                                                                        13740000
         EJECT                                                          13750000
**<DOC-ON>******************************************************        13760000
*                                                                       13770000
*   Phase: EXECUTE - All target table types                             13780000
*                                                                       13790000
*   At this point, the SQL DML statement has been syntactically         13800000
*   and semantically validated and is ready for execution.  If          13810000
*   the statement is packaged in a SQLPrepare() request, a PSB          13820000
*   is constructed now.                                                 13830000
*                                                                       13840000
**<DOC-OFF>*****************************************************        13850000
                                                                        13860000
         CLI   QCSCLI,QCSC_PRP    PREPARE STATEMENT?                    13870000
         BNE   PRE_FIN            NO                                    13880000
         CLI   REQLEVEL,0         VERSION 0 PLIST?                      13890000
         BE    PRE_FIN            NO                                    13900000
                                                                        13910000
         OC    STMTHNDL,STMTHNDL  COOP ASSIGNED A STATEMENT HANDLE?     13920000
         BZ    PRE_FIN            COMPATIBILITY, ETC.                   13930000
                                                                        13940000
         PREPINIT STMTHNDL,*QCSTMTVL CONSTRUCT A PSB                    13950000
                                                                        13960000
         ST    R1,QCSEPSB         RETAIN ADDRESS OF PSB                 13970000
         L     R5,QCSRESP@        SQL RESPONSE HEADER                   13980000
         MVI   DSQLPREP-DSQLRESP(R5),TRUE   INDICATE PREPARE COMPLETED  13990000
                                                                        14000000
PRE_FIN  DS    0H                                                       14010000
                                                                        14020000
         EJECT                                                          14030000
**<DOC-ON>******************************************************        14040000
*                                                                       14050000
*   Phase: EXECUTE - PERSISTENT (catalog) tables                        14060000
*                                                                       14070000
*   If the SQL request targets a CATALOG (prematerialized)              14080000
*   table, we are assurred that it is a select statement                14090000
*   because the catalog cannot be updated using SQL. In this            14100000
*   case, a table services search argument can be formed from           14110000
*   the table description.  Because the table already exists,           14120000
*   the search argument will later be applied as a row filter           14130000
*   just as in a traditional DBMS.                                      14140000
*                                                                       14150000
**<DOC_OFF>*****************************************************        14160000
                                                                        14170000
         L     R6,QCSSSMRY        SEMANTIC SUMMARY ORIGIN               14180000
         USING SQSEMAL,R6         SEMANTIC SUMMARY HEADER FORMAT        14190000
                                                                        14200000
         CLI   QCSTTYPE,QCST_CAT  CATALOG REFERENCE?                    14210000
         BNE   EXEQUERY           STANDARD EXECUTION OTHERWISE          14220000
                                                                        14230000
         TBOPEN QCSTABLE,                                              X14240000
               STOKEN=*QCSTSPAC,                                       X14250000
               TTOKEN=QCSTTOKN,                                        X14260000
               MF=(E,MFE_LIST)                                          14270000
                                                                        14280000
         LTR   R15,R15            TABLE OPENED?                         14290000
         BZ    CAT_DESC           MOST LIKELY NO SUCH TABLE IF NOT      14300000
                                                                        14310000
*---------------------------------------------------------------        14320000
*   undefined catalog component table                                   14330000
*---------------------------------------------------------------        14340000
                                                                        14350000
         L     R1,SQSATBLS        TABLE REFERENECE                      14360000
         MVC   QCSECLEX,SQT@C-SQTABREF(R1)                              14370000
                                                                        14380000
         SQLSTAT ERC_CTAB                                               14390000
                                                                        14400000
         B     PREPRESP           PREPARE FOR UPDATE SQL RESPONSE BLK   14410000
                                                                        14420000
*---------------------------------------------------------------        14430000
*   if request for plan only, request is now complete                   14440000
*---------------------------------------------------------------        14450000
                                                                        14460000
CAT_DESC DS    0H                                                       14470000
         TM    QCSEFLG2,QCS2_PLN+QCS2_PDE                               14480000
         BZ    CAT_DESCRIBE                                             14490000
                                                                        14500000
         SQLSTAT ERC_CATPLAN                                            14510000
                                                                        14520000
         B     PREPRESP           PREPARE FOR UPDATE SQL RESPONSE BLK   14530000
                                                                        14540000
****************************************************************        14550000
*                                                                       14560000
*   Acquire table description                                           14570000
*                                                                       14580000
****************************************************************        14590000
                                                                        14600000
CAT_DESCRIBE   DS   0H                                                  14610000
         TBDESC TTOKEN=QCSTTOKN,  TABLE DESCRIPTION                    X14620000
               LINK=OFFSET,       RETURN OFFLINKS, STANDARD FORMAT     X14630000
               MF=(E,MFE_LIST)                                          14640000
                                                                        14650000
         LTR   R15,R15            DESCRIPTION ACQUIRED?                 14660000
         BNZ   ERR_TBSV           NOTHING OF VALUE RETURNED             14670000
                                                                        14680000
         ST    R1,QCSDESC@        ADDR OF TABLE DESCRIPTOR              14690000
         ST    R0,QCSDESCL        LENGTH OF TABLE DESCRIPTOR            14700000
                                                                        14710000
****************************************************************        14720000
*                                                                       14730000
*   Validate all catalog column references made in query                14740000
*                                                                       14750000
****************************************************************        14760000
                                                                        14770000
         ICM   R4,15,SQSACOLS     LIST OF ALL REFERENCED COLUMNS        14780000
         BZ    CATCOLSE           ALL REFERENCES ARE IMPLICIT           14790000
         USING SQCOLREF,R4        COLUMN REFERENCE                      14800000
                                                                        14810000
CATVALC  DS    0H                                                       14820000
         L     R0,QCSDESC@        R0 <== TABLE DESCRIPTION              14830000
         LA    R1,SQCOLNM         R1 <== COLUMN NAME FROM STMT          14840000
         BAS   R14,$CLOCDEF       FIND CORRESPONDING COLDEF             14850000
         LTR   R15,R15            COLUMN LOCATED?                       14860000
         BNZ   CATCERR            INVALID COLUMN NAME, CLEX IN R1       14870000
                                                                        14880000
         MVC   SQCDTYPE(2),TBCDTYPE-TBCOLDEF(R1) STORE DATA TYPE        14890000
         ICM   R4,15,SQCOLINK     ADVANCE TO NEXT COLUMN ENTRY          14900000
         BNZ   CATVALC            PROCESS ENTIRE LIST                   14910000
         B     CATCOLSE           CONTINUE                              14920000
                                                                        14930000
CATCERR  DS    0H                                                       14940000
         L     R1,SQCOL@C         #CLEX OF FIRST ENCOUNTER WITH COLUMN  14950000
         ICM   R3,15,SQSAORDC     WAS AN ORDER-BY CLAUSE USED?          14960000
         BZ    ERR_CREF           NO - THEN PROCESS THE COLREF ERROR    14970000
         C     R1,SQR@C-SQREFP(R3)    IS IT OUR ORDER-BY COLUMN?        14980000
         BNE   ERR_CREF           NO THEN PROCESS THE COLREF ERROR      14990000
         ICM   R4,15,SQCOLINK     ADVANCE TO NEXT COLUMN ENTRY          15000000
         BNZ   CATVALC            PROCESS ENTIRE LIST                   15010000
         DROP  R4                                                       15020000
                                                                        15030000
CATCOLSE DS    0H                                                       15040000
                                                                        15050000
*---------------------------------------------------------------        15060000
*   order-by clause in catalog ref names a predefined index only        15070000
*---------------------------------------------------------------        15080000
                                                                        15090000
         ICM   R4,15,SQSAORDC     IS AN ORDER BY CLAUSE PRESENT?        15100000
         BZ    CATORDX            SKIP SECTION IF NOT                   15110000
                                                                        15120000
         L     R4,SQRNODE-SQREFP(,R4)  GET SQL COLUMN REFERENCE         15130000
         USING SQCOLREF,R4        COLUMN ENTRY FORMAT                   15140000
         MVC   QCSTNDX,=CL8' '    BLANK OUT INDEX NAME AREA             15150000
         LH    R2,SQCOLNML        LENGTH OF COLUMN NAME                 15160000
         BCTR  R2,0               PREPARE FOR EX                        15170000
         EX    R2,*+4             MOVE THE COLUMN NAME INTO KEY INDEX   15180000
         MVC   QCSTNDX(*-*),SQCOLNM                                     15190000
         DROP  R4                 SQCOLREF                              15200000
                                                                        15210000
CATORDX  DS    0H                                                       15220000
                                                                        15230000
         EJECT                                                          15240000
***************************************************************         15250000
*                                                                       15260000
*   Resolve host variables                                              15270000
*                                                                       15280000
***************************************************************         15290000
                                                                        15300000
         BAS   R14,$HOSTVAR       RESOLVE HOST VARIABLES                15310000
         LTR   R15,R15            ERRORS ENCOUNTERED?                   15320000
         BNZ   PREPRESP           TERMINATE AND RESPOND IF SO           15330000
                                                                        15340000
****************************************************************        15350000
*                                                                       15360000
*   Convert the where clause to a table services SARG                   15370000
*                                                                       15380000
****************************************************************        15390000
                                                                        15400000
         LA    R1,SQSEMAL         R1 <== SEMANTIC SUMMARY               15410000
         BAS   R14,$SARG          GENERATE TABLE SERVICES SARG          15420000
         LTR   R15,R15            COMPLETED WITHOUT ERROR?              15430000
         BNZ   ERR_STG            STORAGE FAILURE OTHERWISE             15440000
                                                                        15450000
         ST    R1,SARGTREE        SEARCH ARGUMENT TREE ORIGIN           15460000
                                                                        15470000
***************************************************************         15480000
*                                                                       15490000
*   Provide execution tree (SARG) linkages to stored columns            15500000
*                                                                       15510000
***************************************************************         15520000
                                                                        15530000
         ICM   R2,15,SARGTREE     NEED EXECUTION TREE FOR WHERE CLAUSE? 15540000
         BZ    CATITREE           NOT USED                              15550000
                                                                        15560000
         TBPSARG TTOKEN=QCSTTOKN, BIND TO TABLE                        X15570000
               SARGS=(R2),                                             X15580000
               XSTGMGR=(IGENCSTG,QCSGPSTG,WRK256),                     X15590000
               MF=(E,MFE_LIST)                                          15600000
                                                                        15610000
         ST    R15,QCSPSARC       POST TBPSARG RETCODE                  15620000
         ST    R0,QCSPSARS        POST TBPSARG RSNCODE                  15630000
         LTR   R15,R15            NORMAL COMPLETION?                    15640000
         BNZ   ERR_SARG           TERMINATE IF NOT                      15650000
                                                                        15660000
CATITREE DS    0H                                                       15670000
         B     POSTEXEC           JOIN POST EXECUTION ANALYSIS          15680000
                                                                        15690000
         EJECT                                                          15700000
**<DOC-ON>*****************************************************         15710000
*                                                                       15720000
*   Phase: EXECUTE - non-PERSISTENT tables                              15730000
*                                                                       15740000
*   When the SQL statement targets a VDB (virtual) table,               15750000
*   ISQLVDB is invoked to define the result set and drive               15760000
*   the navigation process responsible for materializing it.            15770000
*                                                                       15780000
*   If the SQL statement targets a VIRTUAL CATALOG (SYSVCAT)            15790000
*   table, its much the same thing without the navigation.              15800000
*   An appropriate SQL executor is selected to materialize              15810000
*   the result set.                                                     15820000
*                                                                       15830000
**<DOC-OFF>****************************************************         15840000
                                                                        15850000
EXEQUERY DS    0H                                                       15860000
         MVC   QCSSITRE,SARGTREE  WHERE-CLAUSE PREDICATE TREE           15870000
         MVC   QCSQUERY,SQSQUERY  QUERY TYPE CODE                       15880000
                                                                        15890000
         L     R15,=V(ISQLVDB)    ASSUME VDB TARGET                     15900000
         CLI   QCSTTYPE,QCST_VDB                                        15910000
         BE    EXEC                                                     15920000
                                                                        15930000
         L     R15,=V(ISQLVCAT)   ASSUME SYSVCAT TARGET                 15940000
         CLI   QCSTTYPE,QCST_VCA                                        15950000
         BE    EXEC               (EXPANSION ALONG THESE LINES LIKELY)  15960000
                                                                        15970000
EXEC     DS    0H                 INVOKE EXECUTOR                       15980000
         LA    R1,QCS             QUERY CONTENT SUMMARY                 15990000
         @CALL (R15),WKA=WRK1K    INVOKE EXECUTOR                       16000000
                                                                        16010000
*---------------------------------------------------------------        16020000
*   acquire terminal APPL / state info for VDB directed queries         16030000
*---------------------------------------------------------------        16040000
                                                                        16050000
         CLI   QCSTTYPE,QCST_VDB  VDB DIRECTED QUERY?                   16060000
         BNE   FVSESS             VSESS INFO NOT RETURNED OTHERWISE     16070000
         CLI   QCSOURCE,QCSS_WB   WORKBENCH ORIGINATION?                16080000
         BNE   FVSESS             VSESS INFO NOT RETURNED OTHERWISE     16090000
                                                                        16100000
         LA    R1,QCS             R1 <== QUERY CONTENT SUMMARY          16110000
                                                                        16120000
         @CALL IVDBVSES,CTYPE=CVT REPORT SESSION STATUS                 16130000
                                                                        16140000
         LTR   R0,R0              SESSION DESCRIPTORS POSTED?           16150000
         BZ    FVSESS             SKIP IF NOT                           16160000
                                                                        16170000
         L     R5,QCSRESP@        RELOCATED? SQL RESPONSE HEADER        16180000
         USING DSQLRESP,R5        PREPARE FOR UPDATE                    16190000
         SR    R1,R5              CONVERT ADDRESS TO OFFSET             16200000
         STH   R1,DSQLVSE@        POST SESSION ARRAY ORIGIN             16210000
         STC   R0,DSQLVSEC        NUMBER OF ARRAY ENTRIES               16220000
         DROP  R5                 DSQLRESP                              16230000
                                                                        16240000
FVSESS   DS    0H                                                       16250000
                                                                        16260000
*---------------------------------------------------------------        16270000
*   extract and test executor completion information                    16280000
*---------------------------------------------------------------        16290000
                                                                        16300000
         MVC   SARGTREE,QCSSATRE  RETURN SARG TREE, IF ANY              16310000
                                                                        16320000
         L     R0,QCSERSN         OBTAIN REASON CODE                    16330000
         L     R15,QCSERC         EXECUTOR COMPLETION STATUS            16340000
         CH    R15,=AL2(RC04)     DETERMINE THE OUTCOME                 16350000
         BL    POSTEXEC              RC00  - SUCCESS                    16360000
         BH    PREPRESP              RC08+ - FAILURE DOCUMENTED         16370000
                                                                        16380000
*---------------------------------------------------------------        16390000
*   failure encountered in executor - QCS analysis required             16400000
*---------------------------------------------------------------        16410000
                                                                        16420000
         ICM   R0,15,QCSPSARC     FAILURE IN TBPSARG?                   16430000
         BNZ   ERR_SARG           PROCESS THE SARG FAILURE              16440000
         B     PREPRESP           NO OTHER CANDIDATES                   16450000
         DROP  R6                 SQSEMAL                               16460000
                                                                        16470000
         EJECT                                                          16480000
**<DOC-ON>******************************************************        16490000
*                                                                       16500000
*   Phase: EXECUTE (continued) - all target table types                 16510000
*                                                                       16520000
*   If a SQLPrepare() or any other non-suppressed CLI function          16530000
*   is issued for a SELECT statement, the response block                16540000
*   returned must minimally contain a description (TBDESC) of           16550000
*   the result set.  To accomodate the description and any              16560000
*   result set rows that may be extracted later (RETRIEVE), the         16570000
*   TXP bufffer is first enlargened.                                    16580000
*                                                                       16590000
*   Then, if we are processing a SQLPrepare() request directed          16600000
*   against a VDB table, a TBDESC is issued to get a description        16610000
*   of the result set.  If the SELECT target is a catalog table,        16620000
*   the TBDESC was done previously and need not be repeated.            16630000
*                                                                       16640000
*   Lastly, a column name list is inserted allowing coop to             16650000
*   make additional TIREAD requests for subsets of catalog              16660000
*   tables.                                                             16670000
*                                                                       16680000
**<DOC-OFF>*****************************************************        16690000
                                                                        16700000
POSTEXEC DS    0H                                                       16710000
         CLI   QCSCLI,QCSC_PRP    SQLPrepare() OF SOME STATEMENT?       16720000
         BE    POSTCONT           DESCRIPTION REQUIRED IF SO            16730000
         TM    QCSEFLG2,QCS2_NXE  EXECUTION SUPPRESSED?                 16740000
         BO    NORMRET            DONE IF SO                            16750000
                                                                        16760000
POSTCONT DS    0H                                                       16770000
         CLI   QCSQUERY,QCSQ_SEL  SELECT STATEMENT?                     16780000
         BNE   NORMRET            NOTHING TANGIBLE TO RETURN IF NOT     16790000
                                                                        16800000
*---------------------------------------------------------------        16810000
*   resize the TXP buffer to handle bulk data produced by SELECT        16820000
*---------------------------------------------------------------        16830000
                                                                        16840000
         @CALL IXRURSIZ,CTYPE=CVT ACQUIRE RESPONSE BUFR RECOMMENDATIONS 16850000
         LR    R2,R1              ACCEPT SIZE RECOMMENDATION            16860000
                                                                        16870000
         $XPBUFR RESIZE,SIZE=(R2)                                       16880000
                                                                        16890000
*---------------------------------------------------------------        16900000
*   SQLPrepare(SELECT) issued for VDB table, describe result set        16910000
*---------------------------------------------------------------        16920000
                                                                        16930000
         CLI   QCSCLI,QCSC_PRP    PREPARE STATEMENT?                    16940000
         BNE   RETRIEVE           EXECUTE OTHERWISE                     16950000
         CLI   QCSTTYPE,QCST_CAT  CATALOG REFERENCE?                    16960000
         BE    POSTPREP           ALL INFORMATION PREVIOUSLY CAPTURED   16970000
                                                                        16980000
         TBDESC TTOKEN=QCSTTOKN,  TABLE DESCRIPTION                    X16990000
               LINK=OFFSET,       USING OFFSET LINKAGES                X17000000
               FORMAT=*DESCFMT,   STANDARD OR TERSE FORMAT, PER REQ    X17010000
               MF=(E,MFE_LIST)                                          17020000
                                                                        17030000
         LTR   R15,R15            DESCRIPTION ACQUIRED?                 17040000
         BNZ   ERR_TBSV           NOTHING OF VALUE RETURNED             17050000
                                                                        17060000
         ST    R1,QCSDESC@        ADDR OF TABLE DESCRIPTOR              17070000
         ST    R0,QCSDESCL        LENGTH OF TABLE DESCRIPTOR            17080000
                                                                        17090000
*---------------------------------------------------------------        17100000
*   insert table description for SQLPrepare() requests                  17110000
*---------------------------------------------------------------        17120000
                                                                        17130000
POSTPREP DS    0H                                                       17140000
         L     R3,QCSDESC@        DESCRIBE BUFFER ORIGIN                17150000
         L     R4,TBFUSED-TBFMT(,R3)   LENGTH OF BUFFER USED            17160000
                                                                        17170000
         $XPBUFR ISRT,DATA=(R3),DATALEN=(R4),                          X17180000
               EXPAND=YES                                               17190000
                                                                        17200000
         BNZ   ERR_ITXP           TXP BUFFER MGMT FAILURE               17210000
                                                                        17220000
         L     R5,QCSRESP@        SQL RESPONSE HEADER                   17230000
         USING DSQLRESP,R5        PREPARE FOR UPDATE                    17240000
         SR    R1,R5              OFFSET TO TABLE DESCRIPTION           17250000
         STH   R1,DSQLDSC@        POST TABLE DESCRIPTION                17260000
                                                                        17270000
*---------------------------------------------------------------        17280000
*   return selected column list                                         17290000
*---------------------------------------------------------------        17300000
                                                                        17310000
         BAS   R14,$BCLIST        BUILD COLUMN NAME LIST                17320000
         BNZ   ERR_ITXP           BUFFER CAPACITY EXCEEDED              17330000
         B     NORMRET            COMPLETE                              17340000
         DROP  R5                 DSQLRESP                              17350000
                                                                        17360000
         EJECT                                                          17370000
**<DOC-ON>******************************************************        17380000
*                                                                       17390000
*   Phase: RETRIEVE - Package initial segment of result set             17400000
*                                                                       17410000
*   Although the result set (VDB or catalog table) is open              17420000
*   at this point, none of the linkages allowing subsequent             17430000
*   retrievals have been made available to coop, particularly           17440000
*   the Table Interface Block (TIB).  The call to ITIOPEN               17450000
*   includes the open table token but causes a TIB to be                17460000
*   allocated just as would a standard, coop-initiated TIOPEN           17470000
*   request.                                                            17480000
*                                                                       17490000
*   The TIB returned by that service is then updated, transfering       17500000
*   ownership of the TIREAD/TBGET-ready search argument / filter        17510000
*   and the storage pool from which it was created to that              17520000
*   block and its associated resource managers.                         17530000
*                                                                       17540000
*   Beginning in 1.0C, the table description is not returned            17550000
*   on behalf of SQLExecute() requests originating from a               17560000
*   coop of that same or higher level.  Runtimes at those levels        17570000
*   are required to maintain the result set description provided        17580000
*   by SQLPrepare().                                                    17590000
*                                                                       17600000
**<DOC-OFF>*****************************************************        17610000
                                                                        17620000
RETRIEVE DS    0H                                                       17630000
         LA    R7,$TIOPEN         PLIST CONSTRUCTION AREA               17640000
         USING TIOPEN,R7          PREPARING FOR OPEN                    17650000
         XC    TIOPEN(TIOPENLN),TIOPEN                                  17660000
         MVC   TIOPTABL,QCSTABLE  TABLE NAME                            17670000
         MVC   TIOPTKN,QCSTTOKN   PASS OPENED TABLE HANDLE              17680000
                                                                        17690000
         MVC   TIOPPROJ,QCSPRJNM  PROJECT NAME                          17700000
         CLI   QCSTTYPE,QCST_CAT  CATALOG REFERENCE?                    17710000
         BE    *+10                  USE REQUESTED PROJECT NAME IF SO   17720000
         MVC   TIOPPROJ,=C'INTEXSPC' ELSE, FORCE TO EXECUTION SPACE     17730000
                                                                        17740000
         MVI   TIOPAUTO,TRUE      AUTOMATIC CLOSE AT END OF TABLE       17750000
         CLI   QCSTTYPE,QCST_CAT  CATALOG REFERENCE?                    17760000
         BE    *+8                NEVER DROPPED                         17770000
         MVI   TIOPDROP,TRUE      CLIENT TABLES DELETED AFTER RETRIEVAL 17780000
                                                                        17790000
         TM    QFLAGS,Q$NODESC    SUPPRESS DELIVERY OF TABLE DESCRIBE?  17800000
         BNO   *+8                SKIP IF NOT                           17810000
         MVI   TIOPNDSC,TRUE      SUPPRESS TABLE DESCRIPTION FOR RESULT 17820000
                                                                        17830000
         CLI   DESCFMT,0          TERSE FORM OF TABLE DESCRIPTION?      17840000
         BE    *+8                SKIP IF NOT                           17850000
         OI    TIOPOPTS,TIOPTERS  TERSE FORMAT IS SMALLER               17860000
                                                                        17870000
*---------------------------------------------------------------        17880000
*   open the table and prepare TIB / coop response for analysis         17890000
*---------------------------------------------------------------        17900000
                                                                        17910000
         LA    R0,WRK1K           WORKAREA FOR FIRST LEVEL SERVICES     17920000
         @CALL ITIOPEN,CTYPE=CVT,MF=(E,TIOPEN)                          17930000
                                                                        17940000
         L     R6,TIOPRESP        OPEN RESPONSE HEADER IN ALL CASES     17950000
         USING TMRESP,R6          SHORT TERM ADDRESSABILITY             17960000
                                                                        17970000
         LTR   R15,R15            OPEN SUCCESSFUL?                      17980000
         BNZ   OPEN_ERR           FAIL OTHERWISE                        17990000
                                                                        18000000
*---------------------------------------------------------------        18010000
*   complete the table interface block (TIB) - prepare response         18020000
*---------------------------------------------------------------        18030000
                                                                        18040000
         ST    R1,QCSTIB          RETAIN PTR TO TIB (DIAGNOSTIC VALUE)  18050000
         ST    R0,ROWCOUNT        NUMBER OF ROWS IN TABLE               18060000
                                                                        18070000
         USING TIBLOCK,R1         TEMP TIB ADDRESSABILITY FROM TIOPEN   18080000
         MVC   TABLTOKN,TIOPTKN   RETAIN LOCAL COPY OF TABLE TOKEN      18090000
         XC    QCSTTOKN,QCSTTOKN  TRANSFER TABLE OWNERSHIP TO THE TIB   18100000
         MVC   DESCRIBE,TIBDESC   EXTRACT PTR TO TABLE DESCRIPTION      18110000
         MVC   TIBDFTSA,SARGTREE  SEARCH ARG ORIGIN                     18120000
         MVC   TIBSTGP(8),QCSGPSTG   TRANSFER OWNERSHIP OF SARG POOL    18130000
         XC    QCSGPSTG(8),QCSGPSTG  STGMGR STORAGE HDR FBA             18140000
         DROP  R1                 TIBLOCK                               18150000
                                                                        18160000
*---------------------------------------------------------------        18170000
*   post table description and row count                                18180000
*---------------------------------------------------------------        18190000
                                                                        18200000
         L     R5,QCSRESP@        SQL RESPONSE HEADER                   18210000
         USING DSQLRESP,R5        PREPARE FOR UPDATE                    18220000
                                                                        18230000
         L     R0,ROWCOUNT        NUMBER OF TABLE ROWS                  18240000
         ICM   R15,15,SARGTREE    RESULT SET FILTERED?                  18250000
         BZ    *+8                ROW COUNT IS ACCURATE IF NOT          18260000
         SR    R0,R0              ELSE ROW COUNT NOT RELIABLE           18270000
         BCTR  R0,0               HIGH VALUES                           18280000
         ST    R0,DSQLROWS        POST ROW COUNT OR UNAVAILABILITY FLAG 18290000
                                                                        18300000
         TM    QFLAGS,Q$NODESC    TABLE DESCRIPTION SUPPRESSED?         18310000
         BO    OPEN_END           SKIP IF SO                            18320000
                                                                        18330000
         LA    R0,TMRSDATA        TABLE DESCRIPTION                     18340000
         SR    R0,R5              OFFSET TO DESCRIBE ORIGIN             18350000
         STH   R0,DSQLDSC@        READDRESS FOR COOP ACCESS             18360000
         B     OPEN_END           OPEN SUCCEEDS                         18370000
         DROP  R5                 DSQLRESP                              18380000
                                                                        18390000
*---------------------------------------------------------------        18400000
*   result set open failed                                              18410000
*---------------------------------------------------------------        18420000
                                                                        18430000
OPEN_ERR DS    0H                                                       18440000
         L     R2,TMRSRSN         REASON CODE                           18450000
         SLL   R2,16              SHIFT TO HIGH ORDER                   18460000
         O     R2,TMRSRC          COMBINE WITH RETURN CODE              18470000
                                                                        18480000
         SQLIDCMP COMPONENT='TIOPEN',INFOCODE=(R2)                      18490000
                                                                        18500000
         SQLSTAT ERC_TOPN                                               18510000
                                                                        18520000
         LA    R1,TMRESP          TABLE INTERFACE RESPONSE BLOCK        18530000
         BAS   R14,MSGTMRSP       EXTRACT QUEUED MESSAGES               18540000
         B     PREPRESP           PREPARE FOR UPDATE SQL RESPONSE       18550000
                                                                        18560000
*---------------------------------------------------------------        18570000
*   result set open completed without error                             18580000
*---------------------------------------------------------------        18590000
                                                                        18600000
OPEN_END DS    0H                                                       18610000
         DROP  R6,R7              TMRESP, TIOPEN                        18620000
                                                                        18630000
         EJECT                                                          18640000
**<DOC_ON>******************************************************        18650000
*                                                                       18660000
*   Now, ITIREAD will be invoked on behalf of coop to fill the          18670000
*   TXP buffer with the first segment of the result set (as             18680000
*   much as will fit in the possibly zero space remaining). The         18690000
*   TIREAD parameter list itself is first inserted into the             18700000
*   response.  That provides coop with the ability to retrieve          18710000
*   the rest of the result set if it doesn't all fit now.  The          18720000
*   plist address is volitile, however, and must be recomputed          18730000
*   after any $XPBUFR ISRT or call to a service routine that            18740000
*   does the same.                                                      18750000
*                                                                       18760000
*   If the table description was previously inserted in the             18770000
*   response, this request is not a SQLExecute() and we must            18780000
*   also provide coop with the SELECT-COMMA_COLUMN_LIST column          18790000
*   names and a bitmask showing their position in the result            18800000
*   set (which may be a true table).                                    18810000
*                                                                       18820000
*   Finally, ITIREAD is called to begin the row retrieval               18830000
*   process, priming the pump for coop.                                 18840000
*                                                                       18850000
**<DOC-OFF>*****************************************************        18860000
                                                                        18870000
         LA    R7,$TIREAD         PLIST CONSTRUCTION AREA               18880000
         USING TIREAD,R7          PREPARING FOR OPEN                    18890000
         XC    TIREAD(TIREADLN),TIREAD                                  18900000
         MVC   TIRETKN,TABLTOKN   TABLE TOKEN                           18910000
         MVC   TIRENDX,QCSTNDX    INDEX NAME OR NULLS                   18920000
         MVI   TIREP,TIREPTOP     BEGIN AT TABLE EXTREMITY              18930000
         MVI   TIRED,TIREDFWD     MOVE FORWARDS FROM TOP                18940000
                                                                        18950000
         $XPBUFR ISRT,DATA=TIREAD,DATALEN=TIREADLN,                    X18960000
               EXPAND=YES                                               18970000
                                                                        18980000
         BNZ   ERR_ITXP           TPX RESPONSE MGR ERROR                18990000
                                                                        19000000
         L     R5,QCSRESP@        SQL RESPONSE HEADER                   19010000
         USING DSQLRESP,R5        PREPARE FOR UPDATE                    19020000
         LR    R7,R1              SHIFT REFERENCES TO STORED COPY       19030000
         SR    R1,R5              OFFSET TO RESULT TABLE  READ PLIST    19040000
         STH   R1,DSQLRPL@        PORTABLE FORMAT FOR XMIT              19050000
                                                                        19060000
*---------------------------------------------------------------        19070000
*   build column name list for all requests except SQLExecute()         19080000
*---------------------------------------------------------------        19090000
                                                                        19100000
         TM    QFLAGS,Q$NODESC    TABLE DESCRIPTION SUPPRESSED?         19110000
         BO    NOCOLIST           COLUMN LIST ALSO SUPPRESSED IF SO     19120000
                                                                        19130000
         BAS   R14,$BCLIST        BUILD COLUMN NAME LIST                19140000
         BNZ   ERR_ITXP           BUFFER CAPACITY EXCEEDED              19150000
                                                                        19160000
         L     R5,QCSRESP@        SQL RESPONSE HEADER            157382 19170000
         LH    R7,DSQLRPL@        RESTORE TIREAD PTR FROM XPBUFR 157382 19180000
         AR    R7,R5                                             157382 19190000
                                                                        19200000
NOCOLIST DS    0H                                                       19210000
                                                                        19220000
*---------------------------------------------------------------        19230000
*   build TIREAD column mask                                            19240000
*---------------------------------------------------------------        19250000
                                                                        19260000
         L     R6,QCSSSMRY        SEMANTIC SUMMARY                      19270000
         USING SQSEMAL,R6         FORMAT                                19280000
                                                                        19290000
         ICM   R2,15,SQSASELC     SELECTED COLUMN LIST                  19300000
         BZ    SELFIN             ALL COLUMNS SELECTED                  19310000
         USING SQREFP,R2          ORDERED SELECT LIST REFERENCES        19320000
                                                                        19330000
SELCOLS  DS    0H                 EXPLICIT COLUMN SELECTION LIST        19340000
         L     R4,SQRNODE         COLUMN DEFINTION                      19350000
         USING SQCOLREF,R4        COLUMN ENTRY FORMAT                   19360000
                                                                        19370000
         L     R1,DESCRIBE        R1 <== TBDESC TABLE DESCRIPTION ORG   19380000
         LA    R0,SQCOLNM         R0 <== COLUMN NAME                    19390000
         BAS   R14,COLNDX         RETURN COLUMN NUMBER IN R0            19400000
         LTR   R15,R15            SHOULD NEVER FAIL FOR VDB QUERY       19410000
         BZ    SELMASK            CATALOG REFS NOT AS CAREFULLY CHECKED 19420000
         SR    R1,R1              NO ASSOCIATED CLEX PROVIDED           19430000
         B     ERR_CREF           ERROR                                 19440000
                                                                        19450000
SELMASK  DS    0H                 R0 CONTAINS COLUMN NUMBER             19460000
         SETBIT TIREXCLS,(R0)     SET CORR BIT IN COLUMN SELECT MASK    19470000
                                                                        19480000
         ICM   R2,15,SQRLINK      ADVANCE TO NEXT COLUMN PLACEHOLDER    19490000
         BNZ   SELCOLS            RETAIN ALL COLUMNS                    19500000
         DROP  R2,R4,R6           SQREFP, SQCOLREF, SQSEMAL             19510000
                                                                        19520000
SELFIN   DS    0H                 ALL COLUMNS PROCESSED                 19530000
                                                                        19540000
*--------------------------------------------------------------- 135096 19550000
*   TIREAD plist versioned depending on level of coop support    135096 19560000
*--------------------------------------------------------------- 135096 19570000
                                                                        19580000
         TM    RFLAGS,R$RDVER0    VER 0 (10A) CAPABLE ONLY COOP? 135096 19590000
         BNO   READVER1           ELSEWHERE IF NOT               135096 19600000
         MVC   TIRECOLS,TIREXCLS  MOVE COLUMN MASK TO VER 0 LOC  135096 19610000
         B     READTAB            TIREAD VER 0 PLIST READY       135096 19620000
                                                                        19630000
READVER1 DS    0H                                                135096 19640000
         MVI   TIREVER,TIREVER1   INDICATE VER 1 FORMAT PLIST    135096 19650000
                                                                        19660000
READTAB  DS    0H                                                       19670000
                                                                        19680000
*---------------------------------------------------------------        19690000
*   perform first TIREAD, reestablish TXP buffer addressability         19700000
*---------------------------------------------------------------        19710000
                                                                        19720000
         LA    R0,WRK1K           WORKAREA FOR FIRST LEVEL SERVICES     19730000
         @CALL ITIREAD,CTYPE=CVT,MF=(E,TIREAD)  FILL THE FIRST BUFFER   19740000
                                                                        19750000
         LR    R6,R1              TMRESP PTR RETURNED                   19760000
         USING TMRESP,R6          TEMP ADDRESSABILITY                   19770000
                                                                        19780000
         L     R5,QCSRESP@        REFRESH SQL RESPONSE HEADER           19790000
         LR    R7,R5              TRAVERSING TO TIREAD (POSSIBLY MOVED) 19800000
         AH    R7,DSQLRPL@        BY TRACKING MOVEMENT OF SQL RESPONSE  19810000
                                                                        19820000
         LTR   R15,R15            STANDARD COMPLETION?                  19830000
         BNZ   READ_ERR           ERROR IF NOT                          19840000
                                                                        19850000
*---------------------------------------------------------------        19860000
*   TIREAD is successful                                                19870000
*---------------------------------------------------------------        19880000
                                                                        19890000
         MVI   TIREP,TIREPCUR     SUBSEQUENT READS MOVE FROM CRP        19900000
                                                                        19910000
         LA    R0,TMRESP          TMRESP RETURNED FROM TIREAD           19920000
         SR    R0,R5              OFFSET TO READ RESPONSE               19930000
         STH   R0,DSQLRDR@        PORTABLE FORMAT FOR XMIT              19940000
                                                                        19950000
         CLC   TMRSUPRC,=A(100)   EOT IN FIRST PACKET?                  19960000
         BNE   READ_RDY           ONWARD IF NOT                         19970000
                                                                        19980000
         LA    R1,TMRSDATA        TIREAD SPECIFIC RESPONSE AREA         19990000
         USING TIRDRET,R1         TEMP ADDRESSABILITY                   20000000
         OC    TIRD#ROW,TIRD#ROW  # ROWS PENDING RETURN                 20010000
         BNZ   *+8                TABULAR DATA RETURNED                 20020000
         OI    RFLAGS,R$NODATA    ELSE INDICATE NO ELIGIBLE DATA        20030000
         B     READ_RDY           SKIP IF NOT                           20040000
         DROP  R5,R1              DSQLRESP, TIRDRET                     20050000
                                                                        20060000
*---------------------------------------------------------------        20070000
*   result set read failure                                             20080000
*---------------------------------------------------------------        20090000
                                                                        20100000
READ_ERR DS    0H                                                       20110000
         L     R2,TMRSRSN         REASON CODE                           20120000
         SLL   R2,16              SHIFT TO HIGH ORDER                   20130000
         O     R2,TMRSRC          COMBINE WITH RETURN CODE              20140000
                                                                        20150000
         SQLIDCMP COMPONENT='TIREAD',INFOCODE=(R2)                      20160000
                                                                        20170000
         SQLSTAT ERC_TRD                                                20180000
                                                                        20190000
         LA    R1,TMRESP          TABLE INTERFACE RESPONSE BLOCK        20200000
         BAS   R14,MSGTMRSP       PROCESS TM RESPONSE MSG               20210000
         B     PREPRESP           PREPARE FOR UPDATE SQL RESPONSE       20220000
                                                                        20230000
*---------------------------------------------------------------        20240000
*   result set read completed without error                             20250000
*---------------------------------------------------------------        20260000
                                                                        20270000
READ_RDY DS    0H                                                       20280000
         DROP  R7,R6              TIREAD, TMRESP                        20290000
                                                                        20300000
         EJECT                                                          20310000
**<DOC-ON>******************************************************        20320000
*                                                                       20330000
*   Phase: RELEASE - Prepare coop notification and cleanup              20340000
*                                                                       20350000
*   When processing a SQL DML statement, control is                     20360000
*   received at NORMRET to post a standard completion message           20370000
*   for workbench query sources.  Three cases are defined as            20380000
*   follows:                                                            20390000
*                                                                       20400000
*      1) If the requester asked only for a display of the              20410000
*         execution plan, the plan formatter provides all of            20420000
*         the appropriate messages.                                     20430000
*                                                                       20440000
*      2) If the statement is not a SELECT statement, and it            20450000
*         executed without error, a "request complete" message          20460000
*         is provided.                                                  20470000
*                                                                       20480000
*      3) If the statement is a SELECT statement and the result         20490000
*         set is empty a "no rows selected" message is provided,        20500000
*         otherwise the result set rows are the only response           20510000
*         provided.                                                     20520000
*                                                                       20530000
*   When errors are encountered, the SQLMSG and SQLIDCMP                20540000
*   services provide message numbers, component failure                 20550000
*   information, etc. that eventually arrive at label PREPRESP          20560000
*   where these responses are expanded into messages and other          20570000
*   information that is used to complete the DSQLRESP block and         20580000
*   associated data.                                                    20590000
*                                                                       20600000
*   The error handlers provided in this section are those               20610000
*   responsible for generic, component-oriented failures that           20620000
*   may occur in any of the SQL processing phases that preceed          20630000
*   the RELEASE phase.  Where appropriate, they test to see             20640000
*   whether the component failure was previously logged and,            20650000
*   if not, it is assumed that the failure was trapped "recently"       20660000
*   in this routine.                                                    20670000
*                                                                       20680000
**<DOC-OFF>*****************************************************        20690000
                                                                        20700000
NORMRET  DS    0H                 DB FUNCTION COMPLETE                  20710000
         CLI   QCSOURCE,QCSS_RT   RUN TIME OR CATALOG REF?              20720000
         BE    PREPRESP           NO COMPLETION MESSAGE IF SO           20730000
         TM    QCSEFLG2,QCS2_PLN+QCS2_PDE                               20740000
         BNZ   PREPRESP           NO 'COMPLETION' MSG IF PLAN           20750000
                                                                        20760000
         LA    R4,001             NORMAL 'FUNCTION COMPLETE' MSG        20770000
         CLI   QCSQUERY,QCSQ_SEL  SELECT STATEMENT?                     20780000
         BNE   NORMRESP           MSG NEEDED IN LIEU OF RESULT SET      20790000
         TM    RFLAGS,R$NODATA    RESULT SET NON-NULL                   20800000
         BNO   PREPRESP           RESULT SET ITSELF IS RESPONSE         20810000
         LA    R4,000             ELSE RETURN 'NO DATA SELECTED' MSG    20820000
                                                                        20830000
NORMRESP DS    0H                 RETURN 'COMPLETION' MESSAGE           20840000
         SQLMSG (R4)              SUCCESS                               20850000
         B     PREPRESP           PREPARE FOR UPDATE SQL RESPONSE BLK   20860000
                                                                        20870000
*--------------------------------------------------------------         20880000
*   failure constructing navigation network                             20890000
*--------------------------------------------------------------         20900000
                                                                        20910000
ERR_NBLD DS    0H                                                       20920000
         LR    R2,R15             PRESERVE RETURN CODE                  20930000
                                                                        20940000
         L     R3,QCSIPROJ        LOCATE IPROJ                          20950000
         ICM   R0,15,PRJEXMCQ-IPROJ(R3)  MSG STREAM GENERATED?          20960000
         BNZ   ERR_NB2            SKIP IF NOT                           20970000
                                                                        20980000
         SQLMSG 903                                                     20990000
                                                                        21000000
ERR_NB2  DS    0H                                                       21010000
         SQLSTAT ERC_NBLD,INFO=(R2)   SQL EXECUTION FAILURE             21020000
                                                                        21030000
         B     PREPRESP           POST STATUS                           21040000
                                                                        21050000
*---------------------------------------------------------------        21060000
*   unimplemented SQL statement                                         21070000
*---------------------------------------------------------------        21080000
                                                                        21090000
ERR_IMPL DS    0H                                                       21100000
         SQLSTAT ERC_IMPL                                               21110000
                                                                        21120000
         B     PREPRESP           PREPARE FOR UPDATE SQL RESPONSE BLK   21130000
                                                                        21140000
*---------------------------------------------------------------        21150000
*   reference to an undefined column, optional input in R1              21160000
*---------------------------------------------------------------        21170000
                                                                        21180000
ERR_CREF DS    0H                 R1 CONTAINS #CLEX ADDRESS OR ZERO     21190000
         ST    R1,QCSECLEX                                              21200000
                                                                        21210000
         SQLSTAT ERC_CREF                                               21220000
                                                                        21230000
         B     PREPRESP           PREPARE FOR UPDATE SQL RESPONSE BLK   21240000
                                                                        21250000
*--------------------------------------------------------------         21260000
*   TXP buffer error impacting completeness of SQL response             21270000
*--------------------------------------------------------------         21280000
                                                                        21290000
ERR_ITXP DS    0H                                                       21300000
         SQLSTAT ERC_TXP,INFO=(R15)                                     21310000
                                                                        21320000
         B     PREPRESP                                                 21330000
                                                                        21340000
*---------------------------------------------------------------        21350000
*   storage mangement failure or storage depletion                      21360000
*---------------------------------------------------------------        21370000
                                                                        21380000
ERR_STG  DS    0H                                                       21390000
         TM    QCSFFLAG,QCSFFAIL  COMPONENT FAILURE ALREADY LOGGED?     21400000
         BO    ERR_STG_MSG        RETAIN VERSION CLOSEST TO ERROR       21410000
                                                                        21420000
         SQLIDCMP COMPONENT='STORAGE MGMT',INFOCODE=(R15)               21430000
                                                                        21440000
ERR_STG_MSG    DS  0H                                                   21450000
         SQLSTAT ERC_STG                                                21460000
                                                                        21470000
         B     PREPRESP           PREPARE FOR UPDATE SQL RESPONSE BLK   21480000
                                                                        21490000
*---------------------------------------------------------------        21500000
*   table services failures                                             21510000
*---------------------------------------------------------------        21520000
                                                                        21530000
ERR_TBSV DS    0H                                                       21540000
         TM    QCSFFLAG,QCSFFAIL  COMPONENT FAILURE ALREADY LOGGED?     21550000
         BO    ERR_TBSV_MSG       RETAIN VERSION CLOSEST TO ERROR       21560000
                                                                        21570000
         LR    R2,R0              REASON CODE FROM SOME TB* REQUEST     21580000
         SLL   R2,16              CONSOLIDATION                         21590000
         OR    R2,R15             COMBINE WITH RETURN CODE              21600000
                                                                        21610000
         SQLIDCMP COMPONENT='TABLE SERVICES',INFOCODE=(R2)              21620000
                                                                        21630000
ERR_TBSV_MSG   DS  0H                                                   21640000
         SQLSTAT ERC_TBSV                                               21650000
                                                                        21660000
         B     PREPRESP           PREPARE FOR UPDATE SQL RESPONSE BLK   21670000
                                                                        21680000
         EJECT                                                          21690000
**<DOC-ON>******************************************************        21700000
*                                                                       21710000
*   An error was attributed to the TBPSARG service which is used        21720000
*   to bind columns definitions residing in (foreign space) table       21730000
*   objects to the predicate ITREE. These errors come in two            21740000
*   forms.  The first has to do with mismatches between the             21750000
*   column values given and the underlying table columns. These         21760000
*   are application or request oriented errors.  All others are         21770000
*   regarded as component failures.                                     21780000
*                                                                       21790000
**<DOC-OFF>*****************************************************        21800000
                                                                        21810000
ERR_SARG DS    0H                                                       21820000
         MVC   SARGPRC,QCSPSARC   TBPSARG RC                            21830000
         MVC   SARGPRSN,QCSPSARS  TBPSARG RSN                           21840000
         LR    R2,R14             PRESERVE FAILURE OFFSET               21850000
                                                                        21860000
         SQLSTAT ERC_SARG         ASSUME STANDARD REPORTING OF SARG ERR 21870000
                                                                        21880000
         CLC   SARGPRC,=A(RC08)   DETERMINE LEVEL OF ERROR              21890000
         BNH   ERR_SARG_APPL      STANDARD SITUATIONS                   21900000
         TM    QCSFFLAG,QCSFFAIL  COMPONENT FAILURE ALREADY LOGGED?     21910000
         BO    PREPRESP           RETAIN VERSION CLOSEST TO ERROR       21920000
         LR    R14,R2             RESTORE FAILURE OFFSET                21930000
                                                                        21940000
         SQLIDCMP COMPONENT='TBPSARG',INFOCODE=(R15)                    21950000
                                                                        21960000
         B     PREPRESP                                                 21970000
                                                                        21980000
*---------------------------------------------------------------        21990000
*   application oriented SARG errors                                    22000000
*---------------------------------------------------------------        22010000
                                                                        22020000
ERR_SARG_APPL  DS  0H                                                   22030000
         L     R2,SARGPRSN        SARG ERROR RSN                        22040000
         CH    R2,=AL2(RSN08)     SINGLE OUT RSN08, DATA ITEM LENGTH    22050000
         BNE   ERR_SARG_LOG       STORE DIFFERENT RSN FOR THIS CASE     22060000
                                                                        22070000
         SQLSTAT ERC_CLEN         COLUMN VALUE LENG EXCEEDS DEFINED     22080000
                                                                        22090000
ERR_SARG_LOG   DS  0H                                                   22100000
         LR    R0,R2              CONSOLIDATION                         22110000
         SLL   R0,16              SHIFT TO HIGH ORDER                   22120000
         O     R0,SARGPRC         TBPSARG RETURN CODE                   22130000
         ST    R0,QCSEINFO        USEFUL DIAGNOSTIC                     22140000
                                                                        22150000
         SQLMSG 060,*MSGSARG1(R2)                                       22160000
                                                                        22170000
         B     PREPRESP           PREPARE FOR UPDATE SQL RESPONSE BLK   22180000
                                                                        22190000
         EJECT                                                          22200000
**<DOC-ON>******************************************************        22210000
*                                                                       22220000
*   An ABEND was encountered and trapped in the SQL workunit.           22230000
*   Problem documentation has been logged. ERR_ABND is scheduled        22240000
*   as a retry routine when retry is permitted to inform coop           22250000
*   of the failure.                                                     22260000
*                                                                       22270000
**<DOC-OFF>*****************************************************        22280000
                                                                        22290000
ERR_ABND DS    0H                                                       22300000
         SQLSTAT ERC_ABND                                               22310000
                                                                        22320000
         B     PREPRESP                                                 22330000
                                                                        22340000
         EJECT                                                          22350000
****************************************************************        22360000
*                                                                       22370000
*   PHASE: RELEASE                                                      22380000
*                                                                       22390000
*   Post completion status, messages, etc. to response area             22400000
*                                                                       22410000
****************************************************************        22420000
                                                                        22430000
PREPRESP DS    0H                                                       22440000
         ICM   R1,15,QCSECLEX     CLEX FLAGGED IN ERROR?                22450000
         BZ    *+8                SKIP IF NOT                           22460000
         BAS   R14,TAGTOKEN       ELSE IDENTIFY FOR COOP                22470000
                                                                        22480000
         LA    R1,QCSMSGID        MSG LIST ORIGIN                       22490000
         ICM   R0,15,QCSMSGCT     NUMBER OF MSGS                        22500000
         BZ    *+8                NO WORK                               22510000
         BAS   R14,MSGBCALL       GENERATE MESSAGE LINES                22520000
                                                                        22530000
*---------------------------------------------------------------        22540000
*   generate component failure messages if applicable                   22550000
*---------------------------------------------------------------        22560000
                                                                        22570000
         TM    QCSFFLAG,QCSFFAIL  COMPONENT FAILURE LOGGED?             22580000
         BNO   PREPCONT                                                 22590000
                                                                        22600000
         LA    R4,WRK1K           ADDRESS OF MESSAGE RETURN AREA        22610000
         USING $MSGBUF,R4         ADDRESSABILITY                        22620000
         XC    $MSGBUF($MSBPFXL),$MSGBUF                                22630000
                                                                        22640000
         SR    R2,R2              PREPARE FOR INSERT                    22650000
         ICM   R2,3,QCSFDISP      OFFSET AS UNSIGNED FULLWORD           22660000
                                                                        22670000
         $MSG  490,FIELDS=(QCSFCOMP,QCSFSECT,((R2)),                   X22680000
               QCSERC,QCSERSN,QCSEINFO),                               X22690000
               BUFR=WRK1K,                                             X22700000
               BUFL=L'WRK1K,                                           X22710000
               DEST=$BUFFER                                             22720000
                                                                        22730000
         LA    R1,WRK1K           R1 <== MESSAGE BUFFER                 22740000
         BAS   R14,MSGBPROC       POST MESSAGES FOR RETURN              22750000
         DROP  R4                                                       22760000
                                                                        22770000
PREPCONT DS    0H                                                       22780000
                                                                        22790000
*---------------------------------------------------------------        22800000
*   format the DSQLRESP response header                                 22810000
*---------------------------------------------------------------        22820000
                                                                        22830000
         L     R5,QCSRESP@        SQL RESPONSE HEADER                   22840000
         USING DSQLRESP,R5        SQL RESPONSE                          22850000
                                                                        22860000
         MVC   DSQLRC,QCSERC      RETURN CODE                           22870000
         MVC   DSQLRSN,QCSERSN    REASON CODE                           22880000
         MVC   DSQLINFO,QCSEINFO  INFO CODE                             22890000
         MVC   DSQLSUPR,QCSESUPR  SUPER CODE                            22900000
         MVC   DSQLPROJ,QCSPRJNM  PROJECT NAME                          22910000
         MVC   DSQLTABL,QCSTABLE  TABLE NAME                            22920000
         MVC   DSQLTTKN,TABLTOKN  TABLE TOKEN                           22930000
         MVC   DSQLDROP,QCSTDROP  TABLE DROP OPTION                     22940000
         MVC   DSQLEOFF,COSQLEOF  TOKEN OFFSET                          22950000
         MVC   DSQLELEN,COSQLELN  TOKEN LENGTH                          22960000
         MVC   DSQLSTYP,QCSQUERY  RETURN QUERY TYPE                     22970000
                                                                        22980000
*---------------------------------------------------------------        22990000
*   return width (# cols) of result set if SELECT or SQLPrepare()       23000000
*---------------------------------------------------------------        23010000
                                                                        23020000
         LH    R2,DSQLDSC@        RESULT SET DESCRIPTION                23030000
         LTR   R2,R2              SELECT OR PREPARE (FOR SELECT)?       23040000
         BZ    PREPNRET           SKIP IF NOT                           23050000
                                                                        23060000
         LA    R2,DSQLRESP(R2)    CONVERT OFFSET TO PTR                 23070000
         USING TBFMT,R2           DESCRIBE HEADER FORMAT                23080000
         ICM   R0,3,DSQLCOLC      EXPLICIT COLUMN LIST NOTED?           23090000
         BNZ   *+8                SKIP IF SO                            23100000
         LH    R0,TBF#COLS        TRUE WIDTH OF RESULT TABLE            23110000
         STH   R0,DSQLRSET        RETURN COLUMN COUNT                   23120000
         DROP  R2                 TBFMT                                 23130000
                                                                        23140000
PREPNRET DS    0H                                                       23150000
         DROP  R5                 DSQLRESP                              23160000
                                                                        23170000
*---------------------------------------------------------------        23180000
*   return project level msgs and those generated by executor           23190000
*---------------------------------------------------------------        23200000
                                                                        23210000
         L     R7,QCSIPROJ        LOCATE PROJECT                        23220000
         ICM   R1,15,PRJEXMCQ-IPROJ(R7)  MESSAGES?                      23230000
         BZ    *+8                                                      23240000
         BAS   R14,MSGBPROC                                             23250000
                                                                        23260000
         ICM   R1,15,QCSEMSGQ     MESSAGE QUEUE RETURNED?               23270000
         BZ    *+8                SKIP IF NOT                           23280000
         BAS   R14,MSGBPROC       PREPARE FOR RETURN                    23290000
                                                                        23300000
         EJECT                                                          23310000
**<DOC-ON>*****************************************************         23320000
*                                                                       23330000
*   Release acquired storage and other transient resources.             23340000
*                                                                       23350000
*   First, if a SQLPrepare() was issued but failed, the PSB             23360000
*   that was created in the INITIAL phase is deleted. IF a              23370000
*   SQLPrepare() succeeded, a PREPSQL EXPORT is issued to               23380000
*   transfer ownership of the SQL parse output and the assoc            23390000
*   SQL semantic summary.                                               23400000
*                                                                       23410000
**<DOC-OFF>****************************************************         23420000
                                                                        23430000
         ICM   R0,15,QCSEPSB      PSB BUILT OR LOCATED?                 23440000
         BZ    FPSBDEL            SKIP IF NOT                           23450000
         CLI   QCSCLI,QCSC_PRP    PREPARE STATEMENT?                    23460000
         BNE   FPSBDEL            NO PSB CLEANUP OTHERWISE              23470000
         ICM   R15,15,QCSERC      STATEMENT PREPARE COMPLETED NORMALLY? 23480000
         BZ    FPSBDEL            SUCCESS, PSB IS RETAINED              23490000
                                                                        23500000
         L     R1,QCSRESP@        SQL RESPONSE HEADER                   23510000
         MVI   DSQLPREP-DSQLRESP(R1),FALSE  INDICATE PREPARE FAILED     23520000
                                                                        23530000
         @CALL IPSBDEL,(*TSKPCBC,*QCSIUSER,STMTHNDL,FALSE),            X23540000
               CTYPE=CVT,MF=(E,MFE_LIST)                                23550000
                                                                        23560000
         XC    QCSEPSB,QCSEPSB    INDICATE PSB DELETED                  23570000
                                                                        23580000
FPSBDEL  DS    0H                                                       23590000
                                                                        23600000
*--------------------------------------------------------------         23610000
*   park the SQL parse/semantic area in the PSB if available            23620000
*--------------------------------------------------------------         23630000
                                                                        23640000
         ICM   R0,15,QCSEPSB      PSB BUILT OR LOCATED?                 23650000
         BZ    FSQLEXP            SKIP IF NOT                           23660000
                                                                        23670000
         PREPSQL EXPORT,                                               X23680000
               PARSEINFO=QCSPARSE,                                     X23690000
               SEMANTICS=QCSSSMRY,                                     X23700000
               VDBTABLE=QCSAVDBL,                                      X23710000
               PSB=*QCSEPSB,                                           X23720000
               MF=(E,MFE_LIST)                                          23730000
                                                                        23740000
         XC    QCSEPSB,QCSEPSB    DISCHARGE RSRC MGMT RESPONSIBILITIES  23750000
                                                                        23760000
FSQLEXP  DS    0H                                                       23770000
                                                                        23780000
         EJECT                                                          23790000
**<DOC-ON>*****************************************************         23800000
*                                                                       23810000
*   A bottom line product performance metric is the number of           23820000
*   various types of SQL requests that can be processed per             23830000
*   unit time.  $INCR is issued to capture the rate of                  23840000
*   SQL requests broken down by the CLI function types                  23850000
*   SQLPrepare(), SQLExecute(), and SQLExecDirect(). Also,              23860000
*   these figures can be used to determine whether applications         23870000
*   are exploiting the performance benifits of SQLPrepare().            23880000
*                                                                       23890000
**<DOC-OFF>****************************************************         23900000
                                                                        23910000
EXIT     DS    0H                 all SQL requests                      23920000
         $INCR ICA_SQL_STATEMENTS                                       23930000
                                                                        23940000
         CLI   QCSCLI,QCSC_PRP    SQLPrepare() requests                 23950000
         BNE   EXF_PREP                                                 23960000
                                                                        23970000
         $INCR ICA_SQL_PREPARE                                          23980000
                                                                        23990000
EXF_PREP DS    0H                 SQLExecute() requests                 24000000
         CLI   QCSCLI,QCSC_EXE                                          24010000
         BNE   EXF_EXE                                                  24020000
                                                                        24030000
         $INCR ICA_SQL_EXEC                                             24040000
                                                                        24050000
EXF_EXE  DS    0H                 SQLExecDirect() requests              24060000
         CLI   QCSCLI,QCSC_EXD                                          24070000
         BNE   EXF_EXED                                                 24080000
                                                                        24090000
         $INCR ICA_SQL_EXEC_DIR                                         24100000
                                                                        24110000
EXF_EXED DS    0H                                                       24120000
                                                                        24130000
*--------------------------------------------------------------         24140000
*   delete recovery environment                                         24150000
*--------------------------------------------------------------         24160000
                                                                        24170000
         TM    RCVFLAGS,RCVF$ENV  RECOVERY ROUTINE ESTABLISHED?         24180000
         BNO   NXRCVRY            DONE IF NOT                           24190000
                                                                        24200000
         $RCVRY DELETE,MF=(E,MFE_LIST)                                  24210000
                                                                        24220000
NXRCVRY  DS    0H                                                       24230000
                                                                        24240000
*---------------------------------------------------------------        24250000
*   return to caller                                                    24260000
*---------------------------------------------------------------        24270000
                                                                        24280000
         LM    R15,R0,QCSESTAT    ENDING STATUS AS COOP WILL SEE IT     24290000
                                                                        24300000
         #EXIT                                                          24310000
                                                                        24320000
         EJECT ,                                                        24330000
****************************************************************        24340000
*                                                                       24350000
* ROUTINE:  GETQOFF - Obtain the SCOLUSE byte # corr to query           24360000
*                                                                       24370000
* ON EXIT:                                                              24380000
*                                                                       24390000
*    R15 contains one of the following return codes.                    24400000
*        The condition code is set accordingly.                         24410000
*                                                                       24420000
*        RC00 - offset obtained                                         24430000
*                                                                       24440000
*               R1 - SCOLUSE byte #                                     24450000
*                                                                       24460000
*        RC04 - invalid SQL query type                                  24470000
*                                                                       24480000
****************************************************************        24490000
                                                                        24500000
GETQOFF  DS    0H                                                       24510000
         LA    R15,RC00           ASSUME SUCCESS                        24520000
                                                                        24530000
         LA    R1,SCOLSUSE-SCOLUSE                                      24540000
         CLI   QCSQUERY,QCSQ_SEL  SELECT STATEMENT?                     24550000
         BER   R14                RET CC=0                              24560000
                                                                        24570000
         LA    R1,SCOLUUSE-SCOLUSE                                      24580000
         CLI   QCSQUERY,QCSQ_UPD  UPDATE STATEMENT?                     24590000
         BER   R14                RET CC=0                              24600000
                                                                        24610000
         LA    R1,SCOLIUSE-SCOLUSE                                      24620000
         CLI   QCSQUERY,QCSQ_INS  INSERT STATEMENT?                     24630000
         BER   R14                RET CC=0                              24640000
                                                                        24650000
         LA    R1,SCOLDUSE-SCOLUSE                                      24660000
         CLI   QCSQUERY,QCSQ_DEL  DELETE STATEMENT?                     24670000
         BER   R14                RET CC=0                              24680000
                                                                        24690000
         LA    R15,RC04                                                 24700000
         LTR   R15,R15                                                  24710000
         BR    R14                                                      24720000
                                                                        24730000
         EJECT                                                          24740000
****************************************************************        24750000
*                                                                       24760000
* ROUTINE: $BCLIST - Return selected column names                       24770000
*                                                                       24780000
* ON ENTRY:  N/A                                                        24790000
*                                                                       24800000
* ON EXIT:                                                              24810000
*                                                                       24820000
*    R15 contains one of the following return codes.  The               24830000
*        condition code is set accordingly.                             24840000
*                                                                       24850000
*        RC00 - complete, column name list is null if SELECT * ...      24860000
*                                                                       24870000
*        RC04 - terminating error encountered                           24880000
*                                                                       24890000
****************************************************************        24900000
                                                                        24910000
$BCLIST  DS    0H                                                       24920000
         STM   R0,R15,REGSAVE     SAVE MAINLINE REGS                    24930000
         L     R6,QCSSSMRY        LOCATE SEMANTIC SUMMARY               24940000
         USING SQSEMAL,R6         ADDRESSABILITY                        24950000
                                                                        24960000
         ICM   R4,15,SQSASELC     SELECTED COLUMN LIST                  24970000
         BZ    $BCFIN             ALL COLUMNS SELECTED (*)              24980000
         USING SQREFP,R4          ORDERED SELECT LIST REFERENCES        24990000
                                                                        25000000
         USING DSQLRESP,R5        PREPARE FOR UPDATE                    25010000
$BCNEXT  DS    0H                                                       25020000
         L     R3,SQRNODE         COLUMN DEFINTION                      25030000
         USING SQCOLREF,R3        COLUMN ENTRY FORMAT                   25040000
                                                                        25050000
         $XPBUFR ISRT,DATA=SQCOLNM,DATALEN=L'SQCOLNM,                  X25060000
               EXPAND=YES                                               25070000
                                                                        25080000
         BNZ   $BCFAIL            FAIL IF ERROR                         25090000
                                                                        25100000
         ICM   R2,15,COLCOUNT     NUMBER OF COLUMNS SELECTED            25110000
         BNZ   $BCNGO             SKIP IF NOT THE FIRST                 25120000
                                                                        25130000
         L     R5,QCSRESP@        SQL RESPONSE HEADER            157382 25140000
         SR    R1,R5              COLUMN NAME LIST GENERATED?    157382 25150000
         STH   R1,DSQLCOL@        PORTABLE FORMAT FOR XMIT       157382 25160000
$BCNGO   DS    0H                                                       25170000
         LA    R2,1(,R2)          SELECTED COLUMN COUNT                 25180000
         ST    R2,COLCOUNT        UPDATE ACCORDINGLY                    25190000
                                                                        25200000
         ICM   R4,15,SQRLINK      ADVANCE TO NEXT COLUMN PLACEHOLDER    25210000
         BNZ   $BCNEXT            RETAIN ALL COLUMNS                    25220000
         DROP  R4,R3              SQREFP, SQCOLREF                      25230000
                                                                        25240000
*---------------------------------------------------------------        25250000
*   link up column name list to SQL response block header               25260000
*---------------------------------------------------------------        25270000
                                                                        25280000
         L     R5,QCSRESP@        SQL RESPONSE HEADER                   25290000
         L     R1,COLCOUNT        NUMBER OF COLUMNS SELECTED            25300000
         STH   R1,DSQLCOLC        POST FOR RETURN                       25310000
         DROP  R5,R6              DSQLRESP, SQSEMAL                     25320000
                                                                        25330000
*---------------------------------------------------------------        25340000
*   return completion status to caller                                  25350000
*---------------------------------------------------------------        25360000
                                                                        25370000
$BCFIN   DS    0H                                                       25380000
         LA    R15,RC00           FUNCTION COMPLETE                     25390000
         B     $BCRET                                                   25400000
                                                                        25410000
$BCFAIL  DS    0H                 TERMINATING ERROR ENCOUNTERED         25420000
         LA    R15,RC04           INDICATE FAILURE                      25430000
                                                                        25440000
$BCRET   DS    0H                                                       25450000
         LM    R0,R14,REGSAVE     RESTORE CALLERS REGS                  25460000
         LTR   R15,R15            CONVEY STATUS VIA CC                  25470000
         BR    R14                DONE                                  25480000
                                                                        25490000
         EJECT                                                          25500000
***************************************************************         25510000
*                                                                       25520000
* ROUTINE: $FCOL - Locate SYSCOL/SYSVAR pair by VDB column name         25530000
*                                                                       25540000
* ON ENTRY:                                                             25550000
*                                                                       25560000
*    R1 - addr of VDB column name                                       25570000
*                                                                       25580000
* ON EXIT:                                                              25590000
*                                                                       25600000
*    R15 contains one of the following return codes                     25610000
*                                                                       25620000
*        RC00 - syscolumn entry located                                 25630000
*                                                                       25640000
*               R1 - addr of SYSCOLUMN entry                            25650000
*               R0 - addr of associated SYSVARIABLE entry               25660000
*                                                                       25670000
*        RC04 - no matching SYSCOLUMN                                   25680000
*                                                                       25690000
***************************************************************         25700000
                                                                        25710000
$FCOL    DS    0H                                                       25720000
         STM   R0,R15,REGSAVE     SAVE REGS                             25730000
                                                                        25740000
         L     R4,QCSAVDBL        JOIN OF SYSCOLS & SYSVARS             25750000
         USING VDBLRET,R4                                               25760000
         LH    R3,LVDB#COL        VDB COLUMN COUNT                      25770000
         L     R2,LVDBACOL        ADDR OF FIRST VDB COL                 25780000
         USING SYSCOLS,R2         SYSCOLUMN FORMAT                      25790000
                                                                        25800000
$FNXT    DS    0H                                                       25810000
         CLC   SCOLNAME,0(R1)     MATCHING COLUMN NAMES?                25820000
         BE    $FHIT              MATCH IF SO                           25830000
         AH    R2,LVDBLCOL        ELSE ADVANCE TO NEXT                  25840000
         BCT   R3,$FNXT           AND TRY AGAIN                         25850000
         LA    R15,RC04           ERROR, STRUCTURES NOT RETURNED        25860000
         SR    R0,R0                                                    25870000
         SR    R1,R1                                                    25880000
         B     $FRET                                                    25890000
                                                                        25900000
$FHIT    DS    0H                                                       25910000
         SR    R0,R0              PREPARE FOR INSERT                    25920000
         ICM   R0,3,SCOLVEXE+(SKVARSC#-SKEYVAR) 16-BIT UNSIGNED OFFLINK 25930000
         AL    R0,LVDBAVAR        CONVERT TO SYSVARIABLE ADDRESS        25940000
         LA    R1,SYSCOLS         RETURN MATCHING COLUMN ENTRY          25950000
         LA    R15,RC00           INDICATE SUCCESS                      25960000
                                                                        25970000
$FRET    DS    0H                                                       25980000
         LM    R2,R14,REGSAVE+8   RESTORE REGS                          25990000
         BR    R14                RETURN                                26000000
         DROP  R2,R4              SYSCOLS, VDBLRET                      26010000
                                                                        26020000
         EJECT                                                          26030000
***************************************************************         26040000
*                                                                       26050000
* ROUTINE: $CLOCDEF - Locate TBCOLDEF entry by column name              26060000
*                                                                       26070000
* ON ENTRY:                                                             26080000
*                                                                       26090000
*    R0 - addr of standard table description (TBFMT);                   26100000
*         both address and offlink formats are accepted.                26110000
*                                                                       26120000
*    R1 - addr of padded column name                                    26130000
*                                                                       26140000
* ON EXIT:                                                              26150000
*                                                                       26160000
*    R15 contains one of the following return codes                     26170000
*                                                                       26180000
*        RC00 - TBCOLDEF entry located and return via R1                26190000
*        RC04 - TBCOLDEF entry not found                                26200000
*                                                                       26210000
***************************************************************         26220000
                                                                        26230000
$CLOCDEF DS    0H                                                       26240000
         STM   R0,R15,REGSAVE     SAVE REGS                             26250000
                                                                        26260000
         LR    R4,R0              TABLE DESCRIPTION                     26270000
         USING TBFMT,R4           DESCRIPTION HEADER FORMAT             26280000
                                                                        26290000
         L     R5,TBFCOFF         ORIGIN OF TBCOLDEF ARRAY              26300000
         CH    R5,=AL2(256)       PTR OR OFFSET?                        26310000
         BH    *+8                PTR                                   26320000
         LA    R5,TBFMT(R5)       ELSE RELOCATE                         26330000
         USING TBCOLDEF,R5        EACH ENTRY DESCRIBES ONE COLUMN       26340000
         LH    R3,TBF#COLS        NUMBER OF COLUMNS DEFINED             26350000
                                                                        26360000
$CLOCNXT DS    0H                                                       26370000
         CLC   TBCNAME,0(R1)      MATCHING COLUMN NAMES?                26380000
         BE    $CLOCHIT           BIY                                   26390000
         CLC   TBCSNAME,0(R1)     MATCHING COLUMN NAMES?                26400000
         BE    $CLOCHIT           BIY                                   26410000
         LA    R5,TBCOLEND        ELSE ADVANCE TO NEXT ENTRY            26420000
         BCT   R3,$CLOCNXT        AND TRY AGAIN                         26430000
         LA    R15,RC04           ERROR, STRUCTURES NOT RETURNED        26440000
         SR    R1,R1                                                    26450000
         B     $CLOCRET                                                 26460000
                                                                        26470000
$CLOCHIT DS    0H                                                       26480000
         LA    R1,TBCOLDEF        RETURN PTR TO COLDEF                  26490000
         LA    R15,RC00           INDICATE SUCCESS                      26500000
                                                                        26510000
$CLOCRET DS    0H                                                       26520000
         LM    R2,R14,REGSAVE+8   RESTORE REGS                          26530000
         BR    R14                RETURN                                26540000
         DROP  R4,R5              TBFMT, TBCOLDEF                       26550000
                                                                        26560000
         EJECT                                                          26570000
***************************************************************         26580000
*                                                                       26590000
* ROUTINE: COLNDX - Derive column number from column name               26600000
*                                                                       26610000
* ON ENTRY:                                                             26620000
*                                                                       26630000
*    R0 - addr of column name                                           26640000
*                                                                       26650000
*    R1 - addr of standard table description (TBFMT);                   26660000
*         offlink (offset) or ACON linkages accepted                    26670000
*                                                                       26680000
* ON EXIT:                                                              26690000
*                                                                       26700000
*    R15 contains one of the following return codes                     26710000
*                                                                       26720000
*        RC00 - column defined in table                                 26730000
*                                                                       26740000
*               R1 - TBCOLDEF entry origin                              26750000
*               R0 - column number (1 to N)                             26760000
*                                                                       26770000
*        RC04 - column not defined                                      26780000
*                                                                       26790000
***************************************************************         26800000
                                                                        26810000
COLNDX   DS    0H                                                       26820000
         STM   R0,R15,REGSAVE2    PRESERVE CALLERS REGS                 26830000
                                                                        26840000
         LR    R2,R0              COLUMN NAME                           26850000
         LR    R3,R1              TABLE DESCRIPTION HEADER              26860000
         USING TBFMT,R3           HEADER FORMAT                         26870000
                                                                        26880000
         LA    R15,RC04           PRESUME FAILURE                       26890000
         SR    R0,R0                                                    26900000
         SR    R1,R1                                                    26910000
                                                                        26920000
         LH    R5,TBF#COLS        COLUMN COUNT                          26930000
         LTR   R5,R5              VALID?                                26940000
         BNP   COLFIN             SERIOUS ERROR IF NOT                  26950000
                                                                        26960000
         L     R4,TBFCOFF         DISPLACEMENT TO COLUMN DEFS           26970000
         CL    R4,=A(256)         IN OFFLINK FORMAT?                    26980000
         BH    *+6                APPEARS TO BE IN PTR FORMAT           26990000
         AR    R4,R3              FIRST COLUMN DESCRIPTOR               27000000
         USING TBCOLDEF,R4        DECLARE INTENTIONS                    27010000
                                                                        27020000
*--------------------------------------------------------------         27030000
*   scan column definitions for match                                   27040000
*--------------------------------------------------------------         27050000
                                                                        27060000
COLSCAN  DS    0H                                                       27070000
         CLC   TBCNAME,0(R2)      MATCHING LONG NAME?                   27080000
         BE    COLMATCH                                                 27090000
         CLC   TBCSNAME,0(R2)     MATCHING SHORT NAME?                  27100000
         BE    COLMATCH                                                 27110000
         LA    R4,TBCOLEND        TRY NEXT ENTRY IF SO                  27120000
         BCT   R5,COLSCAN         ATTEMPTS TO MATCH                     27130000
         B     COLFIN             MATCHUP FAILS                         27140000
                                                                        27150000
*--------------------------------------------------------------         27160000
*   return matching column definition to caller                         27170000
*--------------------------------------------------------------         27180000
                                                                        27190000
COLMATCH DS    0H                                                       27200000
         LA    R1,TBCOLDEF        R1 <== COLUMN DEFINITION ENTRY        27210000
         LH    R0,TBF#COLS        TOTAL NUMBER OF COLUMNS               27220000
         BCTR  R5,0               RETURN 1-N                            27230000
         SR    R0,R5              COLUMN INDEX WHERE MATCH OCCURRED     27240000
         LA    R15,RC00           SUCCESS                               27250000
                                                                        27260000
COLFIN   DS    0H                 RETURN                                27270000
         LM    R2,R14,REGSAVE2+8  RESTORE MAINLINE REGS                 27280000
         LTR   R15,R15            CC REFLECTS OUTCOME                   27290000
         BR    R14                RETURN                                27300000
                                                                        27310000
         EJECT                                                          27320000
***************************************************************         27330000
*                                                                       27340000
* ROUTINE: $HOSTVAR - Resolve host variables                            27350000
*                                                                       27360000
* ON ENTRY:                                                             27370000
*                                                                       27380000
*    QCS is addressable                                                 27390000
*                                                                       27400000
* ON EXIT:                                                              27410000
*                                                                       27420000
*    R15 contains one of the following return codes                     27430000
*                                                                       27440000
*        RC00 - normal completion                                       27450000
*                                                                       27460000
*        RCnn - host variable processing error captured/logged          27470000
*                                                                       27480000
***************************************************************         27490000
                                                                        27500000
$HOSTVAR DS    0H                                                       27510000
         STM   R0,R15,REGSAVE     PRESERVE MAINLINE REGS                27520000
                                                                        27530000
*---------------------------------------------------------------        27540000
*   determine if host variables eligible and provided                   27550000
*---------------------------------------------------------------        27560000
                                                                        27570000
         CLI   QCSCLI,QCSC_PRP    SQLPrepare()?                         27580000
         BE    $HVPRFIN           NO HOST VAR PROCESSING IF SO          27590000
                                                                        27600000
         CLI   QCSOURCE,QCSS_RT   HOST VARIABLES MAY BE USED IN RUNTIME 27610000
         BNE   $HVPRFIN           NOT A RUNTIME REQUEST                 27620000
                                                                        27630000
         SR    R2,R2              PREPARE FOR INSERT                    27640000
         ICM   R2,15,HARGNO       HOST VARIABLES PROVIDED?              27650000
         BZ    $HVPRFIN                                                 27660000
                                                                        27670000
*---------------------------------------------------------------        27680000
*   resolve host variables                                              27690000
*---------------------------------------------------------------        27700000
                                                                        27710000
         @CALL ISQLHOSV,(*QCSSSMRY,*SQLPLIST,(R2),*HARGVEC,QCSGPSTG),  X27720000
               MF=(E,MFE_LIST)                                          27730000
                                                                        27740000
         ST    R15,HOSVRC         RETURN CODE                           27750000
         ST    R0,HOSVRSN         REASON CODE                           27760000
                                                                        27770000
         LTR   R15,R15            NORMAL COMPLETION?                    27780000
         BZ    $HVPRFIN           SUCCESS IF SO                         27790000
                                                                        27800000
*---------------------------------------------------------------        27810000
*   host variable processing error                                      27820000
*---------------------------------------------------------------        27830000
                                                                        27840000
         L     R15,HOSVRC                                               27850000
         L     R0,HOSVRSN                                               27860000
         LR    R2,R0              ISQLHOSV REASON CODE                  27870000
         SLL   R0,16              CONSOLIDATION                         27880000
         OR    R0,R15             COMBINE WITH RETURN CODE              27890000
                                                                        27900000
         SQLSTAT ERC_HOSV,INFO=(R0)                                     27910000
                                                                        27920000
         SQLMSG 080,*$HVMSGTB(R2)                                       27930000
                                                                        27940000
*---------------------------------------------------------------        27950000
*   host variable processing complete                                   27960000
*---------------------------------------------------------------        27970000
                                                                        27980000
$HVPRFIN DS    0H                                                       27990000
         L     R15,HOSVRC         RETURN SUCCESS/FAILURE INDICATOR      28000000
         LM    R0,R14,REGSAVE     RESTORE MAINLINE REGS                 28010000
         BR    R14                RETURN                                28020000
                                                                        28030000
*--------------------------------------------------------------         28040000
*   various failures relating to host variable processing               28050000
*--------------------------------------------------------------         28060000
                                                                        28070000
$HVMSGTB DS    0F                                                       28080000
         DC    F'0'               RSN00 - SUCCESSFUL COMPLETION         28090000
         DC    F'081'             RSN04 - COLUMN TYPE MISMATCH          28100000
         DC    F'082'             RSN08 - MORE HOST VARS EXPECTED       28110000
         DC    F'083'             RSN12 - LESS HOST VARS EXPECTED       28120000
         DC    F'010'             RSN16 - STORAGE FAILURE               28130000
         DC    F'053'             RSN20 - UNKNOWN FAILURE               28140000
                                                                        28150000
         EJECT                                                          28160000
***************************************************************         28170000
*                                                                       28180000
* ROUTINE:  $SARG - Generate table services search argument             28190000
*                                                                       28200000
* DESCRIPTION:                                                          28210000
*                                                                       28220000
*   When a SARG is provided in the form of a SQL where clause,          28230000
*   the predicate tree anchored in SQSITREE must be converted           28240000
*   to the native table services services search argument               28250000
*   format.  After the result set (table) has been created, the         28260000
*   SARG must be completed by binding column info to it using           28270000
*   the TBPSARG service.                                                28280000
*                                                                       28290000
*                                                                       28300000
* ON ENTRY:                                                             28310000
*                                                                       28320000
*   R1 - Addr of semantic summary (SQSEMAL)                             28330000
*                                                                       28340000
*                                                                       28350000
* ON EXIT:                                                              28360000
*                                                                       28370000
*   R15 contains one of the following return codes                      28380000
*                                                                       28390000
*       RC00 - successful completion                                    28400000
*                                                                       28410000
*              R1 - the address of the table services SARG or           28420000
*                   or zero if no SARG required                         28430000
*                                                                       28440000
*       RC04 - ITRESARG failure (treat as storage failure)              28450000
*                                                                       28460000
*              R0 - ITRESARG completion code                            28470000
*              R1 - zero                                                28480000
*                                                                       28490000
****************************************************************        28500000
                                                                        28510000
$SARG    DS    0H                                                       28520000
         STM   R0,R15,REGSAVE     PRESERVE MAINLINE REGS                28530000
         LR    R6,R1              SEMANTIC SUMMARY                      28540000
         USING SQSEMAL,R6         ADDRESSABILITY                        28550000
                                                                        28560000
         ICM   R1,15,SQSITREE     WHERE-CLAUSE INCLUDED?                28570000
         BZ    $SARGFIN           SKIP SECTION IF NOT                   28580000
                                                                        28590000
*--------------------------------------------------------------         28600000
*   convert SARG to table services format                               28610000
*--------------------------------------------------------------         28620000
                                                                        28630000
         @CALL ITRESARG,(*SQSITREE,QCSGPSTG),                          X28640000
               MF=(E,MFE_LIST)    CONVERT TO SEARCH ARGUMENT            28650000
                                                                        28660000
         LTR   R15,R15            NORMAL COMPLETION (R1 <== SARG)       28670000
         BNZ   $SARGERR           STORAGE FAILURE                       28680000
                                                                        28690000
*--------------------------------------------------------------         28700000
*   return success or failure and possibly a SARG                       28710000
*--------------------------------------------------------------         28720000
                                                                        28730000
$SARGFIN DS    0H                 R1 <== SARG ORIGIN OR ZERO            28740000
         LA    R15,RC00           SUCCESSFUL COMPLETION                 28750000
         B     $SARGRET           DONE                                  28760000
                                                                        28770000
$SARGERR DS    0H                                                       28780000
         LR    R0,R15             PRESERVE FAILING RETCODE              28790000
         SR    R1,R1              NO SARG RETURNED                      28800000
         LA    R15,RC04           INDICATE ERROR                        28810000
                                                                        28820000
$SARGRET DS    0H                                                       28830000
         LM    R2,R14,REGSAVE+8   RESTORE MAINLINE REGS                 28840000
         BR    R14                RETURN                                28850000
         DROP  R6                 SQSEMAL                               28860000
                                                                        28870000
         EJECT                                                          28880000
***************************************************************         28890000
*                                                                       28900000
* ROUTINE: MSGTMRSP - Extract diagnostics from TMRESP block             28910000
*                                                                       28920000
* ON ENTRY:                                                             28930000
*                                                                       28940000
*    R1 - addr of table interfaces response block (TMRESP)              28950000
*                                                                       28960000
* ON EXIT:                                                              28970000
*                                                                       28980000
*    R15 contains one of the following return codes                     28990000
*                                                                       29000000
*        RC00 - msg accepted                                            29010000
*        RC04 - insufficient storage in SQL response buffer             29020000
*                                                                       29030000
***************************************************************         29040000
                                                                        29050000
MSGTMRSP DS    0H                                                       29060000
         STM   R0,R15,REGSAVE     PRESERVE CALLING REGS                 29070000
         LA    R15,RC00           PRESUME ACCEPTABLE COMPLETION         29080000
                                                                        29090000
         LTR   R2,R1              TABLE INTERFACES RESPONSE BLOCK       29100000
         BZ    MSGTMRSX                                                 29110000
         USING TMRESP,R2                                                29120000
                                                                        29130000
         SR    R3,R3              PREPARE FOR INSERT                    29140000
         ICM   R3,3,TMRSDATL      LENGTH OF MESSAGE                     29150000
         BNP   MSGTMRSX           NONE AVAILABLE                        29160000
                                                                        29170000
         SQLRESP (TMRSDATA,(R3)),DSQLRESP=QCSRESP@,WKA=WRK256           29180000
                                                                        29190000
*--------------------------------------------------------------         29200000
*   return completion status to caller                                  29210000
*--------------------------------------------------------------         29220000
                                                                        29230000
MSGTMRSX DS    0H                                                       29240000
         LM    R0,R14,REGSAVE     RETRIEVE CALLERS REGS                 29250000
         LTR   R15,R15            COMPLETION STATUS VIA CC              29260000
         BR    R14                RETURN                                29270000
         DROP  R2                 TMRESP                                29280000
                                                                        29290000
         EJECT                                                          29300000
***************************************************************         29310000
*                                                                       29320000
* ROUTINE: URUMSGS - Transport RU-format messages                       29330000
*                                                                       29340000
* DESCRIPTION:                                                          29350000
*                                                                       29360000
*    This routine is used to transfer a block of messages in            29370000
*    RU message return format to the SQL response message area.         29380000
*                                                                       29390000
*                                                                       29400000
* NOTES:                                                                29410000
*                                                                       29420000
*    The SQL response message area must have been previously            29430000
*    established (DSQLMSGC, DSQLMSG@) by other message calls.           29440000
*                                                                       29450000
*                                                                       29460000
* ON ENTRY:                                                             29470000
*                                                                       29480000
*    R1 - addr of rumsgs message return area                            29490000
*                                                                       29500000
*                                                                       29510000
* ON EXIT:                                                              29520000
*                                                                       29530000
*    R15 contains one of the following return codes                     29540000
*                                                                       29550000
*        RC00 - msg(s) accepted                                         29560000
*        RC04 - insufficient storage in SQL response buffer             29570000
*                                                                       29580000
***************************************************************         29590000
                                                                        29600000
URUMSGS  DS    0H                                                       29610000
         STM   R0,R15,REGSAVE     PRESERVE CALLING REGS                 29620000
         LA    R15,RC00           PRESUME NO WORK                       29630000
         LTR   R4,R1              RUMSGS AREA PROVIDED?                 29640000
         BZ    URUEXIT            FAST RETURN IF NOT                    29650000
                                                                        29660000
         USING RUMSGS,R4          MESSAGE RETURN AREA FORMAT            29670000
         SR    R2,R2              PREPARE FOR INSERT                    29680000
         ICM   R2,3,RUMSGCT       MESSAGES WAITING?                     29690000
         BZ    URUEXIT            DONE                                  29700000
                                                                        29710000
         L     R3,RUMUSED         TOTAL SPACE CONSUMED BY BUFFER        29720000
         SH    R3,=AL2(RUMFXLN)   ISOLATE SPACE CONSUMED BY MESSAGES    29730000
         BNP   URUEXIT            DONE                                  29740000
                                                                        29750000
         LA    R5,RUMTEXT         FIRST MESSAGE                         29760000
                                                                        29770000
*--------------------------------------------------------------         29780000
*   slot each msg                                                       29790000
*--------------------------------------------------------------         29800000
                                                                        29810000
URNXTMSG DS    0H                                                135096 29820000
         LH    R0,0(,R5)          R0 <== MSG LENGTH              135096 29830000
                                                                        29840000
         SQLRESP (2(,R5),(R0)),DSQLRESP=QCSRESP@,WKA=WRK256             29850000
                                                                        29860000
         AH    R5,0(,R5)          ADVANCE TO NEXT MSG            135096 29870000
         LA    R5,2(,R5)          ACCOUNT FOR LENGTH HWORD       135096 29880000
         BCT   R2,URNXTMSG        AGAIN                          135096 29890000
                                                                        29900000
*--------------------------------------------------------------         29910000
*   return completion status to caller                                  29920000
*--------------------------------------------------------------         29930000
                                                                        29940000
URUEXIT  DS    0H                                                       29950000
         LM    R0,R14,REGSAVE     RETRIEVE CALLERS REGS                 29960000
         LTR   R15,R15            COMPLETION STATUS VIA CC              29970000
         BR    R14                RETURN                                29980000
         DROP  R4                 RUMSGS                                29990000
                                                                        30000000
         EJECT                                                          30010000
***************************************************************         30020000
*                                                                       30030000
* ROUTINE: MSGBCALL - Format a msg buffer using $MSG                    30040000
*                                                                       30050000
* ON ENTRY:                                                             30060000
*                                                                       30070000
*    R0 - message count                                                 30080000
*    R1 - message number list origin                                    30090000
*                                                                       30100000
* ON EXIT:                                                              30110000
*                                                                       30120000
*    R15 contains one of the following return codes                     30130000
*                                                                       30140000
*        RC00 - msg accepted                                            30150000
*        RC04 - insufficient storage in response buffer                 30160000
*                                                                       30170000
***************************************************************         30180000
                                                                        30190000
MSGBCALL DS    0H                                                       30200000
         STM   R0,R15,REGSAVE     PRESERVE CALLING REGS                 30210000
         LR    R6,R0              MESSAGE COUNT                         30220000
         LR    R3,R1              MESSAGE NUMBER LIST ORIGIN            30230000
                                                                        30240000
         LA    R4,WRK1K           ADDRESS OF MESSAGE RETURN AREA        30250000
         USING $MSGBUF,R4         ADDRESSABILITY                        30260000
         XC    $MSGBUF($MSBPFXL),$MSGBUF                                30270000
                                                                        30280000
*--------------------------------------------------------------         30290000
*   buffer all msgs                                                     30300000
*--------------------------------------------------------------         30310000
                                                                        30320000
MSGBCNXT DS    0H                                                       30330000
         $MSG  *0(,R3),           APPEND MSG TEXT TO BUFFER            +30340000
               BUFR=WRK1K,                                             +30350000
               BUFL=L'WRK1K,                                           +30360000
               DEST=$BUFFER                                             30370000
                                                                        30380000
         LA    R3,4(,R3)          ADVANCE TO NEXT MESSAGE CODE          30390000
         BCT   R6,MSGBCNXT        PROCESS ALL MSGS                      30400000
                                                                        30410000
*--------------------------------------------------------------         30420000
*   finish by posting the message to the SQL response buffer            30430000
*--------------------------------------------------------------         30440000
                                                                        30450000
         LA    R1,WRK1K           R1->MSGBUF                            30460000
         BAS   R14,MSGBPROC       PROCESS MSG BUFFER                    30470000
                                                                        30480000
         LM    R0,R14,REGSAVE     RETRIEVE CALLING REGS                 30490000
         LTR   R15,R15            REFLECT COMPLETION STATUS             30500000
         BR    R14                RETURN                                30510000
         DROP  R4                 $MSGBUF                               30520000
                                                                        30530000
         EJECT                                                          30540000
***************************************************************         30550000
*                                                                       30560000
* ROUTINE: MSGBPROC - Post $MSGBUF to SQL response buffer               30570000
*                                                                       30580000
* ON ENTRY:                                                             30590000
*                                                                       30600000
*    R1 - address of message buffer in $MSGBUF format                   30610000
*                                                                       30620000
* ON EXIT:                                                              30630000
*                                                                       30640000
*    R15 contains one of the following return codes. The                30650000
*        condition codes is set accordingly.                            30660000
*                                                                       30670000
*        RC00 - all msgs accepted                                       30680000
*        RC04 - insufficient storage in response buffer                 30690000
*                                                                       30700000
***************************************************************         30710000
                                                                        30720000
MSGBPROC DS    0H                                                       30730000
         STM   R0,R15,REGSAVE2    PRESERVE CALLING REGS                 30740000
                                                                        30750000
         LR    R3,R1              $MSGBUF ADDRESS                       30760000
         USING $MSGBUF,R3                                               30770000
         LH    R4,$MSGCNT         EXTRACT THE MESSAGE COUNT             30780000
         LTR   R4,R4              NONE GENERATED                        30790000
         BZ    MSGBRC0            RETURN                                30800000
                                                                        30810000
         L     R6,$MSGQF          LOCATE FIRST MSG                      30820000
         USING $MSBHDR,R6                                               30830000
                                                                        30840000
*--------------------------------------------------------------         30850000
*   stack each msg in the response buffer                               30860000
*--------------------------------------------------------------         30870000
                                                                        30880000
MSGBPROL DS    0H                 PROCESS THE BUFFER IN LOOP            30890000
         LH    R0,$MSBLEN         R0 <== MESSAGE LENGTH                 30900000
         LA    R1,$MSBTEXT        R1 <== MESSAGE TEXT                   30910000
                                                                        30920000
         SQLRESP ($MSBTEXT,(R0)),DSQLRESP=QCSRESP@,WKA=WRK256           30930000
                                                                        30940000
         ICM   R6,15,$MSBLINK     ADVANCE TO NEXT MSG HEADER     135096 30950000
         BZ    MSGBRC0            STRANGE                        135096 30960000
         BCT   R4,MSGBPROL        PROCESS ALL MSGS               135096 30970000
                                                                        30980000
*--------------------------------------------------------------         30990000
*   return completion status to caller                                  31000000
*--------------------------------------------------------------         31010000
                                                                        31020000
MSGBRC0  DS    0H                                                       31030000
         LA    R15,RC00           SUCCESS                               31040000
                                                                        31050000
MSGBPRET DS    0H                                                135096 31060000
         LM    R0,R14,REGSAVE2    RESTORE CALLER'S REGISTERS            31070000
         LTR   R15,R15            CC REFLECTS COMPLETION STATUS         31080000
         BR    R14                RETURN                                31090000
         DROP  R3,R6              $MSGBUF, $MSBHDR                      31100000
                                                                        31110000
         EJECT                                                          31120000
****************************************************************        31130000
*                                                                       31140000
* ROUTINE: TAGTOKEN - Identify token in SQL source statement            31150000
*                                                                       31160000
* ON ENTRY:                                                             31170000
*                                                                       31180000
*    R1 - addr of #CLEX entry or zero if #CLEX not identified           31190000
*                                                                       31200000
* ON EXIT:                                                              31210000
*                                                                       31220000
*    COSQLEOF (token offset) and COSQLELN (token length) updated        31230000
*                                                                       31240000
****************************************************************        31250000
                                                                        31260000
TAGTOKEN DS    0H                 R1 <== #CLEX TOKEN                    31270000
         LTR   R1,R1              #CLEX NODE PRESENT?                   31280000
         BZR   R14                SIMPLIFY CALLERS LOGIC                31290000
                                                                        31300000
         USING #CLEX_NODE_S,R1    #CLEX FORMAT                          31310000
         MVC   COSQLEOF,#CLEX_OFFSET  TOKEN OFFSET IN SQL STATEMENT     31320000
         MVC   COSQLELN,#CLEX_LENGTH  TOKEN LENGTH                      31330000
         BR    R14                DONE                                  31340000
                                                                        31350000
         EJECT                                                          31360000
***************************************************************         31370000
*                                                                       31380000
* ROUTINE: JRNLSQL - Journal SQL request                                31390000
*                                                                       31400000
* DESCRIPTION:                                                          31410000
*                                                                       31420000
*   Journal the inbound request. If the message is accepted,            31430000
*   the associated message class is active. That fact is noted          31440000
*   to control the issuance of related journal messages later.          31450000
*                                                                       31460000
***************************************************************         31470000
                                                                        31480000
JRNLSQL  DS    0H                                                       31490000
         STM   R0,R14,REGSAVE     PRESERVE MAINLINE REGS                31500000
                                                                        31510000
         LA    R2,REQEXEC         SQLEXECUTE() THE MOST COMMON REQUEST  31520000
         CLI   QCSCLI,QCSC_EXE    ASSUMPTION CORRECT?                   31530000
         BE    JRNLMSG                                                  31540000
                                                                        31550000
         LA    R2,REQPLAN         ASSUME VIEW PLAN                      31560000
         TM    QCSEFLG2,QCS2_PLN+QCS2_PDE                               31570000
         BNZ   JRNLMSG                                                  31580000
                                                                        31590000
         LA    R2,REQEXECD        ASSUME EXECDIRECT() OR WORKBENCH      31600000
         CLI   QCSOURCE,QCSS_WB   WORKBENCH?                            31610000
         BE    JRNLMSG                                                  31620000
         CLI   QCSCLI,QCSC_EXD    EXECDIRECT()?                         31630000
         BE    JRNLMSG                                                  31640000
                                                                        31650000
         LA    R2,REQPREP         PREPARE()                             31660000
         CLI   QCSCLI,QCSC_PRP    EXECDIRECT?                           31670000
         BE    JRNLMSG                                                  31680000
         LA    R2,REQUNKWN        REQUEST UNRECOGNIZED                  31690000
                                                                        31700000
JRNLMSG  DS    0H                                                       31710000
         $MSG  002,FIELDS=(((R2)),QCSUSRID,QCSOURCE,                   X31720000
               (*QCSTMTP,*QCSTMTLN))                                    31730000
                                                                        31740000
         LTR   R15,R15            JOURNALLING INBOUND REQUESTS?         31750000
         BNZ   *+8                SKIP IF NOT                           31760000
         OI    QFLAGS,Q$JRNL      DETAIL MESSAGES ELIGIBLE              31770000
                                                                        31780000
         LM    R0,R14,REGSAVE     PRESERVE MAINLINE REGS                31790000
         BR    R14                RETURN                                31800000
                                                                        31810000
         EJECT                                                          31820000
***************************************************************         31830000
*                                                                       31840000
* ROUTINE: RECOVRTN - ABEND recovery                                    31850000
*                                                                       31860000
* DESCRIPTION:                                                          31870000
*                                                                       31880000
*    This process recovery routine establishes a recovery               31890000
*    environment for ISQLDRV and all services invoked by it.            31900000
*    If a recoverable ABEND occurs, registers are restored to           31910000
*    the intial ISQLDRV entry state and an error continuation           31920000
*    point is selected.                                                 31930000
*                                                                       31940000
***************************************************************         31950000
                                                                        31960000
RECOVRTN DS    0H                                                       31970000
         PUSH  USING                                                    31980000
         USING ISQLDRV,R12,R9                                           31990000
         ST    R1,TSKERCVR+(R13*4)                                      32000000
W        USING WORKAREA,R1                                              32010000
                                                                        32020000
         L     R8,W.@QCS             RESTORE QCS POINTER PER CONVENTION 32030000
         STM   R2,R12,TSKERCVR+(R2*4)                                   32040000
                                                                        32050000
         SR    R15,R15               ASSUME TERMINATION                 32060000
         TM    W.RCVFLAGS,RCVF$ABE   ABEND RECURSION POSSIBLE?          32070000
         BOR   R14                   FORCE TERMINATION IF SO            32080000
         OI    W.RCVFLAGS,RCVF$ABE   INDICATE ERROR ENCOUNTERED         32090000
                                                                        32100000
         L     R15,=A(ERR_ABND)                                         32110000
         BR    R14                                                      32120000
         POP   USING                                                    32130000
                                                                        32140000
         EJECT                                                          32150000
         SQLCODES ,                                                     32160000
                                                                        32170000
         EJECT                                                          32180000
***************************************************************         32190000
*                                                                       32200000
*   SARG failure reasons                                                32210000
*                                                                       32220000
***************************************************************         32230000
                                                                        32240000
MSGSARG1 DS    0F             INVALID SARG PREDICATE (RC08)             32250000
         DC    F'0'               RSN00 - SUCCESSFUL COMPLETION         32260000
         DC    F'061'             RSN04                                 32270000
         DC    F'062'             RSN08                                 32280000
         DC    F'063'             RSN12                                 32290000
         DC    F'064'             RSN16                                 32300000
         DC    F'065'             RSN20                                 32310000
         DC    F'066'             RSN24                                 32320000
         DC    F'067'             RSN28                                 32330000
         DC    F'053'             RSN32 - RESERVED                      32340000
         DC    F'069'             RSN36                                 32350000
         DC    F'053'             RSN40 - RESERVED                      32360000
         DC    F'053'             RSN44 - RESERVED                      32370000
         DC    F'053'             RSN48 - RESERVED                      32380000
                                                                        32390000
***************************************************************         32400000
*                                                                       32410000
*   VDB load failures                                                   32420000
*                                                                       32430000
***************************************************************         32440000
                                                                        32450000
MSGLVDBX DS    0F             MISSING / INVALID VDB DEFINITION RSNS     32460000
         DC    F'0'               RSN00 - SUCCESSFUL COMPLETION         32470000
         DC    F'032'                                                   32480000
         DC    F'033'                                                   32490000
         DC    F'034'                                                   32500000
         DC    F'035'                                                   32510000
         DC    F'053'                                                   32520000
                                                                        32530000
***************************************************************         32540000
*                                                                       32550000
*   Misc read-only data areas                                           32560000
*                                                                       32570000
***************************************************************         32580000
                                                                        32590000
BLANKS   DC    CL32' '                                                  32600000
                                                                        32610000
REQPLAN  DC    C'ViewPlan',X'00'                                        32620000
REQPREP  DC    C'SQLPrepare',X'00'                                      32630000
REQEXEC  DC    C'SQLExecute',X'00'                                      32640000
REQEXECD DC    C'SQLExecDirect',X'00'                                   32650000
REQUNKWN DC    C'UNKNOWN REQUEST',X'00'                                 32660000
                                                                        32670000
@VERXCOL @VERSION 10A                                                   32680000
                                                                        32690000
         LTORG ,                                                        32700000
                                                                        32710000
         EJECT                                                          32720000
         #CLEX ,             COPYRIGHT, PTI INC.                        32730000
                                                                        32740000
         PRINT NOGEN                                                    32750000
         ICVT  ,                                                        32760000
         ITASK ,                                                        32770000
         IPCB  ,                                                        32780000
         IUSER ,                                                        32790000
         IPROJ ,                                                        32800000
         END   ,                                                        32810000

INAVSTNV TITLE 'VERIFY CURRENT IMAGE AGAINST MODEL IMAGE'               00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: INAVSTNV - VERIFY CURRENT IMAGE AGAINST MODEL IMAGE          00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THIS ROUTINE IS USED TO DETERMINE WHETHER THE CURRENT              00080000
*    IMAGE ASSOCIATED WITH A SLU SESSION MATCHES THE MODEL              00090000
*    IMAGE DEFINED FOR THE PRESUMED CURRENT STATE.                      00100000
*                                                                       00110000
*                                                                       00120000
* METHOD:                                                               00130000
*                                                                       00140000
*    THE AAP PROVIDED AS AN ARGUMENT CONTAINS THE SLU SESSION           00150000
*    HANDLE WHICH, IN TURN, PROVIDES ACCESS TO THE CURRENT              00160000
*    IMAGE AND THE CURRENT STN - THE PRESUMED CURRENT STATE.            00170000
*                                                                       00180000
*                                                                       00190000
* NOTES:                                                                00200000
*                                                                       00210000
*    THE NVIMAGE CONSTRUCTED FOR THE MODEL IS RETAINED; THE             00220000
*    NVIMAGE REPRESENTING THE CURRENT IMAGE IS DISCARDED.               00230000
*                                                                       00240000
*                                                                       00250000
* ON ENTRY:                                                             00260000
*                                                                       00270000
*    R1  CONTAINS THE ADDRESS OF A PARAMETER LIST CONSTRUCTED           00280000
*        AS FOLLOWS:                                                    00290000
*                                                                       00300000
*        +00 - ADDR OF AAP                                              00310000
*        +04 - ADDR OF IPROJ                                            00320000
*                                                                       00330000
*                                                                       00340000
* ON EXIT:                                                              00350000
*                                                                       00360000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES                     00370000
*                                                                       00380000
*        RC00 - CURRENT IMAGE MATCHES THE MODEL IMAGE                   00390000
*                                                                       00400000
*        RC04 - CURRENT IMAGE DOES NOT MATCH THE MODEL IMAGE            00410000
*                                                                       00420000
*        RC08 - SLU SESSION INFORMATION NOT AVAILABLE                   00430000
*                                                                       00440000
*        RC12 - IMAGE PROCESSING ERROR                                  00450000
*                                                                       00460000
*               R0 - SERVICE ROUTINE RETURN CODE                        00470000
*               R1 - ADDRESS OF CL8 SERVICE NAME                        00480000
*                                                                       00490000
**<DOC-OFF>****************************************************         00500000
                                                                        00510000
         EJECT ,                                                        00520000
***************************************************************         00530000
*                                                                       00540000
* MAINTENANCE:                                                          00550000
*                                                                       00560000
*    07/15/94 R. TURGEON - PAR 120487, 127415                           00570000
*             INITIAL VERSION                                           00580000
*                                                                       00590000
*    11/21/94 SU-FEN WU  - PAR 156082                                   00591002
*             ACCEPT CLEAR SCREEN IN LOADIMAG (RC04)                    00592003
*                                                                       00593002
***************************************************************         00600000
         EJECT                                                          00610000
         #WORK ,                  READ/WRITE WORKAREA                   00620000
                                                                        00630000
SERVNAME DS    CL8                NAME OF FAILING SERVICE               00640000
IMAGE    DS    A                  ADDR OF NVIMAGE                       00650000
                                                                        00660000
#CMPINFO DS    0D                                                       00670000
         CMPINFO DSECT=NO         IMAGE UTILITY FUNCTIONS RETURN AREA   00680000
                                                                        00690000
RETREGS  DS    3F                 R15-R1 RETURN REGS                    00700000
REGSAVE  DS    18F                LOCAL SUBROUTINE SAVEAREA             00710000
                                                                        00720000
         #ENDWORK                                                       00730000
                                                                        00740000
         EJECT                                                          00750000
         NAV ,                    NAVIGATION STRUCTURES                 00760000
                                                                        00770000
         EJECT                                                          00780000
         SESSIMAG ,               SESSION IMAGING BLOCK                 00790000
                                                                        00800000
         EJECT                                                          00810000
         SLUHANDL ,               SLU HANDLE                            00820000
                                                                        00830000
         EJECT                                                          00840000
         EQUS  ,                  GENERAL EQUATES                       00850000
                                                                        00860000
         EJECT                                                          00870000
INAVSTNV #ENTER PREG=R8                                                 00880000
                                                                        00890000
         USING ITASK,R10          STDENV                                00900000
         L     R9,TSKPCBC                                               00910000
         USING IPCB,R9            PROCESS MODE                          00920000
                                                                        00930000
         L     R5,0(,R8)          LIFE OF FUNCTION                      00940000
         USING AAP,R5             AAP ADDRESSABILITY                    00950000
                                                                        00960000
         L     R7,4(,R8)          LIFE OF FUNCTION                      00970000
         USING IPROJ,R7           IPROJ ADDRESSABILITY                  00980000
                                                                        00990000
         EJECT                                                          01000000
***************************************************************         01010000
*                                                                       01020000
*    COMPARE THE MODEL IMAGE TO THE CURRENT IMAGE, REFERRED TO          01030000
*    HERE AS THE 'CANDIDATE' IMAGE, AS FOLLOWS:                         01040000
*                                                                       01050000
*       1) CREATE AN NVIMAGE REPRESENTING THE CANDIDATE IMAGE           01060000
*       2) LOAD THE SYSIMAGE ASSOCIATED WITH THE CURRENT STN            01070000
*       3) PREPARE MODEL AND CANDIDATE IMAGES FOR COMPARE               01080000
*       4) COMPARE THE MODEL AND CANDIDATE IMAGES                       01090000
*                                                                       01100000
***************************************************************         01110000
         ICM   R3,15,AAPSLUH      SLU SESSION HANDLE                    01120000
         BZ    WRN_NSLU           NOT AVAILABLE                         01130000
         USING SLUHANDL,R3        INSPECT SLU HANDLE                    01140000
         ICM   R1,15,SLHSIMAG     R1 <== SESSION IMAGING BLOCK          01150000
         BZ    WRN_NSLU           NOT AVAILABLE                         01160000
                                                                        01170000
         BAS   R14,CURRIMAG       BUILD NVIMAGE FOR CURRENT BUFFER      01180000
         BNP   ERR_SERV           ERROR                                 01190000
         ST    R15,IMAGE          SAVE THE IMAGE POINTER                01200000
         DROP  R3                 SLUHANDL                              01210000
                                                                        01220000
*--------------------------------------------------------------         01230000
*   LOAD THE MODEL SYSIMAGE ASSOCIATED WITH STATE DEFINING STN          01240000
*--------------------------------------------------------------         01250000
         L     R4,AAPCURR         LOCATE STN DEFINING CURRENT STATE     01260000
         USING NVSTN,R4                                                 01270000
                                                                        01280000
         LR    R1,R4              R1 <== CURRENT STATE                  01290000
         BAS   R14,LOADIMAG       FETCH SYSIMAGE IF REQUIRED            01300000
         C     R15,=A(RC04)       RC04 <== NO IMAGE (CLEAR SCREEN)      01301001
         BH    ERR_SERV           ERROR                                 01310001
                                                                        01320000
*--------------------------------------------------------------         01330000
*   PREPARE THE MODEL AND CANDIDATE IMAGES FOR COMPARE                  01340000
*--------------------------------------------------------------         01350000
         L     R0,NVSIMGA         R0 <== ADDR OF MODEL                  01360000
         L     R1,IMAGE           R1 <== ADDR OF CANDIDATE              01370000
         BAS   R14,PREPIMAG       PREPARE BOTH IMAGES                   01380000
         BNZ   ERR_SERV           ERROR                                 01390000
                                                                        01400000
*--------------------------------------------------------------         01410000
*   COMPARE THE MODEL AND CANDIDATE IMAGES                              01420000
*--------------------------------------------------------------         01430000
         L     R0,NVSIMGA         R0 <== ADDR OF MODEL                  01440000
         L     R1,IMAGE           R1 <== ADDR OF CANDIDATE              01450000
         BAS   R14,COMPIMAG       COMPARE BOTH IMAGES                   01460000
         BZ    *+8                IMAGES MATCH                          01470000
         LA    R15,RC04           INDICATE MISMATCH                     01480000
         DROP  R4                 NVSTN                                 01490000
                                                                        01500000
         EJECT                                                          01510000
***************************************************************         01520000
*                                                                       01530000
*   CLEANUP, RETURN COMPLETION STATUS TO CALLER                         01540000
*                                                                       01550000
***************************************************************         01560000
NORMRET  DS    0H                 COMPARE COMPLETE, RESULT IN R15       01570000
         SR    R0,R0              NO REASON CODE                        01580000
         SR    R1,R1              NO INFO CODE                          01590000
         B     STDRET             SERVICE ROUTINE NAME PTR IN R1        01600000
                                                                        01610000
WRN_NSLU DS    0H                 SLU SESSION TERMINATED, ETC.          01620000
         LA    R15,RC08           LOCAL RETURN CODE                     01630000
         SR    R0,R0              NO REASON CODE                        01640000
         SR    R1,R1              NO INFO CODE                          01650000
         B     STDRET             SERVICE ROUTINE NAME PTR IN R1        01660000
                                                                        01670000
ERR_SERV DS    0H                 ERROR DETECTED IN SERVICE RTN         01680000
         LR    R0,R15             RETAIN SERVICE RTN COMPLETION CODE    01690000
         LA    R15,RC12           LOCAL RETURN CODE                     01700000
         B     STDRET             SERVICE ROUTINE NAME PTR IN R1        01710000
                                                                        01720000
*--------------------------------------------------------------         01730000
*   CLEANUP AND EXIT                                                    01740000
*--------------------------------------------------------------         01750000
STDRET   DS    0H                 CLEANUP                               01760000
         STM   R15,R1,RETREGS     PRESERVE STATUS REGS                  01770000
         LA    R1,IMAGE           R1 <== ADDR OF CURRENT NVIMAGE PTR    01780000
         BAS   R14,FREEIMAG       FREE NVIMAGE FOR CURRENT BUFFER       01790000
         LM    R15,R1,RETREGS                                           01800000
                                                                        01810000
         #EXIT ,                  RETURN TO CALLER                      01820000
                                                                        01830000
         EJECT                                                          01840000
***************************************************************         01850000
*                                                                       01860000
* ROUTINE:  CURRIMAG - BUILD NVIMAGE FOR CURRENT 3270 BUFFER            01870000
*                                                                       01880000
* DESCRIPTION:                                                          01890000
*                                                                       01900000
*    THE 'CURRENT' 3270 BUFFER IS THAT CONTAINED IN THE STATE1          01910000
*    IMAGE SECTION OF THE SESSIMAG BLOCK PASSED TO THIS ROUTINE.        01920000
*                                                                       01930000
* NOTES:                                                                01940000
*                                                                       01950000
*    THE NVIMAGE IS BUILT IN PCB STORAGE                                01960000
*                                                                       01970000
* ON ENTRY:                                                             01980000
*                                                                       01990000
*    R1  CONTAINS THE ADDRESS OF THE SESSIMAG BLOCK DESCRIBING          02000000
*        THE CURRENT APPLICATION STATE                                  02010000
*                                                                       02020000
* ON EXIT:                                                              02030000
*                                                                       02040000
*    R15 CONTAINS THE ADDRESS OF AN NVIMAGE OR A NEGATIVE               02050000
*        ERROR COMPLETION CODE RETURNED BY IMGBLD1                      02060000
*                                                                       02070000
*    R1  CONTAINS A SERVICE ROUTINE NAME PTR FOR ERROR HANDLERS         02080000
*                                                                       02090000
***************************************************************         02100000
CURRIMAG DS    0H                                                       02110000
         STM   R0,R15,REGSAVE     SAVE MAINLINE REGISTERS               02120000
                                                                        02130000
         LR    R6,R1              ACCEPT SESSIMAG                       02140000
         USING SESSIMAG,R6                                              02150000
         L     R3,SEIS1IMG        FETCH IMAGE BUFFER ADDRESS            02160000
                                                                        02170000
         $CLINK FUNC=IMGBLD1,                                          X02180000
               (STRUCT*,PCBSTG),                                       X02190000
               (STRUCT*,(R3)),                                         X02200000
               (SHORT,SEIS1ROW),                                       X02210000
               (SHORT,SEIS1COL),                                       X02220000
               (LONG,SEISCSR)                                           02230000
                                                                        02240000
CICPT    DS    0H                                                       02250000
         LA    R1,=CL8'IMGFREE'   SERVICE ROUTINE NAME                  02260000
         LM    R2,R14,REGSAVE+8   RESTORE MAINLINE REGISTERS            02270000
         LTR   R15,R15            REFLECT COMPLETION STATUS VIA CC      02280000
         BR    R14                RETURN TO CALLER                      02290000
         DROP  R6                 SESSIMAG                              02300000
                                                                        02310000
         EJECT                                                          02320000
***************************************************************         02330000
*                                                                       02340000
* ROUTINE:  LOADIMAG - LOAD MODEL IMAGE FOR STN                         02350000
*                                                                       02360000
* NOTES:                                                                02370000
*                                                                       02380000
*    THE MODEL NVIMAGE IS BUILT IN PROJECT STORAGE                      02390000
*                                                                       02400000
* ON ENTRY:                                                             02410000
*                                                                       02420000
*    R1  CONTAINS THE ADDRESS OF AN STN                                 02430000
*                                                                       02440000
* ON EXIT:                                                              02450000
*                                                                       02460000
*    R15 CONTAINS THE IMGLOAD RETURN CODE OR ZERO IF THE MODEL          02470000
*        IMAGE WAS PREVIOUSLY LOADED                                    02480000
*                                                                       02490000
*    R1  CONTAINS A SERVICE ROUTINE NAME PTR FOR ERROR HANDLERS         02500000
*                                                                       02510000
***************************************************************         02520000
LOADIMAG DS    0H                                                       02530000
         STM   R0,R15,REGSAVE     SAVE MAINLINE REGISTERS               02540000
                                                                        02550000
         LR    R4,R1              ACCEPT STN                            02560000
         USING NVSTN,R4                                                 02570000
                                                                        02580000
         LA    R15,RC00           ASSUME MODEL IMAGE PREV LOADED        02590000
         ICM   R0,15,NVSIMGA      ASSUMPTION CORRECT?                   02600000
         BNZ   LICPT              DONE IF SO                            02610000
                                                                        02620000
         $CLINK FUNC=IMGLOAD,                                          X02630000
               (STRUCT*,PRJEXSTG),                                     X02640000
               (STRUCT*,NVSTN)                                          02650000
                                                                        02660000
LICPT    DS    0H                                                       02670000
         LA    R1,=CL8'IMGLOAD'   SERVICE ROUTINE NAME                  02680000
         LM    R2,R14,REGSAVE+8   RESTORE MAINLINE REGISTERS            02690000
         BR    R14                RETURN TO CALLER                      02710000
         DROP  R4                 NVSTN                                 02720000
                                                                        02730000
         EJECT                                                          02740000
***************************************************************         02750000
*                                                                       02760000
* ROUTINE:  PREPIMAG - PREPARE IMAGES FOR COMPARE                       02770000
*                                                                       02780000
* ON ENTRY:                                                             02790000
*                                                                       02800000
*    R0  ADDR OF NVIMAGE #1 - THE MODEL IMAGE                           02810000
*    R1  ADDR OF NVIMAGE #2 - THE CANDIDATE IMAGE                       02820000
*                                                                       02830000
* ON EXIT:                                                              02840000
*                                                                       02850000
*    R15 CONTAINS THE IMGPREP RETURN CODE                               02860000
*                                                                       02870000
*    R1  CONTAINS A SERVICE ROUTINE NAME PTR FOR ERROR HANDLERS         02880000
*                                                                       02890000
***************************************************************         02900000
PREPIMAG DS    0H                                                       02910000
         STM   R0,R15,REGSAVE     SAVE MAINLINE REGISTERS               02920000
                                                                        02930000
         LR    R2,R0              NVIMAGE #1                            02940000
         LR    R3,R1              NVIMAGE #2                            02950000
                                                                        02960000
         $CLINK FUNC=IMGPREP,                                          X02970000
               (STRUCT*,PCBSTG),                                       X02980000
               (STRUCT*,(R2)),                                         X02990000
               (STRUCT*,(R3)),                                         X03000000
               (STRUCT*,#CMPINFO)                                       03010000
                                                                        03020000
         MVC   AAPCIRC,CIRETCD    RETURN CODE                           03030000
         MVC   AAPCIRSN,CIRSNCD   REASON CODE                           03040000
         XC    AAPCIPFL,AAPCIPFL  # OF PROTECTED FIELDS                 03050000
         XC    AAPCIBYT,AAPCIBYT  # BYTES COMPARED                      03060000
                                                                        03070000
         LA    R1,=CL8'IMGPREP'   SERVICE ROUTINE NAME                  03080000
         LM    R2,R14,REGSAVE+8   RESTORE MAINLINE REGISTERS            03090000
         LTR   R15,R15            REFLECT COMPLETION STATUS VIA CC      03100000
         BR    R14                RETURN TO CALLER                      03110000
                                                                        03120000
         EJECT                                                          03130000
***************************************************************         03140000
*                                                                       03150000
* ROUTINE:  COMPIMAG - COMPARE IMAGES                                   03160000
*                                                                       03170000
* ON ENTRY:                                                             03180000
*                                                                       03190000
*    R0  ADDR OF NVIMAGE #1 - THE MODEL IMAGE                           03200000
*    R1  ADDR OF NVIMAGE #2 - THE CANDIDATE IMAGE                       03210000
*                                                                       03220000
* ON EXIT:                                                              03230000
*                                                                       03240000
*    R15 CONTAINS THE IMGPREP RETURN CODE                               03250000
*                                                                       03260000
*    R1  CONTAINS A SERVICE ROUTINE NAME PTR FOR ERROR HANDLERS         03270000
*                                                                       03280000
***************************************************************         03290000
COMPIMAG DS    0H                                                       03300000
         STM   R0,R15,REGSAVE     SAVE MAINLINE REGISTERS               03310000
                                                                        03320000
         LR    R2,R0              NVIMAGE #1                            03330000
         LR    R3,R1              NVIMAGE #2                            03340000
                                                                        03350000
         $CLINK FUNC=IMGCMP,                                           X03360000
               (STRUCT*,PCBSTG),                                       X03370000
               (STRUCT*,(R2)),                                         X03380000
               (STRUCT*,(R3)),                                         X03390000
               (STRUCT*,#CMPINFO)                                       03400000
                                                                        03410000
         MVC   AAPCIRC,CIRETCD    RETURN CODE                           03420000
         MVC   AAPCIRSN,CIRSNCD   REASON CODE                           03430000
         MVC   AAPCIPFL,CIPFLGS   # OF PROTECTED FIELDS                 03440000
         MVC   AAPCIBYT,CIBYTES   # BYTES COMPARED                      03450000
                                                                        03460000
         LA    R1,=CL8'IMGCOMP'   SERVICE ROUTINE NAME                  03470000
         LM    R2,R14,REGSAVE+8   RESTORE MAINLINE REGISTERS            03480000
         LTR   R15,R15            REFLECT COMPLETION STATUS VIA CC      03490000
         BR    R14                RETURN TO CALLER                      03500000
                                                                        03510000
         EJECT                                                          03520000
***************************************************************         03530000
*                                                                       03540000
* ROUTINE:  FREEIMAG - FREE NVIMAGE FOR CURRENT 3270 BUFFER             03550000
*                                                                       03560000
* ON ENTRY:                                                             03570000
*                                                                       03580000
*    R1  CONTAINS THE ADDRESS OF AN NVIMAGE PTR                         03590000
*                                                                       03600000
* ON EXIT:                                                              03610000
*                                                                       03620000
*    R15 CONTAINS ZERO OR THE COMPLETION CODE RETURNED BY               03630000
*        IMGFREE                                                        03640000
*                                                                       03650000
*    R1  CONTAINS A SERVICE ROUTINE NAME PTR FOR ERROR HANDLERS         03660000
*                                                                       03670000
***************************************************************         03680000
FREEIMAG DS    0H                                                       03690000
         STM   R0,R15,REGSAVE     SAVE MAINLINE REGISTERS               03700000
                                                                        03710000
         LA    R15,RC00           ASSUME NO NVIMAGE                     03720000
         LR    R2,R1              ACCEPT NVIMAGE POINTER                03730000
         ICM   R15,15,0(R2)       NVIMAGE CONSTRUCTED?                  03740000
         BZ    FICPT              DONE IF NOT                           03750000
                                                                        03760000
         $CLINK FUNC=IMGFREE,                                          X03770000
               (STRUCT*,PCBSTG),                                       X03780000
               (STRUCT*,(R2))                                           03790000
                                                                        03800000
FICPT    DS    0H                                                       03810000
         LA    R1,=CL8'IMGFREE'   SERVICE ROUTINE NAME                  03820000
         LM    R2,R14,REGSAVE+8   RESTORE MAINLINE REGISTERS            03830000
         LTR   R15,R15            REFLECT COMPLETION STATUS VIA CC      03840000
         BR    R14                RETURN TO CALLER                      03850000
                                                                        03860000
         EJECT                                                          03870000
***************************************************************         03880000
*                                                                       03890000
*   LOCAL READ ONLY DATA AREAS                                          03900000
*                                                                       03910000
***************************************************************         03920000
         LTORG ,                                                        03930000
                                                                        03940000
         PRINT NOGEN                                                    03950000
         ICVT  ,                  ICVT                                  03960000
         ITASK ,                  TASK BLOCK                            03970000
         IPCB  ,                  PROCESS BLOCK                         03980000
         IPROJ ,                  IPROJ BLOCK                           03990000
         END   ,                                                        04000000

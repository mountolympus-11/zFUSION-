ISRVSERV TITLE '- SERVER TASK MANAGER SERVICES'                         00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE: ISRVSERV - Server Task Manager Services                      00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine services requests issued via the $SERVER macro.       00080000
*    The server task manager provides the ability to run                00090000
*    multiple ITASKs within a single SERVER TCB.  This server           00100000
*    TCB is started and managed by Server Task Manager services.        00110000
*                                                                       00120000
*    This routine provides a common entry point for all Server          00130000
*    task manager requests.  Control is passed on to the appropriate    00140000
*    server task manager routine.  After the service routine            00150000
*    has processed the request,  a trace record is cut documenting      00160000
*    the request.                                                       00170000
*                                                                       00180000
* ON ENTRY:                                                             00190000
*                                                                       00200000
*    R1 contains the address of the parameter list mapped by            00210000
*    the SRVPL dsect generated by $SERVER DSECT=YES.                    00220000
*                                                                       00230000
* ON EXIT:                                                              00240000
*                                                                       00250000
*    R15 Contains one of the following return codes:                    00260000
*                                                                       00270000
*        RC00 - Normal completion                                       00280000
*        RC04 - Service completed with warnings                         00290000
*        RC12 - Service failure                                         00300000
*        RC20 - Server Task manager request in error                    00310000
*        RC24 - Invalid function requested                              00320000
*                                                                       00330000
*    For non-zero completion codes,  R0 will contain a reason           00340000
*    code associated with the specified function that is                00350000
*    requested.  The requested function code * 100 will be              00360000
*    added to the reason inorder to assign a unique reason              00370000
*    code for the requested Server task manager service.  Below is      00380000
*    the range of reason codes and their associated functions.          00390000
*    Please refer to the documentation prolog in each of the            00400000
*    requested function routines for a detailed description of          00410000
*    the reason code:                                                   00420000
*                                                                       00430000
*        RSN RANGE      REQUEST      ROUTINE                            00440000
*        -----------    -----------  -------------------                00450000
*         100 -  199    INIT         ISRVINIT                           00460000
*         200 -  299    TERM         ISRVTERM                           00470000
*         300 -  399    ATTACH       ISRVATT                            00480000
*         400 -  499    DETACH       ISRVDET                            00490000
*         500 -  599    (RESERVED)   ISRVCALL (CALLDSP)                 00500000
*         600 -  699    START        ISRVSTRT                           00510000
*         700 -  799    STOP         ISRVSTOP                           00520000
*         800 -  899    (RESERVED)   ISRVSUSP (SUSPEND)                 00530000
*         900 -  999    LOCATE       ISRVLOC                            00540000
*                                                                       00550000
* MODE:                                                                 00560000
*                                                                       00570000
*    TASK                                                               00580000
*    APF/NON-APF                                                        00590000
*    SUP/PROB                                                           00600000
*    AMODE 31, RMODE ANY                                                00610000
*                                                                       00620000
**<DOC-OFF>*****************************************************        00630000
                                                                        00640000
         EJECT ,                                                        00650000
****************************************************************        00660000
*                                                                       00670000
* MAINTENANCE:                                                          00680000
*                                                                       00690000
*   01/06/95 Ron Colmone          Par# 159456                           00700000
*            Initial Version                                            00710000
*                                                                       00720000
****************************************************************        00730000
         EJECT ,                                                        00740000
         $SERVER DSECT=YES        Server Task Manager Plist             00750000
                                                                        00760000
                                                                        00770000
         EJECT ,                                                        00780000
         EQUS  LINKAGE=COND       GENERAL EQUATES                       00790000
                                                                        00800000
         EJECT ,                                                        00810000
         TRACODES ,               TRACE EVENT CODES                     00820000
                                                                        00830000
         EJECT ,                                                        00840000
WORKAREA #WORK LENGTH=#TSKWKLN,PLIST=NO                                 00850000
WRKPASS  DS    XL512              WORKAREA TO PASS                      00860000
WORKLEN  #ENDWORK ,               LENGTH OF WORKAREA                    00870000
                                                                        00880000
         EJECT ,                                                        00890000
ISRVSERV #ENTER BASE=R12,         ENTRY LINKAGE                        +00900000
               PREG=R8,                                                +00910000
               WAPASS=YES                                               00920000
                                                                        00930000
         USING SRVPL,R8           ESTABLISH ADDRESSABILITY              00940000
         USING ITASK,R10          ESTABLISH ADDRESSABILITY              00950000
                                                                        00960000
         EJECT ,                                                        00970000
****************************************************************        00980000
*                                                                       00990000
*  CALL APPROPRIATE FUNCTION PROCESSING RTN                             01000000
*                                                                       01010000
****************************************************************        01020000
                                                                        01030000
         SR    R2,R2              PREPARE FOR INSERT                    01040000
         ICM   R2,1,SVPLREQ       GET $SERVER REQ CODE                  01050000
         BZ    ERR_FUNC           INVALID FUNCTION SPECIFIED            01060000
                                                                        01070000
         C     R2,=A(SRVSERV#)    VALID FUNCTION REQUESTED              01080000
         BH    ERR_FUNC           INVALID FUNCTION SPECIFIED            01090000
         BCTR  R2,0               PREPARE FOR TABLE INDEX               01100000
         SLL   R2,2               MULT BY 4, TABLE INDEX                01110000
                                                                        01120000
         L     R15,SRVSERV(R2)    ADDR OF SERV ROUTINE                  01130000
         LR    R1,R8              ADDR OF PARAMETER LIST                01140000
         LA    R0,WRKPASS         ADDR OF WORKAREA                      01150000
         BASR  R14,R15            CALL SERVICE ROUTINE                  01160000
         B     RETURN                                                   01170000
                                                                        01180000
*---------------------------------------------------------------        01190000
*  RETURN TO CALLER                                                     01200000
*---------------------------------------------------------------        01210000
                                                                        01220000
ERR_FUNC DS    0H                                                       01230000
         LA    R15,RC24           INVALID FUNCTION CODE                 01240000
                                                                        01250000
RETURN   DS    0H                                                       01260000
         L     R14,4(,R13)        ADDRESS OF CALLERS SAVEAREA           01270000
         L     R14,12(,R14)       ADDRESS OF CALLERS RETURN             01280000
         STM   R0,R15,WRKPASS     SAVE REGISTERS                        01290000
                                                                        01300000
         SR    R2,R2              PREPARE FOR INSERT                    01310000
         IC    R2,SVPLREQ         RETRIEVE SERVER TASk REQ CODE         01320000
         LA    R2,TRC_SERVTSK(,R2)  SERVER TASK TRACE CODE RANGE        01330000
                                                                        01340000
         $TRACE (R2),SVPLLN+16,FORCE=*WRKPASS+(4*R15)                   01350000
         BNZ   TRC_END            TRACE INACTIVE                        01360000
         MVC   0(SVPLLN,R1),SRVPL COPY PARAMETER LIST TO TRACE          01370000
         MVC   SVPLLN(4,R1),WRKPASS+(R14*4)                             01380000
         MVC   SVPLLN+4(4,R1),WRKPASS+(R15*4)                           01390000
         MVC   SVPLLN+8(4,R1),WRKPASS+(R0*4)                            01400000
         MVC   SVPLLN+12(4,R1),WRKPASS+(R1*4)                           01410000
TRC_END  DS    0H                                                       01420000
                                                                        01430000
         LM    R0,R15,WRKPASS     RESTORE REGISTERS                     01440000
         LTR   R15,R15            SUCCESSFUL COMPLETION?                01450000
         BZ    RET_EXIT           YES, ALL DONE                         01460000
                                                                        01470000
         SR    R2,R2              PREPARE FOR INSERT                    01480000
         IC    R2,SVPLREQ         GET REQUEST CODE                      01490000
         MH    R2,=AL2(100)       FUNCTION CODE * 100                   01500000
         AR    R0,R2              ADD TO REASON CODE                    01510000
                                                                        01520000
RET_EXIT DS    0H                                                       01530000
         #EXIT ,                  RETURN                                01540000
                                                                        01550000
         EJECT ,                                                        01560000
****************************************************************        01570000
*                                                                       01580000
*  SERVER TASK MANAGER REQUEST TABLE                                    01590000
*                                                                       01600000
****************************************************************        01610000
SRVSERV  DS    0F                                                       01620000
         DC    V(ISRVINIT)        1 - INIT SERVER                       01630000
         DC    V(ISRVTERM)        2 - TERM SERVER                       01640000
         DC    V(ISRVATT)         3 - ATTACH TASK TO SERVER             01650000
         DC    V(ISRVDET)         4 - DETACH TASK FROM SERVER           01660000
         DC    V(ISRVCALL)        5 - CALL SERVER DISPATCHER            01670000
         DC    V(ISRVSTRT)        6 - START SERVER TASK(S)              01680000
         DC    V(ISRVSTOP)        7 - STOP  SERVER TASK(S)              01690000
         DC    V(ISRVSUSP)        8 - SUSPEND ITASK                     01700000
         DC    V(ISRVLOC)         9 - LOCATE ITASK                      01710000
SRVSERV# EQU   (*-SRVSERV)/4      SERVICE RTN FUNCTION CNT              01720000
                                                                        01730000
         LTORG ,                                                        01740000
                                                                        01750000
         PRINT NOGEN                                                    01760000
         ICVT  ,                                                        01770000
                                                                        01780000
         ITASK ,                                                        01790000
                                                                        01800000
         END   ,                                                        01810000

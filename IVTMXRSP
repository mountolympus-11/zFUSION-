IVTMXRSP TITLE 'INTEGRATOR - VTAM RESPONSE EXIT'                        00010000
**<DOC-ON>************************************************************* 00020000
*                                                                       00030000
* ROUTINE: IVTMXRSP - INTEGRATOR VTAM RESPONSE EXIT                     00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THE RESPONSE EXIT IS DRIVEN BY VTAM WHEN A RESPONSE TO A           00080000
*    NORMAL-FLOW REQUEST IS RECEIVED.  INTEGRATOR DOES NOT USE          00090000
*    POST=RESP OR RECEIVE W/RTYPE=RESP TO OBTAIN NORMAL FLOW            00100000
*    RESPONSES.                                                         00110000
*                                                                       00120000
*    A RESPONSE WORK ELEMENT IS CREATED.  THE WORK ELEMENT IS           00130000
*    QUEUED TO THE ISESS WORK QUEUE FOR PROCESSING IF THE ISESS         00140000
*    IS AVAILABLE.  OTHERWISE, THE WORK ELEMENT IS QUEUED TO THE        00150000
*    VTAM MAIN TASK WORK QUEUE FOR A DIAGNOSTIC DUMP.                   00160000
*                                                                       00170000
* ON ENTRY:                                                             00180000
*                                                                       00190000
*    BAKR IS USED TO SAVE REGISTERS.                                    00200000
*                                                                       00210000
*    R15 = ENTRY POINT ADDRESS                                          00220000
*    R14 = RETURN ADDRESS                                               00230000
*    R01 = PARAMETER LIST ADDRESS                                       00240000
*          +00(4): ADDRESS OF ACB                                       00250000
*          +04(4): CID OF ASSOCIATED SESSION                            00260000
*          +08(4): NIB USERFLD OF ASSOCIATED SESSION                    00270000
*          +0C(4): RESERVED (UNUSED)                                    00280000
*          +10(4): ADDRESS OF VTAM READ-ONLY RPL                        00290000
*          +14(4): RESERVED (UNUSED)                                    00300000
*                                                                       00310000
* ON EXIT:                                                              00320000
*                                                                       00330000
*    R15 = 0                                                            00340000
*    R00 = 0                                                            00350000
*    R01 = 0                                                            00360000
*                                                                       00370000
*    ALL OTHER REGISTERS ARE RESTORED BY PR.                            00380000
*                                                                       00390000
**<DOC-OFF>************************************************************ 00400000
                                                                        00410000
         EJECT ,                                                        00420000
*********************************************************************** 00430000
*                                                                       00440000
* MAINTENANCE:                                                          00450000
*                                                                       00460000
*   08/01/93 RANDY WITEK                                                00470000
*                                                                       00480000
*********************************************************************** 00490000
         EQUS  ,                  GENERAL EQUATES                       00500000
                                                                        00510000
RICVT    EQU   R11                INTEGRATOR CVT POINTER                00520000
RITASK   EQU   R10                ASSOCIATED ITASK POINTER              00530000
RIVTAM   EQU   R9                 INTEGRATOR VTAM CVT POINTER           00540000
RIACB    EQU   R8                 ASSOCIATED IACB POINTER               00550000
RIRPL    EQU   R7                 ASSOCIATED RPL/IRPL POINTER           00560000
RISESS   EQU   R6                 ASSOCIATED ISESS POINTER              00570000
RIWE     EQU   R5                 WORK ELEMENT POINTER                  00580000
                                                                        00590000
         USING ICVT,RICVT         ESTABLISH ADDRESSIBILTY               00600000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSIBILTY               00610000
         USING ITASK,RITASK       ESTABLISH ADDRESSIBILTY               00620000
         USING IACB,RIACB         ESTABLISH ADDRESSIBILTY               00630000
         USING IRPL,RIRPL         ESTABLISH ADDRESSIBILTY               00640000
         USING IWEVTAM,RIWE       ESTABLISH ADDRESSIBILTY               00650000
         USING ISESS,RISESS       ESTABLISH ADDRESSIBILTY               00660000
                                                                        00670000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00680000
         DS    0D                                                       00690000
RCVPARMS DS    XL(L'IVR)          IVTAMRPA STORAGE                      00700000
ESTAEMFL DS    XL(L'ESTAEXPL)     PARMLIST CONSTRUCTION                 00710000
FRRPARM  DS    A                  RETURN AREA FOR FRR PARM ADDRESS      00720000
SAVER3   DS    F                  TEMPORARY SAVE AREA                   00730000
RETR15   DS    F                  RETURN CODE VALUE                     00740000
RETR0    DS    F                  RETURN REGISTER 0                     00750000
RETR1    DS    F                  RETURN REGISTER 1                     00760000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00770000
FLAG     DS    X                                                        00780000
FLESTAEX EQU   X'08'              ESTAEX ACTIVE                         00790000
FLFRR    EQU   X'04'              FRR    ACTIVE                         00800000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00810000
                                                                        00820000
IVTMXRSP #VTENTER BASE=R12,       VTAM EXIT ROUTINE LINKAGE            +00830000
               AMODE=31,                                               +00840000
               RMODE=ANY,                                              +00850000
               PREG=(R3),                                              +00860000
               EXITYPE=PLIST                                            00870000
                                                                        00880000
         USING IVTAMRPA,RCVPARMS  ESTABLISH ADDRESSIBILITY              00890000
                                                                        00900000
*---------------------------------------------------------------------- 00910000
* ESTABLISH RECOVERY ENVIRONMENT                                        00920000
*---------------------------------------------------------------------- 00930000
                                                                        00940000
         ST    R3,SAVER3          SAVE PARM REG                         00950000
         LA    R15,IVTXRTRY       RETRY ROUTINE ADDRESS                 00960000
         ST    R15,IVRRETAD       SET RETRY ROUTINE ADDRESS             00970000
         LA    R15,IVTAMRPA       PARAMETERS ADDRESS                    00980000
         ST    R15,IVRRPA@        SET ADDRESS FOR FRR                   00990000
         L     R0,=F'-1'          SHOW REGS RESTORED FROM PARM AREA     01000000
         STM   R0,R15,IVRR00      SAVE RETRY REGISTERS                  01010000
         MVC   IVRMOD,=CL8'IVTMTASK'                                    01020000
         MVC   IVRCSECT,=CL8'IVTMXRSP'                                  01030000
         MVC   IVRFRR,=CL8'IVTMXRCV'                                    01040000
         MVC   IVRTYPE,=CL8'ESTAEX'                                     01050000
         L     R3,=V(IVTMXRCV)    ADDR OF VTAM EXIT RECOVERY ROUTINE    01060000
         ICM   R0,15,PSATOLD      SRB MODE?                             01070000
         BZ    ESTFRR             BRANCH IF YES                         01080000
                                                                        01090000
         MVC   ESTAEMFL(L'ESTAEXPL),ESTAEXL                             01100000
                                                                        01110000
         ESTAEX (R3),                                                  +01120000
               CT,                                                     +01130000
               PARAM=RCVPARMS,                                         +01140000
               TERM=YES,                                               +01150000
               MF=(E,ESTAEMFL)    ESTABLISH RECOVERY                    01160000
                                                                        01170000
         OI    FLAG,FLESTAEX      RECOVERY ENVIRONMENT ESTABLISHED      01180000
         B     RECOVSET           AND CONTINUE                          01190000
                                                                        01200000
ESTFRR   DS    0H                                                       01210000
                                                                        01220000
         MVC   IVRTYPE,=CL8'FRR'                                        01230000
                                                                        01240000
         MODESET EXTKEY=ZERO,                                          +01250000
               SAVEKEY=(2)        SET KEY ZERO                          01260000
                                                                        01270000
         SETFRR A,                                                     +01280000
               FRRAD=(R3),                                             +01290000
               WRKREGS=(14,15),                                        +01300000
               PARMAD=FRRPARM     ESTABLISH RECOVERY                    01310000
                                                                        01320000
         L     R1,FRRPARM         PARM AREA FOR FRR                     01330000
         MVC   0(12,R1),RCVPARMS  SET TYPE & PARM AREA POINTER          01340000
                                                                        01350000
         MODESET KEYADDR=(2)      RESTORE PREVIOUS KEY                  01360000
                                                                        01370000
         OI    FLAG,FLFRR         RECOVERY ENVIRONMENT ESTABLISHED      01380000
         B     RECOVSET           AND CONTINUE                          01390000
                                                                        01400000
RECOVSET DS    0H                                                       01410000
                                                                        01420000
         L     R3,SAVER3          RESTORE PARM REG                      01430000
                                                                        01440000
*---------------------------------------------------------------------- 01450000
* ACCESS ISESS VIA NIB USERFLD AND VALIDATE USING VTAM CID.             01460000
*---------------------------------------------------------------------- 01470000
                                                                        01480000
         L     RIRPL,16(,R3)      READ-ONLY RPL ADDRESS                 01490000
         L     RISESS,8(,R3)      NIB USRFLD IS ISESS ADDRESS           01500000
         CLC   ISEID,=CL8'ISESS'  CHECK EYECATCHER                      01510000
         BNE   QTOMAIN            BRANCH IF NOT GOOD                    01520000
         CLC   ISECID,4(R3)       DO THE CID'S MATCH?                   01530000
         BNE   QTOMAIN            BRANCH IF NOT                         01540000
         L     RITASK,ISEITASK    GET THE SESSION ITASK POINTER         01550000
         LA    R4,ISEWEQ          ADDRESS THE SESSION WORK QUEUE        01560000
         B     ALLOCWE            CREATE WORK ELEMENT                   01570000
                                                                        01580000
*---------------------------------------------------------------------- 01590000
* ISESS WASN'T FOUND, SO QUEUE WORK ELEMENT TO MAIN TASK                01600000
*---------------------------------------------------------------------- 01610000
                                                                        01620000
QTOMAIN  DS    0H                                                       01630000
                                                                        01640000
         SR    RISESS,RISESS      SHOW NO ISESS                         01650000
         LA    R4,IVTWEQ          ADDRESS THE MAIN WORK QUEUE           01660000
                                                                        01670000
*---------------------------------------------------------------------- 01680000
* ALLOCATE RESP WORK ELEMENT                                            01690000
*---------------------------------------------------------------------- 01700000
                                                                        01710000
ALLOCWE  DS    0H                                                       01720000
                                                                        01730000
         $VTAMWE L'IWEX6,         SIZE                                 +01740000
               IWECXRSP           CODE                                  01750000
                                                                        01760000
         LR    RIWE,R1                                                  01770000
                                                                        01780000
*---------------------------------------------------------------------- 01790000
* BUILD RESP WORK ELEMENT                                               01800000
*---------------------------------------------------------------------- 01810000
                                                                        01820000
         ST    RIACB,IWEX6ACB     SET ACB ADDRESS                       01830000
         MVC   IWEX6CID,4(R3)     SET CID                               01840000
         MVC   IWEX6USR,8(R3)     SET USERFLD                           01850000
         SR    R1,R1              CLEAR FOR IC                          01860000
         IC    R1,RPLLEN          LENGTH OF READ-ONLY RPL               01870000
         BCTR  R1,0               LENGTH CODE FOR MVC                   01880000
         EX    R1,COPYRPL         COPY RPL TO WORK ELEMENT              01890000
                                                                        01900000
*---------------------------------------------------------------------- 01910000
* TRACE THE MODULE ENTRY                                                01920000
*---------------------------------------------------------------------- 01930000
                                                                        01940000
         $TRACE *=A(TRC_IVTMXRSP),32,STDENV=NO     32 USER BYTES        01950000
                                                                        01960000
         BNZ   NOMTRACE           BRANCH IF TRACING NOT AVAILABLE       01970000
                                                                        01980000
         ST    RITASK,0(,R1)      TRACE ITASK                           01990000
         ST    RISESS,4(,R1)      TRACE ISESS                           02000000
         ST    RIACB,8(,R1)       TRACE IACB                            02010000
         MVC   12(4,R1),IWEX6CID  TRACE CID                             02020000
         MVC   16(2,R1),RPLSEQNO  TRACE THE SEQUENCE NUMBER             02030000
         MVC   20(4,R1),IWEX6USR  TRACE THE PARM LIST USERFLD           02040000
         MVC   24(3,R1),RPLURH    TRACE REQUEST HEADER                  02050000
                                                                        02060000
NOMTRACE DS    0H                                                       02070000
                                                                        02080000
*---------------------------------------------------------------------- 02090000
* QUEUE RESP WORK ELEMENT TO VTAM MAIN/SESSION ITASK                    02100000
*---------------------------------------------------------------------- 02110000
                                                                        02120000
         $VTAMQ (RIWE),           WORK ELEMENT                         +02130000
               (R4),              QUEUE                                +02140000
               STDENV=NO          EXIT ROUTINE                          02150000
                                                                        02160000
         B     RETURN                                                   02170000
                                                                        02180000
*---------------------------------------------------------------------- 02190000
* RETRY ROUTINE SCHEDULED BY RECOVERY                                   02200000
*---------------------------------------------------------------------- 02210000
                                                                        02220000
IVTXRTRY DS    0H                                                       02230000
                                                                        02240000
         LTR   R0,R0              WERE REGISTERS RESTORED FOR RETRY?    02250000
         BM    REGSOK             BRANCH IF YES, READY TO EXIT          02260000
X        USING IVTAMRPA,R1        PARM AREA ADDRESS MUST BE IN R1       02270000
         LM    R0,R15,X.IVRR00    RESTORE ALL THE REGISTERS             02280000
         DROP  X                                                        02290000
                                                                        02300000
REGSOK   DS    0H                                                       02310000
                                                                        02320000
         ICM   R0,15,PSATOLD      SRB MODE?                             02330000
         BNZ   RETURN             BRANCH IF NOT                         02340000
         ICM   R1,B'0001',=X'80'  KEY 8 IN BITS 24-27                   02350000
         MODESET KEYREG=(R1)      SET KEY 8                             02360000
         B     RETURN             AND WE ARE READY TO EXIT              02370000
                                                                        02380000
*---------------------------------------------------------------------- 02390000
* RETURN TO VTAM FROM EXIT ROUTINE                                      02400000
*---------------------------------------------------------------------- 02410000
                                                                        02420000
RETURN   DS    0H                                                       02430000
                                                                        02440000
         TM    FLAG,FLESTAEX      IS ESTAEX ESTABLISHED?                02450000
         BNO   RETFRR             BRANCH IF NOT                         02460000
                                                                        02470000
         ESTAEX 0                 DELETE RECOVERY ENVIRONMENT           02480000
                                                                        02490000
         NI    FLAG,255-FLESTAEX  CLEAR FLAG                            02500000
         B     EXITNOW            AND EXIT                              02510000
                                                                        02520000
RETFRR   DS    0H                                                       02530000
                                                                        02540000
         TM    FLAG,FLFRR         IS FRR ESTABLISHED?                   02550000
         BNO   EXITNOW            BRANCH IF NOT                         02560000
                                                                        02570000
         MODESET EXTKEY=ZERO,                                          +02580000
               SAVEKEY=(2)        SET KEY ZERO                          02590000
                                                                        02600000
         SETFRR D,                                                     +02610000
               WRKREGS=(14,15)    DELETE RECOVERY ENVIRONMENT           02620000
                                                                        02630000
         MODESET KEYADDR=(2)      RESTORE PREVIOUS KEY                  02640000
                                                                        02650000
         NI    FLAG,255-FLFRR     CLEAR FLAG                            02660000
         B     EXITNOW            AND EXIT                              02670000
                                                                        02680000
EXITNOW  DS    0H                                                       02690000
                                                                        02700000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 02710000
                                                                        02720000
         #VTEXIT ,                RETURN                                02730000
                                                                        02740000
*---------------------------------------------------------------------- 02750000
*  CONSTANTS AND LITERALS                                               02760000
*---------------------------------------------------------------------- 02770000
                                                                        02780000
COPYRPL  MVC   IWEX6RPL(0),0(RIRPL) COPY READ-ONLY RPL TO IWE           02790000
                                                                        02800000
ESTAEXL  ESTAEX *-*,CT,MF=L       ESTAEX PLIST                          02810000
ESTAEXPL EQU   ESTAEXL,*-ESTAEXL                                        02820000
                                                                        02830000
         LTORG ,                                                        02840000
         PRINT NOGEN                                                    02850000
         IVTAMRPA ,               INTEGRATOR VTAM RECOVERY PARAMETERS   02860000
         IHAFRRS ,                MVS FRR STACK                         02870000
         IHAPSA ,                 MVS PREFIXED STORAGE AREA             02880000
         ISTDBIND ,               VTAM BIND IMAGE                       02890000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         02900000
         ICVT  ,                  INTEGRATOR CVT                        02910000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   02920000
         ITASK ,                  INTEGRATOR TASK BLOCK                 02930000
         IACB ,                   INTEGRATOR VTAM ACB+                  02940000
         IRPL ,                   INTEGRATOR VTAM RPL+                  02950000
         INIB ,                   INTEGRATOR VTAM NIB+                  02960000
         ISESS ,                  INTEGRATOR SESSION BLOCK              02970000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            02980000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          02990000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       03000000
         EVCODES ,                INTEGRATOR EVENT CODES                03010000
         ABCODES ,                INTEGRATOR $ABEND CODES               03020000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     03030000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             03040000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             03050000
         IFGEXLST ,               VTAM EXIT LIST                        03060000
         END   ,                                                        03070000

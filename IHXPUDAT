IHXPUDAT TITLE ' - CONVERT SOURCE USERDATA KWDS IN INTERNAL FORMAT'     00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: IHXPUDAT - Convert source userdata kwds to internal fmt      00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine may be used to accept one or more input lines         00080000
*    containing parameters in CMDSCAN format and post the               00090000
*    internal representations of the keywords and values in a           00100000
*    control block provided for that purpose.                           00110000
*                                                                       00120000
*    The syntax of the source language is described in CMDSCAN.         00130000
*    The particular set of keywords and value assignments               00140000
*    accepted is defined by the keyword module passed via               00150000
*    PRQBKMOD.                                                          00160000
*                                                                       00170000
*    Source lines are acquired by calling the routine provided          00180000
*    by PRQBRTNA and the communication word PRQBRTNP.  Entry            00190000
*    and exit linkage is boxed below.  The routine is invoked           00200000
*    in the AMODE of this routine.                                      00210000
*                                                                       00220000
*      ------------------------------------------------------           00230000
*                                                                       00240000
*       CALL:    R15 - EPA        (PRQBRTNA)                            00250000
*                R1  - Comm word  (PRQBRTNP)                            00260000
*                                                                       00270000
*       RETURN:  R15 - Return code, as follows                          00280000
*                                                                       00290000
*                      RC00 - Parm line returned as follows             00300000
*                                                                       00310000
*                             R1 - source line origin                   00320000
*                             R0 - source line length                   00330000
*                                                                       00340000
*                      RCnn - End of source lines                       00350000
*                                                                       00360000
*      ------------------------------------------------------           00370000
*                                                                       00380000
*    For each input line returned and parsed without error              00390000
*    (CMDSCAN), IPRMPOST is invoked to convert the respective           00400000
*    keywords and values to internal format.  The structure of          00410000
*    the control block identified by PRQBCB is mapped by the            00420000
*    POSTOPS table provided by PRQBPOPS.                                00430000
*                                                                       00440000
*                                                                       00450000
* ON ENTRY:                                                             00460000
*                                                                       00470000
*    R1  contains the address of a parameter list described by          00480000
*        the PRMREQB mapping                                            00490000
*                                                                       00500000
*                                                                       00510000
* ON EXIT:                                                              00520000
*                                                                       00530000
*    R15 contains one of the following return codes:                    00540000
*                                                                       00550000
*        RC00 - Function complete                                       00560000
*        RC04 - Function complete, source parm errors noted             00570000
*                                                                       00580000
**<DOC-OFF>****************************************************         00590000
                                                                        00600000
                                                                        00610000
***************************************************************         00620000
*                                                                       00630000
* MAINTENANCE:                                                          00640000
*                                                                       00650000
*    05/28/93 R. Turgeon                                                00660000
*             INITIAL VERSION                                           00670000
*                                                                       00680000
*    07/10/93 R. Colmone                                                00690000
*             Cloned from IDRVPARM                                      00700000
*                                                                       00710000
***************************************************************         00720000
                                                                        00730000
         #WORK ,             BEGIN WORKAREA                             00740000
                                                                        00750000
RETCODE  DS    F             RETURN CODE                                00760000
                                                                        00770000
@OPLIST  DS    0A,0F         DYNAMICALLY ACQUIRED OPLIST DESCRIPTOR     00780000
@OPADDR  DS    A                ORIGIN                                  00790000
@OPLEN   DS    A                LENGTH                                  00800000
                                                                        00810000
SCANKEY  DS    F             KEYWORD OPERAND ERROR - KEYTAB NDX         00820000
SCANERR  DS    A             KEYWORD OPERAND ERROR - FAILING TOKEN      00830000
SCANMSG  DS    A             KEYWORD OPERAND ERROR - MESSAGE TEXT       00840000
                                                                        00850000
ERRENTRY DS    A             IPRMPOST INVALID TABLE ENTRY RETURN        00860000
ERRTOKEN DS    CL16          IPRMPOST ERROR MESSAGE TOKEN RETURN        00870000
                                                                        00880000
INLINE   DS    XL255,X'00'   INPUT LINE AND DELIMITER                   00890000
WK256    DS    XL256         PLIST CONSTRUCTION, ETC.                   00900000
                                                                        00910000
         #ENDWORK ,          END WORKAREA                               00920000
                                                                        00930000
         EJECT                                                          00940000
         PRMREQB ,           PARAMETER LIST                             00950000
         EJECT                                                          00960000
         KEYTAB DSECT=YES    KEYWORD TABLE FORMATS                      00970000
         EJECT                                                          00980000
         OPLIST ,            KEYWORD & VALUES INSTANCES                 00990000
         EJECT                                                          01000000
         POSTOPS DSECT=YES   KEYWORD MAP TO INTERNAL REPRESENTATION     01010000
         EJECT                                                          01020000
         ABCODES ,           $ABEND CODES                               01030000
*                                                                       01040000
         EQUS  ,                                                        01050000
                                                                        01060000
         $MSGDFT PREFIX=ICTPID,COMPID='HXP',TABLE=*#MSGS,              X01070000
               CONID=*ICTCONID,CONNAME=ICTCONNM,                       X01080000
               MF=(E,WK256),                                           X01090000
               PRINT=NOGEN                                              01100000
         EJECT                                                          01110000
                                                                        01120000
         EJECT ,                                                        01130000
IHXPUDAT #ENTER PREG=R8                                                 01140000
                                                                        01150000
         USING ICVT,R11                                                 01160000
         USING ITASK,R10                                                01170000
                                                                        01180000
*--------------------------------------------------------------         01190000
*   ALLOCATE OPLIST TO ACCUMULATE PARSE RESULTS                         01200000
*--------------------------------------------------------------         01210000
         USING PRMREQB,R8         PASSED PARAMETERS                     01220000
                                                                        01230000
         L     R6,PRQBKMOD        KEYWORD MODULE                        01240000
         USING KEYHDR,R6          BEGINS WITH KEYWORD HEADER            01250000
                                                                        01260000
         L     R2,KEYHCNT         NUMBER OF ELIGIBLE KEYWORDS           01270000
         MH    R2,=AL2(OPLISTLN)  SIZE OF OPLIST BACKING KEYTAB         01280000
                                                                        01290000
         STGGET (R2),QH=TSKSTG    ACQUIRE CLEARED STORAGE               01300000
         BNZ   ERR_STG            STORAGE MGMT FAILURE                  01310000
         STM   R1,R2,@OPLIST      OPLIST BLOCK ORIGIN & LENGTH          01320000
                                                                        01330000
*--------------------------------------------------------------         01340000
*   AQUIRE SOURCE LINE FROM ACQUISITION ROUTINE                         01350000
*--------------------------------------------------------------         01360000
GET_NEXT DS    0H                                                       01370000
         L     R15,PRQBRTNA       EPA                                   01380000
         L     R1,PRQBRTNP        COMM WORD                             01390000
         BASR  R14,R15            INVOKDE GET-NEXT                      01400000
         LTR   R15,R15            FUNCTION COMPLETE?                    01410000
         BNZ   ENDLINES           DONE                                  01420000
                                                                        01430000
         LTR   R0,R0              VALID LINE?                           01440000
         BNP   ERR_LINE           REJECT IF NOT                         01450000
         CL    R0,=A(L'INLINE)    TOO LARGE?                            01460000
         BH    ERR_LINE           REJECT IF SO                          01470000
                                                                        01480000
         LR    R2,R0              PREPARE FOR EX                        01490000
         BCTR  R2,0               LENGTH CODE                           01500000
         EX    R2,*+4             MOVE TO ZERO DLM AREA                 01510000
         MVC   INLINE(*-*),0(R1)  COPY SOURCE LINE                      01520000
         LA    R15,INLINE+1(R2)   LAST+1 BYTE                           01530000
         MVI   0(R15),0           C-STYLE DLM                           01540000
                                                                        01550000
         EJECT ,                                                        01560000
***************************************************************         01570000
*                                                                       01580000
*   PARSE PARAMETER SOURCE LINE, MSG IF ERROR                           01590000
*                                                                       01600000
***************************************************************         01610000
         L     R3,@OPADDR         OPLIST BLOCK ORIGIN                   01620000
         L     R4,KEYHORG         OPERAND KEYWORD TABLE ORIGIN          01630000
         USING KEYTAB,R4          KEYTAB, SYMBOLICALLY                  01640000
         LA    R0,INLINE          PARAMETER LINE ORIGIN                 01650000
         ST    R0,FWORD           IN CHAR** FORMAT                      01660000
                                                                        01670000
PARSE    DS    0H                                                       01680000
         $CLINK FUNC=*#CMDSCAN,   COMMAND LINE PARSE SERVICE           X01690000
               (STRUCT*,KEYTAB),  KEYWORD TABLE                        X01700000
               (STRUCT*,(R3)),    OPERAND LIST                         X01710000
               (CHAR**,FWORD),    OPERAND PORTION OF CMD LINE          X01720000
               (INT*,SCANKEY),    KEYWORD TABLE ENTRY INDEX ERR RETURN X01730000
               (CHAR**,SCANMSG),  EBCDIC ERROR MSG TEXT                X01740000
               (CHAR**,SCANERR)   ERROR LOCATION WITHIN OPERAND STRING  01750000
                                                                        01760000
         LTR   R15,R15            TEST PARSE COMPLETION                 01770000
         BZ    PARSE              KEYWORD PROCESSED, OTHERS MAY REMAIN  01780000
         BM    APPLY              PARSE COMPLETE                        01790000
                                                                        01800000
*--------------------------------------------------------------         01810000
*   PARAMETER PARSING ERROR, DOCUMENT ACCORDINGLY                       01820000
*--------------------------------------------------------------         01830000
         LA    R0,RC04            MINIMUM POSSIBLE SEVERITY CODE        01840000
         ST    R0,RETCODE         POISED FOR REQUESTOR                  01850000
                                                                        01860000
         ICM   R15,15,SCANERR     LOCATION OF ERROR WITHIN PARM LINE    01870000
         BZ    ERRPARSE           NOT PROVIDED                          01880000
         MVI   INLINE,C' '        PREPARE PARM LINE FOR REUSE           01890000
         MVC   INLINE+1(L'INLINE-1),INLINE                              01900000
         MVI   0(R15),C'?'        TAG ACCORDINGLY                       01910000
                                                                        01920000
         $MSG  051,FIELDS=(INLINE)                                     X01930000
                                                                        01940000
ERRPARSE DS    0H                                                       01950000
         $MSG  052,FIELDS=((*SCANMSG,0))                                01960000
         B     GET_NEXT                                                 01970000
                                                                        01980000
         EJECT ,                                                        01990000
***************************************************************         02000000
*                                                                       02010000
*   APPLY PARSED OPERANDS TO OPTION BLOCK                               02020000
*                                                                       02030000
***************************************************************         02040000
APPLY    DS    0H                                                       02050000
         L     R5,PRQBPOPS        POSTOPS TABLE ORIGIN                  02060000
         USING POSTOPS,R5         SYMBOLICALLY                          02070000
         L     R3,@OPADDR         OPLIST                                02080000
                                                                        02090000
APPRETRY DS    0H                                                       02100000
         $CLINK FUNC=PRMPOST,                                          X02110000
               (STRUCT*,KEYTAB),  KEYWORD TABLE                        X02120000
               (STRUCT*,(R3)),    OPERAND LIST                         X02130000
               (STRUCT*,POSTOPS), POSTOPS TABLE                        X02140000
               (STRUCT*,ICVT),    OPTIONS POSTED IN ICVT               X02150000
               (VOID**,ERRENTRY), TABLE ENTRY IN ERROR                 X02160000
               (CHAR*,ERRTOKEN)   TERSE ERROR DESCRIPTION (TEXT)        02170000
                                                                        02180000
         LTR   R15,R15            APPLICATION/POSTING COMPLETED?        02190000
         BZ    GET_NEXT           END CYCLE IF SO                       02200000
                                                                        02210000
*--------------------------------------------------------------         02220000
*   DOCUMENT PARAMETER APPLICATION/POSTING ERROR                        02230000
*--------------------------------------------------------------         02240000
         LA    R0,RC04            MINIMUM POSSIBLE SEVERITY CODE        02250000
         ST    R0,RETCODE         POISED FOR REQUESTOR                  02260000
                                                                        02270000
         L     R4,ERRENTRY        KEYTAB ENTRY ASSOCIATED WITH ERROR    02280000
                                                                        02290000
         $MSG  053,FIELDS=(KEYTKWD,ERRTOKEN)                            02300000
                                                                        02310000
         LR    R1,R4              FAILING KEYTAB ENTRY                  02320000
         S     R1,KEYHORG         OFFSET TO FAILING ENTRY               02330000
         SR    R0,R0              PREPARE FOR DIVIDE                    02340000
         D     R0,=A(KEYTLN)      CONVERT OFFSET TO INDEX               02350000
         LA    R4,KEYTAB+KEYTLN   REDRIVE APPL/POST AT NEXT ENTRY       02360000
                                                                        02370000
         MH    R1,=AL2(OPLISTLN)  OFFSET IN CORRESPONDING OPLIST        02380000
         L     R3,@OPADDR         REFRESH OPLIST BASE ADDRESS           02390000
         AR    R3,R1              CHOKE UP ACCORDINGLY                  02400000
         B     APPRETRY           FORCE TO COMPLETION                   02410000
         DROP  R4,R5              KEYTAB, POSTOPS                       02420000
                                                                        02430000
         EJECT ,                                                        02440000
***************************************************************         02450000
*                                                                       02460000
*   RELEASE ACQUIRED BUFFERS, POST COMP STATUS, AND RETURN              02470000
*                                                                       02480000
***************************************************************         02490000
ENDLINES DS    0H                                                       02500000
         L     R2,@OPADDR                                               02510000
         STGRETN ADDR=(R2),LEN=*@OPLEN,QH=TSKSTG                        02520000
                                                                        02530000
         L     R15,RETCODE                                              02540000
         #EXIT ,                                                        02550000
                                                                        02560000
         EJECT ,                                                        02570000
***************************************************************         02580000
*                                                                       02590000
*   CATASTROPHIC LOGIC FAILURES, ETC.                                   02600000
*                                                                       02610000
***************************************************************         02620000
ERR_STG  DS    0H                                                       02630000
         ST    R15,FWORD                                                02640000
         $ABEND ABE_STORAGE,*FWORD,DUMP=YES,                           X02650000
               TITLE='STORAGE MANAGMENT FAILURE'                        02660000
                                                                        02670000
*--------------------------------------------------------------         02680000
                                                                        02690000
ERR_LINE DS    0H                                                       02700000
         $ABEND ABE_INTERFACE,DUMP=YES,                                X02710000
               TITLE='PROGRAMMING INTERFACE VIOLATION'                  02720000
                                                                        02730000
         EJECT ,                                                        02740000
***************************************************************         02750000
*                                                                       02760000
*   LOCAL READ/ONLY DATA AREAS, ETC.                                    02770000
*                                                                       02780000
***************************************************************         02790000
         LTORG ,                                                        02800000
                                                                        02810000
         PRINT NOGEN                                                    02820000
         ICVT  ,                                                        02830000
         ITASK ,                                                        02840000
         END   ,                                                        02850000

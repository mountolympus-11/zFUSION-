ITIDESC  TITLE '- TABLE INTERFACE (TI) DESCRIBE PROCESSOR'              00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: ITIDESC - Table interface (TI) describe processor            00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine allows a cooperative process to describe the          00080000
*    format of a table previously opened by TIOPEN.  Note that          00090000
*    the TIOPEN request itself provides a description of the            00100000
*    table.  Therefore, this service is of most use only to             00110000
*    cooperative processes (COOP) not having access to the data         00120000
*    provided by TIOPEN.  The TIB on the host system also               00130000
*    retains a description of the table during the TIOPEN. That         00140000
*    description is not updated by this service.                        00150000
*                                                                       00160000
*    The table description can be delivered in one of two               00170000
*    formats; standard or terse, as selected by                         00180000
*    TIDESOPT.TIDESTER.                                                 00190000
*                                                                       00200000
*                                                                       00210000
* ON ENTRY:                                                             00220000
*                                                                       00230000
*    R1  points to a parameter list described by the @TIDESC            00240000
*        mapping.                                                       00250000
*                                                                       00260000
*                                                                       00270000
* ON EXIT:                                                              00280000
*                                                                       00290000
*    A response block is sent to the requestor to convey the            00300000
*    results of the describe request.  When the return code             00310000
*    is non-zero, the response string contains an appropriate           00320000
*    error message.                                                     00330000
*                                                                       00340000
*    The response area returned to coop contains one of the             00350000
*    following return/reason code pairs:                                00360000
*                                                                       00370000
*       RC00 - describe complete                                        00380000
*                                                                       00390000
*       RC04 - insufficient response buffer allocation                  00400000
*                                                                       00410000
*       RC12 - request in error                                         00420000
*                                                                       00430000
*              RSN04 - table token does not match open table            00440000
*                                                                       00450000
*       RC16 - table services error                                     00460000
*                                                                       00470000
*              RSN04 - TBDESC failure                                   00480000
*                                                                       00490000
*       RC20 - response service failure                                 00500000
*                                                                       00510000
**<DOC-OFF>****************************************************         00520000
                                                                        00530000
         EJECT                                                          00540000
***************************************************************         00550000
*                                                                       00560000
* MAINTENANCE:                                                          00570000
*                                                                       00580000
*   08/xx/92  R. Turgeon                                                00590000
*             Initial version                                           00600000
*                                                                       00610000
*   08/05/93  Ron Colmone                                               00620000
*             Converted to STDENV                                       00630000
*                                                                       00640000
*   12/06/94  R. Turgeon                                                00650000
*             removed PAGE= / SHRPAGE= for $SPACE, $OBJECT,             00660000
*             and TB* service requests                                  00670000
*                                                                       00680000
*    11/13/95 R. Turgeon                                                00690000
*             Implement FORMAT=TERSE column descriptor allowing         00700000
*             the return of TBCOLDV1 blocks rather than the             00710000
*             larger TBCOLDEF blocks.                                   00720000
*                                                                       00730000
***************************************************************         00740000
                                                                        00750000
         EJECT                                                          00760000
         #WORK ,             READ / WRITE WORK AREA                     00770000
                                                                        00780000
CODESC   DS    A             ADDR OF DESCRIBE OUTPUT AREA               00790000
CODESCLN DS    F             LENGTH OF RETURN AREA ACQUIRED BY SERVICE  00800000
RESPBUF  DS    A             RESPONSE BUFFER IF NEEDED                  00810000
RESPBUFL DS    F             RESPONSE BUFFER LENGTH                     00820000
$TMRESP  DS    A             BOUND PTR TO TMRESP BLOCK IN TXP BUFFER    00830000
DESCFMT  DS    F             DESCRIBE OUTPUT FORMAT (TIDESOPT.TIDESTER) 00840000
                                                                        00850000
         #ENDWORK ,          END OF WORKAREA                            00860000
                                                                        00870000
         EJECT                                                          00880000
         @TIDESC ,           REQUEST BLOCK FORMAT                       00890000
                                                                        00900000
         EJECT                                                          00910000
         TIBLOCK ,           TABLE INTERFACE BLOCK          (TIB)       00920000
                                                                        00930000
         EJECT                                                          00940000
         TMRESP  ,           RESPONSE HEADER                            00950000
                                                                        00960000
         EJECT                                                          00970000
         REQHDR  ,           REQUEST  HEADER                            00980000
                                                                        00990000
         EJECT                                                          01000000
         TBSERVIS DESC                                                  01010000
                                                                        01020000
         EJECT                                                          01030000
         EQUS  ,             GENERAL EQUATES                            01040000
                                                                        01050000
         EJECT                                                          01060000
ITIDESC  #ENTER BASE=R12,PREG=R8                                        01070000
                                                                        01080000
         USING ITASK,R10          ITASK ADDRESSABILITY                  01090000
         L     R9,TSKPCBC         ADDRESS OF CURRENT PCB                01100000
         USING IPCB,R9            PCB ADDRESSABILITY                    01110000
                                                                        01120000
         USING TIDESC,R8          LIFE OF FUNCTION                      01130000
                                                                        01140000
*--------------------------------------------------------------         01150000
*   General initialization - place response block in TXP bufr           01160000
*--------------------------------------------------------------         01170000
                                                                        01180000
         L     R7,PCBUSER         ADDRESS OF IUSER                      01190000
         USING IUSER,R7           TEMP ADDRESSABILITY                   01200000
                                                                        01210000
         L     R7,USRPROJ         PROJECT CONTROL AREA                  01220000
         USING IPROJ,R7           LIFE OF FUNCTION                      01230000
                                                                        01240000
         MVC   DESCFMT(1),TIDESOPT                                      01250000
         NI    DESCFMT,TIDESTER   ISOLATE DESCRIBE OUTPUT FORMAT OPTION 01260000
                                                                        01270000
         $XPBUFR ISRT,            ADD RESPONSE HEADER TO BUFR          X01280000
               NEWFUNC=(TBSV,TI$DESC),                                 X01290000
               DATALEN=TMRESPLN,                                       X01300000
               EXPAND=YES,                                             X01310000
               MF=(E,MFE_LIST)                                          01320000
                                                                        01330000
         BNZ   ERR_ITXP                                                 01340000
                                                                        01350000
*--------------------------------------------------------------         01360000
*   Bind the response block ptr to allow TXP buffer realloc             01370000
*--------------------------------------------------------------         01380000
                                                                        01390000
         LR    R4,R1              NOW RESIDES IN TXP BUFFER             01400000
         ST    R4,$TMRESP         SAVE BINDABLE PTR TO BLOCK            01410000
         USING TMRESP,R4          RESPONSE BLOCK                        01420000
                                                                        01430000
         $XPBUFR ADDPTR,PTRS=($TMRESP)                                  01440000
                                                                        01450000
*--------------------------------------------------------------         01460000
*   Locate the TIB corresponding to the table token provided            01470000
*--------------------------------------------------------------         01480000
                                                                        01490000
         LA    R1,TIDESTKN        R0 <== TABLE TOKEN ADDR               01500000
         BAS   R14,LOCTIB         TEST WHETHER TABLE ALREADY OPENED     01510000
         LTR   R15,R15            TIB CHAIN SEGMENT RETURNED?           01520000
         BNZ   ENOTIB             ERROR                                 01530000
                                                                        01540000
         LR    R5,R0              MATCHING TIB                          01550000
         USING TIBLOCK,R5         DECHAIN THE TIB FROM LIST             01560000
                                                                        01570000
*--------------------------------------------------------------         01580000
*   Describe the table                                                  01590000
*--------------------------------------------------------------         01600000
                                                                        01610000
         TBDESC TTOKEN=TIBTOKN,   DESCRIBE THE TABLE                   X01620000
               LINK=OFFSET,       PORTABLE RESULT AREA                 X01630000
               FORMAT=*DESCFMT,   STD OR TERSE FORMAT, PER CALLER      X01640000
               MF=(E,MFE_LIST)                                          01650000
                                                                        01660000
         LTR   R15,R15            NORMAL COMPLETION?                    01670000
         BNZ   ETBSRV             ASSUME TABLE SERVICES FAILURE         01680000
                                                                        01690000
         ST    R1,CODESC          PRESERVE AREA ALLOCATED BY SERVICE    01700000
         ST    R0,CODESCLN        LENGTH OF DESCRIBE OUTPUT             01710000
                                                                        01720000
         EJECT                                                          01730000
***************************************************************         01740000
*                                                                       01750000
*   Post completion status                                              01760000
*                                                                       01770000
***************************************************************         01780000
                                                                        01790000
         LA    R15,RC00           COMPLETION CODE                       01800000
         SR    R0,R0              NO REASON CODES DEFINED               01810000
         SR    R1,R1              NO DIAGNOSTICS                        01820000
         L     R2,CODESC          RESPONSE DATA ORIGIN                  01830000
         L     R3,TBFUSED-TBFMT(,R2)   RESPONSE DATA LENGTH             01840000
         B     RESPOND            RESPOND TO COOP                       01850000
                                                                        01860000
ENOTIB   DS    0H                 TIB NOT FOUND                         01870000
         LA    R15,RC12           FAIL THE REQUEST                      01880000
         LA    R0,RSN04           POSSIBLE INVALID TABLE TOKEN          01890000
         LA    R2,MSGNOTIB                                              01900000
         LA    R3,L'MSGNOTIB                                            01910000
         B     RESPOND                                                  01920000
                                                                        01930000
ETBSRV   DS    0H                 TBDESC FAILURE                        01940000
         LA    R15,RC16           TABLE SERVICES FAILURE                01950000
         LA    R0,RSN04           TBDESC, DIAGNOSTICS IN R1             01960000
         LA    R2,MSGDESC                                               01970000
         LA    R3,L'MSGDESC                                             01980000
         B     RESPOND                                                  01990000
                                                                        02000000
         EJECT                                                          02010000
***************************************************************         02020000
*                                                                       02030000
*   Construct response. The data portion of the response                02040000
*   block consists of a response header followed by a response          02050000
*   string.  When the TIDESC request succeeds, the response             02060000
*   string is the result of a describe (TBDESC) issued against          02070000
*   the opened table.  In all error cases, the response string          02080000
*   is an error message.                                                02090000
*                                                                       02100000
***************************************************************         02110000
                                                                        02120000
RESPOND  DS    0H                                                       02130000
         MVC   TMRSTTKN,TIDESTKN                                        02140000
         ST    R15,TMRSRC                                               02150000
         ST    R15,TMRSUPRC                                             02160000
         ST    R0,TMRSRSN                                               02170000
         ST    R1,TMRSINFO                                              02180000
                                                                        02190000
         $XPBUFR ISRT,            ADD MESSAGE TO RESPONSE BLOCK        X02200000
               DATA=(R2),                                              X02210000
               DATALEN=(R3),                                           X02220000
               EXPAND=YES,                                             X02230000
               MF=(E,MFE_LIST)                                          02240000
                                                                        02250000
         BNZ   ERR_ITXP                                                 02260000
         L     R4,$TMRESP         ALLOW FOR TXP BUFFER EXPANSION        02270000
         STH   R3,TMRSDATL        POST MSG LENGTH IN RESPONSE HEADER    02280000
         B     CLEANUP                                                  02290000
                                                                        02300000
         EJECT                                                          02310000
***************************************************************         02320000
*                                                                       02330000
*   Errors usually precluding response to cooperative process           02340000
*                                                                       02350000
***************************************************************         02360000
                                                                        02370000
ERR_ITXP DS    0H                                                       02380000
         LR    R1,R15             TXP SERVICE RETURN CODE               02390000
         LA    R15,RC04           ASSUME OUT-OF-SPACE                   02400000
         CR    R1,R15             CORRECT?                              02410000
         BE    *+8                TERMINATE WITH WARNING                02420000
         LA    R15,RC20           ELSE MORE SERIOUS PROBLEM             02430000
                                                                        02440000
         ST    R15,TMRSUPRC       LOCAL RETCODE                         02450000
         ST    R0,TMRSRSN         TXP REASON                            02460000
         ST    R1,TMRSINFO        TXP RETCODE                           02470000
                                                                        02480000
         EJECT                                                          02490000
***************************************************************         02500000
*                                                                       02510000
*   Release storage acquired by describe operation                      02520000
*                                                                       02530000
***************************************************************         02540000
                                                                        02550000
CLEANUP  DS    0H                                                       02560000
         ICM   R3,15,CODESC       DESCRIBE DONE FOR COOP?               02570000
         BZ    FREECOOP           SKIP FREE IF NOT                      02580000
                                                                        02590000
         $RETSTOR (R3),OWNER=ITASK                                      02600000
                                                                        02610000
FREECOOP DS    0H                                                       02620000
                                                                        02630000
*--------------------------------------------------------------         02640000
*   Withdraw notification of TXP buffer movement                        02650000
*--------------------------------------------------------------         02660000
                                                                        02670000
         $XPBUFR REMPTR,PTRS=($TMRESP)                                  02680000
                                                                        02690000
***************************************************************         02700000
*                                                                       02710000
*   Return to caller                                                    02720000
*                                                                       02730000
***************************************************************         02740000
                                                                        02750000
         L     R15,TMRSRC         RETURN CODE                           02760000
         L     R0,TMRSRSN         REASON CODE                           02770000
         L     R1,TMRSINFO        INFO / DIAGNOSTIC CODE                02780000
                                                                        02790000
         #EXIT ,                  RETURN                                02800000
         DROP  R4                 TMRESP                                02810000
                                                                        02820000
         EJECT                                                          02830000
***************************************************************         02840000
*                                                                       02850000
* ROUTINE: LOCTIB - Locate TIB by table token                           02860000
*                                                                       02870000
* ON ENTRY:                                                             02880000
*                                                                       02890000
*    R1  - address of table token                                       02900000
*                                                                       02910000
* ON EXIT:                                                              02920000
*                                                                       02930000
*    R15 contains one of the following return codes                     02940000
*                                                                       02950000
*        RC00 - TIB located                                             02960000
*                                                                       02970000
*               R0 - matching TIB                                       02980000
*               R1 - predecessor of matching TIB on chain               02990000
*                                                                       03000000
*        RC04 - corresponding TIB not found                             03010000
*                                                                       03020000
***************************************************************         03030000
                                                                        03040000
LOCTIB   DS    0H                                                       03050000
         BAKR  R14,0              PRESERVE MAINLINE ENVIRONMENT         03060000
                                                                        03070000
         L     R2,PCBUSER         ADDRESS OF IUSER BLOCK                03080000
         USING IUSER,R2           ADDRESSABILITY                        03090000
                                                                        03100000
         LA    R15,RC04           ASSUME TABLE IS NOT ACTIVE            03110000
         LA    R5,USRTIBS-(TIBNEXT-TIBLOCK)                             03120000
         USING TIBLOCK,R5         PREPARE FOR TIB TRAVERSAL             03130000
                                                                        03140000
LTIBNXT  DS    0H                                                       03150000
         LR    R6,R5              SAVE BACKLINK PTR                     03160000
         ICM   R5,15,TIBNEXT      ADVANCE TO NEXT TIB                   03170000
         BZ    LTIBEXIT           END OF CHAIN                          03180000
         CLC   TIBTOKN,0(R1)      MATCHING TABLE TOKEN?                 03190000
         BNE   LTIBNXT            CONTINUE SCAN IF NOT                  03200000
                                                                        03210000
         LA    R0,TIBLOCK         MATCHING TIB                          03220000
         LR    R1,R6              LIST PREDECESSOR TIB                  03230000
         LA    R15,RC00           INDICATE SUCCESS                      03240000
                                                                        03250000
LTIBEXIT NOP   0                  RETURN                                03260000
         PR    ,                                                        03270000
         DROP  R2,R5              IUSER, TIB                            03280000
                                                                        03290000
         EJECT                                                          03300000
***************************************************************         03310000
*                                                                       03320000
*   Local read only storage                                             03330000
*                                                                       03340000
***************************************************************         03350000
                                                                        03360000
MSGDESC  DC    C'TBDESC operation failed'                               03370000
MSGNOTIB DC    C'Invalid table reference'                               03380000
                                                                        03390000
         LTORG ,                                                        03400000
                                                                        03410000
         PRINT NOGEN                                                    03420000
         ICVT  ,                                                        03430000
         ITASK ,                                                        03440000
         IPCB  ,                                                        03450000
         IUSER ,                                                        03460000
         IPROJ ,                                                        03470000
         END   ,                                                        03480000

IL62NGTS TITLE 'INTEGRATOR - WE PROCESSOR GET SESSION'                  00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: IL62NGTS - INTEGRATOR WE PROCESSOR GET SESSION               00100000
*                                                                       00110000
* DESCRIPTION:                                                          00120000
*                                                                       00130000
* ON ENTRY:                                                             00140000
*                                                                       00150000
*    R15 = ENTRY POINT ADDRESS                                          00160000
*    R14 = RETURN      ADDRESS                                          00170000
*    R13 = SAVE AREA   ADDRESS                                          00180000
*    R11 = ICVT        ADDRESS                                          00190000
*    R10 = ITASK       ADDRESS                                          00200000
*    R09 = IVTAMCVT    ADDRESS                                          00210000
*    R01 = IWE         ADDRESS                                          00220000
*                                                                       00230000
* ON EXIT:                                                              00240000
*                                                                       00250000
*    R15 = 0                                                            00260000
*    R00 = 0                                                            00270000
*    R01 = 0                                                            00280000
*                                                                       00290000
*    ALL OTHER REGISTERS ARE RESTORED                                   00300000
*                                                                       00310000
**<DOC-OFF>************************************************************ 00320000
                                                                        00330000
         EJECT ,                                                        00340000
*********************************************************************** 00350000
*                                                                       00360000
* MAINTENANCE:                                                          00370000
*                                                                       00380000
*   07/01/94 RANDY WITEK                                                00390000
*                                                                       00400000
*********************************************************************** 00410000
                                                                        00420000
         EQUS  ,                  GENERAL EQUATES                       00430000
                                                                        00440000
RICVT    EQU   R11                                                      00450000
RITASK   EQU   R10                                                      00460000
RIVTAM   EQU   R9                                                       00470000
RIACB    EQU   R8                                                       00480000
RIWE     EQU   R7                                                       00490000
RPLB     EQU   R6                                                       00500000
RIVUSER  EQU   R6                                                       00510000
                                                                        00520000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00530000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00540000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00550000
         USING IACB,RIACB         ESTABLISH ADDRESSABILITY              00560000
         USING IWEVTAM,RIWE       ESTABLISH ADDRESSABILITY              00570000
         USING IVUSER,RIVUSER     ESTABLISH ADDRESSABILITY              00580000
                                                                        00590000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00600000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00610000
L62MFL   L62DFPL MF=L             PLIST CONSTRUCTION                    00620000
WRK256   DS    XL256              GENERAL WORKAREA                      00630000
RETPLB   DS    F                  LU6.2 IVUSER/PLB  RETURN AREA         00640000
RETRC    DS    F                  LU6.2 RETURN CODE RETURN AREA         00650000
RETR15   DS    F                  RETURN CODE VALUE                     00660000
RETR0    DS    F                  RETURN REGISTER 0                     00670000
RETR1    DS    F                  RETURN REGISTER 1                     00680000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00690000
FLAG     DS    X                                                        00700000
FLAGLOCK EQU   X'80'              VTAM LOCK OBTAINED                    00710000
FLAGLCKD EQU   X'40'              VTAM LOCK WAS HELD ON ENTRY           00720000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00730000
                                                                        00740000
         $MSGDFT PREFIX=ICTPID,                                        +00750000
               COMPID='L62',                                           +00760000
               TABLE=*#MSGS,                                           +00770000
               WORKA=0,                                                +00780000
               MF=(E,WRK256),                                          +00790000
               PRINT=NOGEN                                              00800000
                                                                        00810000
IL62NGTS #ENTER BASE=R12,         ENTRY LINKAGE                        +00820000
               AMODE=31,                                               +00830000
               PREG=(RIWE),                                            +00840000
               RMODE=ANY                                                00850000
                                                                        00860000
*---------------------------------------------------------------------- 00870000
* NO ALLOCATES DURING SYSTEM/TASK TERMINATION                           00880000
*---------------------------------------------------------------------- 00890000
                                                                        00900000
         TM    ICTSTAT3,ICT3$P+ICT3$PX                                  00910000
         BNZ   ERRPOST            BRANCH IF SYSTEM TERMINATING          00920000
         TM    IVTF1,IVTF1TRM                                           00930000
         BO    ERRPOST            BRANCH IF VTAM MAIN TASK TERMINATING  00940000
                                                                        00950000
*---------------------------------------------------------------------- 00960000
* LOCATE THE CORRECT LOCAL LU                                           00970000
* CURRENTLY WE SUPPORT ONLY THE ONE INTEGRATOR LU6.2 ACB                00980000
*---------------------------------------------------------------------- 00990000
                                                                        01000000
         CLC   IWEXRLLU,ICTAPL62  REQUESTING MAIN LU6.2 ACB?            01010000
         BNE   ERRPOST            BRANCH NO, ALLOC FAILURE NO RETRY     01020000
         ICM   RIACB,15,IVTACB62  MAIN LU6.2 ACB ADDRESS                01030000
         BNP   ERRPOST            BRANCH IF NONE                        01040000
         TM    IACF1,IACF1TPN+IACF1CLS+IACF1QUI+IACF1TRM+IACF1UNU       01050000
         BNZ   ERRPOST            BRANCH IF ACB IS UNUSABLE             01060000
         TM    IACF1,IACF1OPN                                           01070000
         BNO   ERRPOST            BRANCH IF ACB IS NOT OPEN             01080000
                                                                        01090000
*---------------------------------------------------------------------- 01100000
* LOCATE/CREATE THE PARTNER LU                                          01110000
*---------------------------------------------------------------------- 01120000
                                                                        01130000
         BAS   R14,VTAMLOCK       SERIALIZE                             01140000
                                                                        01150000
         L62DSPL (RIACB),         LOCAL LU ADDRESS                     +01160000
               IWEXRPLU,          PARTNER LU NAME ADDRESS              +01170000
               IWEXRPLL,          PARTNER LU NAME LENGTH ADDRESS       +01180000
               RETPLB,            PLB ADDRESS RETURN AREA              +01190000
               RETRC,             RETURN CODE AREA                     +01200000
               MF=(E,L62MFL)                                            01210000
                                                                        01220000
         OC    RETRC,RETRC        DOES PARTNER LU EXIST?                01230000
         BZ    GOTPART            BRANCH IF YES                         01240000
                                                                        01250000
         CLC   IWEXRRCT,=A(CM_IMMEDIATE) OK TO CREATE SESSIONS?         01260000
         BE    ERRPOST                   BRANCH IF NOT                  01270000
                                                                        01280000
         L62DFPL (RIACB),         LOCAL LU ADDRESS                     +01290000
               IWEXRPLU,          PARTNER LU NAME ADDRESS              +01300000
               IWEXRPLL,          PARTNER LU NAME LENGTH ADDRESS       +01310000
               RETPLB,            PLB ADDRESS RETURN AREA              +01320000
               RETRC,             RETURN CODE AREA                     +01330000
               MF=(E,L62MFL)                                            01340000
                                                                        01350000
         OC    RETRC,RETRC        WAS PARTNER LU SUCCESSFULLY STARTED?  01360000
         BZ    DEFPART            BRANCH IF YES                         01370000
         CLC   RETRC,=A(LU62_PRODUCT_SPECIFIC_ERROR) MAYBE A RACE?      01380000
         BNE   ERRPOST            BRANCH IF NOT                         01390000
                                                                        01400000
         L62DSPL (RIACB),         LOCAL LU ADDRESS                     +01410000
               IWEXRPLU,          PARTNER LU NAME ADDRESS              +01420000
               IWEXRPLL,          PARTNER LU NAME LENGTH ADDRESS       +01430000
               RETPLB,            PLB ADDRESS RETURN AREA              +01440000
               RETRC,             RETURN CODE AREA                     +01450000
               MF=(E,L62MFL)                                            01460000
                                                                        01470000
         OC    RETRC,RETRC        DID SOMEBODY ELSE DO THE CREATE?      01480000
         BZ    GOTPART            BRANCH IF YES                         01490000
         B     ERRPOST            BRANCH IF CAN'T FIND PARTNER LU       01500000
                                                                        01510000
DEFPART  DS    0H                                                       01520000
                                                                        01530000
         ICM   RIVUSER,15,RETPLB  RETURNED PLB OF PARTNER LU            01540000
         BNP   ERRPOST            BRANCH IF DOESN'T LOOK GOOD           01550000
         OI    IVUF1,IVUF1LIN     USER IS LOCALLY INITIATED             01560000
         B     ALLOCWE            CONTINUE                              01570000
                                                                        01580000
GOTPART  DS    0H                                                       01590000
                                                                        01600000
         ICM   RIVUSER,15,RETPLB  RETURNED PLB OF PARTNER LU            01610000
         BNP   ERRPOST            BRANCH IF DOESN'T LOOK GOOD           01620000
                                                                        01630000
*                                                                       01640000
* ALLOCATE GET SESSION WORK ELEMENT FOR IVUSER WORK                     01650000
*---------------------------------------------------------------------- 01660000
                                                                        01670000
ALLOCWE  DS    0H                                                       01680000
                                                                        01690000
         $VTAMWE L'IWEXR,          SIZE                                +01700000
               IWECGETS            CODE                                 01710000
                                                                        01720000
L        USING IWE,R3                                                   01730000
                                                                        01740000
         LR    R3,R1               ESTABLISH ADDRESSIBILITY             01750000
         LR    R0,R1               COPY-TO   ADDRESS                    01760000
         L     R1,IWELEN           COPY-TO   LENGTH                     01770000
         LR    R14,RIWE            COPY-FROM ADDRESS                    01780000
         LR    R15,R1              COPY-FROM LENGTH                     01790000
         MVCL  R0,R14              COPY THE WORK ELEMENT                01800000
         XC    L.IWELINK,L.IWELINK NO WE'S LINKED TO THE NEW COPY       01810000
         XC    L.IWEECB,L.IWEECB   ENSURE ECB CLEAR IN NEW COPY         01820000
                                                                        01830000
         DROP  L                                                        01840000
                                                                        01850000
*---------------------------------------------------------------------- 01860000
* QUEUE GET SESSION WORK ELEMENT TO IVUSER                              01870000
*---------------------------------------------------------------------- 01880000
                                                                        01890000
         LR    R1,R3              WORK ELEMENT ADDRESS                  01900000
         LA    R0,IVUWEQ          IVUSER WORK QUEUE                     01910000
         BAS   R14,QWE            GO QUEUE THE LOGON WORK ELEMENT       01920000
         LTR   R15,R15            SUCCESSFUL QUEUEING?                  01930000
         BZ    RETURN             BRANCH IF YES                         01940000
         B     ERRPOST            KILL THE REQUEST                      01950000
                                                                        01960000
*---------------------------------------------------------------------- 01970000
* POST THE REQUESTOR IF PROCESSING WILL NOT CONTINUE AT IVUSER LEVEL    01980000
*---------------------------------------------------------------------- 01990000
                                                                        02000000
ERRPOST  DS    0H                                                       02010000
                                                                        02020000
         L62POST *IWEXREPB,       ADDRESS OF EPB TO BE POSTED          +02030000
               =F'4',             ADDRESS OF ERROR POSTCODE            +02040000
               IWEXRENT,          ADDRESS OF ENTITY TOKEN              +02050000
               RETRC,             RETURN CODE AREA                     +02060000
               MF=(E,L62MFL)                                            02070000
                                                                        02080000
         B     RETURN                                                   02090000
                                                                        02100000
*---------------------------------------------------------------------- 02110000
* RETURN TO MAIN TASK MAINLINE                                          02120000
*---------------------------------------------------------------------- 02130000
                                                                        02140000
RETURN   DS    0H                                                       02150000
                                                                        02160000
         BAS   R14,VTAMUNLK                                             02170000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 02180000
                                                                        02190000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    02200000
                                                                        02210000
*---------------------------------------------------------------------- 02220000
* SUBROUTINE QWE - QUEUE A WORK ELEMENT TO A GIVEN WORK QUEUE           02230000
*                                                                       02240000
* ENTRY            R14 = RETURN ADDRESS                                 02250000
*                  R1  = WORK ELEMENT ADDRESS                           02260000
*                  R0  = QUEUE ADDRESS                                  02270000
*                                                                       02280000
* RETURNS          R15 = 0 --> QUEUEING WAS SUCCESSFUL                  02290000
*                      = 4 --> QUEUEING FAILED, WORK ELEMENT RELEASED   02300000
*---------------------------------------------------------------------- 02310000
                                                                        02320000
QWE      DS    0H                                                       02330000
                                                                        02340000
         STM   R14,R4,SUB0SAVE    SAVE REGISTERS                        02350000
         LR    R3,R0              SAVE QUEUE ADDRESS                    02360000
         LR    R4,R1              SAVE WORK ELEMENT ADDRESS             02370000
                                                                        02380000
         $VTAMQ (R4),             WORK ELEMENT                         +02390000
               (R3)               QUEUE                                 02400000
                                                                        02410000
         L     R14,SUB0SAVE       RESTORE REGISTERS                     02420000
         LM    R0,R4,SUB0SAVE+8   RESTORE REGISTERS                     02430000
         BR    R14                AND RETURN TO CALLER W/R15            02440000
                                                                        02450000
*---------------------------------------------------------------------- 02460000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 02470000
*---------------------------------------------------------------------- 02480000
                                                                        02490000
VTAMLOCK DS    0H                                                       02500000
                                                                        02510000
         TM    FLAG,FLAGLOCK        WAS THE LOCK ALREADY OBTAINED?      02520000
         BOR   R14                  RETURN IF YES                       02530000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             02540000
                                                                        02550000
         $SER  OBTAIN,                                                 +02560000
               VTAM                                                     02570000
                                                                        02580000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              02590000
         BNE   VTAMLOEX             BRANCH IF NOT                       02600000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         02610000
                                                                        02620000
VTAMLOEX DS    0H                                                       02630000
                                                                        02640000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               02650000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          02660000
         BR    R14                  RETURN                              02670000
                                                                        02680000
*---------------------------------------------------------------------- 02690000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                02700000
*---------------------------------------------------------------------- 02710000
                                                                        02720000
VTAMUNLK DS    0H                                                       02730000
                                                                        02740000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       02750000
         BNOR  R14                  BRANCH IF NOT                       02760000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             02770000
         BOR   R14                  DON'T RELEASE IF IT WAS             02780000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             02790000
                                                                        02800000
         $SER  RELEASE,                                                +02810000
               VTAM                                                     02820000
                                                                        02830000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  02840000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          02850000
         BR    R14                  RETURN                              02860000
                                                                        02870000
*---------------------------------------------------------------------- 02880000
*  CONSTANTS AND LITERALS                                               02890000
*---------------------------------------------------------------------- 02900000
                                                                        02910000
         LTORG ,                                                        02920000
         PRINT NOGEN                                                    02930000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                02940000
         ISTDBIND ,               VTAM BIND IMAGE                       02950000
         TRACODES ,               INTEGRATOR TRACE CODES                02960000
         ICVT  ,                  INTEGRATOR CVT                        02970000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   02980000
         IRPL ,                   INTEGRATOR VTAM RPL+                  02990000
         IACB ,                   INTEGRATOR VTAM ACB+                  03000000
         INIB ,                   INTEGRATOR VTAM NIB+                  03010000
         ISESS ,                  INTEGRATOR SESSION BLOCK              03020000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            03030000
         ITASK ,                  INTEGRATOR TASK BLOCK                 03040000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          03050000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       03060000
         EVCODES ,                INTEGRATOR EVENT CODES                03070000
         ABCODES ,                INTEGRATOR $ABEND CODES               03080000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     03090000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        03100000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             03110000
         IFGEXLST ,               VTAM EXIT LIST                        03120000
         END   ,                                                        03130000

IRMXMSGQ TITLE '- RESOURCE MANAGER: WORKUNIT MESSAGE QUEUE/LIST'        00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: IRMXMSGQ - Resource mgr: workunit message queue              00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine serves as a resource manager for the message          00080000
*    queue associated with a workunit.  It deletes all messages         00090000
*    queued to either the message list (MSGL), if implemented,          00100000
*    and the message queue (MSGQ) proper.                               00110000
*                                                                       00120000
* ON ENTRY:                                                             00130000
*                                                                       00140000
*    R0  contains the address of the terminating workunit               00150000
*                                                                       00160000
* ON EXIT:                                                              00170000
*                                                                       00180000
*    R15 contains zero                                                  00190000
*                                                                       00200000
**<DOC-OFF>****************************************************         00210000
                                                                        00220000
         EJECT ,                                                        00230000
***************************************************************         00240000
*                                                                       00250000
* MAINTENANCE:                                                          00260000
*                                                                       00270000
*   09/02/94  R. Turgeon                                                00280000
*             Initial version                                           00290000
*                                                                       00300000
***************************************************************         00310000
                                                                        00320000
         EJECT                                                          00330000
         #WORK ,                                                        00340000
         #ENDWORK ,                                                     00350000
                                                                        00360000
         EJECT                                                          00370000
         @CB   WORKUNIT=YES       COMMON WORKUNIT PREFIX                00380000
                                                                        00390000
         EJECT                                                          00400000
         TMSG  HDR=YES            INTERTASK MESSAGE FORMAT              00410000
                                                                        00420000
         EJECT                                                          00430000
         EQUS  ,                  GENERAL EQUATES                       00440000
                                                                        00450000
         EJECT                                                          00460000
IRMXMSGQ #ENTER PREG=(,R8)                                              00470000
                                                                        00480000
         USING ITASK,R10          STDENV                                00490000
         USING @CB,R8             TERMINATING WORKUNIT                  00500000
                                                                        00510000
         EJECT                                                          00520000
***************************************************************         00530000
*                                                                       00540000
*   DEQUEUE AND DELETE ALL ENTRIES IN MESSAGE LIST (MSGL) AND           00550000
*   THEN THE MESSAGE QUEUE (MSGQ)                                       00560000
*                                                                       00570000
***************************************************************         00580000
         ICM   R1,15,@CB@MSGL     WU IMPLEMENTS MESSAGE LIST (MSGL)?    00590000
         BZ    *+8                SKIP IF NOT                           00600000
         BAS   R14,DEQ_DEL        DEQUEUE AND DELETE                    00610000
                                                                        00620000
         L     R1,@CB@MSGQ        MESSAGE QUEUE (MSGQ)                  00630000
         BAS   R14,DEQ_DEL        DEQUEUE AND DELETE                    00640000
                                                                        00650000
         SR    R15,R15            RETURN CODES NOT DEFINED              00660000
         #EXIT ,                                                        00670000
                                                                        00680000
         EJECT                                                          00690000
***************************************************************         00700000
*                                                                       00710000
* ROUTINE: DEQ_DEL - DEQUEUE AND DELETE MESSAGE ENTRIES                 00720000
*                                                                       00730000
* NOTES:                                                                00740000
*                                                                       00750000
*    CDS IS USED IN THE (UNLIKELY) EVENT THAT INBOUND MESSAGES          00760000
*    ARE STILL ARRIVING WHILE CLEANUP IS RUNNING.  THIS ENSURES         00770000
*    THAT MESSAGES ARE DELETED CLEANLY, BUT DOES NOT PREVENT            00780000
*    CALLERS FROM QUEUEING ADDITIONAL MESSAGES.                         00790000
*                                                                       00800000
* ON ENTRY:                                                             00810000
*                                                                       00820000
*    R1  ADDR OF MESSAGE HEADER IN (PTR,COUNT) FORMAT                   00830000
*                                                                       00840000
***************************************************************         00850000
DEQ_DEL  DS    0H                                                       00860000
         STM   R14,R12,12(R13)    SAVE MAINLINE REGS                    00870000
         LR    R7,R1              RETAIN PTR TO MESSAGE (PTR,COUNT)     00880000
                                                                        00890000
DEQ_NEXT DS    0H                 DEQUEUE TOP MESSAGE                   00900000
         LM    R4,R5,0(R7)        ANCHOR AND COUNT                      00910000
         USING TMSG,R4            MESSAGE FORMAT                        00920000
                                                                        00930000
DEQ_SWAP DS    0H                 SWAP MESSAGE OFF                      00940000
         LTR   R4,R4              MESSAGE ENTRIES REMAIN?               00950000
         BZ    DEQ_FIN            DONE IF NOT                           00960000
         L     R2,TMSGNEXT        MESSAGE FOLLOWING TOP MESSAGE         00970000
         LR    R3,R5              CURRENT ENTRY COUNT                   00980000
         BCTR  R3,0               ACCOUNT FOR REMOVAL                   00990000
         CDS   R4,R2,0(R7)        SWAP OUT TOP ENTRY                    01000000
         BNE   DEQ_SWAP           RETRY                                 01010000
                                                                        01020000
         $RETSTOR (R4),OWNER=@CB  RELEASE THE MESSAGE                   01030000
                                                                        01040000
         B     DEQ_NEXT           AGAIN                                 01050000
         DROP  R4                 TMSG                                  01060000
                                                                        01070000
*--------------------------------------------------------------         01080000
*   RETURN                                                              01090000
*--------------------------------------------------------------         01100000
DEQ_FIN  DS    0H                                                       01110000
         LM    R14,R12,12(R13)    RESTORE REGS                          01120000
         SR    R15,R15            RETURN CODES NOT DEFINED              01130000
         BR    R14                DONE                                  01140000
                                                                        01150000
         EJECT                                                          01160000
***************************************************************         01170000
*                                                                       01180000
*   LOCAL READ ONLY DATA AREAS, ETC.                                    01190000
*                                                                       01200000
***************************************************************         01210000
         LTORG ,                                                        01220000
                                                                        01230000
         PRINT NOGEN                                                    01240000
         ICVT  ,                                                        01250000
         ITASK ,                                                        01260000
         END   ,                                                        01270000

IVTMSPST TITLE 'INTEGRATOR - POST $SESS REQUEST COMPLETE'               00010000
**<DOC-ON>************************************************************* 00020000
*                                                                       00030000
* ROUTINE: IVTMSPST - POST $SESS REQUEST COMPLETE                       00040000
*                                                                       00050000
* DESCRIPTION: THIS ROUTINE IS CALLED TO TRACE AND POST THE $SESS       00060000
*              REQUEST COMPLETION.                                      00070000
*                                                                       00080000
* ON ENTRY:                                                             00090000
*                                                                       00100000
*    R15 = ENTRY POINT ADDRESS                                          00110000
*    R14 = RETURN ADDRESS                                               00120000
*    R13 = AVAILABLE SAVE AREA                                          00130000
*    R11 = ICVT ADDRESS                                                 00140000
*    R10 = ITASK ADDRESS                                                00150000
*    R09 = IVTAMCVT ADDRESS                                             00160000
*    R01 = ADDRESS OF THE SPLIST TO BE POSTED                           00170000
*                                                                       00180000
* ON EXIT:                                                              00190000
*                                                                       00200000
*    R15 = 0                                                            00210000
*    R00 = 0                                                            00220000
*    R01 = 0                                                            00230000
*                                                                       00240000
*    ALL OTHER REGISTERS ARE RESTORED.                                  00250000
*                                                                       00260000
**<DOC-OFF>************************************************************ 00270000
                                                                        00280000
         EJECT ,                                                        00290000
*********************************************************************** 00300000
*                                                                       00310000
* MAINTENANCE:                                                          00320000
*                                                                       00330000
*   08/01/93 RANDY WITEK                                                00340000
*   10/06/95 RANDY WITEK - VALIDATE WU TOKEN BEFORE POSTING             00350000
*                                                                       00360000
*********************************************************************** 00370000
                                                                        00380000
         EQUS  ,                  GENERAL EQUATES                       00390000
                                                                        00400000
RICVT    EQU   R11                                                      00410000
RITASK   EQU   R10                                                      00420000
RIVTAM   EQU   R9                                                       00430000
RSPLIST  EQU   R8                                                       00440000
                                                                        00450000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00460000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00470000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00480000
         USING SPLIST,RSPLIST     ESTABLISH ADDRESSABILITY              00490000
                                                                        00500000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00510000
WRK256   DS    XL256              GENERAL WORKAREA                      00520000
SUB0SAVE DS    16F                SUBROUTINE SAVE AREA                  00530000
$TASKMFL $TASK MF=L               $TASK PLIST CONSTRUCTION              00540000
$WUMFL   $WULOC MF=L              PARM LIST CONSTRUCTION                00550000
WUDATA   DS    XL16               $WULOC USERDATA RETURN AREA           00560000
WUTOKEN  DS    XL8                TEMPORARY WORK UNIT TOKEN AREA        00570000
RETR15   DS    F                                                        00580000
RETR0    DS    F                                                        00590000
RETR1    DS    F                                                        00600000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00610000
POSTR15  DS    F                                                        00620000
POSTR0   DS    F                                                        00630000
FLAG     DS    X                                                        00640000
FLAGLOCK EQU   X'80'                                                    00650000
FLAGLCKD EQU   X'40'                                                    00660000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00670000
                                                                        00680000
         $MSGDFT PREFIX=ICTPID,                                        +00690000
               COMPID='VTM',                                           +00700000
               TABLE=*#MSGS,                                           +00710000
               WORKA=0,                                                +00720000
               MF=(E,WRK256),                                          +00730000
               PRINT=NOGEN                                              00740000
                                                                        00750000
IVTMSPST #ENTER BASE=R12,         ENTRY LINKAGE                        +00760000
               PREG=RSPLIST,                                           +00770000
               AMODE=31,                                               +00780000
               RMODE=ANY                                                00790000
                                                                        00800000
*---------------------------------------------------------------------- 00810000
* TRACE THE REQUEST COMPLETION                                          00820000
*---------------------------------------------------------------------- 00830000
                                                                        00840000
         $TRACE *=A(TRC_ISESAPI_POST),48 TRACE ENTRY W/ 16 USER BYTES   00850000
                                                                        00860000
         BNZ   NOPTRACE           BRANCH IF TRACING NOT AVAILABLE       00870000
                                                                        00880000
         MVC   0(4,R1),SPLFUNC    TRACE $SESS FUNCTION CODE             00890000
         ST    RSPLIST,4(,R1)     TRACE SPLIST                          00900000
         MVC   16(4,R1),SPLRETCD  TRACE RETURN CODE                     00910000
         MVC   20(4,R1),SPLRSNCD  TRACE REASON CODE                     00920000
         MVC   24(4,R1),SPLAREA   TRACE AREA ADDRESS                    00930000
         MVC   28(4,R1),SPLAREAL  TRACE AREA LENGTH                     00940000
         MVC   32(3,R1),SPLRH     TRACE RH                              00950000
         MVC   35(3,R1),SPLCNTRL  TRACE CONTROL FLAGS FOR RU-TYPE       00960000
         MVC   38(2,R1),SPLSEQNO  TRACE SEQUENCE NUMBER                 00970000
         MVC   40(4,R1),SPLSENSE  TRACE SENSE                           00980000
         MVC   44(4,R1),SPLF1     TRACE REQUEST FLAGS                   00990000
         MVC   8(8,R1),SPLTOKEN   TRACE SESSION TOKEN                   01000000
                                                                        01010000
NOPTRACE DS    0H                                                       01020000
                                                                        01030000
*---------------------------------------------------------------------- 01040000
* TRACE SPLIST AND DATA TO LOGFILE IF APPROPRIATE                       01050000
*---------------------------------------------------------------------- 01060000
                                                                        01070000
         LR    R1,RSPLIST         PASS SPLIST IN R1                     01080000
         L     R15,IVT@ATSP       TRACE ROUTINE ENTRY POINT             01090000
         BASR  R14,R15            LINK TO TRACE ROUTINE                 01100000
                                                                        01110000
*---------------------------------------------------------------------- 01120000
* ISSUE GENERAL INFORMATION MESSAGE IF NEGATIVE RESPONSE RECEIVED       01130000
*---------------------------------------------------------------------- 01140000
                                                                        01150000
         CLC   SPLRSNCD+2(2),=X'0404' NEGATIVE RESPONSE RECEIVED?       01160000
         BNE   NONEGRSP               BRANCH IF NOT                     01170000
                                                                        01180000
         $MSG  965,               "-RSP RECEIVED..."                   +01190000
               FIELDS=((RSPLIST),    SPLIST ADDRESS                    +01200000
               (SPLTOKEN,4),         IVUSER TOKEN                      +01210000
               (SPLTOKEN+4,4),       ISESS  TOKEN                      +01220000
               (RITASK),             ITASK ADDRESS                     +01230000
               (TSKPCBC,4),          IPROC ADDRESS                     +01240000
               (TSKNAME,8),          ITASK NAME                        +01250000
               (SPLSENSE,4),         SENSE                             +01260000
               (SPLCNTRL,3),         CNTRL FLAGS                       +01270000
               (SPLRH,3),            REQUEST HEADER                    +01280000
               (SPLSEQNO,2))         SEQUENCE NUMBER                    01290000
                                                                        01300000
NONEGRSP DS    0H                                                       01310000
                                                                        01320000
*---------------------------------------------------------------------- 01330000
* POST THE REQUEST COMPLETE                                             01340000
*---------------------------------------------------------------------- 01350000
                                                                        01360000
         BAS   R14,DISPLOCK       SERIALIZE                             01370000
                                                                        01380000
         $WULOC LOCATE,           FIND THE WORK UNIT                   +01390000
               TOKEN=SPLWU,       WORK UNIT TOKEN ADDRESS              +01400000
               USERDATA=WUDATA,   XL16 AREA TO RECEIVE USER DATA       +01410000
               LOCKED=YES,        DISP LOCK LOCALLY ACQUIRED           +01420000
               MF=(E,$WUMFL)      VALIDATE WORK UNIT                    01430000
                                                                        01440000
         LTR   R15,R15            LOCATE SUCCESS?                       01450000
         BNZ   ERRWU              BRANCH IF YES                         01460000
                                                                        01470000
         L     R3,SPLEPB          USER EPB OR API XEPB FOR REQUEST      01480000
                                                                        01490000
         $TASK POST,              POST THE ASSOCIATED EPB              +01500000
               EPB=(R3),                                               +01510000
               PCODE=0,                                                +01520000
               MF=(E,$TASKMFL)                                          01530000
                                                                        01540000
         LTR   R15,R15            POST COMPLETE                         01550000
         BZ    RETURN             BRANCH IF YES                         01560000
         ST    R15,POSTR15        SAVE RC                               01570000
         ST    R0,POSTR0          SAVE RSN                              01580000
         B     MSG973                                                   01590000
                                                                        01600000
ERRWU    DS    0H                                                       01610000
                                                                        01620000
         MVC   POSTR15,=F'-1'     SET SPECIAL POST RC                   01630000
         MVC   POSTR0,=F'-1'      SET SPECIAL POST RSN                  01640000
         B     MSG973                                                   01650000
                                                                        01660000
MSG973   DS    0H                                                       01670000
                                                                        01680000
         BAS   R14,DISPUNLK       RELEASE THE LOCK                      01690000
                                                                        01700000
         $MSG  973,               "$SESS POST FAILED..."               +01710000
               FIELDS=((SPLTOKEN,4), IVUSER TOKEN                      +01720000
               (SPLTOKEN+4,4),    ISESS TOKEN                          +01730000
               (RSPLIST),         SPLIST ADDRESS                       +01740000
               (R3),              SPLEPB ADDRESS                       +01750000
               (POSTR15,4),       $TASK POST RC                        +01760000
               (POSTR0,4))        $TASK POST RSN                        01770000
                                                                        01780000
         B     RETURN             RETURN TO CALLER                      01790000
                                                                        01800000
*---------------------------------------------------------------------- 01810000
* RETURN TO CALLER                                                      01820000
*---------------------------------------------------------------------- 01830000
                                                                        01840000
RETURN   DS    0H                                                       01850000
                                                                        01860000
         BAS   R14,DISPUNLK       RELEASE THE LOCK IF NECESSARY         01870000
                                                                        01880000
         LM    R15,R1,RETREGS     LOAD RETURN VALUES                    01890000
                                                                        01900000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    01910000
                                                                        01920000
*---------------------------------------------------------------------- 01930000
*   SUBROUTINE: OBTAIN DISP GLOBAL LOCK                                 01940000
*---------------------------------------------------------------------- 01950000
                                                                        01960000
DISPLOCK DS    0H                                                       01970000
                                                                        01980000
         TM    FLAG,FLAGLOCK        WAS THE LOCK ALREADY OBTAINED?      01990000
         BOR   R14                  RETURN IF YES                       02000000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             02010000
                                                                        02020000
         $SER  OBTAIN,                                                 +02030000
               DISP                                                     02040000
                                                                        02050000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              02060000
         BNE   DISPLOEX             BRANCH IF NOT                       02070000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         02080000
                                                                        02090000
DISPLOEX DS    0H                                                       02100000
                                                                        02110000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               02120000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          02130000
         BR    R14                  RETURN                              02140000
                                                                        02150000
*---------------------------------------------------------------------- 02160000
*   SUBROUTINE: RELEASE DISP GLOBAL LOCK                                02170000
*---------------------------------------------------------------------- 02180000
                                                                        02190000
DISPUNLK DS    0H                                                       02200000
                                                                        02210000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       02220000
         BNOR  R14                  BRANCH IF NOT                       02230000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             02240000
         BOR   R14                  DON'T RELEASE IF IT WAS             02250000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             02260000
                                                                        02270000
         $SER  RELEASE,                                                +02280000
               DISP                                                     02290000
                                                                        02300000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  02310000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          02320000
         BR    R14                  RETURN                              02330000
                                                                        02340000
*---------------------------------------------------------------------- 02350000
* ERROR ROUTINES                                                        02360000
*---------------------------------------------------------------------- 02370000
                                                                        02380000
*---------------------------------------------------------------------- 02390000
*  CONSTANTS AND LITERALS                                               02400000
*---------------------------------------------------------------------- 02410000
                                                                        02420000
         LTORG ,                                                        02430000
         PRINT NOGEN                                                    02440000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                02450000
         ISTDBIND ,               VTAM BIND IMAGE                       02460000
         ISTRH ,                  VTAM SNA REQUEST HEADER               02470000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         02480000
         ICVT  ,                  INTEGRATOR CVT                        02490000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   02500000
         IRPL ,                   INTEGRATOR VTAM RPL+                  02510000
         IACB ,                   INTEGRATOR VTAM ACB+                  02520000
         INIB ,                   INTEGRATOR VTAM NIB+                  02530000
         ISESS ,                  INTEGRATOR SESSION BLOCK              02540000
         IRQE ,                   INTEGRATOR RECEIVE QUEUE ELEMENT      02550000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            02560000
         ITASK ,                  INTEGRATOR TASK BLOCK                 02570000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          02580000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       02590000
         EVCODES ,                INTEGRATOR EVENT CODES                02600000
         ABCODES ,                INTEGRATOR $ABEND CODES               02610000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     02620000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        02630000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             02640000
         $PROC DSECT=YES          INTEGRATOR $PROC SERVICES             02650000
         $WULOC DSECT=YES         INTEGRATOR $WULOC SERVICES            02660000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             02670000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             02680000
         IFGEXLST ,               VTAM EXIT LIST                        02690000
         END   ,                                                        02700000

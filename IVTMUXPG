IVTMUXPG TITLE 'INTEGRATOR - IVUSER CPIC LOGON PROCESSOR'               00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: IVTMUTCP - IVUSER CPIC LOGON PROCESSOR                       00100000
*                                                                       00110000
* DESCRIPTION:                                                          00120000
*                                                                       00130000
* ON ENTRY:                                                             00140000
*                                                                       00150000
*    R15 = ENTRY POINT ADDRESS                                          00160000
*    R14 = RETURN ADDRESS                                               00170000
*    R13 = AVAILABLE SAVE AREA                                          00180000
*    R11 = ICVT ADDRESS                                                 00190000
*    R10 = ITASK ADDRESS                                                00200000
*    R09 = IVTAMCVT ADDRESS                                             00210000
*    R08 = IVUSER ADDRESS                                               00220000
*    R01 = ADDRESS OF LOGON WORK ELEMENT (IWE)                          00230000
*                                                                       00240000
* ON EXIT:                                                              00250000
*                                                                       00260000
*    R15 = 0                                                            00270000
*    R00 = 0                                                            00280000
*    R01 = 0                                                            00290000
*                                                                       00300000
*    ALL OTHER REGISTERS ARE RESTORED.                                  00310000
*                                                                       00320000
**<DOC-OFF>************************************************************ 00330000
                                                                        00340000
         EJECT ,                                                        00350000
*********************************************************************** 00360000
*                                                                       00370000
* MAINTENANCE:                                                          00380000
*                                                                       00390000
*   12/31/95 RANDY WITEK - 2.1 TRANSACTION PROGRAM VTAM WU SUPPORT      00400000
*                                                                       00410000
*********************************************************************** 00420000
                                                                        00430000
         EQUS  ,                  GENERAL EQUATES                       00440000
                                                                        00450000
RICVT    EQU   R11                                                      00460000
RITASK   EQU   R10                                                      00470000
RIVTAM   EQU   R9                                                       00480000
RIVUSER  EQU   R8                                                       00490000
RIWE     EQU   R7                                                       00500000
RXSP     EQU   R6                                                       00510000
                                                                        00520000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00530000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00540000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00550000
         USING IVUSER,RIVUSER     ESTABLISH ADDRESSABILITY              00560000
         USING IWEVTAM,RIWE       ESTABLISH ADDRESSABILITY              00570000
         USING XSP,RXSP           ESTABLISH ADDRESSABILITY              00580000
                                                                        00590000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00600000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00610000
$PROCMFL $PROC MF=L               PLIST CONSTRUCTION                    00620000
WUNAME   DS    CL8                NAME FOR NEW PROCESS                  00630000
WRK256   DS    XL256              GENERAL WORKAREA                      00640000
FLAG     DS    X                                                        00650000
FLAGLOCK EQU   X'80'                                                    00660000
FLAGLCKD EQU   X'40'                                                    00670000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00680000
                                                                        00690000
         $MSGDFT PREFIX=ICTPID,                                        +00700000
               COMPID='VTM',                                           +00710000
               TABLE=*#MSGS,                                           +00720000
               WORKA=0,                                                +00730000
               MF=(E,WRK256),                                          +00740000
               PRINT=NOGEN                                              00750000
                                                                        00760000
IVTMUXPG #ENTER BASE=R12,         ENTRY LINKAGE                        +00770000
               PREG=RIWE,                                              +00780000
               AMODE=31,                                               +00790000
               RMODE=ANY                                                00800000
                                                                        00810000
         CLC   IWELCODE,=A(IWECXPGL) IS IT A CPIC "LOGON"               00820000
         BNE   ERRWORK               BRANCH IF NOT, ERROR               00830000
                                                                        00840000
*---------------------------------------------------------------------- 00850000
* SERIALIZE WITH VTAM                                                   00860000
*---------------------------------------------------------------------- 00870000
                                                                        00880000
         BAS   R14,VTAMLOCK       GO SERIALIZE                          00890000
                                                                        00900000
*---------------------------------------------------------------------- 00910000
* REJECT THE LOGON IF SHUTDOWN IS IN PROGRESS                           00920000
*---------------------------------------------------------------------- 00930000
                                                                        00940000
         ICM   RXSP,15,IWEYDXSP   XSP ADDRESS                           00950000
         BNP   ERRWORK            BRANCH IF NO XSP                      00960000
                                                                        00970000
         TM    ICTSTAT3,ICT3$P+ICT3$PX SYSTEM SHUTDOWN?                 00980000
         BNZ   REJECT             BRANCH IF YES                         00990000
         TM    IVTF1,IVTF1TRM     IS TERMINATION UNDERWAY?              01000000
         BO    REJECT             BRANCH IF YES                         01010000
                                                                        01020000
*---------------------------------------------------------------------- 01030000
* USE TASK NAME FOR PROCESS NAME                                        01040000
*---------------------------------------------------------------------- 01050000
                                                                        01060000
         MVC   WUNAME,TSKNAME     SIMPLY REUSE THE TASK NAME            01070000
                                                                        01080000
*---------------------------------------------------------------------- 01090000
* RELEASE VTAM LOCK                                                     01100000
*---------------------------------------------------------------------- 01110000
                                                                        01120000
         BAS   R14,VTAMUNLK       RELEASE                               01130000
                                                                        01140000
*---------------------------------------------------------------------- 01150000
* CREATE A NEW PROCESS TO EXECUTE THE CPIC-VTAM APPLICATION             01160000
*---------------------------------------------------------------------- 01170000
                                                                        01180000
         $PROC CREATE,                  CREATE PROCESS TO INITIATE APPL+01190000
               EP=*IL6@XINI,            IL62XINI IS THE ENTRY POINT    +01200000
               NAME=WUNAME,             IPROC NAME                     +01210000
               PARM=*IWEYDXSP,          XSP IS THE PARM                +01220000
               MF=(E,$PROCMFL)                                          01230000
                                                                        01240000
         LTR   R15,R15                                                  01250000
         BNZ   ERR$PROC                 BRANCH IF SERVICE ERROR         01260000
         LR    R3,R1                    NEW IPCB ADDRESS                01270000
         B     RETURN                   WAIT FOR WORK                   01280000
                                                                        01290000
*---------------------------------------------------------------------- 01300000
* THE CPIC USER "LOGON" MUST BE REJECTED...STOP USER                    01310000
*---------------------------------------------------------------------- 01320000
                                                                        01330000
REJECT   DS    0H                                                       01340000
                                                                        01350000
         $VTAMWE L'IWEXI,                                              +01360000
               IWECSTPU           ALLOCATE "STOP USER" WORK ELEMENT     01370000
                                                                        01380000
         LR    R3,R1              WORK ELEMENT ADDRESS                  01390000
                                                                        01400000
         $VTAMQ (R3),             WORK ELEMENT                         +01410000
               IVUWEQ             QUEUE                                 01420000
                                                                        01430000
         B     RETURN                                                   01440000
                                                                        01450000
*---------------------------------------------------------------------- 01460000
* RETURN TO CALLER                                                      01470000
*---------------------------------------------------------------------- 01480000
                                                                        01490000
RETURN   DS    0H                                                       01500000
                                                                        01510000
         BAS   R14,VTAMUNLK             RELEASE THE LOCK IF NECESSARY   01520000
                                                                        01530000
         SR    R15,R15                  CLEAR R15                       01540000
         SR    R0,R0                    CLEAR R0                        01550000
         SR    R1,R1                    CLEAR R1                        01560000
                                                                        01570000
         #EXIT R1=YES                   RETURN W/R15,R0,R1              01580000
                                                                        01590000
*---------------------------------------------------------------------- 01600000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 01610000
*---------------------------------------------------------------------- 01620000
                                                                        01630000
VTAMLOCK DS    0H                                                       01640000
                                                                        01650000
         TM    FLAG,FLAGLOCK        WAS THE LOCK ALREADY OBTAINED?      01660000
         BOR   R14                  RETURN IF YES                       01670000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             01680000
                                                                        01690000
         $SER  OBTAIN,                                                 +01700000
               VTAM                                                     01710000
                                                                        01720000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              01730000
         BNE   VTAMLOEX             BRANCH IF NOT                       01740000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         01750000
                                                                        01760000
VTAMLOEX DS    0H                                                       01770000
                                                                        01780000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               01790000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          01800000
         BR    R14                  RETURN                              01810000
                                                                        01820000
*---------------------------------------------------------------------- 01830000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                01840000
*---------------------------------------------------------------------- 01850000
                                                                        01860000
VTAMUNLK DS    0H                                                       01870000
                                                                        01880000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       01890000
         BNOR  R14                  BRANCH IF NOT                       01900000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             01910000
         BOR   R14                  DON'T RELEASE IF IT WAS             01920000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             01930000
                                                                        01940000
         $SER  RELEASE,                                                +01950000
               VTAM                                                     01960000
                                                                        01970000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  01980000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          01990000
         BR    R14                  RETURN                              02000000
                                                                        02010000
*---------------------------------------------------------------------- 02020000
* ERROR ROUTINES                                                        02030000
*---------------------------------------------------------------------- 02040000
                                                                        02050000
ERR$PROC DS    0H                                                       02060000
                                                                        02070000
         $ABEND ABE_VTDIAG,                                            +02080000
               SCOPE=PCB,                                              +02090000
               TITLE='$PROC FAILURE'                                    02100000
                                                                        02110000
ERRWORK  DS    0H                                                       02120000
                                                                        02130000
         $ABEND ABE_VTDIAG,                                            +02140000
               SCOPE=PCB,                                              +02150000
               TITLE='UNKNOWN WORK ELEMENT'                             02160000
                                                                        02170000
*---------------------------------------------------------------------- 02180000
*  CONSTANTS AND LITERALS                                               02190000
*---------------------------------------------------------------------- 02200000
                                                                        02210000
         LTORG ,                                                        02220000
         PRINT NOGEN                                                    02230000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                02240000
         ISTDBIND ,               VTAM BIND IMAGE                       02250000
         TRACODES ,               INTEGRATOR TRACE CODES                02260000
         ICVT  ,                  INTEGRATOR CVT                        02270000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   02280000
         IRPL ,                   INTEGRATOR VTAM RPL+                  02290000
         ISESS ,                  INTEGRATOR SESSION BLOCK              02300000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            02310000
         ITASK ,                  INTEGRATOR TASK BLOCK                 02320000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          02330000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       02340000
         EVCODES ,                INTEGRATOR EVENT CODES                02350000
         ABCODES ,                INTEGRATOR $ABEND CODES               02360000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     02370000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        02380000
         $PROC DSECT=YES          INTEGRATOR $PROC SERVICES             02390000
         END   ,                                                        02400000

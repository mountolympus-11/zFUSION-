IRMXUSER TITLE ' - Free IUSER and assocatied user resources'            00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE: IRMXUSER - Resource manager exit rtn - Remove IUSER          00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*   The function of this routine is to delete the security              00080000
*   environment associated with the current user and then               00090000
*   remove the associated IUSER block from the ITASK user chain.        00100000
*   If the user has an open project, the resource manager routine       00110000
*   responsible for project cleanup is called.                          00120000
*                                                                       00130000
* ON ENTRY:                                                             00140000
*                                                                       00150000
*   R0 contains the address of the PCB being deleted                    00160000
*   R1 contains the address of the IUSER to be removed                  00170000
*                                                                       00180000
* ON EXIT:                                                              00190000
*                                                                       00200000
*   R15 contains one of the following return codes:                     00210000
*                                                                       00220000
*     RC00 - Normal completion                                          00230000
*                                                                       00240000
**<DOC-ON>******************************************************        00250000
                                                                        00260000
         EJECT ,                                                        00270000
****************************************************************        00280000
*                                                                       00290000
* MAINTENANCE:                                                          00300000
*                                                                       00310000
*   08/25/93  Ron Colmone                                               00320000
*             Initial version                                           00330000
*                                                                       00340000
*   09/23/94  Ron Colmone         Par #144661                    144661 00350000
*             Removed usecount management from RMX routine       144661 00360000
*             and replaced with generic $RESMGR usecount         144661 00370000
*             support.                                           144661 00380000
*                                                                       00390000
*   12/06/94  R. Turgeon                                                00400000
*             Removed PAGE= / SHRPAGE= for $SPACE, $OBJECT,             00410000
*             and TB* service requests                                  00420000
*                                                                       00430000
****************************************************************        00440000
                                                                        00450000
         EJECT ,                                                        00460000
         EQUS  ,                  GENERATE EQUATES                      00470000
                                                                        00480000
         EJECT                                                          00490000
         TBSERVIS CLOSE           TABLE SERVICES REQUEST TYPES          00500000
                                                                        00510000
         EJECT ,                                                        00520000
         $SAF  DSECT=YES          SECURITY INTERFACE PLIST              00530000
                                                                        00540000
         EJECT ,                                                        00550000
         $ENTITY DSECT=YES        ENTITY MANAGER PLIST FORMAT           00560000
                                                                        00570000
         EJECT ,                                                        00580000
         #WORK ,                  READ/WRITE WORKAREA                   00590000
                                                                        00600000
$SAF_MFL $SAF  MF=L               SECURITY INTERFACE PLIST AREA         00610000
                                                                        00620000
         #ENDWORK ,                                                     00630000
                                                                        00640000
         EJECT ,                                                        00650000
IRMXUSER #ENTER BASE=R12,PREG=(R7,R9)                                   00660000
                                                                        00670000
         USING ITASK,R10          ITASK ADDRESSABILITY                  00680000
         USING IPCB,R9            IPCB  ADDRESSABILITY                  00690000
         USING IUSER,R7           IUSER ADDRESSABILITY                  00700000
                                                                        00710000
         EJECT ,                                                        00720000
*--------------------------------------------------------------         00730000
*  Close private catalog table handles maintained for user              00740000
*--------------------------------------------------------------         00750000
                                                                        00760000
         ICM   R0,15,USRTKTAB                                           00770000
         BZ    CLOSETAB                                                 00780000
                                                                        00790000
         TBCLOSE TTOKEN=USRTKTAB,MF=(E,MFE_LIST)                        00800000
CLOSETAB DS    0H                                                       00810000
                                                                        00820000
         ICM   R0,15,USRTKCOL                                           00830000
         BZ    CLOSECOL                                                 00840000
                                                                        00850000
         TBCLOSE TTOKEN=USRTKCOL,MF=(E,MFE_LIST)                        00860000
CLOSECOL DS    0H                                                       00870000
                                                                        00880000
         ICM   R0,15,USRTKVAR                                           00890000
         BZ    CLOSEVAR                                                 00900000
                                                                        00910000
         TBCLOSE TTOKEN=USRTKVAR,MF=(E,MFE_LIST)                        00920000
CLOSEVAR DS    0H                                                       00930000
                                                                        00940000
*--------------------------------------------------------------         00950000
*  Delete all Table Information Blocks (TIBs) left open by the          00960000
*  cooperative process.  A null project name ptr is passed to           00970000
*  signify that all TIBs are to be freed.                               00980000
*--------------------------------------------------------------         00990000
                                                                        01000000
         @CALL IRMXTCLN,(IPCB,IUSER,0),                                X01010000
               CTYPE=CVT,MF=(E,MFE_LIST)                                01020000
                                                                        01030000
*--------------------------------------------------------------         01040000
*  Delete all Prepared Statement Blocks (PSBs) representing             01050000
*  active SQL statements in the cooperative process.  a PSB             01060000
*  token of zero is passed to signify that all PSBs are to be           01070000
*  freed.                                                               01080000
*--------------------------------------------------------------         01090000
                                                                        01100000
         @CALL IPSBDEL,(IPCB,IUSER,0,TRUE),   GENERIC (ALL) DELETE     X01110000
               CTYPE=CVT,MF=(E,MFE_LIST)                                01120000
                                                                        01130000
*--------------------------------------------------------------         01140000
*  If the user currently has an open project,  call the                 01150000
*  project resource manager routine to close it.                        01160000
*--------------------------------------------------------------         01170000
                                                                        01180000
         ICM   R0,15,USRPROJ      DOES USER HAVE AN OPEN PROJ?          01190000
         BZ    SEC_DEL            NO, DELETE SECURITY ENVIRON           01200000
                                                                        01210000
         LR    R0,R9              ADDRESS OF CURRENT WORKUNIT           01220000
         @CALL IRMXPROJ,CTYPE=CVT CLOSE OPEN PROJECT                    01230000
                                                                        01240000
*--------------------------------------------------------------         01250000
*  Delete the secutity environment, if any                              01260000
*--------------------------------------------------------------         01270000
                                                                        01280000
SEC_DEL  DS    0H                                                       01290000
         $SAF  DELETE,USER=IUSER,MF=(E,$SAF_MFL)                        01300000
                                                                        01310000
*--------------------------------------------------------------         01320000
*  Delete the SLU session $ENTITY structure                             01330000
*--------------------------------------------------------------         01340000
                                                                        01350000
         ICM   R0,15,USRSESS      GET SLU SESS ENTITY STRUCT            01360000
         BZ    DEL_USER           NONE, CONTINUE WITH IUSER             01370000
                                                                        01380000
         $ENTITY TERM,            DELETE SLU SESS ENTITY STRUCT        +01390000
               ANCHOR=USRSESS,                                         +01400000
               MF=(E,MFE_LIST)                                          01410000
                                                                        01420000
*--------------------------------------------------------------         01430000
*  Dequeue and delete the IUSER block                                   01440000
*--------------------------------------------------------------         01450000
                                                                        01460000
DEL_USER DS    0H                                                       01470000
         LA    R1,TSKUSRQ         ADDR OF IUSER QUEUE ORIGIN            01480000
         SH    R1,=A(USRNEXT-IUSER) PREPARE FOR QUEUE SCAN              01490000
P        USING IUSER,R1           IUSER ADDRESSABILITY (PREV)           01500000
                                                                        01510000
DEL_NEXT DS    0H                                                       01520000
         ICM   R2,15,P.USRNEXT    ADDRESS OF NEXT USER                  01530000
         BZ    DEL_POOL           NOT FOUND ON QUEUE                    01540000
         CR    R2,R7              IUSER FOUND IN QUEUE                  01550000
         BE    DEL_REMV           YES, REMOVE FROM USER QUEUE           01560000
         LR    R1,R2              ADDR OF PREV IUSER                    01570000
         B     DEL_NEXT           TRY NEXT IUSER                        01580000
                                                                        01590000
DEL_REMV DS    0H                                                       01600000
         MVC   P.USRNEXT,USRNEXT  REMOVE FROM QUEUE                     01610000
         C     R7,TSKUSRQ+4       LAST ENTRY IN LIST?                   01620000
         BNE   *+8                NO, CONTINUE                          01630000
         ST    R1,TSKUSRQ+4       RESET LAST IUSER ADDRESS              01640000
                                                                        01650000
DEL_POOL DS    0H                                                       01660000
         STGTERM QH=USRSTG        DELETE IUSER STORAGE POOL             01670000
                                                                        01680000
         STGRETN ADDR=(R7),LEN=USRLENG,QH=TSKSTG                        01690000
         DROP  R7                 IUSER                                 01700000
                                                                        01710000
RETURN   DS    0H                                                       01720000
         XC    PCBUSER,PCBUSER    DISCONNECT USER FROM WORKUNIT         01730000
         LA    R15,RC00           NORMAL COMPLETION                     01740000
                                                                        01750000
         #EXIT ,                  RETURN                                01760000
                                                                        01770000
         EJECT ,                                                        01780000
****************************************************************        01790000
*                                                                       01800000
*  LITERAL, CONSTANTS  AND MAPPINGS                                     01810000
*                                                                       01820000
****************************************************************        01830000
                                                                        01840000
         LTORG ,                  LITERALS                              01850000
                                                                        01860000
         PRINT NOGEN                                                    01870000
         ICVT  ,                                                        01880000
         ITASK ,                                                        01890000
         IPCB  ,                                                        01900000
         IUSER ,                                                        01910000
         PRINT GEN                                                      01920000
                                                                        01930000
         END   ,                                                        01940000

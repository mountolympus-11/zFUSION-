ITIMNT   TITLE '- TABLE INTERFACE MULTI-ROW UPDATE'                     00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: ITIMNT - TABLE INTERFACE - MULTI-ROW UPDATE                  00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THIS ROUTINE IS USED TO PERFORM MULTI-ROW ADD, MODIFY,             00080000
*    AND DELETE REQUESTS AGAINST A TABLE OPENED AND MANAGED             00090000
*    BY A COOPERATIVE PROCESS.  THE REQUEST BLOCK CONTAINS              00100000
*    AN UPDATE FUNCTION, A ROW COUNT, AND THE COMPLETE SOURCE           00110000
*    ROW IMAGE FOR EACH ROW.                                            00120000
*                                                                       00130000
*    COLUMNS DEFINED AS VARDATA MUST CONTAIN AN OFFSET TO THE           00140000
*    VARIABLE LENGTH DATA STRING, WITH THE ROW ORIGIN SERVING           00150000
*    AS THE REFERENCE POINT.                                            00160000
*                                                                       00170000
*    EACH ROW PROVIDED IN THE REQUEST BLOCK IS PREPENDED BY             00180000
*    A DESCRIPTOR THAT INCLUDES THE TOTAL ROW LENGTH.  THAT             00190000
*    VALUE IS VERIFIED AGAINST THE SIZE OF THE BASE ROW AND             00200000
*    ALL ASSOCIATED VARDATA AREAS.                                      00210000
*                                                                       00220000
*    THE MULTI-ROW REQUEST IS PROCESSED IN PASSSED ROW ORDER.           00230000
*    IF THE INDICATED TABLE SERVICE REQUEST FAILS FOR ANY               00240000
*    ROW, THE REQUEST IS TERMINATED AND THE SUBSEQUENT ROWS             00250000
*    ARE NOT EXAMINED.                                                  00260000
*                                                                       00270000
*                                                                       00280000
* ON ENTRY:                                                             00290000
*                                                                       00300000
*    R1  POINTS TO A PARAMETER LIST DESCRIBED BY THE @TIMNT             00310000
*        MAPPING                                                        00320000
*                                                                       00330000
*    R0  CONTAINS THE ADDRESS OF A WORKAREA NO SMALLER THAN             00340000
*        THE LENGTH SPECIFIED BY LENGTH= OPERAND ON THE                 00350000
*        #WORK MACRO.                                                   00360000
*                                                                       00370000
* ON EXIT:                                                              00380000
*                                                                       00390000
*    A RESPONSE BLOCK IS CONSTRUCTED TO CONVEY THE RESULTS OF           00400000
*    THE MULTI-ROW UPDATE REQUEST.  WHEN THE RETURN CODES IS            00410000
*    NON-ZERO, THE RESPONSE STRING APPENDED TO THE RESPONSE             00420000
*    HEADER AND ADDRESSED VIA TMRSDATA, TMRSDATL CONTAINS A             00430000
*    SUITABLE ERROR MESSAGE.                                            00440000
*                                                                       00450000
*    THE RESPONSE AREA WILL CONTAIN ONE OF THE FOLLOW RETURN            00460000
*    AND REASON CODE PAIR.  THESE ARE ALSO REFLECTED TO THE             00470000
*    CALLER VIA R15 AND R0.  R1 CONTAINS A TABLE SERVICES               00480000
*    DIAGNOSTIC IN THE COMMON ERROR SITUATIONS.                         00490000
*                                                                       00500000
*       RC00 - REQUEST COMPLETED WITHOUT ERROR                          00510000
*                                                                       00520000
*       RC04 - INSUFFICIENT RESPONSE BUFFER ALLOCATION                  00530000
*                                                                       00540000
*       RC08 - TABLE SERVICES RETURNED AN ERROR STATUS WHEN             00550000
*              PRESENTED WITH ONE OF THE SOURCE (INPUT) ROWS.           00560000
*                                                                       00570000
*              TMRSEROW - ROW NUMBER WITH 1 <= NN <=TIMNTCNT            00580000
*              SUPER    - 16 BIT TBSERV RSN / 16 BIT TBSERV RC          00590000
*              INFO     - TABLE SERVICES DIAGNOSTIC INFO                00600000
*                                                                       00610000
*       RC12 - REQUEST IN ERROR, REASON CODE IN TMRSRSN                 00620000
*                                                                       00630000
*              RSN04 - INVALID TABLE TOKEN                              00640000
*              RSN08 - INVALID REQUEST                                  00650000
*              RSN12 - INVALID ROW ENTRY, ROW # IN TMRSEROW             00660000
*                                                                       00670000
*       RC20 - RESPONSE SERVICE FAILURE                                 00680000
*                                                                       00690000
**<DOC-OFF>****************************************************         00700000
                                                                        00710000
         EJECT ,                                                        00720000
***************************************************************         00730000
*                                                                       00740000
* MAINTENANCE:                                                          00750000
*                                                                       00760000
*   08/XX/92  R. TURGEON                                                00770000
*             INITIAL VERSION                                           00780000
*                                                                       00790000
*   08/05/93  RON COLMONE                                               00800000
*             CONVERTED TO STDENV                                       00810000
*                                                                       00820000
*   12/06/94  R. TURGEON                                                00830000
*             REMOVED PAGE= / SHRPAGE= FOR $SPACE, $OBJECT,             00840000
*             AND TB* SERVICE REQUESTS                                  00850000
*                                                                       00860000
***************************************************************         00870000
                                                                        00880000
         EJECT ,                                                        00890000
         #WORK ,                                                        00900000
ROWCURR  DS    F             CURRENT ROW ENTRY (1-TIMNTCNT)             00910000
ROWORG   DS    A             CURRENT ROW ORIGIN                         00920000
ROWEND   DS    A             CURRENT ROW END                            00930000
                                                                        00940000
TABLTOKN DS    F             TABLE TOKEN                                00950000
INDEX    DS    A             INDEX NAME PTR OR ZERO                     00960000
                                                                        00970000
ERRINFO  DS    0F            R14-R1 UPON SERVICE ROUTINE FAILURE        00980000
ERR_R14  DS    F                                                        00990000
ERR_R15  DS    F                                                        01000000
ERR_R0   DS    F                                                        01010000
ERR_R1   DS    F                                                        01020000
                                                                        01030000
RETC     DS    F             RETURN CODE                                01040000
RSNC     DS    F             REASON CODE                                01050000
DIAGNOSE DS    F             DIAGNOSTICS                                01060000
SUPER    DS    F             SUPER CODE                                 01070000
MSGA     DS    A             MSG ADDRESS                                01080000
MSGLN    DS    F             MSG LENGTH                                 01090000
                                                                        01100000
@TMRESP  DS    A             ADDR OF RESPONSE HEADER                    01110000
#RESPHDR DS    0F,XL(TMRESPLN)                                          01120000
                                                                        01130000
         #ENDWORK ,          END OF WORKAREA                            01140000
                                                                        01150000
         EJECT ,                                                        01160000
         @TIMNT ,            REQUEST BLOCK FORMAT                       01170000
                                                                        01180000
         EJECT ,                                                        01190000
         TIBLOCK ,           TABLE INTERFACE BLOCK          (TIB)       01200000
                                                                        01210000
         EJECT ,                                                        01220000
         @TBFMT ,            DESCRIBE RESULT AREA                       01230000
                                                                        01240000
         EJECT ,                                                        01250000
         @TBCOLDF ,          COLUMN DEFINITION FORMAT                   01260000
                                                                        01270000
         EJECT ,                                                        01280000
         TMRESP  ,           RESPONSE HEADER                            01290000
                                                                        01300000
         EJECT ,                                                        01310000
         REQHDR  ,           REQUEST  HEADER                            01320000
                                                                        01330000
         EJECT ,                                                        01340000
         TBSERVIS ADD,MOD,DELETE                                        01350000
                                                                        01360000
         EJECT ,                                                        01370000
         EQUS  ,             GENERAL EQUATES                            01380000
                                                                        01390000
         EJECT ,                                                        01400000
ITIMNT   #ENTER BASE=R12,WAPASS=YES,PREG=R8                             01410000
                                                                        01420000
         USING TIMNT,R8           LIFE OF FUNCTION                      01430000
                                                                        01440000
         USING ITASK,R10          ITASK ADDRESSABILITY                  01450000
         L     R9,TSKPCBC         ADDRESS OF CURRENT PCB                01460000
         USING IPCB,R9            IPCB  ADDRESSABILITY                  01470000
                                                                        01480000
*--------------------------------------------------------------         01490000
*  GENERAL INITIALIZATION                                               01500000
*--------------------------------------------------------------         01510000
         L     R7,PCBUSER         ADDRESS OF IUSER                      01520000
         USING IUSER,R7           TEMP ADDRESSABILITY                   01530000
         L     R7,USRPROJ         PROJECT CONTROL AREA                  01540000
         USING IPROJ,R7           LIFE OF FUNCTION                      01550000
                                                                        01560000
         LA    R2,#RESPHDR        RESPONSE HEADER CONSTRUCTION          01570000
         ST    R2,@TMRESP         BUILD LOCAL COPY                      01580000
                                                                        01590000
         $XPBUFR ISRT,            ADDRESS RESPONSE HEADER TO BUFFER    +01600000
               NEWFUNC=(TBSV,TI$MAINT),                                +01610000
               DATA=(R2),                                              +01620000
               DATALEN=TMRESPLN,                                       +01630000
               MF=(E,MFE_LIST)                                          01640000
         LTR   R15,R15                                                  01650000
         BNZ   ERR_ITXP                                                 01660000
         ST    R1,@TMRESP         REFRESH RESPONSE HDR PTR              01670000
                                                                        01680000
         EJECT ,                                                        01690000
***************************************************************         01700000
*                                                                       01710000
*   GENERAL INITIALIZATION AND REQUEST VALIDATION                       01720000
*                                                                       01730000
***************************************************************         01740000
         MVC   TABLTOKN,TIMNTKN   PRESERVE COPY OF TABLE TOKEN          01750000
         LA    R1,TABLTOKN        R1 <== TABLE TOKEN ADDR               01760000
         BAS   R14,LOCTIB         TEST WHETHER TABLE ALREADY OPENED     01770000
         LTR   R15,R15            TIB CHAIN SEGMENT RETURNED?           01780000
         BNZ   ENOTIB             ERROR                                 01790000
                                                                        01800000
         LR    R5,R0              MATCHING TIB                          01810000
         USING TIBLOCK,R5         DECHAIN THE TIB FROM LIST             01820000
                                                                        01830000
         LH    R0,TIMNTCNT        NUMBER OF ROWS PROVIDED               01840000
         LTR   R0,R0              VALIDATE ARGUMENT                     01850000
         BNP   EINVREQ            INVALID REQUEST                       01860000
                                                                        01870000
         LA    R1,TIMNTNDX        INDEX NAME AS ARGUMENT                01880000
         TM    TIMNTNDX,BF        INDEX ASSISTED UPDATE REQ?            01890000
         BZ    *+8                SKIP IF NOT                           01900000
         ST    R1,INDEX           CONTAINS PTR OR ZERO                  01910000
                                                                        01920000
         LA    R6,TIMNROW         ADDR OF ROW ENTRY SECTION             01930000
         USING TIMNROW,R6         REPEATING GROUP ADDRESSABILITY        01940000
                                                                        01950000
         EJECT ,                                                        01960000
***************************************************************         01970000
*                                                                       01980000
*   REFORM NEXT ROW FOR TABLE SERVICE                                   01990000
*                                                                       02000000
***************************************************************         02010000
NEXTROW  DS    0H                                                       02020000
         L     R1,ROWCURR         ROW IN PROGRESS                       02030000
         LA    R1,1(,R1)          IDENTIFY CURRENT ROW                  02040000
         ST    R1,ROWCURR         CHECKPOINT ROW POSITION               02050000
         CH    R1,TIMNTCNT        PROCESSED ALL ROWS?                   02060000
         BH    REQ_CPT            DONE IF SO                            02070000
                                                                        02080000
         LA    R15,TIMNROWA       ROW ORIGIN ADDRESS                    02090000
         ST    R15,ROWORG         START OF ROW                          02100000
         AL    R15,TIMNROWL       TOTAL LENGTH OF ROW                   02110000
         ST    R15,ROWEND         END OF ROW                            02120000
                                                                        02130000
         L     R4,TIBDESC         LOCATE THE TABLE INTERFACE BLOCK      02140000
         USING TBFMT,R4           ANCHOR TO TABLE DESCRIPTION           02150000
         LH    R3,TBF#COLS        # OF COLUMN DEFINITIONS               02160000
         L     R4,TBFCOFF         ORIGIN OF COLUMN DEFINITION LIST      02170000
         USING TBCOLDEF,R4        PREPARE FOR COLUMN SCAN               02180000
                                                                        02190000
*--------------------------------------------------------------         02200000
*   INSPECT ALL COLUMNS, VALIDATE ROW LENGTH                            02210000
*--------------------------------------------------------------         02220000
NEXTCOL  DS    0H                                                       02230000
         L     R2,ROWORG          ROW DATA ORIGIN ADDR                  02240000
         AL    R2,TBCDISPL        LOCATE COLUMN ORIGIN                  02250000
         LR    R1,R2              MODIFIABLE COPY                       02260000
         AL    R1,TBCLENG         LOCATE END OF COLUMN                  02270000
         CL    R1,ROWEND          ROW CONTAINED WITHIN STATED BOUNDS?   02280000
         BH    EINVROW            INVALID ROW LENGTH                    02290000
                                                                        02300000
         CLI   TBCDTYPE,$VCHAR    VARDATA - STANDARD FORMATS            02310000
         BE    RVAR                                                     02320000
         CLI   TBCDTYPE,$VBIN                                           02330000
         BE    RVAR                                                     02340000
                                                                        02350000
         CLI   TBCDTYPE,$VCHARX   VARDATA - EXTENDED FORMATS            02360000
         BE    RXVAR                                                    02370000
         CLI   TBCDTYPE,$VBINX                                          02380000
         BE    RXVAR                                                    02390000
         B     ADVCOL                                                   02400000
                                                                        02410000
*------- RELOCATE STANDARD VARDATA FORMATS --------------------         02420000
                                                                        02430000
RVAR     DS    0H                 STANDARD VARDATA FORMATS              02440000
         ICM   R15,15,0(R2)       DATA PRESENT?                         02450000
         BZ    ADVCOL             NO RELOCATION NEEDED IF NOT           02460000
         AL    R15,ROWORG         LOCATE VARDATA STRING ORIGIN          02470000
         STCM  R15,15,0(R2)       REPLACE OFFSET WITH PTR               02480000
         CL    R15,ROWEND         ROW CONTAINED WITHIN STATED BOUNDS?   02490000
         BNL   EINVROW            INVALID ROW LENGTH                    02500000
         AH    R15,0(,R15)        ACCOUNT FOR VARDATA LENGTH            02510000
         LA    R15,2(,R15)        AND LENGTH OF HEADER                  02520000
         CL    R15,ROWEND         ROW CONTAINED WITHIN STATED BOUNDS?   02530000
         BH    EINVROW            INVALID ROW LENGTH                    02540000
         B     ADVCOL             PROCESS ALL COLUMNS                   02550000
                                                                        02560000
*------- RELOCATE EXTENDED VARDATA FORMATS --------------------         02570000
                                                                        02580000
RXVAR    DS    0H                                                       02590000
         ICM   R14,15,0(R2)       DATA PRESENT?                         02600000
         BZ    ADVCOL             NO RELOCATION NEEDED IF NOT           02610000
         ICM   R15,15,4(R2)       DATA PRESENT?                         02620000
         BZ    ADVCOL             NO RELOCATION NEEDED IF NOT           02630000
         AL    R15,ROWORG         LOCATE VARDATA STRING ORIGIN          02640000
         STCM  R15,15,4(R2)       REPLACE OFFSET WITH PTR               02650000
         AR    R15,R14            LOCATE END OF STRING                  02660000
         CL    R15,ROWEND         ROW CONTAINED WITHIN STATED BOUNDS?   02670000
         BH    EINVROW            INVALID ROW LENGTH                    02680000
                                                                        02690000
*------- PROCESS ALL COLUMNS OF CURRENT ROW -------------------         02700000
                                                                        02710000
ADVCOL   DS    0H                                                       02720000
         LA    R4,TBCOLEND        ADVANCE TO NEXT COLUMN DEFINITION     02730000
         BCT   R3,NEXTCOL         AND PERFORM ROW RELOCATION            02740000
         DROP  R4                 TBCOLDEF                              02750000
                                                                        02760000
         EJECT ,                                                        02770000
***************************************************************         02780000
*                                                                       02790000
*   INVOKE THE DESIGNATED TABLE SERVICE                                 02800000
*                                                                       02810000
***************************************************************         02820000
         SR    R2,R2              PREPARE FOR INSERT                    02830000
         IC    R2,TIMNTREQ        FETCH TABLE SERV REQUEST CODE         02840000
         BCTR  R2,0               ZERO RELATIVE                         02850000
         SLL   R2,2               PREPARE FOR WATERFALL                 02860000
         B     *+4(R2)            SELECT TABLE SERV FUNCTION            02870000
         B     ADD_TAB               TBADD                              02880000
         B     MOD_TAB               TBMOD                              02890000
         B     DEL_TAB               TBDELETE                           02900000
                                                                        02910000
*------- TBADD ------------------------------------------------         02920000
                                                                        02930000
ADD_TAB  DS    0H                                                       02940000
         TBADD *ROWORG,                                                X02950000
               INDEX=*INDEX,                                           X02960000
               TTOKEN=TABLTOKN,                                        X02970000
               MF=(E,MFE_LIST)                                          02980000
         B     RC_TEST                                                  02990000
                                                                        03000000
                                                                        03010000
*------- TBMOD ------------------------------------------------         03020000
                                                                        03030000
MOD_TAB  DS    0H                                                       03040000
         TBMOD *ROWORG,                                                X03050000
               INDEX=*INDEX,                                           X03060000
               TTOKEN=TABLTOKN,                                        X03070000
               MF=(E,MFE_LIST)                                          03080000
         B     RC_TEST                                                  03090000
                                                                        03100000
                                                                        03110000
*------- TBDELETE ---------------------------------------------         03120000
                                                                        03130000
DEL_TAB  DS    0H                                                       03140000
         TBDELETE KEYROW=*ROWORG,                                      X03150000
               INDEX=*INDEX,                                           X03160000
               TTOKEN=TABLTOKN,                                        X03170000
               MF=(E,MFE_LIST)                                          03180000
         B     RC_TEST                                                  03190000
                                                                        03200000
                                                                        03210000
*--------------------------------------------------------------         03220000
*   CONTINUE IF REQUEST SUCCEEDS, ABORT THE SEQUENCE OTHERWISE          03230000
*--------------------------------------------------------------         03240000
RC_TEST  DS    0H                                                       03250000
         STM   R14,R1,ERRINFO     PESIMISTIC APPROACH                   03260000
         LTR   R15,R15            REQUEST FAILED OUTRIGHT?              03270000
         BNZ   ETBSRV             ABORT IF SO                           03280000
                                                                        03290000
         @CALL IMNTCTLG,(TIBTABL),  UPDATE MAINTENANCE FLAG            +03300000
               CTYPE=CVT,MF=(E,MFE_LIST)                                03310000
                                                                        03320000
         AL    R6,TIMNROWL        ADVANCE TO NEXT ROW                   03330000
         LA    R6,TIMNRL(,R6)     ACCOUNT FOR ROW HEADER                03340000
         B     NEXTROW            PROCESS ALL ROWS                      03350000
         DROP  R6                 TIMNROW                               03360000
                                                                        03370000
         EJECT ,                                                        03380000
***************************************************************         03390000
*                                                                       03400000
*   POST COMPLETION CODES                                               03410000
*                                                                       03420000
***************************************************************         03430000
REQ_CPT  DS    0H                                                       03440000
         LA    R15,RC00           REQUEST COMPLETE                      03450000
         SR    R0,R0                                                    03460000
         SR    R1,R1                                                    03470000
         SR    R2,R2              NO MSG RETURNED                       03480000
         SR    R3,R3              NO MSG RETURNED                       03490000
         B     RESPOND                                                  03500000
                                                                        03510000
ETBSRV   DS    0H                 TABLE SERVICES ERROR                  03520000
         L     R14,ERR_R0         TABLE SERVICE REASON CODE             03530000
         SLL   R14,16             SHIFT TO UPPER HALFWORD               03540000
         O     R14,ERR_R15        INSERT RETURN CODE                    03550000
         ST    R14,SUPER          SAVE AS SUPER CODE                    03560000
                                                                        03570000
         LA    R15,RC08           ALL ROWS NOT PROCESSED                03580000
         LA    R0,RSN00           NO REASON CODES DEFINED               03590000
         L     R1,ERR_R1          DIAGNOSTICS FROM SERVICE ROUTINE      03600000
         LA    R2,MSGTBSRV                                              03610000
         LA    R3,L'MSGTBSRV                                            03620000
         B     RESPOND                                                  03630000
                                                                        03640000
ENOTIB   DS    0H                 TIB NOT MATCHED                       03650000
         LA    R15,RC12           FAIL THE REQUEST                      03660000
         LA    R0,RSN04           POSSIBLE INVALID TABLE TOKEN          03670000
         SR    R1,R1                                                    03680000
         LA    R2,MSGNOTIB                                              03690000
         LA    R3,L'MSGNOTIB                                            03700000
         B     RESPOND                                                  03710000
                                                                        03720000
EINVREQ  DS    0H                 INVALID REQUEST FORMAT                03730000
         LA    R15,RC12           FAIL THE REQUEST                      03740000
         LA    R0,RSN08                                                 03750000
         SR    R1,R1                                                    03760000
         LA    R2,MSGERREQ                                              03770000
         LA    R3,L'MSGERREQ                                            03780000
         B     RESPOND                                                  03790000
                                                                        03800000
EINVROW  DS    0H                 INVALID ROW ENTRY ENCOUNTERED         03810000
         LA    R15,RC12                                                 03820000
         LA    R0,RSN12                                                 03830000
         L     R1,ROWCURR         ROW NUMBER                            03840000
         LA    R2,MSGERROW                                              03850000
         LA    R3,L'MSGERROW                                            03860000
         B     RESPOND                                                  03870000
                                                                        03880000
         EJECT ,                                                        03890000
***************************************************************         03900000
*                                                                       03910000
*   RETURN COMPLETION STATUS TO COOPERATIVE PROCESS                     03920000
*                                                                       03930000
***************************************************************         03940000
RESPOND  DS    0H                                                       03950000
         L     R6,@TMRESP         LOCATE RESPONSE HEADER                03960000
         USING TMRESP,R6          RESIDES IN RESPONSE BUFFER            03970000
         MVC   TMRSTTKN,TABLTOKN  TABLE TOKEN                           03980000
         MVC   TMRSUPRC,SUPER     SUPER CODE, IF APPLICABLE             03990000
         ST    R15,TMRSRC         R15 - R1                              04000000
         ST    R0,TMRSRSN                                               04010000
         ST    R1,TMRSINFO                                              04020000
                                                                        04030000
         LTR   R3,R3              MESSAGE PROVIDED FOR RETURN?          04040000
         BZ    EXIT               DONE IF NOT                           04050000
                                                                        04060000
         $XPBUFR ISRT,            ADD MESSAGE TO BUFFER                +04070000
               DATA=(R2),                                              +04080000
               DATALEN=(R3),                                           +04090000
               MF=(E,MFE_LIST)                                          04100000
                                                                        04110000
         LTR   R15,R15                                                  04120000
         BNZ   ERR_ITXP                                                 04130000
         STH   R3,TMRSDATL        POST MSG LENGTH IN RESPONSE HDR       04140000
         B     EXIT               DONE                                  04150000
                                                                        04160000
         EJECT ,                                                        04170000
***************************************************************         04180000
*                                                                       04190000
*   ERRORS USUALLY PRECLUDING RESPONSE TO COOPERATIVE PROCESS           04200000
*                                                                       04210000
***************************************************************         04220000
ERR_ITXP DS    0H                                                       04230000
         LR    R1,R15             TXP SERVICE RETURN CODE               04240000
         LA    R15,RC04           ASSUME OUT-OF-SPACE                   04250000
         CR    R1,R15             CORRECT?                              04260000
         BE    *+8                TERMINATE WITH WARNING                04270000
         LA    R15,RC20           ELSE MORE SERIOUS PROBLEM             04280000
                                                                        04290000
         L     R6,@TMRESP         LOCATE RESPONSE HEADER                04300000
         USING TMRESP,R6          RESIDES IN RESPONSE BUFFER            04310000
         ST    R15,TMRSUPRC       LOCAL RETCODE                         04320000
         ST    R0,TMRSRSN         TXP REASON                            04330000
         ST    R1,TMRSINFO        TXP RETCODE                           04340000
         B     EXIT                                                     04350000
                                                                        04360000
         EJECT ,                                                        04370000
***************************************************************         04380000
*                                                                       04390000
*   RETURN TO CALLER                                                    04400000
*                                                                       04410000
***************************************************************         04420000
EXIT     DS    0H                                                       04430000
         L     R15,TMRSRC         RETURN CODE                           04440000
         L     R0,TMRSRSN         REASON CODE                           04450000
         L     R1,TMRSINFO        INFO / DIAGNOSTIC CODE                04460000
                                                                        04470000
         #EXIT ,                  RETURN                                04480000
         DROP  R6                 TMRESP                                04490000
                                                                        04500000
         EJECT ,                                                        04510000
***************************************************************         04520000
*                                                                       04530000
* ROUTINE: LOCTIB - LOCATE TIB BY TABLE TOKEN                           04540000
*                                                                       04550000
* ON ENTRY:                                                             04560000
*                                                                       04570000
*    R1  - ADDRESS OF TABLE TOKEN                                       04580000
*                                                                       04590000
* ON EXIT:                                                              04600000
*                                                                       04610000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES                     04620000
*                                                                       04630000
*        RC00 - TIB LOCATED                                             04640000
*                                                                       04650000
*               R0 - MATCHING TIB                                       04660000
*               R1 - PREDECESSOR OF MATCHING TIB ON CHAIN               04670000
*                                                                       04680000
*        RC04 - NO CORRESPONDING TIB FOUND                              04690000
*                                                                       04700000
***************************************************************         04710000
LOCTIB   DS    0H                                                       04720000
         BAKR  R14,0              PRESERVE MAINLINE ENVIRONMENT         04730000
                                                                        04740000
         L     R2,PCBUSER         ADDRESS OF IUSER BLOCK                04750000
         USING IUSER,R2           ADDRESSABILITY                        04760000
                                                                        04770000
         LA    R15,RC04           ASSUME TABLE IS NOT ACTIVE            04780000
         LA    R5,USRTIBS-(TIBNEXT-TIBLOCK)                             04790000
         USING TIBLOCK,R5         PREPARE FOR TIB TRAVERSAL             04800000
                                                                        04810000
LTIBNXT  DS    0H                                                       04820000
         LR    R6,R5              SAVE BACKLINK PTR                     04830000
         ICM   R5,15,TIBNEXT      ADVANCE TO NEXT TIB                   04840000
         BZ    LTIBEXIT           END OF CHAIN                          04850000
         CLC   TIBTOKN,0(R1)      MATCHING TABLE TOKEN?                 04860000
         BNE   LTIBNXT            CONTINUE SCAN IF NOT                  04870000
                                                                        04880000
         LA    R0,TIBLOCK         MATCHING TIB                          04890000
         LR    R1,R6              LIST PREDECESSOR TIB                  04900000
         LA    R15,RC00           INDICATE SUCCESS                      04910000
                                                                        04920000
LTIBEXIT NOP   0                  RETURN                                04930000
         PR    ,                                                        04940000
         DROP  R2,R5              IUSER, TIB                            04950000
                                                                        04960000
         EJECT ,                                                        04970000
***************************************************************         04980000
*                                                                       04990000
*   LOCAL READ ONLY STORAGE                                             05000000
*                                                                       05010000
***************************************************************         05020000
MSGNOTIB DC    C'INVALID TABLE REFERENCE'                               05030000
MSGTBSRV DC    C'TABLE SERVICES REQUEST DID NOT COMPLETE'               05040000
MSGERREQ DC    C'INVALID REQUEST BLOCK RECEIVED'                        05050000
MSGERROW DC    C'IMPROPERLY STRUCTURED ROW ENTRY PROVIDED'              05060000
                                                                        05070000
         LTORG ,                                                        05080000
                                                                        05090000
         PRINT NOGEN                                                    05100000
         ICVT  ,                                                        05110000
         ITASK ,                                                        05120000
         IPCB  ,                                                        05130000
         IUSER ,                                                        05140000
         IPROJ ,                                                        05150000
         PRINT GEN                                                      05160000
                                                                        05170000
         END   ,                                                        05180000

IL62USUC TITLE 'INTEGRATOR - IVUSER LU6.2 STOP USER CHECK'              00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C SERVICES             00040000
         L62INCL ,                INTEGRATOR LU6.2 SERVICES             00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: IL62USUC - IVUSER LU6.2 STOP USER CHECK                      00100000
*                                                                       00110000
* DESCRIPTION: THIS ROUTINE IS CALLED AT APPROPRIATE TIMES (END OF      00120000
*              SESSION, END OF A SESSION REQUEST, KILL OF A REMOTELY    00130000
*              INITIATED SESSION, ETC.) TO SEE IF THE IVUSER SHOULD     00140000
*              BE ENDED.                                                00150000
*                                                                       00160000
* ON ENTRY:                                                             00170000
*                                                                       00180000
*    R15 = ENTRY POINT ADDRESS                                          00190000
*    R14 = RETURN ADDRESS                                               00200000
*    R13 = AVAILABLE SAVE AREA                                          00210000
*    R11 = ICVT ADDRESS                                                 00220000
*    R10 = ITASK ADDRESS                                                00230000
*    R09 = IVTAMCVT ADDRESS                                             00240000
*    R08 = IVUSER ADDRESS                                               00250000
*                                                                       00260000
* ON EXIT:                                                              00270000
*                                                                       00280000
*    R15 = 0                                                            00290000
*    R00 = 0                                                            00300000
*    R01 = 0                                                            00310000
*                                                                       00320000
*    ALL OTHER REGISTERS ARE RESTORED.                                  00330000
*                                                                       00340000
**<DOC-OFF>************************************************************ 00350000
                                                                        00360000
         EJECT ,                                                        00370000
*********************************************************************** 00380000
*                                                                       00390000
* MAINTENANCE:                                                          00400000
*                                                                       00410000
*   07/01/94 RANDY WITEK                                                00420000
*                                                                       00430000
*********************************************************************** 00440000
                                                                        00450000
         EQUS  ,                  GENERAL EQUATES                       00460000
                                                                        00470000
RICVT    EQU   R11                                                      00480000
RITASK   EQU   R10                                                      00490000
RIVTAM   EQU   R9                                                       00500000
RIVUSER  EQU   R8                                                       00510000
RAQE     EQU   R7                                                       00520000
RMDE     EQU   R6                                                       00530000
                                                                        00540000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00550000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00560000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00570000
         USING IVUSER,RIVUSER     ESTABLISH ADDRESSABILITY              00580000
         USING AQE,RAQE           ESTABLISH ADDRESSABILITY              00590000
         USING MDE,RMDE           ESTABLISH ADDRESSABILITY              00600000
                                                                        00610000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00620000
WRK256   DS    XL256              GENERAL WORKAREA                      00630000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00640000
RETR15   DS    F                                                        00650000
RETR0    DS    F                                                        00660000
RETR1    DS    F                                                        00670000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00680000
FLAG     DS    X                                                        00690000
FLAGLOCK EQU   X'80'                                                    00700000
FLAGLCKD EQU   X'40'                                                    00710000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00720000
                                                                        00730000
         $MSGDFT PREFIX=ICTPID,                                        +00740000
               COMPID='L62',                                           +00750000
               TABLE=*#MSGS,                                           +00760000
               WORKA=0,                                                +00770000
               MF=(E,WRK256),                                          +00780000
               PRINT=NOGEN                                              00790000
                                                                        00800000
IL62USUC #ENTER BASE=R12,         ENTRY LINKAGE                        +00810000
               PREG=R3,                                                +00820000
               AMODE=31,                                               +00830000
               RMODE=ANY                                                00840000
                                                                        00850000
         BAS   R14,VTAMLOCK                                             00860000
                                                                        00870000
*---------------------------------------------------------------------- 00880000
* IF THERE ARE NO ACTIVE SESSIONS...GO CHECK THE AQE'S                  00890000
*---------------------------------------------------------------------- 00900000
                                                                        00910000
         OC    IVU#SESS,IVU#SESS  ANY SESSIONS?                         00920000
         BZ    AQECHECK           BRANCH IF NOT                         00930000
                                                                        00940000
*---------------------------------------------------------------------- 00950000
* IF ALL MODES ARE CLOSING...CHECK IF SNASVCMG IS THE ONLY ACTIVE MODE  00960000
*---------------------------------------------------------------------- 00970000
                                                                        00980000
         TM    IVUF1,IVUF1CAM     CLOSE ALL MODES?                      00990000
         BNO   RETURN             EXIT IF NOT                           01000000
                                                                        01010000
         SR    R2,R2              SNASVCMG MDE ADDRESS                  01020000
         LA    RMDE,IVUMD1ST      GET SET TO RUN MODE_LIST              01030000
         S     RMDE,=A(MDENEXT-MDE)                                     01040000
                                                                        01050000
ACTCHECK DS    0H                                                       01060000
                                                                        01070000
         ICM   RMDE,15,MDENEXT    LINK TO THE NEXT MDE                  01080000
         BM    NOACTIVE           BRANCH IF END, NO ACTIVE SESSIONS     01090000
         CLC   MDENAME,=CL8'SNASVCMG'                                   01100000
         BE    SAVSVCMG           DON'T CHECK THESE SESSIONS            01110000
         L     R1,MDEASC          ACTIVE SESSIONS                       01120000
         A     R1,MDEPSC          + PENDING SESSIONS                    01130000
         BP    RETURN             JUST EXIT IF THERE'S AN ACTIVE MODE   01140000
         B     ACTCHECK           RUN ALL THE MODES                     01150000
                                                                        01160000
SAVSVCMG DS    0H                                                       01170000
                                                                        01180000
         LR    R2,RMDE            SAVE THE SNASVCMG MDE ADDRESS         01190000
         B     ACTCHECK           RUN ALL THE MODES                     01200000
                                                                        01210000
NOACTIVE DS    0H                                                       01220000
                                                                        01230000
         LTR   RMDE,R2            DID WE FIND SNASVCMG?                 01240000
         BZ    RETURN             EXIT IF NOT                           01250000
         L     R1,MDEASC          ACTIVE SESSIONS                       01260000
         A     R1,MDEPSC          + PENDING SESSIONS                    01270000
         ST    R1,MDETERMC        SET TERMINATION COUNT                 01280000
         XC    MDESESSL,MDESESSL  SESSION_LIMIT=0                       01290000
         XC    MDEMINCW,MDEMINCW  MIN_CONWINNERS=0                      01300000
         XC    MDEMINCL,MDEMINCL  MIN_CONLOSER=0                        01310000
         OI    MDEF1,MDEF1STO     TP'S ARE STOPPED                      01320000
         LR    R1,RMDE            PASS MDE IN R1                        01330000
         L     R15,IL6@UDFS       DEACTIVATE FREE SESSIONS              01340000
         BASR  R14,R15            START THE DEACTIVATION                01350000
         B     RETURN             AND EXIT                              01360000
                                                                        01370000
*---------------------------------------------------------------------- 01380000
* IF THERE ARE ACTIVE AQE'S DON'T END THE IVUSER                        01390000
*---------------------------------------------------------------------- 01400000
                                                                        01410000
AQECHECK DS    0H                                                       01420000
                                                                        01430000
         LA    RMDE,IVUMD1ST      GET SET TO RUN MODE_LIST              01440000
         S     RMDE,=A(MDENEXT-MDE)                                     01450000
                                                                        01460000
MDERUN   DS    0H                                                       01470000
                                                                        01480000
         ICM   RMDE,15,MDENEXT    LINK TO THE NEXT MDE                  01490000
         BM    ENDUSER            BRANCH IF END, NO AQE'S WERE FOUND    01500000
         ICM   RAQE,15,MDEWR1ST   IS THERE AN AQE?                      01510000
         BM    MDERUN             BRANCH IF NOT, CHECK ALL MDE'S        01520000
         B     RETURN             AQE WAS FOUND, CAN'T END USER NOW     01530000
                                                                        01540000
*---------------------------------------------------------------------- 01550000
* QUEUE STOP USER WORK ELEMENT TO END THE IVUSER                        01560000
*---------------------------------------------------------------------- 01570000
                                                                        01580000
ENDUSER  DS    0H                                                       01590000
                                                                        01600000
         $VTAMWE L'IWEXI,                                              +01610000
               IWECSTPU           ALLOCATE "STOP USER" WORK ELEMENT     01620000
                                                                        01630000
         LA    R0,IVUWEQ          WORK QUEUE ADDRESS                    01640000
         BAS   R14,QWE            QUEUE STOP WORK ELEMENT TO IVUSER     01650000
         B     RETURN             AND EXIT                              01660000
                                                                        01670000
*---------------------------------------------------------------------- 01680000
* RETURN TO CALLER                                                      01690000
*---------------------------------------------------------------------- 01700000
                                                                        01710000
RETURN   DS    0H                                                       01720000
                                                                        01730000
         BAS   R14,VTAMUNLK                                             01740000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 01750000
                                                                        01760000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    01770000
                                                                        01780000
*---------------------------------------------------------------------- 01790000
* SUBROUTINE QWE - QUEUE A WORK ELEMENT TO A GIVEN WORK QUEUE           01800000
*                                                                       01810000
* ENTRY            R14 = RETURN ADDRESS                                 01820000
*                  R1  = WORK ELEMENT ADDRESS                           01830000
*                  R0  = QUEUE ADDRESS                                  01840000
*                                                                       01850000
* RETURNS          R15 = 0 --> QUEUEING WAS SUCCESSFUL                  01860000
*                      = 4 --> QUEUEING FAILED, WORK ELEMENT RELEASED   01870000
*---------------------------------------------------------------------- 01880000
                                                                        01890000
QWE      DS    0H                                                       01900000
                                                                        01910000
         STM   R14,R4,SUB0SAVE    SAVE REGISTERS                        01920000
         LR    R3,R0              SAVE QUEUE ADDRESS                    01930000
         LR    R4,R1              SAVE WORK ELEMENT ADDRESS             01940000
                                                                        01950000
         $VTAMQ (R4),             WORK ELEMENT                         +01960000
               (R3)               QUEUE                                 01970000
                                                                        01980000
         L     R14,SUB0SAVE       RESTORE REGISTERS                     01990000
         LM    R0,R4,SUB0SAVE+8   RESTORE REGISTERS                     02000000
         BR    R14                AND RETURN TO CALLER W/R15            02010000
                                                                        02020000
*---------------------------------------------------------------------- 02030000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 02040000
*---------------------------------------------------------------------- 02050000
                                                                        02060000
VTAMLOCK DS    0H                                                       02070000
                                                                        02080000
         TM    FLAG,FLAGLOCK        WAS THE LOCK ALREADY OBTAINED?      02090000
         BOR   R14                  RETURN IF YES                       02100000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             02110000
                                                                        02120000
         $SER  OBTAIN,                                                 +02130000
               VTAM                                                     02140000
                                                                        02150000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              02160000
         BNE   VTAMLOEX             BRANCH IF NOT                       02170000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         02180000
                                                                        02190000
VTAMLOEX DS    0H                                                       02200000
                                                                        02210000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               02220000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          02230000
         BR    R14                  RETURN                              02240000
                                                                        02250000
*---------------------------------------------------------------------- 02260000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                02270000
*---------------------------------------------------------------------- 02280000
                                                                        02290000
VTAMUNLK DS    0H                                                       02300000
                                                                        02310000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       02320000
         BNOR  R14                  BRANCH IF NOT                       02330000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             02340000
         BOR   R14                  DON'T RELEASE IF IT WAS             02350000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             02360000
                                                                        02370000
         $SER  RELEASE,                                                +02380000
               VTAM                                                     02390000
                                                                        02400000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  02410000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          02420000
         BR    R14                  RETURN                              02430000
                                                                        02440000
*---------------------------------------------------------------------- 02450000
* ERROR ROUTINES                                                        02460000
*---------------------------------------------------------------------- 02470000
                                                                        02480000
*---------------------------------------------------------------------- 02490000
*  CONSTANTS AND LITERALS                                               02500000
*---------------------------------------------------------------------- 02510000
                                                                        02520000
         LTORG ,                                                        02530000
         PRINT NOGEN                                                    02540000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                02550000
         ISTDBIND ,               VTAM BIND IMAGE                       02560000
         TRACODES ,               INTEGRATOR TRACE CODES                02570000
         ICVT  ,                  INTEGRATOR CVT                        02580000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   02590000
         IRPL ,                   INTEGRATOR VTAM RPL+                  02600000
         IACB ,                   INTEGRATOR VTAM ACB+                  02610000
         INIB ,                   INTEGRATOR VTAM NIB+                  02620000
         ISESS ,                  INTEGRATOR SESSION BLOCK              02630000
         IRQE ,                   INTEGRATOR RECEIVE QUEUE ELEMENT      02640000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            02650000
         ITASK ,                  INTEGRATOR TASK BLOCK                 02660000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          02670000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       02680000
         EVCODES ,                INTEGRATOR EVENT CODES                02690000
         ABCODES ,                INTEGRATOR $ABEND CODES               02700000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     02710000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        02720000
         IFGEXLST ,               VTAM EXIT LIST                        02730000
         END   ,                                                        02740000

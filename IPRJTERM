IPRJTERM TITLE '- PROJECT/DATABASE TASK TERMINATION'                    00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
*  ROUTINE:  IPRJTASK - PROJECT/DATABASE TASK TERMINATION               00040000
*                                                                       00050000
*  DESCRIPTION:                                                         00060000
*                                                                       00070000
*     This function of this routine is to perform project               00080000
*     task termination.  Appropriate messages are used indicating       00090000
*     that the project task shutdown is complete and that the           00100000
*     database has been closed.                                         00110000
*                                                                       00120000
*  ENTRY:                                                               00130000
*                                                                       00140000
*     Upon entry R1 will contain the address of the request             00150000
*     type.                                                             00160000
*        0 - Normal shutdown request (delete global spaces)             00170000
*        4 - Fast shutdown request (cancel)                             00180000
*                                                                       00190000
*  EXIT:                                                                00200000
*                                                                       00210000
*     Upon completion of this routine R15 will contain                  00220000
*     one of the following return codes:                                00230000
*                                                                       00240000
*        RC00 - Project task termination completed successfully         00250000
*        RC08 - Error occured closing project database                  00260000
*                                                                       00270000
**<DOC-OFF>*****************************************************        00280000
                                                                        00290000
         EJECT ,                                                        00300000
****************************************************************        00310000
*                                                                       00320000
*  MAINTENANCE:                                                         00330000
*                                                                       00340000
*    06/26/93 RON COLMONE                                               00350000
*             INTIAL VERSION. SPLIT CODE OUT OF TASK MAINLINE.          00360000
*                                                                       00370000
*    12/06/94 R. Turgeon                                                00380000
*             Removed PAGE= / SHRPAGE= for $SPACE, $OBJECT,             00390000
*             and TB* service requests                                  00400000
*                                                                       00410000
****************************************************************        00420000
                                                                        00430000
         EJECT ,                                                        00440000
         EQUS  ,                  GENERAL EQUATES                       00450000
                                                                        00460000
         EJECT ,                                                        00470000
         PERAREA ,                PRJSRV ERROR RETURN AREA              00480000
                                                                        00490000
         $MSGDFT PREFIX=ICTPID,COMPID='PRJ',TABLE=*#MSGS,              +00500000
               PRINT=NOGEN,MF=(E,WRK256)                                00510000
                                                                        00520000
         EJECT ,                                                        00530000
*---------------------------------------------------------------        00540000
*  GENERAL WORKAREA                                                     00550000
*---------------------------------------------------------------        00560000
         #WORK ,                                                        00570000
WRK2K    DS    XL2048             GENERAL WORKAREA                      00580000
WRK256   DS    XL256              GENERAL WORKAREA                      00590000
REGSAVE1 DS    16F                REGISTER SAVE AREA                    00600000
                                                                        00610000
CFLAGS   DS    X                  CONTROL FLAGS                         00620000
$FASTSTP EQU   X'80'                 FAST STOP REQUESTED                00630000
                                                                        00640000
RCODES   DS    0F,0F              RETURN/REASON CODE                    00650000
RETCD    DS    F                  RETURN CODE FROM SERVICE              00660000
RSNCD    DS    F                  REASON CODE FROM SERVICE              00670000
                                                                        00680000
PROJERR  DS    XL(PERLEN)         PRJSRV ERROR RETURN AREA              00690000
$DBPL    $DB      MF=L            PLIST AREA FOR DBOC                   00700000
$PRJPL   $PROJECT MF=L            PLIST AREA FOR $PROJECT               00710000
         #ENDWORK ,               END OF WORKAREA                       00720000
                                                                        00730000
         EJECT ,                                                        00740000
****************************************************************        00750000
*                                                                       00760000
*   PERFORM PROJECT TASK TERMINATION ENTRY LINKAGE                      00770000
*                                                                       00780000
****************************************************************        00790000
                                                                        00800000
IPRJTERM #ENTER BASE=R12,         ENTRY LINKAGE                        +00810000
               PREG=R8                                                  00820000
         USING ITASK,R10          ESTABLISH ADDRESSABILITY              00830000
                                                                        00840000
         ICM   R0,15,0(R8)        NORMAL SHUTDOWN REQUEST               00850000
         BZ    *+8                YES, CONTINUE                         00860000
         OI    CFLAGS,$FASTSTP    ELSE INDICATE FAST STOP REQUEST       00870000
                                                                        00880000
         EJECT ,                                                        00890000
****************************************************************        00900000
*                                                                       00910000
*   PROJECT TASK TERMINIATION IN PROGRESS.  IF REQUEST IS FOR           00920000
*   NORMAL SHUTDOWN,  DELETE EXECUTION SPACE AND CLOSE CATALOG          00930000
*   PROJECT.                                                            00940000
*                                                                       00950000
****************************************************************        00960000
         NI    ICTSTAT1,FF-ICT1$PRJ    PROJECT TASK NOT ACTIVE          00970000
         TM    CFLAGS,$FASTSTP    FAST STOP REQUESTED?                  00980000
         BO    CLOSE_DB           YES, CLOSE PROJECT DATABASE           00990000
                                                                        01000000
*--------------------------------------------------------------         01010000
*   DELETE EXECUTION SPACE                                              01020000
*--------------------------------------------------------------         01030000
DEL_EXEC DS    0H                                                       01040000
         ICM   R3,15,ICTXSPT@     ADDR OF EXEC SPACE TOKEN              01050000
         BZ    CLS_CTLG           CLOSE CATALOG                         01060000
         XC    ICTXSPT@,ICTXSPT@  CLEAR EXEC SPACE TOKEN ADDR           01070000
                                                                        01080000
         $SPACE DESTROY,                                               +01090000
               TOKEN=(R3),                                             +01100000
               NAME='INTEXSPC',                                        +01110000
               MF=(E,MFE_LIST)                                          01120000
                                                                        01130000
*--------------------------------------------------------------         01140000
*   CLOSE SYSCATLG PROJECT                                              01150000
*--------------------------------------------------------------         01160000
CLS_CTLG DS    0H                                                       01170000
         ICM   R3,15,ICTSYSP@     ADDR OF SYSCATLG SPACE TOKEN          01180000
         BZ    CLOSE_DB           CLOSE DATABASE                        01190000
         XC    ICTSYSP@,ICTSYSP@  CLEAR CTLG SPACE TOKEN ADDR           01200000
                                                                        01210000
         $PROJECT CLOSE,          CLOSE SYSCATLG PROJECT               +01220000
               NAME='SYSCATLG',                                        +01230000
               TOKEN=(R3),                                             +01240000
               USER='INFOSESS',                                        +01250000
               SOURCE=TSKNAME,                                         +01260000
               WORKA=WRK2K,                                            +01270000
               ERRAREA=PROJERR,                                        +01280000
               MF=(E,$PRJPL)                                            01290000
                                                                        01300000
         LTR   R15,R15            OK ?                                  01310000
         BZ    CLOSE_DB           YES, CLOSE DB                         01320000
                                                                        01330000
         LA    R2,PROJERR         ADDRESS OF PRJSRV ERROR AREA          01340000
         USING PERAREA,R2         ADDRESSABILITY                        01350000
         ICM   R1,B'1111',PERRC   ERROR THERE ?                         01360000
         BZ    CLOSE_DB           CLOSE DB                              01370000
                                                                        01380000
         $MSG  279,               DUMP DETAILS                         +01390000
               FIELDS=(PERSRVC,PERRC,PERSYSRC,PERSYSRS)                 01400000
         XC    PERRC,PERRC        RESET PRJSRV ERROR                    01410000
         DROP  R2                 PERAREA                               01420000
         EJECT ,                                                        01430000
****************************************************************        01440000
*                                                                       01450000
*  CLOSE PROJECT DATABASE                                               01460000
*                                                                       01470000
****************************************************************        01480000
CLOSE_DB DS    0H                                                       01490000
         ICM   R0,15,ICTACBDB     DATABASE ACB AVAILABLE                01500000
         BZ    TERM_OK            NO, RETURN                            01510000
                                                                        01520000
         $MSG  005                CLOSING PROJECT DATABASE              01530000
                                                                        01540000
         $DB   CLOSE,             CLOSE DATABASE                       +01550000
               WORKA=WRK2K,                                            +01560000
               MF=(E,$DBPL)                                             01570000
                                                                        01580000
         LTR   R15,R15            CLOSE SUCCESSFULL?                    01590000
         BZ    TERM_OK            YES, ISSUE TERMINATING MSG            01600000
                                                                        01610000
         STM   R15,R0,RCODES      SAVE RETURN/REASON CODES              01620000
         $MSG  016,FIELDS=(RETCD,RSNCD)                                 01630000
         B     ERR_CLS            ERROR CLOSING PROJECT DATABASE        01640000
                                                                        01650000
TERM_OK  DS    0H                                                       01660000
         $MSG  006                DATABASE TASK TERMINATING             01670000
                                                                        01680000
         LA    R15,RC00           NORMAL COMPLETION                     01690000
         B     RET                RETURN                                01700000
                                                                        01710000
         EJECT ,                                                        01720000
****************************************************************        01730000
*                                                                       01740000
*  ERRORS                                                               01750000
*                                                                       01760000
****************************************************************        01770000
ERR_CLS  DS    0H                                                       01780000
         LA    R15,RC08           ERROR CLOSEING PROJECT DATABASE       01790000
                                                                        01800000
RET      DS    0H                                                       01810000
         #EXIT ,                  RETURN                                01820000
                                                                        01830000
         EJECT ,                                                        01840000
****************************************************************        01850000
*                                                                       01860000
*  LITERALS AND CONSTANTS                                               01870000
*                                                                       01880000
****************************************************************        01890000
                                                                        01900000
         LTORG ,                  LITERAL POOL                          01910000
                                                                        01920000
         EJECT ,                                                        01930000
         PRINT NOGEN                                                    01940000
         ICVT  ,                                                        01950000
         ITASK ,                                                        01960000
         PRINT GEN                                                      01970000
                                                                        01980000
         END   ,                                                        01990000

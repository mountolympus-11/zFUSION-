         TITLE 'IRCVRCVR - $RCVRY PCB ERROR RECOVERY CREATE/DELETE'     00010000
         #WORK ,                  BEGIN WORKAREA                        00020000
         #ENDWORK ,               END WORKAREA                          00030000
                                                                        00040000
         EJECT ,                                                        00050000
         IRCVY ,                  RECOVERY STACK ENTRY                  00060000
         EJECT ,                                                        00070000
         IPCB  ,                  PROCESS                               00080000
         EJECT                                                          00090000
         ABCODES ,                $ABEND CODES                          00100000
         EJECT                                                          00110000
         EQUS  ,                                                        00120000
         EJECT                                                          00130000
                                                                        00140000
**<DOC-ON>*****************************************************         00150000
*                                                                       00160000
* ROUTINE:  IRCVRCVR - $RCVRY PCB ERROR RECOVERY CREATE/DELETE          00170000
*                                                                       00180000
* DESCRIPTION:                                                          00190000
*                                                                       00200000
*    THIS ROUTINE IMPLEMENTS THE $RCVRY SERVICE. IT ALLOWS A            00210000
*    REQUESTOR TO ESTABLISH (CREATE) AND DELETE PROCESS LEVEL           00220000
*    ERROR RECOVERY ROUTINES TOGETHER WITH ASSOCIATED PARMS             00230000
*    AND ENVIRONMENTAL DATA.                                            00240000
*                                                                       00250000
*                                                                       00260000
* ON ENTRY:                                                             00270000
*                                                                       00280000
*    R1  CONTAINS THE ADDRESS OF A PLIST CONSTRUCTD AS FOLLOWS:         00290000
*                                                                       00300000
*        +00 - REQUEST TYPE                                             00310000
*              0 - DELETE                                               00320000
*              4 - CREATE                                               00330000
*        +04 - ERROR RECOVERY ROUTINE EPA                               00340000
*        +08 - ERROR RECOVERY ROUTINE PARAMETER VALUE                   00350000
*                                                                       00360000
*                                                                       00370000
* ON EXIT:                                                              00380000
*                                                                       00390000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES                     00400000
*                                                                       00410000
*        RC00 - RECOVERY ROUTINE CREATED/DELETED                        00420000
*        RC04 - DELETE REQUEST, BUT THE DESIGNATED RECOVERY             00430000
*               ROUTINE WAS NOT FOUND                                   00440000
*        RC08 - RECOVERY ROUTINE NOT PROVIDED ON CREATE REQUEST         00450000
*        RC12 - STORAGE FAILURE, STG SERVICE RETCODE IN R1              00460000
*                                                                       00470000
**<DOC-OFF>****************************************************         00480000
                                                                        00490000
***************************************************************         00500000
*                                                                       00510000
* MAINTENANCE:                                                          00520000
*                                                                       00530000
*    04/23/93 R. TURGEON                                                00540000
*             INITIAL VERSION                                           00550000
*                                                                       00560000
***************************************************************         00570000
                                                                        00580000
         EJECT ,                                                        00590000
IRCVRCVR #ENTER PREG=R8                                                 00600000
                                                                        00610000
         USING ICVT,R11                                                 00620000
         USING ITASK,R10                                                00630000
                                                                        00640000
         EJECT ,                                                        00650000
*--------------------------------------------------------------         00660000
*   VALIDATE ENVIRONMENT, FETCH PASSED PARAMETERS                       00670000
*--------------------------------------------------------------         00680000
         USING IPCB,R9            LIFE OF FUNCTION                      00690000
         ICM   R9,15,TSKPCBC      FETCH CURRENT IPCB                    00700000
         BNZ   BEGIN              SERVICE VALID ONLY IN STD ENVRION     00710000
                                                                        00720000
         $ABEND ABE_ENV,                                               x00730000
               TITLE='$RCVRY - Invalid service environment'             00740000
                                                                        00750000
BEGIN    DS    0H                                                       00760000
         LM    R6,R8,0(R8)        FETCH PASSED PARAMETER                00770000
*                                 R7 <== RCVRY RTN EPA OR ZERO          00780000
*                                 R8 <== PARAMETER VALUE                00790000
         LTR   R6,R6              IDENTIFY REQUEST TYPE                 00800000
         BNZ   CREATE             CREATE                                00810000
                                                                        00820000
*--------------------------------------------------------------         00830000
*   DELETE LASTEST OR NAMED ERROR RECOVERY ENTRY                        00840000
*--------------------------------------------------------------         00850000
         LA    R6,PCBRCVYQ-(RCVYNEXT-IRCVY)   POS AT HEAD OF STACK      00860000
PREV     USING IRCVY,R6           PRIOR ENTRY                           00870000
C        USING IRCVY,R5           CURRENT ENTRY                         00880000
                                                                        00890000
DELSCAN  DS    0H                 LOCATE MATCHING ENTRY                 00900000
         ICM   R5,15,PREV.RCVYNEXT   ADVANCE TO NEXT ENTRY              00910000
         BZ    ERR_NF             PREMATURE END OF LIST                 00920000
         LTR   R7,R7              LATEST ENTRY IS SOUGHT?               00930000
         BZ    DELREMOV           SCAN ENDS IF SO                       00940000
         C     R7,C.RCVYRTN       MATCHING RECOVERY ROUTINES?           00950000
         BE    DELREMOV           SCAN ENDS IF SO                       00960000
         LR    R6,R5              ADVANCE ALONG CHAIN                   00970000
         B     DELSCAN            AGAIN                                 00980000
                                                                        00990000
DELREMOV DS    0H                 REMOVE CURRENT ENTRY                  01000000
         MVC   PREV.RCVYNEXT,C.RCVYNEXT                                 01010000
         L     R2,C.RCVYLEN       LENGTH OF BLOCK                       01020000
                                                                        01030000
         STGRETN ADDR=C.IRCVY,LEN=(R2),QH=PCBSTG                        01040000
         LTR   R15,R15            STORAGE FUNCTION COMPLETE?            01050000
         BZ    RET_NORM           DONE IF SO                            01060000
         B     ERR_STG            ERROR OTHERWISE                       01070000
         DROP  PREV,C                                                   01080000
                                                                        01090000
*--------------------------------------------------------------         01100000
*   CREATE NEW ERROR RECOVERY ENVIRONMENT                               01110000
*--------------------------------------------------------------         01120000
CREATE   DS    0H                                                       01130000
         LTR   R7,R7              RECOVERY ROUTINE EPA PROVIDED?        01140000
         BZ    ERR_RRTN           FAIL IF NOT                           01150000
                                                                        01160000
         STGGET RCVYLN,QH=PCBSTG  ACQUIRE CLEARED STORAGE               01170000
         BNZ   ERR_STG            STORAGE FAILURE                       01180000
                                                                        01190000
         LR    R5,R1              ACCEPTED                              01200000
         USING IRCVY,R5           RECOVERY STACK ENTRY FORMAT           01210000
         MVC   RCVYID,=CL8'IRCVY' IDENTIFY BLOCK                        01220000
         MVC   RCVYLEN,=A(RCVYLN) BLOCK LENGTH                          01230000
         ST    R7,RCVYRTN         RECOVERY RTN EPA                      01240000
         ST    R8,RCVYPARM        PARAMETER VALUE                       01250000
         L     R3,4(,R13)         LOCATE CALLERS REGS                   01260000
         MVC   RCVYGRS+8((R13-R2+1)*4),28(R3)                           01270000
         MVC   RCVYNEXT,PCBRCVYQ  CHAIN LINKAGE                         01280000
         ST    R5,PCBRCVYQ        STACK                                 01290000
         DROP  R5                                                       01300000
                                                                        01310000
         EJECT ,                                                        01320000
***************************************************************         01330000
*                                                                       01340000
*   RETURN COMPLETION STATUS TO CALLER                                  01350000
*                                                                       01360000
***************************************************************         01370000
RET_NORM DS    0H                 NORMAL COMPLETION                     01380000
         LA    R15,RC00                                                 01390000
         B     EXIT                                                     01400000
                                                                        01410000
ERR_NF   DS    0H                 IRCVY ENTRY NOT FOUND                 01420000
         LA    R15,RC04                                                 01430000
         B     EXIT                                                     01440000
                                                                        01450000
ERR_RRTN DS    0H                 RECOVERY ROUTINE EPA REQUIRED         01460000
         LA    R15,RC08           ON 'CREATE' REQUEST IS ZERO           01470000
         B     EXIT                                                     01480000
                                                                        01490000
ERR_STG  DS    0H                 STORAGE SERVICE FAILURE               01500000
         LR    R1,R15             PRESERVE SERVICE RTN RETCODE          01510000
         LA    R15,RC12                                                 01520000
                                                                        01530000
EXIT     DS    0H                                                       01540000
         #EXIT ,                                                        01550000
                                                                        01560000
         EJECT ,                                                        01570000
***************************************************************         01580000
*                                                                       01590000
*   LOCAL READ-ONLY DATA AREAS                                          01600000
*                                                                       01610000
***************************************************************         01620000
         LTORG ,                                                        01630000
                                                                        01640000
         EJECT                                                          01650000
         PRINT NOGEN                                                    01660000
         ICVT ,                                                         01670000
         ITASK ,                                                        01680000
         END                                                            01690000

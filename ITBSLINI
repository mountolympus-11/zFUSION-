ITBSLINI TITLE 'TABLE SERVICES - LIKE MASK PREPROCESSOR'                00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE:  ITBSLINI - LIKE MASK PREPROCESSOR                           00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THIS ROUTINE TAKES A STRING THAT WAS USED IN THE LIKE              00080000
*    PREDICATE AND CONVERTS IT TO THE FORM THAT IS USABLE BY            00090000
*    THE 'LIKE' COMPARE ROUTINE 'ITBSLIKE'.                             00100000
*                                                                       00110000
*    UNLIMITED MASK CHARS ('%') ARE TRANSLATED INTO X'FF'.              00120000
*    SEQUENCES OF MULTI MASK CHARS (IE. '%%%') ARE CONDENSED INTO       00130000
*    A SINGLE X'FF'.  THIS IS BECAUSE THE '%' CAN BE FOR 0 TO           00140000
*    UNLIMITED MATCHES.  THEREFORE, STRINGS OF THEM TOGETHER HAS        00150000
*    NO MEANING.  SINGLE MASK CHARS ('_') ARE TRANSLATED INTO           00160000
*    X'FE'.  SINGLE CHARS ARE POSITIONAL AND REQUIRE AT LEAST           00170000
*    ONE CHARACTER.  SEQUENCES OF THIS MASK CHAR ARE NOT                00180000
*    CONDENSED.                                                         00190000
*                                                                       00200000
* ON ENTRY:                                                             00210000
*                                                                       00220000
*    R1  CONTAINS THE ADDRESS OF A PARAMETER LIST MAPPED BY             00230000
*        LINIPL.                                                        00240000
*                                                                       00250000
*                                                                       00260000
* ON EXIT:                                                              00270000
*                                                                       00280000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES                     00290000
*                                                                       00300000
*        RC00 - STRING TRANSFORMED.                                     00310000
*                                                                       00320000
*               R0 CONTAINS THE LENGTH OF THE PROCESSED STRING.         00330000
*                                                                       00340000
*                                                                       00350000
* NOTES:                                                                00360000
*                                                                       00370000
**<DOC-OFF>****************************************************         00380000
                                                                        00390000
         EJECT                                                          00400000
***************************************************************         00410000
*                                                                       00420000
*   WORKING STORAGE AREA                                                00430000
*                                                                       00440000
***************************************************************         00450000
WORKAREA DSECT                                                          00460000
                                                                        00470000
         @WORK ,                  STANDARD WORKAREA                     00480000
                                                                        00490000
SAVESTRT DS    A                  SAVE OFF STARTING OUTPUT BUFFER       00500000
MASKTRT  DS    XL256              TRT TABLE FOR MASKS AND ESC CHARS     00510000
FLAG1    DS    XL1                GENERAL FLAG BYTE                     00520000
$ESCCHAR EQU   X'80'               - CHARACTER IS ESCAPE CHAR           00530000
LASTMASK DS    XL1                LAST MASK FOUND                       00540000
                                                                        00550000
WORKFREE DS    0D                 AVAILABLE TO SERVICE ROUTINES         00560000
WORKLEN  EQU   *-WORKAREA         LENGTH OF WORKAREA                    00570000
                                                                        00580000
         EJECT                                                          00590000
         EQUS  LINKAGE=VCON                                             00600000
                                                                        00610000
         EJECT                                                          00620000
         $STG  TYPE=DSECT                                               00630000
                                                                        00640000
         EJECT                                                          00650000
         $LIKE DSECT=YES                                                00660000
                                                                        00670000
         EJECT                                                          00680000
ITBSLINI @ENTER WORKA=(WORKAREA,WORKLEN),ASC=AR                         00690000
                                                                        00700000
         LAM   R1,R9,MFE_LIST     PRIMARY SPACE ADDRESSING              00710000
                                                                        00720000
*--------------------------------------------------------------         00730000
* GET PARAMETERS FROM PLIST                                             00740000
*--------------------------------------------------------------         00750000
         USING LINIPL,R1                                                00760000
         LM    R4,R7,LIPLSTR      GET PARMS FROM PLIST                  00770000
         ST    R4,SAVESTRT        SAVE OFF STARTING ADDR OF BUFFER      00780000
         XR    R8,R8                                                    00790000
         IC    R8,LIPLESC         GET ESCAPE CHARACTER                  00800000
         DROP  R1                                                       00810000
*                                                                       00820000
*--------------------------------------------------------------         00830000
* SET UP THE TRT TABLE                                                  00840000
*--------------------------------------------------------------         00850000
         MVI   MASKTRT+C'%',X'FF'                                       00860000
         MVI   MASKTRT+C'_',X'FE'                                       00870000
*                                                                       00880000
*--------------------------------------------------------------         00890000
* IF THERE IS AN ESCAPE CHAR, SET ITS TRT VALUE TO X'FD'                00900000
*--------------------------------------------------------------         00910000
         LTR   R8,R8              ANY ESCAPE CHARS?                     00920000
         BZ    FINDNEXT           NO, START LOOKING FOR MASKS           00930000
*                                                                       00940000
         LA    R9,MASKTRT         POINT TO TRT TABLE                    00950000
         L     R1,=F'253'         GET ESCAPE CHAR MASK                  00960000
         STC   R1,0(R8,R9)        SAVE OFF ESCAPE CHAR MASK             00970000
*                                                                       00980000
*--------------------------------------------------------------         00990000
* KEEP SEARCHING OUT MASK CHARACTERS.                                   01000000
*--------------------------------------------------------------         01010000
FINDNEXT DS    0H                                                       01020000
         LTR   R7,R7              ANYTHING LEFT TO SEARCH               01030000
         BNP   ENDIT                                                    01040000
*                                                                       01050000
*--------------------------------------------------------------         01060000
* IF TOO MUCH FOR A SINGLE TRT, THEN DO AS MUCH AS WE CAN               01070000
*--------------------------------------------------------------         01080000
         C     R7,=F'256'         TOO MUCH TO TRT?                      01090000
         BL    TRTLAST            NO, GO AHEAD AND DO IT                01100000
*                                                                       01110000
         XR    R2,R2              ZERO OUT WORK REG                     01120000
         TRT   0(256,R6),MASKTRT  FIND MASK/ESC CHARS                   01130000
         BNZ   PROCMASK           FOUND ONE, PROCESS IT.                01140000
*                                                                       01150000
         LA    R1,256(,R6)        POINT TO NEXT SEGMENT TO COMPARE      01160000
         B     NOMASK             AND KEEP PROCESSING                   01170000
*                                                                       01180000
*--------------------------------------------------------------         01190000
* TRANSLATE WHAT IS THERE                                               01200000
*--------------------------------------------------------------         01210000
TRTLAST  DS    0H                                                       01220000
         XR    R2,R2              ZERO OUT WORK REG                     01230000
         BCTR  R7,0               DECREMENT FOR EXECUTE INSTRUCTION     01240000
         EX    R7,LASTTRT         AND DO EXECUTE                        01250000
         LA    R7,1(,R7)          RESTORE THE LENGTH                    01260000
         BNZ   PROCMASK           PROCESS THE MASK                      01270000
*                                                                       01280000
         LA    R1,0(R7,R6)        POINT PAST AREA OF MOVEMENT           01290000
         B     NOMASK             AND KEEP PROCESSING                   01300000
*                                                                       01310000
*--------------------------------------------------------------         01320000
* SAVE OFF THE TRANSLATED CHAR, ZERO MEANS THAT THERE WAS NO            01330000
* MASK OR ESCAPE CHAR FOUND.  IF THE CHARACTER FOUND WAS AN             01340000
* ESCAPE CHAR, SET A FLAG TO LET US KNOW                                01350000
*--------------------------------------------------------------         01360000
PROCMASK DS    0H                                                       01370000
         C     R2,=F'255'         DID WE FIND UNLIMITED CHAR?           01380000
         BNE   NOMASK             NO, KEEP GOING                        01390000
*                                                                       01400000
         LR    R3,R6              GET CURRENT POINTER TO STRING         01410000
         BCTR  R3,0               DECREMENT PTR TO PASSED IN STRING     01420000
         CLC   0(1,R3),1(R3)      IS IT THE SAME CHAR TWICE?            01430000
         BNE   NOMASK             NO, KEEP GOING                        01440000
*                                                                       01450000
         LR    R2,R6              POINT TO OURSELVES                    01460000
         B     MOVEREST           AND KEEP GOING                        01470000
*                                                                       01480000
NOMASK   DS    0H                                                       01490000
         STC   R2,LASTMASK        SAVE OFF CHARACTER FOUND              01500000
         CLI   LASTMASK,X'FD'     IS IT THE ESCAPE CHAR?                01510000
         BNE   MOVEREST           NO, JUST MOVE DATA                    01520000
*                                                                       01530000
         MVC   LASTMASK(1),1(R1)  MOVE CHARACTER AFTER ESCAPE CHAR      01540000
         OI    FLAG1,$ESCCHAR     MARK AS FOUND ESCAPE CHARACTER        01550000
*                                                                       01560000
*--------------------------------------------------------------         01570000
* MOVE IN ALL DATA UP TO THE TRT CHAR.                                  01580000
*--------------------------------------------------------------         01590000
MOVEREST DS    0H                                                       01600000
         LR    R2,R6              GET START ADDR TO MOVE                01610000
         LR    R3,R1              POINT TO MASK CHAR OR END OF STRING   01620000
         SR    R3,R2              GET LENGTH TO MOVE                    01630000
         LR    R5,R3              COPY LENGTH                           01640000
         MVCL  R4,R2              MOVE INTO WORK AREA                   01650000
*                                                                       01660000
*--------------------------------------------------------------         01670000
* MOVE IN THE TRANSLATED MASK CHARACTER IF THERE IS ONE TO              01680000
* MOVE.                                                                 01690000
*--------------------------------------------------------------         01700000
         CLI   LASTMASK,X'00'     ANY THING TO MOVE?                    01710000
         BE    MOVEDONE           NO, ALL DONE                          01720000
*                                                                       01730000
         MVC   0(1,R4),LASTMASK   MOVE THE MASK CHAR IN                 01740000
         LA    R4,1(,R4)          POINT TO NEXT IN WORK BUFFER          01750000
*                                                                       01760000
*--------------------------------------------------------------         01770000
* BUMP THE POINTERS                                                     01780000
*--------------------------------------------------------------         01790000
MOVEDONE DS    0H                                                       01800000
         SR    R2,R6              GET LENGTH                            01810000
         LA    R2,1(,R2)          ADD ONE FOR THE MASK/ESC CHAR         01820000
         SR    R7,R2              AND DECREMENT THE LENGTH              01830000
         LA    R6,0(R2,R6)        GET NEX STARTING ADDR                 01840000
*                                                                       01850000
         TM    FLAG1,$ESCCHAR     WAS THIS THE ESCAPE CHAR?             01860000
         BZ    FINDNEXT           NO, FIND THE NEXT MASK                01870000
*                                                                       01880000
         LA    R6,1(,R6)          POINT PAST ESCAPED CHARACTER          01890000
         BCTR  R7,0               DECREMENT THE COUNT                   01900000
         NI    FLAG1,FF-$ESCCHAR  TURN OFF THE ESCAPE CHAR FLAG         01910000
         B     FINDNEXT           AND KEEP GOING                        01920000
*                                                                       01930000
*--------------------------------------------------------------         01940000
* SET RETURN CODES AND RETURN TO CALLER                                 01950000
*--------------------------------------------------------------         01960000
ENDIT    DS    0H                                                       01970000
         LA    R15,RC00           SET GOOD RETURN CODE                  01980000
         S     R4,SAVESTRT        GET LENGTH OF PROCESSED MASK          01990000
         LR    R0,R4              RETURN LENGTH TO CALLER               02000000
         @EXIT ,                                                        02010000
                                                                        02020000
         EJECT                                                          02030000
LASTTRT  TRT   0(*-*,R6),MASKTRT                                        02040000
         LTORG ,                                                        02050000
         END   ,                                                        02060000

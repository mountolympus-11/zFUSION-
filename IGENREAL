IGENREAL TITLE '- STORAGE EXTENT REALLOCATION'                          00010000
***************************************************************         00020000
*                                                                       00030000
* MAPPING:  REQPARM - REQUEST PARAMETER LIST                            00040000
*                                                                       00050000
***************************************************************         00060000
REQPARM  DSECT                                                          00070000
REQPDESC DS    A             ADDR OF EXTENT (PTR,LENGTH) PAIR.          00080000
*                            HIGH ORDER BIT OF PTR IS HIGH IF           00090000
*                            THE EXTENT IS NOT FREEABLE.                00100000
*                            USUALLY SET WHEN THE FIRST BUFFER          00110000
*                            RESIDES IN A LOCAL WORKAREA                00120000
*                                                                       00130000
REQPSIZE DS    F             INITIAL SIZE OR ADDITIONAL SIZE REQ.       00140000
*                            IF ZERO, THE CURRENT EXTENT LENGTH         00150000
*                            IS DOUBLED                                 00160000
*                                                                       00170000
REQPUSED DS    F             SIZE OF EXTENT CURRENTLY USED OR           00180000
*                            ZERO IF THIS VALUE IS NOT TRACKED          00190000
*                            OR NOT RELEVANT                            00200000
*                                                                       00210000
REQPCOND DS    F             NON-ZERO IF COMPLETION IS                  00220000
*                            CONDITIONAL ON STORAGE                     00230000
*                            AVAILABILITY                               00240000
*                                                                       00250000
REQPOWNR DS    A             OPTIONALLY, DESIGNATES THE ADDR OF         00260000
*                            THE WORKUNIT OWNING/MANAGING THE           00270000
*                            DYNAMICALLY ACQUIRED/FREED BUFFER          00280000
*                            AREA.  THIS OPERAND IS PASSED THRU         00290000
*                            ON ALL $RETSTOR AND $GETSTOR REQS.         00300000
*                                                                       00310000
REQPLN   EQU   *-REQPARM     LENGTH OF PLIST                            00320000
                                                                        00330000
         EJECT                                                          00340000
**<DOC-ON>*****************************************************         00350000
*                                                                       00360000
* ROUTINE: IGENREAL - GENERAL STORAGE EXTENT REALLOCATION               00370000
*                                                                       00380000
* DESCRIPTION:                                                          00390000
*                                                                       00400000
*    THIS ROUTINE IS USED TO PERFORM THE FREQUENTLY ENCOUNTERED         00410000
*    REALLLOCATE-COPY-RELEASE SEQUENCE APPLIED ON STORAGE AREAS         00420000
*    WHOSE LENGTH REQUIREMENT CANNOT BE DETERMINED IN ADVANCE.          00430000
*                                                                       00440000
*    THE REALLOCATION SIZE IS COMPUTED FROM THE CURRENT EXTENT          00450000
*    SIZE, MINIMUM REQUIREMENT (REQPSIZE), AND BUFFER OCCUPANCY         00460000
*    AMOUNT (REQPUSED), AS FOLLOWS:                                     00470000
*                                                                       00480000
*       1) IF REQPUSED EQ 0, THE REALLOCATION AMOUNT = REQPSIZE         00490000
*                                                                       00500000
*       2) IF REQPUSED NE 0, WE ASSUME THE BUFFER HAS BEEN              00510000
*          FILLED BY A SERIES OF 'APPEND' OPERATIONS, WITH              00520000
*          OVERFLOW OCCURRING ON THE MOST RECENT ATTEMPT.  THE          00530000
*          REALLOCATION AMOUNT IS AT LEAST TWO TIMES LARGER             00540000
*          THAN THE CURRENT EXTENT SIZE, AND LARGER IF NEEDED           00550000
*          TO ACCOMODATE REQPSIZE.                                      00560000
*                                                                       00570000
*                                                                       00580000
* ON ENTRY:                                                             00590000
*                                                                       00600000
*    R1  CONTAINS THE ADDRESS OF A PARAMETER LIST CONSTRUCTED           00610000
*        AS DESCRIBED BY THE LOCAL REQPARM MAPPING                      00620000
*                                                                       00630000
*                                                                       00640000
* ON EXIT:                                                              00650000
*                                                                       00660000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES                     00670000
*                                                                       00680000
*        RC00 - REALLOCATION COMPLETE                                   00690000
*                                                                       00700000
*        RC04 - CONDITIONAL REQUEST AND REQUESTED STORAGE WAS           00710000
*               NOT AVAILABLE                                           00720000
*                                                                       00730000
**<DOC-OFF>****************************************************         00740000
                                                                        00750000
         EJECT                                                          00760000
         EQUS  ,                                                        00770000
                                                                        00780000
         ABCODES ,                $ABEND REQUEST CODES                  00790000
                                                                        00800000
##DFTSIZ EQU   512                DEFAULT ALLOCATION SIZE               00810000
                                                                        00820000
         EJECT                                                          00830000
IGENREAL #ENTER SAVE=NO,PREG=R8                                         00840000
                                                                        00850000
         USING ITASK,R10                                                00860000
         USING REQPARM,R8                                               00870000
                                                                        00880000
         EJECT                                                          00890000
***************************************************************         00900000
*                                                                       00910000
*   ANALYZE (RE) ALLOCATION REQUIREMENTS                                00920000
*                                                                       00930000
***************************************************************         00940000
         L     R4,REQPSIZE        MINIMUM INITIAL / EXTENSION SIZE      00950000
         L     R7,REQPDESC        CURRENT EXTENT DESCRIPTOR ADDR        00960000
         ICM   R6,15,4(R7)        FETCH SIZE OF CURRENT EXTENT          00970000
         BZ    REALLOC            NOT YET ALLOCATED                     00980000
                                                                        00990000
         ICM   R0,15,REQPUSED     BUFFER PARTIALLY USED?                01000000
         BZ    REALLOC            END OF COMPUTATION IF NOT             01010000
                                                                        01020000
         CR    R4,R6              EXTENSION EXCEEDS CURR BUFFER SIZE?   01030000
         BNL   *+6                SKIP IF SO                            01040000
         LR    R4,R6              ELSE DOUBLE SIZE OF CURRENT EXTENT    01050000
         LA    R4,0(R4,R6)        REALLOCATION REQUEST SIZE             01060000
                                                                        01070000
*--------------------------------------------------------------         01080000
*   (RE)ALLOCATE TO SIZE CONTAINED IN R4                                01090000
*--------------------------------------------------------------         01100000
REALLOC  DS    0H                                                       01110000
         LTR   R4,R4              (RE)ALLOCATION AMOUNT PROVIDED?       01120000
         BP    *+8                SKIP IF SO                            01130000
         L     R4,=A(##DFTSIZ)    DEFAULT FIRST ALLOCATION              01140000
                                                                        01150000
         $GETSTOR (R4),COND=YES,OWNER=*REQPOWNR  ACQUIRE NEW EXTENT     01160000
                                                                        01170000
         BZ    NEWXTENT           SUCCESSFUL ACQUISITION                01180000
         ICM   R0,15,REQPCOND     CONDITIONAL REQUEST?                  01190000
         BNZ   WRN_STG            STORAGE NOT AVAILABLE IF SO           01200000
         B     ABN_STG            FAILURE OTHERWISE                     01210000
                                                                        01220000
*--------------------------------------------------------------         01230000
*   COPY EXISTING CONTENTS INTO NEW EXTENT                              01240000
*--------------------------------------------------------------         01250000
NEWXTENT DS    0H                                                       01260000
         LR    R6,R1              NEW EXTENT ORIGIN                     01270000
         ICM   R14,15,0(R7)       CURR EXTENT ORIGIN                    01280000
         BZ    COPIED             SKIP IF N/A                           01290000
         ICM   R15,15,REQPUSED    AMOUNT USED                           01300000
         BZ    COPIED             SKIP IF N/A                           01310000
                                                                        01320000
         LR    R0,R6              NEW EXTENT                            01330000
         LR    R1,R15             SOURCE LENGTH = TARGET LENGTH         01340000
         MVCL  R0,R14             COPY CURRENT CONTENTS                 01350000
                                                                        01360000
COPIED   DS    0H                                                       01370000
                                                                        01380000
*--------------------------------------------------------------         01390000
*   FREE CURRENT EXTENT AND REPLACE WITH NEW ALLOC                      01400000
*--------------------------------------------------------------         01410000
         ICM   R2,15,0(R7)        CURR BUFFER DYNAMICALLY ACQUIRED?     01420000
         BNP   FREED              SKIP IF NOT                           01430000
                                                                        01440000
         $RETSTOR (R2),OWNER=*REQPOWNR   RELEASE CURRENT EXTENT         01450000
                                                                        01460000
FREED    DS    0H                                                       01470000
         ST    R6,0(,R7)          INTRODUCE NEW CURRENT EXTENT          01480000
         ST    R4,4(,R7)          EXTENT LENGTH                         01490000
                                                                        01500000
*--------------------------------------------------------------         01510000
*   RETURN COMPLETION STATUS TO CALLER                                  01520000
*--------------------------------------------------------------         01530000
         LA    R15,RC00           REALLOCATION COMPLETE                 01540000
         B     RETURN                                                   01550000
                                                                        01560000
WRN_STG  DS    0H                 STORAGE NOT AVAILABLE                 01570000
         LA    R15,RC04                                                 01580000
                                                                        01590000
RETURN   DS    0H                                                       01600000
         #EXIT ,                                                        01610000
                                                                        01620000
         EJECT ,                                                        01630000
***************************************************************         01640000
*                                                                       01650000
*   CATASTROPHIC FAILURES                                               01660000
*                                                                       01670000
***************************************************************         01680000
ABN_STG  DS    0H                                                       01690000
         $ABEND ABE_STORAGE,(R2),DUMP=YES,                             X01700000
               TITLE='STORAGE MANAGEMENT FAILURE'                       01710000
                                                                        01720000
         EJECT                                                          01730000
***************************************************************         01740000
*                                                                       01750000
*   READ ONLY DATA AREAS                                                01760000
*                                                                       01770000
***************************************************************         01780000
         LTORG ,                                                        01790000
                                                                        01800000
         PRINT NOGEN                                                    01810000
         ICVT ,                                                         01820000
         ITASK ,                                                        01830000
         END   ,                                                        01840000

IPRJDBIO TITLE '- PROJECT DATABASE I/O SERVICES'                        00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE:   IPRJDBIO - PROJECT DATABASE I/O SERVICES                   00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THE FUNCTION OF THIS SERVICE ROUTINE IS TO SUPPORT                 00080000
*    THE PROJECT DATABASE I/O REQUESTS.  THE IDBIOP PLIST               00090000
*    IS PROVIDED AS INPUT TO THE IO SERVICE ROUTINE.  AN RPL            00100000
*    IS OPTIONALLY RETURNED IF VSAM POSITIONING IS REQUIRED             00110000
*    FOR THE REQUEST.                                                   00120000
*                                                                       00130000
* ON ENTRY:                                                             00140000
*                                                                       00150000
*    R1 CONTAINS THE ADDRESS OF THE PLIST MAPPED BY                     00160000
*    THE IDBIOP MAPPING MACRO.  ($DBIO MACRO CALL                       00170000
*    INTERFACE)                                                         00180000
*                                                                       00190000
* ON EXIT:                                                              00200000
*                                                                       00210000
*    R15 CONTAINS OF THE FOLLOWING RETURN CODES.                        00220000
*                                                                       00230000
*        RC00 - REQUEST COMPLETED SUCCESSFULLY (ALL)                    00240000
*               R0 - LENGTH OF RECORD (GET LOC)                         00250000
*               R1 - ADDR   OF RECORD (GET LOC)                         00260000
*                                                                       00270000
*        RC08 - VSAM REQUEST FAILED                                     00280000
*               R0 - VSAM RETURN CODE                                   00290000
*               R1 - RPL FEEDBACK WORD                                  00300000
*                                                                       00310000
*        RC12 - REQUEST FAILED                                          00320000
*               R0 - 4 - GETRPL FAILED                                  00330000
*                    8 - RPL REQUIRED FOR REQUEST                       00340000
*                   12 - UPD/DEL REQUEST REQUIRES GET-UPDATE            00350000
*                                                                       00360000
**<DOC-OFF>****************************************************         00370000
                                                                        00380000
         EJECT ,                                                        00390000
***************************************************************         00400000
*                                                                       00410000
* MAINTENANCE:                                                          00420000
*                                                                       00430000
*    07/10/92 RON COLMONE                                               00440000
*             INITIAL VERSION                                           00450000
*                                                                       00460000
***************************************************************         00470000
                                                                        00480000
         EJECT ,                                                        00490000
         EQUS  ,                       REGISTER EQUATES                 00500000
                                                                        00510000
         EJECT ,                                                        00520000
         IDBIOP DSECT=YES              REQUEST PLIST                    00530000
                                                                        00540000
         EJECT ,                                                        00550000
*--------------------------------------------------------------         00560000
*                                                                       00570000
*   GENERAL WORKAREA                                                    00580000
*                                                                       00590000
*--------------------------------------------------------------         00600000
         #WORK LENGTH=1024                                              00610000
REGSAVE1 DS    16F                     REGISTER SAVE AREA               00620000
REGSAVE2 DS    16F                     REGISTER SAVE AREA               00630000
WRK256   DS    XL256                   WORKAREA                         00640000
RECADDR  DS    A                       REC BUFFER ADDR (OPTCD=LOC)      00650000
         #ENDWORK ,                    END OF WORKAREA                  00660000
                                                                        00670000
         EJECT ,                                                        00680000
*--------------------------------------------------------------         00690000
*  ESTABLISH ENTRY LINKAGE TO DATABASE SERVICES ROUTINE                 00700000
*--------------------------------------------------------------         00710000
                                                                        00720000
IPRJDBIO #ENTER PREG=R9                DBIO ENTRY                       00730000
                                                                        00740000
         USING IDBIOP,R9               ESTABLISH ADDRESSABILITY         00750000
                                                                        00760000
         EJECT ,                                                        00770000
*--------------------------------------------------------------         00780000
*  OBTAIN AN RPL FOR USE BY THIS REQUEST AND SET OPTIONS                00790000
*  ACCORDINGLY.                                                         00800000
*--------------------------------------------------------------         00810000
                                                                        00820000
         ICM   R1,15,IDBRPL            RPL AVAILABLE?                   00830000
         BNZ   HAVERPL                 YES,  USE IT                     00840000
         CLI   IDBFUNC,IDBF$END        ENDREQ REQUESTED?                00850000
         BE    ERRNORPL                YES, MUST BE AN RPL              00860000
         BAL   R14,GETRPL              ALLOC AN RPL                     00870000
                                                                        00880000
HAVERPL  DS    0H                                                       00890000
         LTR   R6,R1                   GET RPL ADDRESS                  00900000
         BZ    ERRRPL                  NO RPL, RETURN ERROR             00910000
         USING IFGRPL,R6               ESTABLISH ADDRESSABILITY         00920000
                                                                        00930000
*--------------------------------------------------------------         00940000
*  TEST FOR GENERIC KEY PROCESSING                                      00950000
*--------------------------------------------------------------         00960000
                                                                        00970000
SETGKY   DS    0H                                                       00980000
         TM    IDBRFLAG,IDBR$GEN       GENERIC KEY PROCESSING           00990000
         BZ    SETMOVE                 CHECK FOR MOVE MODE              01000000
                                                                        01010000
         MODCB RPL=(R6),               ADD KGQ AND GEN OPTCD'S         +01020000
               OPTCD=(KGE,GEN),                                        +01030000
               MF=(G,WRK256)                                            01040000
                                                                        01050000
*--------------------------------------------------------------         01060000
*  TEST AND SET MOVE/LOCATE MODE                                        01070000
*--------------------------------------------------------------         01080000
                                                                        01090000
SETMOVE  DS    0H                                                       01100000
         TM    IDBRFLAG,IDBR$MVE       GENERIC KEY PROCESSING           01110000
         BZ    SETLOC                  CHECK FOR SEQ ACCESS             01120000
                                                                        01130000
         L     R4,IDBREC               ADDR OF RECORD BUFFER            01140000
         L     R3,IDBRECLN             LEN  OF RECORD                   01150000
         L     R2,IDBAREAL             LEN  OF RECORD AREA              01160000
                                                                        01170000
         MODCB RPL=(R6),               SET MOVE MODE PROCESSING        +01180000
               OPTCD=(MVE),                                            +01190000
               AREA=(R4),                                              +01200000
               AREALEN=(R2),                                           +01210000
               RECLEN=(R3),                                            +01220000
               MF=(G,WRK256)                                            01230000
         B     SETSEQ                  CHECK SEQ PROCESSING             01240000
                                                                        01250000
SETLOC   DS    0H                                                       01260000
         LA    R4,RECADDR              RECORD ADDRESS                   01270000
         LA    R3,L'RECADDR            LENGTH OF RECORD ADDRESS         01280000
                                                                        01290000
         MODCB RPL=(R6),               SET LOC MODE PROCESSING         +01300000
               OPTCD=(LOC),                                            +01310000
               AREA=(R4),                                              +01320000
               AREALEN=(R3),                                           +01330000
               MF=(G,WRK256)                                            01340000
                                                                        01350000
*--------------------------------------------------------------         01360000
*  TEST FOR SEQ PROCESSING                                              01370000
*--------------------------------------------------------------         01380000
                                                                        01390000
SETSEQ   DS    0H                                                       01400000
         TM    IDBRFLAG,IDBR$SEQ       SEQUENCIAL PROCESSING            01410000
         BZ    SETSKP                  CHECK FOR SKIP SEQUENCIAL        01420000
                                                                        01430000
         MODCB RPL=(R6),               CHANGE TO SEQUENTIAL ACCESS     +01440000
               OPTCD=(SEQ),                                            +01450000
               MF=(G,WRK256)                                            01460000
                                                                        01470000
*--------------------------------------------------------------         01480000
*  TEST FOR SKIP PROCESSING                                             01490000
*--------------------------------------------------------------         01500000
                                                                        01510000
SETSKP   DS    0H                                                       01520000
         TM    IDBRFLAG,IDBR$SKP       SKIP SEQ PROCESSING              01530000
         BZ    SETKGE                  CHECK FOR KEY GT/EQ              01540000
                                                                        01550000
         MODCB RPL=(R6),               CHANGE TO SKIP SEQ ACCESS       +01560000
               OPTCD=(SKP),                                            +01570000
               MF=(G,WRK256)                                            01580000
                                                                        01590000
*--------------------------------------------------------------         01600000
*  TEST FOR KEY GT/EQ PROCESSING                                        01610000
*--------------------------------------------------------------         01620000
                                                                        01630000
SETKGE   DS    0H                                                       01640000
         TM    IDBRFLAG,IDBR$KGE       KEY GT/EQ                        01650000
         BZ    SETUPD                  CHECK FOR UPD RETRIEVAL          01660000
                                                                        01670000
         MODCB RPL=(R6),               CHANGE TO KGE                   +01680000
               OPTCD=(KGE),                                            +01690000
               MF=(G,WRK256)                                            01700000
                                                                        01710000
*--------------------------------------------------------------         01720000
*  TEST FOR UPDATE RETRIEVAL                                            01730000
*--------------------------------------------------------------         01740000
                                                                        01750000
SETUPD   DS    0H                                                       01760000
         CLI   IDBFUNC,IDBF$GET        RETRIEVAL REQUEST                01770000
         BNE   SETNUPD                 CHECK IF INSERT REQUEST          01780000
         TM    IDBRFLAG,IDBR$UPD       GENERIC KEY PROCESSING           01790000
         BZ    DBIOFUNC                                                 01800000
                                                                        01810000
         MODCB RPL=(R6),               CHANGE RPL TO UPD RETRIEVAL     +01820000
               OPTCD=(UPD),                                            +01830000
               MF=(G,WRK256)                                            01840000
                                                                        01850000
*--------------------------------------------------------------         01860000
*  TEST FOR INSERT REQUEST AND RESET UPDATE                             01870000
*--------------------------------------------------------------         01880000
                                                                        01890000
SETNUPD  DS    0H                                                       01900000
         CLI   IDBFUNC,IDBF$INS        INSERT REQUEST                   01910000
         BNE   DBIOFUNC                PROCESS FUNCTION                 01920000
                                                                        01930000
         MODCB RPL=(R6),               CHANGE RPL TO NUP (INSERT)      +01940000
               OPTCD=(NUP),                                            +01950000
               MF=(G,WRK256)                                            01960000
                                                                        01970000
         EJECT ,                                                        01980000
*--------------------------------------------------------------         01990000
*  BRANCH TO APPROPRIATE FUNCTION HANDLER                               02000000
*--------------------------------------------------------------         02010000
                                                                        02020000
DBIOFUNC DS    0H                                                       02030000
         SR    R3,R3                   PREPARE FOR INSERT               02040000
         IC    R3,IDBFUNC              OBTAIN FUNCTION CODE             02050000
         BCTR  R3,0                    PREPARE FOR WFB                  02060000
         SLL   R3,2                    CALC BRANCH INDEX                02070000
                                                                        02080000
         B     *+4(R3)                 BRANCH ON FUNC CODE              02090000
         B     DBIOGET                   GET DB RECORD                  02100000
         B     DBIOUPD                   UPD DB RECORD                  02110000
         B     DBIOINS                   INS DB RECORD                  02120000
         B     DBIODEL                   DEL DB RECORD(S)               02130000
         B     DBIOEND                   END REQUEST                    02140000
         EX    R0,*                      UNSUPPORTED                    02150000
         EX    R0,*                      UNSUPPORTED                    02160000
         EX    R0,*                      UNSUPPORTED                    02170000
         EX    R0,*                      UNSUPPORTED                    02180000
                                                                        02190000
         EJECT ,                                                        02200000
*--------------------------------------------------------------         02210000
*  PROCESS DATABASE RETRIEVAL REQUEST                                   02220000
*--------------------------------------------------------------         02230000
                                                                        02240000
DBIOGET  DS    0H                                                       02250000
         GET   RPL=IFGRPL              GET PROJECT RECORD               02260000
                                                                        02270000
         ST    R15,IDBRET              SAVE VSAM RETURN CODE            02280000
         ST    R0,IDBRSN               SAVE VSAM REASON CODE            02290000
         MVC   IDBFDBK,RPLFDBWD        SAVE VSAM FDBK   CODE            02300000
                                                                        02310000
         ICM   R0,15,IDBRET            RECORD RETRIEVED                 02320000
         BNZ   ERR_VSAM                NO, RETURN                       02330000
                                                                        02340000
         TM    IDBRFLAG,IDBR$MVE       MOVE MODE REQUEST?               02350000
         BO    GETEXIT                 YES, RETURN                      02360000
         L     R1,RECADDR              GET RECORD ADDRESS               02370000
         ST    R1,IDBREC               RETURN RECORD ADDRESS            02380000
         L     R0,RPLRLEN              GET RECORD LENGTH                02390000
         ST    R0,IDBRECLN             RETURN RECORD LENGTH             02400000
                                                                        02410000
GETEXIT  DS    0H                                                       02420000
         LA    R15,RC00                RECORD NOT FOUND                 02430000
         B     RETURN                  RETURN ERROR                     02440000
                                                                        02450000
         EJECT ,                                                        02460000
*--------------------------------------------------------------         02470000
*  PROCESS DATABASE PUT UPDATE/INSERT REQUEST                           02480000
*--------------------------------------------------------------         02490000
                                                                        02500000
DBIOINS  DS    0H                                                       02510000
         B     DBIOPUT                 GO INSERT RECORD                 02520000
                                                                        02530000
DBIOUPD  DS    0H                                                       02540000
         TESTCB RPL=(R6),              IN UPDATE MODE?                 +02550000
               OPTCD=(UPD),                                            +02560000
               MF=(G,WRK256)                                            02570000
         BNE   ERRNOUPD                RETURN ERROR,  NOT IN UPD MODE   02580000
                                                                        02590000
DBIOPUT  DS    0H                                                       02600000
         PUT   RPL=IFGRPL              SAVE PROJECT RECORD              02610000
                                                                        02620000
         ST    R15,IDBRET              SAVE VSAM RETURN CODE            02630000
         ST    R0,IDBRSN               SAVE VSAM REASON CODE            02640000
         MVC   IDBFDBK,RPLFDBWD        SAVE VSAM FDBK   CODE            02650000
                                                                        02660000
         BAL   R14,FREERPL             RETURN RPL                       02670000
                                                                        02680000
         ICM   R0,15,IDBRET            RECORD SAVED                     02690000
         BNZ   ERR_VSAM                VSAM FAILURE                     02700000
                                                                        02710000
         LA    R15,RC00                SUCCESSFUL COMPLETION            02720000
         B     RETURN                  RETURN                           02730000
                                                                        02740000
         EJECT ,                                                        02750000
*--------------------------------------------------------------         02760000
*  PROCESS DATABASE DEL REQUEST                                         02770000
*--------------------------------------------------------------         02780000
                                                                        02790000
DBIODEL  DS    0H                                                       02800000
         TESTCB RPL=(R6),              IN UPDATE MODE?                 +02810000
               OPTCD=(UPD),                                            +02820000
               MF=(G,WRK256)                                            02830000
         BNE   ERRNOUPD                RETURN ERROR,  NOT IN UPD MODE   02840000
                                                                        02850000
         ERASE RPL=IFGRPL              DELETE PROJECT RECORD            02860000
                                                                        02870000
         ST    R15,IDBRET              SAVE VSAM RETURN CODE            02880000
         ST    R0,IDBRSN               SAVE VSAM REASON CODE            02890000
         MVC   IDBFDBK,RPLFDBWD        SAVE VSAM FDBK   CODE            02900000
                                                                        02910000
         BAL   R14,FREERPL             RETURN RPL                       02920000
                                                                        02930000
         ICM   R0,15,IDBRET            RECORD DELETED                   02940000
         BNZ   ERR_VSAM                VSAM FAILURE                     02950000
                                                                        02960000
         LA    R15,RC00                SUCCESSFULL                      02970000
         B     RETURN                  RETURN                           02980000
                                                                        02990000
         EJECT ,                                                        03000000
*--------------------------------------------------------------         03010000
*  PROCESS RPL END REQUEST                                              03020000
*--------------------------------------------------------------         03030000
                                                                        03040000
DBIOEND  DS    0H                                                       03050000
         ENDREQ RPL=IFGRPL             TERMINATE REQUEST                03060000
                                                                        03070000
         ST    R15,IDBRET              SAVE VSAM RETURN CODE            03080000
         ST    R0,IDBRSN               SAVE VSAM REASON CODE            03090000
         MVC   IDBFDBK,RPLFDBWD        SAVE VSAM FDBK   CODE            03100000
                                                                        03110000
         BAL   R14,FREERPL             RETURN RPL                       03120000
                                                                        03130000
         ICM   R0,15,IDBRET            REQUEST TERMINATED               03140000
         BNZ   ERR_VSAM                VSAM FAILURE                     03150000
                                                                        03160000
         LA    R15,RC00                SUCCESSFULL COMPLETION           03170000
         B     RETURN                  RETURN                           03180000
                                                                        03190000
         EJECT ,                                                        03200000
*---------------------------------------------------------------        03210000
*                                                                       03220000
*  ERROR EXITS                                                          03230000
*                                                                       03240000
*---------------------------------------------------------------        03250000
                                                                        03260000
ERRRPL   DS    0H                                                       03270000
         LA    R15,RC12                RETURN CODE - FAIL               03280000
         LA    R0,RSN04                REASON CODE - GETRPL ERROR       03290000
         B     RETURN                  RETURN ERROR                     03300000
                                                                        03310000
ERRNORPL DS    0H                                                       03320000
         LA    R15,RC12                RETURN CODE - FAIL               03330000
         LA    R0,RSN08                REASON CODE - RPL REQUIRED       03340000
         B     RETURN                  RETURN ERROR                     03350000
                                                                        03360000
ERRNOUPD DS    0H                                                       03370000
         LA    R15,RC12                RETURN CODE - FAIL               03380000
         LA    R0,RSN12                REASON CODE - NOT IN UPD MODE    03390000
         B     RETURN                  RETURN ERROR                     03400000
                                                                        03410000
ERR_VSAM DS    0H                                                       03420000
         LA    R15,RC08                VSAM ERROR                       03430000
         L     R0,IDBRET               VSAM RETURN CODE                 03440000
         L     R1,IDBFDBK              VSAM FEEDBACK CODE               03450000
         B     RETURN                  RETURN ERROR                     03460000
                                                                        03470000
         EJECT ,                                                        03480000
*---------------------------------------------------------------        03490000
*                                                                       03500000
*  RETURN                                                               03510000
*                                                                       03520000
*---------------------------------------------------------------        03530000
                                                                        03540000
RETURN   DS    0H                                                       03550000
         #EXIT ,                       RETURN                           03560000
                                                                        03570000
         EJECT ,                                                        03580000
*---------------------------------------------------------------        03590000
*                                                                       03600000
*  ROUTINE:  GETRPL                                                     03610000
*                                                                       03620000
*  FUNCTION:                                                            03630000
*                                                                       03640000
*    THIS ROUTINE WILL ALLOCATE AN RPL FOR USE BY THE CURRENT           03650000
*    REQUEST AND SUBSEQUENT REQUEST.                                    03660000
*                                                                       03670000
*  ENTRY:  N/A                                                          03680000
*                                                                       03690000
*  EXIT:   R1 CONTAINS ADDRESS OF RPL   (0 = ERROR)                     03700000
*                                                                       03710000
*---------------------------------------------------------------        03720000
                                                                        03730000
GETRPL   DS    0H                                                       03740000
         STM   R0,R15,REGSAVE1         SAVE CALLER'S REGISTERS          03750000
                                                                        03760000
         STGGET $RPLLEN,QH=ICTSTG      GET AN RPL BUFFER                03770000
         BNZ   GRPLERR                 ERROR,  RETURN                   03780000
         LR    R6,R1                   GET  RPL ADDRESS                 03790000
         ST    R6,IDBRPL               SAVE RPL ADDRESS                 03800000
                                                                        03810000
         L     R5,ICTACBDB             GET ACB ADDRESS                  03820000
         L     R4,IDBKEY               ADDR OF RECORD KEY               03830000
         L     R3,IDBKEYLN             LEN  OF RECORD KEY               03840000
         LA    R7,RECADDR              RECORD BUFFER ADDR AREA          03850000
                                                                        03860000
         GENCB BLK=RPL,                GENERATE VSAM RPL               +03870000
               AM=VSAM,                                                +03880000
               ACB=(R5),                                               +03890000
               AREA=(R7),                                              +03900000
               AREALEN=L'RECADDR,                                      +03910000
               ARG=(R4),                                               +03920000
               KEYLEN=(R3),                                            +03930000
               OPTCD=(KEY,DIR,KEQ,LOC),                                +03940000
               WAREA=(R6),                                             +03950000
               LENGTH=$RPLLEN,                                         +03960000
               MF=(G,WRK256)                                            03970000
                                                                        03980000
         LR    R1,R6                   GET RPL ADDRESS                  03990000
         LTR   R15,R15                 GENCB SUCCESSFULL?               04000000
         BZ    GRPLEXIT                YES, RETURN                      04010000
                                                                        04020000
         BAL   R14,FREERPL             RETURN RPL                       04030000
                                                                        04040000
GRPLERR  DS    0H                                                       04050000
         SR    R1,R1                   ERROR, ZERO RPL ADDRESS          04060000
                                                                        04070000
GRPLEXIT DS    0H                                                       04080000
         LM    R2,R15,REGSAVE1+8       RESTORE CALLER'S REGISTERS       04090000
         BR    R14                     AND RETURN                       04100000
                                                                        04110000
         EJECT ,                                                        04120000
*---------------------------------------------------------------        04130000
*                                                                       04140000
*  ROUTINE:  FREERPL                                                    04150000
*                                                                       04160000
*  FUNCTION:                                                            04170000
*                                                                       04180000
*    THIS ROUTINE WILL FREE THE CURRENT RPL AND ZERO ITS PTR.           04190000
*                                                                       04200000
*                                                                       04210000
*  ENTRY:  N/A                                                          04220000
*                                                                       04230000
*  EXIT:   N/A                                                          04240000
*                                                                       04250000
*---------------------------------------------------------------        04260000
                                                                        04270000
FREERPL  DS    0H                                                       04280000
         STM   R0,R15,REGSAVE2         SAVE CALLER'S REGISTERS          04290000
                                                                        04300000
         L     R2,IDBRPL               GET RPL ADDRESS                  04310000
         XC    IDBRPL,IDBRPL           CLEAR RPL ADDRESS                04320000
                                                                        04330000
         STGRETN ADDR=(R2),            RETURN RPL STORAGE              +04340000
               LEN=$RPLLEN,                                            +04350000
               QH=ICTSTG                                                04360000
                                                                        04370000
         LM    R0,R15,REGSAVE2         RESTORE CALLER'S REGISTERS       04380000
         BR    R14                     RETURN                           04390000
                                                                        04400000
         EJECT ,                                                        04410000
*---------------------------------------------------------------        04420000
*  CONTANCT, LITERALS                                                   04430000
*---------------------------------------------------------------        04440000
                                                                        04450000
         LTORG ,                                                        04460000
                                                                        04470000
         EJECT ,                                                        04480000
         PRINT  NOGEN                                                   04490000
         ICVT  ,                                                        04500000
         ITASK ,                                                        04510000
         IFGRPL AM=VSAM                                                 04520000
$RPLLEN  EQU   *-IFGRPL                                                 04530000
         IFGACB AM=VSAM                                                 04540000
         PRINT  GEN                                                     04550000
                                                                        04560000
         END   ,                                                        04570000

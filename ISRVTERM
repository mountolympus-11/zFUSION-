ISRVTERM TITLE '- Server task Termination'                              00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE: ISRVTERM - Server Task Termination                           00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine will remove the server task extension                 00080000
*    block from the associated ITASKs and release the                   00090000
*    associate SERVERX storage.                                         00100000
*                                                                       00110000
* ON ENTRY:                                                             00120000
*                                                                       00130000
*    R1 Contains the address of the parameter list mapped by            00140000
*    the SRVPL dsect generated by $SERVER DSECT=YES.                    00150000
*                                                                       00160000
* ON EXIT:                                                              00170000
*                                                                       00180000
*    R15 Contains one of the following return codes:                    00190000
*                                                                       00200000
*        RC00 - Normal completion                                       00210000
*                                                                       00220000
*        RC20 - Request Error                                           00230000
*               RSN04 - ITASK address required                          00240000
*                                                                       00250000
* MODE:                                                                 00260000
*                                                                       00270000
*    TASK                                                               00280000
*    APF/NON-APF                                                        00290000
*    SUP/PROB                                                           00300000
*    AMODE 31, RMODE ANY                                                00310000
*                                                                       00320000
**<DOC-OFF>*****************************************************        00330000
                                                                        00340000
         EJECT ,                                                        00350000
****************************************************************        00360000
*                                                                       00370000
* MAINTENANCE:                                                          00380000
*                                                                       00390000
*   01/06/95 Ron Colmone          Par# 159456                           00400000
*            Initial Version                                            00410000
*                                                                       00420000
****************************************************************        00430000
                                                                        00440000
         EJECT ,                                                        00450000
         $SERVER DSECT=YES        TASKMGR PLIST                         00460000
                                                                        00470000
         EJECT ,                                                        00480000
         EQUS  ,                  GENERAL EQUATES                       00490000
*                                                                       00500000
         ABCODES ,                $ABEND CODES                          00510000
                                                                        00520000
         EJECT ,                                                        00530000
         #WORK LENGTH=512         READ/WRITE WORKAREA                   00540000
FLAGS    DS    XL1                FLAGS                                 00550000
$LOCKED  EQU   X'80'                DISP LOCK OBTAINED                  00560000
         #ENDWORK                 END OF WORKAREA                       00570000
                                                                        00580000
         EJECT ,                                                        00590000
ISRVTERM #ENTER BASE=R12,         ENTRY LINKAGE                        +00600000
               PREG=R8,                                                +00610000
               WAPASS=YES                                               00620000
                                                                        00630000
         USING SRVPL,R8           ESTABLISH ADDRESSABILITY              00640000
         USING ITASK,R10          ESTABLISH ADDRESSABILITY              00650000
                                                                        00660000
         EJECT ,                                                        00670000
****************************************************************        00680000
*                                                                       00690000
*  Remove Server Task Extension                                         00700000
*                                                                       00710000
****************************************************************        00720000
                                                                        00730000
         ICM   R7,15,SVPLTASK     ADDRESS OF SERVER ITASK               00740000
         BZ    ERR_TASK           ITASK ADDRESS REQUIRED                00750000
S        USING ITASK,R7           SERVER ITASK ADDRESSABILITY           00760000
                                                                        00770000
         L     R5,S.TSKOWNR       ADDRESS OF PARENT TASK                00780000
P        USING ITASK,R5           PARENT ITASK ADDRESSABILITY           00790000
                                                                        00800000
         L     R6,S.TSKSRV        ADDRESS OF SERVER EXTENSION           00810000
         USING SERVERX,R6         ADDRESSABILITY                        00820000
                                                                        00830000
*---------------------------------------------------------------        00840000
*  Acquire dispatcher lock                                              00850000
*---------------------------------------------------------------        00860000
         $SER  OBTAIN,DISP        OBTAIN DISP LOCK                      00870000
         B     *+4(R15)           BRANCH ON LOCK RETURN CODE            00880000
         B     LOCK_OBT           0 - LOCK OBTAINED                     00890000
         B     LOCK_HAV           4 - LOCK ALREADY OWNED                00900000
         B     ABN_LOCK           8 - LOCK OBTAIN FAILED                00910000
                                                                        00920000
LOCK_OBT DS    0H                                                       00930000
         OI    FLAGS,$LOCKED      INDICATE LOCK ACQUIRED                00940000
                                                                        00950000
LOCK_HAV DS    0H                                                       00960000
                                                                        00970000
*---------------------------------------------------------------        00980000
*  Remove Server block from parent task server queue                    00990000
*---------------------------------------------------------------        01000000
         LA    R3,P.TSKSRVQ       ADDRESS OF SERVER QUEUE               01010000
         SH    R3,=AL2(SRVNEXT-SERVERX)  OFFSET TO NEXT PTR             01020000
                                                                        01030000
         ICM   R0,15,SRVPREV      ADDRESS OF PREVIOUS SERVER            01040000
         BZ    *+6                NONE, ASSUME PARENT TASK ANCHOR       01050000
         LR    R3,R0              ADDRESS OF PREVIOUS BLOCK             01060000
Q        USING SERVERX,R3         ADDRESSABILITY (PREV)                 01070000
N        USING SERVERX,R4         ADDRESSABILITY (NEXT)                 01080000
                                                                        01090000
         ICM   R4,15,SRVNEXT      ADDRESS OF NEXT SERVER ENTRY          01100000
         BZ    *+10               NONE, SKIP UPDATE                     01110000
         MVC   N.SRVPREV,SRVPREV  SET ADDRESS OF PREV ENTRY             01120000
                                                                        01130000
         ST    R4,Q.SRVNEXT       SET ADDRESS OF NEXT SERVER            01140000
         XC    S.TSKSRV,S.TSKSRV  RESET SERVER ADDRESS                  01150000
                                                                        01160000
*---------------------------------------------------------------        01170000
*  Remove Server block from global server task queue                    01180000
*---------------------------------------------------------------        01190000
         LA    R3,ICTSRVQ         ADDRESS OF SERVER QUEUE               01200000
         SH    R3,=AL2(SRVNEXT-SERVERX)  OFFSET TO NEXT PTR             01210000
                                                                        01220000
         ICM   R0,15,SRVGPREV     ADDRESS OF PREVIOUS SERVER            01230000
         BZ    *+6                NONE, ASSUME PARENT TASK ANCHOR       01240000
         LR    R3,R0              ADDRESS OF PREVIOUS BLOCK             01250000
                                                                        01260000
         ICM   R4,15,SRVGNEXT     ADDRESS OF NEXT SERVER ENTRY          01270000
         BZ    *+10               NONE, SKIP UPDATE                     01280000
         MVC   N.SRVGPREV,SRVGPREV SET ADDRESS OF PREV ENTRY            01290000
                                                                        01300000
         ST    R4,Q.SRVGNEXT      SET ADDRESS OF NEXT SERVER            01310000
         DROP  Q,N                SERVERX (PREV,NEXT)                   01320000
                                                                        01330000
*---------------------------------------------------------------        01340000
*  Release server extension block storage                               01350000
*---------------------------------------------------------------        01360000
                                                                        01370000
         $RETSTOR (R6),OWNER=ITASK                                      01380000
                                                                        01390000
*---------------------------------------------------------------        01400000
*  Release dispatcher lock it acquired                                  01410000
*---------------------------------------------------------------        01420000
         TM    FLAGS,$LOCKED      WAS LOCK ACQUIRED                     01430000
         BZ    TERM_END           NO, ALL DONE                          01440000
                                                                        01450000
         $SER  RELEASE,DISP       RELEASE DISPATCHER LOCK               01460000
                                                                        01470000
TERM_END DS    0H                                                       01480000
         LA    R15,RC00           NORMAL COMPLETION                     01490000
         LA    R0,RSN00           NORMAL COMPLETION                     01500000
         B     RETURN             RETURN                                01510000
                                                                        01520000
         EJECT ,                                                        01530000
****************************************************************        01540000
*                                                                       01550000
*   CATASTROPHIC ERRORS                                                 01560000
*                                                                       01570000
****************************************************************        01580000
                                                                        01590000
ABN_LOCK DS    0H                                                       01600000
         $ABEND ABE_DISPLOCK,                                          +01610000
               SCOPE=ITASK,                                            +01620000
               TITLE='UNABLE TO OBTAIN DISPATCHER LOCK'                 01630000
                                                                        01640000
         EJECT ,                                                        01650000
****************************************************************        01660000
*                                                                       01670000
*   ERROR EXIT                                                          01680000
*                                                                       01690000
****************************************************************        01700000
                                                                        01710000
ERR_TASK DS    0H                                                       01720000
         LA    R0,RSN04           SERVER ITASK REQUIRED                 01730000
         B     RET_RC20           REQUEST ERROR                         01740000
                                                                        01750000
         EJECT ,                                                        01760000
****************************************************************        01770000
*                                                                       01780000
*   RETURN                                                              01790000
*                                                                       01800000
****************************************************************        01810000
                                                                        01820000
RET_RC20 DS    0H                                                       01830000
         LA    R15,RC20           REQUEST ERROR                         01840000
         B     RETURN                                                   01850000
                                                                        01860000
RETURN   DS    0H                                                       01870000
         #EXIT ,                  RETURN                                01880000
                                                                        01890000
         EJECT ,                                                        01900000
****************************************************************        01910000
*                                                                       01920000
*  CONSTANTS AND LITERALS                                               01930000
*                                                                       01940000
****************************************************************        01950000
                                                                        01960000
         LTORG ,                                                        01970000
                                                                        01980000
         PRINT NOGEN                                                    01990000
         ICVT  ,                                                        02000000
         ITASK ,                                                        02010000
         SERVERX ,                                                      02020000
                                                                        02030000
         END   ,                                                        02040000

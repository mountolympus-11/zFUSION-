ITSKPOST TITLE '- POST EVENT COMPLETION STATUS'                         00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE: ITSKPOST - Post event completion status                      00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine will post the completion of an event.  If             00080000
*    the specified was initialize with SCOPE=LOCAL,  the                00090000
*    completion code is set in the ECB, marked posted, and              00100000
*    the EPB is placed added to the readied events list for             00110000
*    the workunit.  If the EPB was initialized with SCOPE=GLOBAL,       00120000
*    the system POST service is used to post the event completion       00130000
*    status.  Authorized callers will use the Branch entry              00140000
*    linkage to the post service.                                       00150000
*                                                                       00160000
* ON ENTRY:                                                             00170000
*                                                                       00180000
*    R1 Contains the address of the parameter list mapped by            00190000
*    the TASKPL dsect generated by $TASK DSECT=YES.                     00200000
*                                                                       00210000
* ON EXIT:                                                              00220000
*                                                                       00230000
*    R15 Contains one of the following return codes:                    00240000
*                                                                       00250000
*        RC00 - Normal completion                                       00260000
*                                                                       00270000
*        RC12 - Service Error                                           00280000
*               R0 = RSN04 - EPB has been flushed (TASK terminated)     00290000
*                                                                       00300000
*        RC20 - Request Error                                           00310000
*               R0 = RSN04 - Invalid EPB address specified              00320000
*                                                                       00330000
* MODE:                                                                 00340000
*                                                                       00350000
*    TASK/SRB                                                           00360000
*    APF/NON-APF                                                        00370000
*    SUP/PROB                                                           00380000
*    AMODE 31, RMODE ANY                                                00390000
*                                                                       00400000
**<DOC-OFF>*****************************************************        00410000
                                                                        00420000
         EJECT ,                                                        00430000
****************************************************************        00440000
*                                                                       00450000
* MAINTENANCE:                                                          00460000
*                                                                       00470000
*   04/21/93 Ron Colmone                                                00480000
*            Initial Version                                            00490000
*                                                                       00500000
*   12/16/94 Ron Colmone          Par# 159456                           00510000
*            Added Support for TASKMGR SERVER                           00520000
*                                                                       00530000
****************************************************************        00540000
         EJECT ,                                                        00550000
         $TASK DSECT=YES          TASKMGR PLIST                         00560000
                                                                        00570000
         EJECT ,                                                        00580000
         @EPB  TYPE=DSECT         EVENT PROCESS BLOCK                   00590000
                                                                        00600000
         EJECT ,                                                        00610000
         XEPB  ,                  EXTENDED EPB                          00620000
                                                                        00630000
         EJECT ,                                                        00640000
         EQUS  ,                  GENERAL EQUATES                       00650000
                                                                        00660000
         EJECT ,                                                        00670000
         ABCODES ,                $ABEND CODES                          00680000
                                                                        00690000
         EJECT ,                                                        00700000
         #WORK LENGTH=512         READ/WRITE WORKAREA                   00710000
WRK256   DS    XL256              WORKAREA                              00720000
REGSAVE  DS    16F                REGISTER SAVE AREA                    00730000
FLAGS    DS    X                  GENERAL FLAGS                         00740000
$LOCKED  EQU   X'80'              ACQUIRED LOCK                         00750000
$RBTYPE  DS    X                  RBTYPE                                00760000
         #ENDWORK                 END OF WORKAREA                       00770000
                                                                        00780000
         EJECT ,                                                        00790000
ITSKPOST #ENTER BASE=R12,         ENTRY LINKAGE                        +00800000
               PREG=R8,                                                +00810000
               WAPASS=YES                                               00820000
                                                                        00830000
         USING TASKPL,R8          ESTABLISH ADDRESSABILITY              00840000
         USING ITASK,R10          ESTABLISH ADDRESSABILITY              00850000
         USING IPCB,R9            ESTABLISH ADDRESSABILITY              00860000
         L     R9,TSKPCBC         STANDARD ENVIRONMENT                  00870000
                                                                        00880000
*---------------------------------------------------------------        00890000
*  Verify that the POST request is being issued in standard             00900000
*  environment from the PRB.                                            00910000
*---------------------------------------------------------------        00920000
         USING PSA,0              ADDRESSABILITY                        00930000
         ICM   R4,15,PSATOLD      ADDRESS OF CURRENT TCB                00940000
         BZ    ABN_PENV           TASK POST NOT AVAIL IN SRBMODE        00950000
         USING TCB,R4             ADDRESSABILITY                        00960000
                                                                        00970000
         ICM   R4,15,TCBRBP       ADDRESS OF CURRENT RB                 00980000
         BZ    ABN_PENV           INVALID POST ENVIRONMENT              00990000
         USING RBBASIC,R4         ADDRESSABILITY                        01000000
                                                                        01010000
         MVC   $RBTYPE,RBSTAB1    COPY RB STATUS BYTE                   01020000
         NI    $RBTYPE,RBFTP      RESET NON-TYPE BITS                   01030000
         CLI   $RBTYPE,RBFTPRB    REQUEST ISSUED FROM PRB               01040000
         BNE   ABN_PENV           NO, CATASTROPHIC ERROR                01050000
         DROP  R4                 RB                                    01060000
                                                                        01070000
         EJECT ,                                                        01080000
****************************************************************        01090000
*                                                                       01100000
*  POST EVENT COMPLETION                                                01110000
*                                                                       01120000
****************************************************************        01130000
POST     DS    0H                                                       01140000
         ICM   R6,15,TPLEPB       ADDR OF EVENT PROCESS BLOCK           01150000
         BZ    ERR_EPB            ERROR, EPB REQUIRED                   01160000
         N     R6,=F'-2'          CHANGE EPB TOKEN TO ADDR              01170000
         USING EPB,R6             ESTABLISH ADDRESSABILITY              01180000
X        USING XEPB,R6            ESTABLISH ADDRESSABILITY              01190000
                                                                        01200000
         L     R3,TPLPCODE        GET POST CODE                         01210000
         LA    R4,EPBECB          ADDR OF ECB                           01220000
         TM    EPBFLGS,EPB$RMT    REMOTE ECB?                           01230000
         BZ    *+8                CONTINUE                              01240000
         L     R4,EPBECB          GET REMOTE ECB ADDRESS                01250000
                                                                        01260000
         EJECT ,                                                        01270000
*---------------------------------------------------------------        01280000
* IF EPB IS AN XEPB, THEN DETERMINE IF REQUESTOR TASK HAS               01290000
* TERMINATED.  IF SO, MARK XEPB AS DELETED AND SKIP POST.               01300000
*---------------------------------------------------------------        01310000
         TM    EPBFLGS,EPB$XND    EXTENDED EPB?                         01320000
         BZ    POST_TRA           NO, POST REQUESTOR                    01330000
                                                                        01340000
         TM    X.XEPBFLGS,XEPB$RAB  REQUESTOR TERMINATED                01350000
         BZ    POST_XEP           NO, CHECK FOR XEPB PROCESSOR          01360000
         ICM   R0,15,X.XEPBPTSK   SINGLE POSTER                         01370000
         BNZ   POST_DEL           YES, MARK XEPB AS DELETED             01380000
                                                                        01390000
*---------------------------------------------------------------        01400000
* If current PCB was registered as the processor of this XEPB,          01410000
* then decrement the processor/requestor XEPB use count in the          01420000
* PCB.                                                                  01430000
*---------------------------------------------------------------        01440000
POST_XEP DS    0H                                                       01450000
         LTR   R9,R9              PROCESS MODE?                         01460000
         BZ    POST_TRA           NO, CONTINUE WITH POST                01470000
         C     R9,X.XEPBPPCB      CURRENT PROCESS RESP FOR POST         01480000
         BNE   POST_TRA           NO, CONTINUE WITH POST                01490000
                                                                        01500000
         L     R1,PCBXUSEC        GET CURRENT XEPB USE COUNT            01510000
         LR    R0,R1              COPY USE COUNT                        01520000
         BCTR  R0,0               DECREMENT                             01530000
         CS    R1,R0,PCBXUSEC     UPDATE USE COUNT                      01540000
         BNE   *-8                RETRY                                 01550000
                                                                        01560000
         EJECT ,                                                        01570000
*---------------------------------------------------------------        01580000
* IF EVENT PROCESS BLOCK (EPB) INDICATES THAT THE COMPLETED             01590000
* EVENT IS AN INTRA TASK EVENT,  THEN PLACE THE POST COMPLETION         01600000
* CODE IN THE EPB AND CALL THE FUNCTION TO MAKE THE ASSOCIATED          01610000
* PROCESS READY.                                                        01620000
*---------------------------------------------------------------        01630000
POST_TRA DS    0H                                                       01640000
         TM    EPBFLGS,EPB$NTRA   INTRA TASK EVENT                      01650000
         BZ    POST_REQ           NO, ISSUE STANDARD POST               01660000
                                                                        01670000
         LA    R2,EPBECB          ASSUME INTERNAL ECB                   01680000
         TM    EPBFLGS,EPB$RMT    REMOTE ECB?                           01690000
         BZ    *+8                NO, CONTINUE                          01700000
         L     R2,EPBECB          RETRIVE REMOTE EPB ADDRESS            01710000
                                                                        01720000
         NI    0(R2),X'7F'        RESET WAIT INDICATOR                  01730000
         OI    0(R2),X'40'        FAST POST                             01740000
         STCM  R3,7,1(R2)         SET COMPLETION STATUS                 01750000
                                                                        01760000
         @CALL ITSKREDY,((R2),0),WKA=WRK256,                     159456+01770000
               MF=(E,MFE_LIST)                                   159456 01780000
                                                                        01790000
         B     POST_RET           RETURN                                01800000
                                                                        01810000
         EJECT ,                                                        01820000
*---------------------------------------------------------------        01830000
* IF RUNNING AUTHORIZED,  THE SERIALIZATION SERVICE USES THE            01840000
* MVS LOCAL LOCK TO OBTAIN SERIALIZATION.  LINKAGE=SYSTEM DOES          01850000
* NOT SUPPORT A CALLER HOLDING THE LOCAL LOCK, THEREFORE BRANCH         01860000
* ENTRY POST IS USED WHEN RUNNING AUTHORIZED, SINCE IT REQUIRES         01870000
* THAT THE LOCAL LOCAL BE HELD.                                         01880000
*---------------------------------------------------------------        01890000
POST_REQ DS    0H                                                       01900000
         TM    EPBFLGS,EPB$FLSH   WAITING PROCESS HAS TERMINATED?       01910000
         BZ    POST_GO            NO, THEN CONTINUE WITH POST           01920000
         TM    EPBFLGS,EPB$XND    IS EPB AN XEPB?                       01930000
         BO    POST_DEL           YES, MARK XEPB AS DELETED             01940000
                                                                        01950000
POST_GO  DS    0H                                                       01960000
         TM    0(R4),X'40'        ECB ALREADY POSTED?                   01970000
         BO    POST_RET           YES, BYPASS POST                      01980000
         TM    ICTSTAT2,ICT2$SUP  RUNNING AUTHORIZED?                   01990000
         BO    POST_SUP           YES, USE BRANCH ENTRY                 02000000
                                                                        02010000
*===============================================================        02020000
*  THE FOLLOWING CALL TO POST ORIGINALLY HAD LINKAGE=SVC.               02030000
*  IT WAS CHANGED TO LINKAGE=SYSTEM FOR A TEST TO SEE IF THIS           02040000
*  HAS AN EFFECT ON LOCK OF MVSLOCK INCREASING AND THROUGHPUT           02050000
*  DECREASING.                                                          02060000
*===============================================================        02070000
         POST  (R4),(R3),         POST EVENT COMPLETION                +02080000
               LINKAGE=SYSTEM                                           02090000
         B     POST_RET                                                 02100000
                                                                        02110000
POST_SUP DS    0H                                                       02120000
         TM    TPLCFLGS,TPLC$LLH  LOCAL LOCK HELD BY CALLER      159456 02130000
         BO    LOCK_HAV           YES,  NO NEED TO REACQUIRE     159456 02140000
                                                                        02150000
         $SER  OBTAIN,LOCAL       ACQUIRE LOCAL LOCK                    02160000
         B     *+4(R15)           BRANCH ON LOCK RETURN CODE            02170000
         B     LOCK_OBT           0 - LOCK OBTAINED                     02180000
         B     LOCK_HAV           4 - LOCK ALREADY OWNED                02190000
         B     ABN_LOCK           8 - UNABLE TO ACQUIRE LOCK            02200000
                                                                        02210000
LOCK_OBT DS    0H                                                       02220000
         OI    FLAGS,$LOCKED      INDICATE LOCK ACQUIRED                02230000
                                                                        02240000
LOCK_HAV DS    0H                                                       02250000
         MODESET EXTKEY=ZERO,     SWITCH TO KEY ZERO                   +02260000
               SAVEKEY=(2)                                              02270000
                                                                        02280000
         STM   R0,R15,REGSAVE     SAVE REGISTERS                        02290000
                                                                        02300000
         POST  (R4),(R3),         POST EVENT COMPLETION                +02310000
               LINKAGE=BRANCH                                           02320000
                                                                        02330000
         LM    R0,R15,REGSAVE     RESTORE REGISTERS                     02340000
                                                                        02350000
         MODESET KEYADDR=(2)      RESET KEY                             02360000
                                                                        02370000
         TM    FLAGS,$LOCKED      LOCK ACQUIRED?                        02380000
         BZ    POST_RET           NO, RETURN                            02390000
         $SER  RELEASE,LOCAL      RELEASE LOCAL LOCK                    02400000
         B     POST_RET           RETURN                                02410000
                                                                        02420000
         EJECT ,                                                        02430000
*----------------------------------------------------------------       02440000
*  POST REQUEST IS FOR AN XEPB WHERE THE REQUESTING PROCESS HAS         02450000
*  ALREADY TERMINATED.  MARK XEPB TO BE DELETED.                        02460000
*----------------------------------------------------------------       02470000
POST_DEL DS    0H                                                       02480000
         $XEPB LDELETE,XEPB=X.XEPB   MARK XEPB AS DELETE                02490000
                                                                        02500000
POST_RET DS    0H                                                       02510000
         LA    R15,RC00           NORMAL COMPLETION                     02520000
         B     RETURN             RETURN                                02530000
         DROP  R6                 EPB                                   02540000
                                                                        02550000
         EJECT ,                                                        02560000
****************************************************************        02570000
*                                                                       02580000
*   CATASTROPHIC ERRORS                                                 02590000
*                                                                       02600000
****************************************************************        02610000
                                                                        02620000
ABN_LOCK DS    0H                                                       02630000
         $ABEND ABE_LCLLOCK,                                           +02640000
               SCOPE=ITASK,                                            +02650000
               TITLE='UNABLE TO ACQUIRE MVS LOCAL LOCK'                 02660000
                                                                        02670000
ABN_PENV DS    0H                                                       02680000
         $ABEND ABE_POSTENV,                                           +02690000
               SCOPE=ITASK,                                            +02700000
               TITLE='INVALID ENVIRONMENT FOR TASK POST'                02710000
                                                                        02720000
         EJECT ,                                                        02730000
****************************************************************        02740000
*                                                                       02750000
*   ERROR EXIT                                                          02760000
*                                                                       02770000
****************************************************************        02780000
                                                                        02790000
ERR_PTRM DS    0H                                                       02800000
         LA    R0,RSN04           PROCESS HAS TERMINATED                02810000
         B     RET_RC12           REQUEST ERROR                         02820000
                                                                        02830000
ERR_EPB  DS    0H                                                       02840000
         LA    R0,RSN04           EPB REQUIRED FOR REQUEST              02850000
         B     RET_RC20           CALLING SEQUENCE ERROR                02860000
                                                                        02870000
         EJECT ,                                                        02880000
****************************************************************        02890000
*                                                                       02900000
*   RETURN                                                              02910000
*                                                                       02920000
****************************************************************        02930000
                                                                        02940000
RET_RC12 DS    0H                                                       02950000
         LA    R15,RC12           ABNORMAL RETURN (SERVICE FAIL)        02960000
         B     RETURN                                                   02970000
                                                                        02980000
RET_RC20 DS    0H                                                       02990000
         LA    R15,RC20           PARAMETER ERROR                       03000000
         B     RETURN                                                   03010000
                                                                        03020000
RETURN   DS    0H                                                       03030000
         #EXIT ,                  RETURN                                03040000
                                                                        03050000
         EJECT ,                                                        03060000
****************************************************************        03070000
*                                                                       03080000
*  CONSTANTS AND LITERALS                                               03090000
*                                                                       03100000
****************************************************************        03110000
                                                                        03120000
         LTORG ,                                                        03130000
                                                                        03140000
         PRINT NOGEN                                                    03150000
         ICVT  ,                                                        03160000
         ITASK ,                                                        03170000
         IPCB  ,                                                        03180000
                                                                        03190000
         IHAPSA ,                                                       03200000
         CVT   DSECT=YES,LIST=NO                                        03210000
         IKJTCB ,                                                       03220000
         IHARB ,                                                        03230000
         PRINT GEN                                                      03240000
                                                                        03250000
         END   ,                                                        03260000

IDSSPCXT TITLE 'DATASPACE SERVICES - SPACE EXTEND'                      00010000
***************************************************************         00020000
*                                                                       00030000
*   READ / WRITE WORKING STORAGE AREA                                   00040000
*                                                                       00050000
***************************************************************         00060000
WORKAREA DSECT                                                          00070000
                                                                        00080000
         @WORK PLIST=(MFE_LIST,80)                                      00090001
                                                                        00100001
         ORG   MFE_LIST                                                 00110001
         DSPSERV PLISTVER=1,MF=(L,MFL_DSP,0F)                           00120001
         ORG   ,                                                        00130001
                                                                        00140001
FLAGS    DS    X                  LOCAL FLAGS                           00150000
F$ESTAE  EQU   X'80'                 ESTAE ESTABLISHED                  00160000
F$FAIL   EQU   X'40'                 DSPSERV FAILURE                    00170000
                                                                        00180000
DSPRETC  DS    F                  DSPSERV RETCODE                       00190000
SIZE     DS    F                  SIZE OF EXTENSION (BYTES)             00200000
PAGES    DS    F                  SIZE OF EXTENSION (PAGES) REQUESTED   00210000
NEWPAGES DS    F                  SIZE OF EXTENSION (PAGES) ACQUIRED    00220000
                                                                        00230000
RCVYPARM DS    0A                                                       00240000
RCVYBASE DS    A                  PROGRAM BASE                          00250000
RCVYWKA  DS    A                  ADDR OF WORKAREA                      00260000
                                                                        00270000
ESTAEMFL ESTAEX *-*,CT,TERM=YES,PURGE=NONE,ASYNCH=YES,MF=L              00280000
WORKLEN  EQU   *-WORKAREA         WORKAREA LENGTH                       00290000
                                                                        00300001
         EJECT ,                                                        00310000
         SPCBLOCK ,                                                     00320000
                                                                        00330001
         EJECT ,                                                        00340000
         OIE  ,                                                         00350000
                                                                        00360001
         EJECT ,                                                        00370000
         $TOKEN ,                                                       00380000
                                                                        00390001
         EJECT ,                                                        00400000
         SPCEQUS ,                                                      00410000
                                                                        00420001
         EJECT ,                                                        00430000
         EQUS  LINKAGE=VCON                                             00440000
                                                                        00450001
         EJECT ,                                                        00460000
**<DOC-ON>*****************************************************         00470001
*                                                                       00480000
* ROUTINE: IDSSPCXT - SPACE EXTEND (MVS/ESA)                            00490000
*                                                                       00500000
* DESCRIPTION:                                                          00510000
*                                                                       00520000
*    THIS ROUTINE IS USED TO EXPANED THE SIZE OF AN $SPACE              00530000
*    DATASPACE USING THE MVS/ESA DSPSERV EXTEND FUNCTION.               00540000
*    RECALL THAT SPACES ARE EXTENEDED BY APPENDING VIRTUAL              00550000
*    STORAGE AT THE TOP END OF THE DATASPACE.  IDSMAPIN IS              00560000
*    CALLED TO REBUILD THE SPACE STORAGE MAP TO REFLECT THE             00570000
*    NEWLY ACQUIRED SPACE EXTENTION.                                    00580000
*                                                                       00590000
* NOTES:                                                                00600000
*                                                                       00610000
*    AN ESTAE EXIT IS USED TO TRAP S01D ABENDS THAT RESULT              00620000
*    FROM INVALID DSPSERV REQUESTS THAT CAN BE ISSUED IF                00630000
*    THE SPACE EXTEND REQUEST IS IN ERROR.                              00640000
*                                                                       00650000
*                                                                       00660000
* ON ENTRY:                                                             00670000
*                                                                       00680000
*    R1 POINTS TO AN OS/VS PARAMETER LIST CONTAINING                    00690000
*                                                                       00700000
*        +00 - ADDR OF THE SPACE OR OBJECT TOKEN                        00710000
*        +04 - SIZE (BYTES) OF EXTENSION REQUIRED                       00720000
*                                                                       00730000
*    A/R10 - ADDRESS OF THE STORAGE SPACE BLOCK (SPCBLOCK)              00740000
*                                                                       00750000
*                                                                       00760000
* ON EXIT:                                                              00770000
*                                                                       00780000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES                     00790000
*                                                                       00800000
*        RC00 - NORMAL COMPLETION                                       00810000
*        RC04 - SPACE CANNOT BE EXTENDED                                00820000
*        RC08 - DSPSERV REQUEST FAILURE                                 00830000
*                                                                       00840000
*               R1 - DSPSERV RETCODE ORIGINALLY IN R15                  00850000
*               R0 - DSPSERV RSNCODE                                    00860000
*                                                                       00870000
*        RC12 - UNABLE TO REBUILD SPACE MAP                             00880000
*        RC16 - INVALID REQUEST                                         00890000
*                                                                       00900000
**<DOC-OFF>****************************************************         00910001
                                                                        00920001
         EJECT ,                                                        00930000
IDSSPCXT @ENTER WORKA=(WORKAREA,WORKLEN)                                00940000
                                                                        00950000
         LAE   R1,0(R1,0)         NORMALIZE PLIST                       00960000
         LM    R8,R9,0(R1)        FETCH PASSED PARAMETERS               00970000
*                                 R8 <== ADDR OF $SPACE TOKEN           00980000
*                                 R9 <== EXTENSION SIZE IN BYTES        00990000
                                                                        01000000
         LAE   R8,0(R8,0)         RESIDES IN PRIMARY                    01010000
         USING $TOKEN,R8          ADDRESSABILITY                        01020000
         CLC   $TOKTAG,=CL8'OBJTOKEN'                                   01030000
         BE    VALIDTOK                                                 01040000
         CLC   $TOKTAG,=CL8'SPCTOKEN'                                   01050000
         BNE   ERR_REQ                                                  01060000
                                                                        01070000
VALIDTOK DS    0H                                                       01080000
         L     R10,$SPCBASE       ESTABLISH SPACE ACCESS WINDOW         01090000
         USING SPCBLOCK,R10                                             01100000
         LAM   R10,R10,$ALET                                            01110000
                                                                        01120000
         TM    SPC_FLAGS,SPC_$SERIAL  MULTITASKED ENVIRONMENT           01130000
         BO    ERR_TASK          ONLY OWNER COULD SUCCEED               01140000
                                                                        01150000
*--------------------------------------------------------------         01160000
*   TERSE VALIDATION OF EXTENSION SIZE - CONVERT FOR OUR USE            01170000
*--------------------------------------------------------------         01180000
         LTR   R6,R9              VALIDATE EXTENSION SIZE               01190000
         BNP   ERR_REQ            REJECT                                01200000
                                                                        01210000
         L     R15,SPC_ALU_POWER2                                       01220000
         A     R6,SPC_ALU_SIZE    CONVERT REQUEST TO ALU'S              01230000
         BCTR  R6,0                                                     01240000
         SRL   R6,0(R15)                                                01250000
         A     R6,SPC_STGMAP_OIE+(OIESTLEN-OIE)                         01260000
         LA    R6,#MAP_ALUS_BYTE-1(,R6)                                 01270000
         SLL   R6,0(R15)          BACK TO BYTES                         01280000
                                                                        01290000
         AL    R6,=F'4095'        CONVERTING TO PAGES                   01300000
         SRL   R6,12              NUMBER OF PAGES                       01310000
         ST    R6,PAGES           SAVED                                 01320000
                                                                        01330000
*--------------------------------------------------------------         01340000
*   ESTABLISH ESTAE                                                     01350000
*--------------------------------------------------------------         01360000
         LA    R0,IDSSPCXT        PROGRAM BASE                          01370000
         ST    R0,RCVYBASE        SAVE FOR ESTAE RTN                    01380000
         ST    R13,RCVYWKA        WORKAREA ADDR                         01390000
                                                                        01400000
         MVC   ESTAEMFL($ESTAELN),$ESTAE                                01410000
                                                                        01420000
         ESTAEX TRAP01D,PARAM=RCVYPARM,MF=(E,ESTAEMFL)                  01430000
                                                                        01440000
         OI    FLAGS,F$ESTAE      INDICATE ESTAE REMOVED                01450000
                                                                        01460000
*--------------------------------------------------------------         01470000
*   EXTEND DATASPACE                                                    01480000
*--------------------------------------------------------------         01490000
         DSPSERV EXTEND,          EXTEND SPACE                         X01500000
               STOKEN=$STOKEN,    $SPACE TOKEN                         X01510000
               VAR=YES,           EXACTLY WHAT IS REQUESTED OR FAIL    X01520000
               BLOCKS=PAGES,      EXTEND BY SPECIFIED # PAGES          X01530000
               NUMBLKS=NEWPAGES,  BUT ACCEPT SMALLER ALLOCATION        X01540000
               MF=(E,MFL_DSP)     MAINTAIN REENTRANCY                   01550000
                                                                        01560000
         ST    R15,DSPRETC        PRESERVE COMPLETION CODE              01570000
                                                                        01580000
*--------------------------------------------------------------         01590000
*   DELETE ESTAE, ANALYZE COMPLETION                                    01600000
*--------------------------------------------------------------         01610000
RESUME   DS    0H                                                       01620000
         ESTAEX 0                 REVOKE ESTAE                          01630000
                                                                        01640000
         NI    FLAGS,FF-F$ESTAE   INDICATE ESTAE REMOVED                01650000
                                                                        01660000
         TM    FLAGS,F$FAIL       FAILURE IN DSPSERV?                   01670000
         BO    ERR_ABN            CONVERT TO RETCODE IF SO              01680000
         CLC   DSPRETC,=A(RC04)   SPACE EXTENDED?                       01690000
         BH    ERR_DSP            FAIL IF NOT                           01700000
                                                                        01710000
*--------------------------------------------------------------         01720000
*   RECONSTRCT SPACE MAP                                                01730000
*--------------------------------------------------------------         01740000
         ICM   R3,15,NEWPAGES     EXTENSION PAGES                       01750000
         BNP   ERR_DSP            FAIL IF NOTHING AVAILABLE             01760000
         AL    R3,SPC_PAGES       PAGES BEFORE EXTENSION                01770000
         ST    R3,SPC_PAGES       SAVE NEW PAGE COUNT                   01780000
                                                                        01790000
         SLL   R3,12              TOTAL SIZE IN BYTES                   01800000
         ST    R3,SPC_SIZE        SAVE NEW SPACE SIZE                   01810000
                                                                        01820000
         @CALL IDSMAPIN           RESULT DERIVED FROM PREFIX            01830000
         LTR   R15,R15            WOULD BE UGLY, BUT SPACEMAP           01840000
         BNZ   ERR_INIT           OK AS IS AND SPACE SIZES ARE ACCURATE 01850000
                                                                        01860000
*--------------------------------------------------------------         01870000
*   RETURN COMPLETION STATUS TO CALLER                                  01880000
*--------------------------------------------------------------         01890000
         LA    R15,RC00           NORMAL COMPLETION                     01900000
         SR    R0,R0                                                    01910000
         SR    R1,R1                                                    01920000
         B     RET                                                      01930000
                                                                        01940000
ERR_TASK DS    0H                 MULTITASKING ENVIROMENT               01950000
         LA    R15,RC04           IDENTIFY FAILURE                      01960000
         SR    R0,R0                                                    01970000
         SR    R1,R1                                                    01980000
         B     RET                                                      01990000
                                                                        02000000
ERR_DSP  DS    0H                 DSPSERV SERVICE FAILED                02010000
         SR    R0,R0                                                    02020000
         LR    R1,R15             PRESERVE RETCODE                      02030000
         LA    R15,RC08           IDENTIFY DSPSERV FAILURE              02040000
         B     RET                                                      02050000
                                                                        02060000
ERR_ABN  DS    0H                 DSPSERV SERVICE ABENDED               02070000
         SR    R0,R0                                                    02080000
         LA    R1,X'01D'          IDENTIFY COMPLETION AS ABEND          02090000
         LA    R15,RC08           IDENTIFY DSPSERV FAILURE              02100000
         B     RET                                                      02110000
                                                                        02120000
ERR_INIT DS    0H                 UNABLE TO REBUILD SPACE MAP           02130000
         SR    R0,R0                                                    02140000
         SR    R1,R1                                                    02150000
         LA    R15,RC12                                                 02160000
         B     RET                                                      02170000
                                                                        02180000
ERR_REQ  DS    0H                 INVALID REQUEST                       02190000
         SR    R0,R0                                                    02200000
         SR    R1,R1                                                    02210000
         LA    R15,RC16           PER CONVENTION                        02220000
                                                                        02230000
*--------------------------------------------------------------         02240000
*   RELEASE ESTAE, RETURN COMPLETION STATUS TO CALLER                   02250000
*--------------------------------------------------------------         02260000
RET      DS    0H                 RETURN TO CALLER                      02270000
         @EXIT ,                                                        02280000
                                                                        02290000
         EJECT ,                                                        02300000
***************************************************************         02310000
*                                                                       02320000
*   TRAP DSPSERV ABENDS                                                 02330000
*                                                                       02340000
***************************************************************         02350000
TRAP01D  DS    0H                                                       02360000
         USING *,R15                                                    02370000
         STM   R14,R12,12(R13)    PRESERVE SYSTEM REGS                  02380000
         C     R0,=F'12'          SDWA AVAIL?                           02390000
         BNE   TRAPCONT           RECOVERY IMPOSSIBLE IF NOT            02400000
         SR    R15,R15            REQUEST PERCOLATION                   02410000
         BR    R14                                                      02420000
                                                                        02430000
         USING SDWA,R1            ESTAE EXIT LINKAGE                    02440000
                                                                        02450000
TRAPCONT DS    0H                                                       02460000
         L     R2,0(,R1)          FETCH PARM PTR FROM SDWA (FBA OFFSET) 02470000
         L     R2,0(,R2)          PTR THEN ALET                         02480000
         L     R12,0(,R2)         PROGRAM BASE                          02490000
         L     R3,4(,R2)          PROGRAM PRIMARY WORKAREA              02500000
         USING IDSSPCXT,R12       USE STANDARD BASE                     02510000
         DROP  R15                                                      02520000
                                                                        02530000
W        USING WORKAREA,R3        WORKAREA ADDRESSABILITY               02540000
         OI    W.FLAGS,F$FAIL     INDICATE FAILURE                      02550000
         LA    R4,RESUME          RECOVERY ROUTINE EPA                  02560000
                                                                        02570000
         SETRP RC=4,WKAREA=(1),RETADDR=(4),RETREGS=YES,REGS=(2,12),    X02580000
               DUMP=NO                                                  02590000
                                                                        02600000
         DROP  W,R1               WORKAREA, SDWA                        02610000
                                                                        02620000
         EJECT ,                                                        02630000
***************************************************************         02640000
*                                                                       02650000
*   READ ONLY CONSTANTS, ETC.                                           02660000
*                                                                       02670000
***************************************************************         02680000
$ESTAE   ESTAEX *-*,CT,TERM=YES,PURGE=NONE,ASYNCH=YES,MF=L              02690000
$ESTAELN EQU   *-$ESTAE                                                 02700000
                                                                        02710000
         LTORG ,                                                        02720000
                                                                        02730000
         PRINT NOGEN                                                    02740000
         IHASDWA ,                                                      02750000
         END   ,                                                        02760000

IVTMXREL TITLE 'INTEGRATOR - VTAM RELREQ EXIT'                          00010000
**<DOC-ON>************************************************************* 00020000
*                                                                       00030000
* ROUTINE: IVTMXREL - INTEGRATOR VTAM RELREQ EXIT'                      00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THE RELREQ EXIT IS DRIVEN BY VTAM WHEN THERE IS A REQUEST          00080000
*    TO ESTABLISH A SESSION WITH AN LU THAT IS CURRENTLY LOGGED         00090000
*    ON TO THE INTEGRATOR.                                              00100000
*                                                                       00110000
*    A RELREQ WORK ELEMENT IS CREATED AND QUEUED TO THE VTAM            00120000
*    TASK FOR TASK-MODE PROCESSING OF THE REQUEST.                      00130000
*                                                                       00140000
* ON ENTRY:                                                             00150000
*                                                                       00160000
*    BAKR IS USED TO SAVE REGISTERS                                     00170000
*                                                                       00180000
*    R15 = ENTRY POINT ADDRESS                                          00190000
*    R14 = RETURN ADDRESS                                               00200000
*    R01 = PARAMETER LIST ADDRESS                                       00210000
*          +00(4): ADDRESS OF ACB                                       00220000
*          +04(4): ADDRESS OF 8-BYTE SYMBOLIC NAME OF THE               00230000
*                  REQUESTED LU                                         00240000
*          +08(4): RESERVED (UNUSED)                                    00250000
*          +0C(4): RESERVED (UNUSED)                                    00260000
*          +10(4): RESERVED (UNUSED)                                    00270000
*          +14(4): RESERVED (UNUSED)                                    00280000
*                                                                       00290000
* ON EXIT:                                                              00300000
*                                                                       00310000
*    R15 = 0                                                            00320000
*    R00 = 0                                                            00330000
*    R01 = 0                                                            00340000
*                                                                       00350000
*    ALL OTHER REGISTERS ARE RESTORED BY PR.                            00360000
*                                                                       00370000
**<DOC-OFF>************************************************************ 00380000
                                                                        00390000
         EJECT ,                                                        00400000
*********************************************************************** 00410000
*                                                                       00420000
* MAINTENANCE:                                                          00430000
*                                                                       00440000
*   08/01/93 RANDY WITEK                                                00450000
*                                                                       00460000
*********************************************************************** 00470000
         EQUS  ,                  GENERAL EQUATES                       00480000
                                                                        00490000
RICVT    EQU   R11                INTEGRATOR CVT POINTER                00500000
RITASK   EQU   R10                ASSOCIATED ITASK POINTER              00510000
RIVTAM   EQU   R9                 INTEGRATOR VTAM CVT POINTER           00520000
RIACB    EQU   R8                 ASSOCIATED IACB POINTER               00530000
RIRPL    EQU   R7                 ASSOCIATED RPL/IRPL POINTER           00540000
RISESS   EQU   R6                 ASSOCIATED ISESS POINTER              00550000
RIWE     EQU   R5                 WORK ELEMENT POINTER                  00560000
                                                                        00570000
         USING ICVT,RICVT         ESTABLISH ADDRESSIBILTY               00580000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSIBILTY               00590000
         USING ITASK,RITASK       ESTABLISH ADDRESSIBILTY               00600000
         USING IACB,RIACB         ESTABLISH ADDRESSIBILTY               00610000
         USING IRPL,RIRPL         ESTABLISH ADDRESSIBILTY               00620000
         USING IWEVTAM,RIWE       ESTABLISH ADDRESSIBILTY               00630000
         USING ISESS,RISESS       ESTABLISH ADDRESSIBILTY               00640000
                                                                        00650000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00660000
         DS    0D                                                       00670000
RCVPARMS DS    XL(L'IVR)          IVTAMRPA STORAGE                      00680000
ESTAEMFL DS    XL(L'ESTAEXPL)     PARMLIST CONSTRUCTION                 00690000
FRRPARM  DS    A                  RETURN AREA FOR FRR PARM ADDRESS      00700000
SAVER3   DS    F                  TEMPORARY SAVE AREA                   00710000
RETR15   DS    F                  RETURN CODE VALUE                     00720000
RETR0    DS    F                  RETURN REGISTER 0                     00730000
RETR1    DS    F                  RETURN REGISTER 1                     00740000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00750000
FLAG     DS    X                                                        00760000
FLESTAEX EQU   X'08'              ESTAEX ACTIVE                         00770000
FLFRR    EQU   X'04'              FRR    ACTIVE                         00780000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00790000
                                                                        00800000
IVTMXREL #VTENTER BASE=R12,       VTAM EXIT ROUTINE LINKAGE            +00810000
               AMODE=31,                                               +00820000
               RMODE=ANY,                                              +00830000
               PREG=(R3),                                              +00840000
               EXITYPE=PLIST                                            00850000
                                                                        00860000
         USING IVTAMRPA,RCVPARMS  ESTABLISH ADDRESSIBILITY              00870000
                                                                        00880000
*---------------------------------------------------------------------- 00890000
* ESTABLISH RECOVERY ENVIRONMENT                                        00900000
*---------------------------------------------------------------------- 00910000
                                                                        00920000
         ST    R3,SAVER3          SAVE PARM REG                         00930000
         LA    R15,IVTXRTRY       RETRY ROUTINE ADDRESS                 00940000
         ST    R15,IVRRETAD       SET RETRY ROUTINE ADDRESS             00950000
         LA    R15,IVTAMRPA       PARAMETERS ADDRESS                    00960000
         ST    R15,IVRRPA@        SET ADDRESS FOR FRR                   00970000
         L     R0,=F'-1'          SHOW REGS RESTORED FROM PARM AREA     00980000
         STM   R0,R15,IVRR00      SAVE RETRY REGISTERS                  00990000
         MVC   IVRMOD,=CL8'IVTMTASK'                                    01000000
         MVC   IVRCSECT,=CL8'IVTMXREL'                                  01010000
         MVC   IVRFRR,=CL8'IVTMXRCV'                                    01020000
         MVC   IVRTYPE,=CL8'ESTAEX'                                     01030000
         L     R3,=V(IVTMXRCV)    ADDR OF VTAM EXIT RECOVERY ROUTINE    01040000
         ICM   R0,15,PSATOLD      SRB MODE?                             01050000
         BZ    ESTFRR             BRANCH IF YES                         01060000
                                                                        01070000
         MVC   ESTAEMFL(L'ESTAEXPL),ESTAEXL                             01080000
                                                                        01090000
         ESTAEX (R3),                                                  +01100000
               CT,                                                     +01110000
               PARAM=RCVPARMS,                                         +01120000
               TERM=YES,                                               +01130000
               MF=(E,ESTAEMFL)    ESTABLISH RECOVERY                    01140000
                                                                        01150000
         OI    FLAG,FLESTAEX      RECOVERY ENVIRONMENT ESTABLISHED      01160000
         B     RECOVSET           AND CONTINUE                          01170000
                                                                        01180000
ESTFRR   DS    0H                                                       01190000
                                                                        01200000
         MVC   IVRTYPE,=CL8'FRR'                                        01210000
                                                                        01220000
         MODESET EXTKEY=ZERO,                                          +01230000
               SAVEKEY=(2)        SET KEY ZERO                          01240000
                                                                        01250000
         SETFRR A,                                                     +01260000
               FRRAD=(R3),                                             +01270000
               WRKREGS=(14,15),                                        +01280000
               PARMAD=FRRPARM     ESTABLISH RECOVERY                    01290000
                                                                        01300000
         L     R1,FRRPARM         PARM AREA FOR FRR                     01310000
         MVC   0(12,R1),RCVPARMS  SET TYPE & PARM AREA POINTER          01320000
                                                                        01330000
         MODESET KEYADDR=(2)      RESTORE PREVIOUS KEY                  01340000
                                                                        01350000
         OI    FLAG,FLFRR         RECOVERY ENVIRONMENT ESTABLISHED      01360000
         B     RECOVSET           AND CONTINUE                          01370000
                                                                        01380000
RECOVSET DS    0H                                                       01390000
                                                                        01400000
         L     R3,SAVER3          RESTORE PARM REG                      01410000
                                                                        01420000
*---------------------------------------------------------------------- 01430000
* ALLOCATE RELREQ WORK ELEMENT                                          01440000
*---------------------------------------------------------------------- 01450000
                                                                        01460000
         $VTAMWE L'IWEX5,         SIZE                                 +01470000
               IWECXREL           CODE                                  01480000
                                                                        01490000
         LR    RIWE,R1                                                  01500000
                                                                        01510000
*---------------------------------------------------------------------- 01520000
* BUILD RELREQ WORK ELEMENT                                             01530000
*---------------------------------------------------------------------- 01540000
                                                                        01550000
         ST    RIACB,IWEX5ACB     SET ACB ADDRESS                       01560000
         L     R1,4(,R3)          ADDRESS OF REQUESTED LUNAME           01570000
         MVC   IWEX5LU,0(R1)      COPY LUNAME TO WORK ELEMENT           01580000
                                                                        01590000
*---------------------------------------------------------------------- 01600000
* TRACE THE MODULE ENTRY                                                01610000
*---------------------------------------------------------------------- 01620000
                                                                        01630000
         $TRACE *=A(TRC_IVTMXREL),16,STDENV=NO        16 USER BYTES     01640000
                                                                        01650000
         BNZ   NOMTRACE           BRANCH IF TRACING NOT AVAILABLE       01660000
                                                                        01670000
         ST    RITASK,0(,R1)      TRACE ITASK                           01680000
         ST    RIACB,4(,R1)       TRACE IACB                            01690000
         MVC   8(8,R1),IWEX5LU    TRACE LUNAME                          01700000
                                                                        01710000
NOMTRACE DS    0H                                                       01720000
                                                                        01730000
*---------------------------------------------------------------------- 01740000
* QUEUE RELREQ WORK ELEMENT TO VTAM MAIN ITASK                          01750000
*---------------------------------------------------------------------- 01760000
                                                                        01770000
         $VTAMQ (RIWE),           WORK ELEMENT                         +01780000
               IVTWEQ,            QUEUE                                +01790000
               STDENV=NO          EXIT ROUTINE                          01800000
                                                                        01810000
         B     RETURN                                                   01820000
                                                                        01830000
*---------------------------------------------------------------------- 01840000
* RETRY ROUTINE SCHEDULED BY RECOVERY                                   01850000
*---------------------------------------------------------------------- 01860000
                                                                        01870000
IVTXRTRY DS    0H                                                       01880000
                                                                        01890000
         LTR   R0,R0              WERE REGISTERS RESTORED FOR RETRY?    01900000
         BM    REGSOK             BRANCH IF YES, READY TO EXIT          01910000
X        USING IVTAMRPA,R1        PARM AREA ADDRESS MUST BE IN R1       01920000
         LM    R0,R15,X.IVRR00    RESTORE ALL THE REGISTERS             01930000
         DROP  X                                                        01940000
                                                                        01950000
REGSOK   DS    0H                                                       01960000
                                                                        01970000
         ICM   R0,15,PSATOLD      SRB MODE?                             01980000
         BNZ   RETURN             BRANCH IF NOT                         01990000
         ICM   R1,B'0001',=X'80'  KEY 8 IN BITS 24-27                   02000000
         MODESET KEYREG=(R1)      SET KEY 8                             02010000
         B     RETURN             AND WE ARE READY TO EXIT              02020000
                                                                        02030000
*---------------------------------------------------------------------- 02040000
* RETURN TO VTAM FROM EXIT ROUTINE                                      02050000
*---------------------------------------------------------------------- 02060000
                                                                        02070000
RETURN   DS    0H                                                       02080000
                                                                        02090000
         TM    FLAG,FLESTAEX      IS ESTAEX ESTABLISHED?                02100000
         BNO   RETFRR             BRANCH IF NOT                         02110000
                                                                        02120000
         ESTAEX 0                 DELETE RECOVERY ENVIRONMENT           02130000
                                                                        02140000
         NI    FLAG,255-FLESTAEX  CLEAR FLAG                            02150000
         B     EXITNOW            AND EXIT                              02160000
                                                                        02170000
RETFRR   DS    0H                                                       02180000
                                                                        02190000
         TM    FLAG,FLFRR         IS FRR ESTABLISHED?                   02200000
         BNO   EXITNOW            BRANCH IF NOT                         02210000
                                                                        02220000
         MODESET EXTKEY=ZERO,                                          +02230000
               SAVEKEY=(2)        SET KEY ZERO                          02240000
                                                                        02250000
         SETFRR D,                                                     +02260000
               WRKREGS=(14,15)    DELETE RECOVERY ENVIRONMENT           02270000
                                                                        02280000
         MODESET KEYADDR=(2)      RESTORE PREVIOUS KEY                  02290000
                                                                        02300000
         NI    FLAG,255-FLFRR     CLEAR FLAG                            02310000
         B     EXITNOW            AND EXIT                              02320000
                                                                        02330000
EXITNOW  DS    0H                                                       02340000
                                                                        02350000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 02360000
                                                                        02370000
         #VTEXIT ,                RETURN                                02380000
                                                                        02390000
*---------------------------------------------------------------------- 02400000
*  CONSTANTS AND LITERALS                                               02410000
*---------------------------------------------------------------------- 02420000
                                                                        02430000
ESTAEXL  ESTAEX *-*,CT,MF=L       ESTAEX PLIST                          02440000
ESTAEXPL EQU   ESTAEXL,*-ESTAEXL                                        02450000
                                                                        02460000
         LTORG ,                                                        02470000
         PRINT NOGEN                                                    02480000
         IVTAMRPA ,               INTEGRATOR VTAM RECOVERY PARAMETERS   02490000
         IHAFRRS ,                MVS FRR STACK                         02500000
         IHAPSA ,                 MVS PREFIXED STORAGE AREA             02510000
         ISTDBIND ,               VTAM BIND IMAGE                       02520000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         02530000
         ICVT  ,                  INTEGRATOR CVT                        02540000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   02550000
         ITASK ,                  INTEGRATOR TASK BLOCK                 02560000
         IACB ,                   INTEGRATOR VTAM ACB+                  02570000
         IRPL ,                   INTEGRATOR VTAM RPL+                  02580000
         INIB ,                   INTEGRATOR VTAM NIB+                  02590000
         ISESS ,                  INTEGRATOR SESSION BLOCK              02600000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            02610000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          02620000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       02630000
         EVCODES ,                INTEGRATOR EVENT CODES                02640000
         ABCODES ,                INTEGRATOR $ABEND CODES               02650000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     02660000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             02670000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             02680000
         IFGEXLST ,               VTAM EXIT LIST                        02690000
         END   ,                                                        02700000

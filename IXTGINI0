IXTGINI0 TITLE '- STORAGE MANAGER INITIALIZATION'                       00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE:  IXTGINI0 - Storage Manager Initialization                   00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine drives the initialization of the storage              00080000
*    manager.  It first invokes IXTGINI1 to build the subpool           00090000
*    and partition tables.  Once those are returned, the                00100000
*    "initial" storage extent supporting subpool cell pooling           00110000
*    is allocated and anchored in STANCHOR - the control block          00120000
*    anchoring all major storage manager data areas.                    00130000
*                                                                       00140000
*    If both STGINITIAL() and STGEXPAND() are zero, no cell             00150000
*    pools will be created.  The return code reflects this.             00160000
*    If STGINITIAL(0) is specified, the initial allocation              00170000
*    is performed using the STGEXPAND() value.                          00180000
*                                                                       00190000
*    Two initial extents are allocated.  One is for the exclusive       00200000
*    use of cells less than or equal to the CELL_SIZE_LIM value         00210000
*    in size.  The other is for larger cells.                           00220000
*                                                                       00230000
*    When initial allocation occurs, an amount of storage               00240000
*    reserved for standard GETMAIN and STORAGE allocation               00250000
*    services is also acquired together with the initial extent         00260000
*    and then released from the bottom of the gotten area.              00270000
*    This is intended to prevent fragmentation of storage as            00280000
*    additional STGEXPAND() extents are allocated.  However,            00290000
*    the degree of success depends greatly on the choices               00300000
*    for these values.                                                  00310000
*                                                                       00320000
*    STGRESERVE() specifies the amount of storage initially             00330000
*    reserved for this purpose.  If STGRESERVE(0) is specified          00340000
*    the amount reserved is equal to MAX( 128K, <initial>/8 ).          00350000
*                                                                       00360000
*    Next, we post the size of $GETSTOR storage extent                  00370000
*    appendages (prefix and suffix) in the ICVT allowing                00380000
*    specialized storage managers to choose an appropriate cell         00390000
*    size for $GETSTOR requests (ICTOVSTG).  A savearea frame           00400000
*    size recommendation is stored in ICTFRMSZ for those                00410000
*    storage managers that allocate savearea frames using               00420000
*    $GETSTOR. The ICTOVSTG overhead constant is accounted for          00430000
*    in this value.                                                     00440000
*                                                                       00450000
*    Finally, we locate the subpool (SL1ENTRY) and partition            00460000
*    (SL2ENTRY) entries corresponding with the frame size               00470000
*    posted in ICTFRMSZ, if any. This allows savearea frame             00480000
*    managers to acquire frame cells directly from the                  00490000
*    STORLVLS structures without incurring the overhead of              00500000
*    $GETSTOR.                                                          00510000
*                                                                       00520000
*                                                                       00530000
* NOTES:                                                                00540000
*                                                                       00550000
*    STDENV - task or process mode                                      00560000
*                                                                       00570000
*    If STGEXPAND(0) is specifed, STANCHOR.STAFLAGS.STAFNEXP            00580000
*    is set to allow $GETSTOR to easily determine whether               00590000
*    calls to IXTGXTNT (add extent) will be productive.                 00600000
*                                                                       00610000
*                                                                       00620000
* ON ENTRY:  N/A                                                        00630000
*                                                                       00640000
* ON EXIT:                                                              00650000
*                                                                       00660000
*    R15 contains one of the following return codes                     00670000
*    R0  contains a reason code or zero                                 00680000
*                                                                       00690000
*        RC00 - Successful completion                                   00700000
*                                                                       00710000
*        RC04 - Successful completion, however subpool cell             00720000
*               pooling is disabled                                     00730000
*                                                                       00740000
*        RC08 - Storage allocation failed, subpool cell pooling         00750000
*               may or may not occur depending on the ability           00760000
*               to acquire expansion extents at a later time            00770000
*                                                                       00780000
*               R0 - contains the failing STORAGE return code           00790000
*               R1 - contains the requested storage amount              00800000
*                                                                       00810000
**<DOC-OFF>****************************************************         00820000
                                                                        00830000
         EJECT                                                          00840000
***************************************************************         00850000
*                                                                       00860000
* MAINTENANCE:                                                          00870000
*                                                                       00880000
*    11/01/94 R. TURGEON                                                00890000
*             Initial version                                           00900000
*                                                                       00910000
***************************************************************         00920000
                                                                        00930000
         EJECT                                                          00940000
         STORLVLS ,               STORAGE MANAGEMENT CONTROL INFO       00950000
                                                                        00960000
         EJECT                                                          00970000
         STORCNST ,               STORAGE MANAGEMENT CONSTANTS          00980000
                                                                        00990000
         EJECT                                                          01000000
         $ISTOR ,                 STORAGE BLOCK HEADER                  01010000
                                                                        01020000
         EJECT                                                          01030000
         EQUS LINKAGE=VCON                                              01040000
                                                                        01050000
         EJECT                                                          01060000
IXTGINI0 #ENTER SAVE=NO,LINKAGE=BAKR                                    01070000
                                                                        01080000
         EJECT                                                          01090000
***************************************************************         01100000
*                                                                       01110000
*   Build the storage management block (STANCHOR) and the               01120000
*   associated subpool and partition tables.                            01130000
*                                                                       01140000
***************************************************************         01150000
         @CALL IXTGINI1           BUILD STGMGMT DATA AREAS              01160000
                                                                        01170000
         LR    R8,R1              RETURNED UNANCHORD                    01180000
         USING STANCHOR,R8        LIFE OF FUNCTION ADDRESSABILITY       01190000
         ST    R8,ICTXTANC        STORAGE MANAGER READY FOR WORK        01200000
                                                                        01210000
         ICM   R14,15,ICTXTEXP    CELL POOL EXPANSION SUPPORTED         01220000
         BNZ   *+8                ONWARD IF SO                          01230000
         OI    STAFLAGS,STAFNEXP  ELSE CLOSE CELL POOL EXPANSION GATE   01240000
                                                                        01250000
         LA    R3,$ISHDRLN        $GETSTOR PREFIX SIZE                  01260000
         ICM   R14,15,ICTSTEST    STORAGE INTEG DIAGNOSTIC LEVEL        01270000
         BZ    *+8                SKIP IF NO STORAGE FRAMING            01280000
         LA    R3,4(,R3)          ACCOUNT FOR TRAILING EYECATCHER       01290000
         STH   R3,ICTOVSTG        POST FOR COOPERATIVE STG MGRS         01300000
                                                                        01310000
*--------------------------------------------------------------         01320000
*   POST SAVEAREA FRAME SIZE AND ACQUIRE CORR SL1/SL2 ENTRIES           01330000
*--------------------------------------------------------------         01340000
         L     R0,ICTFRMSZ        UNADJUSTED SAVEAREA FRAME SIZE        01350000
         XC    ICTFRMSZ,ICTFRMSZ  ENSURE ZERO IF IMPROPER               01360000
         AL    R0,=F'255'         ROUND UP TO 128 BYTE MULTIPLE         01370000
         SRL   R0,8                                                     01380000
         SLL   R0,8                                                     01390000
         SR    R0,R3              ACCOUNT FOR $GETSTOR PREFIX           01400000
         BNP   FINL1L2            SAVEAREA FRAMING DISABLED             01410000
         ST    R0,ICTFRMSZ        POST FOR STORAGE MANAGERS             01420000
                                                                        01430000
         BAS   R14,L1L2LOC        LOCATE SL1 AND SL2 ENTRIES (R0)       01440000
         LTR   R15,R15            ANALYZE COMPLETION                    01450000
         BNZ   FINL1L2            ASSERT SUCCESSFUL COMPLETION          01460000
                                                                        01470000
         ST    R1,ICTXFSL1        SAVEAREA FRAME SUBPOOL ENTRY          01480000
         ST    R2,ICTXFSL2        SAVEAREA FRAME PARTITION ENTRY        01490000
                                                                        01500000
FINL1L2  DS    0H                                                       01510000
                                                                        01520000
***************************************************************         01530000
*                                                                       01540000
*   Acquire storage spanning the STGRESERVE() and 2*STGINITIAL()        01550000
*   designations.  Then, free the STGRESERVE() area with the            01560000
*   intent the future STGEXPAND() extensions will fall in               01570000
*   consecutively behind the STGINITIAL() area with little or           01580000
*   no fragmentation.                                                   01590000
*                                                                       01600000
***************************************************************         01610000
         ICM   R7,15,ICTXTINI     FETCH STGINITIAL() ALLOCATION AMOUNT  01620000
         BP    INITSET            READY IF EXPLICITLY PROVIDED          01630000
         ICM   R7,15,ICTXTEXP     ELSE TRY STGEXPAND() VALUE            01640000
         BNP   WRNCELL            INDICATE CELL POOLING DISABLED        01650000
                                                                        01660000
INITSET  DS    0H                 R7 <== INITIAL ALLOC AMT > 0          01670000
         LA    R7,4095(,R7)       ROUND TO PAGE                         01680000
         SRL   R7,12                                                    01690000
         SLL   R7,12                                                    01700000
                                                                        01710000
*--------------------------------------------------------------         01720000
*   COMPUTE INITIAL STORAGE SIZE                                        01730000
*--------------------------------------------------------------         01740000
         ICM   R6,15,ICTXTRSV     STGRESERVE() PROVIDED EXPLICITLY?     01750000
         BP    RSRVSET            ONWARD IF SO                          01760000
         LR    R6,R7              ELSE USE INITIAL VALUE AS BASE        01770000
         SRL   R6,3               RESERVE ONE EIGHTH OF THAT AMOUNT     01780000
         C     R6,$RSVMIN         IF NOT LOWER THAN A REASONABLE ...    01790000
         BNL   *+8                MINIMUM VALUE                         01800000
         L     R6,$RSVMIN                                               01810000
                                                                        01820000
RSRVSET  DS    0H                 R6 <== RESERVED STG AMOUNT            01830000
         LA    R6,4095(,R6)       ROUND TO PAGE                         01840000
         SRL   R6,12                                                    01850000
         SLL   R6,12                                                    01860000
                                                                        01870000
*--------------------------------------------------------------         01880000
*   ALLOCATE COMBINED RESERVED/INITIAL AREA                             01890000
*--------------------------------------------------------------         01900000
         LA    R2,0(R6,R7)        RESERVED AREA PLUS INITIAL BLOCK      01910000
         AR    R2,R7              TWO INITIAL BLOCKS                    01920000
                                                                        01930000
         STORAGE OBTAIN,LENGTH=(R2),COND=YES,LOC=ANY,BNDRY=PAGE         01940000
                                                                        01950000
         LTR   R0,R15             SUCCESS? RETAIN RETCODE AS RSNCODE    01960000
         BZ    FORMATXT           SKIP IF SO                            01970000
         LR    R1,R2              FAILING REQUEST AMOUNT                01980000
         B     ERRSTG             STORAGE NOT AVAILABLE                 01990000
                                                                        02000000
*--------------------------------------------------------------         02010000
*   RELEASE RESERVED AREA IF ANY                                        02020000
*--------------------------------------------------------------         02030000
FORMATXT DS    0H                                                       02040000
         LR    R4,R1              RESERVED AREA FOLLOWED BY INIT EXTENT 02050000
         LTR   R6,R6              RESERVED AREA ALLOCATED?              02060000
         BZ    FORMPOST           SKIP IF NOT                           02070000
         AR    R4,R6              LOCATE ORIGIN OF EXTENT               02080000
                                                                        02090000
         STORAGE RELEASE,ADDR=(1),LENGTH=(R6)                           02100000
                                                                        02110000
*--------------------------------------------------------------         02120000
*   QUEUE EXTENT FOR SMALL CELLS                                        02130000
*--------------------------------------------------------------         02140000
FORMPOST DS    0H                                                       02150000
         USING STXTENT,R4         FORMATTED DATA AREA                   02160000
                                                                        02170000
         XC    STXTENT(STXTLN),STXTENT                                  02180000
         ST    R4,STXORG          EXTENT ORIGIN                         02190000
         ST    R7,STXLEN          EXTENT LENGTH                         02200000
         LR    R0,R7              MODIFIABLE COPY OF EXTENT LENGTH      02210000
         SH    R0,=AL2(STXTLN)    BACKOUT SIZE OF HEADER                02220000
         ST    R0,STXAREM         POST REMAINING LENGTH                 02230000
         LA    R1,STXTLN(,R4)     ORIGIN OF PARCELLABLE AREA            02240000
         ST    R1,STXAPTR         POST ACCORDINGLY                      02250000
                                                                        02260000
         L     R15,=A(CELL_SIZE_LIM)                                    02270000
         ST    R15,STXLIMIT       SMALL BLOCK LIMIT                     02280000
                                                                        02290000
         ST    R4,STAXTEND        FIRST EXTENT IS THE OLDEST EXTENT     02300000
                                                                        02310000
         L     R15,STAXTCNT       NEW EXTENT                            02320000
         LA    R15,1(,R15)        NUMBER OF EXTENTS                     02330000
         ST    R15,STAXTCNT       UPDATE ACCORDINGLY                    02340000
                                                                        02350000
*--------------------------------------------------------------         02360000
*   QUEUE EXTENT FOR LARGE CELLS                                        02370000
*--------------------------------------------------------------         02380000
         LA    R5,STXTENT(R7)     ADVANCE TO LARGE CELL EXTENT          02390000
L        USING STXTENT,R5         PREPARE FOR LINKAGE                   02400000
         XC    L.STXTENT(STXTLN),L.STXTENT                              02410000
         ST    R5,STXPREV         LARGE BLOCK IS NEWEST BLOCK           02420000
         ST    R4,L.STXNEXT       FORWARD LINK                          02430000
         LR    R4,R5              STANDARD EXTENT BASE                  02440000
         DROP  L                  LARGE BLOCK SEPARATE IDENTITY         02450000
                                                                        02460000
         ST    R4,STXORG          EXTENT ORIGIN                         02470000
         ST    R7,STXLEN          EXTENT LENGTH                         02480000
         LR    R0,R7              MODIFIABLE COPY OF EXTENT LENGTH      02490000
         SH    R0,=AL2(STXTLN)    BACKOUT SIZE OF HEADER                02500000
         ST    R0,STXAREM         POST REMAINING LENGTH                 02510000
         LA    R1,STXTLN(,R4)     ORIGIN OF PARCELLABLE AREA            02520000
         ST    R1,STXAPTR         POST ACCORDINGLY                      02530000
                                                                        02540000
         ST    R4,STAXTLST        ESTABLISH EXTENT LIST                 02550000
                                                                        02560000
         L     R15,STAXTCNT       NEW EXTENT                            02570000
         LA    R15,1(,R15)        NUMBER OF EXTENTS                     02580000
         ST    R15,STAXTCNT       UPDATE ACCORDINGLY                    02590000
                                                                        02600000
         EJECT                                                          02610000
***************************************************************         02620000
*                                                                       02630000
*   Return storage management anchor area to caller                     02640000
*                                                                       02650000
***************************************************************         02660000
NORMRET  DS    0H                                                       02670000
         LA    R15,RC00           SUCCESS, CELL POOLING ENABLED         02680000
         SR    R0,R0              REASON CODES NOT DEFINED              02690000
         B     FINISH             DONE                                  02700000
                                                                        02710000
WRNCELL  DS    0H                                                       02720000
         LA    R15,RC04           INDICATE CELL POOLING DISABLED        02730000
         SR    R0,R0              REASON CODES NOT DEFINED              02740000
         B     FINISH             DONE                                  02750000
                                                                        02760000
ERRSTG   DS    0H                 R0,R1 CONTAIN ERROR INFORMATION       02770000
         LA    R15,RC08           INDICATE STORAGE FAILURE / UNAVAIL    02780000
                                                                        02790000
*--------------------------------------------------------------         02800000
*   ACTIVATE THE STORAGE MANAGER AND RETURN                             02810000
*--------------------------------------------------------------         02820000
FINISH   DS    0H                                                       02830000
                                                                        02840000
*--------------------------------------------------------------         02850000
*   EXIT                                                                02860000
*--------------------------------------------------------------         02870000
         #EXIT  ,                 RETURN                                02880000
                                                                        02890000
         EJECT                                                          02900000
**<DOC-ON>*****************************************************         02910000
*                                                                       02920000
* ROUTINE: L1L2LOC - Locate SL1ENTRY & SL2ENTRY by storage size         02930000
*                                                                       02940000
* DESCRIPTION:                                                          02950000
*                                                                       02960000
*    This routine accepts a storage length and returns the              02970000
*    corresponding SL1ENTRY and SL2ENTRY structures jointly             02980000
*    responsible for managing storage blocks of that size.              02990000
*                                                                       03000000
* NOTES:                                                                03010000
*                                                                       03020000
*    No saveareas used, R15-R2 are modified.                            03030000
*                                                                       03040000
*                                                                       03050000
* ON ENTRY:                                                             03060000
*                                                                       03070000
*    R0 - size of storage area (unsigned)                               03080000
*                                                                       03090000
*                                                                       03100000
* ON EXIT:                                                              03110000
*                                                                       03120000
*    R15 contains one of the following return codes.                    03130000
*        The condition code is set accordingly.                         03140000
*                                                                       03150000
*        RC00 - normal completion                                       03160000
*                                                                       03170000
*               R1 - addr of SL1ENTRY                                   03180000
*               R2 - addr of SL2ENTRY                                   03190000
*                                                                       03200000
*        RC04 - Storage management block not yet allocated              03210000
*                                                                       03220000
*        RC08 - ERROR: (SIZE < 2) OR (SIZE > 16M)                       03230000
*                                                                       03240000
**<DOC-OFF>****************************************************         03250000
                                                                        03260000
L1L2LOC  DS    0H                                                       03270000
         ICM   R15,15,ICTXTANC         LOCATE STORAGE MANAGEMENT BLOCK  03280000
         BZ    L1L2WARN                NOT YET INITIALIZED              03290000
         USING STANCHOR,R15            DECLARE INTENTIONS               03300000
                                                                        03310000
         CLM   R0,B'1000',ICTZERO      LENGTH SATISIFIES CONSTRAINTS?   03320000
         BNE   L1L2ERR                 REQUEST REJECTED IF NOT          03330000
         BCTR  R0,0                    REQ LENGTH MINUS 1               03340000
         LTR   R2,R0                   SPLIT HIGH ORDER / LOW ORDER     03350000
         BNP   L1L2ERR                 INVALID REQUEST                  03360000
                                                                        03370000
*--------------------------------------------------------------         03380000
*   LOCATE SUBPOOL SUMMARY TABLE SL1ENTRY                               03390000
*--------------------------------------------------------------         03400000
         SRA   R2,8                    HIGH ORDER BYTE OF REQ LENGTH    03410000
         BNZ   L1L2BIG                 REQUEST AMOUNT > 256 BYTES       03420000
         LR    R1,R0                   USABLE INDEX REG                 03430000
         IC    R2,L1L2EXP2(R1)         FETCH LOG2 (SIZE-1) LOW ORDER    03440000
         B     L1L2COMN                ONWARD                           03450000
                                                                        03460000
L1L2BIG  DS    0H                                                       03470000
         IC    R2,L1L2EXP2(R2)         FETCH LOG2 (SIZE-1) HIGH ORDER   03480000
         LA    R2,8(,R2)               ADJUST EXPONENT ACCORDINGLY      03490000
                                                                        03500000
L1L2COMN DS    0H                                                       03510000
         L     R1,STAHILV1             CHOOSE SL1ENTRY OF LARGEST BLOCK 03520000
         CH    R2,STAHIEXP             COMPARE EXP2, ASSUMPTION TRUE?   03530000
         BNL   L1L2PART                LARGE BLOCK SUMMARY CHOSEN IF SO 03540000
         SLL   R2,4                    ELSE COMPUTE SL1 TABLE INDEX     03550000
         L     R1,STALVL1              TABLE BASE                       03560000
         AR    R1,R2                   ASSOCIATED SL1ENTRY              03570000
                                                                        03580000
L1       USING SL1ENTRY,R1             SUBPOOL SUMMARY TABLE ENTRY      03590000
                                                                        03600000
         TM    L1.SL1ATTRS,SL1A_INACTIVE   ACTIVE ENTRY?                03610000
         BNO   *+8                     SKIP IF SO                       03620000
         L     R1,L1.SL1LVL2           ELSE TRAVERSE TO PROXY SL1ENTRY  03630000
         DROP  R15                     STANCHOR                         03640000
                                                                        03650000
*--------------------------------------------------------------         03660000
*   LOCATE ASSOCIATED PARTITION TABLE SL2ENTRY                          03670000
*--------------------------------------------------------------         03680000
L1L2PART DS    0H                                                       03690000
         L     R2,L1.SL1LVL2           ORIGIN OF ASSOC PARTITION TABLE  03700000
         CLC   L1.SL1PARTS,=H'1'       SINGLE PARTITION?                03710000
         BNH   L1L2FIN                 DONE IF SO                       03720000
                                                                        03730000
         SH    R0,L1.SL1MIN            CONVERT LENGTH TO INTERVAL SIZE  03740000
         BNP   L1L2FIN                 LENGTH FALLS IN FIRST PARTITION  03750000
         LH    R15,L1.SL1SHIFT         INTERVAL -> PARTITION CONVERTER  03760000
         SRL   R0,0(R15)               ACQUIRE PARTITION INDEX          03770000
         MH    R0,=AL2(SL2ENTLN)       CONVERT INDEX TO ENTRY OFFSET    03780000
         AR    R2,R0                   R2 <== SL2ENTRY                  03790000
         DROP  L1                      R1 <== SL1ENTRY                  03800000
                                                                        03810000
*--------------------------------------------------------------         03820000
*   RETURN TO CALLER                                                    03830000
*--------------------------------------------------------------         03840000
L1L2FIN  DS    0H                                                       03850000
         SR    R15,R15                 NORMAL COMPLETION                03860000
         B     L1L2RET                 DONE                             03870000
                                                                        03880000
L1L2WARN DS    0H                      STGMGMT NOT YET INITIALIZED      03890000
         LA    R15,RC04                WARNING                          03900000
         B     L1L2RET                 DONE                             03910000
                                                                        03920000
L1L2ERR  DS    0H                      INVALID STORAGE LENGTH PROVIDED  03930000
         LA    R15,RC08                INDICATE FAILURE                 03940000
                                                                        03950000
L1L2RET  DS    0H                      RETURN                           03960000
         LTR   R15,R15                 SET CC                           03970000
         BR    R14                     COMPLETE                         03980000
                                                                        03990000
         EJECT                                                          04000000
***************************************************************         04010000
*                                                                       04020000
*   LOCAL READ ONLY WORKING STORAGE                                     04030000
*                                                                       04040000
***************************************************************         04050000
L1L2EXP2 EXP2  ,                       LOG2 (SIZE) RESOLUTION TABLE     04060000
                                                                        04070000
$RSVMIN  DC    A(128*1024)        MINIMUM STG RESERVED FOR NATIVE REQS  04080000
                                                                        04090000
         LTORG ,                                                        04100000
                                                                        04110000
         PRINT NOGEN                                                    04120000
         ICVT  ,                                                        04130000
         END   ,                                                        04140000

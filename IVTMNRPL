IVTMNRPL TITLE 'INTEGRATOR - RPL COMPLETION ROUTINE INTERFACE'          00010000
**<DOC-ON>************************************************************* 00020000
*                                                                       00030000
* ROUTINE: IVTMNRPL - INTEGRATOR RPL COMPLETION ROUTINE INTERFACE       00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*                                                                       00080000
*                                                                       00090000
*                                                                       00100000
*                                                                       00110000
* ON ENTRY:                                                             00120000
*                                                                       00130000
*    R15 = ENTRY POINT ADDRESS                                          00140000
*    R14 = RETURN ADDRESS                                               00150000
*    R13 = AVAILABLE SAVE AREA                                          00160000
*    R11 = ICVT ADDRESS                                                 00170000
*    R10 = ITASK ADDRESS                                                00180000
*    R01 = ADDRESS OF RPL EXIT WORK ELEMENT (IWEXA)                     00190000
*                                                                       00200000
* ON EXIT:                                                              00210000
*                                                                       00220000
*    R15 = 0                                                            00230000
*    R00 = 0                                                            00240000
*    R01 = 0                                                            00250000
*                                                                       00260000
*    ALL OTHER REGISTERS ARE RESTORED                                   00270000
*                                                                       00280000
**<DOC-OFF>************************************************************ 00290000
                                                                        00300000
         EJECT ,                                                        00310000
*********************************************************************** 00320000
*                                                                       00330000
* MAINTENANCE:                                                          00340000
*                                                                       00350000
*   08/01/93 RANDY WITEK                                                00360000
*                                                                       00370000
*********************************************************************** 00380000
                                                                        00390000
         EQUS  ,                  GENERAL EQUATES                       00400000
                                                                        00410000
RICVT    EQU   R11                                                      00420000
RITASK   EQU   R10                                                      00430000
RIVTAM   EQU   R9                                                       00440000
RIACB    EQU   R8                                                       00450000
RIRPL    EQU   R7                                                       00460000
RISESS   EQU   R6                                                       00470000
RIWE     EQU   R5                                                       00480000
                                                                        00490000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00500000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00510000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00520000
         USING IACB,RIACB         ESTABLISH ADDRESSABILITY              00530000
         USING IRPL,RIRPL         ESTABLISH ADDRESSABILITY              00540000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00550000
         USING IWEVTAM,RIWE       ESTABLISH ADDRESSABILITY              00560000
                                                                        00570000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00580000
$TASKMFL $TASK MF=L               $TASK PLIST CONSTRUCTION              00590000
$PROCMFL $PROC MF=L               $PROC PLIST CONSTRUCTION              00600000
STIMEMFL STIMERM SET,MF=L         STIMERM PLIST CONSTRUCTION            00610000
ECODE    DS    F                  SAVED EVENT CODE                      00620000
STIMERID DS    F                  ID RETURNED BY MVS STIMERM            00630000
WRK256   DS    XL256              GENERAL WORKAREA                      00640000
RETR15   DS    F                  RETURN CODE VALUE                     00650000
RETR0    DS    F                  RETURN REGISTER 0                     00660000
RETR1    DS    F                  RETURN REGISTER 1                     00670000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00680000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00690000
                                                                        00700000
         $MSGDFT PREFIX=ICTPID,                                        +00710000
               COMPID='VTM',                                           +00720000
               TABLE=*#MSGS,                                           +00730000
               WORKA=0,                                                +00740000
               MF=(E,WRK256),                                          +00750000
               PRINT=NOGEN                                              00760000
                                                                        00770000
IVTMNRPL #ENTER BASE=R12,         ENTRY LINKAGE                        +00780000
               PREG=RIWE,                                              +00790000
               AMODE=31,                                               +00800000
               RMODE=ANY                                                00810000
                                                                        00820000
*---------------------------------------------------------------------- 00830000
* PROCESS A COMPLETED VTAM RPL-BASED REQUEST                            00840000
*---------------------------------------------------------------------- 00850000
                                                                        00860000
         L     RIRPL,IWEXARP@     ADDRESS OF COMPLETED RPL              00870000
         CLC   IRPID,=CL8'IRPL'   IS IT REALLY AN IRPL                  00880000
         BNE   ERRIRPL            BRANCH IF NOT                         00890000
                                                                        00900000
*                                                                       00910000
* DECREMENT THE "ACTIVE RPL" ACCOUNTING WORD                            00920000
*---------------------------------------------------------------------- 00930000
                                                                        00940000
         ICM   R15,15,IRPACCWD    ADDRESS OF "ACTIVE RPL" ACCT. WORD    00950000
         BZ    RPLNOAW            BRANCH IF NO ACCOUNTING WORD          00960000
         L     R1,0(,R15)         CURRENT CONTENTS OF WORD              00970000
                                                                        00980000
RPLUPAW  DS    0H                                                       00990000
                                                                        01000000
         LR    R2,R1              COPY ACCOUNTING WORD                  01010000
         S     R2,=F'1'           MINUS ONE                             01020000
         BM    ERRIRPL            SHOULD NOT GO NEGATIVE                01030000
         CS    R1,R2,0(R15)       TRY TO UPDATE ACCOUNTING WORD         01040000
         BNE   RPLUPAW            TRY THE UPDATE AGAIN                  01050000
                                                                        01060000
RPLNOAW  DS    0H                                                       01070000
                                                                        01080000
*                                                                       01090000
* CHECK FOR RC=32 AND RC=24 SPECIAL ERRORS                              01100000
*---------------------------------------------------------------------- 01110000
                                                                        01120000
         LA    R0,32                                                    01130000
         C     R0,IRPFR15         GENERAL RETURN CODE 32?               01140000
         BE    RPLERROR           INVOKE USER ROUTINE                   01150000
                                                                        01160000
         LA    R0,24                                                    01170000
         C     R0,IRPFR0          RECOVERY ACTION RETURN CODE 24?       01180000
         BE    RPLERROR           INVOKE USER ROUTINE                   01190000
                                                                        01200000
*                                                                       01210000
* CHECK IF A RC=8 RETRY SHOULD BE PERFORMED                             01220000
*---------------------------------------------------------------------- 01230000
                                                                        01240000
         SR    R0,R0              CLEAR FOR ICM                         01250000
         ICM   R0,B'0001',RPLRTNCD RECOVERY ACTION RETURN CODE          01260000
                                                                        01270000
         CLI   RPLRTNCD,8         RETRIABLE FAILURE?                    01280000
         BE    RPLRETRY           BRANCH IF YES                         01290000
                                                                        01300000
*                                                                       01310000
* IF AN RPL COMPLETION ROUTINE SPECIFIED, CALL IT. ELSE, FREE THE RPL.  01320000
*---------------------------------------------------------------------- 01330000
                                                                        01340000
         MVI   IRPRTRY8,0         CLEAR RC=8 RETRY COUNTER              01350000
                                                                        01360000
         CLI   RPLRTNCD,0         GOOD COMPLETION?                      01370000
         BE    RPLOK              CALL OK ENTRY IF GOOD                 01380000
                                                                        01390000
RPLERROR DS    0H                                                       01400000
                                                                        01410000
         ICM   R15,15,IRPWTGER    ERROR COMPLETION ADDRESS              01420000
         BNZ   RPLGO              BRANCH IF ERROR ROUTINE IS PROVIDED   01430000
                                                                        01440000
RPLOK    DS    0H                                                       01450000
                                                                        01460000
         ICM   R15,15,IRPWTGOK    IS THERE AN OK ROUTINE?               01470000
         BZ    RPLFREE            NO ROUTINE, JUST RETURN RPL           01480000
                                                                        01490000
RPLGO    DS    0H                                                       01500000
                                                                        01510000
         LR    R1,RIRPL           PASS IRPL ADDRESS IN R1               01520000
         BASR  R14,R15            CALL THE RPL ROUTINE                  01530000
         B     RETURN             AND WAIT FOR MORE WORK                01540000
                                                                        01550000
RPLFREE  DS    0H                                                       01560000
                                                                        01570000
         $VTAM RETRPL,            RELEASE THE IRPL                     +01580000
               AREA=(RIRPL),      IRPL TO BE RELEASED                  +01590000
               ERRET=ERR$VTAM,    ABEND IF REQUEST NOT ACCEPTED        +01600000
               MF=(E,MFE_LIST)    ACQUIRE AN IRPL                       01610000
                                                                        01620000
         B     RETURN             AND WAIT FOR MORE WORK                01630000
                                                                        01640000
*---------------------------------------------------------------------- 01650000
* RETRY AN OPERATION COMPLETED WITH RECOVERY ACTION RETURN CODE 8       01660000
*---------------------------------------------------------------------- 01670000
                                                                        01680000
*                                                                       01690000
* ALLOW MAXIMUM OF 5 CONSECUTIVE RETRIES FOR RC=8                       01700000
*---------------------------------------------------------------------- 01710000
                                                                        01720000
RPLRETRY DS    0H                                                       01730000
                                                                        01740000
         SR    R2,R2              CLEAR FOR IC                          01750000
         IC    R2,IRPRTRY8        RETRY COUNTER                         01760000
         LA    R2,1(,R2)          BUMP COUNTER                          01770000
         STC   R2,IRPRTRY8        SAVE UPDATED COUNTER                  01780000
         CLI   IRPRTRY8,5         MORE THAN 5 RETRIES?                  01790000
         BH    RPLERROR           BRANCH IF YES                         01800000
                                                                        01810000
*                                                                       01820000
* WAIT FOR 3 SECONDS BEFORE RETRY                                       01830000
*---------------------------------------------------------------------- 01840000
                                                                        01850000
         LA    R2,300             BINTVL TIME UNIT IS .01 SECONDS       01860000
                                                                        01870000
         STIMERM SET,             TASK WAIT FOR 3 SECONDS              +01880000
               BINTVL=(R2),                                            +01890000
               WAIT=YES,                                               +01900000
               ID=STIMERID,                                            +01910000
               MF=(E,STIMEMFL)                                          01920000
                                                                        01930000
*                                                                       01940000
* RE-ISSUE VTAM REQUEST                                                 01950000
*---------------------------------------------------------------------- 01960000
                                                                        01970000
         EXECRPL RPL=(RIRPL)      RE-ISSUE THE REQUEST                  01980000
                                                                        01990000
         STM   R15,R0,IRPR15      SAVE VTAM RETURN REGISTERS            02000000
                                                                        02010000
         $VTAM CHECKPH1,          PHASE-1 RETURN CODE CHECK            +02020000
               AREA=(RIRPL),      IRPL TO BE CHECKED                   +02030000
               MF=(E,MFE_LIST)    ACQUIRE AN IRPL                       02040000
                                                                        02050000
*---------------------------------------------------------------------- 02060000
* RETURN TO CALLER                                                      02070000
*---------------------------------------------------------------------- 02080000
                                                                        02090000
RETURN   DS    0H                                                       02100000
                                                                        02110000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 02120000
                                                                        02130000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    02140000
                                                                        02150000
*---------------------------------------------------------------------- 02160000
* ERROR ROUTINES                                                        02170000
*---------------------------------------------------------------------- 02180000
                                                                        02190000
ERR$VTAM DS    0H                                                       02200000
                                                                        02210000
         $ABEND ABE_VTDIAG,                                            +02220000
               SCOPE=PCB,                                              +02230000
               TITLE='$VTAM FAILURE'                                    02240000
                                                                        02250000
ERRIRPL  DS    0H                                                       02260000
                                                                        02270000
         $ABEND ABE_VTDIAG,                                            +02280000
               SCOPE=PCB,                                              +02290000
               TITLE='INVALID IRPL DETECTED'                            02300000
                                                                        02310000
*---------------------------------------------------------------------- 02320000
*  CONSTANTS AND LITERALS                                               02330000
*---------------------------------------------------------------------- 02340000
                                                                        02350000
         LTORG ,                                                        02360000
         PRINT NOGEN                                                    02370000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                02380000
         ISTDBIND ,               VTAM BIND IMAGE                       02390000
         ICVT  ,                  INTEGRATOR CVT                        02400000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   02410000
         IRPL ,                   INTEGRATOR VTAM RPL+                  02420000
         IACB ,                   INTEGRATOR VTAM ACB+                  02430000
         INIB ,                   INTEGRATOR VTAM NIB+                  02440000
         ISESS ,                  INTEGRATOR SESSION BLOCK              02450000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            02460000
         ITASK ,                  INTEGRATOR TASK BLOCK                 02470000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          02480000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       02490000
         EVCODES ,                INTEGRATOR EVENT CODES                02500000
         ABCODES ,                INTEGRATOR $ABEND CODES               02510000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     02520000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        02530000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             02540000
         $PROC DSECT=YES          INTEGRATOR $PROC SERVICES             02550000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             02560000
         IFGEXLST ,               VTAM EXIT LIST                        02570000
         END   ,                                                        02580000

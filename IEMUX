IEMUX    TITLE '- TERMINAL EMULATOR XIMAGE RU PROCESSOR'                00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: IEMUX - Terminal emulator XIMAGE RU processor                00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine is scheduled to process an inbound XIMAGE             00080000
*    request unit.  The XIMAGE request is placed on the                 00090000
*    SLU session driver's message queue.  If the SLU session            00100000
*    driver is not active, an XIMAGE RU is sent back to                 00110000
*    the terminal emulator to signal that the session has               00120000
*    ended.                                                             00130000
*                                                                       00140000
*                                                                       00150000
* METHOD:                                                               00160000
*                                                                       00170000
*    IEMUX PROC:                                                        00180000
*        let SLU session key = XPORT handle;                            00190000
*        locate SLUHANDL using SLU driver key ($ENTITY) ;               00200000
*                                                                       00210000
*        if session not found                                           00220000
*             return( statechg, "SESSION TERMINATED") ;                 00230000
*                                                                       00240000
*        $TSEND request to SLU driver ($TSEND REPLY=NO) ;               00250000
*        return (RC00)                                                  00260000
*    PROC END ;                                                         00270000
*                                                                       00280000
*                                                                       00290000
* NOTES:                                                                00300000
*                                                                       00310000
*    The acquisition of the TXP buffer is deferred until after          00320000
*    the remote request completes. This allows us to inspect the        00330000
*    size of the message buffer to better determine the size            00340000
*    of the buffer needed.                                              00350000
*                                                                       00360000
*                                                                       00370000
* ON ENTRY:                                                             00380000
*                                                                       00390000
*    R1  contains the address of an inbound XIMAGE function             00400000
*        request unit mapped by the XIMAGE parameter list.              00410000
*                                                                       00420000
*                                                                       00430000
* ON EXIT:                                                              00440000
*                                                                       00450000
*    R15 contains one of the following return codes                     00460000
*                                                                       00470000
*        RC00 - normal completion                                       00480000
*                                                                       00490000
**<DOC-OFF>****************************************************         00500000
                                                                        00510000
         EJECT                                                          00520000
***************************************************************         00530000
*                                                                       00540000
* MAINTENANCE:                                                          00550000
*                                                                       00560000
*    12/14/95 R. Turgeon                                                00570000
*             Use WUTOKEN= format of $TSEND to SLU driver               00580000
*                                                                       00590000
***************************************************************         00600000
                                                                        00610000
         EJECT                                                          00620000
         #WORK ,                                                        00630000
                                                                        00640000
EXTRAREA DS    4F                 $ENTITY EXTR USERDATA RETURN AREA     00650000
                                                                        00660000
         XIMAGE DSECT=NO          TERMINAL EMULATOR RU                  00670000
                                                                        00680000
         #ENDWORK ,               END OF WORKAREA                       00690000
                                                                        00700000
         EJECT                                                          00710000
         @XH   ,                  REQUEST UNIT HEADER                   00720000
                                                                        00730000
         EJECT                                                          00740000
         SLUHANDL ,               VDEVICE HANDLE TO APPL SESSION        00750000
                                                                        00760000
         EJECT                                                          00770000
         $TSEND DSECT=YES         CROSS WU MESSAGING PLIST              00780000
                                                                        00790000
         EJECT                                                          00800000
         $ENTITY DSECT=YES        CROSS WU MESSAGING PLIST              00810000
                                                                        00820000
         EJECT                                                          00830000
         ABCODES PRINT=NOGEN                                            00840000
                                                                        00850000
         MSGCODES ,                                                     00860000
                                                                        00870000
         EQUS  ,                                                        00880000
                                                                        00890000
         EJECT                                                          00900000
IEMUX    #ENTER PREG=R8                                                 00910000
                                                                        00920000
         USING ITASK,R10          STDENV                                00930000
                                                                        00940000
         L     R9,TSKPCBC         PROCESS MODE                          00950000
         USING IPCB,R9            ADDRESSABILITY                        00960000
                                                                        00970000
         EJECT                                                          00980000
***************************************************************         00990000
*                                                                       01000000
*   Locate the session manager process                                  01010000
*                                                                       01020000
***************************************************************         01030000
                                                                        01040000
         USING @XH,R8             XIMAGE RU HEADER                      01050000
                                                                        01060000
         L     R6,PCBUSER         LOCATE USER IDENTIFICATION            01070000
         USING IUSER,R6           ADDRESSABILITY                        01080000
                                                                        01090000
         $ENTITY EXTR,                                                 X01100000
               ENTITY=(@XHSESH,L'@XHSESH),                             X01110000
               USERDATA=EXTRAREA,                                      X01120000
               ANCHOR=USRSESS,                                         X01130000
               MF=(E,MFE_LIST)                                          01140000
                                                                        01150000
         CH    R15,=AL2(RC04)     NORMAL COMPLETION CODES               01160000
         BL    GOTHANDL              SESSION HANDLE LOCATED             01170000
         BE    SESS_END              ERROR - NO SUCH WORKUNIT           01180000
         EX    R0,*                  ASSERT 'PROPERLY FORMULATED REQ'   01190000
         DROP  R6                 IUSER                                 01200000
                                                                        01210000
*--------------------------------------------------------------         01220000
*   Validate appl session handle, extract managing PCB addr             01230000
*--------------------------------------------------------------         01240000
                                                                        01250000
GOTHANDL DS    0H                                                       01260000
         L     R5,EXTRAREA        ACQUIRE SLU SESSION HANDLE            01270000
         USING SLUHANDL,R5        PRINCIPLE LINKAGE / CONTROL ANCHORS   01280000
                                                                        01290000
         CLC   SLHID,=C'SLUHANDL' ASSERT VALID DATA                     01300000
         BE    *+8                CONTINUE                              01310000
         EX    R0,*               ASSERTION DENIED                      01320000
                                                                        01330000
         EJECT                                                          01340000
***************************************************************         01350000
*                                                                       01360000
*   Pass request thru to SLU session driver                             01370000
*                                                                       01380000
***************************************************************         01390000
                                                                        01400000
         LA    R2,ITM_SLU_XIMAGE  IMAGE IN MESSAGE CODE                 01410000
                                                                        01420000
         $TSEND WUTOKEN=SLHSDTKN, SEND TO SESSION DRIVER               X01430000
               TYPE=(R2),         IDENTIFY SESSION RECORDING FUNCTION  X01440000
               INFO=(@XH,*@XHPLEN),   PLIST IN RU FORMAT               X01450000
               MF=(E,MFE_LIST)                                          01460000
                                                                        01470000
         CH    R15,=AL2(RC04)     EVALUATE COMPLETION STATUS            01480000
         BL    RETURN             TARGET WORKUNIT LOCATED, RETURN       01490000
         BE    SESS_END           WORKUNIT NOT FOUND                    01500000
         EX    R0,*               ASSERT 'PROPERLY FORMULATED REQUEST'  01510000
         DROP  R5                 SLUHANDL                              01520000
                                                                        01530000
         EJECT                                                          01540000
***************************************************************         01550000
*                                                                       01560000
*   SLU session driver is not available.  Format a state change         01570000
*   XIMAGE RU to notify terminal emulator of the terminated             01580000
*   session.                                                            01590000
*                                                                       01600000
***************************************************************         01610000
                                                                        01620000
SESS_END DS    0H                                                       01630000
         MVC   XIMAGE(@XHXHLN),@XH    COPY REQUEST UNIT HEADER          01640000
         MVC   XIMGSFNC,=A(XIMGSCHG)  STATE CHANGE REQUEST              01650000
         MVI   XIMGSTA,XIMG_GNE       SESSION ENDED                     01660000
                                                                        01670000
         $XPBUFR INIT,SIZE=XIMGLN,XH=XIMAGE                             01680000
                                                                        01690000
         BNZ   ABE_TXP                                                  01700000
                                                                        01710000
*--------------------------------------------------------------         01720000
*   Insert fixed portion of response block                              01730000
*--------------------------------------------------------------         01740000
                                                                        01750000
         $XPBUFR ISRT,DATA=XIMGDATA,DATALEN=XIMGLN                      01760000
                                                                        01770000
         BNZ   ABE_TXP                                                  01780000
                                                                        01790000
*--------------------------------------------------------------         01800000
*   Send response block to requestor                                    01810000
*--------------------------------------------------------------         01820000
                                                                        01830000
         $XPBUFR XMIT             TRANSMIT AND FREE                     01840000
                                                                        01850000
         EJECT                                                          01860000
***************************************************************         01870000
*                                                                       01880000
*   Cleanup - return to request scheduler                               01890000
*                                                                       01900000
***************************************************************         01910000
                                                                        01920000
RETURN   DS    0H                                                       01930000
         LA    R15,RC00           NORMAL COMPLETION                     01940000
                                                                        01950000
         #EXIT ,                                                        01960000
                                                                        01970000
         EJECT                                                          01980000
***************************************************************         01990000
*                                                                       02000000
* CATastropic errors                                                    02010000
*                                                                       02020000
***************************************************************         02030000
                                                                        02040000
ABE_TXP  DS    0H                                                       02050000
         $ABEND ABE_TXPSERV,DUMP=YES,                                  X02060000
               TITLE='TXP buffer service failure'                       02070000
                                                                        02080000
         EJECT                                                          02090000
***************************************************************         02100000
*                                                                       02110000
*   Local read only data areas                                          02120000
*                                                                       02130000
***************************************************************         02140000
                                                                        02150000
         LTORG ,                                                        02160000
                                                                        02170000
         EJECT                                                          02180000
         PRINT NOGEN                                                    02190000
         ICVT  ,                                                        02200000
         ITASK ,                                                        02210000
         IPCB  ,                                                        02220000
         IUSER ,                                                        02230000
         END   ,                                                        02240000

IVTMSDAT TITLE 'INTEGRATOR - ISESS RECEIVED DATA PROCESSOR'             00010000
**<DOC-ON>************************************************************* 00020000
*                                                                       00030000
* ROUTINE: IVTMSDAT - ISESS RECEIVED DATA PROCESSOR                     00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
* ON ENTRY:                                                             00080000
*                                                                       00090000
*    R15 = ENTRY POINT ADDRESS                                          00100000
*    R14 = RETURN ADDRESS                                               00110000
*    R13 = AVAILABLE SAVE AREA                                          00120000
*    R11 = ICVT ADDRESS                                                 00130000
*    R10 = ITASK ADDRESS                                                00140000
*    R09 = IVTAMCVT ADDRESS                                             00150000
*    R08 = ISESS ADDRESS                                                00160000
*    R01 = ADDRESS OF RECEIVED DATA WORK ELEMENT (IWEXD)                00170000
*                                                                       00180000
* ON EXIT:                                                              00190000
*                                                                       00200000
*    R15 = 0                                                            00210000
*    R00 = 0                                                            00220000
*    R01 = 0                                                            00230000
*                                                                       00240000
*    ALL OTHER REGISTERS ARE RESTORED.                                  00250000
*                                                                       00260000
**<DOC-OFF>************************************************************ 00270000
                                                                        00280000
         EJECT ,                                                        00290000
*********************************************************************** 00300000
*                                                                       00310000
* MAINTENANCE:                                                          00320000
*                                                                       00330000
*   08/01/93 RANDY WITEK                                                00340000
*                                                                       00350000
*********************************************************************** 00360000
                                                                        00370000
         EQUS  ,                  GENERAL EQUATES                       00380000
                                                                        00390000
RICVT    EQU   R11                                                      00400000
RITASK   EQU   R10                                                      00410000
RIVTAM   EQU   R9                                                       00420000
RISESS   EQU   R8                                                       00430000
RIACB    EQU   R7                                                       00440000
RIRPL    EQU   R6                                                       00450000
RIWE     EQU   R5                                                       00460000
RIRQE    EQU   R4                                                       00470000
                                                                        00480000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00490000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00500000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00510000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00520000
         USING IACB,RIACB         ESTABLISH ADDRESSABILITY              00530000
         USING IRPL,RIRPL         ESTABLISH ADDRESSABILITY              00540000
         USING IWEVTAM,RIWE       ESTABLISH ADDRESSABILITY              00550000
         USING IRQE,RIRQE         ESTABLISH ADDRESSABILITY              00560000
                                                                        00570000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00580000
WRK256   DS    XL256              GENERAL WORKAREA                      00590000
RETR15   DS    F                                                        00600000
RETR0    DS    F                                                        00610000
RETR1    DS    F                                                        00620000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00630000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00640000
                                                                        00650000
         $MSGDFT PREFIX=ICTPID,                                        +00660000
               COMPID='VTM',                                           +00670000
               TABLE=*#MSGS,                                           +00680000
               WORKA=0,                                                +00690000
               MF=(E,WRK256),                                          +00700000
               PRINT=NOGEN                                              00710000
                                                                        00720000
IVTMSDAT #ENTER BASE=R12,         ENTRY LINKAGE                        +00730000
               PREG=RIWE,                                              +00740000
               AMODE=31,                                               +00750000
               RMODE=ANY                                                00760000
                                                                        00770000
*---------------------------------------------------------------------- 00780000
* VERIFY THE SESSION CID, IGNORE WORK ELEMENT IF NO MATCH               00790000
*---------------------------------------------------------------------- 00800000
                                                                        00810000
         CLC   ISECID,IWEXDCID      CID MATCH?                          00820000
         BNE   RETURN               BRANCH IF NOT                       00830000
                                                                        00840000
*---------------------------------------------------------------------- 00850000
* IF THIS IS A DATA RECEIVE UPDATE THE MESSAGE AND BYTE COUNTS          00860000
*---------------------------------------------------------------------- 00870000
                                                                        00880000
         TM    IWEXDCTL,RPLDATA     DATA RECEIVE?                       00890000
         BNO   QUEUE                BRANCH IF NOT                       00900000
                                                                        00910000
         L     R1,ISE#MSGI          INBOUND MESSAGE COUNT               00920000
         A     R1,=F'1'             BUMP BY ONE                         00930000
         ST    R1,ISE#MSGI          STORE UPDATED MESSAGE COUNT         00940000
                                                                        00950000
         L     R1,ISE#BYTI          INBOUND BYTE COUNT                  00960000
         A     R1,IWEXDLEN          ADD RECEIVED DATA LENGTH            00970000
         ST    R1,ISE#BYTI          STORE UPDATED BYTE COUNT            00980000
                                                                        00990000
*---------------------------------------------------------------------- 01000000
* QUEUE DFSYN DATA TO SESSION RECEIVE QUEUE & SATISFY $SESS RECEIVE     01010000
*---------------------------------------------------------------------- 01020000
                                                                        01030000
QUEUE    DS    0H                                                       01040000
                                                                        01050000
         $GETSTOR L'IRQ,          ALLOCATE AN IRQE                     +01060000
               LOC=ANY,                                                +01070000
               OWNER=(RITASK)                                           01080000
                                                                        01090000
         LR    RIRQE,R1             ESTABLISH ADDRESSIBILITY            01100000
         MVC   IRQID,=CL8'IRQE'     SET BLOCK ID                        01110000
         MVC   IRQRH(3),IWEXDURH    COPY REQUEST HEADER                 01120000
         MVC   IRQCNTRL(3),IWEXDCTL COPY CONTROL FLAGS                  01130000
         MVC   IRQSEQNO(2),IWEXDSEQ COPY SEQUENCE NUMBER                01140000
         MVC   IRQSENSE(4),IWEXDSNS COPY SENSE INFORMATION              01150000
         MVC   IRQAREA(4),IWEXDBUF  COPY DATA ADDRESS                   01160000
         MVC   IRQAREAL(4),IWEXDLEN COPY DATA LENGTH                    01170000
         OI    IRQF1,IRQF1RSR       A RESETSR IS NEEDED                 01180000
                                                                        01190000
         L     R3,ISERCVTL          LAST IRQE ON THE QUEUE              01200000
         L     R2,IRQNEXT-IRQ(,R3)  NULL ELEMENT POINTER                01210000
         ST    RIRQE,IRQNEXT-IRQ(,R3) SET NEXT POINTER IN LAST IRQE     01220000
         ST    RIRQE,IRQPREV-IRQ(,R2) SET PREV POINTER IN ISERCVTL      01230000
         STM   R2,R3,IRQNEXT        LINK NEW ELEMENT NEXT/PREV          01240000
                                                                        01250000
         L     R15,IVT@SREC         RECEIVE MODULE                      01260000
         BASR  R14,R15              SATISFY RECEIVE REQUEST             01270000
                                                                        01280000
*---------------------------------------------------------------------- 01290000
* RETURN TO CALLER                                                      01300000
*---------------------------------------------------------------------- 01310000
                                                                        01320000
RETURN   DS    0H                                                       01330000
                                                                        01340000
         LM    R15,R1,RETREGS     LOAD RETURN VALUES                    01350000
                                                                        01360000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    01370000
                                                                        01380000
*---------------------------------------------------------------------- 01390000
*  CONSTANTS AND LITERALS                                               01400000
*---------------------------------------------------------------------- 01410000
                                                                        01420000
         LTORG ,                                                        01430000
         PRINT NOGEN                                                    01440000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                01450000
         ISTDBIND ,               VTAM BIND IMAGE                       01460000
         ICVT  ,                  INTEGRATOR CVT                        01470000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   01480000
         IRPL ,                   INTEGRATOR VTAM RPL+                  01490000
         IACB ,                   INTEGRATOR VTAM ACB+                  01500000
         INIB ,                   INTEGRATOR VTAM NIB+                  01510000
         ISESS ,                  INTEGRATOR SESSION BLOCK              01520000
         IRQE ,                   INTEGRATOR RECEIVE QUEUE ELEMENT      01530000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            01540000
         ITASK ,                  INTEGRATOR TASK BLOCK                 01550000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          01560000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       01570000
         EVCODES ,                INTEGRATOR EVENT CODES                01580000
         ABCODES ,                INTEGRATOR $ABEND CODES               01590000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     01600000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        01610000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             01620000
         $PROC DSECT=YES          INTEGRATOR $PROC SERVICES             01630000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             01640000
         IFGEXLST ,               VTAM EXIT LIST                        01650000
         END   ,                                                        01660000

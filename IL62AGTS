IL62AGTS TITLE 'INTEGRATOR - LU6.2 GET SESSION API ROUTINE'             00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: IL62AGTS - LU6.2 GET SESSION API ROUTINE                     00100000
*                                                                       00110000
* DESCRIPTION:                                                          00120000
*                                                                       00130000
*    THIS ROUTINE IS CALLED TO RESERVE A SESSION FOR A NEW              00140000
*    CONVERSATION.                                                      00150000
*                                                                       00160000
* ON ENTRY:                                                             00170000
*                                                                       00180000
*    R15 = ENTRY POINT ADDRESS                                          00190000
*    R14 = RETURN      ADDRESS                                          00200000
*    R13 = SAVE AREA   ADDRESS                                          00210000
*    R01 = PARM LIST   ADDRESS                                          00220000
*                                                                       00230000
*          +00 = ADDRESS OF RCB                                         00240000
*          +04 = ADDRESS OF RETURN CODE AREA                            00250000
*                                                                       00260000
* ON EXIT:                                                              00270000
*                                                                       00280000
*    R15 = 0                                                            00290000
*                                                                       00300000
*    RETURN_CODE = LU62_OK-->GET SESSION SUCCESSFUL                     00310000
*                                                                       00320000
*                = LU62_PARAMETER_ERROR-->UNQUALIFIED PARTNER NAME BAD  00330000
*                = LU62_ALLOCATE_FAILURE_NO_RETRY-->GET SESSION FAILED  00340000
*                                                                       00350000
**<DOC-OFF>************************************************************ 00360000
         EJECT ,                                                        00370000
*********************************************************************** 00380000
*                                                                       00390000
* MAINTENANCE:                                                          00400000
*                                                                       00410000
*   07/01/94 RANDY WITEK                                                00420000
*                                                                       00430000
*********************************************************************** 00440000
                                                                        00450000
         EQUS  ,                  GENERAL EQUATES                       00460000
                                                                        00470000
RICVT    EQU   R11                                                      00480000
RITASK   EQU   R10                                                      00490000
RBASE    EQU   R9                                                       00500000
RIVTAM   EQU   R8                                                       00510000
RPLIST   EQU   R7                                                       00520000
RRCB     EQU   R6                                                       00530000
RTKB     EQU   R5                                                       00540000
                                                                        00550000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00560000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00570000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00580000
         USING L62LIST,RPLIST     ESTABLISH ADDRESSABILITY              00590000
         USING RCB,RRCB           ESTABLISH ADDRESSABILITY              00600000
         USING TKB,RTKB           ESTABLISH ADDRESSABILITY              00610000
                                                                        00620000
         COPY  CRAB               "C" RUNTIME ANCHOR BLOCK              00630000
         USING CRAB,R12           ADDRESSABILITY                        00640000
                                                                        00650000
         COPY  DSA                DYNAMIC SAVE AREA                     00660000
WORKAREA DS    0H                 READ/WRITE WORKAREA                   00670000
WRK256   DS    XL256              GENERAL WORKAREA                      00680000
$TASKMFL $TASK MF=L               PARM LIST CONSTRUCTION                00690000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00700000
RETCODE  DS    F                  TEMPORARY RETURN CODE AREA            00710000
PLUNAMEL DS    F                  UNQUALIFIED PARTNER LU NAME LENGTH    00720000
PLUNAME  DS    CL8                UNQUALIFIED PARTNER LU NAME           00730000
FLAG     DS    X                                                        00740000
WORKLEN  EQU   *-WORKAREA         LENGTH OF USER DSA AREA               00750000
DSALEN   EQU   *-DSA              LENGTH OF DSA                         00760000
                                                                        00770000
         $MSGDFT PREFIX=ICTPID,                                        +00780000
               COMPID='L62',                                           +00790000
               TABLE=*#MSGS,                                           +00800000
               WORKA=0,                                                +00810000
               MF=(E,WRK256),                                          +00820000
               PRINT=NOGEN                                              00830000
                                                                        00840000
IL6AGTS@ CSECT ,                                                        00850000
IL62AGTS CENTRY DSA=DSALEN,BASE=R9,INDEP=YES                            00860000
                                                                        00870000
*---------------------------------------------------------------------- 00880000
* ENTRY                                                                 00890000
*---------------------------------------------------------------------- 00900000
                                                                        00910000
         USING DSA,R13            ADDRESSABILITY                        00920000
         LR    RPLIST,R1          SAVE ADDRESS OF PLIST                 00930000
                                                                        00940000
         LA    R0,WORKAREA        ADDRESS OF USER DSA SECTION           00950000
         LA    R1,WORKLEN         LENGTH  OF USER DSA SECTION           00960000
         SR    R15,R15            PREPARE FOR CLEAR                     00970000
         MVCL  R0,R14             CLEAR USER DSA SECTION                00980000
                                                                        00990000
*---------------------------------------------------------------------- 01000000
* INITIALIZATION                                                        01010000
*---------------------------------------------------------------------- 01020000
                                                                        01030000
         @RESTENV ,               ENSURE ENVIRONMENT                    01040000
                                                                        01050000
         L     RIVTAM,ICTVTCVT    ESTABLISH IVTAMCVT POINTER            01060000
         L     RRCB,L62PARM1      RCB ADDRESS WAS PASSED                01070000
         L     RTKB,RCBTKBID      TKB ADDRESS                           01080000
                                                                        01090000
*---------------------------------------------------------------------- 01100000
* EXTRACT THE UNQUALIFIED PARTNER LU NAME FROM POSSIBLY QUALIFIED NAME  01110000
*---------------------------------------------------------------------- 01120000
                                                                        01130000
         LA    R2,RCBLUNM                 ADDRESS OF PARTNER LU NAME    01140000
         ICM   R3,15,RCBLUNML             LENGTH OF PARTNER LU NAME     01150000
         BNP   ENDNAME                    BRANCH IF BAD LENGTH          01160000
         C     R3,=F'17'                  IS NAME TOO BIG?              01170000
         BH    ENDNAME                    BRANCH IF BAD LENGTH          01180000
                                                                        01190000
GETDOT   DS    0H                                                       01200000
                                                                        01210000
         CLI   0(R2),C'.'                 IS THIS A QUALIFIER?          01220000
         BE    GOTDOT                     BRANCH IF YES                 01230000
         LA    R2,1(,R2)                  BUMP NAME POINTER             01240000
         BCT   R3,GETDOT                  FIND THE SEPARATOR, IF ANY    01250000
         LA    R2,RCBLUNM                 NO DOT, USE NAME AS-IS        01260000
         LR    R14,R2                     ADDRESS OF UNQUALIFIED NAME   01270000
         SR    R15,R15                    LENGTH OF UNQUALIFIED NAME    01280000
         ICM   R3,15,RCBLUNML             NO DOT, USE NAME AS-IS        01290000
         B     GETEND                     NOW FIND THE END OF NAME      01300000
                                                                        01310000
GOTDOT   DS    0H                                                       01320000
                                                                        01330000
         LA    R2,1(,R2)                  BUMP PAST DOT                 01340000
         LR    R14,R2                     ADDRESS OF UNQUALIFIED NAME   01350000
         SR    R15,R15                    LENGTH OF UNQUALIFIED NAME    01360000
         BCT   R3,GETEND                  NOW FIND THE END OF NAME      01370000
         B     ENDNAME                    BRANCH IF BAD LENGTH          01380000
                                                                        01390000
GETEND   DS    0H                                                       01400000
                                                                        01410000
         CLI   0(R2),C' '                 IS IT A CHARACTER?            01420000
         BNH   GOTEND                     BRANCH IF NOT                 01430000
         LA    R2,1(,R2)                  BUMP NAME POINTER             01440000
         LA    R15,1(,R15)                BUMP LENGTH OF UNQUALIFIED NM 01450000
         BCT   R3,GETEND                  AND CHECK ALL CHARACTERS      01460000
                                                                        01470000
GOTEND   DS    0H                                                       01480000
                                                                        01490000
         LTR   R15,R15                    IS UNQUALIFIED NAME OK?       01500000
         BNP   ENDNAME                    BRANCH IF BAD LENGTH          01510000
         C     R15,=F'8'                  IS UNQUALIFIED NAME OK?       01520000
         BH    ENDNAME                    BRANCH IF BAD LENGTH          01530000
         ST    R15,PLUNAMEL               SET UNQUALIFIED NAME LENGTH   01540000
         ICM   R15,B'1000',=C' '          BLANK PAD THE NAME TO 8 BYTES 01550000
         LA    R0,PLUNAME                 AREA TO RECEIVE NAME          01560000
         LA    R1,8                       LENGTH OF RECEIVING AREA      01570000
         MVCL  R0,R14                     COPY UNQUALIFIED NAME         01580000
                                                                        01590000
ENDNAME  DS    0H                                                       01600000
                                                                        01610000
*---------------------------------------------------------------------- 01620000
* ENTRY TRACE                                                           01630000
*---------------------------------------------------------------------- 01640000
                                                                        01650000
         $TRACE *=A(TRC_LU62_IL62AGTS),96 TRACE ENTRY W/ 96 USER BYTES  01660000
         BNZ   NOETRACE                   BRANCH IF NOT TRACING         01670000
         $APITRC IL62AGTS                 TRACE COMMON STUFF            01680000
         ST    RPLIST,24(,R1)             TRACE PARMLIST ADDRESS        01690000
         MVC   28(4,R1),PLUNAMEL          TRACE LUNAME LENGTH           01700000
         MVC   32(8,R1),PLUNAME           TRACE LUNAME                  01710000
         MVC   40(4,R1),RCBMDNML          TRACE MODE NAME LENGTH        01720000
         MVC   44(8,R1),RCBMDNM           TRACE MODE NAME               01730000
         MVC   52(8,R1),TKBTCBID          TRACE IPCB WORK UNIT TOKEN    01740000
         ST    RTKB,64(,R1)               TRACE TKB                     01750000
         ST    RRCB,68(,R1)               TRACE RCB                     01760000
         MVC   72(8,R1),TKBOWNLU          TRACE LOCAL LU                01770000
         MVC   80(4,R1),RCBRCTRL          TRACE RETURN_CONTROL          01780000
         MVC   84(4,R1),RCBSYNCL          TRACE SYNC_LEVEL              01790000
         MVC   88(4,R1),RCBSECUR          TRACE SECURITY_TYPE           01800000
NOETRACE DS    0H                                                       01810000
                                                                        01820000
*---------------------------------------------------------------------- 01830000
* IF THE UNQUALIFIED PARTNER LU NAME APPEARS BAD...END THE ALLOCATE     01840000
*---------------------------------------------------------------------- 01850000
                                                                        01860000
         ICM   R1,15,PLUNAMEL     WAS A NAME EXTRACTED?                 01870000
         BNP   ERRPARM            BRANCH IF NOT                         01880000
                                                                        01890000
*---------------------------------------------------------------------- 01900000
* NO ALLOCATES DURING SYSTEM/TASK TERMINATION                           01910000
*---------------------------------------------------------------------- 01920000
                                                                        01930000
         TM    ICTSTAT3,ICT3$P+ICT3$PX                                  01940000
         BNZ   ERRAFNR            BRANCH IF SYSTEM TERMINATING          01950000
         TM    IVTF1,IVTF1TRM                                           01960000
         BO    ERRAFNR            BRANCH IF VTAM MAIN TASK TERMINATING  01970000
                                                                        01980000
*---------------------------------------------------------------------- 01990000
* ALLOCATE A GET SESSION WORK ELEMENT                                   02000000
*---------------------------------------------------------------------- 02010000
                                                                        02020000
         $VTAMWE L'IWEXR,         SIZE                                 +02030000
               IWECGETS           CODE                                  02040000
                                                                        02050000
         LR    R3,R1              ESTABLISH ADDRESSABILITY              02060000
                                                                        02070000
*---------------------------------------------------------------------- 02080000
* ALLOCATE AN XEPB                                                      02090000
*---------------------------------------------------------------------- 02100000
                                                                        02110000
         $TASK SETEPB,            INITIALIZE EPB FOR SYNCH REQUEST     +02120000
               ECODE=EC$GETS,     GET SESSION EVENT                    +02130000
               ERRET=ERR$TASK,                                         +02140000
               MF=(E,$TASKMFL)                                          02150000
                                                                        02160000
         LR    R4,R1              R4 HAS THE XEPB ADDRESS               02170000
                                                                        02180000
*---------------------------------------------------------------------- 02190000
* FILL IN THE WORK ELEMENT                                              02200000
*---------------------------------------------------------------------- 02210000
                                                                        02220000
         USING IWEVTAM,R3                                               02230000
         MVC   IWEXRENT,TKBTCBID  ENTITY TOKEN                          02240000
         ST    R4,IWEXREPB        EPB ADDRESS                           02250000
         ST    RTKB,IWEXRTKB      TKB ADDRESS                           02260000
         ST    RRCB,IWEXRRCB      RCB ADDRESS                           02270000
         MVC   IWEXRLLU,TKBOWNLU  LOCAL LU NAME                         02280000
         LA    R0,IWEXRPLU        PARTNER LU NAME AREA                  02290000
         LA    R1,L'IWEXRPLU      LENGTH OF PARTNER LU NAME AREA        02300000
         LA    R14,PLUNAME        ADDRESS OF UNQUALIFIED NAME           02310000
         L     R15,PLUNAMEL       UNQUALIFIED NAME LENGTH               02320000
         ICM   R15,B'1000',=C' '  BLANK PAD THE NAME                    02330000
         MVCL  R0,R14             PARTNER LU NAME                       02340000
         MVC   IWEXRPLL,PLUNAMEL  PARTNER LU NAME LENGTH                02350000
         MVC   IWEXRMDE,RCBMDNM   MODE NAME                             02360000
         MVC   IWEXRMDL,RCBMDNML  MODE NAME LENGTH                      02370000
         MVC   IWEXRRCT,RCBRCTRL  RETURN CONTROL                        02380000
         MVC   IWEXRSYN,RCBSYNCL  SYNC LEVEL                            02390000
         MVC   IWEXRSEC,RCBSECUR  SECURITY                              02400000
         DROP  R3                                                       02410000
                                                                        02420000
*---------------------------------------------------------------------- 02430000
* QUEUE THE GET SESSION WORK ELEMENT TO THE VTAM MAIN QUEUE             02440000
*---------------------------------------------------------------------- 02450000
                                                                        02460000
         $VTAMQ (R3),             WORK ELEMENT                         +02470000
               IVTWEQ             QUEUE                                 02480000
                                                                        02490000
         LTR   R15,R15            WAS QUEUEING SUCCESSFUL?              02500000
         BNZ   ERRAFNR            BRANCH IF NOT                         02510000
                                                                        02520000
*---------------------------------------------------------------------- 02530000
* WAIT FOR POSTING OF THE REQUEST                                       02540000
*---------------------------------------------------------------------- 02550000
                                                                        02560000
         $TASK WAIT,              WAIT FOR REQUEST COMPLETION          +02570000
               EPB=(R4),          XEPB ADDRESS                         +02580000
               MF=(E,$TASKMFL)                                          02590000
                                                                        02600000
         LTR   R0,R0              POST CODE IS RETURNED IN R0           02610000
         BZ    RETURN             BRANCH IF SUCCESSFUL GET SESSION      02620000
         B     ERRAFNR            BRANCH IF NOT                         02630000
                                                                        02640000
*---------------------------------------------------------------------- 02650000
* EXCEPTION ROUTINES                                                    02660000
*---------------------------------------------------------------------- 02670000
                                                                        02680000
ERRPARM  DS    0H                                                       02690000
                                                                        02700000
         MVC   RETCODE,=A(LU62_PARAMETER_ERROR)                         02710000
         B     RETURN                                                   02720000
                                                                        02730000
ERRAFNR  DS    0H                                                       02740000
                                                                        02750000
         MVC   RETCODE,=A(LU62_ALLOCATE_FAILURE_NO_RETRY)               02760000
         B     RETURN                                                   02770000
                                                                        02780000
*---------------------------------------------------------------------- 02790000
* EXIT TRACE AND RETURN TO CALLER                                       02800000
*---------------------------------------------------------------------- 02810000
                                                                        02820000
RETURN   DS    0H                                                       02830000
                                                                        02840000
         $TRACE *=A(TRC_LU62_EXIT),16 TRACE ENTRY W/ 16 USER BYTES      02850000
         BNZ   NOXTRACE               BRANCH IF TRACING NOT AVAILABLE   02860000
         MVC   0(8,R1),=CL8'IL62AGTS' MODULE NAME                       02870000
         MVC   8(4,R1),RETCODE        RETURN_CODE VALUE                 02880000
NOXTRACE DS    0H                                                       02890000
                                                                        02900000
         L     R1,L62PARM2        ADDRESS OF RETURN_CODE AREA           02910000
         MVC   0(4,R1),RETCODE    SET RETURN_CODE VARIABLE              02920000
                                                                        02930000
         SR    R15,R15            FUNCTION RETURN CODE = 0              02940000
         CEXIT RC=(R15),INDEP=YES RETURN                                02950000
                                                                        02960000
*---------------------------------------------------------------------- 02970000
* ERROR ROUTINES                                                        02980000
*---------------------------------------------------------------------- 02990000
                                                                        03000000
ERR$TASK DS    0H                                                       03010000
                                                                        03020000
         $ABEND ABE_VTDIAG,                                            +03030000
               SCOPE=PCB,                                              +03040000
               TITLE='$TASK FAILURE'                                    03050000
                                                                        03060000
*---------------------------------------------------------------------- 03070000
* LITERALS AND CONSTANTS                                                03080000
*---------------------------------------------------------------------- 03090000
                                                                        03100000
         LTORG ,                                                        03110000
         PRINT NOGEN                                                    03120000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                03130000
         IKJTCB ,                 MVS TASK CONTROL BLOCK                03140000
         ISTDBIND ,               VTAM BIND IMAGE                       03150000
         TRACODES ,               INTEGRATOR TRACE CODES                03160000
         ICVT  ,                  INTEGRATOR CVT                        03170000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   03180000
         IRPL ,                   INTEGRATOR VTAM RPL+                  03190000
         IACB ,                   INTEGRATOR VTAM ACB+                  03200000
         INIB ,                   INTEGRATOR VTAM NIB+                  03210000
         ISESS ,                  INTEGRATOR SESSION BLOCK              03220000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            03230000
         ITASK ,                  INTEGRATOR TASK BLOCK                 03240000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          03250000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       03260000
         EVCODES ,                INTEGRATOR EVENT CODES                03270000
         ABCODES ,                INTEGRATOR $ABEND CODES               03280000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     03290000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        03300000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             03310000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             03320000
         IFGEXLST ,               VTAM EXIT LIST                        03330000
         END   ,                                                        03340000

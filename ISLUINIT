ISLUINIT TITLE ' - VIRTUAL SESSION IMAGING AND RECORDING - INIT'        00010000
***************************************************************         00020000
*                                                                       00030000
* ROUTINE:  ISLUINIT - INITIALIZATION                                   00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THIS ROUTINE ESTABLISHES THE SESSIMAG CONTROL AREA USED TO         00080000
*    INTERFACE THE VIRTUAL 3270 FUNCTIONS TO THE 3270 SESSION           00090000
*    IMAGING AND SESSION RECORDING FUNCTIONS.  THE FUNCTION             00100000
*    ANCHORS A PTR TO THE SESSIMAG STRUCTURE IN THE "HANDLE"            00110000
*    RETURN AREA PROVIDED BY THE CALLER.  SUBSEQUENT ISES*              00120000
*    REQUESTS IDENTIFY THE STRUCTURE VIA THE HANDLE.                    00130000
*                                                                       00140000
*                                                                       00150000
* ON ENTRY:                                                             00160000
*                                                                       00170000
*    R1  CONTAINS THE ADDRESS OF A PARAMETER LIST DESCRIBED BY          00180000
*        THE SSINIT PARAMETER LIST AS EXPANDED VIA SESSERV INIT.        00190000
*                                                                       00200000
*                                                                       00210000
* ON EXIT:                                                              00220000
*                                                                       00230000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES                     00240000
*                                                                       00250000
*        RC00 - INITIALIZATION COMPLETE                                 00260000
*                                                                       00270000
*        RC16 - MISSING OR INVALID HANDLE PTR                           00280000
*                                                                       00290000
*        RC20 - REQUIRED STORAGE NOT AVAILABLE                          00300000
*                                                                       00310000
***************************************************************         00320000
         EJECT                                                          00330000
         #WORK ,                                                        00340000
         #ENDWORK ,                                                     00350000
                                                                        00360000
         EJECT                                                          00370000
         SESSIMAG ,               EMULATOR IMAGING / RECORDING          00380000
                                                                        00390000
         EJECT                                                          00400000
         SESSERV INIT                                                   00410000
                                                                        00420000
         EJECT                                                          00430000
         IUSER ,                  USER INFORMATION BLOCK                00440000
                                                                        00450000
         EJECT                                                          00460000
         EQUS ,                                                         00470000
                                                                        00480000
         EJECT                                                          00490000
ISLUINIT #ENTER PREG=R8                                                 00500000
                                                                        00510000
         USING ICVT,R11           STANDARD ENVIRONMENT                  00520000
         USING ITASK,R10                                                00530000
                                                                        00540000
         EJECT                                                          00550000
***************************************************************         00560000
*                                                                       00570000
*   ACQUIRE SESSIMAG BLOCK AND INITIALIZE IT                            00580000
*                                                                       00590000
***************************************************************         00600000
         USING SSINIT,R8          PARAMETER LIST                        00610000
         ICM   R0,15,SSIHPTR      HANDLE RETURN AREA PROVIDED?          00620000
         BZ    ERR_HNDL           ERROR IF NOT                          00630000
         SR    R7,R7              SESSIMAG NOT YET ALLOCATED            00640000
                                                                        00650000
         $GETSTOR SEILN,COND=YES                                        00660000
         LTR   R15,R15            STORAGE AVAILABLE?                    00670000
         BNZ   ERR_STG            FAIL REQUEST IF NOT                   00680000
                                                                        00690000
         LR    R7,R1              SESSIMAG FORMATTING                   00700000
         USING SEI,R7             LIFE OF FUNCTION                      00710000
         L     R6,SSIHPTR         HANDLE PTR                            00720000
         ST    R7,0(,R6)          POST FOR SUBSEQUENT REQUESTS          00730000
                                                                        00740000
*--------------------------------------------------------------         00750000
*   INITIALIZE SESSIMAG FROM PASSED PARAMETERS                          00760000
*--------------------------------------------------------------         00770000
         MVC   SEIEYE,=CL8'SESSIMAG'                                    00780000
         L     R2,SSIIUSER        IUSER CONTROL BLOCK                   00790000
         ST    R2,SEIIUSER                                              00800000
         MVC   SEIIPROJ,USRPROJ-IUSER(R2)                               00810000
                                                                        00820000
         OI    SEIS0ATR,SEIA_CLR  PRESUMED INITIAL VDEVICE STATE        00830000
         OI    SEIS1ATR,SEIA_CLR  SUPPORTING INITIAL SKS DERIVATION     00840000
         OI    SEIS1ATR,SEIA_RSP  NO RESPONSE YET RECEIVED FROM HOST    00850000
         OI    SEISTATE,SEIS_FUS  INITIAL STATE, TRANSITION FROM VTAM   00860000
                                                                        00870000
         L     R2,SSIAPPL         APPL NAME                             00880000
         MVC   SEIAPPL,0(R2)                                            00890000
         L     R2,SSILMODE        LOGMODE NAME                          00900000
         MVC   SEILMODE,0(R2)                                           00910000
                                                                        00920000
         L     R1,SSIPROWS        PRIMARY SCREEN, ROW COUNT             00930000
         STH   R1,SEIPROWS                                              00940000
         L     R2,SSIPCOLS        PRIMARY SCREEN, COL COUNT             00950000
         STH   R2,SEIPCOLS                                              00960000
         MR    R0,R2              TOTAL BUFFER REQUIREMENT              00970000
         ST    R1,SEIPRISZ                                              00980000
                                                                        00990000
         L     R1,SSIAROWS        ALTERNATE SCREEN, ROW COUNT           01000000
         STH   R1,SEIAROWS                                              01010000
         L     R2,SSIACOLS        ALTERNATE SCREEN, COL COUNT           01020000
         STH   R2,SEIACOLS                                              01030000
         MR    R0,R2              TOTAL BUFFER REQUIREMENT              01040000
         ST    R1,SEIALTSZ                                              01050000
                                                                        01060000
         CL    R1,SEIPRISZ        ALTERNATE IS LARGEST SIZE?            01070000
         BNL   *+8                SKIP IF SO                            01080000
         L     R1,SEIPRISZ        PRIMARY IS LARGER                     01090000
         LR    R3,R1              SIZE OF LARGEST SCREEN IMAGE          01100000
         ST    R3,SEIMGLEN        LENGTH OF ALL IMAGE BUFFERS           01110000
                                                                        01120000
*--------------------------------------------------------------         01130000
*   ACQUIRE STORAGE FOR LONG TERM 'CURRENT' IMAGE BUFFER                01140000
*--------------------------------------------------------------         01150000
         MVC   SEIS1SIZ,SEIPRISZ  INITIAL IMAGE A REFLECTION OF PRIMARY 01160000
         MVC   SEIS1ROW,SEIPROWS  ROWS                                  01170000
         MVC   SEIS1COL,SEIPCOLS  COLS                                  01180000
                                                                        01190000
         $GETSTOR (R3),COND=YES                                         01200000
         LTR   R15,R15            STORAGE AVAILABLE                     01210000
         BNZ   ERR_STG            FAIL REQUEST IF NOT                   01220000
         ST    R1,SEIS1IMG        CURRENT IMAGE BUFFER                  01230000
                                                                        01240000
         LA    R15,RC00           SUCCESS                               01250000
         B     INIT_FIN           DONE                                  01260000
                                                                        01270000
*--------------------------------------------------------------         01280000
*   MISSING OR INVALID HANDLE / PTR                                     01290000
*--------------------------------------------------------------         01300000
ERR_HNDL DS    0H                                                       01310000
         LA    R15,RC16                                                 01320000
         B     INIT_FIN                                                 01330000
                                                                        01340000
*--------------------------------------------------------------         01350000
*   STORAGE NOT AVAILABLE, TERMINATE                                    01360000
*--------------------------------------------------------------         01370000
ERR_STG  DS    0H                                                       01380000
         LTR   R7,R7              SESSIMAG ALLOCATED?                   01390000
         BZ    ESTG_RSM           RELEASE NOT REQUIRED OTHERWISE        01400000
                                                                        01410000
         @CALL ISLUTERM,CTYPE=CVT,MF=(E,(R8))                           01420000
                                                                        01430000
ESTG_RSM DS    0H                                                       01440000
         LA    R15,RC20           STORAGE NOT AVAILABLE                 01450000
                                                                        01460000
*--------------------------------------------------------------         01470000
*   RETURN COMPLETION STATUS TO REQUESTOR                               01480000
*--------------------------------------------------------------         01490000
INIT_FIN DS    0H                                                       01500000
         #EXIT ,                                                        01510000
                                                                        01520000
         EJECT                                                          01530000
***************************************************************         01540000
*                                                                       01550000
*   LOCAL READ-ONLY DATA AREAS                                          01560000
*                                                                       01570000
***************************************************************         01580000
         LTORG ,                                                        01590000
                                                                        01600000
         PRINT NOGEN                                                    01610000
         ICVT  ,                                                        01620000
         ITASK ,                                                        01630000
         END   ,                                                        01640000

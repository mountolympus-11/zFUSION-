ICPIRTS TITLE 'INTEGRATOR - CPIC CMRTS API - REQUEST TO SEND'           00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: ICPIRTS - CPIC CMRTS API                                     00100000
*                                                                       00110000
* DESCRIPTION:                                                          00120000
*                                                                       00130000
*    THIS ROUTINE IS CALLED TO PROCESS THE CMRTS VERB.                  00140000
*                                                                       00150000
* ON ENTRY:                                                             00160000
*                                                                       00170000
*    R15 = ENTRY POINT ADDRESS                                          00180000
*    R14 = RETURN      ADDRESS                                          00190000
*    R13 = SAVE AREA   ADDRESS                                          00200000
*    R01 = PARM LIST   ADDRESS                                          00210000
*                                                                       00220000
*          +00 = ADDRESS OF CONVERSATION_ID                             00230000
*          +04 = ADDRESS OF RETURN_CODE RETURN AREA                     00240000
*                                                                       00250000
* ON EXIT:                                                              00260000
*                                                                       00270000
*    R15 = 0                                                            00280000
*                                                                       00290000
*    RETURN_CODE = CM_OK                      --> CMRTS SUCCESSFUL      00300000
*                = CM_PROGRAM_PARAMETER_CHECK --> INVALID CONV_ID       00310000
*                = CM_PROGRAM_STATE_CHECK     --> INVALID STATE         00320000
*                = CM_PRODUCT_SPECIFIC_ERROR  --> BAD PARM              00330000
*                = CM_OPERATION_NOT_ACCEPTED  --> N/A                   00340000
*                                                                       00350000
**<DOC-OFF>************************************************************ 00360000
         EJECT ,                                                        00370000
*********************************************************************** 00380000
*                                                                       00390000
* MAINTENANCE:                                                          00400000
*                                                                       00410000
*   07/01/94 RANDY WITEK                                                00420000
*                                                                       00430000
*********************************************************************** 00440000
                                                                        00450000
         EQUS  ,                  GENERAL EQUATES                       00460000
                                                                        00470000
RICVT    EQU   R11                                                      00480000
RITASK   EQU   R10                                                      00490000
RBASE    EQU   R9                                                       00500000
RIVTAM   EQU   R8                                                       00510000
RCMLIST  EQU   R7                                                       00520000
RTKB     EQU   R6                                                       00530000
RRCB     EQU   R5                                                       00540000
RISESS   EQU   R4                                                       00550000
                                                                        00560000
         USING DSA,R13            ESTABLISH ADDRESSABILITY              00570000
         USING CRAB,R12           ESTABLISH ADDRESSABILITY              00580000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00590000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00600000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00610000
         USING CMLIST,RCMLIST     ESTABLISH ADDRESSABILITY              00620000
         USING TKB,RTKB           ESTABLISH ADDRESSABILITY              00630000
         USING RCB,RRCB           ESTABLISH ADDRESSABILITY              00640000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00650000
                                                                        00660000
         COPY  CRAB               "C" RUNTIME ANCHOR BLOCK              00670000
         COPY  DSA                DYNAMIC SAVE AREA                     00680000
WORKAREA DS    0H                 READ/WRITE WORKAREA                   00690000
WRK256   DS    XL256              GENERAL WORKAREA                      00700000
$SESSMFL $SESS MF=L               PLIST CONSTRUCTION                    00710000
$TASKMFL $TASK MF=L               PLIST CONSTRUCTION                    00720000
SAVEEPB  DS    A                  XEPB ADDRESS                          00730000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00740000
CONVID   DS    XL8                TEMPORARY CONVERSATION ID AREA        00750000
RETCODE  DS    F                  TEMPORARY RETURN CODE     AREA        00760000
CONVS    DS    F                  TEMPORARY CONV STATE      AREA        00770000
FLAG     DS    X                                                        00780000
FLAGIERR EQU   X'80'                                                    00790000
FLAGLOCK EQU   X'40'                                                    00800000
FLAGLCKD EQU   X'20'                                                    00810000
WORKLEN  EQU   *-WORKAREA         LENGTH OF USER DSA AREA               00820000
DSALEN   EQU   *-DSA              LENGTH OF DSA                         00830000
                                                                        00840000
         $MSGDFT PREFIX=ICTPID,                                        +00850000
               COMPID='CPI',                                           +00860000
               TABLE=*#MSGS,                                           +00870000
               WORKA=0,                                                +00880000
               MF=(E,WRK256),                                          +00890000
               PRINT=NOGEN                                              00900000
                                                                        00910000
ICPRTS@  CSECT ,                                                        00920000
ICPIRTS  CENTRY DSA=DSALEN,BASE=RBASE,INDEP=YES                         00930000
                                                                        00940000
*---------------------------------------------------------------------- 00950000
* ENTRY                                                                 00960000
*---------------------------------------------------------------------- 00970000
                                                                        00980000
         LR    RCMLIST,R1         SAVE ADDRESS OF PLIST                 00990000
                                                                        01000000
         LA    R0,WORKAREA        ADDRESS OF USER DSA SECTION           01010000
         LA    R1,WORKLEN         LENGTH  OF USER DSA SECTION           01020000
         SR    R15,R15            PREPARE FOR CLEAR                     01030000
         MVCL  R0,R14             CLEAR USER DSA SECTION                01040000
                                                                        01050000
*---------------------------------------------------------------------- 01060000
* INITIALIZATION                                                        01070000
*---------------------------------------------------------------------- 01080000
                                                                        01090000
         @RESTENV ,               ENSURE ENVIRONMENT                    01100000
                                                                        01110000
         L     RIVTAM,ICTVTCVT    ESTABLISH IVTAMCVT POINTER            01120000
                                                                        01130000
         MVC   CONVID,=XL8'55AA55AA55AA55AA'                            01140000
         MVC   CONVS,=XL4'55AA55AA'                                     01150000
                                                                        01160000
         L     R1,CMLPARM2        ADDRESS OF RETURN_CODE AREA           01170000
         MVC   0(4,R1),0(R1)      TEST MOVEMENT                         01180000
                                                                        01190000
         ICM   R1,15,CMLPARM1     ADDRESS OF CONVERSATION ID            01200000
         BNP   INITERR            BRANCH IF BAD                         01210000
         MVC   CONVID,0(R1)       COPY CONVID                           01220000
         B     INITEND                                                  01230000
                                                                        01240000
INITERR  DS    0H                                                       01250000
                                                                        01260000
         OI    FLAG,FLAGIERR      REMEMBER ERROR DETECTED               01270000
                                                                        01280000
INITEND  DS    0H                                                       01290000
                                                                        01300000
*---------------------------------------------------------------------- 01310000
* ENTRY TRACE                                                           01320000
*---------------------------------------------------------------------- 01330000
                                                                        01340000
         $TRACE *=A(TRC_CPIC_ICPIRTS),48 TRACE ENTRY W/ 48 USER BYTES   01350000
         BNZ   NOETRACE                  BRANCH IF NOT TRACING          01360000
         $APITRC ICPIRTS                 TRACE COMMON STUFF             01370000
         ST    RCMLIST,24(,R1)           TRACE PARMLIST ADDRESS         01380000
         MVC   32(8,R1),CONVID           TRACE CONVERSATION ID          01390000
NOETRACE DS    0H                                                       01400000
                                                                        01410000
*---------------------------------------------------------------------- 01420000
* LOCATE SPECIFIED CONVERSATION                                         01430000
*---------------------------------------------------------------------- 01440000
                                                                        01450000
         TM    FLAG,FLAGIERR             ERROR DETECTED ALREADY?        01460000
         BO    ERRPROD                   BRANCH IF YES                  01470000
                                                                        01480000
         LA    R1,CONVID                 ADDRESS OF CONVERSATION ID     01490000
         L     R15,ICP@LOC               ENTRY POINT OF TKB/RCB LOCATE  01500000
         BASR  R14,R15                   LOCATE THE TKB/RCB             01510000
         LTR   RTKB,R1                   TKB ADDRESS                    01520000
         BNP   ERRPARM                   BRANCH IF BAD                  01530000
         LTR   RRCB,R0                   RCB ADDRESS                    01540000
         BNP   ERRPARM                   BRANCH IF BAD                  01550000
                                                                        01560000
         MVC   CONVS,RCBCONVS            COPY CONV STATE                01570000
                                                                        01580000
*---------------------------------------------------------------------- 01590000
* STATE CHECKS                                                          01600000
*---------------------------------------------------------------------- 01610000
                                                                        01620000
         CLC   CONVS,=A(CM_INITIALIZE_STATE)                            01630000
         BE    ERRSTATE                                                 01640000
         CLC   CONVS,=A(CM_DEFER_RECEIVE_STATE)                         01650000
         BE    ERRSTATE                                                 01660000
         CLC   CONVS,=A(CM_DEFER_DEALLOCATE_STATE)                      01670000
         BE    ERRSTATE                                                 01680000
         B     RTSEND                                                   01690000
                                                                        01700000
*---------------------------------------------------------------------- 01710000
* PERFORM REQUEST TO SEND OPERATION                                     01720000
*---------------------------------------------------------------------- 01730000
                                                                        01740000
RTSEND   DS    0H                                                       01750000
                                                                        01760000
*                                                                       01770000
* RESERVE THE SESSION                                                   01780000
*---------------------------------------------------------------------- 01790000
                                                                        01800000
         BAS   R14,VTAMLOCK                                             01810000
                                                                        01820000
         $SESS $SESS_FIND_SESSION,                                     +01830000
               SESSION=RCBHSID,                                        +01840000
               ERRET=ERRPROD,                                          +01850000
               MF=(E,$SESSMFL)    LOCATE ASSOCIATED ISESS, IF ANY       01860000
                                                                        01870000
X        USING SPLIST,$SESSMFL                                          01880000
         L     RISESS,X.SPLAREA   ADDRESS OF ASSOCIATED ISESS BLOCK     01890000
         DROP  X                                                        01900000
                                                                        01910000
         TM    ISEF1,ISEF1TRM     SESS TERM STARTED?                    01920000
         BO    ERRPROD            BRANCH IF YES                         01930000
         TM    ISE62FL2,ISE62DRD  IS DRIVER DOWN?                       01940000
         BO    ERRPROD            BRANCH IF YES                         01950000
                                                                        01960000
*                                                                       01970000
* ALLOCATE A CPIC REQUEST WORK ELEMENT                                  01980000
*---------------------------------------------------------------------- 01990000
                                                                        02000000
         $VTAMWE L'IWEXZ,         SIZE                                 +02010000
               IWECRTS            CODE                                  02020000
                                                                        02030000
         LR    R3,R1              ESTABLISH ADDRESSABILITY              02040000
                                                                        02050000
*                                                                       02060000
* ALLOCATE AN XEPB                                                      02070000
*---------------------------------------------------------------------- 02080000
                                                                        02090000
         $TASK SETEPB,            INITIALIZE EPB FOR SYNCH REQUEST     +02100000
               ECODE=EC$RTS,      EVENT CODE                           +02110000
               ERRET=ERR$TASK,                                         +02120000
               MF=(E,$TASKMFL)                                          02130000
                                                                        02140000
         ST    R1,SAVEEPB         SAVE THE XEPB ADDRESS                 02150000
                                                                        02160000
*                                                                       02170000
* FILL IN THE CPIC RTS REQUEST WORK ELEMENT                             02180000
*---------------------------------------------------------------------- 02190000
                                                                        02200000
         USING IWEVTAM,R3                                               02210000
         MVC   IWEXZENT,TKBTCBID  ENTITY TOKEN                          02220000
         MVC   IWEXZEPB,SAVEEPB   EPB ADDRESS                           02230000
         ST    RRCB,IWEXZRCB      RCB ADDRESS                           02240000
         DROP  R3                                                       02250000
                                                                        02260000
*                                                                       02270000
* QUEUE THE CPIC RTS REQUEST WORK ELEMENT TO THE SESSION QUEUE          02280000
*---------------------------------------------------------------------- 02290000
                                                                        02300000
         $VTAMQ (R3),             WORK ELEMENT                         +02310000
               ISEWEQ             QUEUE                                 02320000
                                                                        02330000
*                                                                       02340000
* RELEASE SERIALIZATION & WAIT FOR POSTING OF THE CPIC RTS REQUEST      02350000
*---------------------------------------------------------------------- 02360000
                                                                        02370000
         BAS   R14,VTAMUNLK       RELEASE LOCK                          02380000
                                                                        02390000
         $TASK WAIT,              WAIT FOR REQUEST COMPLETION          +02400000
               EPB=*SAVEEPB,      XEPB ADDRESS                         +02410000
               MF=(E,$TASKMFL)                                          02420000
                                                                        02430000
         LTR   R15,R0             POST CODE (R0) IS RETURNED IN R15     02440000
         BNZ   ERRPROD            BRANCH IF NOT SUCCESSFUL              02450000
         B     RETURN                                                   02460000
                                                                        02470000
*---------------------------------------------------------------------- 02480000
* EXCEPTION ROUTINES                                                    02490000
*---------------------------------------------------------------------- 02500000
                                                                        02510000
ERRPROD  DS    0H                                                       02520000
                                                                        02530000
         MVC   RETCODE,=A(CM_PRODUCT_SPECIFIC_ERROR)                    02540000
         B     RETURN                                                   02550000
                                                                        02560000
ERRSTATE DS    0H                                                       02570000
                                                                        02580000
         MVC   RETCODE,=A(CM_PROGRAM_STATE_CHECK)                       02590000
         B     RETURN                                                   02600000
                                                                        02610000
ERRPARM  DS    0H                                                       02620000
                                                                        02630000
         MVC   RETCODE,=A(CM_PROGRAM_PARAMETER_CHECK)                   02640000
         B     RETURN                                                   02650000
                                                                        02660000
*---------------------------------------------------------------------- 02670000
* EXIT TRACE AND RETURN TO CALLER                                       02680000
*---------------------------------------------------------------------- 02690000
                                                                        02700000
RETURN   DS    0H                                                       02710000
                                                                        02720000
         BAS   R14,VTAMUNLK           RELEASE THE LOCK IF NECESSARY     02730000
                                                                        02740000
         $TRACE *=A(TRC_CPIC_EXIT),48 TRACE ENTRY                       02750000
         BNZ   NOXTRACE               BRANCH IF TRACING NOT AVAILABLE   02760000
         MVC   0(8,R1),=CL8'ICPIRTS'  MODULE NAME                       02770000
         MVC   8(4,R1),RETCODE        RETURN_CODE VALUE                 02780000
         MVC   12(8,R1),CONVID        CONVERSATION ID                   02790000
         MVC   20(4,R1),CONVS         CONVERSATION STATE                02800000
NOXTRACE DS    0H                                                       02810000
                                                                        02820000
         L     R1,CMLPARM2        ADDRESS OF RETURN_CODE AREA           02830000
         MVC   0(4,R1),RETCODE    SET RETURN_CODE VARIABLE              02840000
                                                                        02850000
         SR    R15,R15            FUNCTION RETURN CODE = 0              02860000
         CEXIT RC=(R15),INDEP=YES RETURN                                02870000
                                                                        02880000
*---------------------------------------------------------------------- 02890000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 02900000
*---------------------------------------------------------------------- 02910000
                                                                        02920000
VTAMLOCK DS    0H                                                       02930000
                                                                        02940000
         TM    FLAG,FLAGLOCK        WAS THE LOCK ALREADY OBTAINED?      02950000
         BOR   R14                  RETURN IF YES                       02960000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             02970000
                                                                        02980000
         $SER  OBTAIN,                                                 +02990000
               VTAM                                                     03000000
                                                                        03010000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              03020000
         BNE   VTAMLOEX             BRANCH IF NOT                       03030000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         03040000
                                                                        03050000
VTAMLOEX DS    0H                                                       03060000
                                                                        03070000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               03080000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          03090000
         BR    R14                  RETURN                              03100000
                                                                        03110000
*---------------------------------------------------------------------- 03120000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                03130000
*---------------------------------------------------------------------- 03140000
                                                                        03150000
VTAMUNLK DS    0H                                                       03160000
                                                                        03170000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       03180000
         BNOR  R14                  BRANCH IF NOT                       03190000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             03200000
         BOR   R14                  DON'T RELEASE IF IT WAS             03210000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             03220000
                                                                        03230000
         $SER  RELEASE,                                                +03240000
               VTAM                                                     03250000
                                                                        03260000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  03270000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          03280000
         BR    R14                  RETURN                              03290000
                                                                        03300000
*---------------------------------------------------------------------- 03310000
* ERROR ROUTINES                                                        03320000
*---------------------------------------------------------------------- 03330000
                                                                        03340000
ERR$TASK DS    0H                                                       03350000
                                                                        03360000
         $ABEND ABE_VTDIAG,                                            +03370000
               SCOPE=PCB,                                              +03380000
               TITLE='$TASK FAILURE'                                    03390000
                                                                        03400000
*---------------------------------------------------------------------- 03410000
* LITERALS AND CONSTANTS                                                03420000
*---------------------------------------------------------------------- 03430000
                                                                        03440000
         LTORG ,                                                        03450000
                                                                        03460000
         PRINT NOGEN                                                    03470000
         ISTDBIND ,               VTAM BIND IMAGE                       03480000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                03490000
         IKJTCB ,                 MVS TASK CONTROL BLOCK                03500000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         03510000
         ICVT  ,                  INTEGRATOR CVT                        03520000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   03530000
         ITASK ,                  INTEGRATOR TASK BLOCK                 03540000
         IPCB ,                   INTEGRATOR PROCESS BLOCK              03550000
         IACB ,                   INTEGRATOR VTAM ACB                   03560000
         ABCODES ,                INTEGRATOR $ABEND CODES               03570000
         EVCODES ,                INTEGRATOR EVENT CODES                03580000
         ISESS ,                  INTEGRATOR SESSION BLOCK              03590000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            03600000
         IRPL ,                   INTEGRATOR VTAM RPL                   03610000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          03620000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             03630000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             03640000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             03650000
         END   ,                                                        03660000

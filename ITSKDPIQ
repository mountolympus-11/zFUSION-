ITSKDPIQ TITLE '- Initialize Dispatch Queue'                            00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* Routine: ITSKDPIQ - Initialize task/server manager DispQ              00040000
*                                                                       00050000
* Description:                                                          00060000
*                                                                       00070000
*    This routine will initialize the task/server manager               00080000
*    dispatch queue header.  If segmented dispatch queue                00090000
*    is requested,  the DISPQSEG block will be allocated                00100000
*    and initialized.  Segmented dispatch queue header are              00110000
*    identified by a negative value in the second word of               00120000
*    the queue header.  The first word is the address of the            00130000
*    DISPQSEG block.                                                    00140000
*                                                                       00150000
*                                                                       00160000
* On Entry:                                                             00170000
*                                                                       00180000
*    R1 Contains Addr of the parameter list as follows:                 00190000
*        +0  - Address of Dispatch Queue Header                         00200000
*        +4  - Seqmeneted Dispatch Queue Indicator                      00210000
*              TRUE  - Dispatch Queue is segmeneted by Priority         00220000
*              FALSE - Unsegmented Dispatch Queue                       00230000
*        +8  - Workunit for storage ownership                           00240000
*                                                                       00250000
* On Exit:                                                              00260000
*                                                                       00270000
*    R15 Contains one of the following return codes:                    00280000
*                                                                       00290000
*        RC00 - Normal Completion                                       00300000
*                                                                       00310000
**<DOC-OFF>*****************************************************        00320000
                                                                        00330000
         EJECT ,                                                        00340000
****************************************************************        00350000
*                                                                       00360000
* Maintenance:                                                          00370000
*                                                                       00380000
*   09/12/95 Ron Colmone          Par #214761                           00390000
*            Initial Version                                            00400000
*                                                                       00410000
****************************************************************        00420000
                                                                        00430000
         EJECT ,                                                        00440000
         @CB   TYPE=DSECT,WORKUNIT=YES                                  00450000
                                                                        00460000
         EJECT ,                                                        00470000
         DISPQSEG ,               SEGMENTED DISPATCHER QUEUE BLOCK      00480000
                                                                        00490000
         EJECT ,                                                        00500000
         EQUS  ,                  GENERAL EQUATES                       00510000
                                                                        00520000
         EJECT ,                                                        00530000
ITSKDPIQ #ENTER BASE=R12,PREG=R8,LINKAGE=BAKR,SAVE=NO                   00540000
                                                                        00550000
         LM    R6,R8,0(R8)        RETRIEVE PASSED PARAMETERS            00560000
         USING ITASK,R10          ADDRESSABILITY                        00570000
STG      USING @CB,R8             STORAGE OWNING WORKUNIT               00580000
                                                                        00590000
         EJECT ,                                                        00600000
****************************************************************        00610000
*                                                                       00620000
*  Determine if segmented queue header initialization is                00630000
*  requested.  If so,  allocate and initialize segmented                00640000
*  dispatch queue block.                                                00650000
*                                                                       00660000
****************************************************************        00670000
         LTR   R7,R7              SEGMENTED DISPATCH QUEUE              00680000
         BZ    STDQUEUE           NO, STANDARD QUEUE                    00690000
                                                                        00700000
         L     R2,=A(DQSLENG)     LENGTH OF SEGMENTED DISPQ             00710000
                                                                        00720000
         $GETSTOR (R2),OWNER=STG.@CB                                    00730000
         LR    R5,R1              ADDRESS OF DISPQSEG BLOCK             00740000
         USING DISPQSEG,R5        ADDRESSABILITY                        00750000
                                                                        00760000
         ST    R1,0(,R6)          SET DISPQSEG BLOCK ADDRESS            00770000
         MVC   4(4,R6),=F'-1'     INDICATE SEGMENTED DISPQ              00780000
                                                                        00790000
*---------------------------------------------------------------        00800000
*  Initialize seqmented dispatch block                                  00810000
*---------------------------------------------------------------        00820000
         LA    R3,DQSSLOTS        NUMBER OF PRIORITY SLOTS              00830000
         LA    R2,DQSPRIOQ        DISPATCH PRIOR QUEUE ORIGIN           00840000
         LH    R0,=AL2(@CBDISP-@CB)  OFFSET TO DISPQ LIST               00850000
                                                                        00860000
SEG_INIT DS    0H                                                       00870000
         LR    R1,R2              ADDRESS OF QHDR FIRST POINTER         00880000
         SR    R1,R0              SUBSTRACT OFFSET TO LIST POINTER      00890000
         ST    R1,4(,R2)          INITIALIZE QHDR ENTRY                 00900000
                                                                        00910000
         LA    R2,L'DQSPRIOQ(,R2) ADDRESS OF NEXT QUEUE HDR ENTRY       00920000
         BCT   R3,SEG_INIT        PROCESS REMAINING ENTRIES             00930000
         B     RETURN             RETURN                                00940000
                                                                        00950000
*---------------------------------------------------------------        00960000
*  Standard Queue header initialization                                 00970000
*---------------------------------------------------------------        00980000
STDQUEUE DS    0H                                                       00990000
         LA    R1,0(,R6)          ADDRESS OF QUEUE HEADER               01000000
         SH    R1,=AL2(@CBDISP-@CB) OFFSET TO DISPQ LIST                01010000
         ST    R1,4(,R6)          INITIALIZE QUEUE HEADER               01020000
                                                                        01030000
         EJECT ,                                                        01040000
****************************************************************        01050000
*                                                                       01060000
*   RETURN                                                              01070000
*                                                                       01080000
****************************************************************        01090000
                                                                        01100000
RETURN   DS    0H                                                       01110000
         LA    R15,RC00           NORMAL COMPLETION                     01120000
         #EXIT ,                  RETURN                                01130000
                                                                        01140000
         EJECT ,                                                        01150000
****************************************************************        01160000
*                                                                       01170000
*  CONSTANTS AND LITERALS                                               01180000
*                                                                       01190000
****************************************************************        01200000
                                                                        01210000
         LTORG ,                                                        01220000
                                                                        01230000
         PRINT NOGEN                                                    01240000
         ICVT  ,                                                        01250000
         ITASK ,                                                        01260000
         PRINT GEN                                                      01270000
                                                                        01280000
         END   ,                                                        01290000

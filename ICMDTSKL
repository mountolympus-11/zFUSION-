ICMDTSKL TITLE '- TASK AND PROCESS DISPLAY CMDPROC'                     00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: ICMDTSKL - Task and process display cmdproc                  00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine processes the various forms of the TASKLIST           00080000
*    command which is used to present information about the             00090000
*    ITASKs active in the system and, optionally, their                 00100000
*    associated processes.  If the command contains no operands         00110000
*    the number of active tasks and processes is displayed.             00120000
*    most forms of the command allow a particular task name to          00130000
*    be provided via the TASKNAME() operand.                            00140000
*                                                                       00150000
*                                                                       00160000
* SYNTAX:                                                               00170000
*                                                                       00180000
*    TASKLIST íNAMES | PROCS | ALLù íACTiveù íTASK(<name>)ù             00190000
*             íADDRSù                        íMASKTASK(<pattern>)ù      00200000
*                                                                       00210000
*                                                                       00220000
*    If one of TASK() or MASKTASK() is provided, but no display         00230000
*    type is given, ALL is assumed by default.                          00240000
*                                                                       00250000
*                                                                       00260000
* ON ENTRY:                                                             00270000
*                                                                       00280000
*    R1  addr of command request block (CMDREQ) in local                00290000
*        cmdproc format                                                 00300000
*                                                                       00310000
**<DOC-OFF>****************************************************         00320000
                                                                        00330000
         EJECT                                                          00340000
***************************************************************         00350000
*                                                                       00360000
* MAINTENANCE:                                                          00370000
*                                                                       00380000
*    05/19/93 R. Turgeon                                                00390000
*             Initial version                                           00400000
*                                                                       00410000
*    07/12/94 R. Turgeon                                                00420000
*             Added support for ACTIVE operand                          00430000
*                                                                       00440000
***************************************************************         00450000
                                                                        00460000
         EJECT                                                          00470000
         #WORK ,             BEGIN WORKAREA                             00480000
                                                                        00490000
MAJID    DS    X             MAJOR KEYWORD ID (MUTEXC)                  00500000
MINID    DS    X             MINOR KEYWORD ID (MUTEXC)                  00510000
ACTID    DS    X             ACTIVE WORKUNITS QUALIFIER                 00520000
MATCHFLG DS    X             TASK FOUND                                 00530000
ADDRS    DS    X             TRUE IF ADDRS OPERAND                      00540000
                                                                        00550000
EYEHEX   DS    CL9           HEX CONVERSION AREA                        00560000
                                                                        00570000
TASKNAME DS    CL8           TASK() OR MASKTASK() DESIGNATION           00580000
TASKZERO DS    F             TASKNAME AS NTS FOR PATMATCH ROUTINE       00590000
                                                                        00600000
*--------------------------------------------------------------         00610000
*   TL NAMES report line                                                00620000
*--------------------------------------------------------------         00630000
                                                                        00640000
@TNMCURR DS    A             ADDR NEXT TASK NAME SLOT                   00650000
                                                                        00660000
MODELTNM DS    C'*TASKNAME:00'                                          00670000
                                                                        00680000
@TNMLIST DS    0C            TASK NAME DISPLAY LINE N-ACROSS            00690000
@TNMS1   DS    CL(L'MODELTNM)                                           00700000
@TNMS2   DS    CL(L'MODELTNM)                                           00710000
@TNMS3   DS    CL(L'MODELTNM)                                           00720000
@TNMS4   DS    CL(L'MODELTNM)                                           00730000
@TNMS5   DS    CL(L'MODELTNM)                                           00740000
@TNMLEND EQU   *             END OF COLLECTOR ARRAY                     00750000
@TNMLN   EQU   *-@TNMLIST    LENGTH OF COLLECTOR ARRAY                  00760000
                                                                        00770000
#TADCURR DS    A             ADDR NEXT TASK ADDR SLOT                   00780000
                                                                        00790000
#TADLIST DS    0C            TASK ADDR DISPLAY LINE N-ACROSS            00800000
#TADS1   DS    CL(L'MODELTNM)                                           00810000
#TADS2   DS    CL(L'MODELTNM)                                           00820000
#TADS3   DS    CL(L'MODELTNM)                                           00830000
#TADS4   DS    CL(L'MODELTNM)                                           00840000
#TADS5   DS    CL(L'MODELTNM)                                           00850000
                                                                        00860000
*--------------------------------------------------------------         00870000
*   TL PROCS report line                                                00880000
*--------------------------------------------------------------         00890000
                                                                        00900000
@TPRCURR DS    A             ADDR NEXT TASK NAME SLOT                   00910000
                                                                        00920000
@TPRTASK DS    CL(L'MODELTNM+2)   *TASKNAME:00 -                        00930000
@TPRLIST DS    0C            TASK DISPLAY LINE N-ACROSS                 00940000
@TPRS1   DS    CL9           PROCNAME PLUS BUSY DESIGNATION             00950000
@TPRS2   DS    CL9                                                      00960000
@TPRS3   DS    CL9                                                      00970000
@TPRS4   DS    CL9                                                      00980000
@TPRS5   DS    CL9                                                      00990000
@TPRLEND EQU   *             END OF COLLECTOR ARRAY                     01000000
@TPRLN   EQU   *-@TPRLIST    LENGTH OF COLLECTOR ARRAY                  01010000
                                                                        01020000
#TPACURR DS    A             ADDR NEXT TASK NAME SLOT                   01030000
                                                                        01040000
#TPATASK DS    CL(L'MODELTNM+2)   *TASKNAME:00 -                        01050000
#TPALIST DS    0C            PROC DISPLAY LINE N-ACROSS                 01060000
#TPAS1   DS    CL9           PROCADDR PLUS BUSY DESIGNATION             01070000
#TPAS2   DS    CL9                                                      01080000
#TPAS3   DS    CL9                                                      01090000
#TPAS4   DS    CL9                                                      01100000
#TPAS5   DS    CL9                                                      01110000
                                                                        01120000
*--------------------------------------------------------------         01130000
*   misc workareas                                                      01140000
*--------------------------------------------------------------         01150000
                                                                        01160000
REGSAVE  DS    16F           LOCAL ROUTINE SAVEAREA                     01170000
WK256    DS    XL256         LARGE PLIST CONSTRUCTION, ETC.             01180000
         #ENDWORK ,          END WORKAREA                               01190000
                                                                        01200000
         EJECT                                                          01210000
         CMDREQ  ,           COMMAND REQUEST BLOCK                      01220000
                                                                        01230000
         EJECT                                                          01240000
         CCSUMRY ,           COMMAND OPERAND PREPARSE SUMMARY           01250000
                                                                        01260000
         EJECT                                                          01270000
         SERVERX ,           SERVER ITASK EXTENSION                     01280000
                                                                        01290000
         EJECT                                                          01300000
         ITASK ,                                                        01310000
                                                                        01320000
         EJECT                                                          01330000
         KEYCODES COMMANDSET=TASKLIST                                   01340000
                                                                        01350000
         CMDCODES ,                                                     01360000
                                                                        01370000
         EQUS  ,                                                        01380000
                                                                        01390000
         $MSGDFT PREFIX=ICTPID,COMPID='CMD',TABLE=*#MSGS,              X01400000
               CONID=*CMRQCNID,CONNAME=CMRQCNAM,CART=CMRQCART,         X01410000
               DESTADD=*CMRQDMSK,                                      X01420000
               MSGQA=*CMRQMQA,STGQH=*CMRQSTGQ,                         X01430000
               MF=(E,WK256),                                           X01440000
               PRINT=NOGEN                                              01450000
         EJECT                                                          01460000
                                                                        01470000
                                                                        01480000
         EJECT ,                                                        01490000
ICMDTSKL #ENTER PREG=R8                                                 01500000
                                                                        01510000
         USING ICVT,R11                                                 01520000
         USING ITASK,R10                                                01530000
                                                                        01540000
*--------------------------------------------------------------         01550000
*    locate command request block, command summary, and ops             01560000
*--------------------------------------------------------------         01570000
                                                                        01580000
         USING CMDREQ,R8          COMMAND REQUEST BLOCK                 01590000
         ICM   R7,15,CMRQSMRY     ASSOC COMMAND SUMMARY                 01600000
         BZ    COUNTS             AMBIGUOUS REQUEST                     01610000
         USING CCSUMRY,R7         COMMAND OPERAND SUMMARY FORMAT        01620000
         ICM   R5,15,CMRQSMR#     TOTAL NUMBER OF OPERAND ENTRIES       01630000
         BZ    COUNTS             AMBIGUOUS REQUEST IF ZERO             01640000
         L     R6,CMRQOPST        OPERAND STRING ORIGIN                 01650000
                                                                        01660000
*--------------------------------------------------------------         01670000
*   identify the operands provided and validate                         01680000
*--------------------------------------------------------------         01690000
                                                                        01700000
PARSENXT DS    0H                                                       01710000
         SR    R2,R2              NO PROCESSING ROUTINE                 01720000
         LA    R1,TL_ALL          ALL TASKS                             01730000
         CH    R1,CCSID           CURRENT KEYWORD?                      01740000
         BE    MAJKEY             BREAK IF SO                           01750000
                                                                        01760000
         SR    R2,R2              NO PROCESSING ROUTINE                 01770000
         LA    R1,TL_NAMES        TASK NAMES                            01780000
         CH    R1,CCSID           CURRENT KEYWORD?                      01790000
         BE    MAJKEY             BREAK IF SO                           01800000
                                                                        01810000
         SR    R2,R2              NO PROCESSING ROUTINE                 01820000
         LA    R1,TL_PROCS        PROCESS LIST OPTION                   01830000
         CH    R1,CCSID           CURRENT KEYWORD?                      01840000
         BE    MAJKEY             BREAK IF SO                           01850000
                                                                        01860000
         LA    R1,TL_ACTIVE       ACTIVE WORKUNITS OPTION               01870000
         CH    R1,CCSID           CURRENT KEYWORD?                      01880000
         BE    ACTKEY             BREAK IF SO                           01890000
                                                                        01900000
         LA    R1,TL_ADDRS        WORKUNIT ADDRS OPTION?                01910000
         CH    R1,CCSID           CURRENT KEYWORD?                      01920000
         BE    ADDRKEY            BREAK IF SO                           01930000
                                                                        01940000
         LA    R2,PTSKNM          EXTRACT TASK NAME                     01950000
         LA    R1,TL_TASK         SPECIFIC TASK                         01960000
         CH    R1,CCSID           CURRENT KEYWORD?                      01970000
         BE    MINKEY             BREAK IF SO                           01980000
         LA    R1,TL_MTASK        TASK PATTERN                          01990000
         CH    R1,CCSID           CURRENT KEYWORD?                      02000000
         BE    MINKEY             BREAK IF SO                           02010000
         B     ERREJECT           REJECT OTHERWISE                      02020000
                                                                        02030000
*--------------------------------------------------------------         02040000
*   post sentinels and values for major and minor keys found            02050000
*--------------------------------------------------------------         02060000
                                                                        02070000
MAJKEY   DS    0H                                                       02080000
         CLI   MAJID,0            ONLY KEYWORD OF MAJOR GROUP?          02090000
         BNE   ERRCNFLC           CONFLICTING OPERANDS OTHERWISE        02100000
         STC   R1,MAJID           POST REQUEST TYPE                     02110000
         LTR   R2,R2              RESUMPTION POINT PROVIDED?            02120000
         BNZR  R2                 ONWARD IF SO                          02130000
         B     ADVANCE            ADVANCE TO NEXT OPERAND               02140000
                                                                        02150000
MINKEY   DS    0H                                                       02160000
         CLI   MINID,0            ONLY KEYWORD OF MINOR GROUP?          02170000
         BNE   ERRCNFLC           CONFLICTING OPERANDS OTHERWISE        02180000
         STC   R1,MINID           POST REQUEST TYPE                     02190000
         LTR   R2,R2              RESUMPTION POINT PROVIDED?            02200000
         BNZR  R2                 ONWARD IF SO                          02210000
         B     ADVANCE            ADVANCE TO NEXT OPERAND               02220000
                                                                        02230000
ACTKEY   DS    0H                                                       02240000
         MVI   ACTID,TRUE         ACTIVE ENTRIES ONLY                   02250000
         B     ADVANCE            ADVANCE TO NEXT OPERAND               02260000
                                                                        02270000
ADDRKEY  DS    0H                                                       02280000
         MVI   ADDRS,TRUE         WORKUNIT ADDRESSES REQUIRED           02290000
         B     ADVANCE            ADVANCE TO NEXT OPERAND               02300000
                                                                        02310000
*------- TASK(<name>) or TASK(<pattern>) ----------------------         02320000
                                                                        02330000
PTSKNM   DS    0H                 TASK(<TASKNAME>)                      02340000
         CLC   CCSVALCT,=H'1'     SINGLE VALUE?                         02350000
         BNE   ERRSYNTX           SYNTAX PROBLEM OTHERWISE              02360000
         LH    R2,CCSVLEN         FETCH VALUE LENGTH                    02370000
         LTR   R2,R2              LENGTH OF STRING                      02380000
         BNP   ERRSYNTX           SYNTAX ERROR                          02390000
         CH    R2,=AL2(L'TASKNAME)   CORRECT LENGTH?                    02400000
         BH    ERRSYNTX           ERROR IF NOT                          02410000
                                                                        02420000
         MVC   TASKNAME,BLANKS    BLANK PAD                             02430000
         L     R3,CCSVDISP        OFFSET TO TASKNAME IN CMD LINE        02440000
         AR    R3,R6              CONVERT OFFSET TO ADDRESS             02450000
         BCTR  R2,0               PREPARE FOR EX                        02460000
         EX    R2,*+4             LOCAL COPY OF TASKNAME                02470000
         MVC   TASKNAME(*-*),0(R3)                                      02480000
                                                                        02490000
*--------------------------------------------------------------         02500000
*   process all keywords, validate request completeness                 02510000
*--------------------------------------------------------------         02520000
                                                                        02530000
ADVANCE  DS    0H                                                       02540000
         LA    R15,CCSVSLN        LENGTH OF EACH VALUE ENTRY            02550000
         MH    R15,CCSVALCT       TOTAL SIZE CONSUMED BY VALUES         02560000
         LA    R7,CCSUMRY+CCSPFXL(R15)                                  02570000
         BCT   R5,PARSENXT        EXAMINE ALL OPERANDS                  02580000
                                                                        02590000
         CLI   MAJID,0            MAJOR OPERAND PROVIDED?               02600000
         BNE   *+8                READY TO ROLL IF SO                   02610000
         MVI   MAJID,TL_PROCS     ASSUME LIST OF ASSOCIATED PROCS       02620000
                                                                        02630000
         CLI   MAJID,TL_NAMES     TASK NAMES?                           02640000
         BE    NAMES              DISPLAY ACCORDINGLY                   02650000
         CLI   MAJID,TL_PROCS     PROCESS AND TASK NAMES?               02660000
         BE    PROCS              DISPLAY ACCORDINGLY                   02670000
         CLI   MAJID,TL_ALL       PROCESS ALL WORKUNITS?                02680000
         BE    PROCS              DISPLAY ACCORDINGLY                   02690000
         B     PROCS              UNRECOGNIZED REQ, FOR NOW             02700000
         DROP  R7                 CCSUMRY                               02710000
                                                                        02720000
         EJECT                                                          02730000
***************************************************************         02740000
*                                                                       02750000
*   TL NAMES condensed ITASK name list display                          02760000
*                                                                       02770000
***************************************************************         02780000
                                                                        02790000
NAMES    DS    0H                                                       02800000
         $MSG  202                                                      02810000
                                                                        02820000
         $SER  OBTAIN,DISP        ACQUIRE TASK / PROCESS LOCK           02830000
                                                                        02840000
*--------------------------------------------------------------         02850000
*   scan ITASKS for matching entry                                      02860000
*--------------------------------------------------------------         02870000
                                                                        02880000
         BAS   R14,TNMINIT        INITIALIZE TASK NAME COLLECTION LINE  02890000
                                                                        02900000
         L     R5,ICTTASKQ        BEGINNING OF ITASK LIST               02910000
I        USING ITASK,R5           ITASK ADDRESSABILITY                  02920000
                                                                        02930000
NAMENEXT DS    0H                                                       02940000
         LA    R1,I.ITASK         R1 <== CANDIDATE ITASK                02950000
         BAS   R14,TASKTEST       APPLY TASK FILTERS IF ANY             02960000
         BNZ   NAMEADV            SKIP IF NO MATCH                      02970000
                                                                        02980000
         CLI   ACTID,0            ACTIVE WORKUNITS ONLY?                02990000
         BE    NAMEGO             ALL WORKUNITS OTHERWISE               03000000
         LA    R1,I.ITASK         R1 <== CANDIDATE ITASK                03010000
         BAS   R14,TESTACT        WORK RUNNING UNDER ITASK?             03020000
         BNZ   NAMEADV            SKIP IF NOT                           03030000
                                                                        03040000
NAMEGO   DS    0H                                                       03050000
         MVI   MATCHFLG,4         MATCHING TASK IDENTIFIED              03060000
         LA    R1,I.ITASK         R1 <== SELECT ITASK                   03070000
         BAS   R14,TNMISRT        INSERT ENTRY                          03080000
                                                                        03090000
*--------------------------------------------------------------         03100000
*   advance to next ITASK                                               03110000
*--------------------------------------------------------------         03120000
                                                                        03130000
NAMEADV  DS    0H                                                       03140000
         ICM   R5,15,I.TSKNEXT    ELSE ADVANCE TO NEXT ITASK            03150000
         BNZ   NAMENEXT           AND TRY AGAIN                         03160000
         BAS   R14,TNMPRNT        ENSURE LAST LINE IS WRITTEN           03170000
         DROP  I                  ITASK                                 03180000
                                                                        03190000
         $SER  RELEASE,DISP       RELEASE TASKS / PROCESS LOCK          03200000
         B     RESULT             COMPLETE                              03210000
                                                                        03220000
         EJECT ,                                                        03230000
***************************************************************         03240000
*                                                                       03250000
*   TL PROCS condensed ITASK and PROCess name list display              03260000
*                                                                       03270000
***************************************************************         03280000
PROCS    DS    0H                                                       03290000
         $MSG  204                                                      03300000
                                                                        03310000
         $SER  OBTAIN,DISP        ACQUIRE TASKS / PROCESS LOCK          03320000
                                                                        03330000
*--------------------------------------------------------------         03340000
*   scan ITASKs for matching entry                                      03350000
*--------------------------------------------------------------         03360000
                                                                        03370000
         L     R5,ICTTASKQ        BEGINNING OF ITASK LIST               03380000
I        USING ITASK,R5           ITASK ADDRESSABILITY                  03390000
                                                                        03400000
PRTSKNXT DS    0H                                                       03410000
         LA    R1,I.ITASK         R1 <== CANDIDATE ITASK                03420000
         BAS   R14,TASKTEST       APPLY TASK FILTERS IF ANY             03430000
         BNZ   PRTSKADV           PROCESS IT IF SO                      03440000
                                                                        03450000
PRTSKSEL DS    0H                 SELECTED ITASK ENCOUNTERED            03460000
         CLI   ACTID,0            ACTIVE WORKUNITS ONLY?                03470000
         BE    PRTSKGO            ALL WORKUNITS OTHERWISE               03480000
         LA    R1,I.ITASK         R1 <== CANDIDATE ITASK                03490000
         BAS   R14,TESTACT        WORK RUNNING UNDER ITASK?             03500000
         BNZ   PRTSKADV           SKIP IF NOT                           03510000
                                                                        03520000
PRTSKGO  DS    0H                                                       03530000
         MVI   MATCHFLG,4         MATCHING TASK IDENTIFIED              03540000
         LA    R1,I.ITASK         R1 <== SELECT ITASK                   03550000
         BAS   R14,TPRINIT        INITIALIZE TASK NAME COLLECTION LINE  03560000
         BAS   R14,TPRTISRT       INSERT TASK ENTRY                     03570000
                                                                        03580000
*--------------------------------------------------------------         03590000
*   scan all (active) processes of selected ITASK                       03600000
*--------------------------------------------------------------         03610000
                                                                        03620000
         ICM   R6,15,I.TSKPCB     PCB QUEUE                             03630000
         BZ    PRTSKFIN           DONE                                  03640000
         USING IPCB,R6            PROCESS                               03650000
                                                                        03660000
PRTSKLST DS    0H                 NEXT PROCESS                          03670000
         CLI   ACTID,0            ACTIVE WORKUNITS ONLY?                03680000
         BE    PRTSKPGO           ALL WORKUNITS OTHERWISE               03690000
         C     R6,I.TSKPCBC       IS THIS THE ACTIVE PROCESS?           03700000
         BNE   PRTSKPCB           SKIP IF NOT                           03710000
                                                                        03720000
PRTSKPGO DS    0H                                                       03730000
         LA    R0,I.ITASK         R0 <== ITASK                          03740000
         LA    R1,IPCB            R1 <== PROCESS PCB                    03750000
         BAS   R14,TPRPISRT       INSERT TASK ENTRY                     03760000
                                                                        03770000
PRTSKPCB DS    0H                                                       03780000
         ICM   R6,15,PCBNEXT      ADVANCE TO NEXT PROCESS               03790000
         BNZ   PRTSKLST           AND FORMAT                            03800000
                                                                        03810000
PRTSKFIN DS    0H                                                       03820000
         BAS   R14,TPRPRNT        ENSURE LAST LINE IS WRITTEN           03830000
         DROP  R6                 IPCB                                  03840000
                                                                        03850000
*--------------------------------------------------------------         03860000
*   advance to next ITASK                                               03870000
*--------------------------------------------------------------         03880000
                                                                        03890000
PRTSKADV DS    0H                                                       03900000
         ICM   R5,15,I.TSKNEXT    ELSE ADVANCE TO NEXT ITASK            03910000
         BNZ   PRTSKNXT           AND TRY AGAIN                         03920000
         DROP  I                  ITASK                                 03930000
                                                                        03940000
         $SER  RELEASE,DISP       RELEASE TASKS / PROCESS LOCK          03950000
         B     RESULT             COMPLETE                              03960000
                                                                        03970000
         EJECT                                                          03980000
***************************************************************         03990000
*                                                                       04000000
*   determine whether command search args were satisfied                04010000
*                                                                       04020000
***************************************************************         04030000
                                                                        04040000
RESULT   DS    0H                                                       04050000
         CLI   MATCHFLG,0         MATCHING ITASK FOUND?                 04060000
         BNE   NORMRET            SEARCH SATISFIED IF SO                04070000
                                                                        04080000
         $MSG  210,FIELDS=(TASKNAME)   SEARCH FAILED                    04090000
         B     NORMRET            DONE                                  04100000
                                                                        04110000
         EJECT                                                          04120000
***************************************************************         04130000
*                                                                       04140000
*   summary display of active task and process counts                   04150000
*                                                                       04160000
***************************************************************         04170000
                                                                        04180000
COUNTS   DS    0H                                                       04190000
         $MSG  201,FIELDS=(ICT#PROC,ICT#TASK)                           04200000
                                                                        04210000
         EJECT ,                                                        04220000
***************************************************************         04230000
*                                                                       04240000
*   return completion status to requestor                               04250000
*                                                                       04260000
***************************************************************         04270000
                                                                        04280000
NORMRET  DS    0H                                                       04290000
         LA    R15,CCODE_NORESP   NO ADDITIONAL RESPONSE REQUIRED       04300000
         B     CMDRET                                                   04310000
                                                                        04320000
ERRSYNTX DS    0H                                                       04330000
         LA    R15,CCODE_SYNTAX   SYNTAX ERROR                          04340000
         B     CMDRET             DONE                                  04350000
                                                                        04360000
ERRAMBIG DS    0H                                                       04370000
         LA    R15,CCODE_AMBIG    AMBIGUOUS REQUEST                     04380000
         B     CMDRET             DONE                                  04390000
                                                                        04400000
ERRCNFLC DS    0H                                                       04410000
         LA    R15,CCODE_CONFLICT CONFLICTING OPERANDS                  04420000
         B     CMDRET             DONE                                  04430000
                                                                        04440000
ERREJECT DS    0H                                                       04450000
         LA    R15,CCODE_REJECT   COMMAND REJECTED                      04460000
         B     CMDRET             DONE                                  04470000
                                                                        04480000
CMDRET   DS    0H                                                       04490000
         ST    R15,CMRQCOMP       POST COMPLETION CODE PER CONVENTION   04500000
         #EXIT ,                                                        04510000
                                                                        04520000
         EJECT                                                          04530000
** TL NAMES ***************************************************         04540000
*                                                                       04550000
* ROUTINE: TNMISRT - add ITASK info to collection array                 04560000
*                                                                       04570000
***************************************************************         04580000
                                                                        04590000
TNMISRT  DS    0H                                                       04600000
         STM   R0,R15,REGSAVE                                           04610000
         LR    R5,R1              ITASK                                 04620000
I        USING ITASK,R5                                                 04630000
                                                                        04640000
TNMISRT1 DS    0H                                                       04650000
         L     R2,@TNMCURR        SLOT PTR                              04660000
         LA    R0,@TNMLEND        END OF COLLECTOR ARRAY                04670000
         CR    R2,R0              INFRINGEMENT?                         04680000
         BL    TNMISRT2           ACCEPT NEW ENTRY                      04690000
                                                                        04700000
         BAS   R14,TNMPRNT        DISPOSE OF CURRENT ENTRY              04710000
         BAS   R14,TNMINIT        PREPARE FOR NEW PASS                  04720000
         B     TNMISRT1           TRY AGAIN                             04730000
                                                                        04740000
*--------------------------------------------------------------         04750000
*   insert ITASK name                                                   04760000
*--------------------------------------------------------------         04770000
                                                                        04780000
TNMISRT2 DS    0H                                                       04790000
         MVC   1(L'TSKNAME,R2),I.TSKNAME                                04800000
                                                                        04810000
         LA    R1,I.ITASK         R1 <== CANDIDATE ITASK                04820000
         BAS   R14,TESTACT        WORK RUNNING UNDER ITASK?             04830000
         BNZ   *+8                SKIP IF NOT                           04840000
         MVI   0(R2),C'*'         INDICATE RUNNING TASK                 04850000
                                                                        04860000
         ICM   R3,15,I.TSKSVTSK   ITASK RUNNING UNDER A SERVER?         04870000
         BZ    TNMISRT3           SKIP IF NOT                           04880000
         MVI   L'TSKNAME+1(R2),C':'                                     04890000
         MVC   L'TSKNAME+1+1(2,R2),TSKNAME-ITASK+6(R3)                  04900000
                                                                        04910000
*--------------------------------------------------------------         04920000
*   insert ITASK address if requested                                   04930000
*--------------------------------------------------------------         04940000
                                                                        04950000
TNMISRT3 DS    0H                 WORKUNIT ADDRESSES                    04960000
         CLI   ADDRS,FALSE        REQUESTED?                            04970000
         BE    TNMISRT4           SKIP IF NOT                           04980000
                                                                        04990000
         L     R4,#TADCURR        ADDRESS SLOT PTR                      05000000
         MVC   0(1,R4),0(R2)      PARROT ACTIVE WORKUNIT INDICATOR      05010000
         LR    R0,R5              ITASK ADDRESS                         05020000
         BAS   R14,CVTHEX         CONVERT TO EYEBALL HEX                05030000
         MVC   1(8,R4),0(R1)      ADD TO MESSAGE LINE                   05040000
                                                                        05050000
         LA    R4,L'#TADS1(,R4)   IDENTIFY ADDR SLOT FOR NEXT PASS      05060000
         ST    R4,#TADCURR        POST                                  05070000
                                                                        05080000
*--------------------------------------------------------------         05090000
*   update current position, function complete                          05100000
*--------------------------------------------------------------         05110000
                                                                        05120000
TNMISRT4 DS    0H                                                       05130000
         LA    R2,L'@TNMS1(,R2)   IDENTIFY SLOT FOR NEXT PASS           05140000
         ST    R2,@TNMCURR        POST                                  05150000
                                                                        05160000
         LM    R0,R14,REGSAVE     RESTORE REGS                          05170000
         BR    R14                RETURN                                05180000
         DROP  I                  ITASK                                 05190000
                                                                        05200000
** TL NAMES ***************************************************         05210000
*                                                                       05220000
* ROUTINE: TNMPRNT - print NAMES display line                           05230000
*                                                                       05240000
***************************************************************         05250000
                                                                        05260000
TNMPRNT  DS    0H                                                       05270000
         ST    R14,FWORD          PRESERVE RETURN ADDRESS               05280000
                                                                        05290000
         L     R1,@TNMCURR        NEXT AVAILABLE SLOT                   05300000
         LA    R0,@TNMLIST        END OF COLLECTOR ARRAY                05310000
         CR    R1,R0              ANY ENTRIES PRESENT?                  05320000
         BNHR  R14                DONE IF NOT                           05330000
                                                                        05340000
         $MSG  203,FIELDS=(@TNMS1,@TNMS2,@TNMS3,@TNMS4,@TNMS5)          05350000
                                                                        05360000
         CLI   ADDRS,FALSE        CONTROL BLOCK ADDRESSES REQUESTED?    05370000
         BE    TNMPRNX                                                  05380000
                                                                        05390000
         $MSG  213,FIELDS=(#TADS1,#TADS2,#TADS3,#TADS4,#TADS5)          05400000
                                                                        05410000
TNMPRNX  DS    0H                                                       05420000
         L     R14,FWORD          PRESERVE RETURN ADDRESS               05430000
         BR    R14                                                      05440000
                                                                        05450000
** TL NAMES ***************************************************         05460000
*                                                                       05470000
* ROUTINE: TNMINIT - initialize ITASK collection array                  05480000
*                                                                       05490000
***************************************************************         05500000
                                                                        05510000
TNMINIT  DS    0H                                                       05520000
         LA    R0,@TNMLIST   NAME LIST ORIGIN                           05530000
         ST    R0,@TNMCURR                                              05540000
         LA    R0,#TADLIST   ADDR LIST ORIGIN                           05550000
         ST    R0,#TADCURR                                              05560000
                                                                        05570000
         MVI   @TNMLIST,C' ' CLEAR NAME COLLECTION AREA                 05580000
         MVC   @TNMLIST+1(@TNMLN-1),@TNMLIST                            05590000
                                                                        05600000
         MVI   #TADLIST,C' ' CLEAR ADDR COLLECTION AREA                 05610000
         MVC   #TADLIST+1(@TNMLN-1),#TADLIST                            05620000
                                                                        05630000
         BR    R14                                                      05640000
                                                                        05650000
         EJECT                                                          05660000
** TL PROCS ***************************************************         05670000
*                                                                       05680000
* ROUTINE: TPRTISRT - add ITASK info to display line                    05690000
*                                                                       05700000
***************************************************************         05710000
                                                                        05720000
TPRTISRT DS    0H                                                       05730000
         STM   R0,R15,REGSAVE                                           05740000
         LR    R5,R1              ITASK                                 05750000
I        USING ITASK,R5           ADDRESSABILITY                        05760000
                                                                        05770000
*--------------------------------------------------------------         05780000
*   insert itask name                                                   05790000
*--------------------------------------------------------------         05800000
                                                                        05810000
         MVC   @TPRTASK,BLANKS    CLEAR TASK DESCRIPTOR                 05820000
         MVC   @TPRTASK+1(8),I.TSKNAME                                  05830000
         MVI   @TPRTASK+L'@TPRTASK-1,C'-'   SEPARATOR                   05840000
                                                                        05850000
         LA    R1,I.ITASK         R1 <== CANDIDATE ITASK                05860000
         BAS   R14,TESTACT        WORK RUNNING UNDER ITASK?             05870000
         BNZ   *+8                SKIP IF NOT                           05880000
         MVI   @TPRTASK,C'*'      INDICATE RUNNING TASK                 05890000
                                                                        05900000
         ICM   R3,15,I.TSKSVTSK   ITASK RUNNING UNDER A SERVER?         05910000
         BZ    TPRTITNM           SKIP IF NOT                           05920000
         MVI   @TPRTASK+L'TSKNAME+1,C':'                                05930000
         MVC   @TPRTASK+L'TSKNAME+1+1(2),TSKNAME-ITASK+6(R3)            05940000
                                                                        05950000
TPRTITNM DS    0H                                                       05960000
                                                                        05970000
*--------------------------------------------------------------         05980000
*   insert ITASK address if requested                                   05990000
*--------------------------------------------------------------         06000000
                                                                        06010000
         CLI   ADDRS,FALSE        REQUESTED?                            06020000
         BE    TPRTITAD           SKIP IF NOT                           06030000
                                                                        06040000
         MVC   #TPATASK(1),@TPRTASK   PARROT ACTIVE WORKUNIT INDICATOR  06050000
         LR    R0,R5                  ITASK ADDRESS                     06060000
         BAS   R14,CVTHEX             CONVERT TO EYEBALL HEX            06070000
         MVC   #TPATASK+1(8),0(R1)    ADD TO MESSAGE LINE               06080000
                                                                        06090000
TPRTITAD DS    0H                                                       06100000
                                                                        06110000
*--------------------------------------------------------------         06120000
*   function complete                                                   06130000
*--------------------------------------------------------------         06140000
                                                                        06150000
         LM    R0,R14,REGSAVE     RESTORE REGS                          06160000
         BR    R14                RETURN                                06170000
         DROP  I                  ITASK                                 06180000
                                                                        06190000
** TL PROCS ***************************************************         06200000
*                                                                       06210000
* ROUTINE: TPRPISRT - add process info to display line                  06220000
*                                                                       06230000
***************************************************************         06240000
                                                                        06250000
TPRPISRT DS    0H                                                       06260000
         STM   R0,R15,REGSAVE                                           06270000
         LR    R5,R0              ITASK                                 06280000
I        USING ITASK,R5                                                 06290000
         LR    R6,R1              IPCB                                  06300000
P        USING IPCB,R6                                                  06310000
                                                                        06320000
TPRPINS1 DS    0H                                                       06330000
         L     R2,@TPRCURR        PCB SLOT PTR                          06340000
         LA    R0,@TPRLEND        END OF COLLECTOR ARRAY                06350000
         CR    R2,R0              INFRINGEMENT?                         06360000
         BL    TPRPINS2           ACCEPT NEW ENTRY                      06370000
                                                                        06380000
         BAS   R14,TPRPRNT        DISPOSE OF CURRENT ENTRY              06390000
         BAS   R14,TPRINIT        PREPARE FOR NEW PASS                  06400000
                                                                        06410000
         MVC   @TPRTASK,BLANKS    GROUP INDICATE FOR TASK NAME          06420000
         MVC   #TPATASK,BLANKS    CLEAR TASK ADDRESS AS WELL            06430000
         B     TPRPINS1           TRY AGAIN                             06440000
                                                                        06450000
*--------------------------------------------------------------         06460000
*   insert PROC name                                                    06470000
*--------------------------------------------------------------         06480000
                                                                        06490000
TPRPINS2 DS    0H                                                       06500000
         MVC   1(L'PCBNAME,R2),P.PCBNAME                                06510000
                                                                        06520000
         C     R6,I.TSKPCBC       CURRENTLY RUNNING THIS PROCESS?       06530000
         BNE   *+8                SKIP IF NOT                           06540000
         MVI   0(R2),C'*'         INDICATE RUNNING PROCESS              06550000
                                                                        06560000
*--------------------------------------------------------------         06570000
*   insert PROC address if requested                                    06580000
*--------------------------------------------------------------         06590000
                                                                        06600000
         CLI   ADDRS,FALSE        REQUESTED?                            06610000
         BE    TPRPISAD           SKIP IF NOT                           06620000
                                                                        06630000
         L     R4,#TPACURR        CURRENT PROC ADDRESS SLOT             06640000
         MVC   0(1,R4),0(R2)      PARROT ACTIVE WORKUNIT INDICATOR      06650000
         LR    R0,R6              PROC ADDRESS                          06660000
         BAS   R14,CVTHEX         CONVERT TO EYEBALL HEX                06670000
         MVC   1(8,R4),0(R1)      ADD TO MESSAGE LINE                   06680000
                                                                        06690000
         LA    R4,L'#TPAS1(,R4)   IDENTIFY ADDR SLOT FOR NEXT PASS      06700000
         ST    R4,#TPACURR        POST                                  06710000
                                                                        06720000
TPRPISAD DS    0H                                                       06730000
                                                                        06740000
*--------------------------------------------------------------         06750000
*   update current position, function complete                          06760000
*--------------------------------------------------------------         06770000
                                                                        06780000
         LA    R2,L'@TPRS1(,R2)   IDENTIFY SLOT FOR NEXT PASS           06790000
         ST    R2,@TPRCURR        POST                                  06800000
                                                                        06810000
         LM    R0,R14,REGSAVE     RESTORE REGS                          06820000
         BR    R14                RETURN                                06830000
         DROP  I,P                ITASK, IPCB                           06840000
                                                                        06850000
** TL PROCS ***************************************************         06860000
*                                                                       06870000
* ROUTINE: TPRPRNT - print PROCS display line                           06880000
*                                                                       06890000
***************************************************************         06900000
                                                                        06910000
TPRPRNT  DS    0H                                                       06920000
         ST    R14,FWORD          PRESERVE RETURN ADDRESS               06930000
                                                                        06940000
         L     R1,@TPRCURR        NEXT AVAILABLE SLOT                   06950000
         LA    R0,@TPRLIST        END OF COLLECTOR ARRAY                06960000
         CR    R1,R0              ANY ENTRIES PRESENT?                  06970000
         BNHR  R14                DONE IF NOT                           06980000
                                                                        06990000
         $MSG  205,FIELDS=(@TPRTASK,@TPRS1,@TPRS2,@TPRS3,@TPRS4,@TPRS5) 07000000
                                                                        07010000
         CLI   ADDRS,FALSE        CONTROL BLOCK ADDRESSES REQUESTED?    07020000
         BE    TPRPRNX                                                  07030000
                                                                        07040000
         $MSG  215,FIELDS=(#TPATASK,#TPAS1,#TPAS2,#TPAS3,#TPAS4,#TPAS5) 07050000
                                                                        07060000
TPRPRNX  DS    0H                                                       07070000
         L     R14,FWORD          PRESERVE RETURN ADDRESS               07080000
         BR    R14                                                      07090000
                                                                        07100000
** TL PROCS ***************************************************         07110000
*                                                                       07120000
* ROUTINE: TNMINIT - initialize ITASK/PROC collection array             07130000
*                                                                       07140000
***************************************************************         07150000
                                                                        07160000
TPRINIT  DS    0H                                                       07170000
         LA    R0,@TPRLIST   PROC NAME LIST ORIGIN                      07180000
         ST    R0,@TPRCURR                                              07190000
         LA    R0,#TPALIST   PROC ADDR LIST ORIGIN                      07200000
         ST    R0,#TPACURR                                              07210000
                                                                        07220000
         MVI   @TPRLIST,C' ' CLEAR NAME COLLECTION AREA                 07230000
         MVC   @TPRLIST+1(@TPRLN-1),@TPRLIST                            07240000
                                                                        07250000
         MVI   #TPALIST,C' ' CLEAR ADDR COLLECTION AREA                 07260000
         MVC   #TPALIST+1(@TPRLN-1),#TPALIST                            07270000
                                                                        07280000
         BR    R14                                                      07290000
                                                                        07300000
         EJECT                                                          07310000
***************************************************************         07320000
*                                                                       07330000
* ROUTINE: TASKTEST - determine if ITASK included or excluded           07340000
*                                                                       07350000
* DESCRIPTION:                                                          07360000
*                                                                       07370000
*    This routine determines whether a TASK() or MASKTASK()             07380000
*    operand specifically excludes the candidate ITASK from             07390000
*    the request.                                                       07400000
*                                                                       07410000
*                                                                       07420000
* ON ENTRY:                                                             07430000
*                                                                       07440000
*    R1 - address of candidate ITASK                                    07450000
*                                                                       07460000
*                                                                       07470000
* ON EXIT:                                                              07480000
*                                                                       07490000
*    inclusion or exclusion is indicated by the condition code          07500000
*                                                                       07510000
*        CC == 0 - ITASK not excluded                                   07520000
*        CC != 0 - ITASK specifically excluded                          07530000
*                                                                       07540000
***************************************************************         07550000
                                                                        07560000
TASKTEST DS    0H                                                       07570000
         TM    TASKNAME,BF        TASK NAME / PATTERN FILTER?           07580000
         BZR   R14                ALL TASKS OTHERWISE (CC == 0)         07590000
                                                                        07600000
         CLI   MINID,TL_TASK      SIMPLE TASK NAME FILTER?              07610000
         BNE   TTPAT              TRY NEXT OPTION IF NOT                07620000
         CLC   TASKNAME,TSKNAME-ITASK(R1)                               07630000
         BR    R14                REFLECT COMPARE RESULT TO CALLER      07640000
                                                                        07650000
TTPAT    DS    0H                 PATTERN MATCH REQUEST                 07660000
         CLI   MINID,TL_MTASK     TASK NAME PATTERN?                    07670000
         BNER  R14                NE COMPRENDRE PAS                     07680000
                                                                        07690000
*--------------------------------------------------------------         07700000
*   pattern match requires use of a service routine                     07710000
*--------------------------------------------------------------         07720000
                                                                        07730000
         STM   R0,R15,REGSAVE     PRESERVE MAINLINE REGS                07740000
         LR    R5,R1              ACCEPT CANDIDATE ITASK BLOCK          07750000
TTSK     USING ITASK,R5           PRIVATE ADDRESSABILITY                07760000
                                                                        07770000
         LA    R3,L'TTSK.TSKNAME  LENGTH OF TASK NAME                   07780000
         LA    R4,X'40'           SCAN_PATTERN ????????????????         07790000
                                                                        07800000
         $CLINK FUNC=PATMTCH,     MATCH PATTERN AGAINST CANDIDATE      X07810000
               (CHAR*,TASKNAME),  NTS PATTERN                          X07820000
               (CHAR*,TTSK.TSKNAME),                                   X07830000
               (REGISTER_INT,(R3)), LENGTH OF TASK NAME                X07840000
               (REGISTER_INT,(R4)), PATTERN MATCH REQUEST              X07850000
               (INT,ICTZERO),                                          X07860000
               (INT,ICTZERO)                                            07870000
                                                                        07880000
         LTR   R15,R15            PATMATCH USES FALSE AS NO MATCH       07890000
         LA    R15,TRUE           REVERSE TO ASM NOTION                 07900000
         BZ    *+8                                                      07910000
         LA    R15,FALSE                                                07920000
         LTR   R15,R15                                                  07930000
                                                                        07940000
         LM    R0,R14,REGSAVE     RESTORE CALLERS REGS                  07950000
         BR    R14                RETURN                                07960000
         DROP  TTSK               CANDIDATE ITASK                       07970000
                                                                        07980000
         EJECT                                                          07990000
***************************************************************         08000000
*                                                                       08010000
* ROUTINE: TESTACT - determine whether ITASK is active                  08020000
*                                                                       08030000
* DESCRIPTION:                                                          08040000
*                                                                       08050000
*    This routine is used to determine whether the given ITASK          08060000
*    is active as follows:                                              08070000
*                                                                       08080000
*       1) if the given ITASK is active on a server ITASK,              08090000
*          the ITASK is active                                          08100000
*                                                                       08110000
*       2) if the given ITASK is its own server and it has an           08120000
*          active PCB, the ITASK is active                              08130000
*                                                                       08140000
*                                                                       08150000
* ON ENTRY:                                                             08160000
*                                                                       08170000
*    R1 - ITASK address                                                 08180000
*                                                                       08190000
*                                                                       08200000
* ON EXIT:                                                              08210000
*                                                                       08220000
*    active/inactive status is reflected via the condition code         08230000
*                                                                       08240000
*        CC == 0 - ITASK is active                                      08250000
*        CC != 0 - ITASK is not active                                  08260000
*                                                                       08270000
***************************************************************         08280000
                                                                        08290000
TESTACT  DS    0H                                                       08300000
         ICM   R15,15,TSKSVTSK-ITASK(R1)   BRANCH IF ITASK RUNS UNDER   08310000
         BNZ   TA_SERV                     A SERVER ITASK               08320000
         ICM   R0,15,TSKPCBC-ITASK(R1)     ANY PCB ACTIVE ON THIS TASK? 08330000
         BNZ   *+8                         SKIP IF SO                   08340000
         LA    R15,RC04                    INDICATE ITASK NOT ACTIVE    08350000
         LTR   R15,R15                     CC SET ACCORDINGLY           08360000
         BR    R14                                                      08370000
                                                                        08380000
TA_SERV  DS    0H                          MOST ITASKS UNDER SERVERS    08390000
         L     R15,TSKSRV-ITASK(,R15)      ELSE LOCATE ITS SERVER       08400000
         CL    R1,SRVTASKC-SERVERX(,R15)   ITASK CURRENT ON SERVER?     08410000
         BR    R14                         CC SET ACCORDINGLY           08420000
                                                                        08430000
         EJECT                                                          08440000
***************************************************************         08450000
*                                                                       08460000
* ROUTINE: CVTHEX - convert fullword to displayable hex                 08470000
*                                                                       08480000
* ON ENTRY:                                                             08490000
*                                                                       08500000
*    R0 - fullword value                                                08510000
*                                                                       08520000
* ON EXIT:                                                              08530000
*                                                                       08540000
*    R1 - addr of CL8 displayable hex string                            08550000
*                                                                       08560000
***************************************************************         08570000
                                                                        08580000
CVTHEX   DS    0H                                                       08590000
         ST    R0,FWORD                                                 08600000
         UNPK  EYEHEX,FWORD(5)                                          08610000
         TR    EYEHEX(8),CVTHTAB-C'0'                                   08620000
         LA    R1,EYEHEX                                                08630000
         BR    R14                                                      08640000
                                                                        08650000
CVTHTAB  DC    C'0123456789ABCDEF'                                      08660000
                                                                        08670000
         EJECT                                                          08680000
***************************************************************         08690000
*                                                                       08700000
*   local read/only data areas, etc.                                    08710000
*                                                                       08720000
***************************************************************         08730000
                                                                        08740000
BLANKS   DC    CL16' '                                                  08750000
                                                                        08760000
         LTORG ,                                                        08770000
                                                                        08780000
         PRINT NOGEN                                                    08790000
         ICVT  ,                                                        08800000
         IPCB  ,                                                        08810000
         END   ,                                                        08820000

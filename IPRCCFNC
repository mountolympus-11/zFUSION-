IPRCCFNC TITLE 'PROCESS MANAGER C-LANGUAGE INTERFACE'                   00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE:  IPRCCFNC - PROCESS MANAGER C-LANGUAGE INTERFACE             00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*   THIS ROUTINE WILL BRIDGE C-LANGUAGE ROUTINES WITH THE               00080000
*   THE $PROC (PROCESS SERVICES). FUNCTIONS ARE PROVIDED                00090000
*   TO CREATE, DELETE, STOP AND CANCEL PROCESSES.                       00100000
*                                                                       00110000
* FUNCTIONS:                                                            00120000
*                                                                       00130000
*   PROCCRE - CREATE A NEW PROCESS                                      00140000
*   PROCDEL - DELETE A PROCESS                                          00150000
*   PROCSTP - STOP   A PROCESS                                          00160000
*   PROCCAN - CANCEL A PROCESS                                          00170000
*   TSEND   - SEND MESSAGE TO  TASK/PROCESS                             00180000
*   TRECV   - RECV MESSAGE FOR TASK/PROCESS                             00190000
*   TWAIT   - WAIT FOR EVENT COMPLETION                         134222  00200000
*   SETEPB  - INITIALIZE EVENT                                  134222  00210000
*   LOCMEPB - LOCATE MESSAGE EPB                                134222  00220000
*   LOCWUHDR- LOCATE WORKUNIT HEADER (@CB)                      134222  00230000
*   EPBPOST - POST AN EPB                                               00240000
*   TXPISRT - ACQUIRE / FORMAT STORAGE EXENT IN THE TXP BUFFER          00250000
*                                                                       00260000
* ON ENTRY:                                                             00270000
*                                                                       00280000
*   R1 CONTAINS THE ADDRESS OF THE PARAMETER LIST FOLLOWING             00290000
*   THE SAS/C STANDARD LINKAGE CONVENTIONS.                             00300000
*                                                                       00310000
* ON EXIT:                                                              00320000
*                                                                       00330000
*   R15 CONTAINS THE RETURN INFO AS DOCUMENTED IN THE                   00340000
*   FUNCTION PROLOG.                                                    00350000
*                                                                       00360000
**<DOC-OFF>*****************************************************        00370000
                                                                        00380000
         EJECT ,                                                        00390000
****************************************************************        00400000
*                                                                       00410000
* MAINTENANCE:                                                          00420000
*                                                                       00430000
*   06/21/93 RON COLMONE                                                00440000
*            INITIAL VERSION                                            00450000
*                                                                       00460000
*   08/04/94 RON COLMONE          PAR# 134222                           00470000
*            ADDED TWAIT, SETEPB, AND LOCMEPB FUNCTIONS                 00480000
*            FOR USE BY XPORT CPI-C TRANSACTION DRIVER.                 00490000
*                                                                       00500000
****************************************************************        00510000
         EJECT ,                                                        00520000
         $TASK  DSECT=YES         TASK SERVICES REQ BLOCK               00530000
         EJECT ,                                                        00540000
         $PROC  DSECT=YES         PROCESS SERVICES REQ BLOCK            00550000
         EJECT ,                                                        00560000
         $TSEND DSECT=YES         TASK/PROCESS SEND REQ BLOCK           00570000
         EJECT ,                                                        00580000
         EQUS  ,                  GENERAL EQUATES                       00590000
         EJECT ,                                                        00600000
         EVCODES ,                EVENT CODES                           00610000
                                                                        00620000
         EJECT ,                                                        00630000
         COPY  CRAB               "C"  RUNTIME ANCHOR BLOCK             00640000
         USING CRAB,R12           LIFETIME ADDRESSABILITY               00650000
                                                                        00660000
         EJECT ,                                                        00670000
****************************************************************        00680000
*                                                                       00690000
* DSECT: TSENDPL - TSEND PLIST AREA                                     00700000
*                                                                       00710000
* DESCRIPTION:                                                          00720000
*                                                                       00730000
*   THIS DSECT DESCRIBES THE FORMAT OF THE TSEND PLIST                  00740000
*   GENERATED BY THE TSEND C-LANGUAGE FUNCTION CALL.                    00750000
*                                                                       00760000
****************************************************************        00770000
TSENDPL  DSECT ,                                                        00780000
TSPTDEST DS    A                  ADDRESS OF TASKNAME STRING            00790000
TSPPDEST DS    A                  ADDRESS OF PROCNAME STRING            00800000
TSPMTYPE DS    F                  MESSAGE TYPE                          00810000
TSPINFO  DS    A                  ADDRESS OF MESSAGE INFO               00820000
TSPINFOL DS    F                  LENGTH  OF MESSAGE INGO               00830000
TSPPARMS DS    A                  ADDRESS OF MESSAGE PARMS              00840000
TSPLENG  EQU   *-TSENDPL          LENGTH  OF TSEND PLIST                00850000
                                                                        00860000
TSNDPRMS DSECT ,                  TSEND PARMS                           00870000
TSNDP1   DS    F                  PARM 1                                00880000
TSNDP2   DS    F                  PARM 2                                00890000
TSNDP3   DS    F                  PARM 3                                00900000
TSNDP4   DS    F                  PARM 4                                00910000
TSNDPLN  EQU   *-TSNDPRMS         LENGTH OF PARMS                       00920000
                                                                        00930000
         EJECT ,                                                        00940000
****************************************************************        00950000
*                                                                       00960000
* DSECT: TRECVPL - TRECV PLIST AREA                                     00970000
*                                                                       00980000
* DESCRIPTION:                                                          00990000
*                                                                       01000000
*   THIS DSECT DESCRIBES THE FORMAT OF THE TRECV PLIST                  01010000
*   GENERATED BY THE TRECV C-LANGUAGE FUNCTION CALL.                    01020000
*                                                                       01030000
****************************************************************        01040000
TRECVPL  DSECT ,                                                        01050000
TRPSCOPE DS    F                  TRECV SCOPE                           01060000
TRPS$TSK EQU   0                    SCOPE=TASK                          01070000
TRPS$PCB EQU   1                    SCOPE=PCB                           01080000
TRPWAIT  DS    F                  $TASK WAIT IF TRUE AND NO MSG         01090000
TRPAREA  DS    A                  ADDRESS OF RECEIVE AREA               01100000
TRPAREAL DS    F                  LENGTH OF RECEIVE AREA                01110000
TRPLENG  EQU   *-TRECVPL          LENGTH OF TRECV PLIST                 01120000
                                                                        01130000
         EJECT ,                                                134222  01140000
****************************************************************134222  01150000
*                                                               134222  01160000
* DSECT: TWAITPL - TWAIT PLIST AREA                             134222  01170000
*                                                               134222  01180000
* DESCRIPTION:                                                  134222  01190000
*                                                               134222  01200000
*   THIS DSECT DESCRIBES THE FORMAT OF THE TWAIT PLIST          134222  01210000
*   GENERATED BY THE TWAIT C-LANGUAGE FUNCTION CALL.            134222  01220000
*                                                               134222  01230000
****************************************************************134222  01240000
TWAITPL  DSECT ,                                                134222  01250000
TWPEPB@  DS    A                  EPB ADDRESS                   134222  01260000
TWPEVNT@ DS    A                  ADDRESS OF EVENT CODE         134222  01270000
TWPSTAT@ DS    A                  ADDRESS OF COMPLETION STATUS  134222  01280000
TWPLENG  EQU   *-TWAITPL          LENGTH OF TWAIT PLIST         134222  01290000
                                                                        01300000
         EJECT ,                                                134222  01310000
****************************************************************134222  01320000
*                                                               134222  01330000
* DSECT: TSEPBPL - SETEPB PLIST AREA                            134222  01340000
*                                                               134222  01350000
* DESCRIPTION:                                                  134222  01360000
*                                                               134222  01370000
*   THIS DSECT DESCRIBES THE FORMAT OF THE SETEPB PLIST         134222  01380000
*   GENERATED BY THE SETEPB C-LANGUAGE FUNCTION CALL.           134222  01390000
*                                                               134222  01400000
****************************************************************134222  01410000
TSEPBPL  DSECT ,                                                134222  01420000
TEPEPBA@ DS    A                  EPB ANCHOR ADDRESS            134222  01430000
TEPECODE DS    F                  EVENT CODE                    134222  01440000
TEPRTN@  DS    A                  ADDRESS OF ASYNC RTN          134222  01450000
TEPPARMS DS    A                  ADDRESS OF ASYNC RTN PARMS    134222  01460000
TEPPCB   DS    A                  ADDRESS OF ASSOCIATED PCB     134222  01470000
TEPSCOPE DS    F                  EPB SCOPE                     134222  01480000
TEPS$LCL EQU   0                    SCOPE=LOCAL                 134222  01490000
TEPS$GBL EQU   1                    SCOPE=GLOBAL                134222  01500000
TEPLENG  EQU   *-TSEPBPL          LENGTH OF SETEPB PLIST        134222  01510000
                                                                        01520000
         EJECT ,                                                134222  01530000
****************************************************************134222  01540000
*                                                               134222  01550000
* DSECT: LMEPBPL - LOCMEPB/LOCWUHDR PARAMETER LIST              134222  01560000
*                                                               134222  01570000
* DESCRIPTION:                                                  134222  01580000
*                                                               134222  01590000
*   THIS DSECT DESCRIBES THE FORMAT OF THE LOCMEPB PLIST        134222  01600000
*   GENERATED BY THE LOCMEPB C-LANGUAGE FUNCTION CALL.          134222  01610000
*                                                               134222  01620000
****************************************************************134222  01630000
LMEPBPL  DSECT ,                                                134222  01640000
LMPSCOPE DS    F                  SCOPE PCB / TASK              134222  01650000
LMPS$TSK EQU   0                    SCOPE=TASK                          01660000
LMPS$PCB EQU   1                    SCOPE=PCB                           01670000
LMPLENG  EQU   *-LMEPBPL          LENGTH OF LOCMEPB PLIST       134222  01680000
                                                                        01690000
         EJECT ,                                                        01700000
****************************************************************        01710000
*                                                                       01720000
* DSECT: EPOSTPL - EPBPOST PLIST                                        01730000
*                                                                       01740000
* DESCRIPTION:                                                          01750000
*                                                                       01760000
*   THIS DSECT DESCRIBES THE FORMAT OF THE EPBPOST PLIST                01770000
*   GENERATED BY THE EPBPOST C-LANGUAGE FUNCTION CALL.                  01780000
*                                                                       01790000
****************************************************************        01800000
EPOSTPL  DSECT ,                                                        01810000
EPEPBTKN DS    F                  EPB TOKEN                             01820000
EPPOSTCD DS    F                  POST CODE                             01830000
EPOSTLN  EQU   *-EPOSTPL          LENGTH OF EPOST PLIST                 01840000
                                                                        01850000
         EJECT ,                                                        01860000
****************************************************************        01870000
*                                                                       01880000
* DSECT: TXPISPL - TXPISRT PLIST                                        01890000
*                                                                       01900000
* DESCRIPTION:                                                          01910000
*                                                                       01920000
*   THIS DSECT DESCRIBES THE FORMAT OF THE TXPISPL PLIST                01930000
*   GENERATED BY THE TXPISRT C-LANGUAGE FUNCTION CALL.                  01940000
*                                                                       01950000
****************************************************************        01960000
TXPISPL  DSECT ,                                                        01970000
TXPIDATL DS    F                  DATA AREA LENGTH                      01980000
TXPIDATA DS    A                  SOURCE DATA AREA LENGTH OR ZERO       01990000
TXPISLN  EQU   *-TXPISPL          LENGTH OF EPOST PLIST                 02000000
                                                                        02010000
         EJECT ,                                                        02020000
****************************************************************        02030000
*                                                                       02040000
*  DYNAMIC SAVE AREA                                                    02050000
*                                                                       02060000
****************************************************************        02070000
         COPY  DSA                DYNAMIC SAVE AREA                     02080000
WORKAREA DS    0D                 USER DSA AREA                         02090000
TASKNM@  DS    A                  TASK    NAME ADDR                     02100000
PROCNM@  DS    A                  PROCESS NAME ADDR                     02110000
TASKNAME DS    CL8                TASK    NAME                          02120000
PROCNAME DS    CL8                PROCESS NAME                          02130000
                                                                        02140000
$TSNDPRM DS    XL(TSNDPLN)        TSEND PARMS                           02150000
                                                                        02160000
SCOPE    DS    X                  TRECV SCOPE FLAGS                     02170000
$SCP_TSK EQU   X'80'                SCOPE=TASK                          02180000
$SCP_PCB EQU   X'40'                SCOPE=PCB                           02190000
                                                                        02200000
FLAGS    DS    X                  CONTROL FLAGS                         02210000
$SETEPB  EQU   X'80'                MESSAGE EPB INITIALIZED             02220000
                                                                        02230000
PARMS    DS    10F                PARAMETER LIST                        02240000
$TASKMFL $TASK  MF=(L,PARMS)      $TASK  PLIST                          02250001
$PROCMFL $PROC  MF=(L,PARMS)      $PROC  PLIST                          02260001
$TSENDPL $TSEND MF=(L,PARMS)      $TSEND PLIST                          02270001
$TRECVPL $TRECV MF=(L,PARMS)      $TRECV PLIST                          02280001
                                                                        02290000
WORKLEN  EQU   *-WORKAREA         LENGTH OF USER DSA SECTION            02300000
DSALEN   EQU   *-DSA              LENGTH OF DSA                         02310000
                                                                        02320000
         EJECT ,                                                        02330000
**<DOC-ON>******************************************************        02340000
*                                                                       02350000
* FUNCTION: PROCCRE - CREATE NEW PROCESS                                02360000
*                                                                       02370000
* DESCRIPTION:                                                          02380000
*                                                                       02390000
*    THIS FUNCTION OF THIS ROUTINE IS TO PROVIDE A BRIDGE               02400000
*    FROM "C" TO THE $PROC CREATE FACILITY.  THIS ROUTINE               02410000
*    CREATE A NEW PROCESS WITH THE SPECIFIED NAME AND                   02420000
*    ENTRY ADDRESS.  IF PROCESS CREATE IS SUCCESSFUL, THE               02430000
*    ADDRESS OF THE NEWLY CREATED PCB IS RETURNED.                      02440000
*                                                                       02450000
*                                                                       02460000
* ENTRY:    R1 CONTAINS ADDR OF FOLLOWING PARAMETER LIST:               02470000
*                                                                       02480000
*               +00  - ADDR OF PROCESS NAME STRING                      02490000
*               +04  - PROCESS ENTRY ADDRESS                            02500000
*               +08  - PROCESS PARM  ADDRESS                            02510000
*               +0C  - DISPATCH PRIORITY                                02520000
*               +10  - STORAGE POOL SIZE                                02530000
*                                                                       02540000
* EXIT:     R15 CONTAINS RETURN VALUE AS FOLLOWS:                       02550000
*                 0  - PROCESS CREATE FAILED                            02560000
*                >0  - PCB ADDRESS (CREATE SUCCESSFUL)                  02570000
*                                                                       02580000
**<DOC-OFF>*****************************************************        02590000
                                                                        02600000
IPRCCFNC CSECT ,                                                        02610000
PROCCRE  CENTRY DSA=DSALEN                                              02620000
         USING DSA,R13            ADDRESSABILITY                        02630000
                                                                        02640000
         LR    R8,R1              ADDRESS OF PASSED PARMS               02650000
                                                                        02660000
         LA    R0,WORKAREA        ADDR OF USER DSA                      02670000
         LA    R1,WORKLEN         LENGTH OF USER DSA                    02680000
         SR    R15,R15            PREPARE FOR CLEAR                     02690000
         MVCL  R0,R14             CLEAR USER DSA SECTION                02700000
                                                                        02710000
*---------------------------------------------------------------        02720000
*  RESTORE STANDARD ENVIRONMENT                                         02730000
*---------------------------------------------------------------        02740000
         @RESTENV ,                                                     02750000
         USING ICVT,R11           ADDRESSABILITY                        02760000
         USING ITASK,R10          ADDRESSABILITY                        02770000
                                                                        02780000
         EJECT ,                                                        02790000
*---------------------------------------------------------------        02800000
* GET NAME OF PROCESS TO BE CREATED                                     02810000
*---------------------------------------------------------------        02820000
PRC_NAME DS    0H                                                       02830000
         L     R2,0(,R8)          ADDRESS OF PROCESS NAME               02840000
         MVC   PROCNAME,BLANKS    INITIALIZE PROCESS NAME               02850000
                                                                        02860000
         @CALL STRLEN,((R2)),MF=(E,PARMS)                               02870000
         LA    R0,L'PROCNAME      MAXIMUM LENGTH OF PROCNAME            02880000
         CR    R15,R0             STRING LENGTH < MAX                   02890000
         BH    *+6                NO, CONTINUE                          02900000
         LR    R15,R0             USE MAXIMUM LENGTH                    02910000
                                                                        02920000
         BCTR  R15,0              PREPARE FOR EXEC                      02930000
         EX    R15,*+4            COPY STRING                           02940000
         MVC   PROCNAME(*-*),0(R2) *** EX OBJECT ***                    02950000
                                                                        02960000
*---------------------------------------------------------------        02970000
* OBTAIN PARMS AND ISSUE PROC CREATE REQUEST                            02980000
*---------------------------------------------------------------        02990000
         L     R2,4(,R8)          ENTRY ADDRESS OF PROCESS RTN          03000000
         L     R3,8(,R8)          PARM  ADDRESS OF PROCESS RTN          03010000
         L     R4,12(,R8)         DISPATCH PRIORITY                     03020000
         L     R5,16(,R8)         STORAGE POOL ALLOCATION SIZE          03030000
                                                                        03040000
         $PROC CREATE,            CREATE NEW PROCESS                   +03050000
               NAME=PROCNAME,                                          +03060000
               EP=(R2),                                                +03070000
               PARM=(R3),                                              +03080000
               DPRTY=(R4),                                             +03090000
               STGSIZE=(R5),                                           +03100000
               MF=(E,$PROCMFL)                                          03110000
                                                                        03120000
         BNZ   CRE_ERR            ERROR, CREATE FAILED                  03130000
                                                                        03140000
         LR    R15,R1             RETURN PCB ADDRESS                    03150000
         B     CRE_EXIT           RETURN                                03160000
                                                                        03170000
         EJECT ,                                                        03180000
*---------------------------------------------------------------        03190000
*  RETURN                                                               03200000
*---------------------------------------------------------------        03210000
CRE_ERR  DS    0H                                                       03220000
         LA    R15,0              PCB=0, $PROC CREATE FAILED            03230000
         B     CRE_EXIT           RETURN                                03240000
                                                                        03250000
CRE_EXIT DS    0H                                                       03260000
         CEXIT RC=(R15)           RETURN                                03270000
                                                                        03280000
         EJECT ,                                                        03290000
**<DOC-ON>******************************************************        03300000
*                                                                       03310000
* FUNCTION: PROCDEL - DELETE PROCESS                                    03320000
*                                                                       03330000
* DESCRIPTION:                                                          03340000
*                                                                       03350000
*   THE FUNCTION OF THIS ROUTINE IS TO PROVIDE A BRIDGE                 03360000
*   FROM "C" TO THE $PROC DELETE FACILITY.  THIS ROUTINE                03370000
*   ISSUES A $PROC DELETE REQUEST FOR THE SPECIFIED PCB.                03380000
*   THE RETURN CODE FROM THE $PROC DELETE SERVICE IS                    03390000
*   RETURNED.                                                           03400000
*                                                                       03410000
* ENTRY:    R1 CONTAINS ADDR OF THE PARAMETER LIST AS FOLLOWS:          03420000
*                                                                       03430000
*               +00  - ADDR OF PCB TO DELETE                            03440000
*                                                                       03450000
* EXIT:     R15 CONTAINS RETURN CODE FROM $PROC DELETE REQUEST          03460000
*                                                                       03470000
**<DOC-OFF>*****************************************************        03480000
                                                                        03490000
PROCDEL  CENTRY DSA=DSALEN                                              03500000
         USING DSA,R13            ADDRESSABILITY                        03510000
                                                                        03520000
         LR    R8,R1              ADDRESS OF PASSED PARMS               03530000
                                                                        03540000
         LA    R0,WORKAREA        ADDR OF USER DSA                      03550000
         LA    R1,WORKLEN         LENGTH OF USER DSA                    03560000
         SR    R15,R15            PREPARE FOR CLEAR                     03570000
         MVCL  R0,R14             CLEAR USER DSA SECTION                03580000
                                                                        03590000
*---------------------------------------------------------------        03600000
*  RESTORE STANDARD ENVIRONMENT                                         03610000
*---------------------------------------------------------------        03620000
         @RESTENV ,                                                     03630000
         USING ICVT,R11           ADDRESSABILITY                        03640000
         USING ITASK,R10          ADDRESSABILITY                        03650000
                                                                        03660000
         EJECT ,                                                        03670000
*---------------------------------------------------------------        03680000
* ISSUE PROCESS DELETE REQUEST                                          03690000
*---------------------------------------------------------------        03700000
                                                                        03710000
         $PROC DELETE,            DELETE SPECIFIED PROCESS             +03720000
               PCB=*0(R8),                                             +03730000
               MF=(E,$PROCMFL)                                          03740000
                                                                        03750000
         CEXIT RC=(R15)           RETURN                                03760000
                                                                        03770000
         EJECT ,                                                        03780000
**<DOC-ON>******************************************************        03790000
*                                                                       03800000
* FUNCTION: PROCSTP - STOP PROCESS                                      03810000
*                                                                       03820000
* DESCRIPTION:                                                          03830000
*                                                                       03840000
*   THE FUNCTION OF THIS ROUTINE IS TO PROVIDE A BRIDGE                 03850000
*   FROM "C" TO THE $PROC STOP FACILITY.  THIS ROUTINE                  03860000
*   ISSUES A $PROC STOP REQUEST FOR THE SPECIFIED PCB.                  03870000
*   THE RETURN CODE FROM THE $PROC STOP SERVICE IS                      03880000
*   RETURNED.                                                           03890000
*                                                                       03900000
* ENTRY:    R1 CONTAINS ADDR OF THE PARAMETER LIST AS FOLLOWS:          03910000
*                                                                       03920000
*               +00  - ADDR OF PCB TO STOP                              03930000
*                                                                       03940000
* EXIT:     R15 CONTAINS RETURN CODE FROM $PROC STOP REQUEST            03950000
*                                                                       03960000
**<DOC-OFF>*****************************************************        03970000
                                                                        03980000
PROCSTP  CENTRY DSA=DSALEN                                              03990000
         USING DSA,R13            ADDRESSABILITY                        04000000
                                                                        04010000
         LR    R8,R1              ADDRESS OF PASSED PARMS               04020000
                                                                        04030000
         LA    R0,WORKAREA        ADDR OF USER DSA                      04040000
         LA    R1,WORKLEN         LENGTH OF USER DSA                    04050000
         SR    R15,R15            PREPARE FOR CLEAR                     04060000
         MVCL  R0,R14             CLEAR USER DSA SECTION                04070000
                                                                        04080000
*---------------------------------------------------------------        04090000
*  RESTORE STANDARD ENVIRONMENT                                         04100000
*---------------------------------------------------------------        04110000
         @RESTENV ,                                                     04120000
         USING ICVT,R11           ADDRESSABILITY                        04130000
         USING ITASK,R10          ADDRESSABILITY                        04140000
                                                                        04150000
         EJECT ,                                                        04160000
*---------------------------------------------------------------        04170000
* ISSUE PROCESS STOP REQUEST                                            04180000
*---------------------------------------------------------------        04190000
                                                                        04200000
         $PROC STOP,              STOP SPECIFIED PROCESS               +04210000
               PCB=*0(R8),                                             +04220000
               MF=(E,$PROCMFL)                                          04230000
                                                                        04240000
         CEXIT RC=(R15)           RETURN                                04250000
                                                                        04260000
         EJECT ,                                                        04270000
**<DOC-ON>******************************************************        04280000
*                                                                       04290000
* FUNCTION: PROCCAN - CANCEL PROCESS                                    04300000
*                                                                       04310000
* DESCRIPTION:                                                          04320000
*                                                                       04330000
*   THE FUNCTION OF THIS ROUTINE IS TO PROVIDE A BRIDGE                 04340000
*   FROM "C" TO THE $PROC CANCEL FACILITY.  THIS ROUTINE                04350000
*   ISSUES A $PROC CANCEL REQUEST FOR THE SPECIFIED PCB.                04360000
*   THE RETURN CODE FROM THE $PROC CANCEL SERVICE IS                    04370000
*   RETURNED.                                                           04380000
*                                                                       04390000
* ENTRY:    R1 CONTAINS ADDR OF THE PARAMETER LIST AS FOLLOWS:          04400000
*                                                                       04410000
*               +00  - ADDR OF PCB TO CANCEL                            04420000
*                                                                       04430000
* EXIT:     R15 CONTAINS RETURN CODE FROM $PROC CANCEL REQUEST          04440000
*                                                                       04450000
**<DOC-OFF>*****************************************************        04460000
                                                                        04470000
PROCCAN  CENTRY DSA=DSALEN                                              04480000
         USING DSA,R13            ADDRESSABILITY                        04490000
                                                                        04500000
         LR    R8,R1              ADDRESS OF PASSED PARMS               04510000
                                                                        04520000
         LA    R0,WORKAREA        ADDR OF USER DSA                      04530000
         LA    R1,WORKLEN         LENGTH OF USER DSA                    04540000
         SR    R15,R15            PREPARE FOR CLEAR                     04550000
         MVCL  R0,R14             CLEAR USER DSA SECTION                04560000
                                                                        04570000
*---------------------------------------------------------------        04580000
*  RESTORE STANDARD ENVIRONMENT                                         04590000
*---------------------------------------------------------------        04600000
         @RESTENV ,                                                     04610000
         USING ICVT,R11           ADDRESSABILITY                        04620000
         USING ITASK,R10          ADDRESSABILITY                        04630000
                                                                        04640000
         EJECT ,                                                        04650000
*---------------------------------------------------------------        04660000
* ISSUE PROCESS CANCEL REQUEST                                          04670000
*---------------------------------------------------------------        04680000
                                                                        04690000
         $PROC CANCEL,            CANCEL SPECIFIED PROCESS             +04700000
               PCB=*0(R8),                                             +04710000
               MF=(E,$PROCMFL)                                          04720000
                                                                        04730000
         CEXIT RC=(R15)           RETURN                                04740000
                                                                        04750000
         EJECT ,                                                        04760000
**<DOC-ON>******************************************************        04770000
*                                                                       04780000
* FUNCTION: TSEND - SEND MESSAGE TO TASK/PROCESS                        04790000
*                                                                       04800000
* DESCRIPTION:                                                          04810000
*                                                                       04820000
*   THE FUNCTION OF THIS ROUTINE IS TO PROVIDE A C-LANGUAGE             04830000
*   BRIDGE TO THE $TSEND (TASK/PROCESS) SEND SERVIVE.                   04840000
*                                                                       04850000
* ENTRY:    R1 CONTAINS ADDR OF A PARAMETER LIST DESCRIBED              04860000
*              BY THE TSENDPL MAPPING EXPANDED ABOVE                    04870000
*                                                                       04880000
* EXIT:     R15 CONTAINS THE RETURN CODE FROM TSEND                     04890000
*                                                                       04900000
**<DOC-OFF>*****************************************************        04910000
                                                                        04920000
TSEND    CENTRY DSA=DSALEN                                              04930000
         USING DSA,R13            ADDRESSABILITY                        04940000
                                                                        04950000
         LR    R8,R1              ADDR OF TSEND PARMS                   04960000
         USING TSENDPL,R8         ADDRESSABILITY                        04970000
                                                                        04980000
         LA    R0,WORKAREA        ADDR OF USER DSA                      04990000
         LA    R1,WORKLEN         LENGTH OF USER DSA                    05000000
         SR    R15,R15            PREPARE FOR CLEAR                     05010000
         MVCL  R0,R14             CLEAR USER DSA SECTION                05020000
                                                                        05030000
         ICM   R1,15,TSPPARMS     ADDRESS OF TSEND PARMS                05040000
         BZ    *+10               NO PARMS TO COPY                      05050000
         MVC   $TSNDPRM,0(R1)     MAKE LOCAL COPY OF PARMS              05060000
                                                                        05070000
         LA    R7,$TSNDPRM        ADDR OF PARMS                         05080000
         USING TSNDPRMS,R7        ADDRESSABILITY                        05090000
                                                                        05100000
*---------------------------------------------------------------        05110000
*  RESTORE STANDARD ENVIRONMENT                                         05120000
*---------------------------------------------------------------        05130000
         @RESTENV ,                                                     05140000
         USING ICVT,R11           ADDRESSABILITY                        05150000
         USING ITASK,R10          ADDRESSABILITY                        05160000
                                                                        05170000
         EJECT ,                                                        05180000
*---------------------------------------------------------------        05190000
*  FORMAT DESTINATION TASK                                              05200000
*---------------------------------------------------------------        05210000
TDEST    DS    0H                 DESTINATION TASK NAME                 05220000
         ICM   R2,15,TSPTDEST     TASK NAME DEST                        05230000
         BZ    PDEST              NONE, SKIP TASK NAME                  05240000
         MVC   TASKNAME,BLANKS    INITIALIZE TASK NAME                  05250000
         @CALL STRLEN,((R2)),MF=(E,PARMS)                               05260000
         LTR   R15,R15            NULL STRING                           05270000
         BZ    PDEST              YES, ASSUME CURRENT TASK              05280000
         LA    R0,L'TASKNAME      MAXIMUM LENGTH OF TASKNAME            05290000
         CR    R15,R0             STRING LENGTH < MAX                   05300000
         BL    *+6                NO, CONTINUE                          05310000
         LR    R15,R0             USE MAXIMUM LENGTH                    05320000
                                                                        05330000
         BCTR  R15,0              PREPARE FOR EXEC                      05340000
         EX    R15,*+4            COPY STRING                           05350000
         MVC   TASKNAME(*-*),0(R2) *** EX OBJECT ***                    05360000
                                                                        05370000
         CLI   TASKNAME,C'*'      CURRENT TASK?                         05380000
         BE    PDEST              YES, CONTINUE WITH PROCESS NAME       05390000
         LA    R1,TASKNAME        ADDRESS OF TASK NAME                  05400000
         ST    R1,TASKNM@         SAVE ADDRESS                          05410000
                                                                        05420000
*---------------------------------------------------------------        05430000
*  FORMAT DESTINATION PROCESS                                           05440000
*---------------------------------------------------------------        05450000
PDEST    DS    0H                 DESTINATION PROC NAME                 05460000
         ICM   R2,15,TSPPDEST     PROC NAME DEST                        05470000
         BZ    SENDREQ            NONE, ISSUE SEND REQUEST              05480000
         MVC   PROCNAME,BLANKS    INITIALIZE PROC NAME                  05490000
         @CALL STRLEN,((R2)),MF=(E,PARMS)                               05500000
         LTR   R15,R15            NULL STRING?                          05510000
         BZ    SENDREQ            YES, CONTINUE WITH SEND               05520000
         LA    R0,L'PROCNAME      MAXIMUM LENGTH OF PROCNAME            05530000
         CR    R15,R0             STRING LENGTH < MAX                   05540000
         BL    *+6                NO, CONTINUE                          05550000
         LR    R15,R0             USE MAXIMUM LENGTH                    05560000
                                                                        05570000
         BCTR  R15,0              PREPARE FOR EXEC                      05580000
         EX    R15,*+4            COPY STRING                           05590000
         MVC   PROCNAME(*-*),0(R2) *** EX OBJECT ***                    05600000
                                                                        05610000
         CLI   PROCNAME,C'*'      CURRENT PROCESS?                      05620000
         BE    SENDREQ            YES, CONTINUE WITH TSEND              05630000
         LA    R1,PROCNAME        ADDRESS OF PROC NAME                  05640000
         ST    R1,PROCNM@         SAVE ADDRESS                          05650000
                                                                        05660000
         EJECT ,                                                        05670000
*---------------------------------------------------------------        05680000
*  ISSUE TSEND REQUEST                                                  05690000
*---------------------------------------------------------------        05700000
SENDREQ  DS    0H                                                       05710000
         $TSEND *TASKNM@,*PROCNM@,                                     +05720000
               TYPE=*TSPMTYPE,                                         +05730000
               INFO=(*TSPINFO,*TSPINFOL),                              +05740000
               PARMS=(*TSNDP1,*TSNDP2,*TSNDP3,*TSNDP4),                +05750000
               REPLY=NO,                                               +05760000
               MF=(E,$TSENDPL)                                          05770000
                                                                        05780000
         CEXIT RC=(R15)           RETURN                                05790000
         DROP  R8,R7              TSENDPL, TSNDPRMS                     05800000
                                                                        05810000
         EJECT ,                                                        05820000
**<DOC-ON>******************************************************        05830000
*                                                                       05840000
* FUNCTION: TRECV - RECEIVE TASK/PROCESS MESSAGE                        05850000
*                                                                       05860000
* DESCRIPTION:                                                          05870000
*                                                                       05880000
*   THE FUNCTION OF THIS ROUTINE IS TO PROVIDE A C-LANGUAGE             05890000
*   BRIDGE TO THE $TRECV/$TASK WAIT SERVICES.                           05900000
*                                                                       05910000
* ENTRY:    R1 CONTAINS ADDR OF A PARAMETER LIST DESCRIBED BY           05920000
*              THE TRECVPL MAPPING ABOVE                                05930000
*                                                                       05940000
* EXIT:     R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES.             05950000
*                                                                       05960000
*                RC00   - MESSAGE SUCCESSFULLY RECEIVED                 05970000
*                RC04   - NO MESSAGE AVAILABLE (WAIT=NO)                05980000
*               -(RC04) - STOP   EVENT RECEIVED                         05990000
*               -(RC08) - CANCEL EVENT RECEIVED                         06000000
*                < -8   - BUFFER TOO SMALL (NEG LENGTH)                 06010000
*                                                                       06020000
**<DOC-OFF>*****************************************************        06030000
                                                                        06040000
TRECV    CENTRY DSA=DSALEN                                              06050000
                                                                        06060000
         LR    R8,R1              ADDRESS OF PARMS                      06070000
         USING TRECVPL,R8         ADDRESSABILITY                        06080000
                                                                        06090000
         LA    R0,WORKAREA        ADDR OF USER DSA                      06100000
         LA    R1,WORKLEN         LENGTH OF USER DSA                    06110000
         SR    R15,R15            PREPARE FOR CLEAR                     06120000
         MVCL  R0,R14             CLEAR USER DSA SECTION                06130000
                                                                        06140000
*---------------------------------------------------------------        06150000
*  RESTORE STANDARD ENVIRONMENT                                         06160000
*---------------------------------------------------------------        06170000
         @RESTENV ,                                                     06180000
         USING ICVT,R11           ADDRESSABILITY                        06190000
         USING ITASK,R10          ADDRESSABILITY                        06200000
                                                                        06210000
         EJECT ,                                                        06220000
*---------------------------------------------------------------        06230000
*   RECEIVE MESSAGE                                                     06240000
*---------------------------------------------------------------        06250000
RECV_MSG DS    0H                                                       06260000
         LA    R0,TRPS$PCB        SCOPE=PCB                             06270000
         C     R0,TRPSCOPE                                              06280000
         BE    RECV_PCB           YES, RECEIVE FROM PCB QUEUE           06290000
                                                                        06300000
*--------------------------                                             06310000
*   TASK MESSAGE QUEUE                                                  06320000
*--------------------------                                             06330000
RECV_TSK DS    0H                                                       06340000
         OI    SCOPE,$SCP_TSK     INDICATE TASK LEVEL RECEIVE           06350000
         $TRECV (*TRPAREA,*TRPAREAL),  ISSUE TASK LEVEL MSG RECV       +06360000
               SCOPE=TASK,                                             +06370000
               MF=(E,$TRECVPL)                                          06380000
                                                                        06390000
         B     RECV_RC                                                  06400000
                                                                        06410000
*--------------------------                                             06420000
*   PCB MESSAGE QUEUE                                                   06430000
*--------------------------                                             06440000
RECV_PCB DS    0H                                                       06450000
         OI    SCOPE,$SCP_PCB     INDICATE PCB LEVEL RECEIVE            06460000
         $TRECV (*TRPAREA,*TRPAREAL),  ISSUE PROCESS LEVEL MSG RECV    +06470000
               SCOPE=PCB,                                              +06480000
               MF=(E,$TRECVPL)                                          06490000
                                                                        06500000
*---------------------------------------------------------------        06510000
*   TEST TASK/PROCESS RECEIVE COMPLETION STATUS                         06520000
*---------------------------------------------------------------        06530000
RECV_RC  DS    0H                                                       06540000
         B     *+4(R15)           BRANCH ON RECEIVE RETURN CODE         06550000
         B     RECV_RET           MESSAGE AVAILABLE, RETURN             06560000
         B     RECV_NA            MESSAGE NOT AVAILABLE / WAIT?         06570000
         B     RECV_SIZ           BUFFER TOO SMALL CONDITION            06580000
                                                                        06590000
         EJECT ,                                                        06600000
*---------------------------------------------------------------        06610000
*   BUFFER NOT AVAILABLE,  CHECK IF WAIT REQUESTED                      06620000
*---------------------------------------------------------------        06630000
RECV_NA  DS    0H                                                       06640000
         ICM   R0,15,TRPWAIT      WAIT SPECIFIED?                       06650000
         BZ    RECV_RET           NO, RETURN                            06660000
                                                                        06670000
         TM    FLAGS,$SETEPB      EPB INITIALIZED?                      06680000
         BO    TSK_WAIT           YES,  WAIT FOR COMPLETION             06690000
                                                                        06700000
         LA    R6,ITASK           ASSUME SCOPE=TASK                     06710000
         TM    SCOPE,$SCP_TSK     SCOPE=TASK SPECIFIED                  06720000
         BO    *+8                YES, CONTINUE                         06730000
         L     R6,TSKPCBC         OBTAIN PCB WORKUNIT                   06740000
         USING @CB,R6             ADDRESSABILITY                        06750000
         L     R6,@CB@MEPB        ADDRESS OF WORKUNIT MSG EPB           06760000
         USING EPB,R6             ADDRESSABILITY                        06770000
                                                                        06780000
         OI    FLAGS,$SETEPB      INDICATE EPB INITIALIZED              06790000
         TM    EPBECB,X'80'       SETEPB ALREADY ISSUED?                06800000
         BO    TSK_WAIT           YES, WAIT FOR COMPLETION              06810000
                                                                        06820000
         TM    SCOPE,$SCP_TSK     GLOBAL EVENT                          06830000
         BZ    LCL_EPB            NO,  USE LOCAL EPB                    06840000
         $TASK SETEPB,EPB=(R6),ECODE=EC$MSG,MF=(E,$TASKMFL)             06850000
         B     RECV_MSG           SET IF MESSAGE HAS ARRIVED            06860000
                                                                        06870000
LCL_EPB  DS    0H                                                       06880000
         $TASK SETEPB,EPB=(R6),ECODE=EC$MSG,SCOPE=LOCAL,MF=(E,$TASKMFL) 06890000
         B     RECV_MSG           SEE IF MESSAGE HAS ARRIVED            06900000
                                                                        06910000
         EJECT ,                                                        06920000
*---------------------------------------------------------------        06930000
*  WAIT FOR COMPLETION OF MESSAGE EVENT                                 06940000
*---------------------------------------------------------------        06950000
TSK_WAIT DS    0H                                                       06960000
         $TASK WAIT,              WAIT FOR MESSAGE TO ARRIVE           +06970000
               EPB=EPB,           ONLY MESSAGE EVENTS                  +06980000
               MESSAGE=RECV_MSG,  RECEIVE THE MESSAGE                  +06990000
               CANCEL=RECV_CAN,   CANCEL RECEIVED                      +07000000
               STOP=RECV_STP,     STOP   RECEIVED                      +07010000
               MF=(E,$TASKMFL)                                          07020000
         B     TSK_WAIT           SHOULDN'T HAPPEN, BUT WAIT IF SO      07030000
                                                                        07040000
         EJECT ,                                                        07050000
*---------------------------------------------------------------        07060000
*  SET RETURN CODE AND RETURN                                           07070000
*---------------------------------------------------------------        07080000
RECV_SIZ DS    0H                                                       07090000
         LNR   R15,R1             INSUFFICIENT BUFF SIZE (NEG SIZE)     07100000
         B     RECV_RET           RETURN                                07110000
                                                                        07120000
RECV_STP DS    0H                                                       07130000
         LA    R15,RC04           STOP RETURN CODE                      07140000
         LNR   R15,R15            NEGATIVE RC FOR TERM REQUEST          07150000
         B     RECV_RET           RETURN                                07160000
                                                                        07170000
RECV_CAN DS    0H                                                       07180000
         LA    R15,RC08           CANCEL RETURN CODE                    07190000
         LNR   R15,R15            NEGATIVE RC FOR TERM REQUEST          07200000
         B     RECV_RET           RETURN                                07210000
                                                                        07220000
RECV_RET DS    0H                                                       07230000
         CEXIT RC=(R15)           RETURN                                07240000
                                                                        07250000
         DROP  R8,R6              TRECVPL, EPB                          07260000
                                                                        07270000
         EJECT ,                                                134222  07280000
**<DOC-ON>******************************************************134222  07290000
*                                                               134222  07300000
* FUNCTION: TWAIT - TWAIT FOR EVENT COMPLETION                  134222  07310000
*                                                               134222  07320000
* DESCRIPTION:                                                  134222  07330000
*                                                               134222  07340000
*   THE FUNCTION OF THIS ROUTINE IS TO PROVIDE A C-LANGUAGE     134222  07350000
*   BRIDGE TO THE $TASK WAIT SERVICES.                          134222  07360000
*                                                               134222  07370000
* ENTRY:    R1 CONTAINS ADDR OF A PARAMETER LIST DESCRIBED BY   134222  07380000
*              THE TWAITPL MAPPING ABOVE                        134222  07390000
*                                                               134222  07400000
* EXIT:     R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES.     134222  07410000
*                                                               134222  07420000
*                RC00   - EVENT NOTIFICATION COMPLETE           134222  07430000
*               -(RC04) - STOP   EVENT RECEIVED                 134222  07440000
*               -(RC08) - CANCEL EVENT RECEIVED                 134222  07450000
*                                                               134222  07460000
**<DOC-OFF>*****************************************************134222  07470000
                                                                        07480000
TWAIT    CENTRY DSA=DSALEN                                      134222  07490000
                                                                        07500000
         LR    R8,R1              ADDRESS OF PARMS              134222  07510000
         USING TWAITPL,R8         ADDRESSABILITY                134222  07520000
                                                                        07530000
         LA    R0,WORKAREA        ADDR OF USER DSA              134222  07540000
         LA    R1,WORKLEN         LENGTH OF USER DSA            134222  07550000
         SR    R15,R15            PREPARE FOR CLEAR             134222  07560000
         MVCL  R0,R14             CLEAR USER DSA SECTION        134222  07570000
                                                                        07580000
*---------------------------------------------------------------134222  07590000
*  RESTORE STANDARD ENVIRONMENT                                 134222  07600000
*---------------------------------------------------------------134222  07610000
         @RESTENV ,                                             134222  07620000
         USING ICVT,R11           ADDRESSABILITY                134222  07630000
         USING ITASK,R10          ADDRESSABILITY                134222  07640000
                                                                        07650000
*---------------------------------------------------------------134222  07660000
*  WAIT FOR EVENT COMPLETION                                    134222  07670000
*---------------------------------------------------------------134222  07680000
         $TASK WAIT,              WAIT FOR EVENT COMPLETION     134222 +07690000
               EPB=*TWPEPB@,                                    134222 +07700000
               CANCEL=WAIT_CAN,                                 134222 +07710000
               STOP=WAIT_STP,                                   134222 +07720000
               MF=(E,$TASKMFL)                                  134222  07730000
                                                                        07740000
         L     R2,TWPEVNT@        ADDRESS OF EVENT CODE         134222  07750000
         ST    R15,0(,R2)         SAVE EVENT CODE               134222  07760000
                                                                        07770000
         L     R2,TWPSTAT@        ADDRESS OF EVENT COMPL CODE   134222  07780000
         ST    R0,0(,R2)          SAVE COMPLETION CODE          134222  07790000
                                                                        07800000
         LA    R15,RC00           NORMAL COMPLETION             134222  07810000
         B     WAIT_RET           RETURN                        134222  07820000
                                                                        07830000
         EJECT ,                                                134222  07840000
*---------------------------------------------------------------134222  07850000
*  SET RETURN CODE AND RETURN                                   134222  07860000
*---------------------------------------------------------------134222  07870000
WAIT_STP DS    0H                                               134222  07880000
         LA    R15,RC04           STOP RETURN CODE              134222  07890000
         LNR   R15,R15            NEGATIVE RC FOR TERM REQUEST  134222  07900000
         B     WAIT_RET           RETURN                        134222  07910000
                                                                        07920000
WAIT_CAN DS    0H                                               134222  07930000
         LA    R15,RC08           CANCEL RETURN CODE            134222  07940000
         LNR   R15,R15            NEGATIVE RC FOR TERM REQUEST  134222  07950000
         B     WAIT_RET           RETURN                        134222  07960000
                                                                        07970000
WAIT_RET DS    0H                                               134222  07980000
         CEXIT RC=(R15)           RETURN                        134222  07990000
                                                                        08000000
         DROP  R8                 TWAITPL                       134222  08010000
                                                                        08020000
         EJECT ,                                                134222  08030000
**<DOC-ON>******************************************************134222  08040000
*                                                               134222  08050000
* FUNCTION: SETEPB - ININITIAL EVENT                            134222  08060000
*                                                               134222  08070000
* DESCRIPTION:                                                  134222  08080000
*                                                               134222  08090000
*   THE FUNCTION OF THIS ROUTINE IS TO PROVIDE A C-LANGUAGE     134222  08100000
*   BRIDGE TO THE $TASK SETEPB SERVICES.                        134222  08110000
*                                                               134222  08120000
* ENTRY:    R1 CONTAINS ADDR OF A PARAMETER LIST DESCRIBED BY   134222  08130000
*              THE TSEPBPL MAPPING ABOVE                        134222  08140000
*                                                               134222  08150000
* EXIT:     R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES.     134222  08160000
*                                                               134222  08170000
*                RC00   - EVENT NOTIFICATION COMPLETE           134222  08180000
*               >RC00   - SETEPB COMPLETION CODE                134222  08190000
*                RC20   - REQUEST ERROR                         134222  08200000
*                                                               134222  08210000
**<DOC-OFF>*****************************************************134222  08220000
                                                                        08230000
SETEPB   CENTRY DSA=DSALEN                                      134222  08240000
                                                                        08250000
         LR    R8,R1              ADDRESS OF PARMS              134222  08260000
         USING TSEPBPL,R8         ADDRESSABILITY                134222  08270000
                                                                        08280000
         LA    R0,WORKAREA        ADDR OF USER DSA              134222  08290000
         LA    R1,WORKLEN         LENGTH OF USER DSA            134222  08300000
         SR    R15,R15            PREPARE FOR CLEAR             134222  08310000
         MVCL  R0,R14             CLEAR USER DSA SECTION        134222  08320000
                                                                        08330000
*---------------------------------------------------------------134222  08340000
*  RESTORE STANDARD ENVIRONMENT                                 134222  08350000
*---------------------------------------------------------------134222  08360000
         @RESTENV ,                                             134222  08370000
         USING ICVT,R11           ADDRESSABILITY                134222  08380000
         USING ITASK,R10          ADDRESSABILITY                134222  08390000
                                                                        08400000
*---------------------------------------------------------------134222  08410000
*  OBTAIN EPB ANCHOR AND EPB ADDRESS                            134222  08420000
*---------------------------------------------------------------134222  08430000
         ICM   R2,15,TEPEPBA@     ADDRESS OF EPB ANCHOR         134222  08440000
         BZ    SEPB_REQ           INVALID REQUEST               134222  08450000
         L     R3,0(,R2)          ADDRESS OF EPB                134222  08460000
                                                                        08470000
         CLC   TEPSCOPE,=A(TEPS$LCL)  SCOPE=LOCAL               134222  08480000
         BNE   SEPB_GBL               NO, SET GLOBAL EPB        134222  08490000
                                                                        08500000
*---------------------------------------------------------------134222  08510000
*  INITIALIZE SCOPE=LOCAL EPB                                   134222  08520000
*---------------------------------------------------------------134222  08530000
SEPB_LCL DS    0H                                               134222  08540000
         $TASK SETEPB,            INITIALIZE SCOPE=LOCAL EPB    134222 +08550000
               EPB=(R3),                                        134222 +08560000
               ECODE=*TEPECODE,                                 134222 +08570000
               RTN=*TEPRTN@,                                    134222 +08580000
               PARM=*TEPPARMS,                                  134222 +08590000
               PCB=*TEPPCB,                                     134222 +08600000
               SCOPE=LOCAL,                                     134222 +08610000
               MF=(E,$TASKMFL)                                  134222  08620000
                                                                        08630000
         B     SEPB_GO                                          134222  08640000
                                                                        08650000
*---------------------------------------------------------------134222  08660000
*  INITIALIZE SCOPE=GLOBAL EPB                                  134222  08670000
*---------------------------------------------------------------134222  08680000
SEPB_GBL DS    0H                                               134222  08690000
         $TASK SETEPB,            INITIALIZE SCOPE=LOCAL EPB    134222 +08700000
               EPB=(R3),                                        134222 +08710000
               ECODE=*TEPECODE,                                 134222 +08720000
               RTN=*TEPRTN@,                                    134222 +08730000
               PARM=*TEPPARMS,                                  134222 +08740000
               PCB=*TEPPCB,                                     134222 +08750000
               SCOPE=GLOBAL,                                    134222 +08760000
               MF=(E,$TASKMFL)                                  134222  08770000
                                                                        08780000
*---------------------------------------------------------------134222  08790000
*  SAVE EPB ADDRESS IF XEPB REQUESTED                           134222  08800000
*---------------------------------------------------------------134222  08810000
SEPB_GO  DS    0H                                               134222  08820000
         LTR   R15,R15            SETEPB SUCCESSFUL             134222  08830000
         BNZ   SEPB_RET           NO, RETURN                    134222  08840000
                                                                        08850000
         LTR   R3,R3              XEPB REQUESTED?               134222  08860000
         BNZ   SEPB_RET           NO, SUCCESSFULL COMPLETION    134222  08870000
         N     R2,=F'-2'          CONVERT EPB TOKEN TO ADDRESS  134222  08880000
         ST    R1,0(,R2)          RETURN ADDRESS OF XEPB        134222  08890000
                                                                        08900000
         B     SEPB_RET           RETURN                        134222  08910000
                                                                        08920000
*---------------------------------------------------------------134222  08930000
*  SET COMPLETION CODE AND RETURN                               134222  08940000
*---------------------------------------------------------------134222  08950000
SEPB_REQ DS    0H                                               134222  08960000
         LA    R15,RC20           REQUEST ERROR                 134222  08970000
                                                                        08980000
SEPB_RET DS    0H                                               134222  08990000
         CEXIT RC=(R15)           RETURN                        134222  09000000
                                                                        09010000
         DROP  R8                 TSEPBPL                       134222  09020000
                                                                        09030000
         EJECT ,                                                134222  09040000
**<DOC-ON>******************************************************134222  09050000
*                                                               134222  09060000
* FUNCTION: LOCMEPB - LOCATE MESSAGE EPB                        134222  09070000
*                                                               134222  09080000
* DESCRIPTION:                                                  134222  09090000
*                                                               134222  09100000
*   THE FUNCTION OF THIS ROUTINE IS TO RETURN THE ADDRESS       134222  09110000
*   THE TASK OR PCB MESSAGE EPB.                                134222  09120000
*                                                               134222  09130000
* ENTRY:    R1 CONTAINS ADDR OF A PARAMETER LIST DESCRIBED BY   134222  09140000
*              THE LMEPBPL MAPPING ABOVE                        134222  09150000
*                                                               134222  09160000
* EXIT:     R15 CONTAINS THE ADDRESS OF THE REQUEST MSG EPB.    134222  09170000
*                                                               134222  09180000
**<DOC-OFF>*****************************************************134222  09190000
                                                                        09200000
LOCMEPB  CENTRY DSA=DSALEN                                      134222  09210000
                                                                        09220000
         LR    R8,R1              ADDRESS OF PARMS              134222  09230000
         USING LMEPBPL,R8         ADDRESSABILITY                134222  09240000
                                                                        09250000
         LA    R0,WORKAREA        ADDR OF USER DSA              134222  09260000
         LA    R1,WORKLEN         LENGTH OF USER DSA            134222  09270000
         SR    R15,R15            PREPARE FOR CLEAR             134222  09280000
         MVCL  R0,R14             CLEAR USER DSA SECTION        134222  09290000
                                                                        09300000
*---------------------------------------------------------------134222  09310000
*  RESTORE STANDARD ENVIRONMENT                                 134222  09320000
*---------------------------------------------------------------134222  09330000
         @RESTENV ,                                             134222  09340000
         USING ICVT,R11           ADDRESSABILITY                134222  09350000
         USING ITASK,R10          ADDRESSABILITY                134222  09360000
                                                                        09370000
*---------------------------------------------------------------134222  09380000
*  GET ADDRESS OF SCOPE WORKUNIT                                134222  09390000
*---------------------------------------------------------------134222  09400000
         LR    R3,R10             ASSUME SCOPE ITASK            134222  09410000
         CLC   LMPSCOPE,=A(LMPS$TSK)     SCOPE=PCB?             134222  09420000
         BE    *+8                NO, CONTINUE                  134222  09430000
         L     R3,TSKPCBC         OBTAIN CURRENT WORKUNIT ADDR  134222  09440000
         USING @CB,R3             TEMP ADDRESSABILITY           134222  09450000
                                                                        09460000
         L     R15,@CB@MEPB       ADDRESS OF MESSAGE EPB        134222  09470000
                                                                        09480000
*---------------------------------------------------------------134222  09490000
*  RETURN                                                       134222  09500000
*---------------------------------------------------------------134222  09510000
         CEXIT RC=(R15)           RETURN                        134222  09520000
                                                                        09530000
         DROP  R8,R3              LMEPBPL, @CB                  134222  09540000
                                                                        09550000
         EJECT ,                                                134222  09560000
**<DOC-ON>******************************************************134222  09570000
*                                                               134222  09580000
* FUNCTION: LOCWUHDR - LOCATE WORKUNIT HEADER (@CB WORKUNIT=YES)134222  09590000
*                                                               134222  09600000
* DESCRIPTION:                                                  134222  09610000
*                                                               134222  09620000
*   THE FUNCTION OF THIS ROUTINE IS TO RETURN THE ADDRESS       134222  09630000
*   THE WORKUNIT HEADER (@CB) FOR THE ITASK OR ACTIVE IPCB.     134222  09640000
*                                                               134222  09650000
* ENTRY:    R1 CONTAINS ADDR OF A PARAMETER LIST DESCRIBED BY   134222  09660000
*              THE LMEPBPL MAPPING ABOVE                        134222  09670000
*                                                               134222  09680000
* EXIT:     R15 CONTAINS THE ADDRESS OF THE WORKUNIT HEADER.    134222  09690000
*                                                               134222  09700000
**<DOC-OFF>*****************************************************134222  09710000
                                                                        09720000
LOCWUHDR CENTRY DSA=DSALEN                                      134222  09730000
                                                                        09740000
         LR    R8,R1              ADDRESS OF PARMS              134222  09750000
         USING LMEPBPL,R8         ADDRESSABILITY                134222  09760000
                                                                        09770000
         LA    R0,WORKAREA        ADDR OF USER DSA              134222  09780000
         LA    R1,WORKLEN         LENGTH OF USER DSA            134222  09790000
         SR    R15,R15            PREPARE FOR CLEAR             134222  09800000
         MVCL  R0,R14             CLEAR USER DSA SECTION        134222  09810000
                                                                        09820000
*---------------------------------------------------------------134222  09830000
*  RESTORE STANDARD ENVIRONMENT                                 134222  09840000
*---------------------------------------------------------------134222  09850000
         @RESTENV ,                                             134222  09860000
         USING ICVT,R11           ADDRESSABILITY                134222  09870000
         USING ITASK,R10          ADDRESSABILITY                134222  09880000
                                                                        09890000
*---------------------------------------------------------------134222  09900000
*  GET ADDRESS OF SCOPE WORKUNIT                                134222  09910000
*---------------------------------------------------------------134222  09920000
         LR    R15,R10            ASSUME SCOPE ITASK            134222  09930000
         CLC   LMPSCOPE,=A(LMPS$TSK)     SCOPE=PCB?             134222  09940000
         BE    *+8                NO, CONTINUE                  134222  09950000
         L     R15,TSKPCBC        OBTAIN CURRENT WORKUNIT ADDR  134222  09960000
                                                                        09970000
*---------------------------------------------------------------134222  09980000
*  RETURN                                                       134222  09990000
*---------------------------------------------------------------134222  10000000
         CEXIT RC=(R15)           RETURN                        134222  10010000
                                                                        10020000
         DROP  R8                 LMEPBPL, @CB                  134222  10030000
                                                                        10040000
         EJECT ,                                                        10050000
**<DOC-ON>******************************************************        10060000
*                                                                       10070000
* FUNCTION: EPBPOST - POST EPB                                          10080000
*                                                                       10090000
* DESCRIPTION:                                                          10100000
*                                                                       10110000
*   THE FUNCTION OF THIS ROUTINE IS TO PROVIDE A C-LANGUAGE             10120000
*   BRIDGE TO THE $TASK POST SERVICE.                                   10130000
*                                                                       10140000
* ENTRY:    R1  CONTAINS ADDR OF A PARAMETER LIST DESCRIBED BY          10150000
*               THE EPOSTPL MAPPING EXPANDED ABOVE                      10160000
*                                                                       10170000
* EXIT:     R15 CONTAINS A $TASK POST RETURN CODE                       10180000
*                                                                       10190000
**<DOC-OFF>*****************************************************        10200000
                                                                        10210000
EPBPOST  CENTRY DSA=DSALEN                                              10220000
                                                                        10230000
         LR    R8,R1              ADDRESS OF PARMS                      10240000
         USING EPOSTPL,R8         ADDRESSABILITY                        10250000
                                                                        10260000
         LA    R0,WORKAREA        ADDR OF USER DSA                      10270000
         LA    R1,WORKLEN         LENGTH OF USER DSA                    10280000
         SR    R15,R15            PREPARE FOR CLEAR                     10290000
         MVCL  R0,R14             CLEAR USER DSA SECTION                10300000
                                                                        10310000
*---------------------------------------------------------------        10320000
*  RESTORE STANDARD ENVIRONMENT                                         10330000
*---------------------------------------------------------------        10340000
         @RESTENV ,                                                     10350000
         USING ICVT,R11           ADDRESSABILITY                        10360000
         USING ITASK,R10          ADDRESSABILITY                        10370000
                                                                        10380000
*---------------------------------------------------------------        10390000
*  POST THE EPB AND EXIT                                                10400000
*---------------------------------------------------------------        10410000
         $TASK POST,              POST THE EPB                         +10420000
               EPB=*EPEPBTKN,     EPB TOKEN                            +10430000
               PCODE=*EPPOSTCD,   POST CODE                            +10440000
               MF=(E,$TASKMFL)                                          10450000
                                                                        10460000
         CEXIT RC=(R15)           RETURN                                10470000
         DROP  R8                 EPOSTPL                               10480000
                                                                        10490000
         EJECT ,                                                        10500000
**<DOC-ON>******************************************************        10510000
*                                                                       10520000
* FUNCTION: TXPISPL - TXP BUFFER INSERT                                 10530000
*                                                                       10540000
* DESCRIPTION:                                                          10550000
*                                                                       10560000
*   THE FUNCTION OF THIS ROUTINE IS TO PROVIDE A C-LANGUAGE             10570000
*   BRIDGE TO THE $XPBUFR ISRT SERVICE.  FUNCTION STACKING IS           10580000
*   NOT SUPPORTED IN THIS LEVEL OF THE SERVICE BRIDGE.                  10590000
*                                                                       10600000
* ENTRY:    R1  CONTAINS ADDR OF A PARAMETER LIST DESCRIBED BY          10610000
*               THE TXPISPL MAPPING EXPANDED ABOVE                      10620000
*                                                                       10630000
* EXIT:     R15 CONTAINS EITHER THE ADDRESS OF THE TXP BUFFER           10640000
*               AREA RETURNED OR ZERO IF AN ERROR WAS ENCOUNTERED       10650000
*                                                                       10660000
**<DOC-OFF>*****************************************************        10670000
                                                                        10680000
TXPISRT  CENTRY DSA=DSALEN                                              10690000
                                                                        10700000
         LR    R8,R1              ADDRESS OF PARMS                      10710000
         USING TXPISPL,R8         ADDRESSABILITY                        10720000
                                                                        10730000
         LA    R0,WORKAREA        ADDR OF USER DSA                      10740000
         LA    R1,WORKLEN         LENGTH OF USER DSA                    10750000
         SR    R15,R15            PREPARE FOR CLEAR                     10760000
         MVCL  R0,R14             CLEAR USER DSA SECTION                10770000
                                                                        10780000
*---------------------------------------------------------------        10790000
*  RESTORE STANDARD ENVIRONMENT                                         10800000
*---------------------------------------------------------------        10810000
         @RESTENV ,                                                     10820000
         USING ICVT,R11           ADDRESSABILITY                        10830000
         USING ITASK,R10          ADDRESSABILITY                        10840000
                                                                        10850000
*---------------------------------------------------------------        10860000
*  POST THE EPB AND EXIT                                                10870000
*---------------------------------------------------------------        10880000
         $XPBUFR ISRT,            TXP BUFFER INSERT                    +10890000
               DATALEN=*TXPIDATL, DATA AREA LENGTH                     +10900000
               DATA=*TXPIDATA,    SOURCE DATA AREA ORIGIN OR ZERO      +10910000
               MF=(E,PARMS)                                             10920000
                                                                        10930000
         LTR   R15,R15            INSERT SUCCESSFUL?                    10940000
         BNZ   TXPIFAIL           ERROR IF NOT                          10950000
         LR    R15,R1             RETURN AREA PTR                       10960000
         B     TXPIRET            DONE                                  10970000
                                                                        10980000
TXPIFAIL DS    0H                                                       10990000
         SR    R15,R15            INDICATE ERROR C-STYLE                11000000
                                                                        11010000
TXPIRET  DS    0H                                                       11020000
         CEXIT RC=(R15)           RETURN                                11030000
         DROP  R8                 EPOSTPL                               11040000
                                                                        11050000
         EJECT ,                                                        11060000
****************************************************************        11070000
*                                                                       11080000
*  LITERALS AND CONSTANTS                                               11090000
*                                                                       11100000
****************************************************************        11110000
BLANKS   DC    CL8' '             BLANKS                                11120000
                                                                        11130000
         LTORG ,                                                        11140000
                                                                        11150000
         PRINT NOGEN                                                    11160000
         ICVT  ,                                                        11170000
         ITASK ,                                                        11180000
         @CB   WORKUNIT=YES                                             11190000
         @EPB  ,                                                        11200000
         IHAPSA ,                                                       11210000
         IKJTCB ,                                                       11220000
         CVT   DSECT=YES,LIST=NO                                        11230000
         PRINT GEN                                                      11240000
                                                                        11250000
         END   ,                                                        11260000

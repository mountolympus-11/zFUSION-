ISQKYDST TITLE '- BUILD SELECT-DISTINCT ROW FILTER INDEX'               00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: ISQKYDST - Build SELECT DISTINCT row filter index            00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine constructs a "row filter" table index                 00080000
*    definition that accomodates a SELECT DISTINCT request.             00090000
*    The DENSE, UNIQUE index built spans all columns defined in         00100000
*    the base table (result set) provided ensuring that all             00110000
*    rows accepted by subsequent add requests are unique with           00120000
*    respect to previously accepted rows.                               00130000
*                                                                       00140000
*                                                                       00150000
* ON ENTRY:                                                             00160000
*                                                                       00170000
*    R1  contains the address of a parameter list constructed           00180000
*        as follows:                                                    00190000
*                                                                       00200000
*           +00 - address of the SQL semantic summary (SQLSEMAL)        00210000
*                 (not currently used)                                  00220000
*                                                                       00230000
*           +04 - address of the result set definition in the           00240000
*                 form of a TBCOLDEF pointer vector as used in          00250000
*                 a TBCREATE COLLST= operation                          00260000
*                                                                       00270000
*           +08 - number of TBCOLDEF vector entries conveying           00280000
*                 the result set column count                           00290000
*                                                                       00300000
*           +12 - address of a clear TBKEYDEF construction area         00310000
*                                                                       00320000
*                                                                       00330000
* ON EXIT:                                                              00340000
*                                                                       00350000
*    R15  contains one of the following return codes                    00360000
*                                                                       00370000
*         RC00 - the SELECT DISTINCT row filter index definition        00380000
*                was constructed without error                          00390000
*                                                                       00400000
*                R1 - TBKEYDEF origin                                   00410000
*                                                                       00420000
**<DOC-OFF>****************************************************         00430000
                                                                        00440000
         EJECT                                                          00450000
***************************************************************         00460000
*                                                                       00470000
* MAINTENANCE:                                                          00480000
*                                                                       00490000
*    01/27/95 R. Turgeon                                                00500000
*             Initial version modelled on 1.0C ITIDIST                  00510000
*                                                                       00520000
***************************************************************         00530000
                                                                        00540000
         EJECT                                                          00550000
         SQLSEMAL ,          SQL SEMANTIC SUMMARY                       00560000
                                                                        00570000
         EJECT                                                          00580000
         @TBKEYDF ,          TABLE KEY DEFINITION                       00590000
                                                                        00600000
         EJECT                                                          00610000
         @TBCOLDF ,          TABLE COLUMN DEFINITION                    00620000
                                                                        00630000
         EJECT                                                          00640000
         EQUS  ,             EQUATES                                    00650000
                                                                        00660000
         EJECT                                                          00670000
ISQKYDST #ENTER PREG=R8,SAVE=NO                                         00680000
                                                                        00690000
         USING ITASK,R10          STDENV                                00700000
                                                                        00710000
***************************************************************         00720000
*                                                                       00730000
*   Fetch passed parameters, initialize the TBKEYDEF in the             00740000
*   return area provided by the caller                                  00750000
*                                                                       00760000
***************************************************************         00770000
         L     R7,0(,R8)          ACCEPT SQL SEMANTIC SUMMARY           00780000
         USING SQSEMAL,R7         LIFE OF FUNCTION ADDRESSABILITY       00790000
                                                                        00800000
         L     R5,4(,R8)          TABLE TBCOLDEF POINTER ARRAY ORIGIN   00810000
         L     R6,8(,R8)          TBCOLDEF POINTER ARRAY ENTRY COUNT    00820000
                                                                        00830000
         L     R9,12(,R8)         TBKEYDEF CONSTRUCTION AREA            00840000
         USING TBKEYDEF,R9        DEFINES OUR KEYDEF                    00850000
         MVC   TBKEYNAM,=CL8'DISTINCT'      NAME THE INDEX              00860000
         MVI   TBKTYPE,$DENSE     ALL ROWS PARTICIPATE                  00870000
         MVI   TBKTYPE2,$UNIQUE   UNIQUE ROWS ONLY                      00880000
                                                                        00890000
*--------------------------------------------------------------         00900000
*   Complete index TBKEYDEF with references to all TBCOLDEFs            00910000
*--------------------------------------------------------------         00920000
         STH   R6,TBKCOUNT        ALL COLUMNS SPANNED BY THIS INDEX     00930000
                                                                        00940000
         LA    R0,TBKEYDEF+TBKEYDFL   ORIGIN OF TBCOLDEF POINTER ARRAY  00950000
         LR    R1,R6              COLUMN COUNT                          00960000
         SLL   R1,2               CONVERTED TO POINTER ARRAY LENGTH     00970000
         LR    R2,R5              TBCOLDEF POINTER ARRAY ORIGIN         00980000
         LR    R3,R1              BASE TABLE COLUMNS = INDEX COLUMNS    00990000
         MVCL  R0,R2              COMPLETE THE TBKEYDEF                 01000000
                                                                        01010000
***************************************************************         01020000
*                                                                       01030000
*   Return completed TBKEYDEF to caller                                 01040000
*                                                                       01050000
***************************************************************         01060000
         SR    R15,R15            SUCCESS                               01070000
         LA    R1,TBKEYDEF        RETURN TBKEYDEF ORIGIN                01080000
                                                                        01090000
         #EXIT ,                                                        01100000
                                                                        01110000
         EJECT                                                          01120000
***************************************************************         01130000
*                                                                       01140000
*   LOCAL READ/ONLY DATA AREAS                                          01150000
*                                                                       01160000
***************************************************************         01170000
         LTORG ,                                                        01180000
                                                                        01190000
         PRINT NOGEN                                                    01200000
         ICVT  ,                                                        01210000
         ITASK ,                                                        01220000
         END   ,                                                        01230000

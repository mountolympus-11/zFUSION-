IVTMXNSX TITLE 'INTEGRATOR - VTAM NSEXIT'                               00010000
**<DOC-ON>************************************************************* 00020000
*                                                                       00030000
* ROUTINE: IVTMXNSX - INTEGRATOR VTAM NSEXIT                            00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THE NSEXIT IS DRIVEN BY VTAM TO HANDLE THREE TYPES OF              00080000
*    SNA NETWORK SERVICES REQUESTS:                                     00090000
*                                                                       00100000
*       - CLEANUP RU, WHICH INDICATES A SESSION IS GONE.                00110000
*                                                                       00120000
*       - NOTIFY RU, FOR SESSION INITIATION ERRORS AND                  00130000
*         THIRD-PARTY NOTIFICATION OF SESSION PROCEDURES.               00140000
*                                                                       00150000
*       - NETWORK SERVICES PROCEDURE ERROR (NSPE) RU, FOR               00160000
*         SESSION SETUP ERRORS WHEN THE NIB USERFLD IN THE              00170000
*         INITIATION REQUEST WAS ZERO (THESE WILL NOT BE                00180000
*         EXPECTED IN THE INTEGRATOR).                                  00190000
*                                                                       00200000
*    A NSEXIT WORK ELEMENT IS CREATED AND QUEUED TO THE ISESS           00210000
*    WORK QUEUE OR THE MAIN TASK WORK QUEUE FOR PROCESSING.             00220000
*                                                                       00230000
* ON ENTRY:                                                             00240000
*                                                                       00250000
*    BAKR IS USED TO SAVE REGISTERS.                                    00260000
*                                                                       00270000
*    R15 = ENTRY POINT ADDRESS                                          00280000
*    R14 = RETURN ADDRESS                                               00290000
*    R01 = PARAMETER LIST ADDRESS                                       00300000
*          +00(4): ADDRESS OF ACB                                       00310000
*          +04(4): DEPENDENT ON RU TYPE                                 00320000
*                  CLEANUP: CID OF THE SESSION                          00330000
*                  NOTIFY:  NOT USED                                    00340000
*                  NSPE:    NOT USED                                    00350000
*          +08(4): DEPENDENT ON RU TYPE                                 00360000
*                  CLEANUP: NIB USERFLD FROM OPNDST/OPNSEC              00370000
*                  NOTIFY:  NIB USERFLD FROM SIMLOGON/REQSESS/          00380000
*                           CLSDST OPTCD=PASS                           00390000
*                  NSPE:    NOT USED                                    00400000
*          +0C(4): RESERVED (UNUSED)                                    00410000
*          +10(4): VTAM READ-ONLY RPL ADDRESS                           00420000
*          +14(4): RESERVED (UNUSED)                                    00430000
*                                                                       00440000
* ON EXIT:                                                              00450000
*                                                                       00460000
*    R15 = 0                                                            00470000
*    R00 = 0                                                            00480000
*    R01 = 0                                                            00490000
*                                                                       00500000
*    ALL OTHER REGISTERS ARE RESTORED BY PR.                            00510000
*                                                                       00520000
**<DOC-OFF>************************************************************ 00530000
                                                                        00540000
         EJECT ,                                                        00550000
*********************************************************************** 00560000
*                                                                       00570000
* MAINTENANCE:                                                          00580000
*                                                                       00590000
*   08/01/93 RANDY WITEK                                                00600000
*                                                                       00610000
*********************************************************************** 00620000
         EQUS  ,                  GENERAL EQUATES                       00630000
                                                                        00640000
RICVT    EQU   R11                INTEGRATOR CVT POINTER                00650000
RITASK   EQU   R10                ASSOCIATED ITASK POINTER              00660000
RIVTAM   EQU   R9                 INTEGRATOR VTAM CVT POINTER           00670000
RIACB    EQU   R8                 ASSOCIATED IACB POINTER               00680000
RIRPL    EQU   R7                 ASSOCIATED RPL/IRPL POINTER           00690000
RISESS   EQU   R6                 ASSOCIATED ISESS POINTER              00700000
RIWE     EQU   R5                 WORK ELEMENT POINTER                  00710000
                                                                        00720000
         USING ICVT,RICVT         ESTABLISH ADDRESSIBILTY               00730000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSIBILTY               00740000
         USING ITASK,RITASK       ESTABLISH ADDRESSIBILTY               00750000
         USING IACB,RIACB         ESTABLISH ADDRESSIBILTY               00760000
         USING IRPL,RIRPL         ESTABLISH ADDRESSIBILTY               00770000
         USING IWEVTAM,RIWE       ESTABLISH ADDRESSIBILTY               00780000
         USING ISESS,RISESS       ESTABLISH ADDRESSIBILTY               00790000
                                                                        00800000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00810000
         DS    0D                                                       00820000
RCVPARMS DS    XL(L'IVR)          IVTAMRPA STORAGE                      00830000
ESTAEMFL DS    XL(L'ESTAEXPL)     PARMLIST CONSTRUCTION                 00840000
FRRPARM  DS    A                  RETURN AREA FOR FRR PARM ADDRESS      00850000
SAVER2   DS    F                  TEMPORARY SAVE AREA                   00860000
RETR15   DS    F                  RETURN CODE VALUE                     00870000
RETR0    DS    F                  RETURN REGISTER 0                     00880000
RETR1    DS    F                  RETURN REGISTER 1                     00890000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00900000
FLAG     DS    X                                                        00910000
FLESTAEX EQU   X'08'              ESTAEX ACTIVE                         00920000
FLFRR    EQU   X'04'              FRR    ACTIVE                         00930000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00940000
                                                                        00950000
IVTMXNSX #VTENTER BASE=R12,       VTAM EXIT ROUTINE LINKAGE            +00960000
               AMODE=31,                                               +00970000
               RMODE=ANY,                                              +00980000
               PREG=(R2),                                              +00990000
               EXITYPE=PLIST                                            01000000
                                                                        01010000
         USING IVTAMRPA,RCVPARMS  ESTABLISH ADDRESSIBILITY              01020000
                                                                        01030000
*---------------------------------------------------------------------- 01040000
* ESTABLISH RECOVERY ENVIRONMENT                                        01050000
*---------------------------------------------------------------------- 01060000
                                                                        01070000
         ST    R2,SAVER2          SAVE PARM REG                         01080000
         LA    R15,IVTXRTRY       RETRY ROUTINE ADDRESS                 01090000
         ST    R15,IVRRETAD       SET RETRY ROUTINE ADDRESS             01100000
         LA    R15,IVTAMRPA       PARAMETERS ADDRESS                    01110000
         ST    R15,IVRRPA@        SET ADDRESS FOR FRR                   01120000
         L     R0,=F'-1'          SHOW REGS RESTORED FROM PARM AREA     01130000
         STM   R0,R15,IVRR00      SAVE RETRY REGISTERS                  01140000
         MVC   IVRMOD,=CL8'IVTMTASK'                                    01150000
         MVC   IVRCSECT,=CL8'IVTMXNSX'                                  01160000
         MVC   IVRFRR,=CL8'IVTMXRCV'                                    01170000
         MVC   IVRTYPE,=CL8'ESTAEX'                                     01180000
         L     R3,=V(IVTMXRCV)    ADDR OF VTAM EXIT RECOVERY ROUTINE    01190000
         ICM   R0,15,PSATOLD      SRB MODE?                             01200000
         BZ    ESTFRR             BRANCH IF YES                         01210000
                                                                        01220000
         MVC   ESTAEMFL(L'ESTAEXPL),ESTAEXL                             01230000
                                                                        01240000
         ESTAEX (R3),                                                  +01250000
               CT,                                                     +01260000
               PARAM=RCVPARMS,                                         +01270000
               TERM=YES,                                               +01280000
               MF=(E,ESTAEMFL)    ESTABLISH RECOVERY                    01290000
                                                                        01300000
         OI    FLAG,FLESTAEX      RECOVERY ENVIRONMENT ESTABLISHED      01310000
         B     RECOVSET           AND CONTINUE                          01320000
                                                                        01330000
ESTFRR   DS    0H                                                       01340000
                                                                        01350000
         MVC   IVRTYPE,=CL8'FRR'                                        01360000
                                                                        01370000
         MODESET EXTKEY=ZERO,                                          +01380000
               SAVEKEY=(2)        SET KEY ZERO                          01390000
                                                                        01400000
         SETFRR A,                                                     +01410000
               FRRAD=(R3),                                             +01420000
               WRKREGS=(14,15),                                        +01430000
               PARMAD=FRRPARM     ESTABLISH RECOVERY                    01440000
                                                                        01450000
         L     R1,FRRPARM         PARM AREA FOR FRR                     01460000
         MVC   0(12,R1),RCVPARMS  SET TYPE & PARM AREA POINTER          01470000
                                                                        01480000
         MODESET KEYADDR=(2)      RESTORE PREVIOUS KEY                  01490000
                                                                        01500000
         OI    FLAG,FLFRR         RECOVERY ENVIRONMENT ESTABLISHED      01510000
         B     RECOVSET           AND CONTINUE                          01520000
                                                                        01530000
RECOVSET DS    0H                                                       01540000
                                                                        01550000
         L     R2,SAVER2          RESTORE PARM REG                      01560000
                                                                        01570000
*---------------------------------------------------------------------- 01580000
* COLLECT PARAMETERS                                                    01590000
*---------------------------------------------------------------------- 01600000
                                                                        01610000
         L     RIACB,0(,R2)       ASSOCIATED IACB ADDRESS               01620000
         L     RIRPL,16(,R2)      ADDRESS OF VTAM READ-ONLY RPL         01630000
         L     RISESS,8(,R2)      NIB USERFLD CONTENTS                  01640000
                                                                        01650000
*---------------------------------------------------------------------- 01660000
* COMPUTE LENGTH OF WORK ELEMENT                                        01670000
*---------------------------------------------------------------------- 01680000
                                                                        01690000
         LA    R3,L'IWEX4         LENGTH OF BASIC WORK ELEMENT          01700000
         A     R3,RPLRLEN         PLUS LENGTH OF THE RU DATA            01710000
                                                                        01720000
*---------------------------------------------------------------------- 01730000
* DETERMINE WHERE TO QUEUE WORK ELEMENT BASED ON USERFLD                01740000
*---------------------------------------------------------------------- 01750000
                                                                        01760000
         LTR   RISESS,RISESS      NIB USRFLD IS ISESS ADDRESS           01770000
         BNP   QTOMAIN            IF USERFLD IS ZERO --> NO ISESS       01780000
*                                 IF USERFLD <  ZERO --> ISQE ADDRESS   01790000
         OI    IVRF1,IVRF1IVI     ISESS VALIDATION IN PROGRESS          01800000
         CLC   ISEID,=CL8'ISESS'  CHECK THE EYECATCHER                  01810000
         BNE   QTOMAIN            BRANCH IF NOT GOOD                    01820000
         NI    IVRF1,255-IVRF1IVI ISESS VALIDATION COMPLETE             01830000
         LA    R4,ISEWEQ          USE THE ISESS WORK QUEUE              01840000
         L     RITASK,ISEITASK    GET THE SESSION ITASK POINTER         01850000
         B     ALLOCWE            GO CREATE THE WORK ELEMENT            01860000
                                                                        01870000
*---------------------------------------------------------------------- 01880000
* ISESS WASN'T FOUND, SO SEND THE WORK ELEMENT TO THE MAIN TASK         01890000
*---------------------------------------------------------------------- 01900000
                                                                        01910000
QTOMAIN  DS    0H                                                       01920000
                                                                        01930000
         NI    IVRF1,255-IVRF1IVI ISESS VALIDATION COMPLETE             01940000
         SR    RISESS,RISESS      SHOW NO ISESS                         01950000
         LA    R4,IVTWEQ          USE THE VTAM MAIN WORK QUEUE          01960000
                                                                        01970000
*---------------------------------------------------------------------- 01980000
* ALLOCATE NSEXIT WORK ELEMENT                                          01990000
*---------------------------------------------------------------------- 02000000
                                                                        02010000
ALLOCWE  DS    0H                                                       02020000
                                                                        02030000
         ST    R2,SAVER2          SAVE R2 TEMPORARILY                   02040000
                                                                        02050000
         $VTAMWE (R3),            SIZE                                 +02060000
               IWECXNSX           CODE                                  02070000
                                                                        02080000
         LR    RIWE,R1            WORK ELEMENT ADDRESS                  02090000
         L     R2,SAVER2          RESTORE R2                            02100000
                                                                        02110000
*---------------------------------------------------------------------- 02120000
* BUILD NSEXIT WORK ELEMENT                                             02130000
*---------------------------------------------------------------------- 02140000
                                                                        02150000
         ST    RIACB,IWEX4ACB     SET ACB ADDRESS                       02160000
         MVC   IWEX4CID,4(R2)     SET CID                               02170000
         MVC   IWEX4USR,8(R2)     SET USERFLD                           02180000
         SR    R3,R3              CLEAR FOR IC                          02190000
         IC    R3,RPLLEN          LENGTH OF VTAM RPL                    02200000
         BCTR  R3,0               LENGTH CODE FOR EXECUTE               02210000
         EX    R3,COPYRPL         COPY VTAM RPL TO WORK ELEMENT         02220000
         LA    R0,IWEX4RU         ADDRESS OF RU DATA RECEIVING AREA     02230000
         L     R1,RPLRLEN         LENGTH OF RU DATA                     02240000
         LR    R3,R1              LENGTH OF RU DATA                     02250000
         L     R2,RPLAREA         ADDRESS OF RU DATA                    02260000
         MVCL  R0,R2              COPY RU DATA TO WORK ELEMENT          02270000
         LA    R1,IWEX4RU         ADDRESS OF THE RU DATA COPY           02280000
         ST    R1,IWEX4RPL+(RPLAREA-IFGRPL) POINT RPL COPY AT RU COPY   02290000
                                                                        02300000
*---------------------------------------------------------------------- 02310000
* TRACE THE MODULE ENTRY                                                02320000
*---------------------------------------------------------------------- 02330000
                                                                        02340000
         $TRACE *=A(TRC_IVTMXNSX),32,STDENV=NO        32 USER BYTES     02350000
                                                                        02360000
         BNZ   NOMTRACE           BRANCH IF TRACING NOT AVAILABLE       02370000
                                                                        02380000
         ST    RITASK,0(,R1)      TRACE ITASK                           02390000
         ST    RISESS,4(,R1)      TRACE ISESS                           02400000
         ST    RIACB,8(,R1)       TRACE IACB                            02410000
         MVC   12(4,R1),IWEX4CID  TRACE CID                             02420000
         MVC   20(4,R1),IWEX4USR  TRACE PARM LIST USERFLD               02430000
         L     R2,RPLRLEN         LENGTH OF RU                          02440000
         C     R2,=F'4'           MORE THAN 4 BYTES?                    02450000
         BNH   USELEN             BRANCH IF NOT                         02460000
         LA    R2,4               MAX. OF 4 BYTES                       02470000
                                                                        02480000
USELEN   DS    0H                                                       02490000
                                                                        02500000
         BCTR  R2,0               LENGTH CODE                           02510000
         EX    R2,TRACERU         COPY UP TO 4 BYTES                    02520000
         B     NOMTRACE           GO AROUND THE EXECUTE                 02530000
                                                                        02540000
TRACERU  MVC   16(0,R1),IWEX4RU   TRACE MAX. OF 4 BYTES OF THE RU       02550000
                                                                        02560000
NOMTRACE DS    0H                                                       02570000
                                                                        02580000
*---------------------------------------------------------------------- 02590000
* QUEUE NSEXIT WORK ELEMENT TO VTAM MAIN/SESSION ITASK                  02600000
*---------------------------------------------------------------------- 02610000
                                                                        02620000
         $VTAMQ (RIWE),           WORK ELEMENT                         +02630000
               (R4),              QUEUE                                +02640000
               STDENV=NO          EXIT ROUTINE                          02650000
                                                                        02660000
         B     RETURN                                                   02670000
                                                                        02680000
*---------------------------------------------------------------------- 02690000
* RETRY ROUTINE SCHEDULED BY RECOVERY                                   02700000
*---------------------------------------------------------------------- 02710000
                                                                        02720000
IVTXRTRY DS    0H                                                       02730000
                                                                        02740000
         LTR   R0,R0              WERE REGISTERS RESTORED FOR RETRY?    02750000
         BM    REGSOK             BRANCH IF YES, READY TO EXIT          02760000
X        USING IVTAMRPA,R1        PARM AREA ADDRESS MUST BE IN R1       02770000
         LM    R0,R15,X.IVRR00    RESTORE ALL THE REGISTERS             02780000
         DROP  X                                                        02790000
                                                                        02800000
REGSOK   DS    0H                                                       02810000
                                                                        02820000
         ICM   R0,15,PSATOLD      SRB MODE?                             02830000
         BNZ   RETURN             BRANCH IF NOT                         02840000
         ICM   R1,B'0001',=X'80'  KEY 8 IN BITS 24-27                   02850000
         MODESET KEYREG=(R1)      SET KEY 8                             02860000
         B     RETURN             AND WE ARE READY TO EXIT              02870000
                                                                        02880000
*---------------------------------------------------------------------- 02890000
* RETURN TO VTAM FROM EXIT ROUTINE                                      02900000
*---------------------------------------------------------------------- 02910000
                                                                        02920000
RETURN   DS    0H                                                       02930000
                                                                        02940000
         TM    FLAG,FLESTAEX      IS ESTAEX ESTABLISHED?                02950000
         BNO   RETFRR             BRANCH IF NOT                         02960000
                                                                        02970000
         ESTAEX 0                 DELETE RECOVERY ENVIRONMENT           02980000
                                                                        02990000
         NI    FLAG,255-FLESTAEX  CLEAR FLAG                            03000000
         B     EXITNOW            AND EXIT                              03010000
                                                                        03020000
RETFRR   DS    0H                                                       03030000
                                                                        03040000
         TM    FLAG,FLFRR         IS FRR ESTABLISHED?                   03050000
         BNO   EXITNOW            BRANCH IF NOT                         03060000
                                                                        03070000
         MODESET EXTKEY=ZERO,                                          +03080000
               SAVEKEY=(2)        SET KEY ZERO                          03090000
                                                                        03100000
         SETFRR D,                                                     +03110000
               WRKREGS=(14,15)    DELETE RECOVERY ENVIRONMENT           03120000
                                                                        03130000
         MODESET KEYADDR=(2)      RESTORE PREVIOUS KEY                  03140000
                                                                        03150000
         NI    FLAG,255-FLFRR     CLEAR FLAG                            03160000
         B     EXITNOW            AND EXIT                              03170000
                                                                        03180000
EXITNOW  DS    0H                                                       03190000
                                                                        03200000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 03210000
                                                                        03220000
         #VTEXIT ,                RETURN                                03230000
                                                                        03240000
*---------------------------------------------------------------------- 03250000
*  CONSTANTS AND LITERALS                                               03260000
*---------------------------------------------------------------------- 03270000
                                                                        03280000
COPYRPL  MVC   IWEX4RPL(0),0(RIRPL) COPY READ-ONLY RPL TO IWE           03290000
                                                                        03300000
ESTAEXL  ESTAEX *-*,CT,MF=L       ESTAEX PLIST                          03310000
ESTAEXPL EQU   ESTAEXL,*-ESTAEXL                                        03320000
                                                                        03330000
         LTORG ,                                                        03340000
         PRINT NOGEN                                                    03350000
         IVTAMRPA ,               INTEGRATOR VTAM RECOVERY PARAMETERS   03360000
         IHAFRRS ,                MVS FRR STACK                         03370000
         IHAPSA ,                 MVS PREFIXED STORAGE AREA             03380000
         ISTDBIND ,               VTAM BIND IMAGE                       03390000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         03400000
         ICVT  ,                  INTEGRATOR CVT                        03410000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   03420000
         ITASK ,                  INTEGRATOR TASK BLOCK                 03430000
         IACB ,                   INTEGRATOR VTAM ACB+                  03440000
         IRPL ,                   INTEGRATOR VTAM RPL+                  03450000
         INIB ,                   INTEGRATOR VTAM NIB+                  03460000
         ISESS ,                  INTEGRATOR SESSION BLOCK              03470000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            03480000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          03490000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       03500000
         EVCODES ,                INTEGRATOR EVENT CODES                03510000
         ABCODES ,                INTEGRATOR $ABEND CODES               03520000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     03530000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             03540000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             03550000
         IFGEXLST ,               VTAM EXIT LIST                        03560000
         END   ,                                                        03570000

IRUNAAPS TITLE '- AAPSCAN SERVICE, SCAN AAP LIST'                       00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE:  IRUNAAPS - AAPSCAN service, scan AAP list                   00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine implements the VDB virtual session scan               00080000
*    service described in the AAPSCAN macro.                            00090000
*                                                                       00100000
*                                                                       00110000
* METHOD:                                                               00120000
*                                                                       00130000
*    Active and terminating virtual sessions with host                  00140000
*    applications are represented by an AAP block chained off           00150000
*    IUSER.USRAPPLQ.  Each AAP contains a summary of the                00160000
*    virtual session state and use in AAPFLAG1 allowing AAPs            00170000
*    to be matched to the state specified on entry.                     00180000
*                                                                       00190000
*    AAPs satisfying the given state are returned one summary           00200000
*    per call.  An end of list indicator is returned when all           00210000
*    AAPs satisfying the given state have been returned.                00220000
*                                                                       00230000
*                                                                       00240000
* LINKAGE:                                                              00250000
*                                                                       00260000
*    Invoked via the AAPSCAN macro                                      00270000
*    Standard BASR linkage                                              00280000
*    No savearea allocated                                              00290000
*                                                                       00300000
*                                                                       00310000
* ON ENTRY:                                                             00320000
*                                                                       00330000
*    R1  address of a parameter list described by PAAPSCAN              00340000
*        (AAPSCAN DSECT=YES)                                            00350000
*                                                                       00360000
*    R0  an AAP session state code as generated by AAP# DSECT=YES       00370000
*                                                                       00380000
*                                                                       00390000
* ON EXIT:                                                              00400000
*                                                                       00410000
*    R15 contains one of the following return codes                     00420000
*                                                                       00430000
*        RC00 - Request complete, AAP summary returned                  00440000
*                                                                       00450000
*               R1 contains the address of the matching AAP             00460000
*                  which must be provided (via LASTAAP=) on             00470000
*                  subsequent AAPSCAN requests                          00480000
*                                                                       00490000
*               R0 echos the address of the return vector               00500000
*                  provided via AAPSCAN RVEC=                           00510000
*                                                                       00520000
*        RC04 - No (additional) AAPs satisfy the requested state        00530000
*                                                                       00540000
*               R1 contains zero                                        00550000
*                                                                       00560000
*        RC08 - IUSER block not available                               00570000
*                                                                       00580000
*               R1 contains zero                                        00590000
*                                                                       00600000
*        RC12 - Invalid request                                         00610000
*                                                                       00620000
**<DOC-OFF>****************************************************         00630000
                                                                        00640000
         EJECT                                                          00650000
***************************************************************         00660000
*                                                                       00670000
*  Maintenance:                                                         00680000
*                                                                       00690000
*    01/12/96  R. Turgeon         Rel 2.1                               00700000
*              Initial version                                          00710000
*                                                                       00720000
***************************************************************         00730000
                                                                        00740000
         EJECT                                                          00750000
         AAPSCAN DSECT=YES        CONSTANTS, MAPPINGS                   00760000
                                                                        00770000
         EJECT                                                          00780000
         NAV   ,                  NAVIGATION BLOCKS INCLUDING AAP       00790000
                                                                        00800000
         EJECT                                                          00810000
         IUSER ,                  USER BLOCK                            00820000
                                                                        00830000
         EJECT                                                          00840000
         EQUS  ,                                                        00850000
                                                                        00860000
         EJECT                                                          00870000
IRUNAAPS #ENTER SAVE=NO,PREG=(R7)                                       00880000
                                                                        00890000
         USING ITASK,R10          STDENV                                00900000
                                                                        00910000
         EJECT                                                          00920000
***************************************************************         00930000
*                                                                       00940000
*   Locate the designated IUSER anchor block on initial call            00950000
*                                                                       00960000
***************************************************************         00970000
                                                                        00980000
         USING PAAPSCAN,R7        REQUEST LIST                          00990000
         USING AAP,R8                                                   01000000
                                                                        01010000
         L     R2,PAAPSTAT        STATE CODE                            01020000
                                                                        01030000
         ICM   R8,15,PAAPLAST     RESUMING AT SOME AAP?                 01040000
         BNZ   ADV_AAP            SCAN FORWARD FROM THAT POINT          01050000
                                                                        01060000
         ICM   R6,15,PAAPUSER     IUSER PROVIDED EXPLICITLY?            01070000
         BNZ   USER_LOC           ONWARD IF SO                          01080000
                                                                        01090000
         L     R9,TSKPCBC         CURRENT PROCESS                       01100000
         ICM   R6,15,PCBUSER-IPCB(R9)   IUSER ALLOCATED?                01110000
         BZ    WRN_USER           WARNING OTHERWISE                     01120000
                                                                        01130000
*--------------------------------------------------------------         01140000
*   First request, locate AAP chain                                     01150000
*--------------------------------------------------------------         01160000
                                                                        01170000
USER_LOC DS    0H                                                       01180000
         USING IUSER,R6           TRANSIENT                             01190000
                                                                        01200000
         ICM   R8,15,USRAPPLQ     ANY AAPS?                             01210000
         BZ    END_LIST           INDICATE END OF LIST IF NOT           01220000
         DROP  R6                 IUSER                                 01230000
                                                                        01240000
***************************************************************         01250000
*                                                                       01260000
*   Locate an AAP satisfying the requested state                        01270000
*                                                                       01280000
***************************************************************         01290000
                                                                        01300000
NEXT_AAP DS    0H                                                       01310000
         CH    R2,=AL2(AAP#SCN_ALL)                                     01320000
         BE    MATCHED            ALL AAPS                              01330000
                                                                        01340000
         TM    AAPFLAG1,AAPFRAN   DRIVEN FOR VDB OPERATION?             01350000
         BNO   RAN_AAP                                                  01360000
         CH    R2,=AL2(AAP#SCN_RAN)                                     01370000
         BE    MATCHED                                                  01380000
                                                                        01390000
RAN_AAP  DS    0H                                                       01400000
         TM    AAPFLAG1,AAPFTERM  TERMINATING?                          01410000
         BNO   TRM_AAP            SKIP IF NOT                           01420000
         CH    R2,=AL2(AAP#SCN_TERM)                                    01430000
         BE    MATCHED                                                  01440000
         B     ADV_AAP                                                  01450000
                                                                        01460000
TRM_AAP  DS    0H                                                       01470000
         TM    AAPFLAG1,AAPFUP    RUNNING?                              01480000
         BNO   ADV_AAP            SKIP IF NOT (STRANGE)                 01490000
         CH    R2,=AL2(AAP#SCN_UP)                                      01500000
         BE    MATCHED                                                  01510000
                                                                        01520000
*--------------------------------------------------------------         01530000
*   Scan all AAPs until match or end of list                            01540000
*--------------------------------------------------------------         01550000
                                                                        01560000
ADV_AAP  DS    0H                 SCAN ALL AAPS                         01570000
         ICM   R8,15,AAPNEXT      NEXT AAP                              01580000
         BNZ   NEXT_AAP           CONTINUE                              01590000
         B     END_LIST           END OF LIST                           01600000
                                                                        01610000
***************************************************************         01620000
*                                                                       01630000
*   Construct AAP summary                                               01640000
*                                                                       01650000
***************************************************************         01660000
                                                                        01670000
MATCHED  DS    0H                 TALLY COMPLETE                        01680000
         ICM   R4,15,PAAPRVEC     RETURN VECTOR                         01690000
         BZ    ERR_REQ            REQUIRED                              01700000
                                                                        01710000
         USING RVAAPSCN,R4        FORMATTED DATA AREA                   01720000
         XC    RVAAPSCN(RVAAPLN),RVAAPSCN                               01730000
         MVC   RVASTN,AAPCURR     CURRENT STN ADDRESS                   01740000
                                                                        01750000
         LA    R0,AAPANAME        EXTERNAL APPLICATION NAME             01760000
         ST    R0,RVAAPPL                                               01770000
         LA    R0,AAPCPRJ         PROJECT NAME, LAST SESS ACTIVITY      01780000
         ST    R0,RVAPRJNM                                              01790000
         LA    R0,AAPCSTNM        CURRENT SCREEN (SET) NAME             01800000
         ST    R0,RVASNAME                                              01810000
                                                                        01820000
         MVI   RVAVSESS,TRUE      ASSUME SESSION UP OR COMING UP        01830000
         TM    AAPFLAG1,AAPFTERM  TERMINATED/TERMINATING APPL?          01840000
         BNO   COMPLETE           INFORMATION ACCURATE IF NOT           01850000
                                                                        01860000
         MVI   RVAVSESS,FALSE     SESSION DOWN OR GOING DOWN            01870000
         XC    RVASTN,RVASTN      STN POINTER NO LONGER VALID           01880000
         LA    R0,=CL16'*VTAM*'   WHERE SESSION IS HEADED               01890000
         ST    R0,RVASNAME        RETURN ACCORDINGLY                    01900000
                                                                        01910000
***************************************************************         01920000
*                                                                       01930000
*   Return completion status to caller                                  01940000
*                                                                       01950000
***************************************************************         01960000
                                                                        01970000
COMPLETE DS    0H                                                       01980000
         LA    R15,RC00           INDICATE SUCCESS                      01990000
         LA    R1,AAP             RETURN MATCHED AAP                    02000000
         LA    R0,RVAAPSCN        RETURN (ECHO) RETURN VECTOR           02010000
         B     RETURN             COMPLETE                              02020000
                                                                        02030000
*--------------------------------------------------------------         02040000
*   End of AAP list encountered                                         02050000
*--------------------------------------------------------------         02060000
                                                                        02070000
END_LIST DS    0H                 END OF AAP LIST ENCOUNTERED           02080000
         LA    R15,RC04           INDICATOR                             02090000
         B     ERR_RET            COMPLETE                              02100000
                                                                        02110000
*--------------------------------------------------------------         02120000
*   IUSER block not available                                           02130000
*--------------------------------------------------------------         02140000
                                                                        02150000
WRN_USER DS    0H                 IUSER NOT AVAILABLE                   02160000
         LA    R15,RC08           WARNING                               02170000
         B     ERR_RET            COMPLETE                              02180000
                                                                        02190000
*--------------------------------------------------------------         02200000
*   Invalid request                                                     02210000
*--------------------------------------------------------------         02220000
                                                                        02230000
ERR_REQ  DS    0H                 INVALID REQUEST                       02240000
         LA    R15,RC12           ERROR                                 02250000
         B     ERR_RET            COMPLETE                              02260000
                                                                        02270000
*--------------------------------------------------------------         02280000
*   Return to caller                                                    02290000
*--------------------------------------------------------------         02300000
                                                                        02310000
ERR_RET  DS    0H                                                       02320000
         SR    R0,R0              NO RVEC UPDATES                       02330000
         SR    R1,R1              NO AAP RETURNED                       02340000
                                                                        02350000
RETURN   DS    0H                                                       02360000
                                                                        02370000
         #EXIT ,                                                        02380000
                                                                        02390000
         EJECT                                                          02400000
***************************************************************         02410000
*                                                                       02420000
*   Local read-only data areas, etc.                                    02430000
*                                                                       02440000
***************************************************************         02450000
                                                                        02460000
         LTORG ,                                                        02470000
                                                                        02480000
         EJECT                                                          02490000
         PRINT NOGEN                                                    02500000
         ICVT  ,                                                        02510000
         ITASK ,                                                        02520000
         IPCB  ,                                                        02530000
         END   ,                                                        02540000

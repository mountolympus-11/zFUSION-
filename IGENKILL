IGENKILL TITLE '- FAIL CURRENT WORKUNIT'                                00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: IGENKILL - FAIL CURRENT WORKUNIT                             00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THIS ROUTINE IS ENTERED UNDER AN IRB TO TERMINATE THE              00080000
*    CURRENT WORKUNIT.  A '$ABEND X122/X222' IS ISSUED TO               00090000
*    FORCE THE IPCB/ITASK THRU ABEND PROCESSING AND RECOVERY.           00100000
*                                                                       00110000
* NOTES:                                                                00120000
*                                                                       00130000
*    THIS CODE IS DISPATCHED OUTSIDE OF STDENV.  STDENV                 00140000
*    SERVICES, $MSG IN PARTICULAR, ARE NOT AVAILABLE.                   00150000
*                                                                       00160000
* ON ENTRY:                                                             00170000
*                                                                       00180000
*    R1  CONTAINS THE ADDRESS OF A PARAMETER LIST CONSTRUCTED           00190000
*        AS FOLLOWS:                                                    00200000
*                                                                       00210000
*        +00(4) -- NONZERO IF DUMP REQUESTED, ZERO OTHERWISE            00220000
*        +04(8) -- TASK NAME OF ITASK TO BE KILLED                      00230000
*                                                                       00240000
**<DOC-OFF>****************************************************         00250000
                                                                        00260000
         EJECT                                                          00270000
         $SERVER DSECT=YES        TASK SERVER PARAMETER LIST            00280000
                                                                        00290000
         EJECT                                                          00300000
         @EPB  ,                  EVENT PROCESS BLOCK MAPPING           00310000
                                                                        00320000
         EJECT                                                          00330000
         EQUS  ,                                                        00340000
                                                                        00350000
WORKAREA #WORK ,                                                        00360000
$SRV_MFL $SERVER MF=(L,*)         TASK SERVER PLIST AREA                00370000
WORKLEN  #ENDWORK                                                       00380000
                                                                        00390000
         ABCODES ,                $ABEND REQUEST CODES                  00400000
                                                                        00410000
         EJECT                                                          00420000
IGENKILL #ENTER SAVE=NO,PREG=R8                                         00430000
                                                                        00440000
*--------------------------------------------------------------         00450000
*   RESTORE STDENV                                                      00460000
*--------------------------------------------------------------         00470000
         @RESTENV ,               RESTORE STDENV                        00480000
                                                                        00490000
         USING ICVT,R11                                                 00500000
         USING ITASK,R10                                                00510000
                                                                        00520000
*--------------------------------------------------------------         00530000
*  IF REQUESTED TASK TO BE KILLED IS THE ACTIVE TASK, THEN              00540000
*  CONTINUE WITH THE $ABEND TO TERMINATE THE WORKUNIT.  IF              00550000
*  REQUESTED TASK IS NOT THE ACTIVE TASK, ATTEMPT TO LOCATE             00560000
*  ITASK WITHIN THE SERVER AND SET THE THE KILL-ON-NEXT-DISP            00570000
*  INDICATOR AND POST THE DISPATCHER ECB.                               00580000
*--------------------------------------------------------------         00590000
         CLC   TSKNAME,4(R8)      REQUESTED TASK ACTIVE                 00600000
         BE    ABEND              YES, CONTINUE WITH KILL               00610000
                                                                        00620000
         $GETSTOR WORKLEN,QHDR=0  ALLOCATE WORKAREA STORAGE             00630000
         ST    R1,8(,R13)         FORWARD  SAVEAREA LINKAGE             00640000
         ST    R13,4(,R1)         BACKWARD SAVEAREA LINKAGE             00650000
         LR    R13,R1             ADDRESS OF SAVEAREA                   00660000
         USING WORKAREA,R13       WORKAREA ADDRESSABILITY               00670000
                                                                        00680000
         $SERVER LOCATE,          LOCATE REQUESTED TASK TO KILL        +00690000
               TASKNAME=4(R8),                                         +00700000
               MF=(E,$SRV_MFL)                                          00710000
         BNZ   RETURN             RETURN IF NOT FOUND                   00720000
                                                                        00730000
         LR    R5,R1              ADDRESS OF REQUESTED ITASK            00740000
T        USING ITASK,R5           ADDRESSABILITY                        00750000
                                                                        00760000
         OI    T.TSKFLGS3,TSK3$KIL KILL TASK NO NEXT DISPATCH           00770000
         ICM   R0,15,0(R8)         DUMP REQUESTED?                      00780000
         BZ    *+8                 NO, CONTINUE                         00790000
         OI    T.TSKFLGS3,TSK3$DMP SET DUMP OPTION                      00800000
                                                                        00810000
         LA    R2,T.TSKDEPB       ADDRESS OF DISPATCHER EPB             00820000
         USING EPB,R2             TEMP ADDRESSABILTY                    00830000
         LA    R2,EPBECB          ADDRESS OF DISPATCHER ECB             00840000
                                                                        00850000
         POST  (R2),              POST TASK DISPATCH ECB               +00860000
               LINKAGE=SYSTEM                                           00870000
                                                                        00880000
         B     RETURN             RETURN                                00890000
                                                                        00900000
         DROP  R2,T               @EPB, ITASK                           00910000
                                                                        00920000
*--------------------------------------------------------------         00930000
*   FAIL THE WORKUNIT                                                   00940000
*--------------------------------------------------------------         00950000
ABEND    DS    0H                                                       00960000
         LA    R3,ABE_KILL_NODMP  ABEND WITHOUT DUMP                    00970000
         ICM   R2,15,0(R8)        DUMP REQUEST FLAG                     00980000
         BZ    *+8                READY IF NODUMP                       00990000
         LA    R3,ABE_KILL_DMP    ABEND WITH DUMP                       01000000
                                                                        01010000
         $ABEND (R3),DUMP=(R2),                                        +01020000
               TITLE='WORKUNIT FAILED BY OPERATOR REQUEST'              01030000
                                                                        01040000
*--------------------------------------------------------------         01050000
*   RETURN                                                              01060000
*--------------------------------------------------------------         01070000
RETURN   DS    0H                                                       01080000
         LR    R3,R13             ADDRESS OF SAVEAREA                   01090000
         L     R13,4(,R13)        ADDRESS OF CALLER'S SAVEAREA          01100000
                                                                        01110000
         $RETSTOR (R3)            RETURN WORKAREA                       01120000
                                                                        01130000
         #EXIT ,                  RETURN                                01140000
                                                                        01150000
***************************************************************         01160000
*                                                                       01170000
*   LOCAL READ/ONLY DATA AREAS                                          01180000
*                                                                       01190000
***************************************************************         01200000
         LTORG ,                                                        01210000
                                                                        01220000
         PRINT NOGEN                                                    01230000
         ICVT ,                                                         01240000
         ITASK ,                                                        01250000
         END   ,                                                        01260000

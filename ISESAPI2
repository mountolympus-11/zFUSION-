ISESAPI2 TITLE 'INTEGRATOR - VTAM SESSION SERVICES API (PART 2)'        00010000
**<DOC-ON>************************************************************* 00020000
*                                                                       00030000
* ROUTINE: ISESAPI2 - INTEGRATOR VTAM SESSION SERVICES API (PART 2)     00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*                                                                       00080000
*                                                                       00090000
*                                                                       00100000
*                                                                       00110000
* ON ENTRY:                                                             00120000
*                                                                       00130000
*    R15 = ENTRY POINT ADDRESS                                          00140000
*    R14 = RETURN ADDRESS                                               00150000
*    R13 = AVAILABLE SAVE AREA                                          00160000
*    R11 = ICVT ADDRESS                                                 00170000
*    R10 = ITASK ADDRESS                                                00180000
*    R09 = IVTAMCVT ADDRESS                                             00190000
*    R08 = ISESS ADDRESS                                                00200000
*    R07 = IVUSER ADDRESS                                               00210000
*    R06 = $SESS PARAMETER LIST ADDRESS                                 00220000
*          (SEE COMMENTS FOR SPECIFIC SERVICE BEING CALLED)             00230000
*                                                                       00240000
* ON EXIT:                                                              00250000
*                                                                       00260000
*    R15 = $SESS_RC_...                                                 00270000
*                                                                       00280000
*    R00 = $SESS_RSN_...                                                00290000
*                                                                       00300000
*    R01 = ADDRESS OF $SESS PARAMETER LIST (SPLIST)                     00310000
*                                                                       00320000
*    ALL OTHER REGISTERS ARE RESTORED                                   00330000
*                                                                       00340000
**<DOC-OFF>************************************************************ 00350000
                                                                        00360000
         EJECT ,                                                        00370000
*********************************************************************** 00380000
*                                                                       00390000
* MAINTENANCE:                                                          00400000
*                                                                       00410000
*   08/01/93 RANDY WITEK                                                00420000
*                                                                       00430000
*********************************************************************** 00440000
                                                                        00450000
         EQUS  ,                  GENERAL EQUATES                       00460000
                                                                        00470000
RICVT    EQU   R11                                                      00480000
RITASK   EQU   R10                                                      00490000
RIVTAM   EQU   R9                                                       00500000
RISESS   EQU   R8                                                       00510000
RIVUSER  EQU   R7                                                       00520000
RSPLIST  EQU   R6                                                       00530000
                                                                        00540000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00550000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00560000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00570000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00580000
         USING IVUSER,RIVUSER     ESTABLISH ADDRESSABILITY              00590000
         USING SPLIST,RSPLIST     ESTABLISH ADDRESSABILITY              00600000
                                                                        00610000
*---------------------------------------------------------------------- 00620000
*   S A V E   A N D   W O R K I N G   S T O R A G E                     00630000
*---------------------------------------------------------------------- 00640000
                                                                        00650000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00660000
LV0SAVE  DS    18F                SUBROUTINE SAVE AREA                  00670000
WRK256   DS    XL256              GENERAL WORKAREA                      00680000
RETR15   DS    F                  RETURN CODE                           00690000
RETR0    DS    F                  RETURN REGISTER 0                     00700000
RETR1    DS    F                  RETURN REGISTER 1                     00710000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00720000
FLAG     DS    X                                                        00730000
FLAGLOCK EQU   X'80'              VTAM GLOBAL LOCK HELD                 00740000
FLAGLCKD EQU   X'40'              VTAM GLOBAL LOCK HELD ON ENTRY        00750000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00760000
                                                                        00770000
*---------------------------------------------------------------------- 00780000
*   M E S S A G E   D E F A U L T S                                     00790000
*---------------------------------------------------------------------- 00800000
                                                                        00810000
         $MSGDFT PREFIX=ICTPID,COMPID='VTM',TABLE=*#MSGS,              +00820000
               PRINT=NOGEN,WORKA=0,MF=(E,WRK256)                        00830000
                                                                        00840000
*---------------------------------------------------------------------- 00850000
*   M O D U L E   E N T R Y                                             00860000
*---------------------------------------------------------------------- 00870000
                                                                        00880000
ISESAPI2 #ENTER BASE=R12,         R12 IS BASE REGISTER                 +00890000
               AMODE=31,                                               +00900000
               RMODE=ANY,                                              +00910000
               SAVE=YES,          ALLOCATE SAVE/WORK AREA              +00920000
               RESTENV=NO,        ICVT AND ITASK POINTERS ARE OK       +00930000
               WAPASS=NO,         NO WORK AREA PASSED IN R0            +00940000
               LINKAGE=STD        CALLED BY BAS/BASR                    00950000
                                                                        00960000
*---------------------------------------------------------------------- 00970000
* JUMP TO PROCESSING ROUTINE BASED ON REQUEST CODE                      00980000
*---------------------------------------------------------------------- 00990000
                                                                        01000000
         L     R1,SPLFUNC         LOAD REQUEST CODE                     01010000
         S     R1,=F'26'          FUNC-CODES IN ISESAPI2 START AT 26    01020000
         BM    RETURN4            BRANCH IF NEGATIVE                    01030000
         SLL   R1,2               MULTIPLY BY 4                         01040000
         C     R1,=A(MAXFUNC)     IS REQUEST CODE VALID?                01050000
         BNH   REQTABLE(R1)       BRANCH TO ROUTINE IF VALID            01060000
         B     RETURN4            EXIT WITH RC=4                        01070000
                                                                        01080000
REQTABLE B     ADDSESS            ADD_SESSION                           01090000
         B     DELSESS            DELETE_SESSION                        01100000
         B     FINDSESS           FIND_SESSION                          01110000
MAXFUNC  EQU   (*-REQTABLE)-4                                           01120000
                                                                        01130000
*---------------------------------------------------------------------- 01140000
* REQUEST 26 - ADD SESSION (ISESS) TO IVUSER'S CHAIN OF SESSIONS        01150000
*                                                                       01160000
* ENTRY  VALUES: R01 = ADDRESS OF $SESS SERVICES PARAMETER LIST         01170000
*                SPLFUNC  = 26                                          01180000
*                SPLTOKEN = SESSION TOKEN                               01190000
*                SPLAREA  = ADDRESS OF ISESS BLOCK                      01200000
*                                                                       01210000
* RETURN VALUES: R15 = $SESS_RC_...                                     01220000
*                R00 = $SESS_RSN_...                                    01230000
*                R01 = SPLIST ADDRESS                                   01240000
*                                                                       01250000
*---------------------------------------------------------------------- 01260000
                                                                        01270000
ADDSESS  DS    0H                                                       01280000
                                                                        01290000
         BAS   R14,VTAMLOCK                                             01300000
                                                                        01310000
         ICM   RISESS,15,SPLAREA             ADDRESS OF ISESS BLOCK     01320000
         BZ    ERRNOPRM                      BRANCH IF INVALID          01330000
         CLC   ISEID,=CL8'ISESS'             VALIDATE EYECATCHER        01340000
         BNE   ERRISESS                      BRANCH IF INVALID          01350000
         LA    R14,IVUIS1ST-(ISENEXT-ISE)    NORMALIZED HEADER ADDRESS  01360000
                                                                        01370000
ADDRUNCH DS    0H                                                       01380000
                                                                        01390000
         ICM   R14,15,ISENEXT-ISE(R14)       NEXT ISESS IN THE CHAIN    01400000
         BM    ADDTOCHN                      BRANCH IF NEW TOKEN IS HI  01410000
         CLC   ISETK(L'ISETK),ISETK-ISE(R14) COMPARE TOKENS             01420000
         BH    ADDRUNCH                      BRANCH IF NEW TOKEN HI     01430000
         BNE   ADDTOCHN                      BRANCH TO INSERT NEW ISESS 01440000
         B     ERRDUPTK                      BRANCH IF DUPLICATE TOKEN  01450000
                                                                        01460000
ADDTOCHN DS    0H                                                       01470000
                                                                        01480000
         L     R15,ISEPREV-ISE(,R14)    LINK TO PREVIOUS ISESS          01490000
         ST    RISESS,ISENEXT-ISE(,R15) LINK NEW ISESS TO PREVIOUS      01500000
         ST    RISESS,ISEPREV-ISE(,R14) LINK NEW ISESS TO NEXT          01510000
         STM   R14,R15,ISENEXT          SET NEXT/PREV IN NEW ISESS      01520000
                                                                        01530000
         L     R1,IVU#SESS              CURRENT NUMBER OF ISESS'S       01540000
         A     R1,=F'1'                 BUMP IT BY ONE                  01550000
         ST    R1,IVU#SESS              SAVE THE UPDATED ISESS COUNT    01560000
                                                                        01570000
         B     RETURN                   RETURN TO CALLER                01580000
                                                                        01590000
*---------------------------------------------------------------------- 01600000
* REQUEST 27 - DELETE SESSION (ISESS) FROM IVUSER'S CHAIN OF SESSIONS   01610000
*                                                                       01620000
* ENTRY  VALUES: R01 = ADDRESS OF $SESS SERVICES PARAMETER LIST         01630000
*                SPLFUNC  = 27                                          01640000
*                SPLTOKEN = SESSION TOKEN                               01650000
*                                                                       01660000
* RETURN VALUES: R15 = $SESS_RC_...                                     01670000
*                R00 = $SESS_RSN_...                                    01680000
*                R01 = SPLIST ADDRESS                                   01690000
*                                                                       01700000
*---------------------------------------------------------------------- 01710000
                                                                        01720000
DELSESS  DS    0H                                                       01730000
                                                                        01740000
         BAS   R14,VTAMLOCK                                             01750000
                                                                        01760000
         LM    R1,R2,ISENEXT        NEXT/PREV ISESS'S ON SAME IVUSER    01770000
         ST    R2,ISEPREV-ISE(,R1)  REMOVE ISESS FROM QUEUE             01780000
         ST    R1,ISENEXT-ISE(,R2)  REMOVE ISESS FROM QUEUE             01790000
                                                                        01800000
         L     R1,IVU#SESS          CURRENT NUMBER OF ISESS'S           01810000
         S     R1,=F'1'             DECREMENT BY ONE                    01820000
         ST    R1,IVU#SESS          SAVE THE UPDATED ISESS COUNT        01830000
         BM    ERRSESS              BRANCH IF COUNT WORD IS BAD         01840000
                                                                        01850000
         B     RETURN                  RETURN TO CALLER                 01860000
                                                                        01870000
*---------------------------------------------------------------------- 01880000
* REQUEST 28 - FIND SESSION                                             01890000
*                                                                       01900000
* ENTRY  VALUES: R01 = ADDRESS OF $SESS SERVICES PARAMETER LIST         01910000
*                SPLFUNC  = 28                                          01920000
*                SPLTOKEN = SESSION TOKEN                               01930000
*                                                                       01940000
* RETURN VALUES: R15 = $SESS_RC_...                                     01950000
*                R00 = $SESS_RSN_...                                    01960000
*                R01 = SPLIST ADDRESS                                   01970000
*                SPLAREA  = ADDRESS OF ISESS BLOCK IF FOUND             01980000
*                                                                       01990000
*---------------------------------------------------------------------- 02000000
                                                                        02010000
FINDSESS DS    0H                                                       02020000
                                                                        02030000
         BAS   R14,VTAMLOCK                                             02040000
                                                                        02050000
         OC    SPLTOKEN,SPLTOKEN             TOKEN PROVIDED?            02060000
         BZ    ERRTOKEN                      BRANCH IF INVALID          02070000
                                                                        02080000
         $VTAM FINDUSER,                                               +02090000
               AREA=SPLTOKEN,                                          +02100000
               MF=(E,MFE_LIST)               LOCATE THE IVUSER BLOCK    02110000
                                                                        02120000
         LTR   R15,R15                       IVUSER FOUND?              02130000
         BNZ   ERRTOKEN                      BRANCH IF NOT              02140000
         LR    RIVUSER,R1                    WE HAVE THE IVUSER         02150000
         CLC   IVUID,=CL8'IVUSER'            VALIDATE EYECATCHER        02160000
         BNE   ERRTOKEN                      BRANCH IF INVALID          02170000
         LA    RISESS,IVUIS1ST-(ISENEXT-ISE) NORMALIZED HDR ADDR        02180000
                                                                        02190000
FINDSRUN DS    0H                                                       02200000
                                                                        02210000
         ICM   RISESS,15,ISENEXT             NEXT ISESS IN THE CHAIN    02220000
         BM    ERRTOKEN                      BRANCH IF END OF CHAIN     02230000
         CLC   SPLTOKEN(L'ISETK),ISETK       COMPARE TOKENS             02240000
         BH    FINDSRUN                      BRANCH IF ARGUMENT IS HI   02250000
         BNE   ERRTOKEN                      BRANCH IF ARGUMENT IS LO   02260000
         ST    RISESS,SPLAREA                RETURN THE ISESS ADDRESS   02270000
         B     RETURN                        RETURN TO CALLER           02280000
                                                                        02290000
*---------------------------------------------------------------------- 02300000
*   SET RETURN CODE OF 8: ENVIRONMENT W/REASON CODE INVALID TOKEN       02310000
*---------------------------------------------------------------------- 02320000
                                                                        02330000
ERRTOKEN DS    0H                                                       02340000
                                                                        02350000
         MVC   SPLRSNCD,=A($SESS_RSN_TOKEN)                             02360000
         B     RETURN8                                                  02370000
                                                                        02380000
*---------------------------------------------------------------------- 02390000
*   SET RETURN CODE OF 8: ENVIRONMENT W/REASON CODE DUPLICATE TOKEN     02400000
*---------------------------------------------------------------------- 02410000
                                                                        02420000
ERRDUPTK DS    0H                                                       02430000
                                                                        02440000
         MVC   SPLRSNCD,=A($SESS_RSN_DUPLICATE_TOKEN)                   02450000
         B     RETURN8                                                  02460000
                                                                        02470000
*---------------------------------------------------------------------- 02480000
*   SET RETURN CODE OF 8: ENVIRONMENT W/REASON CODE INVALID ISESS       02490000
*---------------------------------------------------------------------- 02500000
                                                                        02510000
ERRISESS DS    0H                                                       02520000
                                                                        02530000
         MVC   SPLRSNCD,=A($SESS_RSN_ISESS)                             02540000
         B     RETURN8                                                  02550000
                                                                        02560000
*---------------------------------------------------------------------- 02570000
*   SET RETURN CODE OF 4: FUNCTION W/REASON CODE MISSING PARAMETER      02580000
*---------------------------------------------------------------------- 02590000
                                                                        02600000
ERRNOPRM DS    0H                                                       02610000
                                                                        02620000
         MVC   SPLRSNCD,=A($SESS_RSN_MISSING_PARM)                      02630000
         B     RETURN4                                                  02640000
                                                                        02650000
*---------------------------------------------------------------------- 02660000
*   SET RETURN CODE OF 8: ENVIRONMENT ERROR                             02670000
*---------------------------------------------------------------------- 02680000
                                                                        02690000
RETURN8  DS    0H                                                       02700000
                                                                        02710000
         MVC   SPLRETCD,=A($SESS_RC_ENVIRONMENT)                        02720000
         B     RETURN                                                   02730000
                                                                        02740000
*---------------------------------------------------------------------- 02750000
*   SET RETURN CODE OF 4: FUNCTION CODE ERROR                           02760000
*---------------------------------------------------------------------- 02770000
                                                                        02780000
RETURN4  DS    0H                                                       02790000
                                                                        02800000
         MVC   SPLRETCD,=A($SESS_RC_FUNCTION)                           02810000
         B     RETURN                                                   02820000
                                                                        02830000
*---------------------------------------------------------------------- 02840000
*   R E T U R N   T O   C A L L E R                                     02850000
*---------------------------------------------------------------------- 02860000
                                                                        02870000
RETURN   DS    0H                                                       02880000
                                                                        02890000
         BAS   R14,VTAMUNLK         RELEASE THE LOCK IF IT IS HELD      02900000
                                                                        02910000
         ST    RSPLIST,RETR1        RETURN SPLIST ADDRESS IN R1         02920000
         MVC   RETR15,SPLRETCD      $SESS_RC_...                        02930000
         MVC   RETR0,SPLRSNCD       $SESS_RSN_...                       02940000
         LM    R15,R1,RETREGS       LOAD RETURN REGISTERS               02950000
                                                                        02960000
         #EXIT R1=YES               RETURN W/R15,R0,R1                  02970000
                                                                        02980000
*---------------------------------------------------------------------- 02990000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 03000000
*---------------------------------------------------------------------- 03010000
                                                                        03020000
VTAMLOCK DS    0H                                                       03030000
                                                                        03040000
         TM    FLAG,FLAGLOCK        WAS THE LOCK ALREADY OBTAINED?      03050000
         BOR   R14                  RETURN IF YES                       03060000
         STM   R14,R2,LV0SAVE       SAVE CALLER'S REGISTERS             03070000
                                                                        03080000
         $SER  OBTAIN,                                                 +03090000
               VTAM                                                     03100000
                                                                        03110000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              03120000
         BNE   VTAMLOEX             BRANCH IF NOT                       03130000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         03140000
                                                                        03150000
VTAMLOEX DS    0H                                                       03160000
                                                                        03170000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               03180000
         LM    R14,R2,LV0SAVE       RESTORE CALLER'S REGISTERS          03190000
         BR    R14                  RETURN                              03200000
                                                                        03210000
*---------------------------------------------------------------------- 03220000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                03230000
*---------------------------------------------------------------------- 03240000
                                                                        03250000
VTAMUNLK DS    0H                                                       03260000
                                                                        03270000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       03280000
         BNOR  R14                  BRANCH IF NOT                       03290000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             03300000
         BOR   R14                  DON'T RELEASE IF IT WAS             03310000
         STM   R14,R2,LV0SAVE       SAVE CALLER'S REGISTERS             03320000
                                                                        03330000
         $SER  RELEASE,                                                +03340000
               VTAM                                                     03350000
                                                                        03360000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  03370000
         LM    R14,R2,LV0SAVE       RESTORE CALLER'S REGISTERS          03380000
         BR    R14                  RETURN                              03390000
                                                                        03400000
*---------------------------------------------------------------------- 03410000
*   E R R O R   R O U T I N E S                                         03420000
*---------------------------------------------------------------------- 03430000
                                                                        03440000
ERRSESS  DS    0H                                                       03450000
                                                                        03460000
         $ABEND ABE_VTDIAG,                                            +03470000
               SCOPE=PCB,                                              +03480000
               TITLE='INVALID ISESS DETECTED'                           03490000
                                                                        03500000
*---------------------------------------------------------------------- 03510000
*   C O N S T A N T S   A N D   L I T E R A L S                         03520000
*---------------------------------------------------------------------- 03530000
                                                                        03540000
         LTORG ,                                                        03550000
                                                                        03560000
*---------------------------------------------------------------------- 03570000
*   D S E C T S                                                         03580000
*---------------------------------------------------------------------- 03590000
                                                                        03600000
         PRINT NOGEN                                                    03610000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                03620000
         ISTDBIND ,               VTAM BIND IMAGE                       03630000
         ISTRH ,                  VTAM SNA REQUEST HEADER               03640000
         ICVT  ,                  INTEGRATOR CVT                        03650000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   03660000
         ITASK ,                  INTEGRATOR TASK BLOCK                 03670000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            03680000
         IACB ,                   INTEGRATOR VTAM ACB+                  03690000
         IRPL ,                   INTEGRATOR VTAM RPL+                  03700000
         INIB ,                   INTEGRATOR VTAM NIB+                  03710000
         ISESS ,                  INTEGRATOR SESSION CONTROL            03720000
         IRQE ,                   INTEGRATOR RECEIVE QUEUE ELEMENT      03730000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENTS         03740000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       03750000
         EVCODES ,                INTEGRATOR EVENT CODES                03760000
         ABCODES ,                INTEGRATOR $ABEND CODES               03770000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     03780000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             03790000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             03800000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             03810000
         IFGEXLST ,               VTAM EXIT LIST                        03820000
         END   ,                                                        03830000

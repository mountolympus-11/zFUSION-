IL62ADRC TITLE 'INTEGRATOR - LU6.2 DEFINE RESOURCE_CONTROL_BLOCK'       00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: IL62ADRC - LU6.2 DEFINE RESOURCE_CONTROL_BLOCK               00100000
*                                                                       00110000
* DESCRIPTION:                                                          00120000
*                                                                       00130000
*    THIS ROUTINE IS CALLED TO CREATE A RESOURCE_CONTROL_BLOCK          00140000
*    (RCB) ON BEHALF OF THE CURRENT PROCESS.                            00150000
*                                                                       00160000
* ON ENTRY:                                                             00170000
*                                                                       00180000
*    R15 = ENTRY POINT ADDRESS                                          00190000
*    R14 = RETURN      ADDRESS                                          00200000
*    R13 = SAVE AREA   ADDRESS                                          00210000
*    R01 = PARM LIST   ADDRESS                                          00220000
*                                                                       00230000
*          +00 = ADDRESS OF RCB RETURN AREA                             00240000
*          +04 = ADDRESS OF RETURN CODE AREA                            00250000
*                                                                       00260000
* ON EXIT:                                                              00270000
*                                                                       00280000
*    R15 = 0                                                            00290000
*                                                                       00300000
*    RETURN_CODE = LU62_OK --> RCB SUCCESSFULLY ALLOCATED               00310000
*                                                                       00320000
*                = LU62_PRODUCT_SPECIFIC_ERROR --> NO CURRENT IPCB      00330000
*                = LU62_PRODUCT_SPECIFIC_ERROR --> DEFINE TKB FAILED    00340000
*                                                                       00350000
**<DOC-OFF>************************************************************ 00360000
         EJECT ,                                                        00370000
*********************************************************************** 00380000
*                                                                       00390000
* MAINTENANCE:                                                          00400000
*                                                                       00410000
*   07/01/94 RANDY WITEK                                                00420000
*   10/26/95 RANDY WITEK - FIX MVS LEVEL-DEPENDENT TIME USAGE           00430000
*                                                                       00440000
*********************************************************************** 00450000
                                                                        00460000
         EQUS  ,                  GENERAL EQUATES                       00470000
                                                                        00480000
RICVT    EQU   R11                                                      00490000
RITASK   EQU   R10                                                      00500000
RBASE    EQU   R9                                                       00510000
RIVTAM   EQU   R8                                                       00520000
RPLIST   EQU   R7                                                       00530000
RTKB     EQU   R6                                                       00540000
RIPCB    EQU   R5                                                       00550000
RRCB     EQU   R4                                                       00560000
                                                                        00570000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00580000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00590000
         USING L62LIST,RPLIST     ESTABLISH ADDRESSABILITY              00600000
         USING TKB,RTKB           ESTABLISH ADDRESSABILITY              00610000
         USING IPCB,RIPCB         ESTABLISH ADDRESSABILITY              00620000
         USING RCB,RRCB           ESTABLISH ADDRESSABILITY              00630000
                                                                        00640000
         COPY  CRAB               "C" RUNTIME ANCHOR BLOCK              00650000
         USING CRAB,R12           ADDRESSABILITY                        00660000
                                                                        00670000
         COPY  DSA                DYNAMIC SAVE AREA                     00680000
WORKAREA DS    0H                 READ/WRITE WORKAREA                   00690000
WRK256   DS    XL256              GENERAL WORKAREA                      00700000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00710000
L62PLIST L62DFTK MF=L             PARM LIST AREA                        00720000
L62RETCD DS    F                  LU62DFTK RETURN CODE AREA             00730000
RETCODE  DS    F                  TEMPORARY RETURN CODE AREA            00740000
FLAG     DS    X                                                        00750000
WORKLEN  EQU   *-WORKAREA         LENGTH OF USER DSA AREA               00760000
DSALEN   EQU   *-DSA              LENGTH OF DSA                         00770000
                                                                        00780000
         $MSGDFT PREFIX=ICTPID,                                        +00790000
               COMPID='L62',                                           +00800000
               TABLE=*#MSGS,                                           +00810000
               WORKA=0,                                                +00820000
               MF=(E,WRK256),                                          +00830000
               PRINT=NOGEN                                              00840000
                                                                        00850000
IL6ADRC@ CSECT ,                                                        00860000
IL62ADRC CENTRY DSA=DSALEN,BASE=RBASE,INDEP=YES                         00870000
                                                                        00880000
         USING DSA,R13            ADDRESSABILITY                        00890000
         LR    RPLIST,R1          SAVE ADDRESS OF PLIST                 00900000
                                                                        00910000
         LA    R0,WORKAREA        ADDRESS OF USER DSA SECTION           00920000
         LA    R1,WORKLEN         LENGTH  OF USER DSA SECTION           00930000
         SR    R15,R15            PREPARE FOR CLEAR                     00940000
         MVCL  R0,R14             CLEAR USER DSA SECTION                00950000
                                                                        00960000
*---------------------------------------------------------------------- 00970000
* INITIALIZATION                                                        00980000
*---------------------------------------------------------------------- 00990000
                                                                        01000000
         @RESTENV ,               ENSURE ENVIRONMENT                    01010000
                                                                        01020000
         L     RIVTAM,ICTVTCVT    ESTABLISH IVTAMCVT POINTER            01030000
         USING IVTAMCVT,RIVTAM    ADDRESSABILITY                        01040000
                                                                        01050000
*---------------------------------------------------------------------- 01060000
* ENTRY TRACE                                                           01070000
*---------------------------------------------------------------------- 01080000
                                                                        01090000
         $TRACE *=A(TRC_LU62_IL62ADRC),32 TRACE ENTRY W/ 32 USER BYTES  01100000
         BNZ   NOETRACE                   BRANCH IF NOT TRACING         01110000
         $APITRC IL62ADRC                 TRACE COMMON STUFF            01120000
         ST    RPLIST,24(,R1)             TRACE PARMLIST ADDRESS        01130000
NOETRACE DS    0H                                                       01140000
                                                                        01150000
*---------------------------------------------------------------------- 01160000
* LOCATE THE TKB FOR THIS TRANSACTION PROGRAM                           01170000
*---------------------------------------------------------------------- 01180000
                                                                        01190000
         ICM   RIPCB,15,TSKPCBC   ACCESS CURRENT IPCB                   01200000
         BZ    ERRPROD            BRANCH IF NOT FOUND                   01210000
         ICM   RTKB,15,PCBIVTAM   ACCESS THE TKB                        01220000
         BNZ   GETRCB             BRANCH IF IT ALREADY EXISTS           01230000
                                                                        01240000
*---------------------------------------------------------------------- 01250000
* CREATE A TKB FOR THIS PROCESS                                         01260000
*---------------------------------------------------------------------- 01270000
                                                                        01280000
         L62DFTK DEFNAME,         TPN                                  +01290000
               DEFNAMEL,          TPN LENGTH                           +01300000
               L62RETCD,          RETURN CODE AREA                     +01310000
               MF=(E,L62PLIST)                                          01320000
                                                                        01330000
         ICM   R15,15,L62RETCD    SUCCESSFUL CALL?                      01340000
         BNZ   ERRPROD            BRANCH IF NOT                         01350000
         ICM   RTKB,15,PCBIVTAM   ACCESS THE TKB                        01360000
         BZ    ERRPROD            BRANCH IF IT IS NOT THERE!!!          01370000
                                                                        01380000
*---------------------------------------------------------------------- 01390000
* ALLOCATE A RESOURCE_CONTROL_BLOCK                                     01400000
*---------------------------------------------------------------------- 01410000
                                                                        01420000
GETRCB   DS    0H                                                       01430000
                                                                        01440000
         LA    R3,L'RCBMAX        ALLOCATE A RCB                        01450000
                                                                        01460000
         $GETSTOR (R3),                                                +01470000
               LOC=ANY,                                                +01480000
               OWNER=(RIPCB)      RCB ALLOCATED IN CURRENT PROCESS      01490000
                                                                        01500000
         LR    RRCB,R1            ESTABLISH ADDRESSABILITY              01510000
         MVC   RCBID,=CL8'RCB'    SET EYECATCHER                        01520000
         ST    R3,RCBLEN          SET THE LENGTH                        01530000
                                                                        01540000
*---------------------------------------------------------------------- 01550000
* INITIALIZE THE RCB FIELDS                                             01560000
*---------------------------------------------------------------------- 01570000
                                                                        01580000
         MVC   RCBENT,TKBTCBID          SET ENTITY TOKEN                01590000
         ST    RRCB,RCBCNVID            SET THE CONV ID                 01600000
         ST    RRCB,RCBCNVID+4          SET THE CONV ID                 01610000
         ST    RTKB,RCBTKBID            SET THE TCB ID                  01620000
         MVC   RCBTPNM,=CL64' '                                         01630000
         MVC   RCBLUNM,=CL17' '                                         01640000
         MVC   RCBMDNM,=CL8' '                                          01650000
                                                                        01660000
         L     R14,TKBRC1ST             1ST RCB IN RESOURCES_LIST       01670000
         L     R15,RCBPREV-RCB(,R14)    RCB PRECEDING THAT ONE          01680000
         ST    RRCB,RCBPREV-RCB(,R14)   NEW RCB IS PREV                 01690000
         ST    RRCB,RCBNEXT-RCB(,R15)   NEW RCB IS NEXT                 01700000
         STM   R14,R15,RCBNEXT          LINK NEW RCB INTO LIST          01710000
                                                                        01720000
*---------------------------------------------------------------------- 01730000
* GET START TIME AND DATE                                               01740000
*---------------------------------------------------------------------- 01750000
                                                                        01760000
         BAS   R14,GETTIME        GET THE CURRENT TIME/DATE             01770000
         ST    R0,RCBSTIME        SET TRAN START TIME                   01780000
         ST    R1,RCBSDATE        SET TRAN START DATE                   01790000
                                                                        01800000
*---------------------------------------------------------------------- 01810000
* ISSUE DIAGNOSTIC MESSAGE IF 'VTAMTRACE' IS ACTIVE                     01820000
*---------------------------------------------------------------------- 01830000
                                                                        01840000
         $MSG  997,                     "CONV START....'               +01850000
               FIELDS=((RTKB),          TKB ADDRESS                    +01860000
               (RRCB),                  RCB ADDRESS                    +01870000
               (TSKNAME,8),             ITASK NAME                     +01880000
               (RITASK),                ITASK ADDRESS                  +01890000
               (PCBNAME,8),             IPCB  NAME                     +01900000
               (RIPCB),                 IPCB  ADDRESS                  +01910000
               (RCBCNVID,4),            CONVERSATION ID                +01920000
               (RCBCNVID+4,4),          CONVERSATION ID                +01930000
               (TKBTPN,64))             TP NAME                         01940000
                                                                        01950000
         B     RETURN                                                   01960000
                                                                        01970000
*---------------------------------------------------------------------- 01980000
* EXCEPTION ROUTINES                                                    01990000
*---------------------------------------------------------------------- 02000000
                                                                        02010000
ERRPROD  DS    0H                                                       02020000
                                                                        02030000
         MVC   RETCODE,=A(LU62_PRODUCT_SPECIFIC_ERROR)                  02040000
         B     ERRCOMM                                                  02050000
                                                                        02060000
ERRCOMM  DS    0H                                                       02070000
                                                                        02080000
         SR    RRCB,RRCB          ENSURE NO RCB POINTER                 02090000
         B     RETURN                                                   02100000
                                                                        02110000
*---------------------------------------------------------------------- 02120000
* EXIT TRACE AND RETURN TO CALLER                                       02130000
*---------------------------------------------------------------------- 02140000
                                                                        02150000
RETURN   DS    0H                                                       02160000
                                                                        02170000
         $TRACE *=A(TRC_LU62_EXIT),16 TRACE ENTRY W/ 16 USER BYTES      02180000
         BNZ   NOXTRACE               BRANCH IF TRACING NOT AVAILABLE   02190000
         MVC   0(8,R1),=CL8'IL62ADRC' MODULE NAME                       02200000
         MVC   8(4,R1),RETCODE        RETURN_CODE VALUE                 02210000
         ST    RRCB,12(,R1)           RCB ADDRESS                       02220000
NOXTRACE DS    0H                                                       02230000
                                                                        02240000
         L     R1,L62PARM2        ADDRESS OF RETURN_CODE AREA           02250000
         MVC   0(4,R1),RETCODE    SET RETURN_CODE VARIABLE              02260000
                                                                        02270000
         L     R1,L62PARM1        ADDRESS OF RCB RETURN AREA            02280000
         ST    RRCB,0(,R1)        SET RCB ADDRESS                       02290000
                                                                        02300000
         SR    R15,R15            FUNCTION RETURN CODE = 0              02310000
         CEXIT RC=(R15),INDEP=YES RETURN                                02320000
                                                                        02330000
*---------------------------------------------------------------------- 02340000
*                                                                       02350000
* ROUTINE: GETTIME - OBTAIN THE CURRENT TIME/DATE                       02360000
*                                                                       02370000
* DESCRIPTION:                                                          02380000
*                                                                       02390000
*    THIS ROUTINE CALLS THE MVS TIME SERVICE FOR CURRENT TIME/DATE.     02400000
*                                                                       02410000
* ENTRY:   N/A                                                          02420000
*                                                                       02430000
* EXIT:    ALL REGISTERS ARE RESTORED EXCEPT:                           02440000
*          R0 = TIME(4) = HHMMSSTH                                      02450000
*          R1 = DATE(4) = 0DDDYYYY                                      02460000
*---------------------------------------------------------------------- 02470000
                                                                        02480000
GETTIME  DS    0H                                                       02490000
                                                                        02500000
         STM   R0,R15,SUB0SAVE    SAVE CALLER'S REGISTERS               02510000
                                                                        02520000
         TIME  DEC,                                                    +02530000
               LINKAGE=SVC        R0=HHMMSSTH R1=0CYYDDDF               02540000
                                                                        02550000
         LR    R2,R1              R2=0CYYDDDF                           02560000
         SRL   R1,4               R1=00CYYDDD                           02570000
         SLL   R1,20              R1=DDD00000                           02580000
         SRL   R1,4               R1=0DDD0000                           02590000
         SRL   R2,16              R2=00000CYY                           02600000
         C     R2,=X'000000FF'    IS THIS 20TH CENTURY?                 02610000
         BNH   GET20TH            BRANCH IF YES                         02620000
         ICM   R2,B'0010',=X'20'  SET 21ST CENTURY                      02630000
         B     GETBOTH            NOW COMBINE DAY AND YEAR              02640000
                                                                        02650000
GET20TH  DS    0H                                                       02660000
                                                                        02670000
         ICM   R2,B'0010',=X'19'  SET 20TH CENTURY                      02680000
                                                                        02690000
GETBOTH  DS    0H                                                       02700000
                                                                        02710000
         OR    R1,R2              R1=0DDDYYYY                           02720000
                                                                        02730000
         LM    R2,R15,SUB0SAVE+8  RESTORE CALLER'S REGISTERS            02740000
         BR    R14                RETURN                                02750000
                                                                        02760000
*---------------------------------------------------------------------- 02770000
* LITERALS AND CONSTANTS                                                02780000
*---------------------------------------------------------------------- 02790000
                                                                        02800000
DEFNAME  DC    C'*LOCALLY INITIATED*'                                   02810000
DEFNAMEL DC    A(L'DEFNAME)                                             02820000
                                                                        02830000
         LTORG ,                                                        02840000
                                                                        02850000
         PRINT NOGEN                                                    02860000
         ISTDBIND ,               VTAM BIND IMAGE                       02870000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                02880000
         IKJTCB ,                 MVS TASK CONTROL BLOCK                02890000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         02900000
         ICVT  ,                  INTEGRATOR CVT                        02910000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   02920000
         ITASK ,                  INTEGRATOR TASK BLOCK                 02930000
         IPCB ,                   INTEGRATOR PROCESS BLOCK              02940000
         ABCODES ,                INTEGRATOR $ABEND CODES               02950000
         EVCODES ,                INTEGRATOR EVENT CODES                02960000
         $RESMGR DSECT=YES        INTEGRATOR $RESMGR SERVICES           02970000
         END   ,                                                        02980000

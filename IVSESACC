IVSESACC TITLE '- ACQUIRE AND AUTHORIZE ACCESS TO APPLICATION'          00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: IVSESACC - Acquire and authorize access to appl              00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine provides common preparation logic for                 00080000
*    establishing a session with a named application.                   00090000
*                                                                       00100000
*    First, access to the application is verified via $SAF.             00110000
*    Violation messages produced by the security product, if            00120000
*    any, are returned in the message buffer provided by the            00130000
*    caller.                                                            00140000
*                                                                       00150000
*    If access is permitted, the application definition is              00160000
*    retrieved from SYSAPPLS and placed in the return area              00170000
*    provided by the caller.  If the application record is              00180000
*    not found, the application is not defined.                         00190000
*                                                                       00200000
*    Finally, a SLU handle is acquired from ITASK storage               00210000
*    and initialized with data extracted from the SYSAPPLS              00220000
*    record.  Specifically,                                             00230000
*                                                                       00240000
*       SLHID     - SLUHANDL eyecatcher                                 00250000
*       SLHXAPID  - external application name                           00260000
*       SLHAPPL   - VTAM application name                               00270000
*       SLHLOGMD  - logmode                                             00280000
*                                                                       00290000
*    Completion of the SLU handle and the eventual STGRETN              00300000
*    of the block (STGRETN QH=TSKSTG) is the callers                    00310000
*    responsibility.                                                    00320000
*                                                                       00330000
*                                                                       00340000
* ON ENTRY:                                                             00350000
*                                                                       00360000
*    R1  contains the address of a parameter list described             00370000
*        by VSESACCP                                                    00380000
*                                                                       00390000
*                                                                       00400000
* ON EXIT:                                                              00410000
*                                                                       00420000
*    R15 contains one of the following return codes                     00430000
*                                                                       00440000
*        RC00 - application access validated                            00450000
*                                                                       00460000
*               R1 - SLUHANDL origin (STGGET QH=TSKSTG)                 00470000
*                                                                       00480000
*        RC04 - application not defined - INTVSE004E                    00490000
*               message returned                                        00500000
*                                                                       00510000
*        RC08 - application access denied by $SAF                       00520000
*                                                                       00530000
*               R0 - security system return code                        00540000
*               R1 - security system reason code                        00550000
*                                                                       00560000
* MESSAGES:                                                             00570000
*                                                                       00580000
*    004 - Application is not defined                                   00590000
*                                                                       00600000
**<DOC-OFF>****************************************************         00610000
                                                                        00620000
         EJECT                                                          00630000
***************************************************************         00640000
*                                                                       00650000
* MAINTENANCE:                                                          00660000
*                                                                       00670000
*    04/20/95 R. Turgeon                                                00680000
*             Initial version                                           00690000
*                                                                       00700000
***************************************************************         00710000
                                                                        00720000
         EJECT                                                          00730000
         VSESACCP ,               OUR PARAMETER LIST                    00740000
                                                                        00750000
         EJECT                                                          00760000
         $SAF  DSECT=YES          SAF VALIDATION                        00770000
                                                                        00780000
         EJECT                                                          00790000
         SLUHANDL ,               APPLICATION SESSION HANDLE            00800000
                                                                        00810000
         EJECT                                                          00820000
         ICATALOG APPLS           SYSTEM CATALOG TABLES                 00830000
                                                                        00840000
         TBSERVIS EXIST           TABLE SERVICES                        00850000
                                                                        00860000
         EJECT                                                          00870000
         ABCODES ,                                                      00880000
                                                                        00890000
         EQUS  ,                                                        00900000
                                                                        00910000
         $MSGDFT PREFIX=ICTPID,COMPID='VSE',TABLE=*#MSGS,              X00920000
               CONID=*ICTCONID,CONNAME=ICTCONNM,                       X00930000
               PRINT=NOGEN,MF=(E,$MSGMFL)                               00940000
                                                                        00950000
         EJECT                                                          00960000
         #WORK ,                                                        00970000
                                                                        00980000
@SLUHNDL DS    A                  ADDR OF ALLOCATED SLUHANDL            00990000
APPLNAME DS    CL16               EXTERNAL APPLICATION NAME PROVIDED    01000000
                                                                        01010000
$SAFMFL  $SAF  MF=(L,*)           $SAF PLIST CONSTRUCTION AREA          01020000
$MSGMFL  $MSG  MF=(L,*),FIELDS=(,,,,)                                   01030000
                                                                        01040000
         #ENDWORK ,                                                     01050000
                                                                        01060000
         EJECT                                                          01070000
IVSESACC #ENTER PREG=R8                                                 01080000
                                                                        01090000
         USING ITASK,R10          STDENV                                01100000
                                                                        01110000
         EJECT                                                          01120000
***************************************************************         01130000
*                                                                       01140000
*   GENERAL INITIALIZATION                                              01150000
*                                                                       01160000
***************************************************************         01170000
                                                                        01180000
         USING VSESACCP,R8        PARAMETER LIST, LIFE OF FUNCTION      01190000
                                                                        01200000
         L     R2,VSACAPPL        LOCATE EXTERNAL APPLICATION NAME      01210000
         MVC   APPLNAME,0(R2)     CREATE A LOCAL COPY                   01220000
                                                                        01230000
***************************************************************         01240000
*                                                                       01250000
*   RESOURCE (APPL) ACCESS TEST                                         01260000
*                                                                       01270000
***************************************************************         01280000
                                                                        01290000
         $SAF  RESCHK,            AUTH CHECK                           X01300000
               CLASS='APPL',      APPL ACCESS                          X01310000
               ENTITY=APPLNAME,                                        X01320000
               ACCESS=READ,                                            X01330000
               MSGAREA=*VSACMSGB,                                      X01340000
               MSGLEN=*VSACMSGL,                                       X01350000
               MF=(E,$SAFMFL)                                           01360000
                                                                        01370000
         CH    R15,=AL2(RC04)     ACCESS ALLOWED?                       01380000
         BH    ERR_VIO            TERMINATE IF NOT                      01390000
                                                                        01400000
***************************************************************         01410000
*                                                                       01420000
*   ACQUIRE APPLICATION DEFINITION FROM SYSAPPLS                        01430000
*                                                                       01440000
***************************************************************         01450000
                                                                        01460000
         L     R7,VSACARET        SYSAPPLS ROW RETURN AREA              01470000
         USING SYSAPPLS,R7        WORKAREA PREVIOUSLY CLEARED           01480000
         XC    SYSAPPLS(SYSAPLSN),SYSAPLSN                              01490000
         MVC   SAPLNAME,APPLNAME  REQUESTED APPL IS SYSAPPLS ROW KEY    01500000
                                                                        01510000
         TBEXIST SYSAPPLS,        ROW RETURN                           X01520000
               KEYROW=SYSAPPLS,                                        X01530000
               INDEX='PRIMARY',                                        X01540000
               TTOKEN=ICTSAPPL,                                        X01550000
               MF=(E,MFE_LIST)                                          01560000
                                                                        01570000
         CH    R15,=AL2(RC04)     TEST COMPLETION STATUS                01580000
         BE    ERR_APPL           APPL NOT DEFINED                      01590000
         BH    ABN_TBSV           TABLE SERVICES FAILURE                01600000
                                                                        01610000
***************************************************************         01620000
*                                                                       01630000
*   ACQUIRE AND PARTIALLY INITIALIZE A SLU HANDLE                       01640000
*                                                                       01650000
***************************************************************         01660000
                                                                        01670000
         STGGET SLHLN,QH=TSKSTG   ACQUIRE STG FOR SESSION HANDLE        01680000
         BZ    *+8                ASSERT STORAGE AVAILABLE              01690000
         EX    R0,*               ASSERTION DENIED                      01700000
                                                                        01710000
         LR    R5,R1              ALLOCATED STORAGE                     01720000
         ST    R5,@SLUHNDL        RETAIN FOR RETURN                     01730000
         USING SLUHANDL,R5        TYPE CAST                             01740000
                                                                        01750000
         MVC   SLHID,=CL8'SLUHANDL'                                     01760000
         MVC   SLHXAPID,APPLNAME  EXTERNAL APPLICATION ID               01770000
         MVC   SLHAPPL,SAPVTNAM   VTAM APPLICATION NAME                 01780000
         MVC   SLHLOGMD,SAPLOGMD  USE LOGMODE FROM APPL RECORD          01790000
         DROP  R5                 SLUHANDL                              01800000
                                                                        01810000
         EJECT                                                          01820000
***************************************************************         01830000
*                                                                       01840000
*   RETURN COMPLETION STATUS / SLU HANDLE TO REQUESTER                  01850000
*                                                                       01860000
***************************************************************         01870000
                                                                        01880000
         LA    R15,RC00           SUCCESSFUL COMPLETION                 01890000
         SR    R0,R0              REASON CODES NOT DEFINED              01900000
         L     R1,@SLUHNDL        R1 <== SLUHANDL ORIGIN                01910000
         B     RETURN                                                   01920000
                                                                        01930000
*--------------------------------------------------------------         01940000
*   ERROR: APPLICATION NOT DEFINED                                      01950000
*--------------------------------------------------------------         01960000
                                                                        01970000
ERR_APPL DS    0H                                                       01980000
         $MSG  004,BUFR=*VSACMSGB,BUFL=*VSACMSGL                        01990000
                                                                        02000000
         LA    R15,RC04           INDICATE UNKNOWN APPL                 02010000
         SR    R0,R0              REASON CODES NOT DEFINED              02020000
         B     RETURN                                                   02030000
                                                                        02040000
*--------------------------------------------------------------         02050000
*   ERROR: APPL ACCESS VIOLATION                                        02060000
*--------------------------------------------------------------         02070000
                                                                        02080000
ERR_VIO  DS    0H                 R0,R1 CONTAIN SECSYS RC,RSN           02090000
         LA    R15,RC08           INDICATE ACCESS VIOLATION             02100000
                                                                        02110000
*--------------------------------------------------------------         02120000
*   RETURN TO REQUESTER                                                 02130000
*--------------------------------------------------------------         02140000
                                                                        02150000
RETURN   DS    0H                                                       02160000
                                                                        02170000
         #EXIT ,                                                        02180000
                                                                        02190000
         EJECT                                                          02200000
***************************************************************         02210000
*                                                                       02220000
* CATASTROPHIC ERRORS                                                   02230000
*                                                                       02240000
***************************************************************         02250000
                                                                        02260000
ABN_TBSV DS    0H                                                       02270000
         $ABEND ABE_TBSERV,DUMP=YES,                                   X02280000
               TITLE='TABLE SERVICE FAILURE'                            02290000
                                                                        02300000
         EJECT                                                          02310000
***************************************************************         02320000
*                                                                       02330000
*   LOCAL READ ONLY DATA AREAS, ETC.                                    02340000
*                                                                       02350000
***************************************************************         02360000
                                                                        02370000
         LTORG ,                                                        02380000
                                                                        02390000
         PRINT NOGEN                                                    02400000
         ICVT  ,                                                        02410000
         ITASK ,                                                        02420000
         END   ,                                                        02430000

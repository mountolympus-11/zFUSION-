IXTGTRM  TITLE '- $TRMSTOR: RELEASE OWNED STORAGE EXTENTS'              00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: IXTGTRM - $TRMSTOR: RELEASE OWNED STORAGE EXTENTS            00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine implements the $TRMSTOR service which is              00080000
*    used to release all active storage extents owned by a              00090000
*    designated work unit (owner) or Active Extent List (QHDR)          00100000
*    by repeatedly invoking $RETSTOR.                                   00110000
*                                                                       00120000
*                                                                       00130000
* NOTES:                                                                00140000
*                                                                       00150000
*    Storage owned by the current work unit may be released at          00160000
*    any time without locking.  However, storage owned by another       00170000
*    work unit, particularly storage owned by a foreign ITASK,          00180000
*    can be released only when that work unit is non-dispatchable       00190000
*    and, then, only when exclusive use has been obtained by the        00200000
*    requestor.                                                         00210000
*                                                                       00220000
*    The ICVT.ICTSTEST field is used to convey the type                 00230000
*    of storage integrity tests to apply upon the Active Extent         00240000
*    Lists addressable to the requestor.  Optionally, special           00250000
*    requestors may bypass storage validation altogether.               00260000
*    Refer to IXTGVAL for details.                                      00270000
*                                                                       00280000
*                                                                       00290000
* ATTRIBUTES:                                                           00300000
*                                                                       00310000
*    BAKR LINKAGE                                                       00320000
*    AMODE(31), RMODE(ANY)                                              00330000
*                                                                       00340000
*                                                                       00350000
* SERIALIZATION:                                                        00360000
*                                                                       00370000
*    NO LOCKS ARE ACQUIRED                                              00380000
*                                                                       00390000
*                                                                       00400000
* ON ENTRY:                                                             00410000
*                                                                       00420000
*    R1  DIRECTLY OR INDIRECTLY DESIGNATES THE $ISTOR ACTIVE            00430000
*        EXTENT LIST WHICH 'OWNS' THE INDICATED STORAGE LIST,           00440000
*        AS FOLLOWS:                                                    00450000
*                                                                       00460000
*           R15 = 0  - THE ACTIVE EXTENT LIST ASSOCIATED WITH           00470000
*                      THE CURRENT ITASK (IF IN ITASK MODE) OR          00480000
*                      PROCESS (IF IN PCB MODE) IS SELECTED. AN         00490000
*                      ERROR IS REPORTED IF THE REQUESTOR IS NOT        00500000
*                      EXECUTING IN THE STANDARD ENVIRONMENT.           00510000
*                                                                       00520000
*           R15 > 0  - THE REGISTER CONTAINS THE ADDRESS OF AN          00530000
*                      ITASK OR PCB REPRESENTING THE OWNING             00540000
*                      WORK UNIT                                        00550000
*                                                                       00560000
*           R15 < 0  - BITS 1-31 OF THE REGISTER CONTAIN THE            00570000
*                      ADDRESS OF A DOUBLE WORD (ALIGNED) $ISTOR        00580000
*                      ACTIVE EXTENT LIST HEADER.  THE HEADER           00590000
*                      NEED NOT BE ASSOCIATED WITH A STANDARD           00600000
*                      WORK UNIT (ITASK OR PCB)                         00610000
*                                                                       00620000
* ON EXIT:                                                              00630000
*                                                                       00640000
*    R15 CONTAINS ZERO                                                  00650000
*                                                                       00660000
**<DOC-OFF>****************************************************         00670000
                                                                        00680000
         EJECT                                                          00690000
***************************************************************         00700000
*                                                                       00710000
* MAINTEANCE:                                                           00720000
*                                                                       00730000
*    07/15/92 R. TURGEON                                                00740000
*             INITIAL VERSION                                           00750000
*                                                                       00760000
*    05/06/93 R. COLMONE                                                00770000
*             CHANGED TO USE BAKR LINKAGE                               00780000
*                                                                       00790000
*    06/10/93 R. TURGEON                                                00800000
*             ADAPTATION TO STANDARD EXECUTION ENVIRONMENT              00810000
*                                                                       00820000
*    11/10/94 R. TURGEON                                                00830000
*             ADAPTATION TO STANDARD EXECUTION ENVIRONMENT              00840000
*                                                                       00850000
***************************************************************         00860000
         EJECT                                                          00870000
         $ISTOR ,                 ACTIVE STORAGE EXTENT DESCRIPTOR      00880000
                                                                        00890000
         EJECT                                                          00900000
         @CB   WORKUNIT=YES       PREFIX FOR ALL WORKUNIT CBS           00910000
                                                                        00920000
         EJECT                                                          00930000
         EQUS  STDENV=TEST                                              00940000
                                                                        00950000
         ABCODES ,                                                      00960000
                                                                        00970000
         EJECT                                                          00980000
IXTGTRM  CSECT ,                                                        00990000
IXTGTRM  AMODE 31                                                       01000000
IXTGTRM  RMODE ANY                                                      01010000
                                                                        01020000
         BAKR  R14,0              SAVE ENVIRONMENT                      01030000
         BASR  R12,0              ESTABLISH BASE                        01040000
         USING *,R12              TEMP BASE                             01050000
         LAE   R12,0(R12,0)       DISCARD ALET                          01060000
         L     R12,=A(IXTGTRM)                                          01070000
         USING IXTGTRM,R12        ESTABLISH ADDRESSABILITY              01080000
                                                                        01090000
         @CPYRYT ,                COPYRIGHT                             01100000
                                                                        01110000
         SYSSTATE ASCENV=P        PRIMARY MODE                          01120000
         SAC   0                                                        01130000
                                                                        01140000
*--------------------------------------------------------------         01150000
*   ACCEPT PASSED PARAMETERS - RECOVER ENVIRONMENT                      01160000
*--------------------------------------------------------------         01170000
         LR    R9,R1              ACTIVE EXTENT LIST PTR                01180000
                                                                        01190000
         @RESTENV ,               RESTORE REMNANTS OF STD ENVIRON       01200000
                                                                        01210000
         USING ICVT,R11           ICVT                                  01220000
         USING ITASK,R10          ITASK OR ZERO                         01230000
                                                                        01240000
         L     R7,ICTSTEST        SNAPSHOT OF DIAGNOSTIC OPTIONS        01250000
                                                                        01260000
*--------------------------------------------------------------         01270000
*   LOC WORKUNIT ACTIVE EXTENT LIST IF NOT EXPLICITLY PROVIDED          01280000
*--------------------------------------------------------------         01290000
         USING @CB,R9             ASSUME POINTER TO WORKUNIT CB         01300000
         LTR   R9,R9              OWNER IDENTITY                        01310000
         BZ    QHDR_DFT           NONE PROVIDED                         01320000
         BM    QHDR_DIR           QHDR PROVIDED DIRECTLY OR ZERO        01330000
         L     R9,@CBSTORQ        LOCATE ACTIVE EXTENT LIST QHDR        01340000
         B     QHDR_DIR           QHDR IDENTIFIED                       01350000
                                                                        01360000
QHDR_DFT DS    0H                 USE WORKUNIT ACTIVE EXTENT LIST HDR   01370000
         LTR   R9,R10             ITASK IF STDENV                       01380000
         BZ    ABN_ENV            CANT ACCOUNT FOR IT OTHERWISE         01390000
         L     R9,@CBSTORQ        ITASK ACTIVE EXTENT LIST              01400000
         ICM   R15,15,TSKPCBC     RUNNING IN PROCESS MODE?              01410000
         BZ    QHDR_DIR           SKIP IF NOT                           01420000
         L     R9,@CBSTORQ-@CB(R15)   PROC ACTIVE EXTENT LIST           01430000
                                                                        01440000
QHDR_DIR DS    0H                 QHDR ADDRESS ACQUIRED                 01450000
         LA    R9,0(,R9)                                                01460000
         DROP  R9                                                       01470000
                                                                        01480000
*--------------------------------------------------------------         01490000
*   STORAGE VALIDATION DEPENDING ON DIAGNOSTIC OPTIONS                  01500000
*--------------------------------------------------------------         01510000
         CH    R7,=AL2(ICTSTES1)  EXTENT VALIDATION AT FREE?            01520000
         BNH   VERF_FIN           DONE IF MINIMAL TEST ONLY             01530000
                                                                        01540000
         LR    R0,R7              STORAGE VALIDATION LVL IN FORCE       01550000
         LR    R1,R9              ACTIVE EXTENT LIST HEADER             01560000
                                                                        01570000
         @CALL IXTGVAL,CTYPE=CVT PERFORM VALIDATIONS                    01580000
                                                                        01590000
VERF_FIN DS    0H                 EXTENT VALIDATION COMPLETE            01600000
                                                                        01610000
*--------------------------------------------------------------         01620000
*   FREE ALL STORAGE EXTENTS CHAINED TO QUEUE HEADER                    01630000
*--------------------------------------------------------------         01640000
TRM_LOOP DS    0H                                                       01650000
         ICM   R7,15,4(R9)        ALL EXTENTS FREED?                    01660000
         BZ    TRM_FIN            FUNCTION COMPLETE                     01670000
                                                                        01680000
         $RETSTOR $ISHDRLN(R7),QHDR=(R9),VALIDATE=NO                    01690000
                                                                        01700000
         B     TRM_LOOP           AGAIN                                 01710000
                                                                        01720000
*--------------------------------------------------------------         01730000
*   RETURN COMPLETION STATUS TO REQUESTOR                               01740000
*--------------------------------------------------------------         01750000
TRM_FIN  DS    0H                                                       01760000
         LA    R15,RC00           COMPLETION SUMMARY                    01770000
         PR    ,                  RETURN                                01780000
                                                                        01790000
***************************************************************         01800000
*                                                                       01810000
*   CATASTROPHIC FAILURES                                               01820000
*                                                                       01830000
***************************************************************         01840000
ABN_ENV  DS    0H                                                       01850000
         $ABEND ABE_ENV,DUMP=NO,                                       X01860000
               TITLE='$TRMSTOR - INVALID SERVICE ENVIRONMENT'           01870000
                                                                        01880000
         EJECT ,                                                        01890000
***************************************************************         01900000
*                                                                       01910000
*   LOCAL READ ONLY STORAGE                                             01920000
*                                                                       01930000
***************************************************************         01940000
         LTORG ,                                                        01950000
                                                                        01960000
         PRINT NOGEN                                                    01970000
         ICVT  ,                                                        01980000
         ITASK ,                                                        01990000
                                                                        02000000
         IHAPSA ,                                                       02010000
         IKJTCB ,                                                       02020000
         END   ,                                                        02030000

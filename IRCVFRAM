IRCVFRAM TITLE '- SAVEAREA FRAME RECOVERY DRIVER'                       00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE:  IRCVFRAM - Savearea frame recovery driver                   00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine is invoked by $FRAME RECOVER to purge                 00080000
*    savearea / workarea frames from the workunit frame stack           00090000
*    during ABEND recovery processing.                                  00100000
*                                                                       00110000
*                                                                       00120000
* METHOD:                                                               00130000
*                                                                       00140000
*    The workunit contains a Frame Control Area or FRCA that            00150000
*    that identifies the CURRENT FRCA - the most recently added         00160000
*    savearea stack entry.  The CURRENT FRCA also contains the          00170000
*    address of a recovery routine (RCVRTN) responsible for             00180000
*    evaluating the use of the associated frame and for                 00190000
*    performing the appropriate cleanup if the frame is no              00200000
*    longer active.                                                     00210000
*                                                                       00220000
*    The RCVRTN associated with the CURRENT FRCA is invoked             00230000
*    given the address of its FRCA and the R13 value (RETRYSA)          00240000
*    associated with the resumption/retry routine. The RCVRTN           00250000
*    determines whether the RETRYSA is spanned by the frame             00260000
*    associated with the given FRCA (in an implementation               00270000
*    dependent manner) and completes as follows:                        00280000
*                                                                       00290000
*    - If the CURRENT FRCA / frame is associated (in some way)          00300000
*      with the retry routine RETRYSA, return RC00 indicating           00310000
*      RECOVERY COMPLETE.                                               00320000
*                                                                       00330000
*    - If the CURRENT FRCA / frame is not associated with the           00340000
*      RETRYSA, $FRAME POP the CURRENT FRCA off the stack,              00350000
*      release the frame (implementation dependent) and return          00360000
*      RC04 indicating RECOVERY CONTINUES.                              00370000
*                                                                       00380000
*                                                                       00390000
* NOTES:                                                                00400000
*                                                                       00410000
*    STDENV callers only                                                00420000
*                                                                       00430000
*                                                                       00440000
* RCVRTN LINKAGE:                                                       00450000
*                                                                       00460000
*    Frame recovery routines are entered via BASR with a                00470000
*    standard OS/VS savearea.                                           00480000
*                                                                       00490000
*       R0 - address of a 256 byte, cleared workarea                    00500000
*                                                                       00510000
*       R1 - contains the address of a parameter list                   00520000
*            constructed as follows                                     00530000
*                                                                       00540000
*            +00 - address of the FRCA                                  00550000
*            +04 - RETRYSA value or zero (high order bit cleared)       00560000
*                                                                       00570000
*    RCVRTNs may not acquire savearea frames.                           00580000
*                                                                       00590000
*                                                                       00600000
* ON ENTRY:                                                             00610000
*                                                                       00620000
*    R1  contains the workunit origin address                           00630000
*                                                                       00640000
*    R0  contains the R13 retry value (RETRYSA) or zero if no           00650000
*        retry will be attempted                                        00660000
*                                                                       00670000
*                                                                       00680000
* ON EXIT:                                                              00690000
*                                                                       00700000
*    R15 contains one of the following return codes                     00710000
*                                                                       00720000
*        RC00 - RECOVERY COMPLETE                                       00730000
*        RC04 - RECOVERY CONTINUES                                      00740000
*                                                                       00750000
*    R1  retains the address of the given workunit                      00760000
*                                                                       00770000
**<DOC-OFF>****************************************************         00780000
                                                                        00790000
         EJECT                                                          00800000
***************************************************************         00810000
*                                                                       00820000
* MAINTENANCE:                                                          00830000
*                                                                       00840000
*    12/01/94  R. Turgeon                                               00850000
*              Initial version                                          00860000
*                                                                       00870000
***************************************************************         00880000
                                                                        00890000
         EJECT                                                          00900000
WORKAREA #WORK ,                                                        00910000
                                                                        00920000
WK256    DS    XL256              WORKAREA PROVIDED TO RCVRTNS          00930000
                                                                        00940000
WORKLEN  #ENDWORK ,                                                     00950000
                                                                        00960000
         EJECT                                                          00970000
         FRCA  ,                  FRAME CONTROL AREA                    00980000
                                                                        00990000
         EJECT                                                          01000000
         @CB   WORKUNIT=YES       WORKUNIT PREFIX                       01010000
                                                                        01020000
         EJECT                                                          01030000
         EQUS  ,                                                        01040000
                                                                        01050000
         EJECT                                                          01060000
***************************************************************         01070000
*                                                                       01080000
*   The nonstd linkage below ensures that the savearea frame            01090000
*   stack is not modified while it is being examined and                01100000
*   repaired.                                                           01110000
*                                                                       01120000
***************************************************************         01130000
IRCVFRAM #ENTER SAVE=NO,PREG=(R9,R7)                                    01140000
                                                                        01150000
         $GETSTOR *=A(WORKLEN)                                          01160000
                                                                        01170000
         ST     R1,8(,R13)                                              01180000
         ST     R13,4(,R1)                                              01190000
         LR     R13,R1                                                  01200000
         USING  WORKAREA,R13                                            01210000
                                                                        01220000
*--------------------------------------------------------------         01230000
*   Accept passed parameters                                            01240000
*--------------------------------------------------------------         01250000
         LA     R7,0(,R7)         R7 <== RETRYSA VALUE                  01260000
                                                                        01270000
         USING  @CB,R9            STANDARD WORKUNIT PREFIX              01280000
         L      R8,@CB@FRCA       LOCATE FRAME CONTROL AREA             01290000
         USING  FRCA,R8           LIFE OF FUNCTION ADDRESSABILITY       01300000
                                                                        01310000
         EJECT                                                          01320000
***************************************************************         01330000
*                                                                       01340000
*   Repeatedly invoke the RCVRTN associated with the CURRENT            01350000
*   FRCA until RECOVERY COMPLETE is signaled or all FRCAs have          01360000
*   been deleted.                                                       01370000
*                                                                       01380000
***************************************************************         01390000
CURRFRCA DS    0H                                                       01400000
         ICM   R2,15,FRCAFRCP     FRCA'S REMAIN?                        01410000
         BZ    RETURN             DONE IF SO                            01420000
                                                                        01430000
         LA    R1,MFE_LIST        PLIST CONSTRUCTION                    01440000
         ST    R2,0(,R1)          CURRENT FRCA                          01450000
         ST    R7,4(,R1)          RETRYSA VALUE                         01460000
                                                                        01470000
         XC    WK256,WK256        CLEAR THE WORKAREA                    01480000
                                                                        01490000
         LA    R0,WK256           256 BYTE WORKAREA                     01500000
         L     R15,FRCAFRTN       RCVRTN EPA                            01510000
         BASR  R14,R15            IMPLEMENTATION DEPENDENT EVAL/CLEANUP 01520000
                                                                        01530000
         LTR   R15,R15            RECOVERY COMPLETE                     01540000
         BNZ   CURRFRCA           AGAIN IF NOT                          01550000
                                                                        01560000
*--------------------------------------------------------------         01570000
*   RETURN TO REQUESTER                                                 01580000
*--------------------------------------------------------------         01590000
RETURN   DS    0H                                                       01600000
         L     R3,4(,R13)         TRACE BACK THRU SAVEAREAS             01610000
                                                                        01620000
         $RETSTOR (R13)           RELEASE ACQUIRED AREA                 01630000
                                                                        01640000
         LR    R13,R3             RESTORE SAVE=NO CONFIG AT ENTRY       01650000
         LA    R15,RC00           INDICATE RECOVERY COMPLETE            01660000
         LA    R1,@CB             RETURN SELECTED WORKUNIT              01670000
                                                                        01680000
         #EXIT ,                                                        01690000
                                                                        01700000
         EJECT                                                          01710000
***************************************************************         01720000
*                                                                       01730000
*   LOCAL READ ONLY WORKING STORAGE                                     01740000
*                                                                       01750000
***************************************************************         01760000
         LTORG ,                                                        01770000
                                                                        01780000
         PRINT NOGEN                                                    01790000
         ICVT  ,                                                        01800000
         END   ,                                                        01810000

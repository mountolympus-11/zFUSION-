IL62UDFS TITLE 'INTEGRATOR - IVUSER LU6.2 DEACTIVATE FREE SESSIONS'     00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: IL62UDFS - IVUSER LU6.2 DEACTIVATE FREE SESSIONS             00100000
*                                                                       00110000
* DESCRIPTION:                                                          00120000
*                                                                       00130000
* ON ENTRY:                                                             00140000
*                                                                       00150000
*    R15 = ENTRY POINT ADDRESS                                          00160000
*    R14 = RETURN ADDRESS                                               00170000
*    R13 = AVAILABLE SAVE AREA                                          00180000
*    R11 = ICVT ADDRESS                                                 00190000
*    R10 = ITASK ADDRESS                                                00200000
*    R09 = IVTAMCVT ADDRESS                                             00210000
*    R08 = IVUSER ADDRESS                                               00220000
*    R01 = MDE ADDRESS                                                  00230000
*                                                                       00240000
*          VTAMLOCK IS HELD                                             00250000
*                                                                       00260000
* ON EXIT:                                                              00270000
*                                                                       00280000
*    R15 = 0                                                            00290000
*    R00 = 0                                                            00300000
*    R01 = 0                                                            00310000
*                                                                       00320000
*    ALL OTHER REGISTERS ARE RESTORED.                                  00330000
*                                                                       00340000
**<DOC-OFF>************************************************************ 00350000
                                                                        00360000
         EJECT ,                                                        00370000
*********************************************************************** 00380000
*                                                                       00390000
* MAINTENANCE:                                                          00400000
*                                                                       00410000
*   10/01/94 RANDY WITEK - LU6.2 SUPPORT                                00420000
*                                                                       00430000
*********************************************************************** 00440000
                                                                        00450000
         EQUS  ,                  GENERAL EQUATES                       00460000
                                                                        00470000
RICVT    EQU   R11                                                      00480000
RITASK   EQU   R10                                                      00490000
RIVTAM   EQU   R9                                                       00500000
RIVUSER  EQU   R8                                                       00510000
RMDE     EQU   R7                                                       00520000
RISESS   EQU   R6                                                       00530000
                                                                        00540000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00550000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00560000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00570000
         USING IVUSER,RIVUSER     ESTABLISH ADDRESSABILITY              00580000
         USING MDE,RMDE           ESTABLISH ADDRESSABILITY              00590000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00600000
                                                                        00610000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00620000
WRK256   DS    XL256              GENERAL WORKAREA                      00630000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00640000
L62MFL   L62POST MF=L             PLIST CONSTRUCTION                    00650000
L62RETRC DS    F                  LU6.2 RETURN CODE RETURN AREA         00660000
                                                                        00670000
CONWIN#  DS    F                  CONWINNER_COUNT                       00680000
CONLOS#  DS    F                  CONLOSER_COUNT                        00690000
                                                                        00700000
RETR15   DS    F                                                        00710000
RETR0    DS    F                                                        00720000
RETR1    DS    F                                                        00730000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00740000
FLAG     DS    X                                                        00750000
FLAGLOCK EQU   X'80'                                                    00760000
FLAGLCKD EQU   X'40'                                                    00770000
FLAGDWIN EQU   X'20'              WINNER CAN BE DEACTIVATED             00780000
FLAGDLOS EQU   X'10'              LOSER  CAN BE DEACTIVATED             00790000
                                                                        00800000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00810000
                                                                        00820000
         $MSGDFT PREFIX=ICTPID,                                        +00830000
               COMPID='L62',                                           +00840000
               TABLE=*#MSGS,                                           +00850000
               WORKA=0,                                                +00860000
               MF=(E,WRK256),                                          +00870000
               PRINT=NOGEN                                              00880000
                                                                        00890000
IL62UDFS #ENTER BASE=R12,         ENTRY LINKAGE                        +00900000
               PREG=RMDE,                                              +00910000
               AMODE=31,                                               +00920000
               RMODE=ANY                                                00930000
                                                                        00940000
*---------------------------------------------------------------------- 00950000
* IF TERMINATION COUNT IS ZERO...RETURN                                 00960000
*---------------------------------------------------------------------- 00970000
                                                                        00980000
KILLNEXT DS    0H                                                       00990000
                                                                        01000000
         ICM   R1,15,MDETERMC     TERMINATION COUNT?                    01010000
         BZ    RETURN             EXIT IF NO TERMINATIONS NEEDED        01020000
                                                                        01030000
*---------------------------------------------------------------------- 01040000
* DETERMINE SOME VARIABLE VALUES                                        01050000
*---------------------------------------------------------------------- 01060000
                                                                        01070000
         L     R1,MDEACWC         ACTIVE CONWINNER                      01080000
         A     R1,MDEPCWC         + PENDING CONWINNER                   01090000
         S     R1,MDEPTCW         - PENDING CONWINNER TERMINATIONS      01100000
         ST    R1,CONWIN#         SAVE NUMBER OF CONWINNERS             01110000
         BM    ERRENVIR           BRANCH IF SOMETHING IS FUNNY          01120000
                                                                        01130000
         L     R2,MDEACLC         ACTIVE CONLOSERS                      01140000
         A     R2,MDEPCLC         + PENDING CONLOSERS                   01150000
         S     R2,MDEPTCL         - PENDING CONLOSERS TERMINATIONS      01160000
         ST    R2,CONLOS#         SAVE NUMBER OF CONLOSERS              01170000
         BM    ERRENVIR           BRANCH IF SOMETHING IS FUNNY          01180000
                                                                        01190000
*---------------------------------------------------------------------- 01200000
* SEE IF NEED FOR DEACTIVATION STILL EXISTS                             01210000
*---------------------------------------------------------------------- 01220000
                                                                        01230000
         NI    FLAG,255-FLAGDWIN  NO WINNERS TO TERMINATE               01240000
         NI    FLAG,255-FLAGDLOS  NO LOSERS  TO TERMINATE               01250000
                                                                        01260000
         C     R1,MDEMINCW        IS CONWINNER_COUNT BELOW LIMIT?       01270000
         BNH   *+8                BRANCH IF YES                         01280000
         OI    FLAG,FLAGDWIN      REMEMBER WINNERS TO DEACTIVATE        01290000
                                                                        01300000
         C     R2,MDEMINCL        IS CONLOSER_COUNT BELOW LIMIT?        01310000
         BNH   *+8                BRANCH IF YES                         01320000
         OI    FLAG,FLAGDLOS      REMEMBER LOSERS  TO DEACTIVATE        01330000
                                                                        01340000
         TM    FLAG,FLAGDWIN+FLAGDLOS                                   01350000
         BNZ   NEEDDEAC           BRANCH IF SESSION(S) TO DEACTIVATE    01360000
         XC    MDETERMC,MDETERMC  CLEAR THE TERMINATION COUNT           01370000
         B     RETURN             AND EXIT                              01380000
                                                                        01390000
NEEDDEAC DS    0H                                                       01400000
                                                                        01410000
*---------------------------------------------------------------------- 01420000
* FIND A FREE SESSION TO DEACTIVATE                                     01430000
*---------------------------------------------------------------------- 01440000
                                                                        01450000
         LA    RISESS,MDEFS1ST    SET TO RUN FREE SESSION CHAIN         01460000
         S     RISESS,=A(ISE62FSN-ISESS)                                01470000
                                                                        01480000
FINDSESS DS    0H                                                       01490000
                                                                        01500000
         ICM   RISESS,15,ISE62FSN IS THERE A FREE SESSION?              01510000
         BNP   RETURN             BRANCH IF NOT, CAN'T DEACTIVATE NOW   01520000
         TM    ISE62FL1,ISE62AEX  IS AN ATTACH EXPECTED?                01530000
         BO    FINDSESS           BRANCH IF YES                         01540000
         TM    ISE62FL2,ISE62BID  IS A BID SEQUENCE IN PROGRESS?        01550000
         BO    FINDSESS           BRANCH IF YES                         01560000
         TM    ISE62FL3,ISE62TRM  IS SESSION ALREADY PENDING TERM?      01570000
         BO    FINDSESS           BRANCH IF YES                         01580000
                                                                        01590000
         TM    ISEF2,ISEF2WIN     IS IT A WINNER?                       01600000
         BO    FOUNDWIN           BRANCH IF YES                         01610000
         TM    FLAG,FLAGDLOS      CAN WE DEACTIVATE A LOSER?            01620000
         BO    DEACTLOS           BRANCH IF YES                         01630000
         B     FINDSESS           GO CHECH THE NEXT SESSION             01640000
                                                                        01650000
FOUNDWIN DS    0H                                                       01660000
                                                                        01670000
         TM    FLAG,FLAGDWIN      CAN WE DEACTIVATE A WINNER?           01680000
         BO    DEACTWIN           BRANCH IF YES                         01690000
         B     FINDSESS           GO CHECK THE NEXT SESSION             01700000
                                                                        01710000
*---------------------------------------------------------------------- 01720000
* START DEACTIVATION OF THE SESSION                                     01730000
*---------------------------------------------------------------------- 01740000
                                                                        01750000
DEACTLOS DS    0H                                                       01760000
                                                                        01770000
         LA    R1,MDEPTCL         PENDING TERMINATION LOSERS            01780000
         B     DEACT              AND CONTINUE                          01790000
                                                                        01800000
DEACTWIN DS    0H                                                       01810000
                                                                        01820000
         LA    R1,MDEPTCW         PENDING TERMINATION LOSERS            01830000
                                                                        01840000
DEACT    DS    0H                                                       01850000
                                                                        01860000
         L     R2,0(,R1)          SELECTED PENDING COUNT                01870000
         A     R2,=F'1'           BUMP IT BY ONE                        01880000
         ST    R2,0(,R1)          SAVE UPDATED COUNT                    01890000
                                                                        01900000
         L     R2,MDETERMC        CURRENT TERMINATION COUNT             01910000
         S     R2,=F'1'           DECREMENT TERMINATION COUNT           01920000
         ST    R2,MDETERMC        SAVE UPDATED TERMINATION COUNT        01930000
         BM    ERRENVIR           BRANCH IF SOMETHINGS FUNNY            01940000
                                                                        01950000
         OI    ISE62FL3,ISE62TRM  SHOW THAT SESSION IS PENDING TERM     01960000
                                                                        01970000
         $VTAMWE L'IWEY3,         LENGTH                               +01980000
               IWECBISR           CODE                                  01990000
                                                                        02000000
X        USING IWEVTAM,R1                                               02010000
         OI    X.IY3F1,IY3F1SNT   SEND BIS REQUEST                      02020000
         ST    RMDE,X.IWEY3MDE    PASS THE MDE ADDRESS                  02030000
         MVC   X.IWEY3NME,MDENAME PASS THE MODE NAME                    02040000
         MVC   X.IWEY3TKN,ISETK   PASS THE SESSION TOKEN                02050000
         DROP  X                                                        02060000
                                                                        02070000
         LA    R0,ISEWEQ          QUEUE ADDRESS                         02080000
         BAS   R14,QWE            QUEUE THE WORK ELEMENT                02090000
         B     KILLNEXT           CHECK IF MORE TO DEACTIVATE           02100000
                                                                        02110000
*---------------------------------------------------------------------- 02120000
* RETURN TO CALLER                                                      02130000
*---------------------------------------------------------------------- 02140000
                                                                        02150000
RETURN   DS    0H                                                       02160000
                                                                        02170000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 02180000
                                                                        02190000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    02200000
                                                                        02210000
*---------------------------------------------------------------------- 02220000
* SUBROUTINE QWE - QUEUE A WORK ELEMENT TO A GIVEN WORK QUEUE           02230000
*                                                                       02240000
* ENTRY            R14 = RETURN ADDRESS                                 02250000
*                  R1  = WORK ELEMENT ADDRESS                           02260000
*                  R0  = QUEUE ADDRESS                                  02270000
*                                                                       02280000
* RETURNS          R15 = 0 --> QUEUEING WAS SUCCESSFUL                  02290000
*                      = 4 --> QUEUEING FAILED, WORK ELEMENT RELEASED   02300000
*---------------------------------------------------------------------- 02310000
                                                                        02320000
QWE      DS    0H                                                       02330000
                                                                        02340000
         STM   R14,R4,SUB0SAVE    SAVE REGISTERS                        02350000
         LR    R3,R0              SAVE QUEUE ADDRESS                    02360000
         LR    R4,R1              SAVE WORK ELEMENT ADDRESS             02370000
                                                                        02380000
         $VTAMQ (R4),             WORK ELEMENT                         +02390000
               (R3)               QUEUE                                 02400000
                                                                        02410000
         L     R14,SUB0SAVE       RESTORE REGISTERS                     02420000
         LM    R0,R4,SUB0SAVE+8   RESTORE REGISTERS                     02430000
         BR    R14                AND RETURN TO CALLER W/R15            02440000
                                                                        02450000
*---------------------------------------------------------------------- 02460000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 02470000
*---------------------------------------------------------------------- 02480000
                                                                        02490000
VTAMLOCK DS    0H                                                       02500000
                                                                        02510000
         TM    FLAG,FLAGLOCK        WAS THE LOCK ALREADY OBTAINED?      02520000
         BOR   R14                  RETURN IF YES                       02530000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             02540000
                                                                        02550000
         $SER  OBTAIN,                                                 +02560000
               VTAM                                                     02570000
                                                                        02580000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              02590000
         BNE   VTAMLOEX             BRANCH IF NOT                       02600000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         02610000
                                                                        02620000
VTAMLOEX DS    0H                                                       02630000
                                                                        02640000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               02650000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          02660000
         BR    R14                  RETURN                              02670000
                                                                        02680000
*---------------------------------------------------------------------- 02690000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                02700000
*---------------------------------------------------------------------- 02710000
                                                                        02720000
VTAMUNLK DS    0H                                                       02730000
                                                                        02740000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       02750000
         BNOR  R14                  BRANCH IF NOT                       02760000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             02770000
         BOR   R14                  DON'T RELEASE IF IT WAS             02780000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             02790000
                                                                        02800000
         $SER  RELEASE,                                                +02810000
               VTAM                                                     02820000
                                                                        02830000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  02840000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          02850000
         BR    R14                  RETURN                              02860000
                                                                        02870000
*---------------------------------------------------------------------- 02880000
* ERROR ROUTINES                                                        02890000
*---------------------------------------------------------------------- 02900000
                                                                        02910000
ERRENVIR DS    0H                                                       02920000
                                                                        02930000
         $ABEND ABE_VTDIAG,                                            +02940000
               SCOPE=PCB,                                              +02950000
               TITLE='ENVIRONMENT ERROR'                                02960000
                                                                        02970000
*---------------------------------------------------------------------- 02980000
*  CONSTANTS AND LITERALS                                               02990000
*---------------------------------------------------------------------- 03000000
                                                                        03010000
         LTORG ,                                                        03020000
         PRINT NOGEN                                                    03030000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                03040000
         ISTDBIND ,               VTAM BIND IMAGE                       03050000
         TRACODES ,               INTEGRATOR TRACE CODES                03060000
         ICVT  ,                  INTEGRATOR CVT                        03070000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   03080000
         IRPL ,                   INTEGRATOR VTAM RPL+                  03090000
         IACB ,                   INTEGRATOR VTAM ACB+                  03100000
         INIB ,                   INTEGRATOR VTAM NIB+                  03110000
         ISESS ,                  INTEGRATOR SESSION BLOCK              03120000
         IRQE ,                   INTEGRATOR RECEIVE QUEUE ELEMENT      03130000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            03140000
         ITASK ,                  INTEGRATOR TASK BLOCK                 03150000
         IPCB ,                   INTEGRATOR PROCESS BLOCK              03160000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          03170000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       03180000
         EVCODES ,                INTEGRATOR EVENT CODES                03190000
         ABCODES ,                INTEGRATOR $ABEND CODES               03200000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     03210000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        03220000
         END   ,                                                        03230000

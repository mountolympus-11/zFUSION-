ITB@CMPR TITLE 'TABLE SERVICES - ROW KEY COMPARE'                       00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE:  ITB@CMPR - Row key compare                                  00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine is used to compare the key fields of two              00080000
*    table rows referred to as row #1 and row #2.  The key              00090000
*    fields are described by the TBKEYDEF descriptor provided           00100000
*    as input.  Individual ALETs are provided for row #1 and            00110000
*    row #2.  This allows for either operand to reside in the           00120000
*    source (primary) space or in the object space.  When the           00130000
*    ALET provided is zero, the corresponding row is assumed to         00140000
*    be in source format.  When the alet is non-zero, it refers         00150000
*    to an object space and the corresponding row is assumed to         00160000
*    be in stored row format.                                           00170000
*                                                                       00180000
*                                                                       00190000
* ON ENTRY:                                                             00200000
*                                                                       00210000
*    R1  points to a parameter list described by the CMPRPARM           00220000
*        mapping macro.  The plist addr is not AR qualified.            00230000
*                                                                       00240000
*                                                                       00250000
* ON EXIT:                                                              00260000
*                                                                       00270000
*    R15 contains one of the following return codes                     00280000
*                                                                       00290000
*        RC00 - row #1 = row #2                                         00300000
*        RC04 - row #1 < row #2                                         00310000
*        RC08 - row #1 > row #2                                         00320000
*                                                                       00330000
*        RC12 - unsupported data type or data content error             00340000
*                                                                       00350000
**<DOC-OFF>****************************************************         00360000
                                                                        00370000
         EJECT                                                          00380000
***************************************************************         00390000
*                                                                       00400000
* MAINTENANCE:                                                          00410000
*                                                                       00420000
*    01/28/95 R. Turgeon                                                00430000
*             Move the ASC/DESC sequencing flag from the fixed          00440000
*             length TBKORDER word to the high order bit of             00450000
*             each TBCOLDEF pointer array entry.                        00460000
*                                                                       00470000
***************************************************************         00480000
                                                                        00490000
         EJECT                                                          00500000
         CMPRPARM ,               ROW KEY COMPARE PLIST                 00510000
                                                                        00520000
         EJECT                                                          00530000
         @TBCOLDF ,               COLUMN DEFINITION                     00540000
                                                                        00550000
         EJECT                                                          00560000
         @TBKEYDF ,               INDEX DEFINITION                      00570000
                                                                        00580000
         EJECT                                                          00590000
         COLHDR ,                 COLUMN DEFINITION HEADER / LINKAGE    00600000
                                                                        00610000
         EJECT                                                          00620000
         EQUS  LINKAGE=VCON                                             00630000
                                                                        00640000
         EJECT                                                          00650000
ITB@CMPR @ENTER ASC=ENTRY                                               00660000
                                                                        00670000
         LAE   R7,0(R1,0)         FETCH PLIST ADDRESS                   00680000
         USING CMPR$PRM,R7                                              00690000
                                                                        00700000
         L     R1,CMPR$ALE        ALET DESCRIBING OBJECT SPACE          00710000
                                                                        00720000
         LAM   AR5,AR5,CMPR$AL1   ROW #1                                00730000
         LAM   AR6,AR6,CMPR$AL2   ROW #2                                00740000
                                                                        00750000
         L     R4,CMPR$KEY        KEY DEFINITION ADDRESS                00760000
         USING TBKEYDEF,R4        ADDRESSABILITY ONCE QUALIFIED         00770000
         SAR   AR4,R1             KEY DEFINITION IN TABLE SPACE         00780000
         LH    R8,TBKCOUNT        KEY COMPONENT COLUMN COUNT            00790000
         LAE   R9,TBKCOLS         KEY COMPONENT COLUMN PTR ARRAY        00800000
         SAR   AR10,R1            CURRENT KEY COLUMN DESCRIPTOR         00810000
         DROP  R4                 TBKEYDEF                              00820000
                                                                        00830000
         EJECT                                                          00840000
***************************************************************         00850000
*                                                                       00860000
*   Compare key cols moving from major to minor until mismatch          00870000
*                                                                       00880000
***************************************************************         00890000
                                                                        00900000
SELCOL   DS    0H                 SELECT NEXT KEY COLUMN                00910000
         L     R10,0(,R9)         COLUMN DEFINITION OFFLINK             00920000
         A     R10,CMPR$ORG       CONVERT OFFLINK TO ADDRESS            00930000
         USING COLHDR,R10         COLUMN DEFINITION PREFIX              00940000
                                                                        00950000
         L     R5,COLDISPL        ASSUME ROW #1 IN STORED ROW FORMAT    00960000
         L     R6,COLDISPL        ASSUME ROW #2 IN STORED ROW FORMAT    00970000
                                                                        00980000
         LA    R10,COLDEF         DROP PREFIX, ADDRESS COLDEF PROPER    00990000
         USING TBCOLDEF,R10       COLUMN DEFINITION ADDRESSABILITY      01000000
                                                                        01010000
         EAR   R0,AR5             ALET QUALIFIES ROW #1                 01020000
         LTR   R0,R0              ROW RESIDES IN OBJECT SPACE?          01030000
         BNZ   *+8                OFFSET PREVIOUSLY ESTABLISHED         01040000
         L     R5,TBCDISPL        ELSE SWITCH TO SOURCE FORMAT          01050000
         AL    R5,CMPR$OP1        STORED ROW ORIGIN                     01060000
                                                                        01070000
         EAR   R0,AR6             ALET QUALIFIES ROW #2                 01080000
         LTR   R0,R0              ROW RESIDES IN OBJECT SPACE?          01090000
         BNZ   *+8                OFFSET PREVIOUSLY ESTABLISHED         01100000
         L     R6,TBCDISPL        ELSE SWITCH TO SOURCE FORMAT          01110000
         AL    R6,CMPR$OP2        STORED ROW ORIGIN                     01120000
                                                                        01130000
*--------------------------------------------------------------         01140000
*   Select and invoke data comparison routine                           01150000
*--------------------------------------------------------------         01160000
                                                                        01170000
         LAE   R14,0(0,0)         PREPARE FOR INSERT                    01180000
         IC    R14,TBCDTYPE       PRIMARY DATA TYPE OF EACH COMPARAND   01190000
         SLL   R14,2              RTN PTRS ARE FWORDS                   01200000
         L     R14,COMPSTD(R14)   FETCH COMPARE RTN ADDR                01210000
         LTR   R14,R14            ROUTINE PROVIDED?                     01220000
         BNZ   COMPCALL           NON-NUMERIC DATA TYPES                01230000
                                                                        01240000
         IC    R14,TBCNTYPE       NUMERIC DATA TYPE OF EACH COMPARAND   01250000
         SLL   R14,2              RTN PTRS ARE FWORDS                   01260000
         L     R14,COMPNUM(R14)   NUMERIC COMPARE                       01270000
                                                                        01280000
COMPCALL DS    0H                                                       01290000
         L     R11,TBCLENG        FIXED LENGTH OF EACH COMPARAND        01300000
         BASR  R14,R14            INVOKE DATA DEPENDENT COMPARE         01310000
         BL    LOW                ROW#1 < ROW#2                         01320000
         BH    HIGH               ROW#1 > ROW#2                         01330000
         DROP  R10                TBCOLDEF                              01340000
                                                                        01350000
*--------------------------------------------------------------         01360000
*   Equal compare requires redrive, else identify mismatch              01370000
*--------------------------------------------------------------         01380000
                                                                        01390000
         LA    R9,4(,R9)          ADVANCE TO NEXT COLKEY ARRAY PTR      01400000
         BCT   R8,SELCOL          ADVANCE TO NEXT COLUMN                01410000
         LA    R15,RC00           ROW#1 = ROW#2                         01420000
         B     FIN                ROWS ARE IDENTICAL                    01430000
                                                                        01440000
LOW      DS    0H                 ROW#1 < ROW#2                         01450000
         LA    R15,RC04           INDICATE SUCH                         01460000
         B     SEQTEST                                                  01470000
                                                                        01480000
HIGH     DS    0H                 ROW#1 > ROW#2                         01490000
         LA    R15,RC08           INDICATE SUCH                         01500000
                                                                        01510000
SEQTEST  DS    0H                 INVERT OP SEQ FOR DESCENDING SORT     01520000
         ICM   R0,15,0(R9)        TEST SEQUENCE FLAG IN TBCOLDEF PTR    01530000
         BNM   FIN                RETURN ASCENDING SEQUENCE             01540000
         LNR   R15,R15            SUBTRACT FROM SUM OF CHOICES          01550000
         A     R15,=A(RC08+RC04)  TO INVERT THE RESULT                  01560000
         B     FIN                                                      01570000
                                                                        01580000
*--------------------------------------------------------------         01590000
*   Return completion status to caller                                  01600000
*--------------------------------------------------------------         01610000
                                                                        01620000
ERROR    DS    0H                 TERMINATING ERROR                     01630000
         LA    R15,RC12                                                 01640000
                                                                        01650000
FIN      DS    0H                 RETURN                                01660000
         @EXIT ,                                                        01670000
                                                                        01680000
         EJECT ,                                                        01690000
***************************************************************         01700000
*                                                                       01710000
*   Datatype dependent column compare routine lookup                    01720000
*                                                                       01730000
***************************************************************         01740000
                                                                        01750000
COMPSTD  DS    0F                 NON-NUMERIC DATATYPES                 01760000
         DC    A(*-*)         0   NUMERIC DATA, REF COMPNUM             01770000
         DC    A($CLC)        1   CHARACTER                             01780000
         DC    A($CLC)        2   BINARY                                01790000
         DC    A($CLC)        3   BOOLEAN                               01800000
         DC    A($CHRV)       4   VARCHAR                               01810000
         DC    A($BINV)       5   VARBIN                                01820000
         DC    A($CHRX)       6   VARCHARX                              01830000
         DC    A($BINX)       7   VARBINX                               01840000
         DC    A($CLC)        8   TIME STAMP (???)                      01850000
         DC    A(ERROR)       7   *** RESERVED ***                      01860000
                                                                        01870000
COMPNUM  DS    0F                 NUMERIC DATATYPES                     01880000
         DC    A(ERROR)       0   *** RESERVED ***                      01890000
         DC    A(INTSIGN)     1   SIGNED INTEGER                        01900000
         DC    A(INTUSIGN)    2   UNSIGNED INTEGER                      01910000
         DC    A($CP)         3   PACKED DECIMAL                        01920000
         DC    A($CP)         4   PACKED DECIMAL                        01930000
         DC    A(FLOAT)       5   FLOATING POINT                        01940000
         DC    A(ERROR)       6   SQL STYLE NUMERICS                    01950000
         DC    A(ERROR)       7   *** RESERVED ***                      01960000
                                                                        01970000
         EJECT ,                                                        01980000
***************************************************************         01990000
*                                                                       02000000
* Data comparison routines                                              02010000
*                                                                       02020000
* NOTES:                                                                02030000
*                                                                       02040000
*    R0-R4, R15 available as work registers                             02050000
*                                                                       02060000
* ON ENTRY:                                                             02070000
*                                                                       02080000
*    A/R5 - row #1 data column origin                                   02090000
*    A/R6 - row #2 data column origin                                   02100000
*    R11  - length of each operand in fixed row (modifiable)            02110000
*    R14  - return address                                              02120000
*                                                                       02130000
* ON EXIT:                                                              02140000
*                                                                       02150000
*    CC reflects the result of the (row #1 vs row #2) compare           02160000
*                                                                       02170000
***************************************************************         02180000
                                                                        02190000
*--------------------------------------------------------------         02200000
*   Fixed length type EBCDIC collating compare                          02210000
*--------------------------------------------------------------         02220000
                                                                        02230000
$CLC     DS    0H                                                       02240000
         BCTR  R11,0                                                    02250000
         EX    R11,$CLCINST                                             02260000
         BR    R14                                                      02270000
                                                                        02280000
$CLCINST CLC   0(*-*,R5),0(R6)                                          02290000
                                                                        02300000
*--------------------------------------------------------------         02310000
*   varchar - EBCDIC collating compare                                  02320000
*--------------------------------------------------------------         02330000
                                                                        02340000
$CHRV    DS    0H                                                       02350000
         LR    R1,R14             RETURN ADDRESS                        02360000
                                                                        02370000
         SR    R3,R3              ROW#1 FIELD LENGTH                    02380000
         ICM   R5,15,0(R5)        LOCATE VARDATA ORIGIN                 02390000
         BZ    $CHRV_R1           ROW#1 FIELD IS NULL                   02400000
         EAR   R0,AR5             COMPARAND QUALIFIER                   02410000
         LTR   R0,R0              DETERMINE IF STORED OR SOURCE FORMAT  02420000
         BZ    *+8                SOURCE FORMAT - COMPARAND IN PSPACE   02430000
         AL    R5,CMPR$ORG        STORED FORMAT - COMPARAND IN OSPACE   02440000
                                                                        02450000
         ICM   R3,3,0(R5)         ACQUIRE FIELD LENGTH                  02460000
         LAE   R2,2(,R5)          QUALIFIED STRING ORIGIN               02470000
                                                                        02480000
$CHRV_R1 DS    0H                                                       02490000
                                                                        02500000
         L     R15,=X'40000000'   ROW#2 FIELD LENGTH AND PAD            02510000
         ICM   R6,15,0(R6)        LOCATE VARDATA ORIGIN                 02520000
         BZ    $CHRV_R2           ROW#2 FIELD IS NULL                   02530000
         EAR   R0,AR6             COMPARAND QUALIFIER                   02540000
         LTR   R0,R0              DETERMINE IF STORED OR SOURCE FORMAT  02550000
         BZ    *+8                SOURCE FORMAT - COMPARAND IN PSPACE   02560000
         AL    R6,CMPR$ORG        STORED FORMAT - COMPARAND IN OSPACE   02570000
                                                                        02580000
         ICM   R15,3,0(R6)        ACQUIRE FIELD LENGTH                  02590000
         LAE   R14,2(,R6)         QUALIFIED STRING ORIGIN               02600000
                                                                        02610000
$CHRV_R2 DS    0H                                                       02620000
                                                                        02630000
         CLCL  R2,R14             COMPARE, SET CC                       02640000
         BR    R1                                                       02650000
                                                                        02660000
*--------------------------------------------------------------         02670000
*   varcharx - EBCDIC collating compare                                 02680000
*--------------------------------------------------------------         02690000
                                                                        02700000
$CHRX    DS    0H                                                       02710000
         LR    R1,R14             RETURN ADDRESS                        02720000
                                                                        02730000
         L     R3,0(,R5)          VARDATAX FIELD 1 LENGTH               02740000
         LAE   R2,4(,R5)          VARDATAX FIELD 1 ORIGIN               02750000
         EAR   R0,AR2             COMPARAND QUALIFIER                   02760000
         LTR   R0,R0              DETERMINE IF STORED OR SOURCE FORMAT  02770000
         BZ    *+8                SOURCE FORMAT - COMPARAND IN PSPACE   02780000
         AL    R2,CMPR$ORG        STORED FORMAT - COMPARAND IN OSPACE   02790000
                                                                        02800000
         L     R15,0(,R6)         VARDATAX FIELD 2 LENGTH               02810000
         LAE   R14,4(,R6)         VARDATAX FIELD 2 ORIGIN               02820000
         ICM   R15,8,=C' '        PAD CHAR                              02830000
         EAR   R0,AR14            COMPARAND QUALIFIER                   02840000
         LTR   R0,R0              DETERMINE IF STORED OR SOURCE FORMAT  02850000
         BZ    *+8                SOURCE FORMAT - COMPARAND IN PSPACE   02860000
         AL    R14,CMPR$ORG       STORED FORMAT - COMPARAND IN OSPACE   02870000
                                                                        02880000
         CLCL  R2,R14             COMPARE, SET CC                       02890000
         BR    R1                                                       02900000
                                                                        02910000
*--------------------------------------------------------------         02920000
*   varbinary                                                           02930000
*--------------------------------------------------------------         02940000
                                                                        02950000
$BINV    DS    0H                                                       02960000
         LR    R1,R14             RETURN ADDRESS                        02970000
                                                                        02980000
         SR    R3,R3              ROW#1 FIELD LENGTH                    02990000
         ICM   R5,15,0(R5)        LOCATE VARDATA ORIGIN                 03000000
         BZ    $BINV_R1           ROW#1 FIELD IS NULL                   03010000
         EAR   R0,AR5             COMPARAND QUALIFIER                   03020000
         LTR   R0,R0              DETERMINE IF STORED OR SOURCE FORMAT  03030000
         BZ    *+8                SOURCE FORMAT - COMPARAND IN PSPACE   03040000
         AL    R5,CMPR$ORG        STORED FORMAT - COMPARAND IN OSPACE   03050000
                                                                        03060000
         ICM   R3,3,0(R5)         ACQUIRE FIELD LENGTH                  03070000
         LAE   R2,2(,R5)          QUALIFIED STRING ORIGIN               03080000
                                                                        03090000
$BINV_R1 DS    0H                                                       03100000
                                                                        03110000
         SR    R15,R15            ROW#2 FIELD LENGTH AND PAD            03120000
         ICM   R6,15,0(R6)        LOCATE VARDATA ORIGIN                 03130000
         BZ    $BINV_R2           ROW#2 FIELD IS NULL                   03140000
         EAR   R0,AR6             COMPARAND QUALIFIER                   03150000
         LTR   R0,R0              DETERMINE IF STORED OR SOURCE FORMAT  03160000
         BZ    *+8                SOURCE FORMAT - COMPARAND IN PSPACE   03170000
         AL    R6,CMPR$ORG        STORED FORMAT - COMPARAND IN OSPACE   03180000
                                                                        03190000
         ICM   R15,3,0(R6)        ACQUIRE FIELD LENGTH                  03200000
         LAE   R14,2(,R6)         QUALIFIED STRING ORIGIN               03210000
                                                                        03220000
$BINV_R2 DS    0H                                                       03230000
                                                                        03240000
         CLCL  R2,R14             COMPARE, SET CC                       03250000
         BR    R1                                                       03260000
                                                                        03270000
*--------------------------------------------------------------         03280000
*   varbinaryx                                                          03290000
*--------------------------------------------------------------         03300000
                                                                        03310000
$BINX    DS    0H                                                       03320000
         LR    R1,R14             RETURN ADDRESS                        03330000
                                                                        03340000
         L     R3,0(,R5)          VARDATAX FIELD 1 LENGTH               03350000
         LAE   R2,4(,R5)          VARDATAX FIELD 1 ORIGIN               03360000
         EAR   R0,AR2             COMPARAND QUALIFIER                   03370000
         LTR   R0,R0              DETERMINE IF STORED OR SOURCE FORMAT  03380000
         BZ    *+8                SOURCE FORMAT - COMPARAND IN PSPACE   03390000
         AL    R2,CMPR$ORG        STORED FORMAT - COMPARAND IN OSPACE   03400000
                                                                        03410000
         L     R15,0(,R6)         VARDATAX FIELD 2 LENGTH               03420000
         LAE   R14,4(,R6)         VARDATAX FIELD 2 ORIGIN               03430000
         EAR   R0,AR14            COMPARAND QUALIFIER                   03440000
         LTR   R0,R0              DETERMINE IF STORED OR SOURCE FORMAT  03450000
         BZ    *+8                SOURCE FORMAT - COMPARAND IN PSPACE   03460000
         AL    R14,CMPR$ORG       STORED FORMAT - COMPARAND IN OSPACE   03470000
                                                                        03480000
         CLCL  R2,R14             COMPARE, SET CC                       03490000
         BR    R1                                                       03500000
                                                                        03510000
*--------------------------------------------------------------         03520000
*   packed data formats                                                 03530000
*--------------------------------------------------------------         03540000
                                                                        03550000
$CP      DS    0H                                                       03560000
         BCTR  R11,0                                                    03570000
         LR    R15,R11                                                  03580000
         SLL   R11,4                                                    03590000
         OR    R11,R15                                                  03600000
         EX    R11,$CPINST                                              03610000
         BR    R14                                                      03620000
                                                                        03630000
$CPINST  CP    0(*-*,R5),0(*-*,R6)                                      03640000
                                                                        03650000
*--------------------------------------------------------------         03660000
*   floating point                                                      03670000
*--------------------------------------------------------------         03680000
                                                                        03690000
FLOAT    DS    0H                                                       03700000
         B     ERROR                                                    03710000
                                                                        03720000
*--------------------------------------------------------------         03730000
*   signed integer                                                      03740000
*--------------------------------------------------------------         03750000
                                                                        03760000
INTSIGN  DS    0H                                                       03770000
         BCTR  R11,0                                                    03780000
         SLL   R11,2                                                    03790000
         SR    R0,R0                                                    03800000
         EX    R0,$FET(R11)            FETCH SIGNED VALUE               03810000
         BNM   *+8                     SKIP IF HIGHORDER BIT IS LOW     03820000
         EX    R0,$SXT(R11)            ELSE SIGN EXTEND                 03830000
                                                                        03840000
         EX    R0,$SINTEX(R11)         COMPARE SIGNED VALUES            03850000
         BR    R14                                                      03860000
                                                                        03870000
$SXT     DS    0H                                                       03880000
         O     R0,=X'FFFFFF00'                                          03890000
         O     R0,=X'FFFF0000'                                          03900000
         O     R0,=X'FF000000'                                          03910000
         O     R0,=X'00000000'                                          03920000
                                                                        03930000
$SINTEX  DS    0H                      INTEGER OPERAND SIGNED COMPARE   03940000
         CLM   R0,B'0001',0(R6)        TYPICAL EBCDIC (C) USAGE         03950000
         CH    R0,0(,R6)                                                03960000
         EX    R0,*                    SIGNED, THREE BYTE INTS INVALID  03970000
         C     R0,0(,R6)                                                03980000
                                                                        03990000
*--------------------------------------------------------------         04000000
*   signed and unsigned integer                                         04010000
*--------------------------------------------------------------         04020000
                                                                        04030000
INTUSIGN DS    0H                                                       04040000
         BCTR  R11,0                                                    04050000
         SLL   R11,2                                                    04060000
         SR    R0,R0                                                    04070000
         EX    R0,$FET(R11)            FETCH UNSIGNED VALUE             04080000
                                                                        04090000
         EX    R0,$UINTEX(R11)         COMPARE UNSIGNED VALUES          04100000
         BR    R14                                                      04110000
                                                                        04120000
$UINTEX  DS    0H                      INTEGER OPERAND UNSIGNED COMPARE 04130000
         CLM   R0,B'0001',0(R6)                                         04140000
         CLM   R0,B'0011',0(R6)                                         04150000
         CLM   R0,B'0111',0(R6)                                         04160000
         CLM   R0,B'1111',0(R6)                                         04170000
                                                                        04180000
*--------------------------------------------------------------         04190000
*   integer, common logic                                               04200000
*--------------------------------------------------------------         04210000
                                                                        04220000
$FET     DS    0H                      INTEGER OPERAND FETCH            04230000
         ICM   R0,B'0001',0(R5)                                         04240000
         ICM   R0,B'0011',0(R5)                                         04250000
         ICM   R0,B'0111',0(R5)                                         04260000
         ICM   R0,B'1111',0(R5)                                         04270000
                                                                        04280000
         EJECT ,                                                        04290000
***************************************************************         04300000
*                                                                       04310000
*   Local read-only data areas, etc.                                    04320000
*                                                                       04330000
***************************************************************         04340000
                                                                        04350000
         LTORG ,                                                        04360000
         END   ,                                                        04370000

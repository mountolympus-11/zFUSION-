IVTMNKIL TITLE 'INTEGRATOR - MAIN TASK KILL SESSION PROCESSOR'          00010000
**<DOC-ON>************************************************************* 00020000
*                                                                       00030000
* ROUTINE: IVTMNKIL - INTEGRATOR MAIN TASK KILL SESSION PROCESSOR       00040000
*                                                                       00050000
* DESCRIPTION: END AN SNA SESSION THAT WAS NOT TERMINATED DURING        00060000
*              NORMAL SESSION END PROCESSING (E.G. KILL A SESSION IF    00070000
*              THE SESSION PROC HAS ABENDED).                           00080000
*                                                                       00090000
* ON ENTRY:                                                             00100000
*                                                                       00110000
*    R15 = ENTRY POINT ADDRESS                                          00120000
*    R14 = RETURN ADDRESS                                               00130000
*    R13 = AVAILABLE SAVE AREA                                          00140000
*    R11 = ICVT ADDRESS                                                 00150000
*    R10 = ITASK ADDRESS                                                00160000
*    R01 = IWE ADDRESS (WORK ELEMENT)                                   00170000
*                                                                       00180000
* ON EXIT:                                                              00190000
*                                                                       00200000
*    R15 = 0                                                            00210000
*    R00 = 0                                                            00220000
*    R01 = 0                                                            00230000
*                                                                       00240000
*    ALL OTHER REGISTERS ARE RESTORED                                   00250000
*                                                                       00260000
**<DOC-OFF>************************************************************ 00270000
                                                                        00280000
         EJECT ,                                                        00290000
*********************************************************************** 00300000
*                                                                       00310000
* MAINTENANCE:                                                          00320000
*                                                                       00330000
*   08/01/93 RANDY WITEK                                                00340000
*                                                                       00350000
*********************************************************************** 00360000
                                                                        00370000
         EQUS  ,                  GENERAL EQUATES                       00380000
                                                                        00390000
RICVT    EQU   R11                                                      00400000
RITASK   EQU   R10                                                      00410000
RIVTAM   EQU   R9                                                       00420000
RIACB    EQU   R8                                                       00430000
RIRPL    EQU   R7                                                       00440000
RIWE     EQU   R6                                                       00450000
RCID     EQU   R5                                                       00460000
                                                                        00470000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00480000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00490000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00500000
         USING IACB,RIACB         ESTABLISH ADDRESSABILITY              00510000
         USING IRPL,RIRPL         ESTABLISH ADDRESSABILITY              00520000
         USING IWEVTAM,RIWE       ESTABLISH ADDRESSABILITY              00530000
                                                                        00540000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00550000
WRK256   DS    XL256              GENERAL WORKAREA                      00560000
RETR15   DS    F                  RETURN CODE VALUE                     00570000
RETR0    DS    F                  RETURN REGISTER 0                     00580000
RETR1    DS    F                  RETURN REGISTER 1                     00590000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00600000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00610000
                                                                        00620000
         $MSGDFT PREFIX=ICTPID,                                        +00630000
               COMPID='VTM',                                           +00640000
               TABLE=*#MSGS,                                           +00650000
               WORKA=0,                                                +00660000
               MF=(E,WRK256),                                          +00670000
               PRINT=NOGEN                                              00680000
                                                                        00690000
IVTMNKIL #ENTER BASE=R12,         ENTRY LINKAGE                        +00700000
               AMODE=31,                                               +00710000
               PREG=(RIWE),                                            +00720000
               RMODE=ANY                                                00730000
                                                                        00740000
*---------------------------------------------------------------------- 00750000
* SESSION KILL WORK ELEMENT                                             00760000
*---------------------------------------------------------------------- 00770000
                                                                        00780000
         L     RCID,IWEXLCID      VTAM CID OF SESSION TO BE KILLED      00790000
         L     RIACB,IWEXLACB     VTAM ACB OF SESSION TO BE KILLED      00800000
                                                                        00810000
*                                                                       00820000
* OBTAIN RPL FOR CLSDST/TERMSESS OPERATION                              00830000
*---------------------------------------------------------------------- 00840000
                                                                        00850000
         $VTAM GETRPL,                                                 +00860000
               AREA=IVTRPACT,                                          +00870000
               ERRET=ERR$VTAM,                                         +00880000
               MF=(E,MFE_LIST)    ACQUIRE AN IRPL                       00890000
                                                                        00900000
         LR    RIRPL,R1           ESTABLISH ADDRESSIBILITY              00910000
         LA    R1,IVTWEQ          MAIN TASK WORK QUEUE                  00920000
         ST    R1,IRP@WEQ         WILL RECEIVE THE RPL COMPLETION       00930000
         ST    RCID,IRPARG        SAVE CID OF SESSION TO BE KILLED      00940000
                                                                        00950000
*                                                                       00960000
* DETERMINE IF WE ARE KILLING A PENDING BIND OR AN EXISTING SESSION     00970000
*---------------------------------------------------------------------- 00980000
                                                                        00990000
         TM    ILF1,ILF1BIND        IS THIS A PENDING BIND?             01000000
         BNO   KILLSESS             BRANCH IF NOT                       01010000
         MVC   RPLOSENS(4),IWEXLSNS SET ANY PROVIDED SENSE INFO         01020000
         TM    IVT05DAT+2,X'04'     SUPPORT FOR TERMSESS UNBIND?        01030000
         BO    KILLUBND             BRANCH IF YES                       01040000
                                                                        01050000
         SESSIONC RPL=(RIRPL),                                         +01060000
               ACB=(RIACB),                                            +01070000
               ARG=(RCID),                                             +01080000
               STYPE=RESP,                                             +01090000
               CONTROL=BIND         KILL THE PENDING BIND               01100000
                                                                        01110000
         B     COMMCHK              GO TO COMMON CHECK ROUTINE          01120000
                                                                        01130000
KILLUBND DS    0H                                                       01140000
                                                                        01150000
         OC    RPLOSENS(4),RPLOSENS IS THERE PROVIDED SENSE INFO?       01160000
         BNZ   KILLTSON             BRANCH IF YES                       01170000
                                                                        01180000
         TERMSESS RPL=(RIRPL),                                         +01190000
               ACB=(RIACB),                                            +01200000
               ARG=(RCID),                                             +01210000
               OPTCD=(UNBIND,ASY)   KILL THE PENDING BIND               01220000
                                                                        01230000
         B     COMMCHK              GO TO COMMON CHECK ROUTINE          01240000
                                                                        01250000
KILLTSON DS    0H                                                       01260000
                                                                        01270000
         TERMSESS RPL=(RIRPL),                                         +01280000
               ACB=(RIACB),                                            +01290000
               ARG=(RCID),                                             +01300000
               PARMS=(SONCODE=X'FE'),                                  +01310000
               OPTCD=(UNBIND,ASY,SONCODE)                               01320000
                                                                        01330000
         B     COMMCHK              GO TO COMMON CHECK ROUTINE          01340000
                                                                        01350000
*                                                                       01360000
* DETERMINE IF WE ARE THE PLU OR SLU SESSION PARTNER                    01370000
*---------------------------------------------------------------------- 01380000
                                                                        01390000
KILLSESS DS    0H                                                       01400000
                                                                        01410000
         ICM   R1,15,IWEXLSLU     0=PLU, !0=SLU                         01420000
         BNZ   KILLSLU            BRANCH IF WE ARE THE SLU              01430000
                                                                        01440000
*                                                                       01450000
* KILL SESSION WHERE WE ARE THE PRIMARY LU (PLU)                        01460000
*---------------------------------------------------------------------- 01470000
                                                                        01480000
         CLSDST RPL=(RIRPL),                                           +01490000
               ACB=(RIACB),                                            +01500000
               ARG=(RCID),                                             +01510000
               OPTCD=(RELEASE,ASY) END THE SESSION                      01520000
                                                                        01530000
         B     COMMCHK            GO TO COMMON CHECK ROUTINE            01540000
                                                                        01550000
*                                                                       01560000
* KILL SESSION WHERE WE ARE ACTING AS THE SECONDARY LU (SLU)            01570000
*---------------------------------------------------------------------- 01580000
                                                                        01590000
KILLSLU  DS    0H                                                       01600000
                                                                        01610000
         TM    IVT05DAT+2,X'04'   SUPPORT FOR TERMSESS UNBIND?          01620000
         BNO   KILLSLUX           BRANCH IF NOT                         01630000
                                                                        01640000
         TERMSESS RPL=(RIRPL),                                         +01650000
               ACB=(RIACB),                                            +01660000
               ARG=(RCID),                                             +01670000
               PARMS=(SONCODE=X'0F'),     (CLEANUP)                    +01680000
               OPTCD=(UNBIND,SONCODE,ASY) END THE SESSION (UNBIND)      01690000
                                                                        01700000
         B     COMMCHK            GO TO COMMON CHECK ROUTINE            01710000
                                                                        01720000
KILLSLUX DS    0H                                                       01730000
                                                                        01740000
         TERMSESS RPL=(RIRPL),                                         +01750000
               ACB=(RIACB),                                            +01760000
               ARG=(RCID),                                             +01770000
               OPTCD=(UNCOND,ASY) END THE SESSION (UNCOND)              01780000
                                                                        01790000
         B     COMMCHK            GO TO COMMON CHECK ROUTINE            01800000
                                                                        01810000
*                                                                       01820000
* PERFORM CLSDST/TERMSESS PHASE-1 CHECK                                 01830000
*---------------------------------------------------------------------- 01840000
                                                                        01850000
COMMCHK  DS    0H                                                       01860000
                                                                        01870000
         STM   R15,R0,IRPR15      SAVE VTAM RETURN REGISTERS            01880000
                                                                        01890000
         $VTAM CHECKPH1,          CHECK REQUEST ACCEPTANCE             +01900000
               AREA=(RIRPL),                                           +01910000
               MF=(E,MFE_LIST)                                          01920000
                                                                        01930000
*---------------------------------------------------------------------- 01940000
* RETURN TO MAIN TASK MAINLINE                                          01950000
*---------------------------------------------------------------------- 01960000
                                                                        01970000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 01980000
                                                                        01990000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    02000000
                                                                        02010000
*---------------------------------------------------------------------- 02020000
* ERROR ROUTINES                                                        02030000
*---------------------------------------------------------------------- 02040000
                                                                        02050000
ERR$VTAM DS    0H                                                       02060000
                                                                        02070000
         $ABEND ABE_VTDIAG,                                            +02080000
               SCOPE=PCB,                                              +02090000
               TITLE='$VTAM FAILURE'                                    02100000
                                                                        02110000
*---------------------------------------------------------------------- 02120000
*  CONSTANTS AND LITERALS                                               02130000
*---------------------------------------------------------------------- 02140000
                                                                        02150000
         LTORG ,                                                        02160000
         PRINT NOGEN                                                    02170000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                02180000
         ISTDBIND ,               VTAM BIND IMAGE                       02190000
         ICVT  ,                  INTEGRATOR CVT                        02200000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   02210000
         IRPL ,                   INTEGRATOR VTAM RPL+                  02220000
         IACB ,                   INTEGRATOR VTAM ACB+                  02230000
         INIB ,                   INTEGRATOR VTAM NIB+                  02240000
         ISESS ,                  INTEGRATOR SESSION BLOCK              02250000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            02260000
         ITASK ,                  INTEGRATOR TASK BLOCK                 02270000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          02280000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       02290000
         EVCODES ,                INTEGRATOR EVENT CODES                02300000
         ABCODES ,                INTEGRATOR $ABEND CODES               02310000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     02320000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        02330000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             02340000
         END   ,                                                        02350000

ITBCOLMN TITLE 'TABLE SERVICES - COLUMN INFO'                           00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE:  ITBCOLMN - Table services - column info                     00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine implements the TBCOLUMN table service. It             00080000
*    allows an application to determine the total number of             00090000
*    columns contained in an open table, and to acquire                 00100000
*    detailed column information by either column name or               00110000
*    column number.                                                     00120000
*                                                                       00130000
*    For all non-error completions, the total number of columns         00140000
*    is always returned.  The status return word and column             00150000
*    definition return areas are zeroed for each column entry           00160000
*    considered.  Then, if the column designated is a member of         00170000
*    the given table, the appropriate data is placed in those           00180000
*    areas.                                                             00190000
*                                                                       00200000
*    The format of the status return word is described by the           00210000
*    STATRET local mapping.  The format of a column definition          00220000
*    entry is described by the table services TBCOLDEF mapping.         00230000
*                                                                       00240000
*                                                                       00250000
* ON ENTRY:                                                             00260000
*                                                                       00270000
*    R1  contains the address of a parameter list described by          00280000
*        the @TBCOLMN mapping macro                                     00290000
*                                                                       00300000
*                                                                       00310000
* ON EXIT:                                                              00320000
*                                                                       00330000
*    R15 contains one of the following return codes                     00340000
*    R0  may contain an associated reason code or other data            00350000
*                                                                       00360000
*        RC00 - status returned for all designated columns              00370000
*                                                                       00380000
*               R0 - number of table columns                            00390000
*                                                                       00400000
*        RC04 - at least one of the designated columns is not           00410000
*               defined in the table                                    00420000
*                                                                       00430000
*               R0 - number of table columns                            00440000
*                                                                       00450000
*        RC08 - reserved                                                00460000
*                                                                       00470000
*        RC12 - request in error                                        00480000
*                                                                       00490000
*               RSN04 - invalid table token supplied                    00500000
*                                                                       00510000
*        RC16 - object management error encountered                     00520000
*                                                                       00530000
*               R1 - @PUSHERR summary of service rtn failure            00540000
*                                                                       00550000
*               RSN12 - base table not accessable                       00560000
*                                                                       00570000
**<DOC-OFF>****************************************************         00580000
                                                                        00590000
         EJECT                                                          00600000
***************************************************************         00610000
*                                                                       00620000
* MAINTENANCE:                                                          00630000
*                                                                       00640000
*    02/25/95 R. Turgeon                                                00650000
*             Initial version                                           00660000
*                                                                       00670000
***************************************************************         00680000
                                                                        00690000
         EJECT                                                          00700000
***************************************************************         00710000
*                                                                       00720000
*   Working storage area                                                00730000
*                                                                       00740000
***************************************************************         00750000
WORKAREA DSECT                                                          00760000
                                                                        00770000
         @WORK ,                  STANDARD WORKAREA                     00780000
                                                                        00790000
FLAGS    DS    X                  FLAG BYTE                             00800000
F_COLERR EQU   X'80'                 SOME COLUMN WAS NOT RECOGNIZED     00810000
                                                                        00820000
ALETTABL DS    F                  BASE TABLE OBJECT ALET                00830000
BASETABL DS    A                  BASE TABLE ADDRESS                    00840000
                                                                        00850000
WORKFREE DS    0D                 AVAILABLE TO SERVICE ROUTINES         00860000
WORKLEN  EQU   *-WORKAREA         LENGTH OF WORKAREA                    00870000
                                                                        00880000
         EJECT                                                          00890000
***************************************************************         00900000
*                                                                       00910000
* MAPPING: STATRET - column status return area format                   00920000
*                                                                       00930000
***************************************************************         00940000
STATRET  DSECT ,                  STATUS RETURN AREA                    00950000
STATCOL# DS    H                  COLUMN NUMBER                         00960000
STATRSV1 DS    H                  RESERVED                              00970000
STATRETL EQU   *-STATRET          STATUS RETURN AREA LENGTH             00980000
                                                                        00990000
         EJECT                                                          01000000
         @TBCOLMN ,               PARAMETER LIST FORMAT                 01010000
                                                                        01020000
         EJECT                                                          01030000
         $TOKEN ,                 SPACE TOKEN                           01040000
                                                                        01050000
         EJECT                                                          01060000
         TBTOKEN ,                TABLE TOKEN                           01070000
                                                                        01080000
         EJECT                                                          01090000
         $STG TYPE=DSECT          FREE STORAGE MGMT                     01100000
                                                                        01110000
         EJECT                                                          01120000
         @TABLE ,                 TABLE OBJECT PREFIX                   01130000
                                                                        01140000
         EJECT                                                          01150000
         @TBCOLDF ,               COLUMN DEFINITION                     01160000
                                                                        01170000
         EJECT                                                          01180000
         COLHDR ,                 COLUMN DEFINITION HEADER / LINKAGE    01190000
                                                                        01200000
         EJECT                                                          01210000
         OIE   ,                  OBJECT INDEX ENTRY ($OBJECT INLINE)   01220000
                                                                        01230000
         EJECT                                                          01240000
         SPCBLOCK ,               OBJECT SPACE BLOCK ($OBJECT INLINE)   01250000
                                                                        01260000
         EJECT                                                          01270000
         EQUS  LINKAGE=VCON                                             01280000
                                                                        01290000
         EJECT                                                          01300000
ITBCOLMN @ENTER WORKA=(WORKAREA,WORKLEN),ASC=AR                         01310000
                                                                        01320000
         EJECT                                                          01330000
***************************************************************         01340000
*                                                                       01350000
*   Fetch request parameters, general initialization                    01360000
*                                                                       01370000
***************************************************************         01380000
                                                                        01390000
         LAM   R1,R7,MFE_LIST     PRIMARY SPACE ADDRESSING              01400000
                                                                        01410000
         LR    R7,R1              PARAMETER LIST                        01420000
         USING TBCOLUMN,R7        TBCOLUMN SERVICE                      01430000
                                                                        01440000
         L     R6,TBCOTOKN        LOCATE TABLE TOKEN                    01450000
         L     R6,0(,R6)          TOKEN IS A PTR                        01460000
         USING TBTOKEN,R6         TABLE TOKEN ADDRESSABILITY LOF        01470000
         CLC   TTOKTAG,=CL8'TBTOKEN'                                    01480000
         BNE   ETBTOKEN                                                 01490000
                                                                        01500000
         EJECT                                                          01510000
***************************************************************         01520000
*                                                                       01530000
*   Acquire base table object and validate                              01540000
*                                                                       01550000
***************************************************************         01560000
                                                                        01570000
         $OBJECT ACCESS,INTENT=QUERY,OTOKEN=TTOKTABL,                  X01580000
               INLINE=YES                                               01590000
         BZ    TBLOBJOK           LONG FORM ONLY FOR ERROR LOGGING      01600000
                                                                        01610000
         $OBJECT ACCESS,INTENT=QUERY,OTOKEN=TTOKTABL,                  X01620000
               SHRPAGE=WORKFREE,MF=(E,MFE_LIST)                         01630000
         BNZ   ETABLOBJ           FAIL IF NOT                           01640000
                                                                        01650000
TBLOBJOK DS    0H                                                       01660000
                                                                        01670000
*-------------------------------------------------------------          01680000
*   Table object located, now verify and anchor                         01690000
*-------------------------------------------------------------          01700000
                                                                        01710000
         STAM  AR1,AR1,ALETTABL   BASE TABLE ALET                       01720000
         LAE   R11,0(,R1)         OBJECT ADDRESS                        01730000
         USING TABLE,R11          TABLE BASE                            01740000
         CLC   TBLTAG,=CL8'TBTABLE'                                     01750000
         BNE   ETABLOBJ                                                 01760000
         ST    R11,BASETABL       TABLE BASE                            01770000
                                                                        01780000
         EJECT                                                          01790000
***************************************************************         01800000
*                                                                       01810000
*   For each column designated, match it to the corresponding           01820000
*   base table definition                                               01830000
*                                                                       01840000
***************************************************************         01850000
                                                                        01860000
         ICM   R4,15,TBCO#COL     NUMBER OF COLUMNS SUPPLIED            01870000
         BZ    NORMRET            DONE IF NONE                          01880000
         LA    R5,TBCOCENT        BEGINNING OF COLUMN ENTRY SECTION     01890000
         USING TBCOCID,R5         CHOKE UP ON ADDRESSABILITY            01900000
                                                                        01910000
PROCENT  DS    0H                                                       01920000
         ICM   R2,15,TBCOCRET     STATUS RETURN AREA                    01930000
         BZ    *+10               NOT PROVIDED                          01940000
         XC    0(STATRETL,R2),0(R2)   CLEAR                             01950000
                                                                        01960000
         ICM   R2,15,TBCOCDEF     COLUMN DEFINITION RETURN AREA         01970000
         BZ    *+10               NOT PROVIDED                          01980000
         XC    0(TBCOLDFL,R2),0(R2)   CLEAR                             01990000
                                                                        02000000
*--------------------------------------------------------------         02010000
*   Match column descriptor (name or number) to table column            02020000
*--------------------------------------------------------------         02030000
                                                                        02040000
         L     R1,TBCOCID         R1 <== COLUMN IDENTIFIER              02050000
         LAE   R1,0(R1,0)         ALWAYS RESIDES IN PSPACE              02060000
         BAS   R14,CLOCATE        LOCATE COLHDR/COLDEF                  02070000
         LTR   R15,R15            REQUESTED ENTRY MATCHED?              02080000
         BZ    MATCH              ELSEWHERE IF SO                       02090000
                                                                        02100000
         OI    FLAGS,F_COLERR     INDICATE MISMATCH                     02110000
         B     ADVANCE            ADVANCE TO NEXT ENTRY                 02120000
                                                                        02130000
*--------------------------------------------------------------         02140000
*   Return status and/or column definition entry in user stg            02150000
*--------------------------------------------------------------         02160000
                                                                        02170000
MATCH    DS    0H                                                       02180000
         LAE   R8,0(,R1)          COLUMN HEADER / COLUMN DEFINITION     02190000
CHDR     USING COLHDR,R8                                                02200000
CDEF     USING TBCOLDEF,CHDR.COLDEF                                     02210000
                                                                        02220000
         ICM   R2,15,TBCOCRET     STATUS RETURN AREA                    02230000
         BZ    FSTAT              SKIPPED                               02240000
         L     R0,CHDR.COLNUMBR   COLUMN NUMBER                         02250000
         STH   R0,STATCOL#-STATRET(,R2)                                 02260000
                                                                        02270000
FSTAT    DS    0H                                                       02280000
         ICM   R2,15,TBCOCDEF     COLUMN DEFINITION RETURN AREA         02290000
         BZ    FDEF               SKIPPED                               02300000
         MVC   0(TBCOLDFL,R2),CDEF.TBCOLDEF                             02310000
                                                                        02320000
FDEF     DS    0H                                                       02330000
         DROP  CDEF,CHDR          TBCOLDEF, COLHDR                      02340000
                                                                        02350000
*--------------------------------------------------------------         02360000
*   Return status and/or column definition entry in user stg            02370000
*--------------------------------------------------------------         02380000
                                                                        02390000
ADVANCE  DS    0H                                                       02400000
         LA    R5,TBCOCID+TBCOCL  NEXT COLUMN ENTRY                     02410000
         BCT   R4,PROCENT         PROCESS ALL ENTRIES                   02420000
                                                                        02430000
         EJECT                                                          02440000
***************************************************************         02450000
*                                                                       02460000
*   Completion notification, error handling and posting                 02470000
*                                                                       02480000
***************************************************************         02490000
                                                                        02500000
NORMRET  DS    0H                                                       02510000
         LA    R15,RC00           ASSUME ALL COLUMNS RECOGNIZED         02520000
         TM    FLAGS,F_COLERR     ASSUMPTION CORRECT?                   02530000
         BNO   *+8                SKIP IF SO                            02540000
         LA    R15,RC04           AT LEAST ONE COLUMN NOT RECOGNIZED    02550000
                                                                        02560000
         L     R0,TBL#COLS        R0 <== RETURN COLUMN COUNT            02570000
         B     EXIT                                                     02580000
                                                                        02590000
                                                                        02600000
*------- logical request errors -------------------------------         02610000
                                                                        02620000
ETBTOKEN DS    0H                 INVALID TABLE TOKEN SUPPLIED          02630000
         LA    R0,RSN04                                                 02640000
         B     ERR_REQ                                                  02650000
                                                                        02660000
ERR_REQ  DS    0H                 REQUEST IN ERROR                      02670000
         LA    R15,RC12                                                 02680000
         B     EXIT                                                     02690000
                                                                        02700000
                                                                        02710000
*------- object management errors -----------------------------         02720000
                                                                        02730000
ETABLOBJ DS    0H                 COULD NOT ACCESS BASE TABLE           02740000
         LA    R2,RSN12                                                 02750000
         B     ERR_OBJ                                                  02760000
                                                                        02770000
ERR_OBJ  DS    0H                                                       02780000
         @PUSHERR ,               PRESERVE SERVICE ROUTINE STATUS       02790000
                                                                        02800000
         LR    R0,R2              ASSERT LOCAL REASON CODE              02810000
         LA    R15,RC16                                                 02820000
                                                                        02830000
*--------------------------------------------------------------         02840000
*   Return to caller                                                    02850000
*--------------------------------------------------------------         02860000
                                                                        02870000
EXIT     DS    0H                                                       02880000
         XC    MFE_LIST(4*4),MFE_LIST                                   02890000
         LAM   R14,R2,MFE_LIST                                          02900000
                                                                        02910000
         @EXIT ,                                                        02920000
                                                                        02930000
         EJECT                                                          02940000
***************************************************************         02950000
*                                                                       02960000
* ROUTINE: CLOCATE - Locate column header / column definition           02970000
*                                                                       02980000
* ON ENTRY:                                                             02990000
*                                                                       03000000
*    A/R1  Column designation                                           03010000
*                                                                       03020000
* ON EXIT:                                                              03030000
*                                                                       03040000
*    R15 contains one of the following return codes                     03050000
*                                                                       03060000
*        RC00 - column matched                                          03070000
*                                                                       03080000
*               A/R1 - COLHDR / COLDEF origin                           03090000
*                                                                       03100000
*        RC04 - column not matched                                      03110000
*                                                                       03120000
***************************************************************         03130000
                                                                        03140000
CLOCATE  DS    0H                                                       03150000
         BAKR  R14,0              PRESERVE CALLING ENVIRONMENT          03160000
                                                                        03170000
         L     R4,TBCOMETH        FETCH METHOD                          03180000
         SLL   R4,2               CONVERT CODE FOR BRANCH TABLE         03190000
         L     R3,0(,R1)          COLUMN NUMBER IF GIVEN BY PTR         03200000
                                                                        03210000
*--------------------------------------------------------------         03220000
*   Scan column list attached to table                                  03230000
*--------------------------------------------------------------         03240000
                                                                        03250000
         LAE   R8,TBLCOLST-(COLNEXT-COLHDR) PREP FOR COLHDR/COLDEF SCAN 03260000
CHDR     USING COLHDR,R8                                                03270000
CDEF     USING TBCOLDEF,CHDR.COLDEF                                     03280000
                                                                        03290000
CLOCSCAN DS    0H                                                       03300000
         ICM   R8,15,CHDR.COLNEXT ACQUIRE NEXT COLHDR/COLDEF OFFSET     03310000
         BZ    CLOCFAIL           SCAN COMPLETE                         03320000
         LA    R8,TABLE(R8)       CONVERT OFFLINK TO ADDRESS            03330000
                                                                        03340000
         B     *+4(R4)            COLUMN SEARCH METHOD                  03350000
         B     CLOCFAIL              NONE PROVIDED                      03360000
         B     CLOCNAME              BY COLUMN NAME                     03370000
         B     CLOCNUM               BY COLUMN NUMBER                   03380000
                                                                        03390000
*--------------------------------------------------------------         03400000
*   Match column by column name                                         03410000
*--------------------------------------------------------------         03420000
                                                                        03430000
CLOCNAME DS    0H                                                       03440000
         CLC   CDEF.TBCNAME,0(R1)    MATCH EXTERNAL NAME                03450000
         BE    CLOCHIT                                                  03460000
         CLC   CDEF.TBCSNAME,0(R1)   MATCHING INTERNAL NAME             03470000
         BE    CLOCHIT                                                  03480000
         B     CLOCSCAN                                                 03490000
                                                                        03500000
*--------------------------------------------------------------         03510000
*   Match column by column number                                       03520000
*--------------------------------------------------------------         03530000
                                                                        03540000
CLOCNUM  DS    0H                                                       03550000
         C     R1,CHDR.COLNUMBR   MATCH DIRECTLY SPECIFIED COL #        03560000
         BE    CLOCHIT                                                  03570000
         C     R3,CHDR.COLNUMBR   MATCH REMOTE COL #                    03580000
         BE    CLOCHIT                                                  03590000
         B     CLOCSCAN                                                 03600000
                                                                        03610000
*--------------------------------------------------------------         03620000
*   Return COLHDR / COLDEF and match status to caller                   03630000
*--------------------------------------------------------------         03640000
                                                                        03650000
CLOCHIT  DS    0H                                                       03660000
         LA    R15,RC00           MATCHING COLHDR / COLDEF FOUND        03670000
         LAE   R1,CHDR.COLHDR     RETURN COMPOSIT ENTRY                 03680000
         B     CLOCRET                                                  03690000
                                                                        03700000
CLOCFAIL DS    0H                                                       03710000
         LA    R15,RC04           NO MATCH                              03720000
                                                                        03730000
CLOCRET  DS    0H                                                       03740000
         PR    ,                  RETURN                                03750000
         DROP  CDEF,CHDR          TBCOLDEF, COLHDR                      03760000
                                                                        03770000
         EJECT                                                          03780000
***************************************************************         03790000
*                                                                       03800000
*   Local read-only data areas, etc.                                    03810000
*                                                                       03820000
***************************************************************         03830000
         LTORG ,                                                        03840000
         END   ,                                                        03850000

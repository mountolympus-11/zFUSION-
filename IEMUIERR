IEMUIERR TITLE '- EMULATOR INBOUND IMAGE REJECT NOTIFICATION'           00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE:  IEMUIERR - EMULATOR INBOUND IMAGE REJECT NOTIFICATION       00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THIS ROUTINE IS INVOKED WHEN AN IMAGE SENT FROM VDEVICE TO         00080000
*    HOST APPLICATION IS NOT ACCEPTED.  THE ISLUIMIG ROUTINE            00090000
*    RETURN AND REASON CODE RECCOMENDATIONS PROVIDED AS INPUT           00100000
*    DESCRIBE THE REASON FOR REJECTION.  WHEN THE REJECTION IS          00110000
*    DUE TO AN UNRECOVERABLE ERROR (PROGRAMMING ERROR, ETC)             00120000
*    THE EMULATOR VDEVICE IS PROVIDED A TERMINATION RETURN AND          00130000
*    REASON CODE, AND OPTIONALLY A DIAGNOSTIC MESSAGE. THE              00140000
*    ACTIONS TAKEN FOR RECOVERABLE ERRORS ARE DESCRIBED                 00150000
*    BELOW:                                                             00160000
*                                                                       00170000
*       RC04: THE INPUT IMAGE RECEIVED FROM THE EMULATOR DOES           00180000
*             NOT HAVE THE SAME SEQUENCE NUMBER AS THAT                 00190000
*             ASSIGNED TO THE LAST IMAGE PROVIDED BY THE APPL.          00200000
*             AN XIMAGE.READIMG REQUEST IS MADE TO THE VDEVICE          00210000
*             TO PROVIDE A CURRENT IMAGE IN STANDARD                    00220000
*             (UNENCODED) FORMAT.                                       00230000
*                                                                       00240000
*       RC08: AN INPUT IMAGE WAS RECEIVED FROM THE EMULATOR             00250000
*             VDEVICE WHEN THE VDEVICE DID NOT OWN THE                  00260000
*             DIRECTION.  AN XIMAGE.STATECHG REQUEST IS MADE TO         00270000
*             THE VDEVICE TO RING THE BELL, RAISE THE "MINUS            00280000
*             FUNCTION" INDICATOR, AND TO REFRESH THE VDEVICE           00290000
*             STATES FROM LOCALLY MAINTAINED VALUES.                    00300000
*                                                                       00310000
*                                                                       00320000
* ON ENTRY:                                                             00330000
*                                                                       00340000
*    R1  CONTAINS THE ADDRESS OF A PARAMETER LIST CONSTRUCTED           00350000
*        AS FOLLOWS                                                     00360000
*                                                                       00370000
*           +00 - ADDR OF SLUHANDL                                      00380000
*           +04 - ISLUIMGI RETURN CODE                                  00390000
*           +08 - ISLUIMGI REASON CODE                                  00400000
*                                                                       00410000
*                                                                       00420000
* ON EXIT:                                                              00430000
*                                                                       00440000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES                     00450000
*                                                                       00460000
*        RC00 - ERROR CORRECTION PROCEDURE INVOKED                      00470000
*                                                                       00480000
*        RCNN - UNCORRECTABLE ERROR, THE ISLUIMGI RETURN CODE           00490000
*               PROVIDED ON INPUT IS REFLECTED                          00500000
*                                                                       00510000
*        RC24 - THIS ROUTINE COULD NOT ACCESS THE VIRTUAL               00520000
*               DEVICE ($XPBUFR XMIT FAILURE).  THE LOGICAL             00530000
*               SESSION IS PRESUMED TO HAVE TERMINATED.                 00540000
*                                                                       00550000
**<DOC-OFF>****************************************************         00560000
                                                                        00570000
         EJECT                                                          00580000
         #WORK ,                                                        00590000
                                                                        00600000
RETRSN   DS    0F                 ISLUIMGI RETURN AND REASON CODES      00610000
RETC     DS    F                     RETCODE                            00620000
RSNC     DS    F                     RSNCODE                            00630000
                                                                        00640000
LCLRETC  DS    F                  OUR RETURN CODE                       00650000
                                                                        00660000
STATREGS DS    3F                 R15-R1 STATUS AREA                    00670000
REGSAVE  DS    16F                LOCAL SAVEAREA                        00680000
                                                                        00690000
         @XH   TYPE=BLOCK         STANDARD RU (MODEL) HEADER            00700000
                                                                        00710000
         XIMAGE DSECT=NO          XIMAGE REQUEST/RESPONSE BLOCK         00720000
                                                                        00730000
         #ENDWORK ,                                                     00740000
                                                                        00750000
         EJECT                                                          00760000
         SLUHANDL ,               SLU SESSION HANDLE                    00770000
                                                                        00780000
         EJECT                                                          00790000
         SESSIMAG ,               SESSION IMAGING/RECORDING COMM AREA   00800000
                                                                        00810000
         EJECT                                                          00820000
         $TSEND DSECT=YES         CROSS WU MESSAGING PLIST              00830000
                                                                        00840000
         EJECT                                                          00850000
         REQHDR ,                 COMMUNICATION PROTOCOLS, CODES, ETC.  00860000
                                                                        00870000
         EJECT                                                          00880000
         ABCODES PRINT=NOGEN                                            00890000
                                                                        00900000
         MSGCODES ,                                                     00910000
                                                                        00920000
         EQUS ,                                                         00930000
                                                                        00940000
         EJECT                                                          00950000
IEMUIERR #ENTER PREG=R8                                                 00960000
                                                                        00970000
         USING ITASK,R10          TASK MODE OR BETTER                   00980000
                                                                        00990000
         EJECT                                                          01000000
***************************************************************         01010000
*                                                                       01020000
*   FETCH PASSED PARAMETERS, PREPARE FOR EMULATOR NOTIFICATION          01030000
*                                                                       01040000
***************************************************************         01050000
         LM    R2,R4,0(R8)        FETCH SLUHANDL, RETC, RSNC            01060000
         LR    R8,R2              ACCEPT SLUHANDL                       01070000
         USING SLUHANDL,R8        LIFE OF FUNCTION                      01080000
         STM   R3,R4,RETRSN       RETAIN RETC AND RSNC                  01090000
                                                                        01100000
         LTR   R3,R3              NORMAL COMPLETION REPORTED?           01110000
         BZ    RETURN             QUICK OUT IF SO                       01120000
                                                                        01130000
         L     R9,SLHSIMAG        LOCATE SESSIMAG                       01140000
         USING SESSIMAG,R9                                              01150000
                                                                        01160000
*--------------------------------------------------------------         01170000
*   ANALYZE COMPLETION STATUS                                           01180000
*--------------------------------------------------------------         01190000
         L     R15,RETC           FETCH EMULATOR COMPLETION CODE        01200000
         ST    R15,LCLRETC        PREPARE FOR REFLECT BACK              01210000
                                                                        01220000
         B     *+4(R15)           ANALYZE COMPLETION                    01230000
         B     RETURN                RC00 CPT:  NORMAL COMPLETION       01240000
         B     WSEQ                  RC04 RCVY: SEQUENCE CONFLICT       01250000
         B     WDIR                  RC08 RCVY: DIRECTION VIOLATION     01260000
         B     EREQUEST              RC12 FAIL: REQUEST IN ERROR        01270000
         B     EREQUEST              RC16 FAIL: IMAGING ERROR           01280000
         B     EREQUEST              RC20 FAIL: INVALID HANDLE          01290000
         B     EREQUEST              RC24 FAIL: *UNDEFINED*             01300000
         B     EREQUEST              RC28 FAIL: *UNDEFINED*             01310000
                                                                        01320000
*--------------------------------------------------------------         01330000
*   SEQUENCE # CONFLICT, CORRECTIVE ACTION IS IMAGE-REREAD              01340000
*--------------------------------------------------------------         01350000
WSEQ     DS    0H                                                       01360000
         LA    R0,READIMG         READ-IMAGE XIMG SUBFUNCTION           01370000
         SR    R1,R1              RESPONSE BLOCK ONLY                   01380000
         BAS   R14,RESPINIT       ALLOCATE RESPONSE BLOCK               01390000
         LR    R5,R1              ADDRESSABLE RESPONSE                  01400000
         USING XIMGDATA,R5                                              01410000
                                                                        01420000
         MVC   XIMGSEQ,SEISEQ#    REMIND COOP OF SEQ#                   01430000
                                                                        01440000
         MVC   LCLRETC,=A(RC00)   RETRY                                 01450000
         LA    R1,XIMAGE          RESPONSE BLOCK                        01460000
         B     RESPOND            FORMAT RESPONSE                       01470000
         DROP  R5                 XIMAGE                                01480000
                                                                        01490000
*--------------------------------------------------------------         01500000
*   VDEVICE VIOLATES DIRECTION, VDEVICE TO RAISE "MINUS FUNC"           01510000
*--------------------------------------------------------------         01520000
WDIR     DS    0H                                                       01530000
         LA    R0,STATECHG        REFLECT STATE CHANGE TO OFFENDER      01540000
         SR    R1,R1              RESPONSE BLOCK ONLY                   01550000
         BAS   R14,RESPINIT       ALLOCATE RESPONSE BLOCK               01560000
         LR    R5,R1              ADDRESSABLE RESPONSE                  01570000
         USING XIMGDATA,R5                                              01580000
                                                                        01590000
         MVC   XIMGSEQ,SEISEQ#    REMIND COOP OF SEQ#                   01600000
         MVI   XIMGSTA,XIMG_FNC+XIMG_BEL    RAISE OIA INDICATION        01610000
                                                                        01620000
         MVC   LCLRETC,=A(RC00)   RETRY                                 01630000
         LA    R1,XIMAGE          RESPONSE BLOCK                        01640000
         B     RESPOND            FORMAT RESPONSE                       01650000
         DROP  R5                 XIMAGE                                01660000
                                                                        01670000
*--------------------------------------------------------------         01680000
*   SESSION FAILURE, NOTIFY VDEVICE OF TERMINATION                      01690000
*--------------------------------------------------------------         01700000
EREQUEST DS    0H                                                       01710000
         LA    R0,STATECHG        REFLECT STATE CHANGE TO OFFENDER      01720000
         LA    R1,256             REQUEST BLOCK PLUS MESSAGES           01730000
         BAS   R14,RESPINIT       ALLOCATE RESPONSE BLOCK               01740000
         LR    R5,R1              ADDRESSABLE RESPONSE                  01750000
         USING XIMGDATA,R5                                              01760000
                                                                        01770000
         MVC   XIMGRETC,RETC      FAILING RETCODE                       01780000
         MVC   XIMGRSNC,RSNC      FAILING RSNCODE                       01790000
         MVI   XIMGSTA,SEIF_GNE   SESSION TERMINATING                   01800000
                                                                        01810000
         LA    R1,XIMAGE          RESPONSE BLOCK                        01820000
         B     RESPOND            FORMAT RESPONSE                       01830000
         DROP  R5                 XIMAGE                                01840000
                                                                        01850000
         EJECT                                                          01860000
***************************************************************         01870000
*                                                                       01880000
*   SEND RESPONSE TO REQUESTOR                                          01890000
*                                                                       01900000
***************************************************************         01910000
RESPOND  DS    0H                                                       01920000
         TM    SEISTATE,SEIS_DEV  COMMUNICATION W/ VDEVICE FAILED PREV? 01930000
         BO    COMMFAIL           BYPASS NOTIFICATION IF SO             01940000
                                                                        01950000
         $XPBUFR XMIT             TRANSMIT AND FREE                     01960000
         BZ    RETURN             NORMAL COMPLETION                     01970000
                                                                        01980000
         C     R15,=A(RC16)       LIKELY SESSION DISAPPEARANCE?         01990000
         BNE   ABE_TXP            SOME OTHER FAILURE OTHERWISE          02000000
         OI    SEISTATE,SEIS_DEV  COMMUNICATION WITH VDEVICE LOST       02010000
                                                                        02020000
COMMFAIL DS    0H                                                       02030000
         LA    R15,RC24           COMMUNICATION FAILURE                 02040000
         ST    R15,LCLRETC        RETAIN COMPLETION STATUS              02050000
                                                                        02060000
*--------------------------------------------------------------         02070000
*   RETURN COMPLETION STATUS TO REQUESTOR                               02080000
*--------------------------------------------------------------         02090000
RETURN   DS    0H                                                       02100000
         L     R15,LCLRETC        CONVEY CONTINUATION OPTION            02110000
         SR    R0,R0              REASON CODES NOT DEFINED              02120000
                                                                        02130000
         #EXIT ,                                                        02140000
                                                                        02150000
         EJECT                                                          02160000
***************************************************************         02170000
*                                                                       02180000
* ROUTINE: RESPINIT - INITIALIZE RESPONSE BUFFER                        02190000
*                                                                       02200000
* ON ENTRY:                                                             02210000
*                                                                       02220000
*    R0 - XIMG RESPONSE SUBFUNCTION                                     02230000
*    R1 - SIZE OF EXTENSION REQUIRED                                    02240000
*                                                                       02250000
* ON EXIT:                                                              02260000
*                                                                       02270000
*    R1 - XIMGDATA RESPONSE BLOCK ORIGIN (TXP BUFFER RESIDENT)          02280000
*                                                                       02290000
***************************************************************         02300000
RESPINIT DS    0H                                                       02310000
         STM   R0,R15,REGSAVE     SAVE MAINLINE REGS                    02320000
         LR    R2,R1              EXTENSION SIZE                        02330000
         LA    R2,7(,R2)          ROUND TO DWORD                        02340000
         SRL   R2,3                                                     02350000
         SLL   R2,3                                                     02360000
                                                                        02370000
         LA    R6,@XH             MODEL RU HEADER                       02380000
         USING @XH,R6                                                   02390000
         LA    R1,XIMG            FUNCTION CODE                         02400000
         ST    R1,@XHFUNC                                               02410000
         ST    R0,@XHSFNC         SUBFUNCTION CODE PROVIDED BY CALLER   02420000
         MVC   @XHSESH,SLHXPH     SESSION HANDLE                        02430000
                                                                        02440000
         $XPBUFR INIT,SIZE=XIMGLN(R2),XH=@XH                            02450000
         BNZ   ABE_TXP                                                  02460000
         DROP  R6                 MODEL TRANSACTION HDR                 02470000
                                                                        02480000
*--------------------------------------------------------------         02490000
*   CONSTRUCT RESPONSE BLOCK AND PREPARE FOR RETURN                     02500000
*--------------------------------------------------------------         02510000
         $XPBUFR ISRT,DATALEN=XIMGLN                                    02520000
         BNZ   ABE_TXP                                                  02530000
                                                                        02540000
         USING XIMGDATA,R1        LIFE OF FUNCTION ADDRESSABILITY       02550000
         XC    XIMGDATA(XIMGLN),XIMGDATA  REDUNDANT                     02560000
                                                                        02570000
*--------------------------------------------------------------         02580000
*   RETURN TO CALLER                                                    02590000
*--------------------------------------------------------------         02600000
         LM    R2,R14,REGSAVE+8   RESTORE MAINLINE REGS                 02610000
         SR    R15,R15            RETURN CODES NOT DEFINED              02620000
         BR    R14                EXIT                                  02630000
         DROP  R1                 XIMG                                  02640000
                                                                        02650000
         EJECT                                                          02660000
***************************************************************         02670000
*                                                                       02680000
* CATASTROPIC ERRORS                                                    02690000
*                                                                       02700000
***************************************************************         02710000
ABE_TXP  DS    0H                                                       02720000
         $ABEND ABE_TXPSERV,DUMP=YES,                                  X02730000
               TITLE='TXP BUFFER SERVICE FAILURE'                       02740000
                                                                        02750000
         EJECT                                                          02760000
***************************************************************         02770000
*                                                                       02780000
*   LOCAL READ-ONLY DATA AREAS                                          02790000
*                                                                       02800000
***************************************************************         02810000
         LTORG ,                                                        02820000
                                                                        02830000
         PRINT NOGEN                                                    02840000
         ICVT  ,                                                        02850000
         ITASK ,                                                        02860000
         END   ,                                                        02870000

IPSBMOPS TITLE ' - PREPARED STATEMENT MULTIAPPLICATION OPERATIONS'      00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: IPSBMOPS - PREPARED STATEMENT MULTIAPP OPERATIONS            00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THIS ROUTINE IS USED TO COORDINATE THE USE AND RESOURCE            00080000
*    MANAGEMENT OF PREPARED STATEMENT MULTI-APPLICATION                 00090000
*    SEQUENCING INFORMATION MAINTAINED IN THE PREPARED                  00100000
*    STATEMENT BLOCK, OR PSB, VIA IMPORT AND EXPORT SERVICES.           00110000
*                                                                       00120000
*    IMPORT - MULTI-APPLICATION SEQUENCEING INFORMATION                 00130000
*             PREVIOUSLY EXPORTED INTO THE PSBAPPL EXTENSION            00140000
*             OF THE PSB IS RESTORED IN THE CORRESPONDING               00150000
*             AAPBLOCKS.  PLANLNK IS INVOKED TO REORDER THE             00160000
*             AAPS FOR EXECUTION.                                       00170000
*                                                                       00180000
*    EXPORT - MULTI-APPLICATION SEQUENCING INFORMATION IS               00190000
*             COPIED FROM THE AFFECTED APPS INTO A NEWLY                00200000
*             ALLOCATED PSAPPL EXTENSION TO THE PSB.                    00210000
*                                                                       00220000
*                                                                       00230000
* ENTRY:                                                                00240000
*                                                                       00250000
*    R1 CONTAINS THE ADDRESS OF A PARAMETER LIST CONSTRUCTED            00260000
*       AS FOLLOWS:                                                     00270000
*                                                                       00280000
*        +00 - REQUEST (IMPORT OR EXPORT) CODE                          00290000
*        +04 - AAP CHAIN ANCHOR PTR                                     00300000
*        +08 - ADDR OF THE PREPARED STATEMENT BLOCK (PSB) OR ZERO       00310000
*                                                                       00320000
* EXIT:                                                                 00330000
*                                                                       00340000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES                     00350000
*                                                                       00360000
*        RC00 - COMPLETE                                                00370000
*        RC04 - NO PREPARED STATEMENT                                   00380000
*        RC08 - REQUEST NOT SATISFIABLE                                 00390000
*                                                                       00400000
**<DOC-OFF>****************************************************         00410000
                                                                        00420000
         EJECT                                                          00430000
***************************************************************         00440000
*                                                                       00450000
* MAINTENANCE:                                                          00460000
*                                                                       00470000
*   05/09/94  R. TURGEON                                                00480000
*             INITIAL VERSION                                           00490000
*                                                                       00500000
***************************************************************         00510000
                                                                        00520000
         EJECT                                                          00530000
         #WORK ,                       READ/WRITE WORKAREA              00540000
                                                                        00550000
@USRSTG  DS    A                       ADDR OF IUSER.USRSTG             00560000
ANCAPPS  DS    A                       AAP CHAIN ANCHOR ADDRESS         00570000
ACOUNT   DS    F                       NUMBER OF SELECTED AAPS          00580000
                                                                        00590000
         #ENDWORK ,                                                     00600000
                                                                        00610000
         EJECT                                                          00620000
         IUSER ,                       COOP INSTANCE (USER) BLOCK       00630000
                                                                        00640000
         EJECT                                                          00650000
         NAV   ,                       NAVIGATION / PLAN STRUCTURES     00660000
                                                                        00670000
         EJECT                                                          00680000
         PSB   ,                       TABLE INTERFACE BLOCK (TIB)      00690000
                                                                        00700000
         EJECT                                                          00710000
         PREPAPPS EQUS                 REQUEST BLOCK SYMBOLICS          00720000
                                                                        00730000
         EJECT                                                          00740000
         PLNXREF ,                     LOCAL AAP/PSB XREF ENTRY FORMAT  00750000
                                                                        00760000
         EJECT                                                          00770000
         EQUS  ,                                                        00780000
                                                                        00790000
         EJECT                                                          00800000
IPSBMOPS #ENTER BASE=R12,PREG=(R8)                                      00810000
                                                                        00820000
         USING ITASK,R10               ITASK ADDRESSABILITY             00830000
         L     R9,TSKPCBC              LOCATE CURRENT PROCESS           00840000
         USING IPCB,R9                 STDENV, PROCESS MODE             00850000
                                                                        00860000
         EJECT                                                          00870000
*--------------------------------------------------------------         00880000
*   FETCH PASSED PARAMETERS, IDENTIFY REQUEST TYPE                      00890000
*--------------------------------------------------------------         00900000
         LM    R4,R7,0(R8)             FETCH PASSED PARAMETERS          00910000
*                                      R4 <== REQUEST CODE              00920000
         ST    R5,ANCAPPS              R5 <== AAP CHAIN ANCHOR          00930000
         LTR   R7,R7                   SELECTED AAPS?                   00940000
         BNP   ERR_PREP                REQ NOT SATISFIABLE IF NOT       00950000
         ST    R7,ACOUNT               RETAIN FOR LATER USE             00960000
                                                                        00970000
         USING PSB,R6                  PREPARED STATEMENT BLOCK         00980000
         LTR   R6,R6                   PSB AVAILABLE?                   00990000
         BZ    WRN_NPSB                DONE IF NOT                      01000000
                                                                        01010000
         L     R2,PCBUSER              USER INSTANCE                    01020000
         USING IUSER,R2                USER ASSOCIATION                 01030000
         LA    R0,USRSTG-IUSER(,R2)    USER STORAGE POOL                01040000
         ST    R0,@USRSTG              RETAIN PTR FOR PLAN OPS          01050000
         DROP  R2                      IUSER                            01060000
                                                                        01070000
         C     R4,=A(PREPM_IMPORT)                                      01080000
         BE    IMPORT                                                   01090000
         C     R4,=A(PREPM_EXPORT)                                      01100000
         BE    EXPORT                                                   01110000
                                                                        01120000
         EX    R0,*                    INVALID REQUEST                  01130000
                                                                        01140000
         EJECT                                                          01150000
***************************************************************         01160000
*                                                                       01170000
*   IMPORT - ASSIGN APPLICATION SEQUENCE NUMBERS, THEN ORDER            01180000
*                                                                       01190000
***************************************************************         01200000
IMPORT   DS    0H                                                       01210000
         CLI   PSBMULTI,FALSE          MULTIAPP SEQ INFO EXPORTED?      01220000
         BE    ERR_PREP                NOT SATISFIABLE OTHERWISE        01230000
                                                                        01240000
         L     R5,ANCAPPS              AAP CHAIN ANCHOR AAP             01250000
         L     R5,0(,R5)               SCAN THE AAP CHAIN               01260000
         USING AAP,R5                  AAP FORMAT                       01270000
                                                                        01280000
IMPAPNXT DS    0H                                                       01290000
         TM    AAPFLAG1,AAPFSEL        APP SELECTED FOR EXECUTION?      01300000
         BNO   IMPAPADV                SKIP IF NOT                      01310000
                                                                        01320000
         LA    R1,AAP                  R1 <== SELECTED AAP              01330000
         BAS   R14,LOCPSAPP            LOCATE CORR ENTRY IN PSB         01340000
         BZ    ERR_PREP                SOMETHING SERIOUSLY WRONG        01350000
                                                                        01360000
         USING PSAPPL,R15              PSB MULTI-APP SEQUENCE ENTRY     01370000
         MVC   AAPRQNDX,PSAPSEQ        IMPORT ITS SEQUENCE NUMBER       01380000
         DROP  R15                     PSAPPL                           01390000
                                                                        01400000
IMPAPADV DS    0H                                                       01410000
         ICM   R5,15,AAPNEXT           ADVANCE TO NEXT AAP              01420000
         BNZ   IMPAPNXT                SCAN ALL AAPS                    01430000
         DROP  R5                      AAP                              01440000
                                                                        01450000
*--------------------------------------------------------------         01460000
*   (RE)ORDER THE AAP QUEUE                                             01470000
*--------------------------------------------------------------         01480000
         L     R2,ANCAPPS              AAP CHAIN ANCHOR PTR             01490000
                                                                        01500000
         $CLINK FUNC=PLNLNK,           ORDER THE AAP CHAIN             X01510000
               (STRUCT**,(R2))                                          01520000
                                                                        01530000
         B     COMPLETE                DONE                             01540000
         EJECT                                                          01550000
***************************************************************         01560000
*                                                                       01570000
*   EXPORT - RETAIN SELECTED APPL IDENTIFIERS AND SEQUENCE #'S          01580000
*                                                                       01590000
***************************************************************         01600000
EXPORT   DS    0H                                                       01610000
         CLI   PSBMULTI,FALSE          MULTIAPP SEQ INFO EXPORTED?      01620000
         BNE   ERR_PREP                UPDATE REPLACE NOT SUPPORTED     01630000
                                                                        01640000
*--------------------------------------------------------------         01650000
*   ACQUIRE PSAPPL EXTENSION TO PSB                                     01660000
*--------------------------------------------------------------         01670000
         LA    R3,PSAPPLN              PSAPPL ENTRY LENGTH              01680000
         MH    R3,ACOUNT+2             TOTAL SIZE OF BLOCK REQUIRED     01690000
         L     R2,@USRSTG              USER ORIENTED STORAGE            01700000
                                                                        01710000
         STGGET (R3),QH=(R2)           ACQUIRE PSB PLAN EXTENSION       01720000
         BZ    *+8                     ASSERT SUCCESSFUL ACQUISITION    01730000
         EX    R0,*                    DENIED                           01740000
                                                                        01750000
         USING PSAPPL,R1               ENTRY FORMAT                     01760000
                                                                        01770000
         MVI   PSBMULTI,TRUE           EXPORTED MULTIAPP SEQUENCING     01780000
         ST    R1,PSBMALST             SEQUENCE LIST                    01790000
         ST    R3,PSBMASIZ             BLOCK SIZE                       01800000
         MVC   PSBMACNT,ACOUNT         ENTRY COUNT                      01810000
                                                                        01820000
*--------------------------------------------------------------         01830000
*   CONSTRUCT PSAPPL ENTRIES                                            01840000
*--------------------------------------------------------------         01850000
         L     R5,ANCAPPS              AAP CHAIN ANCHOR AAP             01860000
         L     R5,0(,R5)               SCAN THE AAP CHAIN               01870000
         USING AAP,R5                  AAP FORMAT                       01880000
                                                                        01890000
EXPAPNXT DS    0H                                                       01900000
         TM    AAPFLAG1,AAPFSEL        APP SELECTED FOR EXECUTION?      01910000
         BNO   EXPAPADV                SKIP IF NOT                      01920000
                                                                        01930000
         MVC   PSAPNAME,AAPANAME       APPLICATION NAME                 01940000
         MVC   PSAPLOGM,AAPLOGMD       LOGMODE                          01950000
         MVC   PSAPSEQ,AAPRQNDX        SEQUENCE NUMBER                  01960000
         LA    R1,PSAPNEXT             PREPARE FOR NEXT PSAPPL ENTRY    01970000
                                                                        01980000
EXPAPADV DS    0H                                                       01990000
         ICM   R5,15,AAPNEXT           ADVANCE TO NEXT AAP              02000000
         BNZ   EXPAPNXT                SCAN ALL AAPS                    02010000
         B     COMPLETE                DONE                             02020000
         DROP  R5,R1                   AAP, PSAPPL                      02030000
                                                                        02040000
         EJECT                                                          02050000
***************************************************************         02060000
*                                                                       02070000
*   RETURN COMPLETION STATUS TO REQUESTOR                               02080000
*                                                                       02090000
***************************************************************         02100000
COMPLETE DS    0H                      FUNCTION COMPLETED SUCCESSFULLY  02110000
         LA    R15,RC00                                                 02120000
         B     RETURN                                                   02130000
                                                                        02140000
WRN_NPSB DS    0H                      STATEMENT NOT PREPARED           02150000
         LA    R15,RC04                                                 02160000
         B     RETURN                                                   02170000
                                                                        02180000
ERR_PREP DS    0H                      REQUEST NOT SATISFIABLE          02190000
         LA    R15,RC08                                                 02200000
         B     RETURN                                                   02210000
                                                                        02220000
RETURN   DS    0H                                                       02230000
         #EXIT ,                       RETURN                           02240000
                                                                        02250000
         EJECT                                                          02260000
***************************************************************         02270000
*                                                                       02280000
* ROUTINE: LOCPSAPP - LOCATE PSAPPL ENTRY                               02290000
*                                                                       02300000
* ON ENTRY:                                                             02310000
*                                                                       02320000
*    R1 - AAP ENTRY                                                     02330000
*                                                                       02340000
* ON EXIT:                                                              02350000
*                                                                       02360000
*    R15 CONTAINS THE ADDRESS OF THE CORRESPONDING PSB->PSAPPL          02370000
*        ENTRY OR ZERO IF NO MATCH WAS FOUND                            02380000
*                                                                       02390000
***************************************************************         02400000
LOCPSAPP DS    0H                                                       02410000
A        USING AAP,R1                  AAP                              02420000
                                                                        02430000
         L     R15,PSBMALST            PSAPPL LIST ORIGIN               02440000
         USING PSAPPL,R15                                               02450000
         L     R0,PSBMACNT             PSAPPL ENTRY COUNT               02460000
                                                                        02470000
LOCPSNXT DS    0H                                                       02480000
         CLC   PSAPNAME,A.AAPANAME     MATCH APPL NAME                  02490000
         BNE   LOCPSADV                                                 02500000
         CLC   PSAPLOGM,A.AAPLOGMD     MATCH LOGMODE                    02510000
         BE    LOCPSFIN                                                 02520000
                                                                        02530000
LOCPSADV DS    0H                                                       02540000
         LA    R15,PSAPNEXT            NEXT PSAPPL ENTRY                02550000
         BCT   R0,LOCPSNXT             SEARCH ALL ENTRIES               02560000
         SR    R15,R15                 SEARCH FAILS                     02570000
                                                                        02580000
LOCPSFIN DS    0H                                                       02590000
         LTR   R15,R15                 REFLECT COMPLETION STATUS VIA CC 02600000
         BR    R14                     RETURN                           02610000
         DROP  A,R15                   AAP, PSAPPL                      02620000
                                                                        02630000
         EJECT                                                          02640000
***************************************************************         02650000
*                                                                       02660000
*   LOCAL READ ONLY STORAGE                                             02670000
*                                                                       02680000
***************************************************************         02690000
         LTORG ,                                                        02700000
                                                                        02710000
         PRINT NOGEN                                                    02720000
         ICVT  ,                                                        02730000
         ITASK ,                                                        02740000
         IPCB  ,                                                        02750000
         END   ,                                                        02760000

IVTMXSCP TITLE 'INTEGRATOR - VTAM SCIP EXIT'                            00010000
**<DOC-ON>************************************************************* 00020000
*                                                                       00030000
* ROUTINE: IVTMXSCP - INTEGRATOR VTAM SCIP EXIT                         00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THE SCIP EXIT IS DRIVEN BY VTAM WHEN CERTAIN SESSION               00080000
*    CONTROL RU'S ARE RECEIVED:                                         00090000
*                                                                       00100000
*    - CLEAR                                                            00110000
*    - START DATA TRAFFIC (SDT)                                         00120000
*    - REQUEST RECOVERY (RQR)                                           00130000
*    - SET AND TEST SEQUENCE NUMBERS (STSN)                             00140000
*    - BIND                                                             00150000
*    - UNBIND                                                           00160000
*                                                                       00170000
*    ALL OF THE REQUESTS WILL BE "SESSION RELATED" EXCEPT FOR           00180000
*    UNSOLICITED BINDS THAT RESULT FROM APPLICATIONS USING              00190000
*    CLSDST-PASS AND/OR SIMLOGON.  "SESSION RELATED" MEANS THAT         00200000
*    THE NIB USERFLD IS PRESENT.  IF THE NIB USERFLD VALUE IS           00210000
*    POSITIVE, IT CONTAINS THE ADDRESS OF AN ISESS WHOSE WORK           00220000
*    QUEUE WILL RECEIVE THE RU.  IF THE NIB USERFLD VALUE IS NEGATIVE   00230000
*    IT IS THE ADDRESS OF AN ISQE WITH THE HI-ORDER BIT ON TO           00240000
*    IDENTIFY IT AS AN ISQE ADDRESS.  IN THIS CASE THE RU WILL BE       00250000
*    QUEUED TO THE MAIN TASK FOR PROCESSING (THE RU IS A SOLICITED      00260000
*    BIND).                                                             00270000
*                                                                       00280000
*    FOR UNSOLICITED BINDS, THE WORK ELEMENT IS QUEUED TO THE VTAM      00290000
*    MAIN TASK WORK QUEUE.  THE MAIN TASK WILL LOCATE THE ISESS         00300000
*    THAT SHOULD BE PROCESSING THE REQUEST AND QUEUES THE ELEMENT       00310000
*    TO THAT ISESS WORK QUEUE.                                          00320000
*                                                                       00330000
* ON ENTRY:                                                             00340000
*                                                                       00350000
*    BAKR IS USED TO SAVE REGISTERS.                                    00360000
*                                                                       00370000
*    R15 = ENTRY POINT ADDRESS                                          00380000
*    R14 = RETURN ADDRESS                                               00390000
*    R01 = PARAMETER LIST ADDRESS                                       00400000
*          +00(4): ADDRESS OF ACB                                       00410000
*          +04(4): CID OF ASSOCIATED SESSION                            00420000
*          +08(4): NIB USERFLD OF ASSOCIATED SESSION                    00430000
*          +0C(4): DEPENDENT ON REQUEST TYPE                            00440000
*                  BIND: ADDRESS OF SESSION PARAMETERS                  00450000
*                  OTHER REQUEST TYPES: NOT APPLICABLE                  00460000
*          +10(4): ADDRESS OF VTAM READ-ONLY RPL                        00470000
*          +14(4): RESERVED (UNUSED)                                    00480000
*                                                                       00490000
* ON EXIT:                                                              00500000
*                                                                       00510000
*    R15 = 0                                                            00520000
*    R00 = 0                                                            00530000
*    R01 = 0                                                            00540000
*                                                                       00550000
*    ALL OTHER REGISTERS ARE RESTORED BY PR.                            00560000
*                                                                       00570000
**<DOC-OFF>************************************************************ 00580000
                                                                        00590000
         EJECT ,                                                        00600000
*********************************************************************** 00610000
*                                                                       00620000
* MAINTENANCE:                                                          00630000
*                                                                       00640000
*   08/01/93 RANDY WITEK                                                00650000
*                                                                       00660000
*********************************************************************** 00670000
         EQUS  ,                  GENERAL EQUATES                       00680000
                                                                        00690000
RICVT    EQU   R11                INTEGRATOR CVT POINTER                00700000
RITASK   EQU   R10                ASSOCIATED ITASK POINTER              00710000
RIVTAM   EQU   R9                 INTEGRATOR VTAM CVT POINTER           00720000
RIACB    EQU   R8                 ASSOCIATED IACB POINTER               00730000
RIRPL    EQU   R7                 ASSOCIATED RPL/IRPL POINTER           00740000
RISESS   EQU   R6                 ASSOCIATED ISESS POINTER              00750000
RIWE     EQU   R5                 WORK ELEMENT POINTER                  00760000
                                                                        00770000
         USING ICVT,RICVT         ESTABLISH ADDRESSIBILTY               00780000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSIBILTY               00790000
         USING ITASK,RITASK       ESTABLISH ADDRESSIBILTY               00800000
         USING IACB,RIACB         ESTABLISH ADDRESSIBILTY               00810000
         USING IRPL,RIRPL         ESTABLISH ADDRESSIBILTY               00820000
         USING IWEVTAM,RIWE       ESTABLISH ADDRESSIBILTY               00830000
         USING ISESS,RISESS       ESTABLISH ADDRESSIBILTY               00840000
                                                                        00850000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00860000
         DS    0D                                                       00870000
RCVPARMS DS    XL(L'IVR)          IVTAMRPA STORAGE                      00880000
ESTAEMFL DS    XL(L'ESTAEXPL)     PARMLIST CONSTRUCTION                 00890000
FRRPARM  DS    A                  RETURN AREA FOR FRR PARM ADDRESS      00900000
SAVER2   DS    F                  TEMPORARY SAVE AREA                   00910000
RETR15   DS    F                  RETURN CODE VALUE                     00920000
RETR0    DS    F                  RETURN REGISTER 0                     00930000
RETR1    DS    F                  RETURN REGISTER 1                     00940000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00950000
FLAG     DS    X                                                        00960000
FLESTAEX EQU   X'08'              ESTAEX ACTIVE                         00970000
FLFRR    EQU   X'04'              FRR    ACTIVE                         00980000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00990000
                                                                        01000000
IVTMXSCP #VTENTER BASE=R12,       VTAM EXIT ROUTINE LINKAGE            +01010000
               AMODE=31,                                               +01020000
               RMODE=ANY,                                              +01030000
               PREG=(R2),                                              +01040000
               EXITYPE=PLIST                                            01050000
                                                                        01060000
         USING IVTAMRPA,RCVPARMS  ESTABLISH ADDRESSIBILITY              01070000
                                                                        01080000
*---------------------------------------------------------------------- 01090000
* ESTABLISH RECOVERY ENVIRONMENT                                        01100000
*---------------------------------------------------------------------- 01110000
                                                                        01120000
         ST    R2,SAVER2          SAVE PARM REG                         01130000
         LA    R15,IVTXRTRY       RETRY ROUTINE ADDRESS                 01140000
         ST    R15,IVRRETAD       SET RETRY ROUTINE ADDRESS             01150000
         LA    R15,IVTAMRPA       PARAMETERS ADDRESS                    01160000
         ST    R15,IVRRPA@        SET ADDRESS FOR FRR                   01170000
         L     R0,=F'-1'          SHOW REGS RESTORED FROM PARM AREA     01180000
         STM   R0,R15,IVRR00      SAVE RETRY REGISTERS                  01190000
         MVC   IVRMOD,=CL8'IVTMTASK'                                    01200000
         MVC   IVRCSECT,=CL8'IVTMXSCP'                                  01210000
         MVC   IVRFRR,=CL8'IVTMXRCV'                                    01220000
         MVC   IVRTYPE,=CL8'ESTAEX'                                     01230000
         L     R3,=V(IVTMXRCV)    ADDR OF VTAM EXIT RECOVERY ROUTINE    01240000
         ICM   R0,15,PSATOLD      SRB MODE?                             01250000
         BZ    ESTFRR             BRANCH IF YES                         01260000
                                                                        01270000
         MVC   ESTAEMFL(L'ESTAEXPL),ESTAEXL                             01280000
                                                                        01290000
         ESTAEX (R3),                                                  +01300000
               CT,                                                     +01310000
               PARAM=RCVPARMS,                                         +01320000
               TERM=YES,                                               +01330000
               MF=(E,ESTAEMFL)    ESTABLISH RECOVERY                    01340000
                                                                        01350000
         OI    FLAG,FLESTAEX      RECOVERY ENVIRONMENT ESTABLISHED      01360000
         B     RECOVSET           AND CONTINUE                          01370000
                                                                        01380000
ESTFRR   DS    0H                                                       01390000
                                                                        01400000
         MVC   IVRTYPE,=CL8'FRR'                                        01410000
                                                                        01420000
         MODESET EXTKEY=ZERO,                                          +01430000
               SAVEKEY=(2)        SET KEY ZERO                          01440000
                                                                        01450000
         SETFRR A,                                                     +01460000
               FRRAD=(R3),                                             +01470000
               WRKREGS=(14,15),                                        +01480000
               PARMAD=FRRPARM     ESTABLISH RECOVERY                    01490000
                                                                        01500000
         L     R1,FRRPARM         PARM AREA FOR FRR                     01510000
         MVC   0(12,R1),RCVPARMS  SET TYPE & PARM AREA POINTER          01520000
                                                                        01530000
         MODESET KEYADDR=(2)      RESTORE PREVIOUS KEY                  01540000
                                                                        01550000
         OI    FLAG,FLFRR         RECOVERY ENVIRONMENT ESTABLISHED      01560000
         B     RECOVSET           AND CONTINUE                          01570000
                                                                        01580000
RECOVSET DS    0H                                                       01590000
                                                                        01600000
         L     R2,SAVER2          RESTORE PARM REG                      01610000
                                                                        01620000
*---------------------------------------------------------------------- 01630000
* COLLECT PARAMETERS                                                    01640000
*---------------------------------------------------------------------- 01650000
                                                                        01660000
         L     RIACB,0(,R2)       ASSOCIATED IACB ADDRESS               01670000
         L     RISESS,8(,R2)      NIB USERFLD CONTENTS                  01680000
         L     RIRPL,16(,R2)      ADDRESS OF VTAM READ-ONLY RPL         01690000
                                                                        01700000
*---------------------------------------------------------------------- 01710000
* COMPUTE LENGTH OF WORK ELEMENT                                        01720000
*---------------------------------------------------------------------- 01730000
                                                                        01740000
         LA    R3,L'IWEX7         LENGTH OF BASIC WORK ELEMENT          01750000
         TM    RPLCNTDC,RPLTBIND+RPLTUNBD IS AN RU PRESENT?             01760000
         BZ    SKIPRLEN           BRANCH IF NOT                         01770000
         A     R3,RPLRLEN         PLUS LENGTH OF THE RU DATA            01780000
                                                                        01790000
*---------------------------------------------------------------------- 01800000
* DETERMINE WHERE TO QUEUE WORK ELEMENT BASED ON USERFLD CONTENTS       01810000
*---------------------------------------------------------------------- 01820000
                                                                        01830000
SKIPRLEN DS    0H                                                       01840000
                                                                        01850000
         LTR   RISESS,RISESS      NIB USRFLD IS ISESS ADDRESS           01860000
         BNP   QTOMAIN            IF USERFLD IS ZERO --> NO ISESS       01870000
*                                 IF USERFLD <  ZERO --> ISQE ADDRESS   01880000
         OI    IVRF1,IVRF1IVI     ISESS VALIDATION IN PROGRESS          01890000
         CLC   ISEID,=CL8'ISESS'  CHECK EYECATCHER                      01900000
         BNE   QTOMAIN            BRANCH IF NOT GOOD                    01910000
         NI    IVRF1,255-IVRF1IVI ISESS VALIDATION COMPLETE             01920000
         LA    R4,ISEWEQ          USE THE ISESS WORK QUEUE              01930000
         L     RITASK,ISEITASK    GET THE SESSION ITASK POINTER         01940000
         B     ALLOCWE            GO CREATE THE WORK ELEMENT            01950000
                                                                        01960000
*---------------------------------------------------------------------- 01970000
* PREPARE TO QUEUE A WORK ELEMENT TO THE VTAM MAIN TASK.                01980000
*---------------------------------------------------------------------- 01990000
                                                                        02000000
QTOMAIN  DS    0H                                                       02010000
                                                                        02020000
         NI    IVRF1,255-IVRF1IVI ISESS VALIDATION COMPLETE             02030000
         LA    R4,IVTWEQ          USE THE VTAM MAIN WORK QUEUE          02040000
                                                                        02050000
*---------------------------------------------------------------------- 02060000
* ALLOCATE SCIP WORK ELEMENT                                            02070000
*---------------------------------------------------------------------- 02080000
                                                                        02090000
ALLOCWE  DS    0H                                                       02100000
                                                                        02110000
         ST    R2,SAVER2          SAVE R2 TEMPORARILY                   02120000
                                                                        02130000
         $VTAMWE (R3),            SIZE                                 +02140000
               IWECXSCP           CODE                                  02150000
                                                                        02160000
         LR    RIWE,R1                                                  02170000
         L     R2,SAVER2          RESTORE R2                            02180000
                                                                        02190000
*---------------------------------------------------------------------- 02200000
* BUILD SCIP WORK ELEMENT                                               02210000
*---------------------------------------------------------------------- 02220000
                                                                        02230000
         ST    RIACB,IWEX7ACB     SET ACB ADDRESS                       02240000
         MVC   IWEX7CID,4(R2)     SET CID                               02250000
         MVC   IWEX7USR,8(R2)     SET USERFLD                           02260000
         SR    R3,R3              CLEAR FOR IC                          02270000
         IC    R3,RPLLEN          LENGTH OF VTAM RPL                    02280000
         BCTR  R3,0               LENGTH CODE FOR EXECUTE               02290000
         EX    R3,COPYRPL         COPY VTAM RPL TO WORK ELEMENT         02300000
         TM    RPLCNTDC,RPLTBIND+RPLTUNBD IS AN RU PRESENT?             02310000
         BZ    SKIPCOPY           BRANCH IF NOT                         02320000
         TM    RPLCNTDC,RPLTBIND  IS THIS A BIND?                       02330000
         BZ    SKIPLUNM           BRANCH IF NOT                         02340000
                                                                        02350000
         L     R15,12(,R2)        SESSION PARAMETERS ADDRESS            02360000
X        USING ISTDBIND,R15                                             02370000
         MVC   IWEX7LU,X.BINPRIMN SET PRIMARY LU NAME                   02380000
         DROP  X                                                        02390000
                                                                        02400000
SKIPLUNM DS    0H                                                       02410000
                                                                        02420000
         LA    R0,IWEX7RU         ADDRESS OF RU DATA RECEIVING AREA     02430000
         L     R1,RPLRLEN         LENGTH OF RU DATA                     02440000
         LR    R3,R1              LENGTH OF RU DATA                     02450000
         L     R2,RPLAREA         ADDRESS OF RU DATA                    02460000
         MVCL  R0,R2              COPY RU DATA TO WORK ELEMENT          02470000
         LA    R1,IWEX7RU         ADDRESS OF THE RU DATA COPY           02480000
         ST    R1,IWEX7RPL+(RPLAREA-IFGRPL) POINT RPL COPY AT RU COPY   02490000
                                                                        02500000
*---------------------------------------------------------------------- 02510000
* TRACE THE MODULE ENTRY                                                02520000
*---------------------------------------------------------------------- 02530000
                                                                        02540000
SKIPCOPY DS    0H                                                       02550000
                                                                        02560000
         $TRACE *=A(TRC_IVTMXSCP),32,STDENV=NO        32 USER BYTES     02570000
                                                                        02580000
         BNZ   NOMTRACE           BRANCH IF TRACING NOT AVAILABLE       02590000
                                                                        02600000
         ST    RITASK,0(,R1)      TRACE ITASK                           02610000
         ST    RISESS,4(,R1)      TRACE ISESS                           02620000
         ST    RIACB,8(,R1)       TRACE IACB                            02630000
         MVC   12(4,R1),IWEX7CID  TRACE CID                             02640000
         MVC   16(3,R1),RPLCNTRL  TRACE THE CNTRL FLAGS FOR RU-TYPE     02650000
         MVC   20(4,R1),IWEX7USR  TRACE THE USERFLD                     02660000
         MVC   24(8,R1),IWEX7LU   TRACE THE PLUNAME FOR BINDS           02670000
                                                                        02680000
NOMTRACE DS    0H                                                       02690000
                                                                        02700000
*---------------------------------------------------------------------- 02710000
* QUEUE SCIP WORK ELEMENT TO VTAM MAIN/SESSION ITASK                    02720000
*---------------------------------------------------------------------- 02730000
                                                                        02740000
         $VTAMQ (RIWE),           WORK ELEMENT                         +02750000
               (R4),              QUEUE                                +02760000
               STDENV=NO          EXIT ROUTINE                          02770000
                                                                        02780000
         B     RETURN                                                   02790000
                                                                        02800000
*---------------------------------------------------------------------- 02810000
* RETRY ROUTINE SCHEDULED BY RECOVERY                                   02820000
*---------------------------------------------------------------------- 02830000
                                                                        02840000
IVTXRTRY DS    0H                                                       02850000
                                                                        02860000
         LTR   R0,R0              WERE REGISTERS RESTORED FOR RETRY?    02870000
         BM    REGSOK             BRANCH IF YES, READY TO EXIT          02880000
X        USING IVTAMRPA,R1        PARM AREA ADDRESS MUST BE IN R1       02890000
         LM    R0,R15,X.IVRR00    RESTORE ALL THE REGISTERS             02900000
         DROP  X                                                        02910000
                                                                        02920000
REGSOK   DS    0H                                                       02930000
                                                                        02940000
         ICM   R0,15,PSATOLD      SRB MODE?                             02950000
         BNZ   RETURN             BRANCH IF NOT                         02960000
         ICM   R1,B'0001',=X'80'  KEY 8 IN BITS 24-27                   02970000
         MODESET KEYREG=(R1)      SET KEY 8                             02980000
         B     RETURN             AND WE ARE READY TO EXIT              02990000
                                                                        03000000
*---------------------------------------------------------------------- 03010000
* RETURN TO VTAM FROM EXIT ROUTINE                                      03020000
*---------------------------------------------------------------------- 03030000
                                                                        03040000
RETURN   DS    0H                                                       03050000
                                                                        03060000
         TM    FLAG,FLESTAEX      IS ESTAEX ESTABLISHED?                03070000
         BNO   RETFRR             BRANCH IF NOT                         03080000
                                                                        03090000
         ESTAEX 0                 DELETE RECOVERY ENVIRONMENT           03100000
                                                                        03110000
         NI    FLAG,255-FLESTAEX  CLEAR FLAG                            03120000
         B     EXITNOW            AND EXIT                              03130000
                                                                        03140000
RETFRR   DS    0H                                                       03150000
                                                                        03160000
         TM    FLAG,FLFRR         IS FRR ESTABLISHED?                   03170000
         BNO   EXITNOW            BRANCH IF NOT                         03180000
                                                                        03190000
         MODESET EXTKEY=ZERO,                                          +03200000
               SAVEKEY=(2)        SET KEY ZERO                          03210000
                                                                        03220000
         SETFRR D,                                                     +03230000
               WRKREGS=(14,15)    DELETE RECOVERY ENVIRONMENT           03240000
                                                                        03250000
         MODESET KEYADDR=(2)      RESTORE PREVIOUS KEY                  03260000
                                                                        03270000
         NI    FLAG,255-FLFRR     CLEAR FLAG                            03280000
         B     EXITNOW            AND EXIT                              03290000
                                                                        03300000
EXITNOW  DS    0H                                                       03310000
                                                                        03320000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 03330000
                                                                        03340000
         #VTEXIT ,                RETURN                                03350000
                                                                        03360000
*---------------------------------------------------------------------- 03370000
*  CONSTANTS AND LITERALS                                               03380000
*---------------------------------------------------------------------- 03390000
                                                                        03400000
COPYRPL  MVC   IWEX7RPL(0),0(RIRPL) COPY READ-ONLY RPL TO IWE           03410000
                                                                        03420000
ESTAEXL  ESTAEX *-*,CT,MF=L       ESTAEX PLIST                          03430000
ESTAEXPL EQU   ESTAEXL,*-ESTAEXL                                        03440000
                                                                        03450000
         LTORG ,                                                        03460000
         PRINT NOGEN                                                    03470000
         IVTAMRPA ,               INTEGRATOR VTAM RECOVERY PARAMETERS   03480000
         IHAFRRS ,                MVS FRR STACK                         03490000
         IHAPSA ,                 MVS PREFIXED STORAGE AREA             03500000
         ISTDBIND ,               VTAM SESSION PARMS                    03510000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         03520000
         ICVT  ,                  INTEGRATOR CVT                        03530000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   03540000
         ITASK ,                  INTEGRATOR TASK BLOCK                 03550000
         IACB ,                   INTEGRATOR VTAM ACB+                  03560000
         IRPL ,                   INTEGRATOR VTAM RPL+                  03570000
         INIB ,                   INTEGRATOR VTAM NIB+                  03580000
         ISESS ,                  INTEGRATOR SESSION BLOCK              03590000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            03600000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          03610000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       03620000
         EVCODES ,                INTEGRATOR EVENT CODES                03630000
         ABCODES ,                INTEGRATOR $ABEND CODES               03640000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     03650000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             03660000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             03670000
         IFGEXLST ,               VTAM EXIT LIST                        03680000
         END   ,                                                        03690000

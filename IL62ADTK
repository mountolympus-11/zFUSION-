IL62ADTK TITLE 'INTEGRATOR - LU6.2 DEFINE TRANSACTION_CONTROL_BLOCK'    00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: IL62ADTK - LU6.2 DEFINE TRANSACTION_CONTROL_BLOCK            00100000
*                                                                       00110000
* DESCRIPTION:                                                          00120000
*                                                                       00130000
*    THIS ROUTINE IS CALLED TO CREATE A TRANSACTION_CONTROL_BLOCK       00140000
*    (TKB) ON BEHALF OF THE CURRENT PROCESS.                            00150000
*                                                                       00160000
* ON ENTRY:                                                             00170000
*                                                                       00180000
*    R15 = ENTRY POINT ADDRESS                                          00190000
*    R14 = RETURN      ADDRESS                                          00200000
*    R13 = SAVE AREA   ADDRESS                                          00210000
*    R01 = PARM LIST   ADDRESS                                          00220000
*                                                                       00230000
*          +00 = ADDRESS OF TP NAME                                     00240000
*          +04 = ADDRESS OF TP NAME LENGTH                              00250000
*          +08 = ADDRESS OF RETURN CODE AREA                            00260000
*                                                                       00270000
* ON EXIT:                                                              00280000
*                                                                       00290000
*    R15 = 0                                                            00300000
*                                                                       00310000
*    RETURN_CODE = LU62_OK --> TKB SUCCESSFULLY ALLOCATED               00320000
*                                                                       00330000
*                = LU62_INT_TKB_EXISTS --> TKB IS ALREADY ALLOCATED     00340000
*                = LU62_PRODUCT_SPECIFIC_ERROR --> NO CURRENT IPCB      00350000
*                = LU62_PRODUCT_SPECIFIC_ERROR --> $RESMGR ERROR        00360000
*                = LU62_PARAMETER_ERROR --> INVALID/MISSING TPN         00370000
*                                                                       00380000
**<DOC-OFF>************************************************************ 00390000
         EJECT ,                                                        00400000
*********************************************************************** 00410000
*                                                                       00420000
* MAINTENANCE:                                                          00430000
*                                                                       00440000
*   07/01/94 RANDY WITEK                                                00450000
*   10/26/95 RANDY WITEK - FIX MVS LEVEL-DEPENDENT TIME USAGE           00460000
*                                                                       00470000
*********************************************************************** 00480000
                                                                        00490000
         EQUS  ,                  GENERAL EQUATES                       00500000
                                                                        00510000
RICVT    EQU   R11                                                      00520000
RITASK   EQU   R10                                                      00530000
RBASE    EQU   R9                                                       00540000
RIVTAM   EQU   R8                                                       00550000
RPLIST   EQU   R7                                                       00560000
RTKB     EQU   R6                                                       00570000
RIPCB    EQU   R5                                                       00580000
                                                                        00590000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00600000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00610000
         USING L62LIST,RPLIST     ESTABLISH ADDRESSABILITY              00620000
         USING TKB,RTKB           ESTABLISH ADDRESSABILITY              00630000
         USING IPCB,RIPCB         ESTABLISH ADDRESSABILITY              00640000
                                                                        00650000
         COPY  CRAB               "C" RUNTIME ANCHOR BLOCK              00660000
         USING CRAB,R12           ADDRESSABILITY                        00670000
                                                                        00680000
         COPY  DSA                DYNAMIC SAVE AREA                     00690000
WORKAREA DS    0H                 READ/WRITE WORKAREA                   00700000
WRK256   DS    XL256              GENERAL WORKAREA                      00710000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00720000
$RMGRMFL $RESMGR MF=L             $RESMGR PLIST CONSTRUCTION            00730000
TPN@     DS    A                  ADDRESS OF TPN                        00740000
TPNLN    DS    F                  LENGTH OF TPN                         00750000
WRKLOCAL DS    CL64               WORKING COPY OF TPN                   00760000
RETCODE  DS    F                  TEMPORARY RETURN CODE AREA            00770000
FLAG     DS    X                                                        00780000
WORKLEN  EQU   *-WORKAREA         LENGTH OF USER DSA AREA               00790000
DSALEN   EQU   *-DSA              LENGTH OF DSA                         00800000
                                                                        00810000
         $MSGDFT PREFIX=ICTPID,                                        +00820000
               COMPID='L62',                                           +00830000
               TABLE=*#MSGS,                                           +00840000
               WORKA=0,                                                +00850000
               MF=(E,WRK256),                                          +00860000
               PRINT=NOGEN                                              00870000
                                                                        00880000
IL6ADTK@ CSECT ,                                                        00890000
IL62ADTK CENTRY DSA=DSALEN,BASE=RBASE,INDEP=YES                         00900000
                                                                        00910000
         USING DSA,R13            ADDRESSABILITY                        00920000
         LR    RPLIST,R1          SAVE ADDRESS OF PLIST                 00930000
                                                                        00940000
         LA    R0,WORKAREA        ADDRESS OF USER DSA SECTION           00950000
         LA    R1,WORKLEN         LENGTH  OF USER DSA SECTION           00960000
         SR    R15,R15            PREPARE FOR CLEAR                     00970000
         MVCL  R0,R14             CLEAR USER DSA SECTION                00980000
                                                                        00990000
*---------------------------------------------------------------------- 01000000
* INITIALIZATION                                                        01010000
*---------------------------------------------------------------------- 01020000
                                                                        01030000
         @RESTENV ,               ENSURE ENVIRONMENT                    01040000
                                                                        01050000
         L     RIVTAM,ICTVTCVT    ESTABLISH IVTAMCVT POINTER            01060000
         USING IVTAMCVT,RIVTAM    ADDRESSABILITY                        01070000
                                                                        01080000
         L     R2,L62PARM1        TPN ADDRESS                           01090000
         L     R3,L62PARM2        TPN LENGTH ADDRESS                    01100000
         L     R3,0(,R3)          TPN LENGTH                            01110000
         ST    R2,TPN@            SAVE THE ADDRESS                      01120000
         ST    R3,TPNLN           SAVE THE LENGTH                       01130000
         MVC   WRKLOCAL,=CL64' '  BLANK WORKING COPY OF TPN             01140000
         LTR   R14,R2             TPN?                                  01150000
         BNP   INITEND            BRANCH IF NOT OK                      01160000
         LTR   R15,R3             TPN LENGTH?                           01170000
         BNP   INITEND            BRANCH IF NOT OK                      01180000
         ICM   R15,B'1000',=C' '  PAD WITH A BLANK IF NECESSARY         01190000
         LA    R2,WRKLOCAL        COPY-TO ADDRESS                       01200000
         LA    R3,64              COPY-TO LENGTH                        01210000
         MVCL  R2,R14             COPY TPN                              01220000
                                                                        01230000
INITEND  DS    0H                                                       01240000
                                                                        01250000
*---------------------------------------------------------------------- 01260000
* ENTRY TRACE                                                           01270000
*---------------------------------------------------------------------- 01280000
                                                                        01290000
         $TRACE *=A(TRC_LU62_IL62ADTK),96 TRACE ENTRY W/ 96 USER BYTES  01300000
         BNZ   NOETRACE                   BRANCH IF NOT TRACING         01310000
         $APITRC IL62ADTK                 TRACE COMMON STUFF            01320000
         ST    RPLIST,24(,R1)             TRACE PARMLIST ADDRESS        01330000
         MVC   32(64,R1),WRKLOCAL         TRACE TPN                     01340000
NOETRACE DS    0H                                                       01350000
                                                                        01360000
*---------------------------------------------------------------------- 01370000
* VALIDATE PARMS                                                        01380000
*---------------------------------------------------------------------- 01390000
                                                                        01400000
         ICM   R1,15,TPN@         WAS A NAME POINTER PROVIDED?          01410000
         BNP   ERRPARM            BRANCH IF NOT                         01420000
         ICM   R1,15,TPNLN        WAS A VALID LENGTH PROVIDED?          01430000
         BNP   ERRPARM            BRANCH IF NOT                         01440000
         C     R1,=F'64'          WAS A VALID LENGTH PROVIDED?          01450000
         BH    ERRPARM            BRANCH IF NOT                         01460000
                                                                        01470000
*---------------------------------------------------------------------- 01480000
* SEE IF THE TKB ALREADY EXISTS                                         01490000
*---------------------------------------------------------------------- 01500000
                                                                        01510000
         ICM   RIPCB,15,TSKPCBC   ACCESS CURRENT IPCB                   01520000
         BZ    ERRPROD            BRANCH IF NOT FOUND                   01530000
         ICM   RTKB,15,PCBIVTAM   ACCESS THE TKB                        01540000
         BNZ   ERRTKB             BRANCH IF IT ALREADY EXISTS           01550000
                                                                        01560000
*---------------------------------------------------------------------- 01570000
* CREATE A TKB FOR THIS PROCESS                                         01580000
*---------------------------------------------------------------------- 01590000
                                                                        01600000
*                                                                       01610000
* ALLOCATE A TRANSACTION_CONTROL_BLOCK                                  01620000
*---------------------------------------------------------------------- 01630000
                                                                        01640000
         LA    R3,L'TKBMAX        ALLOCATE A TKB                        01650000
                                                                        01660000
         $GETSTOR (R3),                                                +01670000
               LOC=ANY,                                                +01680000
               OWNER=(RIPCB)      TKB ALLOCATED IN CURRENT PROCESS      01690000
                                                                        01700000
         LR    RTKB,R1            ESTABLISH ADDRESSABILITY              01710000
         ST    RTKB,PCBIVTAM      ANCHOR TKB TO PROCESS                 01720000
         MVC   TKBID,=CL8'TKB'    SET EYECATCHER                        01730000
         ST    R3,TKBLEN          SET THE LENGTH                        01740000
                                                                        01750000
*                                                                       01760000
* ESTABLISH TRANSACTION CLEANUP ENVIRONMENT                             01770000
*---------------------------------------------------------------------- 01780000
                                                                        01790000
         $RESMGR ADD,             ADD A RESOURCE MANAGER               +01800000
               TOKEN=TKBRMTOK,    PUT RESMGR TOKEN IN TKB              +01810000
               OWNER=(RIPCB),     THE PROCESS IS THE RESOURCE          +01820000
               ROUTINE=*IL6@TPMG, ROUTINE IS IL62TPMG                  +01830000
               PARM=(RTKB),       R1 PARM IS TKB                       +01840000
               MF=(E,$RMGRMFL)                                          01850000
                                                                        01860000
         LTR   R15,R15            RESOURCE MANAGER ADDED?               01870000
         BZ    TKBINIT            BRANCH IF YES                         01880000
         XC    PCBIVTAM,PCBIVTAM  SHOW NO TKB                           01890000
                                                                        01900000
         $RETSTOR (RTKB),                                              +01910000
               OWNER=(RIPCB)      RELEASE TKB STORAGE                   01920000
                                                                        01930000
         B     ERRPROD            FAIL THE REQUEST                      01940000
                                                                        01950000
*                                                                       01960000
* INITIALIZE THE TKB FIELDS                                             01970000
*---------------------------------------------------------------------- 01980000
                                                                        01990000
TKBINIT  DS    0H                                                       02000000
                                                                        02010000
         MVC   TKBTCBID,PCBENTKN        SET THE TKB TCB_ID              02020000
         MVC   TKBTPN,WRKLOCAL          SET TP NAME                     02030000
         MVC   TKBOWNLU,ICTAPL62        SET DEFAULT LOCAL LU            02040000
         MVC   TKBUSER,=CL10' '         NO SECURITY USERID              02050000
         MVC   TKBPROF,=CL10' '         NO SECURITY PROFILE             02060000
         MVC   TKBPSWD,=CL10' '         NO SECURITY PASSWORD            02070000
         MVC   TKBUSERL,=H'0'           NO SECURITY USERID              02080000
         MVC   TKBPROFL,=H'0'           NO SECURITY PROFILE             02090000
         MVC   TKBPSWDL,=H'0'           NO SECURITY PASSWORD            02100000
         ST    RITASK,TKBITASK          SET ITASK POINTER               02110000
         ST    RIPCB,TKBIPCB            SET IPCB  POINTER               02120000
                                                                        02130000
         LA    R14,TKBRC1ST             INITIALIZE RESOURCES_LIST       02140000
         S     R14,=A(RCBNEXT-RCB)      NORMALIZE                       02150000
         O     R14,=X'80000000'         MARK END OF LIST                02160000
         ST    R14,TKBRC1ST             SET NULL RESOURCES_LIST         02170000
         ST    R14,TKBRCLST             SET NULL RESOURCES_LIST         02180000
                                                                        02190000
*                                                                       02200000
* GET START TIME AND DATE                                               02210000
*---------------------------------------------------------------------- 02220000
                                                                        02230000
         BAS   R14,GETTIME        GET THE CURRENT TIME/DATE             02240000
         ST    R0,TKBSTIME        SET TRAN START TIME                   02250000
         ST    R1,TKBSDATE        SET TRAN START DATE                   02260000
                                                                        02270000
*                                                                       02280000
* ISSUE DIAGNOSTIC MESSAGE IS 'VTAMTRACE' IS ACTIVE                     02290000
*---------------------------------------------------------------------- 02300000
                                                                        02310000
         $MSG  999,                     "TPN START.....'               +02320000
               FIELDS=((RTKB),          TKB ADDRESS                    +02330000
               (TSKNAME,8),             ITASK NAME                     +02340000
               (RITASK),                ITASK ADDRESS                  +02350000
               (PCBNAME,8),             IPCB  NAME                     +02360000
               (RIPCB),                 IPCB  ADDRESS                  +02370000
               (TKBTPN,64))             TP NAME                         02380000
                                                                        02390000
         B     RETURN                                                   02400000
                                                                        02410000
*---------------------------------------------------------------------- 02420000
* EXCEPTION ROUTINES                                                    02430000
*---------------------------------------------------------------------- 02440000
                                                                        02450000
ERRPARM  DS    0H                                                       02460000
                                                                        02470000
         MVC   RETCODE,=A(LU62_PARAMETER_ERROR)                         02480000
         B     ERRCOMM                                                  02490000
                                                                        02500000
ERRPROD  DS    0H                                                       02510000
                                                                        02520000
         MVC   RETCODE,=A(LU62_PRODUCT_SPECIFIC_ERROR)                  02530000
         B     ERRCOMM                                                  02540000
                                                                        02550000
ERRTKB   DS    0H                                                       02560000
                                                                        02570000
         MVC   RETCODE,=A(LU62_INT_TKB_EXISTS)                          02580000
         B     ERRCOMM                                                  02590000
                                                                        02600000
ERRCOMM  DS    0H                                                       02610000
                                                                        02620000
         SR    RTKB,RTKB          ENSURE NO TKB POINTER                 02630000
         B     RETURN                                                   02640000
                                                                        02650000
*---------------------------------------------------------------------- 02660000
* EXIT TRACE AND RETURN TO CALLER                                       02670000
*---------------------------------------------------------------------- 02680000
                                                                        02690000
RETURN   DS    0H                                                       02700000
                                                                        02710000
         $TRACE *=A(TRC_LU62_EXIT),16 TRACE ENTRY W/ 16 USER BYTES      02720000
         BNZ   NOXTRACE               BRANCH IF TRACING NOT AVAILABLE   02730000
         MVC   0(8,R1),=CL8'IL62ADTK' MODULE NAME                       02740000
         MVC   8(4,R1),RETCODE        RETURN_CODE VALUE                 02750000
         ST    RTKB,12(,R1)           TKB ADDRESS                       02760000
NOXTRACE DS    0H                                                       02770000
                                                                        02780000
         L     R1,L62PARM3        ADDRESS OF RETURN_CODE AREA           02790000
         MVC   0(4,R1),RETCODE    SET RETURN_CODE VARIABLE              02800000
                                                                        02810000
         SR    R15,R15            FUNCTION RETURN CODE = 0              02820000
         CEXIT RC=(R15),INDEP=YES RETURN                                02830000
                                                                        02840000
*---------------------------------------------------------------------- 02850000
*                                                                       02860000
* ROUTINE: GETTIME - OBTAIN THE CURRENT TIME/DATE                       02870000
*                                                                       02880000
* DESCRIPTION:                                                          02890000
*                                                                       02900000
*    THIS ROUTINE CALLS THE MVS TIME SERVICE FOR CURRENT TIME/DATE.     02910000
*                                                                       02920000
* ENTRY:   N/A                                                          02930000
*                                                                       02940000
* EXIT:    ALL REGISTERS ARE RESTORED EXCEPT:                           02950000
*          R0 = TIME(4) = HHMMSSTH                                      02960000
*          R1 = DATE(4) = 0DDDYYYY                                      02970000
*---------------------------------------------------------------------- 02980000
                                                                        02990000
GETTIME  DS    0H                                                       03000000
                                                                        03010000
         STM   R0,R15,SUB0SAVE    SAVE CALLER'S REGISTERS               03020000
                                                                        03030000
         TIME  DEC,                                                    +03040000
               LINKAGE=SVC        R0=HHMMSSTH R1=0CYYDDDF               03050000
                                                                        03060000
         LR    R2,R1              R2=0CYYDDDF                           03070000
         SRL   R1,4               R1=00CYYDDD                           03080000
         SLL   R1,20              R1=DDD00000                           03090000
         SRL   R1,4               R1=0DDD0000                           03100000
         SRL   R2,16              R2=00000CYY                           03110000
         C     R2,=X'000000FF'    IS THIS 20TH CENTURY?                 03120000
         BNH   GET20TH            BRANCH IF YES                         03130000
         ICM   R2,B'0010',=X'20'  SET 21ST CENTURY                      03140000
         B     GETBOTH            NOW COMBINE DAY AND YEAR              03150000
                                                                        03160000
GET20TH  DS    0H                                                       03170000
                                                                        03180000
         ICM   R2,B'0010',=X'19'  SET 20TH CENTURY                      03190000
                                                                        03200000
GETBOTH  DS    0H                                                       03210000
                                                                        03220000
         OR    R1,R2              R1=0DDDYYYY                           03230000
                                                                        03240000
         LM    R2,R15,SUB0SAVE+8  RESTORE CALLER'S REGISTERS            03250000
         BR    R14                RETURN                                03260000
                                                                        03270000
*---------------------------------------------------------------------- 03280000
* LITERALS AND CONSTANTS                                                03290000
*---------------------------------------------------------------------- 03300000
                                                                        03310000
         LTORG ,                                                        03320000
                                                                        03330000
         PRINT NOGEN                                                    03340000
         ISTDBIND ,               VTAM BIND IMAGE                       03350000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                03360000
         IKJTCB ,                 MVS TASK CONTROL BLOCK                03370000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         03380000
         ICVT  ,                  INTEGRATOR CVT                        03390000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   03400000
         ITASK ,                  INTEGRATOR TASK BLOCK                 03410000
         IPCB ,                   INTEGRATOR PROCESS BLOCK              03420000
         IACB ,                   INTEGRATOR VTAM ACB                   03430000
         ABCODES ,                INTEGRATOR $ABEND CODES               03440000
         EVCODES ,                INTEGRATOR EVENT CODES                03450000
         ISESS ,                  INTEGRATOR SESSION BLOCK              03460000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            03470000
         IRPL ,                   INTEGRATOR VTAM RPL                   03480000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          03490000
         $RESMGR DSECT=YES        INTEGRATOR $RESMGR SERVICES           03500000
         END   ,                                                        03510000

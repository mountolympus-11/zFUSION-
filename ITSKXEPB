ITSKXEPB TITLE '- ALLOC/FREE EXTENDED EVENT PROCESS BLOCK (XEPB)'       00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* Routine: ITSKXEPB - Alloc/Free Extended Event Process Block           00040000
*                                                                       00050000
* Description:                                                          00060000
*                                                                       00070000
*    This routine will alloc/free an extended event process             00080000
*    block.  Extended EPBs are used specifically for inter              00090000
*    task communications.  This recoverable resource allows             00100000
*    either side of the conversation to terminate successfully          00110000
*    or abnormally without suffering storage misuse and not             00120000
*    being notified of event completion.                                00130000
*                                                                       00140000
*    The extended EPB is allocated using $GETSTOR storage               00150000
*    with no ownership.  XEPB's are then chained from the               00160000
*    requesting ITASK and the processing ITASK (posting).               00170000
*                                                                       00180000
*    When a task terminates,  its XEPB queues are scanned so            00190000
*    that the appropriate action can be taken.                          00200000
*                                                                       00210000
* On Entry:                                                             00220000
*                                                                       00230000
*    R1 Contains Addr of the parameter list as follows:                 00240000
*                                                                       00250000
*        +0 -  0 - Allocate XEPB                                        00260000
*             >0 - Delete   XEPB, dechain and free all deleted          00270000
*             <0 - Dechain and free all deleted XEPBs                   00280000
*                                                                       00290000
*        +4 - Requestors ITASK address   (ALLOC)                        00300000
*                                                                       00310000
*        +8 - Processors ITASK address   (ALLOC)                        00320000
*                                                                       00330000
* On Exit:                                                              00340000
*                                                                       00350000
*    R15 Contains one of the following return codes:                    00360000
*                                                                       00370000
*        RC00 - Normal Completion                                       00380000
*               R1 = Address of XEPB (Alloc)                            00390000
*                                                                       00400000
*        RC08 - Request Failed                                          00410000
*               R0 = RSN04 - Unable to locate XEPB to free              00420000
*                                                                       00430000
*        RC12 - Service Failure                                         00440000
*               R0 = RSN04 - Storage Error                              00450000
*                    RSN08 - Unable to acquire lock                     00460000
*                                                                       00470000
**<DOC-OFF>*****************************************************        00480000
                                                                        00490000
         EJECT ,                                                        00500000
****************************************************************        00510000
*                                                                       00520000
* Maintenance:                                                          00530000
*                                                                       00540000
*   05/14/93 Ron Colmone                                                00550000
*            Initial Version                                            00560000
*                                                                       00570000
*   12/20/94 Ron Colmone          Par# 159456                           00580000
*            XEPB are now allocated in $GETSTOR storage cellpools:      00590000
*                                                                       00600000
*   09/13/95 Ron Colmone          Par# 215477                           00610000
*                                                                       00620000
*            Global XEPB chain has been removed,  XEPBs are now         00630000
*            queued from the ITASK requesting the XEPB via the          00640000
*            SETEPB service and the ITASK responsible for posting       00650000
*            the EPB.  This task is either identified on the            00660000
*            SETEPB or subsequently on a PCSEPB request.                00670000
*                                                                       00680000
*            Note:  Since the changes introduced by this par            00690000
*                   effected nearly the entire module, the lines        00700000
*                   changed are not identified by change tags.          00710000
*                                                                       00720000
****************************************************************        00730000
                                                                        00740000
         EJECT ,                                                        00750000
         @EPB  TYPE=DSECT         EVENT PROCESS BLOCK MAPPING           00760000
                                                                        00770000
         EJECT ,                                                        00780000
         XEPB  ,                  EXTENDED EPB MAPPING                  00790000
                                                                        00800000
         EJECT ,                                                        00810000
         EQUS  ,                  GENERAL EQUATES                       00820000
                                                                        00830000
         EJECT ,                                                        00840000
         #WORK LENGTH=256         READ/WRITE WORKAREA                   00850000
REGSAVE  DS    16F                REGISTER SAVE AREA                    00860000
FLAGS    DS    X                  SERIALIZATION FLAG                    00870000
$LOCKED  EQU   X'80'              SERIALIZATION ACQUIRED                00880000
         #ENDWORK                 END OF WORKAREA                       00890000
                                                                        00900000
         EJECT ,                                                        00910000
ITSKXEPB #ENTER BASE=R12,         ENTRY LINKAGE                        +00920000
               PREG=R8,                                                +00930000
               WAPASS=YES                                               00940000
                                                                        00950000
         LM    R6,R8,0(R8)        ADDRESS OF XEPB                       00960000
R        USING ITASK,R7           REQUESTORS ITASK (ALLOC req only)     00970000
P        USING ITASK,R8           PROCESSORS ITASK (ALLOC req only)     00980000
         USING ITASK,R10          CURRENT ITASK                         00990000
                                                                        01000000
         LTR   R6,R6              DETERMINE REQUEST TYPE                01010000
         BZ    XEPBALOC            0 - ALLOC  XEPB                      01020000
         BP    XEPBDEL            >0 - DELETE XEPB                      01030000
         BM    XEPBFREE           <0 - FREE   XEPBS                     01040000
                                                                        01050000
         EJECT ,                                                        01060000
****************************************************************        01070000
*                                                                       01080000
*  Allocate XEPB and add to requestor and processor ITASK queues        01090000
*                                                                       01100000
****************************************************************        01110000
XEPBALOC DS    0H                                                       01120000
         BAS   R14,GETLOCK        ACQUIRE DISP LOCK                     01130000
         BNZ   ERR_LOCK           ERROR, LOCK FAILURE                   01140000
                                                                        01150000
         $GETSTOR XEPBLENG,QHDR=0,COND=YES  ALLOC STG FOR XEPB   159456 01160000
         BNZ   ERR_STG            UNABLE TO ALLOC STG                   01170000
                                                                        01180000
         LR    R6,R1              ADDR OF XEPB                          01190000
         USING XEPB,R6            ADDRESSABILITY                        01200000
STD      USING EPB,R6             ADDRESSABILITY                        01210000
                                                                        01220000
         XC    XEPB(XEPBLENG),XEPB  CLEAR XEPB                          01230000
         MVC   STD.EPBID,=C'EPB '   EPB EYE CATCHER                     01240000
         OI    STD.EPBFLGS,EPB$XND  INDICATE EXTEND EPB                 01250000
                                                                        01260000
         ST    R7,XEPBRTSK        REQUESTOR ITASK ADDRESS               01270000
         ST    R8,XEPBPTSK        PROCESSOR ITASK ADDRESS               01280000
                                                                        01290000
*--------------------------------------------------------------         01300000
*  Add XEPB to requesting ITASK XEPB queue                              01310000
*--------------------------------------------------------------         01320000
ALLC_REQ DS    0H                                                       01330000
         L     R1,R.TSKXEPQR+4    END OF REQUESTOR XEPB QUEUE           01340000
L        USING XEPB,R1            ADDRESSABILITY TO XEPB END            01350000
         ST    R1,XEPBRPRV        PREVIOUS TO LAST ENTRY                01360000
         ST    R6,L.XEPBRNXT      ADD TO END OF LIST                    01370000
         ST    R6,R.TSKXEPQR+4    UPDATE NEW END OF CHAIN               01380000
         DROP  L                  XEPB                                  01390000
                                                                        01400000
*--------------------------------------------------------------         01410000
*  Add XEPB to Processing ITASK XEPB queue, if specified                01420000
*--------------------------------------------------------------         01430000
ALLC_PRC DS    0H                                                       01440000
         LTR   R8,R8              PROCESSOR SPECIFIED?                  01450000
         BZ    ALLC_END           NO, RETURN                            01460000
         CR    R7,R8              REQUESTOR = PROCESSOR                 01470000
         BE    ALLC_END           NO NEED TO QUEUE TO PROCESSOR Q       01480000
                                                                        01490000
         L     R1,P.TSKXEPQP+4    END OF PROCESSOR XEPB QUEUE           01500000
L        USING XEPB,R1            ADDRESSABILITY TO XEPB END            01510000
         ST    R1,XEPBPPRV        PREVIOUS TO LAST ENTRY                01520000
         ST    R6,L.XEPBPNXT      ADD TO END OF LIST                    01530000
         ST    R6,P.TSKXEPQP+4    UPDATE NEW END OF CHAIN               01540000
         DROP  L                  XEPB                                  01550000
                                                                        01560000
*--------------------------------------------------------------         01570000
*  Return XEPB address                                                  01580000
*--------------------------------------------------------------         01590000
ALLC_END DS    0H                                                       01600000
         LA    R1,XEPB            RETURN XEPB ADDRESS                   01610000
         LA    R15,RC00           NORMAL COMPLETION                     01620000
         B     RETURN             RETURN                                01630000
                                                                        01640000
         DROP  STD,P,R            EPB STANDARD, ITASK( PRC,REQ)         01650000
                                                                        01660000
         EJECT ,                                                        01670000
****************************************************************        01680000
*                                                                       01690000
*  Mark XEPB as deleted and process entire xepb queue removing          01700000
*  deleted XEPBs.                                                       01710000
*                                                                       01720000
****************************************************************        01730000
XEPBDEL  DS    0H                                                       01740000
         $XEPB LDELETE,XEPB=XEPB  MARK XEPB AS DELETED                  01750000
                                                                        01760000
****************************************************************        01770000
*                                                                       01780000
*  Remove XEPBs from the Requestor and Processor XEPB queue             01790000
*  that have been marked as deleted.                                    01800000
*                                                                       01810000
****************************************************************        01820000
XEPBFREE DS    0H                                                       01830000
         BAS   R14,GETLOCK        REQUEST SERIALIZATION                 01840000
         BNZ   ERR_LOCK           ERROR, LOCK FAILURE                   01850000
                                                                        01860000
         LA    R1,TSKXEPQR        ITASK REQUESTOR XEPB QUEUE            01870000
         LH    R0,=AL2(XEPBRNXT-XEPB)  OFFSET TO NEXT PTR               01880000
         BAS   R14,FREEXEPB       FREE DELETED XEPBS                    01890000
                                                                        01900000
         LA    R1,TSKXEPQP        ITASK PROCESSOR XEPB QUEUE            01910000
         LH    R0,=AL2(XEPBPNXT-XEPB)  OFFSET TO NEXT PTR               01920000
         BAS   R14,FREEXEPB       FREE DELETED XEPBS                    01930000
                                                                        01940000
         LA    R15,RC00           NORMAL COMPLETION                     01950000
         B     RETURN             RETURN                                01960000
                                                                        01970000
         EJECT ,                                                        01980000
****************************************************************        01990000
*                                                                       02000000
*   ERROR EXIT                                                          02010000
*                                                                       02020000
****************************************************************        02030000
                                                                        02040000
ERR_XEPB DS    0H                                                       02050000
         LA    R0,RSN04           INVALID XEPB ADDRESS (FREE)           02060000
         B     RET_RC08                                                 02070000
                                                                        02080000
ERR_STG  DS    0H                                                       02090000
         LA    R0,RSN04           STORAGE ERROR                         02100000
         B     RET_RC12                                                 02110000
                                                                        02120000
ERR_LOCK DS    0H                                                       02130000
         LA    R0,RSN08           LOCK OBTAIN FAILED                    02140000
         B     RET_RC12                                                 02150000
                                                                        02160000
         EJECT ,                                                        02170000
****************************************************************        02180000
*                                                                       02190000
*   RETURN                                                              02200000
*                                                                       02210000
****************************************************************        02220000
                                                                        02230000
RET_RC08 DS    0H                                                       02240000
         LA    R15,RC08           SERVICE FAILURE                       02250000
         B     RETURN                                                   02260000
                                                                        02270000
RET_RC12 DS    0H                                                       02280000
         LA    R15,RC12           ABNORMAL RETURN                       02290000
         B     RETURN                                                   02300000
                                                                        02310000
RETURN   DS    0H                                                       02320000
         BAS   R14,RELLOCK        RELEASE ACQUIRED LOCKS                02330000
         #EXIT ,                  RETURN                                02340000
                                                                        02350000
         EJECT ,                                                        02360000
****************************************************************        02370000
*                                                                       02380000
*  Routine: FREEXEPB - Remove and free deleted XEPBs from queue         02390000
*                                                                       02400000
*  Description:                                                         02410000
*                                                                       02420000
*    This routine will scan the passed XEPB chain and remove            02430000
*    entries that have been marked as deleted.                          02440000
*                                                                       02450000
*  Entry:  R1  - Address of Queue header                                02460000
*          R0  - Offset to next pointer in XEPB                         02470000
*                                                                       02480000
*  Exit:   N/A                                                          02490000
*                                                                       02500000
****************************************************************        02510000
FREEXEPB DS    0H                                                       02520000
         STM   R0,R15,REGSAVE     SAVE CALLERS REGISTERS                02530000
                                                                        02540000
         LR    R2,R0              OFFSET  TO NEXT POINTER               02550000
         LR    R9,R1              SAVE QHEADER ADDRESS                  02560000
         LR    R4,R1              ADDRESS OF QUEUE HEADER               02570000
Q        USING XEPB,R4            ADDRESSABILITY                        02580000
                                                                        02590000
FREE_NXT DS    0H                                                       02600000
         ICM   R4,15,0(R4)        ADDR OF NEXT XEPB                     02610000
         BZ    FREE_END           INVALID XEPB, RELEASE LOCK            02620000
         TM    Q.XEPBFLGS,XEPB$DEL XEPB DELETED?                        02630000
         BO    FREE_REM           YES, REMOVE FROM XEPB QUEUE           02640000
         AR    R4,R2                                                    02650000
         B     FREE_NXT           CHECK NEXT ENTRY                      02660000
                                                                        02670000
*---------------------------------------------------------------        02680000
*  Remove the XEPB from the specified queue                             02690000
*---------------------------------------------------------------        02700000
FREE_REM DS    0H                                                       02710000
         LR    R3,R4              COPY XEPB ADDRESS                     02720000
D        USING XEPB,R3            ADDRESSABILITY XEPB (DEL)             02730000
                                                                        02740000
         L     R4,4(R2,R3)        ADDRESS OF PREV XEPB                  02750000
         AR    R4,R2              ADDRESS OF QUEUE LINKAGE (PREV)       02760000
                                                                        02770000
         $XEPB REMOVE,XEPB=(R3),QOFFSET=(R2),QHDR=(R9)                  02780000
                                                                        02790000
*---------------------------------------------------------------        02800000
*  If XEPB is still queued to requesting ITASK,  then remove            02810000
*  from requestor's ITASK XEPB queue.                                   02820000
*---------------------------------------------------------------        02830000
         OC    D.XEPBRNXT(8),D.XEPBRNXT  STILL IN REQUESTOR QUEUE       02840000
         BZ    FREE_PCK                  NO, CHECK PROCESSOR QUEUE      02850000
         ICM   R7,15,D.XEPBRTSK          REQUESTOR ITASK                02860000
         BZ    FREE_PCK                  NO PROCESS ITASK               02870000
RT       USING ITASK,R7                  ADDRESSIBILITY ITASK (REQ)     02880000
                                                                        02890000
         $XEPB REMOVE,XEPB=(R3),QTYPE=R,QHDR=RT.TSKXEPQR                02900000
         B     FREE_EPB                  RELEASE XEPB STORAGE           02910000
                                                                        02920000
         DROP  RT                                                       02930000
                                                                        02940000
*---------------------------------------------------------------        02950000
*  If XEPB is still queued to processing ITASK,  then remove            02960000
*  from Processor's ITASK XEPB queue.                                   02970000
*---------------------------------------------------------------        02980000
FREE_PCK DS    0H                                                       02990000
         OC    D.XEPBPNXT(8),D.XEPBPNXT  STILL IN PROCESSOR QUEUE       03000000
         BZ    FREE_EPB                  NO, FREE XEPB STORAGE          03010000
         ICM   R7,15,D.XEPBPTSK          PROCESSOR ITASK                03020000
         BZ    FREE_EPB                  NO PROCESS ITASK               03030000
PT       USING ITASK,R7                  ADDRESSIBILITY ITASK (PROC)    03040000
                                                                        03050000
         $XEPB REMOVE,XEPB=(R3),QTYPE=P,QHDR=PT.TSKXEPQP                03060000
         DROP  PT,D                                                     03070000
                                                                        03080000
*---------------------------------------------------------------        03090000
*  Release XEPB storage                                                 03100000
*---------------------------------------------------------------        03110000
FREE_EPB DS    0H                                                       03120000
         $RETSTOR (R3)            RELEASE XEPB STORAGE                  03130000
                                                                        03140000
         B     FREE_NXT           PROCESS NEXT XEPB                     03150000
                                                                        03160000
FREE_END DS    0H                                                       03170000
         LM    R0,R15,REGSAVE     RESTORE CALLERS REGISTERS             03180000
         BR    R14                RETURN                                03190000
                                                                        03200000
         EJECT ,                                                        03210000
****************************************************************        03220000
*                                                                       03230000
*  Routine: GETLOCK - Acquire DISP lock                                 03240000
*                                                                       03250000
****************************************************************        03260000
GETLOCK  DS    0H                                                       03270000
         STM   R0,R15,REGSAVE     SAVE CALLERS REGISTERS                03280000
                                                                        03290000
         $SER  OBTAIN,DISP        REQUEST SERIALIZATION                 03300000
         B     *+4(R15)           BRANCH ON LOCK RETURN CODE            03310000
         B     GETL_OBT           0 - LOCK OBTAINED                     03320000
         B     GETL_HAV           4 - LOCK ALREADY OWNED                03330000
         B     GETL_ERR           8 - UNABLE TO ACQUIRE LOCK            03340000
                                                                        03350000
GETL_OBT DS    0H                                                       03360000
         OI    FLAGS,$LOCKED      LOCK OBTAINED                         03370000
                                                                        03380000
GETL_HAV DS    0H                                                       03390000
         LA    R15,RC00           NORMAL COMPLETION                     03400000
         B     GETL_RET           RETURN                                03410000
                                                                        03420000
GETL_ERR DS    0H                                                       03430000
         LA    R15,RC08           UNABLE TO ACQUIRE LOCK                03440000
                                                                        03450000
GETL_RET DS    0H                                                       03460000
         LM    R0,R14,REGSAVE     RESTORE CALLERS REGISTERS             03470000
         LTR   R15,R15            SET CONDITION CODE                    03480000
         BR    R14                RETURN                                03490000
                                                                        03500000
         EJECT ,                                                        03510000
****************************************************************        03520000
*                                                                       03530000
*  Routine: RELLOCK - Release DISP lock                                 03540000
*                                                                       03550000
****************************************************************        03560000
RELLOCK  DS    0H                                                       03570000
         STM   R0,R15,REGSAVE     SAVE CALLERS REGISTERS                03580000
                                                                        03590000
         TM    FLAGS,$LOCKED      SERIALIZATION ACQUIRED?               03600000
         BZ    RELL_RET           NO, RETURN                            03610000
         $SER  RELEASE,DISP       RELEASE SERIALIZATION                 03620000
                                                                        03630000
RELL_RET DS    0H                                                       03640000
         LM    R0,R15,REGSAVE     RESTORE CALLERS REGISTERS             03650000
         BR    R14                RETURN                                03660000
                                                                        03670000
         EJECT ,                                                        03680000
****************************************************************        03690000
*                                                                       03700000
*  CONSTANTS AND LITERALS                                               03710000
*                                                                       03720000
****************************************************************        03730000
                                                                        03740000
         LTORG ,                                                        03750000
                                                                        03760000
         PRINT NOGEN                                                    03770000
         ICVT  ,                                                        03780000
         ITASK ,                                                        03790000
         PRINT GEN                                                      03800000
                                                                        03810000
         END   ,                                                        03820000

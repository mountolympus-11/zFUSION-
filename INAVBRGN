INAVBRGN TITLE '- CONSTRUCT REGION NETWORK'                             00010000
***************************************************************         00020000
*                                                                       00030000
*   LOCAL READ/WRITE WORKING STORAGE                                    00040000
*                                                                       00050000
***************************************************************         00060000
         #WORK ,                   READ/WRITE WORKAREA                  00070000
CURRSSET DS    A                   ADDR OF LAST REF'D EXRGNET           00080000
@SYSRGNL DS    F                   LENGTH OF SYSREGION LAST READ        00090000
RCRGNNET DS    F                   HIGHEST RGNNET RETCODE               00100000
                                                                        00110000
AUXBUFL  DS    F                   LENGTH OF AUXBUFR OR ZERO            00120000
AUXBUFR  DS    A                   AUXILLIARY SYSRGNS ROW BUFFER        00130000
                                                                        00140000
STATREGS DS    4F                  R14-R1 STATUS PRESERVATION AREA      00150000
REGSAVE  DS    16F                 LOCAL ROUTINE REGISTER SAVEAREA      00160000
REGSAVE2 DS    16F                 LOCAL ROUTINE REGISTER SAVEAREA      00170000
*                                                                       00180000
WK256    DS    XL256               GENERAL PURPOSE WORKAREA             00190000
RGNBUFR  DS    XL512               SYSRGNS FETCH ROW BUFFER             00200000
         #ENDWORK ,                END OF WORKAREA                      00210000
                                                                        00220000
         EJECT ,                                                        00230000
         RBUFNF ,                                                       00240000
                                                                        00250000
         EJECT ,                                                        00260000
         REGION ,                                                       00270000
                                                                        00280000
         EJECT ,                                                        00290000
         EXRGNET ,                                                      00300000
                                                                        00310000
         EJECT ,                                                        00320000
         ICATALOG REGION                                                00330000
                                                                        00340000
         EJECT ,                                                        00350000
         TBSERVIS SET,GET                                               00360000
                                                                        00370000
         EJECT ,                                                        00380000
         EQUS  ,                                                        00390000
                                                                        00400000
         EJECT ,                                                        00410000
**<DOC-ON>*****************************************************         00420000
*                                                                       00430000
* ROUTINE:  INAVBRGN - BUILD AND VALIDATE SCREEN REGION NETWORK         00440000
*                                                                       00450000
* DESCRIPTION:                                                          00460000
*                                                                       00470000
*    WHEN CALLED WITH A NON-ZERO REQUEST CODE, THE REGION TREE          00480000
*    ASSOCIATED WITH EACH SCREEN / SCREEN SET IN THE CURRENT            00490000
*    PROJECT IS REBUILT IF THE SYSREGIONS TABLE HAS BEEN                00500000
*    UPDATED SINCE THE LAST REQUEST. IF SYSREGIONS IS HAS NOT           00510000
*    BEEN UPDATED, NO REBUILD OCCURS.                                   00520000
*                                                                       00530000
*                                                                       00540000
* ON ENTRY:                                                             00550000
*                                                                       00560000
*    R1  CONTAINS ADDRESS OF ASSOCIATED IPROJ                           00570000
*                                                                       00580000
* ON EXIT:                                                              00590000
*                                                                       00600000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES                     00610000
*                                                                       00620000
*        RC00 - OPERATION COMPLETE                                      00630000
*                                                                       00640000
*        RC04 - RESERVED                                                00650000
*                                                                       00660000
*        RC08 - AT LEAST ONE REGION TREE COULD NOT BE BUILT.            00670000
*               THE INVALID EXRNET NODES CONTAIN THE RGNNET             00680000
*               SERVICE ROUTINE RETURN CODE.                            00690000
*                                                                       00700000
*        RC12 - TABLE SERVICES FAILURE                                  00710000
*                                                                       00720000
*               R1 - TABLE SERVICES RSN:RC CODES                        00730000
*                                                                       00740000
*        RC16 - STORAGE DEPLETED OR STGGET ERROR                        00750000
*                                                                       00760000
*               R1 - STGGET RETURN CODE                                 00770000
*                                                                       00780000
**<DOC-OFF>****************************************************         00790000
                                                                        00800000
         EJECT ,                                                        00810000
***************************************************************         00820000
*                                                                       00830000
* MAINTENANCE:                                                          00840000
*                                                                       00850000
*   02/XX/93  R. TURGEON                                                00860000
*             INITIAL VERSION                                           00870000
*                                                                       00880000
*   08/11/93  RON COLMONE                                               00890000
*             CONVERTED FOR NEW EXECUTION ENVIRONMENT                   00900000
*                                                                       00910000
***************************************************************         00920000
                                                                        00930000
         EJECT ,                                                        00940000
INAVBRGN #ENTER BASE=R12,PREG=R8                                        00950000
                                                                        00960000
         USING ITASK,R10               ITASK ADDRESSABILITY             00970000
         L     R9,TSKPCBC              CURRENT PROCESS                  00980000
         USING IPCB,R9                 IPCB  ADDRESSABILITY             00990000
         USING IPROJ,R8                IPROJ ADDRESSABILITY             01000000
                                                                        01010000
         EJECT ,                                                        01020000
***************************************************************         01030000
*                                                                       01040000
*   READ ALL SYSREGION DEFINITIONS.  BECAUSE SYSREGIONS ARE             01050000
*   VARIABLE LENGTH ENTRIES, AN AUXILIARY BUFFER WILL BE                01060000
*   ALLOCATED IF ANY SYSREGION LENGTH EXCEEDS THE SIZE OF THE           01070000
*   LOCAL WORKAREA USED INITIALLY.                                      01080000
*                                                                       01090000
***************************************************************         01100000
         TBSET TTOKEN=PRJTKRGN,        PREPARE FOR SYSRGN SCAN         X01110000
               INDEX='PRIMARY',        SEARCH ARG IS PART OF KEY       X01120000
               POS=TOP,                FROM THE TOP                    X01130000
               MF=(E,MFE_LIST)                                          01140000
                                                                        01150000
         LTR   R15,R15                                                  01160000
         BNZ   ERR_TBSV                                                 01170000
                                                                        01180000
*--------------------------------------------------------------         01190000
*   READ ALL REGION DEFINITIONS                                         01200000
*--------------------------------------------------------------         01210000
FET_RGN  DS    0H                      FETCH REGION DEFINITION          01220000
         L     R4,AUXBUFR              EXTENDED BUFFER                  01230000
         ICM   R3,15,AUXBUFL           EXTENDED BUFFER LENGTH           01240000
         BNZ   FET_READ                USE ACQUIRED BUFFER              01250000
         LA    R4,RGNBUFR              USUAL SYSREGIONS BUFFER          01260000
         LA    R3,L'RGNBUFR            LENGTH OF USUAL BUFFER           01270000
                                                                        01280000
FET_READ DS    0H                                                       01290000
         TBGET (R4),                   ROW DELIVERY AREA               X01300000
               LENGTH=(R3),            SIZE OF DELIVERY AREA           X01310000
               POS=NEXT,               SEQUENTIAL FROM TOP TO BOT      X01320000
               INDEX='PRIMARY',        ACCESS VIA INDEX                X01330000
               TTOKEN=PRJTKRGN,        CATALOG FOUND IN PROJECT        X01340000
               MF=(E,MFE_LIST)                                          01350000
                                                                        01360000
         CH    R15,=AL2(RC16)          STANDARD TABLE SERVICES RETC     01370000
         BH    ERR_TBSV                SERVICE ROUTINE FAILURE          01380000
                                                                        01390000
         B     *+4(R15)                ANALYZE RETURN CODE              01400000
         B     FET_OK                     RC00 - ROW READ SUCCESSFULLY  01410000
         B     FET_RC04                   RC04 - MULTIPLE CAUSES        01420000
         B     ERR_TBSV                   RC08 - RESERVED               01430000
         B     ERR_TBSV                   RC12 - REQUEST IN ERROR       01440000
         B     ERR_TBSV                   RC16 - OBJECT SERVICE FAILURE 01450000
                                                                        01460000
*--------------------------------------------------------------         01470000
*   WARNING INDICATES END-TABLE OR INSUFFICIENT BUFFER SPACE            01480000
*--------------------------------------------------------------         01490000
FET_RC04 DS    0H                      TABLE SERVICES WARNING           01500000
         LTR   R2,R0                   END OF TABLE?                    01510000
         BZ    FET_CPT                 FETCH COMPLETED IF SO            01520000
                                                                        01530000
         ICM   R4,15,AUXBUFR           EXTENDED BUFFER PREV ACQUIRED?   01540000
         BZ    FET_REAL                SKIP IF NOT                      01550000
         L     R3,AUXBUFL              LENGTH OF BUFFER                 01560000
         STGRETN ADDR=(R4),LEN=(R3),QH=PRJEXSTG                         01570000
                                                                        01580000
FET_REAL DS    0H                                                       01590000
         LA    R3,0(R2,R2)             LENGTH REQUIRED AND THEN SOME    01600000
         STGGET (R3),QH=PRJEXSTG       INVOKE STORAGE SERVICE           01610000
         BNZ   ERR_STG                 FAIL OTHERWISE                   01620000
         ST    R1,AUXBUFR              POST NEW BUFFER ADDRESS          01630000
         ST    R3,AUXBUFL              POST NEW BUFFER LENGTH           01640000
         B     FET_RGN                                                  01650000
                                                                        01660000
***************************************************************         01670000
*                                                                       01680000
*   ATTACH THE SYSREGION ENTRY ACQUIRED TO THE APPROPRIATE              01690000
*   SCREEN SET.  THE TECHNIQUE USED BELOW DOES NOT REQUIRE              01700000
*   SYSREGION ROW DELIVERY BY SCREEN SET.                               01710000
*                                                                       01720000
***************************************************************         01730000
FET_OK   DS    0H                                                       01740000
         USING SYSRGN,R4               SYSREGION ROW                    01750000
         ST    R1,@SYSRGNL             LENGTH OF SYSREGION READ         01760000
         ICM   R0,15,SRLMETH+4         PTR TO VARBINX LOCATOR METHOD    01770000
         BZ    *+6                     NO METHOD PROVIDED               01780000
         SR    R0,R4                   CONVERT TO OFFSET                01790000
         ST    R0,SRLMETH+4            PTR TO VARBINX LOCATOR METHOD    01800000
                                                                        01810000
         ICM   R5,15,CURRSSET          LOCATE CURRENT SCREEN SET        01820000
         BZ    NEW_SSET                NOT INITIALIZED                  01830000
         USING EXRGNET,R5              SCREEN SET / REGION IDENTIFIER   01840000
         CLC   EXRNSSET,SRSSET         CONTINUING DEFINTION OF SET?     01850000
         BE    USE_SSET                ONWARD IF SO                     01860000
                                                                        01870000
*--------------------------------------------------------------         01880000
*   LOCATE SCREEN SET REGION IDENTIFIER                                 01890000
*--------------------------------------------------------------         01900000
         LA    R1,SRSSET               R1 <== SCREEN SET NAME           01910000
         @CALL ILOCSSET,CTYPE=CVT      LOCATE SCREEN SET DESCRIPTOR     01920000
         LTR   R15,R15                 SCREEN SET / REGION IN PROGRESS? 01930000
         BNZ   NEW_SSET                NEED NEW EXRGNET IF NOT          01940000
         LR    R5,R1                   USE RETURNED STRUCTURE           01950000
         B     USE_SSET                REJOIN                           01960000
                                                                        01970000
*--------------------------------------------------------------         01980000
*   NEW SSET NAME ENCOUNTERED, BUILD AND QUEUE NEW EXRGNET              01990000
*--------------------------------------------------------------         02000000
NEW_SSET DS    0H                                                       02010000
         LA    R3,EXRGNETL             LENGTH OF REGION NET IDENTIFIER  02020000
         STGGET (R3),QH=PRJEXSTG       INVOKE STORAGE SERVICE           02030000
         BNZ   ERR_STG                 STORAGE ACQUIRED?                02040000
                                                                        02050000
         LR    R5,R1                   CLEARED STORAGE BLOCK            02060000
         USING EXRGNET,R5              REMINDER                         02070000
         MVC   EXRNSSET,SRSSET         SCREEN SET NAME                  02080000
         MVC   EXRNEXT,PRJEXRGN        ADD IDENTIFIER TO CHAIN          02090000
         ST    R5,PRJEXRGN             A STACK, ACTUALLY                02100000
                                                                        02110000
*--------------------------------------------------------------         02120000
*   CONSTRUCT AND STORE RGNTRY / SYSREGION PAIR                         02130000
*--------------------------------------------------------------         02140000
USE_SSET DS    0H                                                       02150000
         ST    R5,CURRSSET             CURRENT SCREEN SET/RGN ID BLOCK  02160000
         L     R0,@SYSRGNL             LENGTH OF SYSREGION              02170000
         LA    R1,SYSRGN               ADDRESS OF SYSREGION             02180000
         LA    R15,EXRNBUFR            BUFFER PTR                       02190000
         BAS   R14,STORGN              CREATE SYSRGN/RGNTRY PAIR        02200000
         LTR   R15,R15                 SUCCESS?                         02210000
         BNZ   ERR_STG                 STORAGE MGMT PROBLEM OTHERWISE   02220000
                                                                        02230000
         L     R15,EXRNTRYS            NUMBER OF REGIONS ACCEPTED       02240000
         LA    R15,1(,R15)             ACCOUNT FOR THIS ONE             02250000
         ST    R15,EXRNTRYS            SAVE UPDATED COUNT               02260000
         B     FET_RGN                 ACQUIRE NEXT REGION              02270000
         DROP  R4,R5                   SYSRGN, EXRGNET                  02280000
                                                                        02290000
         EJECT ,                                                        02300000
***************************************************************         02310000
*                                                                       02320000
*   REGION FETCH COMPLETE - BUILD RGNTREES FOR ALL SCREEN SETS          02330000
*                                                                       02340000
***************************************************************         02350000
FET_CPT  DS    0H                                                       02360000
         ICM   R5,15,PRJEXRGN          CHAIN OF SCREEN SET BLOCKS       02370000
         USING EXRGNET,R5              FORMAT                           02380000
         BZ    FINISH                                                   02390000
                                                                        02400000
BLDTREE  DS    0H                                                       02410000
         L     R1,EXRNBUFR             BUFFER PTR AS PARM               02420000
         BAS   R14,BUFCVTA             CONVERSIONS / CLEANUP            02430000
         L     R1,EXRNTRYS             R1 <== # RGNTRY/SYSRGN PAIRS     02440000
         L     R0,EXRNBUFR             R0 <== NEAR/FAR BUFFER           02450000
         BAS   R14,RLINKUP             COMPLETE RGNTRY->SYSRGN LINKAGES 02460000
         ST    R1,EXRNTLST             SAVE ADDR OF RGNTRY ARRAY        02470000
                                                                        02480000
         L     R2,EXRNTLST             ADDR OF RGNTRY ARRAY             02490000
                                                                        02500000
         $CLINK FUNC=RGNNET,                                           X02510000
               (STRUCT*,EXRNROOT),                                     X02520000
               (STRUCT*,WK256),                                        X02530000
               (STRUCT*,(R2)),                                         X02540000
               (INT,EXRNTRYS)                                           02550000
                                                                        02560000
         ST    R15,EXRNRC              SAVE RETCODE AS STATUS           02570000
         C     R15,RCRGNNET            HIGHEST RETCODE ENCOUNTERED?     02580000
         BNH   *+8                     SKIP IF NOT                      02590000
         ST    R15,RCRGNNET            SAVE OTHERWISE                   02600000
         LTR   R15,R15                 REGION TREE INTACT?              02610000
         BNZ   BLDADV                  SKIP IF NOT                      02620000
                                                                        02630000
*--------------------------------------------------------------         02640000
*   IDENTIFY 'WRAP' REGION, BUILD WRAP REGION SUBTREE                   02650000
*--------------------------------------------------------------         02660000
         LA    R4,EXRNROOT             LOCATE REGION TREE BASE          02670000
         USING RGNTREE,R4              ESTABLISH ADDRESSABILITY         02680000
         ICM   R0,15,RGTWCNT           WRAP REGIONS DEFINED?            02690000
         BZ    BLDADV                  DONE HERE IF NOT                 02700000
                                                                        02710000
         $CLINK FUNC=RGNWLOC,          IDENTIFY WRAP REGION OWNER      X02720000
               (STRUCT*,RGNTREE)                                        02730000
                                                                        02740000
         LTR   R7,R15                  WRAP REGION OWNER DEFINED?       02750000
         BZ    BLDADV                  SKIP IF NOT                      02760000
         USING RGNTRY,R7               WRAP OWNER ADDRESSABILITY        02770000
         ST    R7,RGTWMAIN             IDENTIFY WRAP REGION OWNER       02780000
                                                                        02790000
         STGGET EXRGNETL,QH=PRJEXSTG   ACQUIRE STORAGE FOR SUBTREE BASE 02800000
         BNZ   ERR_STG                 STORAGE MANAGEMENT FAILURE       02810000
         ST    R1,EXRNWRAP             CONSTRUCT WRAP RGN SUBTREE BASE  02820000
                                                                        02830000
T        USING RGNTREE,R1              CONSTRUCT REGION TREE BASE       02840000
         L     R15,RGN#SUBR            NUMBER OF WRAP RGN SUBRGNS       02850000
         LA    R15,1(,R15)             ACCOUNT FOR WRAP RGN AS PARENT   02860000
         ST    R15,T.RGTCOUNT          INITIALIZE WRAP RGNTREE BASE     02870000
         MVC   T.RGTWCNT,RGTWCNT       # WRAP REGIONS                   02880000
         MVC   T.RGTWATTR,RGTWATTR     WRAP REGION ENTRY PTR            02890000
         MVC   T.RGTWMAIN,RGTWMAIN     WRAP REGION OWNER                02900000
                                                                        02910000
R        USING RGNTRY,T.RGTROOT        SWITCH FOCUS TO ROOT RGNTRY      02920000
         MVC   R.RGNTRY(RGNTRYLN),RGNTRY  COPY SERVES AS TILING BASE    02930000
         XC    R.RGNPEER,R.RGNPEER     DELETE PEER CHAIN                02940000
         XC    R.RGNRELR,R.RGNRELR     DISCHARGE RELATED RGN (FUTURE)   02950000
         MVC   R.RGNNEXT,R.RGNSUB      ALL RGNS THIS VIEW ARE SUBRGNS   02960000
         DROP  R,T,R7                  NEW RGNTREE/RGNTRY, WRAP OWNER   02970000
         DROP  R4                      RGNTREE                          02980000
                                                                        02990000
*--------------------------------------------------------------         03000000
*   SCAN ENTIRE PROJECT REGION NETWORK                                  03010000
*--------------------------------------------------------------         03020000
BLDADV   DS    0H                                                       03030000
         ICM   R5,15,EXRNEXT           PROCESS ALL BLOCKS               03040000
         BNZ   BLDTREE                                                  03050000
                                                                        03060000
         EJECT ,                                                        03070000
***************************************************************         03080000
*                                                                       03090000
*   RETURN COMPLETION STATUS TO CALLER                                  03100000
*                                                                       03110000
***************************************************************         03120000
FINISH   DS    0H                                                       03130000
         ICM   R15,15,RCRGNNET         HIGHEST RGNNET RETCODE           03140000
         BZ    EXIT                    NORMAL COMPLETION                03150000
         LR    R1,R15                  RETAIN SERVICE ROUTINE RC        03160000
         LA    R15,RC08                                                 03170000
         B     EXIT                                                     03180000
                                                                        03190000
ERR_TBSV DS    0H                      TABLE SERVICES FAILURE           03200000
         LR    R1,R0                   RETAIN SERVICE ROUTINE RSN       03210000
         SLL   R1,16                   RSN:RC                           03220000
         OR    R1,R15                  RETAIN SERVICE ROUTINE RC        03230000
         LA    R15,RC20                                                 03240000
         B     EXIT                                                     03250000
                                                                        03260000
ERR_STG  DS    0H                      STORAGE FAILURE                  03270000
         LR    R1,R15                  RETAIN SERVICE ROUTINE RC        03280000
         LA    R15,RC24                                                 03290000
         B     EXIT                                                     03300000
                                                                        03310000
*--------------------------------------------------------------         03320000
*   RELEASE ACQUIRED STORAGE AND RETURN                                 03330000
*--------------------------------------------------------------         03340000
EXIT     DS    0H                                                       03350000
         ICM   R4,15,AUXBUFR           AUX BUFFER ALLOCATED?            03360000
         BZ    EXIT_FIN                SKIP IF NOT                      03370000
         L     R3,AUXBUFL              AUX BUFFER LENGTH                03380000
                                                                        03390000
         STM   R14,R1,STATREGS         PRESERVE COMPLETION STATUS       03400000
         STGRETN ADDR=(R4),LEN=(R3),QH=PRJEXSTG                         03410000
         LM    R14,R1,STATREGS         RESTORE  COMPLETION STATUS       03420000
                                                                        03430000
EXIT_FIN DS    0H                                                       03440000
         #EXIT ,                       RETURN                           03450000
                                                                        03460000
         EJECT ,                                                        03470000
***************************************************************         03480000
*                                                                       03490000
* ROUTINE:  STORGN - CREATE RGNTRY / SYSRGN ENTRY PAIR                  03500000
*                                                                       03510000
* DESCRIPTION:                                                          03520000
*                                                                       03530000
*    THIS ROUTINE CREATES A REGION NETWORK ENTRY (RGNTRY) FOR A         03540000
*    GIVEN REGION DEFINITION (SYSRGN) WITHIN A BUFFER PROVIDED          03550000
*    FOR THAT PURPOSE.  THE REGION IS MOVED INTO THE FAR END OF         03560000
*    THE BUFFER PROVIDED.  THE RGNTRY IS CREATED IN THE NEAR            03570000
*    END.  THE BUFFER MANAGEMENT DATA AND THE RGNTRY->SYSRGN            03580000
*    PTR ARE MAINTAINED IN OFFSET FORMAT ALLOW THE BUFFER TO BE         03590000
*    EASILY REALLOCATED IF ITS CAPACITY IS EXCEEDED.                    03600000
*                                                                       03610000
*                                                                       03620000
* ON ENTRY:                                                             03630000
*                                                                       03640000
*    R1  - ADDRESS OF SYSRGN                                            03650000
*    R0  - LENGTH  OF SYSRGN                                            03660000
*    R15 - ADDRESS OF RBUFRNF BUFFER PTR                                03670000
*                                                                       03680000
* ON EXIT:                                                              03690000
*                                                                       03700000
*    R15 CONTAINS ZERO OR A $STORGET FAILURE CODE                       03710000
*                                                                       03720000
***************************************************************         03730000
STORGN   DS    0H                                                       03740000
         STM   R0,R15,REGSAVE     SAVE MAINLINE REGS                    03750000
         LR    R4,R15             R4 <== BUFFER ADDRESS PTR             03760000
         LR    R3,R1              R3 <== SYSRGN ORIGIN                  03770000
         LR    R2,R0              R2 <== SYSRGN LENGTH                  03780000
                                                                        03790000
*--------------------------------------------------------------         03800000
*   TEST CAPACITY OF EXISTING BUFFER                                    03810000
*--------------------------------------------------------------         03820000
         ICM   R6,15,0(R4)        LOCATE BUFFER                         03830000
         BZ    STOREALO           BUFFER NOT YET ALLOCATED              03840000
         USING RBUFNF,R6          BUFFER DESCRIPTOR                     03850000
                                                                        03860000
STORTEST DS    0H                                                       03870000
         LA    R5,RGNTRYLN+4(R2)  ROUNDED LENGTH REQ'D FOR ENTRY PAIR   03880000
         L     R14,RBFREE         SIZE OF FREE SPACE                    03890000
         SR    R14,R5             CAPACITY EXCEEDED?                    03900000
         ST    R14,RBFREE         PERHAPS NOT                           03910000
         BNM   STORPAIR           NORMAL CONTINUATION                   03920000
                                                                        03930000
*--------------------------------------------------------------         03940000
*   (RE) ALLOCATE BUFFER                                                03950000
*--------------------------------------------------------------         03960000
STOREALO DS    0H                                                       03970000
         LA    R1,RBUFNF          R1 <== OVERCOMMITTED BUFFER PTR       03980000
         BAS   R14,BUFREAL        REALLOCATE IT                         03990000
         LTR   R15,R15            SUCCESS?                              04000000
         BNZ   STOREXIT           FAIL IF NOT                           04010000
         LR    R6,R1              SUBSTITUTE NEW BUFFER FOR OLD         04020000
         ST    R6,0(,R4)          PERM ANCHOR                           04030000
         B     STORTEST           RETRY                                 04040000
                                                                        04050000
*--------------------------------------------------------------         04060000
*   CONSTRUCT SYSRGN / RGNTRY PAIR                                      04070000
*--------------------------------------------------------------         04080000
STORPAIR DS    0H                                                       04090000
         L     R7,RBNEARPT        NEXT FREE NEAR SLOT                   04100000
         LA    R0,RGNTRYLN(,R7)   DISPLACEMENT TO NEXT FREE SLOT        04110000
         ST    R0,RBNEARPT        ACCOUNT FOR THIS ENTRY                04120000
         LA    R7,RBUFNF(R7)      CONVERT NEAR OFFSET TO ADDRESS        04130000
         USING RGNTRY,R7          ENTRY FORMAT                          04140000
         XC    RGNTRY(RGNTRYLN),RGNTRY                                  04150000
                                                                        04160000
         LA    R1,4(,R2)          ROUND SYSREGION LENGTH TO BOUNDARY    04170000
         SRL   R1,2                                                     04180000
         SLL   R1,2                                                     04190000
                                                                        04200000
         L     R4,RBFARPT         OFFSET OF LATEST FAR ENTRY            04210000
         SR    R4,R1              ADJUST BY SIZE OF NEW SYSRGN          04220000
         ST    R4,RBFARPT         ACCOUNT FOR THIS ENTRY                04230000
         L     R0,RBFAREND        END OF BUFFER                         04240000
         SR    R0,R4              DISPL FROM END TO NEW SYSRGN          04250000
         ST    R0,RGNSRGN         USE AS TEMPORARY LINK                 04260000
                                                                        04270000
         LA    R4,RBUFNF(R4)      CONVERT FAR OFFSET TO ADDRESS         04280000
         LR    R5,R2              LENGTH OF SYSRGN                      04290000
         LR    R14,R3             SYSRGN ORIGIN                         04300000
         LR    R15,R2             SOURCE LENGTH = TARGET LENGTH         04310000
         MVCL  R4,R14             COPY SYSRGN TO NEW HOME               04320000
                                                                        04330000
STOREXIT DS    0H                                                       04340000
         LM    R0,R14,REGSAVE     RESTORE CALLERS REGS                  04350000
         BR    R14                RETURN                                04360000
         DROP  R7,R6              RGNTRY, BUFRNF                        04370000
         EJECT ,                                                        04380000
***************************************************************         04390000
*                                                                       04400000
* ROUTINE:  BUFREAL - (RE)ACQUIRE RBUFNF                                04410000
*                                                                       04420000
* ON ENTRY:                                                             04430000
*                                                                       04440000
*    R1 - ADDR OF OVER-EXTENDED RBUFNF OR ZERO IF FIRST ALLOC           04450000
*                                                                       04460000
* ON EXIT:                                                              04470000
*                                                                       04480000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES                     04490000
*                                                                       04500000
*        00 - BUFFER ACQUIRED AND RETURNED VIA R1                       04510000
*                                                                       04520000
*        NN - STGGET STORAGE ALLOCATION FAILURE CODE                    04530000
*             SOURCE BUFFER NOT FREED                                   04540000
*                                                                       04550000
***************************************************************         04560000
BUFREAL  DS    0H                                                       04570000
         STM   R0,R15,REGSAVE2    SAVE MAINLINE REGS                    04580000
         LR    R5,R1              REALLOCATION ASSUMED                  04590000
                                                                        04600000
OB       USING RBUFNF,R5          OLD BUFFER FORMAT                     04610000
         LA    R2,EXRGNETL+512    ASSUME INITIAL ALLOCATION             04620000
         LTR   R5,R5              ASSUMPTION CORRECT?                   04630000
         BZ    BUFRGET            ONWARD IF SO                          04640000
         L     R2,OB.RBLEN        ELSE GET OLD LENGTH                   04650000
         AR    R2,R2              REQUEST TWICE AS MUCH                 04660000
                                                                        04670000
BUFRGET  DS    0H                                                       04680000
         STGGET (R2),QH=PRJEXSTG  ACQUIRE STORAGE                       04690000
         BNZ   BUFREXIT           ERROR                                 04700000
                                                                        04710000
         LR    R6,R1              ELSE ACCEPT CLEAR STORAGE             04720000
NB       USING RBUFNF,R6          NEW BUFFER FORMAT                     04730000
         ST    R2,NB.RBLEN        LENGTH OF BUFFER                      04740000
         LA    R0,RBUFNFLN        OFFSET TO NEAR AREA                   04750000
         ST    R0,NB.RBNEAR       NEAR AREA                             04760000
         ST    R0,NB.RBNEARPT     ASSUME INITIAL ALLOC                  04770000
         ST    R2,NB.RBFAREND     OFFSET TO END OF BUFFER               04780000
         ST    R2,NB.RBFARPT      ASSUME INITIAL ALLOC                  04790000
         SR    R2,R0              TOTAL FREE SPACE IN EMPTY BUFFER      04800000
         ST    R2,NB.RBFREE       ... AVAILABLE FOR ALLOCATION          04810000
                                                                        04820000
         LTR   R15,R5             REALLOCATION?                         04830000
         BZ    BUFREXIT           DONE IF NOT                           04840000
                                                                        04850000
*--------------------------------------------------------------         04860000
*   REALLOC REQ - COPY NEAR/FAR DATA AND RECOMPUTE FREE SPACE           04870000
*--------------------------------------------------------------         04880000
         L     R14,OB.RBNEAR      OFFSET TO ORG OF NEAR AREA            04890000
         L     R15,OB.RBNEARPT    OFFSET TO END OF NEAR AREA            04900000
         SR    R15,R14            ANYTHING TO MOVE?                     04910000
         BNP   BUFRCFAR           SKIP IF NOT                           04920000
         LA    R14,OB.RBUFNF(R14) NEAR DATA ORIGIN                      04930000
                                                                        04940000
         L     R3,NB.RBFREE       AVAILABLE FREE SPACE IN NEW BUFFER    04950000
         SR    R3,R15             ACCOUNT FOR COPIED NEAR AREA          04960000
         ST    R3,NB.RBFREE       UPDATE ACCORDINGLY                    04970000
         AL    R15,NB.RBNEAR      BUMP BY NEAR AREA ORIGIN OFFSET       04980000
         ST    R15,NB.RBNEARPT    OFFPTR TO NEXT FREE SEGMENT           04990000
                                                                        05000000
         L     R0,NB.RBNEAR       DESTINATION OFFSET                    05010000
         AR    R0,R6              CONVERT TO ADDRESS                    05020000
         LR    R1,R15             TARGET LENGTH = SOURCE LENGTH         05030000
         MVCL  R0,R14             COPY FAR DATA                         05040000
                                                                        05050000
*------- FAR AREA ---------------------------------------------         05060000
                                                                        05070000
BUFRCFAR DS    0H                                                       05080000
         L     R14,OB.RBFARPT     OFFSET TO ORG OF FAR AREA             05090000
         L     R15,OB.RBFAREND    OFFSET TO END OF FAR AREA             05100000
         SR    R15,R14            ANYTHING TO MOVE?                     05110000
         BNP   BUFRFREE           DONE IF NOT                           05120000
         LA    R14,OB.RBUFNF(R14) FAR DATA ORIGIN                       05130000
                                                                        05140000
         L     R3,NB.RBFREE       AVAILABLE FREE SPACE IN NEW BUFFER    05150000
         SR    R3,R15             ACCOUNT FOR COPIED FAR AREA           05160000
         ST    R3,NB.RBFREE       UPDATE ACCORDINGLY                    05170000
                                                                        05180000
         L     R0,NB.RBFAREND     END OF NEW BUFFER                     05190000
         SR    R0,R15             OFFSET ORIGIN OF FAR AREA             05200000
         ST    R0,NB.RBFARPT      UPDATE FAR DATA ORIGIN                05210000
         AR    R0,R6              CONVERT TO ADDRESS                    05220000
         LR    R1,R15             TARGET LENGTH = SOURCE LENGTH         05230000
         MVCL  R0,R14             COPY FAR DATA                         05240000
                                                                        05250000
*--------------------------------------------------------------         05260000
*   FREE PRIOR BUFFER AND EXIT                                          05270000
*--------------------------------------------------------------         05280000
BUFRFREE DS    0H                                                       05290000
         LTR   R5,R5              OLD BUFFER TO FREE?                   05300000
         BZ    BUFREXIT           SKIP IF NOT                           05310000
         L     R3,OB.RBLEN        LENGTH OF BUFFER                      05320000
                                                                        05330000
         STGRETN ADDR=(R5),LEN=(R3),QH=PRJEXSTG                         05340000
                                                                        05350000
BUFREXIT DS    0H                                                       05360000
         LA    R1,NB.RBUFNF       RETURN NEW BUFFER                     05370000
         LM    R2,R14,REGSAVE2+8  RESTORE REGS                          05380000
         BR    R14                                                      05390000
                                                                        05400000
         DROP  OB,NB                                                    05410000
                                                                        05420000
         EJECT ,                                                        05430000
***************************************************************         05440000
*                                                                       05450000
* ROUTINE:  BUFCVTA - CONVERT RBUFNF OFFSETS TO ADDRESSES               05460000
*                                                                       05470000
* ON ENTRY:                                                             05480000
*                                                                       05490000
*    R1 - ADDR OF RBUFNF                                                05500000
*                                                                       05510000
***************************************************************         05520000
BUFCVTA  DS    0H                                                       05530000
         LR    R15,R1                                                   05540000
         USING RBUFNF,R15                                               05550000
                                                                        05560000
         L     R0,RBNEAR                                                05570000
         ALR   R0,R15                                                   05580000
         ST    R0,RBNEAR                                                05590000
                                                                        05600000
         L     R0,RBNEARPT                                              05610000
         ALR   R0,R15                                                   05620000
         ST    R0,RBNEARPT                                              05630000
                                                                        05640000
         L     R0,RBFAREND                                              05650000
         ALR   R0,R15                                                   05660000
         ST    R0,RBFAREND                                              05670000
                                                                        05680000
         L     R0,RBFARPT                                               05690000
         ALR   R0,R15                                                   05700000
         ST    R0,RBFARPT                                               05710000
                                                                        05720000
         SR    R15,R15                                                  05730000
         BR    R14                                                      05740000
                                                                        05750000
         DROP  R15                                                      05760000
                                                                        05770000
         EJECT ,                                                        05780000
***************************************************************         05790000
*                                                                       05800000
* ROUTINE:  RLINKUP - CONVERT RGNTRY->SYSRGN LINKS TO ADDRESSES         05810000
*                                                                       05820000
* ON ENTRY:                                                             05830000
*                                                                       05840000
*    R1  - NUMBER OF RGNTRY / SYSRGN PAIRS STORED                       05850000
*    R0  - ADDRESS OF RBUFRNF BUFFER                                    05860000
*                                                                       05870000
* ON EXIT:                                                              05880000
*                                                                       05890000
*    R15 - ZERO INDICATING NORMAL COMPLETION                            05900000
*    R1  - ADDR OF FIRST ENTRY IN THE RGNTRY ARRAY                      05910000
*                                                                       05920000
***************************************************************         05930000
RLINKUP  DS    0H                                                       05940000
         STM   R0,R15,REGSAVE     SAVE MAINLINE REGS                    05950000
         LR    R6,R0              LOCATE BUFFER                         05960000
         USING RBUFNF,R6          BUFFER DESCRIPTOR                     05970000
         LTR   R2,R1              NUMBER OF PAIRS STORED                05980000
         BNP   RLINKXIT           STRANGE REQ                           05990000
                                                                        06000000
         L     R7,RBNEAR          RGNTRY'S RESIDE IN NEAR PARTITION     06010000
         USING RGNTRY,R7          RGNTRY FORMAT                         06020000
                                                                        06030000
RLINKNXT DS    0H                                                       06040000
         L     R0,RBFAREND        END OF BUFFER ADDRESS                 06050000
         SL    R0,RGNSRGN         DISPL (BACKWARDS) TO SYSRGN           06060000
         ST    R0,RGNSRGN         CONVERT DISPL TO PTR                  06070000
         LA    R7,RGNTRY+RGNTRYLN ADVANCE TO NEXT RGNTRY                06080000
         BCT   R2,RLINKNXT        PROCESS NEXT PAIR                     06090000
                                                                        06100000
RLINKXIT DS    0H                                                       06110000
         SR    R15,R15            RC UNDEFINED                          06120000
         L     R1,RBNEAR          RETURN PTR TO RGNTRY LIST             06130000
         LM    R2,R14,REGSAVE+8   RESTORE MAINLINE REGS                 06140000
         BR    R14                RETURN                                06150000
         DROP  R7,R6              RGNTRY, RBUFRNF                       06160000
                                                                        06170000
         EJECT ,                                                        06180000
***************************************************************         06190000
*                                                                       06200000
*   LOCAL READ ONLY STORAGE                                             06210000
*                                                                       06220000
***************************************************************         06230000
         LTORG ,                                                        06240000
                                                                        06250000
         PRINT NOGEN                                                    06260000
         ICVT  ,                                                        06270000
         ITASK ,                                                        06280000
         IPCB  ,                                                        06290000
         IUSER ,                                                        06300000
         IPROJ ,                                                        06310000
         END   ,                                                        06320000

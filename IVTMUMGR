IVTMUMGR TITLE 'INTEGRATOR - VTAM SERVICES IVUSER RESOURCE MANAGER'     00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: IVTMUMGR - INTEGRATOR VTAM SERVICES IVUSER RESOURCE MANAGER  00100000
*                                                                       00110000
* DESCRIPTION: 1) PERFORM CLEANUP FOR IVUSER SUBTASK TERMINATION        00120000
*                                                                       00130000
* ON ENTRY:                                                             00140000
*                                                                       00150000
*    R15 = ENTRY POINT ADDRESS                                          00160000
*    R14 = RETURN ADDRESS                                               00170000
*    R13 = AVAILABLE SAVE AREA                                          00180000
*    R11 = ICVT ADDRESS                                                 00190000
*    R10 = ITASK ADDRESS                                                00200000
*    R01 = IVUSER ADDRESS                                               00210000
*                                                                       00220000
* ON EXIT:                                                              00230000
*                                                                       00240000
*    R15 = 0                                                            00250000
*    R00 = 0                                                            00260000
*    R01 = 0                                                            00270000
*                                                                       00280000
*    ALL OTHER REGISTERS ARE RESTORED                                   00290000
*                                                                       00300000
*                                                                       00310000
**<DOC-OFF>************************************************************ 00320000
                                                                        00330000
         EJECT ,                                                        00340000
*********************************************************************** 00350000
*                                                                       00360000
* MAINTENANCE:                                                          00370000
*                                                                       00380000
*   08/01/93 RANDY WITEK                                                00390000
*   07/01/94 RANDY WITEK - LU6.2 SUPPORT                                00400000
*                                                                       00410000
*********************************************************************** 00420000
                                                                        00430000
         EQUS  ,                  GENERAL EQUATES                       00440000
                                                                        00450000
RICVT    EQU   R11                                                      00460000
RITASK   EQU   R10                                                      00470000
RIVTAM   EQU   R9                                                       00480000
RIVUSER  EQU   R8                                                       00490000
RIWE     EQU   R7                                                       00500000
RMDE     EQU   R6                                                       00510000
RAQE     EQU   R5                                                       00520000
                                                                        00530000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00540000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00550000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00560000
         USING IVUSER,RIVUSER     ESTABLISH ADDRESSABILITY              00570000
         USING IWEVTAM,RIWE       ESTABLISH ADDRESSABILITY              00580000
         USING MDE,RMDE           ESTABLISH ADDRESSABILITY              00590000
         USING AQE,RAQE           ESTABLISH ADDRESSABILITY              00600000
                                                                        00610000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00620000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00630000
WRK256   DS    XL256              GENERAL WORKAREA                      00640000
L62MFL   L62POST MF=L             PLIST CONSTRUCTION                    00650000
L62RETCD DS    F                  RETURN CODE AREA                      00660000
RETR15   DS    F                  RETURN CODE VALUE                     00670000
RETR0    DS    F                  RETURN REGISTER 0                     00680000
RETR1    DS    F                  RETURN REGISTER 1                     00690000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00700000
FLAG     DS    X                                                        00710000
FLAGLOCK EQU   X'80'                                                    00720000
FLAGLCKD EQU   X'40'                                                    00730000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00740000
                                                                        00750000
         $MSGDFT PREFIX=ICTPID,                                        +00760000
               COMPID='VTM',                                           +00770000
               TABLE=*#MSGS,                                           +00780000
               WORKA=0,                                                +00790000
               MF=(E,WRK256),                                          +00800000
               PRINT=NOGEN                                              00810000
                                                                        00820000
IVTMUMGR #ENTER BASE=R12,         ENTRY LINKAGE                        +00830000
               PREG=RIVUSER,                                           +00840000
               AMODE=31,                                               +00850000
               RMODE=ANY                                                00860000
                                                                        00870000
*---------------------------------------------------------------------- 00880000
* PROCESS VTAM USER TERMINATION                                         00890000
*---------------------------------------------------------------------- 00900000
                                                                        00910000
         L     RIVTAM,ICTVTCVT    VTAM CVT ADDRESSIBILITY               00920000
                                                                        00930000
*                                                                       00940000
* VERIFY IVUSER BLOCK                                                   00950000
*---------------------------------------------------------------------- 00960000
                                                                        00970000
         CLC   IVUID,=CL8'IVUSER'       VALID BLOCK?                    00980000
         BNE   ERRUTERM                 BRANCH IF NOT                   00990000
                                                                        01000000
*                                                                       01010000
* ISSUE AN INFORMATIVE MESSAGE AND CUT A TRACE RECORD                   01020000
*---------------------------------------------------------------------- 01030000
                                                                        01040000
         $TRACE *=A(TRC_IVUSER_END),32   TRACE ENTRY W/32 USER BYTES    01050000
                                                                        01060000
         BNZ   NOUTRACE                  BRANCH IF NOT TRACING          01070000
                                                                        01080000
         ST    RIVUSER,0(,R1)            TRACE IVUSER ADDRESS           01090000
         MVC   4(4,R1),IVUITASK          TRACE ITASK  ADDRESS           01100000
         MVC   8(8,R1),IVUTK             TRACE IVUSER TOKEN             01110000
         MVC   16(4,R1),IVU#SESS         TRACE CURRENT SESSION COUNT    01120000
         MVC   20(8,R1),IVUITSKN         TRACE TASK NAME (I.E. LUNAME)  01130000
                                                                        01140000
NOUTRACE DS    0H                                                       01150000
                                                                        01160000
         $MSG  986,                                                    +01170000
               FIELDS=((RIVUSER),  "IVUSER HAS ENDED" MESSAGE          +01180000
               (IVUTKUSR,4))       IVUSER TOKEN                         01190000
                                                                        01200000
*                                                                       01210000
* REMOVE IVUSER FROM THE LOOKUP STRUCTURE                               01220000
*---------------------------------------------------------------------- 01230000
                                                                        01240000
         BAS   R14,VTAMLOCK       SERIALIZE                             01250000
                                                                        01260000
         $VTAM DELUSER,           DELETE THE IVUSER FROM LOOKUP TABLE  +01270000
               AREA=(RIVUSER),                                         +01280000
               ERRET=ERR$VTAM,                                         +01290000
               MF=(E,MFE_LIST)                                         +01300000
                                                                        01310000
*                                                                       01320000
* FOR LU6.2...REMOVE THE IVUSER/PLB FROM THE PLB CHAIN                  01330000
*---------------------------------------------------------------------- 01340000
                                                                        01350000
         TM    IVUF1,IVUF1L62     IS THIS IVUSER FOR LU6.2              01360000
         BNO   L62CLEAN           BRANCH IF NOT                         01370000
                                                                        01380000
         ICM   R2,15,IVUPLNXT     IS THIS IVUSER/PLB ON THE CHAIN?      01390000
         BZ    PLBCLEAN           BRANCH IF NOT                         01400000
         LM    R2,R3,IVUPLNXT     DE-CHAIN IVUSER FROM PLB CHAIN        01410000
         ST    R2,IVUPLNXT-IVU(,R3)                                     01420000
         ST    R3,IVUPLPRV-IVU(,R2)                                     01430000
                                                                        01440000
PLBCLEAN DS    0H                                                       01450000
                                                                        01460000
*                                                                       01470000
* FOR LU6.2...POST ANY LINGERING ALLOCATE REQUESTS                      01480000
*---------------------------------------------------------------------- 01490000
                                                                        01500000
MDELOOP  DS    0H                                                       01510000
                                                                        01520000
         ICM   RMDE,15,IVUMD1ST   FIRST MDE IN THE LIST                 01530000
         BM    L62CLEAN           BRANCH IF ALL DONE                    01540000
         LM    R14,R15,MDENEXT    DEQUEUE THE MDE                       01550000
         ST    R15,MDEPREV-MDE(,R14)                                    01560000
         ST    R14,MDENEXT-MDE(,R15)                                    01570000
                                                                        01580000
AQELOOP  DS    0H                                                       01590000
                                                                        01600000
         ICM   RAQE,15,MDEWR1ST   FIRST AQE IN THE LIST                 01610000
         BM    AQECLEAN           BRANCH IF ALL DONE                    01620000
         LM    R14,R15,AQENEXT    DEQUEUE THE MDE                       01630000
         ST    R15,AQEPREV-AQE(,R14)                                    01640000
         ST    R14,AQENEXT-AQE(,R15)                                    01650000
                                                                        01660000
         TM    AQEF1,AQEF1SRA     SESSION REQUEST ACTIVE?               01670000
         BNO   AQENOSPL           BRANCH IF NOT                         01680000
         ICM   R2,15,AQESPL       GOT THE SPLIST ADDRESS?               01690000
         BZ    AQENOSPL           BRANCH IF NOT                         01700000
                                                                        01710000
         $RETSTOR (R2),                                                +01720000
               OWNER=(RITASK)     RELEASE THE SPLIST STORAGE            01730000
                                                                        01740000
AQENOSPL DS    0H                                                       01750000
                                                                        01760000
         OC    AQEEPB,AQEEPB      IS THERE AN EPB TO POST?              01770000
         BZ    AQEFREE            BRANCH IF NOT                         01780000
         OC    AQEENT,AQEENT      IS THERE AN ENTITY TOKEN?             01790000
         BZ    AQEFREE            BRANCH IF NOT                         01800000
                                                                        01810000
         L62POST *AQEEPB,         ADDRESS OF EPB TO BE POSTED          +01820000
               =F'4',             ADDRESS OF POST CODE                 +01830000
               AQEENT,            ADDRESS OF ENTITY TOKEN              +01840000
               L62RETCD,          RETURN CODE AREA                     +01850000
               MF=(E,L62MFL)                                            01860000
                                                                        01870000
AQEFREE  DS    0H                                                       01880000
                                                                        01890000
         $RETSTOR (RAQE),                                              +01900000
               OWNER=(RITASK)     RELEASE THE AQE STORAGE               01910000
                                                                        01920000
         B     AQELOOP            AND PROCESS THE NEXT AQE              01930000
                                                                        01940000
AQECLEAN DS    0H                                                       01950000
                                                                        01960000
         $RETSTOR (RMDE),                                              +01970000
               OWNER=(RITASK)     RELEASE THE MDE STORAGE               01980000
                                                                        01990000
         B     MDELOOP            AND PROCESS THE NEXT MDE              02000000
                                                                        02010000
L62CLEAN DS    0H                                                       02020000
                                                                        02030000
         BAS   R14,VTAMUNLK       RELEASE SERIALIZATION                 02040000
                                                                        02050000
*                                                                       02060000
* RELEASE ANY DANGLING WORK ELEMENTS ON THE IVUWEQ                      02070000
*---------------------------------------------------------------------- 02080000
                                                                        02090000
         L     RIWE,IVULASTW         ADDRESS OF LAST WORK PROCESSED     02100000
                                                                        02110000
VTRMFRWE DS    0H                                                       02120000
                                                                        02130000
         LTR   RIWE,RIWE             IS THERE AN IWE?                   02140000
         BZ    VTRMNOWE              BRANCH IF NOT                      02150000
         LR    R2,RIWE               IWE TO BE FREED                    02160000
         L     RIWE,IWELINK          LINK TO NEXT IWE                   02170000
                                                                        02180000
         $VTAMFWE (R2)               RELEASE THE DANGLING WORK ELEMENT  02190000
                                                                        02200000
         B     VTRMFRWE              RELEASE THE NEXT ONE               02210000
                                                                        02220000
VTRMNOWE DS    0H                                                       02230000
                                                                        02240000
*                                                                       02250000
* RELEASE THE MAIN TASK STORAGE FOR THE IVUSER BLOCK                    02260000
*---------------------------------------------------------------------- 02270000
                                                                        02280000
         $VTAMRET (RIVUSER)       QUEUE IVUSER FOR MAINTASK RELEASE     02290000
                                                                        02300000
*---------------------------------------------------------------------- 02310000
* RETURN TO CALLER                                                      02320000
*---------------------------------------------------------------------- 02330000
                                                                        02340000
RETURN   DS    0H                                                       02350000
                                                                        02360000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 02370000
                                                                        02380000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    02390000
                                                                        02400000
*---------------------------------------------------------------------- 02410000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 02420000
*---------------------------------------------------------------------- 02430000
                                                                        02440000
VTAMLOCK DS    0H                                                       02450000
                                                                        02460000
         TM    FLAG,FLAGLOCK        WAS THE LOCK ALREADY OBTAINED?      02470000
         BOR   R14                  RETURN IF YES                       02480000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             02490000
                                                                        02500000
         $SER  OBTAIN,                                                 +02510000
               VTAM                                                     02520000
                                                                        02530000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              02540000
         BNE   VTAMLOEX             BRANCH IF NOT                       02550000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         02560000
                                                                        02570000
VTAMLOEX DS    0H                                                       02580000
                                                                        02590000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               02600000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          02610000
         BR    R14                  RETURN                              02620000
                                                                        02630000
*---------------------------------------------------------------------- 02640000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                02650000
*---------------------------------------------------------------------- 02660000
                                                                        02670000
VTAMUNLK DS    0H                                                       02680000
                                                                        02690000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       02700000
         BNOR  R14                  BRANCH IF NOT                       02710000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             02720000
         BOR   R14                  DON'T RELEASE IF IT WAS             02730000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             02740000
                                                                        02750000
         $SER  RELEASE,                                                +02760000
               VTAM                                                     02770000
                                                                        02780000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  02790000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          02800000
         BR    R14                  RETURN                              02810000
                                                                        02820000
*---------------------------------------------------------------------- 02830000
* ERROR ROUTINES                                                        02840000
*---------------------------------------------------------------------- 02850000
                                                                        02860000
ERR$VTAM DS    0H                                                       02870000
                                                                        02880000
         $ABEND ABE_VTDIAG,                                            +02890000
               SCOPE=PCB,                                              +02900000
               TITLE='$VTAM FAILURE'                                    02910000
                                                                        02920000
ERRUTERM DS    0H                                                       02930000
                                                                        02940000
         $ABEND ABE_VTDIAG,                                            +02950000
               SCOPE=PCB,                                              +02960000
               TITLE='INVALID IVUSER BLOCK AT USER TERMINATION'         02970000
                                                                        02980000
*---------------------------------------------------------------------- 02990000
* LITERALS AND DSECTS                                                   03000000
*---------------------------------------------------------------------- 03010000
                                                                        03020000
         LTORG ,                                                        03030000
                                                                        03040000
         PRINT NOGEN                                                    03050000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                03060000
         ISTDBIND ,               VTAM BIND IMAGE                       03070000
         ISTRH ,                  VTAM SNA RH                           03080000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         03090000
         ICVT  ,                  INTEGRATOR CVT                        03100000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   03110000
         IRPL ,                   INTEGRATOR VTAM RPL+                  03120000
         IACB ,                   INTEGRATOR VTAM ACB+                  03130000
         INIB ,                   INTEGRATOR VTAM NIB+                  03140000
         ISESS ,                  INTEGRATOR SESSION BLOCK              03150000
         IRQE ,                   INTEGRATOR REQUEST QUEUE ELEMENT      03160000
         IPOOL ,                  INTEGRATOR POOL BLOCK                 03170000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            03180000
         ITASK ,                  INTEGRATOR TASK BLOCK                 03190000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          03200000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       03210000
         EVCODES ,                INTEGRATOR EVENT CODES                03220000
         ABCODES ,                INTEGRATOR $ABEND CODES               03230000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     03240000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        03250000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             03260000
         END   ,                                                        03270000

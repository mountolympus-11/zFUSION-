IRGNWRRS TITLE '- WRAP REGION SELECTION'                                00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: IRGNWRRS - WRAP REGION SELECTION                             00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THIS ROUTINE IS USED TO IDENTIFY THOSE REGION INSTANCES            00080000
*    DRAWN AGAINST A WRAP REGION IMAGE THAT ARE ELIGIBLE FOR            00090000
*    SCRAPE.                                                            00100000
*                                                                       00110000
*    THE WRAP REGION IMAGE IS AN ASSEMBLY OF ONE OR MORE WRAP           00120000
*    REGION SEGMENTS.  IF A REGION DRAWN BEGINNING IN ANY               00130000
*    SEGMENT TERMINATES IN THE LAST LINE OF THE WRAP REGION             00140000
*    IMAGE, IT IS POSSIBLE THAT THE REGION IS NOT STABLE; THAT          00150000
*    IS, THE REGION MIGHT EXTEND WHEN ADDITIONAL SEGMENTS               00160000
*    ARE APPENDED TO THE END OF THE IMAGE.  ALL SEGMENTS                00170000
*    SPANNED BY THE POTENTIALLY UNSTABLE REGION MUST BE                 00180000
*    RETAINED, AND ALL REGIONS THAT BEGIN IN THE RETAINED               00190000
*    SEGMENT GROUP ARE NOT ELIGIBLE FOR SCRAPE IN THIS PASS.            00200000
*                                                                       00210000
*    ALL PEER AND REPEATING REGIONS THAT ARE IMMEDIATE                  00220000
*    DESCENDANTS OF THE WRAP REGION IMAGE RECTANGLE (I.E.               00230000
*    ALL LEVEL1 INSTANCES) ARE TESTED IN THIS MANNER. THEIR             00240000
*    SUBREGIONS ARE NOT TESTED BECAUSE THEY CAN EXTEND NO               00250000
*    FURTHER THAN THE PARENT REGION.                                    00260000
*                                                                       00270000
*    THIS ROUTINE RETURNS THE NUMBER OF SEGMENTS THAT MAY BE            00280000
*    DISCARDED FROM THE WRAP IMAGE AFTER SCRAPING COMPLETES,            00290000
*    COUNTING FROM THE TOP WITH SEGMENT #1.                             00300000
*                                                                       00310000
*    THE 'INELIGIBLE BIT' (RECENTRY.RECFLAG.RECINFEL) IS SET            00320000
*    IN EVERY RGN INSTANCE THAT IS NOT ELIGIBLE FOR SCRAPE.             00330000
*    RGN INSTANCES NOT HAVING THIS BIT SET ARE ELIGIBLE FOR             00340000
*    SCRAPE.                                                            00350000
*                                                                       00360000
*                                                                       00370000
* ON ENTRY:                                                             00380000
*                                                                       00390000
*    R1 - ADDR OF THE WRAP REGION IMAGING VECTOR    (WRIVEC)            00400000
*    R0 - ADDR OF WRAP GROUP REGION INSTANCE ENTRY  (RECENTRY)          00410000
*                                                                       00420000
*                                                                       00430000
* ON EXIT:                                                              00440000
*                                                                       00450000
*    R15 CONTAINS ZERO                                                  00460000
*                                                                       00470000
*    R1 - THE NUMBER OF COMPLETE WRAP IMAGE SEGMENTS THAT MAY           00480000
*         BE REMOVED FROM THE WRAP IMAGE AFTER REGION SCRAPING          00490000
*         IS COMPLETE.                                                  00500000
*                                                                       00510000
*    R0 - THE NUMBER OF WRAP IMAGE LINES SPANNED BY THE SEGMENT         00520000
*         COUNT RETURNED IN R1.                                         00530000
*                                                                       00540000
**<DOC-OFF>****************************************************         00550000
                                                                        00560000
         EJECT ,                                                        00570000
         #WORK ,                                                        00580000
                                                                        00590000
ROOTRECT DS    A                  ADDR OF RGN INSTANCE ROOT NODE PASSED 00600000
NEXTPEER DS    A                  PEER RGN INSTANCE PTR                 00610000
SEGELIG  DS    F                  # DISCARDABLE SEGMENTS                00620000
LASTLINE DS    F                  LINE # OF END OF SEGMENT STACK        00630000
*                                                                       00640000
SKIPLINE DS    F                  ANY REGION BEGINNING ON OR AFTER      00650000
*                                 THIS LINE NUMBER WILL BE MARKED       00660000
*                                 INELIGIBLE                            00670000
*                                                                       00680000
         #ENDWORK ,                                                     00690000
                                                                        00700000
         EJECT                                                          00710000
         GEOMETRY ,               DRAWING CONSTRUCTS                    00720000
                                                                        00730000
         EJECT                                                          00740000
         DRAW ,                   REGION INSTANCE MAPPINGS              00750000
                                                                        00760000
         EJECT                                                          00770000
         WRIVEC ,                 WRAP REGION IMAGING VECTOR            00780000
                                                                        00790000
         EJECT                                                          00800000
         EQUS ,                                                         00810000
                                                                        00820000
         EJECT                                                          00830000
IRGNWRRS #ENTER PREG=(R8,R7)                                            00840000
                                                                        00850000
         USING ITASK,R10          STANDARD ENVIRONMENT                  00860000
                                                                        00870000
***************************************************************         00880000
*                                                                       00890000
*   GENERAL INITIALIZATION, ACCEPT WRIVEC AND RGN INSTANCE TREE         00900000
*                                                                       00910000
***************************************************************         00920000
         USING WRIVEC,R8          LIFE OF FUNCTION ADDRESSABILITY       00930000
                                                                        00940000
         ST    R7,ROOTRECT        RGN INSTANCE TREE ROOT                00950000
         USING RECENTRY,R7        LIFE OF FUNCTION ADDRESSABILITY       00960000
S        USING RSMRY,RECRSMRY     RGN INSTANCE EXTENT SUMMARY           00970000
R        USING RECT,S.RSMABSR     RGN INSTANCE ABSOLUTE COORDS          00980000
E        USING EDGES,S.RSMEDGES   RGN INSTANCE EDGE DEFINITIONS         00990000
                                                                        01000000
         ICM   R6,15,WRIRECUR     # OF MANAGED SEGMENTS                 01010000
         BZ    RETURN             UNUSUAL REQUEST, NO MANAGED DATA      01020000
         ST    R6,SEGELIG         ASSUME ALL SEGMENTS ARE DISCARDABLE   01030000
                                                                        01040000
***************************************************************         01050000
*                                                                       01060000
*   IDENTIFY THE LAST LINE OF THE WRAP IMAGE BY ACQUIRING THE           01070000
*   LAST LINE NUMBER OF THE LAST SEGMENT RESIDING IN THE WRAP           01080000
*   IMAGE.  INITIALLY, SET THE INELIGIBLE SEGMENT ORIGIN LINE           01090000
*   (SKIPLINE) TO A HARMLESS VALUE (LAST+1) BECAUSE WE                  01100000
*   INITIALLY ASSUME THAT ALL REGIONS DRAWN AGAINST THE WRAP            01110000
*   IMAGE ARE SCRAPABLE.                                                01120000
*                                                                       01130000
***************************************************************         01140000
         LR    R1,R6              R1 <== SEGMENT # OF LAST SEGMENT      01150000
         BAS   R14,SEGXTNT        ACQUIRE SEGMENT EXTENT INFO           01160000
         ST    R1,LASTLINE        LAST LINE OF IMAGE                    01170000
         LA    R1,1(,R1)          LAST LINE + 1                         01180000
         ST    R1,SKIPLINE        INITAL VALUE FOR INELIGIBLE SEGMENTS  01190000
                                                                        01200000
***************************************************************         01210000
*                                                                       01220000
*   IDENTIFY RETAINED SEGMENTS AND ELIGIBLE REGION BOUNDARIES           01230000
*                                                                       01240000
***************************************************************         01250000
RESTART  DS    0H                                                       01260000
         L     R7,ROOTRECT        RESTORE RGN INSTANCE TREE BASE        01270000
         ICM   R7,15,RECSUB       PREP SCAN FIRST LEVEL RGN INSTANCES   01280000
         BZ    RETURN             NO RGNS MATERIALIZED WITHIN WRAP GRP  01290000
         MVC   NEXTPEER,RECPEER   RETAIN PTR TO PEER RGN                01300000
                                                                        01310000
SCAN1    DS    0H                 REGION INSTANCE SCAN                  01320000
         TM    RECFLAG,RECFINEL   PREVIOUSLY TAGGED INELIGIBLE?         01330000
         BO    ADV1               SKIP IF SO                            01340000
         CLC   R.RECTULR,SKIPLINE+2   RGN UPPER ROW VS ELIG BORDER      01350000
         BNL   FAILINST               REGION NOT ELIGIBLE THIS PASS     01360000
         CLC   R.RECTLRR,LASTLINE+2   LOWER EDGE VS WRAP IMAGE END      01370000
         BNL   FAILINST               INELIGIBLE IF COINCIDENT          01380000
                                                                        01390000
ADV1     DS    0H                                                       01400000
         ICM   R7,15,RECRPT       TWIN INSTANCES LEFT?                  01410000
         BNZ   SCAN1              PROCESS IF SO                         01420000
         ICM   R7,15,NEXTPEER     PEER REGIONS AVAIL?                   01430000
         BZ    RETURN             DONE IF NOT                           01440000
         MVC   NEXTPEER,RECPEER   RETAIN PEER PTR FOR NEXT PASS         01450000
         B     SCAN1              AGAIN                                 01460000
                                                                        01470000
*--------------------------------------------------------------         01480000
*   INELIGIBLE RGN, MARK IT AND SUBRGNS - DRAW NEW BOUNDARIES           01490000
*--------------------------------------------------------------         01500000
FAILINST DS    0H                                                       01510000
         LH    R1,R.RECTULR       R1 <== UPPER EDGE OF INELIG INSTANCE  01520000
         BAS   R14,CLTOSEG        CONVERT LINE # TO SEGMENT ID          01530000
         LR    R0,R1              R1 <== MODIFIABLE SEGMENT NUMBER      01540000
         BCTR  R0,0               CONVERT SEGMENT NUMBER TO THE NUMBER  01550000
         ST    R0,SEGELIG         OF SEGMENTS THAT MUST BE RETAINED     01560000
                                                                        01570000
         BAS   R14,SEGXTNT        IDENTIFY FIRST LINE OF THIS SEGMENT   01580000
         ST    R0,SKIPLINE        NO REGIONS BEGUN IN THIS SEGMENT OR   01590000
*                                 IN SUBSEQUENT SEGMENTS ARE ELIGIBLE   01600000
*                                 FOR SCRAPE THIS PASS                  01610000
*                                                                       01620000
         LR    R1,R7              INELIGIBLE REGION INSTANCE AS PARM    01630000
         BAS   R14,INELTAG        INCLUDES ALL SUBREGIONS               01640000
         B     RESTART            REDRIVE THE SCAN WITH NEW BOUNDS      01650000
                                                                        01660000
***************************************************************         01670000
*                                                                       01680000
*   RETURN DISCARDABLE SEGMENT COUNT AND THE NUMBER OF LINES            01690000
*   SPANNED BY THESE SEGMENTS                                           01700000
*                                                                       01710000
***************************************************************         01720000
RETURN   DS    0H                                                       01730000
         L     R1,SEGELIG         NUMBER OF DISCARDABLE SEGMENTS        01740000
         L     R0,SKIPLINE        FIRST LINE OF CURRENT SEGMENT         01750000
         BCTR  R0,0               CVT TO DISCARDABLE SEGMENT LINE COUNT 01760000
                                                                        01770000
         SR    R15,R15            RETURN CODES NOT DEFINED              01780000
         #EXIT ,                                                        01790000
                                                                        01800000
         EJECT                                                          01810000
***************************************************************         01820000
*                                                                       01830000
* ROUTINE: SEGXTNT - ACQUIRE SEGMENT BOUNDARIES                         01840000
*                                                                       01850000
* DESCRIPTION:                                                          01860000
*                                                                       01870000
*    THIS ROUTINE ACCEPTS A WRAP IMAGE VECTOR SEGMENT NUMBER            01880000
*    AND RETURNS THE STARTING AND ENDING LINE NUMBERS OF THAT           01890000
*    SEGMENT RELATIVE TO THE WRAP IMAGE.                                01900000
*                                                                       01910000
*                                                                       01920000
* ON ENTRY:                                                             01930000
*                                                                       01940000
*    WRIVEC IS ADDRESSABLE                                              01950000
*                                                                       01960000
*    R1 - SEGMENT NUMBER                                                01970000
*                                                                       01980000
*                                                                       01990000
* ON EXIT:                                                              02000000
*                                                                       02010000
*    R0 - FIRST LINE OF SEGMENT                                         02020000
*    R1 - LAST  LINE OF SEGMENT                                         02030000
*                                                                       02040000
***************************************************************         02050000
SEGXTNT  DS    0H                                                       02060000
         BCTR  R1,0               ZERO RELATIVE SEGMENT NUMBER          02070000
         MH    R1,=AL2(WRELN)     OFFSET TO WRE                         02080000
         LA    R15,WRIWRES(R1)    PTR TO WRE                            02090000
                                                                        02100000
W        USING WRE,R15            ADDRESSABILITY                        02110000
         L     R0,W.WREFIRST      ORIGIN LINE                           02120000
         LR    R1,R0              MODIFIABLE COPY                       02130000
         A     R1,W.WREROWS       LAST LINE +1                          02140000
         BCTR  R1,0               LAST LINE                             02150000
                                                                        02160000
         SR    R15,R15            RETURN CODES NOT DEFINED              02170000
         BR    R14                REJOIN                                02180000
         DROP  W                  WRE                                   02190000
                                                                        02200000
         EJECT                                                          02210000
***************************************************************         02220000
*                                                                       02230000
* ROUTINE: CLTOSEG - CONVERT LINE # TO SEGMENT ID                       02240000
*                                                                       02250000
* DESCRIPTION:                                                          02260000
*                                                                       02270000
*    THIS ROUTINE ACCEPTS A LINE NUMBER (1-N) CONTAINED IN THE          02280000
*    WRAP GROUP AND RETURNS THE SEGMENT NUMBER CONTAINING THAT          02290000
*    LINE.                                                              02300000
*                                                                       02310000
*                                                                       02320000
* ON ENTRY:                                                             02330000
*                                                                       02340000
*    WRIVEC IS ADDRESSABLE                                              02350000
*                                                                       02360000
*    R1 - LINE (ROW) NUMBER                                             02370000
*                                                                       02380000
*                                                                       02390000
* ON EXIT:                                                              02400000
*                                                                       02410000
*    R1 - SEGMENT ID                                                    02420000
*                                                                       02430000
***************************************************************         02440000
CLTOSEG  DS    0H                                                       02450000
         ST    R2,FWORD           WORK REG                              02460000
                                                                        02470000
         L     R2,WRIRECUR        MANAGED SEGMENT COUNT                 02480000
         LA    R15,WRIWRES        ORIGIN OF WRE LIST                    02490000
W        USING WRE,R15            WRE ADDRESSABILITY                    02500000
                                                                        02510000
CLTOSNXT DS    0H                 WRE SCAN                              02520000
         L     R0,W.WREFIRST      FIRST LINE OF CANDIDATE SEG           02530000
         A     R0,W.WREROWS       LAST+1 LINE OF CANDIDATE SEG          02540000
         CR    R1,R0              LINE FALLS WITHIN CANDIDATE?          02550000
         BL    CLTOSRET           DONE IF SO                            02560000
                                                                        02570000
         LA    R15,WRELN(,R15)    ADVANCE TO NEXT SEGMENT               02580000
         BCT   R2,CLTOSNXT        AND TRY AGAIN                         02590000
         EX    R0,*               ASSERT REASONABLE REQUEST             02600000
                                                                        02610000
CLTOSRET DS    0H                                                       02620000
         L     R1,WRIRECUR        NUMBER OF MANAGED SEGMENTS            02630000
         LA    R1,1(,R1)          PREPARE FOR ENTRY COMPUTATION         02640000
         SR    R1,R2              R1 <== RETURN SEGMENT NUMBER (1-N)    02650000
                                                                        02660000
         L     R2,FWORD           RESTORE WORKING REG                   02670000
         SR    R15,R15            RETURN CODES NOT DEFINED              02680000
         BR    R14                REJOIN MAINLINE                       02690000
         DROP  W                  WRE                                   02700000
                                                                        02710000
         EJECT                                                          02720000
***************************************************************         02730000
*                                                                       02740000
* ROUTINE: INELTAG - TAG INELIGIBLE PEER / DEPENDENT RGN INSTS          02750000
*                                                                       02760000
* DESCRIPTION:                                                          02770000
*                                                                       02780000
*    THE 'INELIGIBLE' BIT IS SET IN THE GIVEN REGION INSTANCE           02790000
*    AND ALL OF ITS SUBREGIONS.                                         02800000
*                                                                       02810000
* ON ENTRY:                                                             02820000
*                                                                       02830000
*    R1 - ADDR OF RGN INSTANCE (RECENTRY)                               02840000
*                                                                       02850000
* NOTES:                                                                02860000
*                                                                       02870000
*    RECURSIVE ROUTINE, BAKR LINKAGE                                    02880000
*                                                                       02890000
***************************************************************         02900000
INELTAG  DS    0H                                                       02910000
         BAKR  R14,0              STACK REQUESTORS REGS                 02920000
                                                                        02930000
         LR    R7,R1              STANDARD RECENTRY ADDRESSABILITY      02940000
IR       USING RECENTRY,R7        DISTINCT ADDRESSABILITY               02950000
         OI    IR.RECFLAG,RECFINEL   MARK RGN INSTANCE INELIGIBLE       02960000
                                                                        02970000
         ICM   R7,15,IR.RECSUB    DEPENDENT REGION INSTANCE LIST?       02980000
         BZ    INELRET            DONE IF NOT                           02990000
                                                                        03000000
*--------------------------------------------------------------         03010000
*   TAG ALL SUBREGIONS OF GIVEN INSTANCE                                03020000
*--------------------------------------------------------------         03030000
INELPEER DS    0H                                                       03040000
         L     R6,IR.RECPEER      NEXT PEER INSTANCE THIS LEVEL         03050000
                                                                        03060000
INELRPT  DS    0H                                                       03070000
         LR    R1,R7              CURRENT INSTANCE AS ROOT              03080000
         BAS   R14,INELTAG        TAG IT AND ALL SUBTREES               03090000
                                                                        03100000
         ICM   R7,15,IR.RECRPT    MULTIPLE INSTANCES OF THIS TYPE?      03110000
         BNZ   INELRPT            AGAIN IF SO                           03120000
         LTR   R7,R6              PEER INSTANCES PRESENT?               03130000
         BNZ   INELPEER           PROCESS IF SO                         03140000
                                                                        03150000
INELRET  DS    0H                                                       03160000
         PR    ,                  RETURN                                03170000
         DROP  IR                 RECENTRY                              03180000
                                                                        03190000
         EJECT                                                          03200000
***************************************************************         03210000
*                                                                       03220000
*   LOCAL READ/ONLY DATA AREAS                                          03230000
*                                                                       03240000
***************************************************************         03250000
         LTORG ,                                                        03260000
                                                                        03270000
         PRINT NOGEN                                                    03280000
         ICVT  ,                                                        03290000
         ITASK ,                                                        03300000
         END   ,                                                        03310000

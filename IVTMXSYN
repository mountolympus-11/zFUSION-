IVTMXSYN TITLE 'INTEGRATOR - VTAM SYNAD EXIT'                           00010000
**<DOC-ON>************************************************************* 00020000
*                                                                       00030000
* ROUTINE: IVTMXSYN - INTEGRATOR VTAM SYNAD EXIT                        00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THE SYNAD EXIT IS INVOKED SYNCHRONOUSLY WHEN A PHYSICAL            00080000
*    ERROR IS DETECTED BY VTAM. A WORK ELEMENT IS QUEUED TO THE         00090000
*    VTAM MAIN TASK SO THAT A DIAGNOSTIC MESSAGE CAN BE ISSUED.         00100000
*                                                                       00110000
* ON ENTRY:                                                             00120000
*                                                                       00130000
*    BAKR IS USED TO SAVE REGISTERS.                                    00140000
*                                                                       00150000
*    R15 = ENTRY POINT ADDRESS                                          00160000
*    R14 = RETURN ADDRESS                                               00170000
*    R13 = SAVE AREA AT TIME OF ERROR                                   00180000
*    R01 = ADDRESS OF RPL ASSOCIATED WITH THE ERROR                     00190000
*    R00 = RECOVERY ACTION RETURN CODE                                  00200000
*          X'04' - EXCEPTIONAL CONDITION                                00210000
*          X'08' - RETRIABLE CONDITION                                  00220000
*          X'0C' - DATA INTEGRITY DAMAGE                                00230000
*          X'10' - ENVIRONMENT ERROR                                    00240000
*          OTHER - RPL OVERWRITTEN                                      00250000
*                                                                       00260000
* ON EXIT:                                                              00270000
*                                                                       00280000
*    R15 = 4                                                            00290000
*    R00 = RPLRTNCD                                                     00300000
*    R01 = 0                                                            00310000
*                                                                       00320000
*    ALL OTHER REGISTERS ARE RESTORED BY PR.                            00330000
*                                                                       00340000
**<DOC-OFF>************************************************************ 00350000
                                                                        00360000
         EJECT ,                                                        00370000
*********************************************************************** 00380000
*                                                                       00390000
* MAINTENANCE:                                                          00400000
*                                                                       00410000
*   08/01/93 RANDY WITEK                                                00420000
*                                                                       00430000
*********************************************************************** 00440000
         EQUS  ,                  GENERAL EQUATES                       00450000
                                                                        00460000
RICVT    EQU   R11                INTEGRATOR CVT POINTER                00470000
RITASK   EQU   R10                ASSOCIATED ITASK POINTER              00480000
RIVTAM   EQU   R9                 INTEGRATOR VTAM CVT POINTER           00490000
RIACB    EQU   R8                 ASSOCIATED IACB POINTER               00500000
RIRPL    EQU   R7                 ASSOCIATED RPL/IRPL POINTER           00510000
RISESS   EQU   R6                 ASSOCIATED ISESS POINTER              00520000
RIWE     EQU   R5                 WORK ELEMENT POINTER                  00530000
                                                                        00540000
         USING ICVT,RICVT         ESTABLISH ADDRESSIBILTY               00550000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSIBILTY               00560000
         USING ITASK,RITASK       ESTABLISH ADDRESSIBILTY               00570000
         USING IACB,RIACB         ESTABLISH ADDRESSIBILTY               00580000
         USING IRPL,RIRPL         ESTABLISH ADDRESSIBILTY               00590000
         USING IWEVTAM,RIWE       ESTABLISH ADDRESSIBILTY               00600000
         USING ISESS,RISESS       ESTABLISH ADDRESSIBILTY               00610000
                                                                        00620000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00630000
         DS    0D                                                       00640000
RCVPARMS DS    XL(L'IVR)          IVTAMRPA STORAGE                      00650000
ESTAEMFL DS    XL(L'ESTAEXPL)     PARMLIST CONSTRUCTION                 00660000
FRRPARM  DS    A                  RETURN AREA FOR FRR PARM ADDRESS      00670000
RETR15   DS    F                  RETURN CODE VALUE                     00680000
RETR0    DS    F                  RETURN REGISTER 0                     00690000
RETR1    DS    F                  RETURN REGISTER 1                     00700000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00710000
FLAG     DS    X                                                        00720000
FLNORPL  EQU   X'80'                                                    00730000
FLESTAEX EQU   X'08'              ESTAEX ACTIVE                         00740000
FLFRR    EQU   X'04'              FRR    ACTIVE                         00750000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00760000
                                                                        00770000
IVTMXSYN #VTENTER BASE=R12,       VTAM EXIT ROUTINE LINKAGE            +00780000
               AMODE=31,                                               +00790000
               RMODE=ANY,                                              +00800000
               PREG=(R3,R4),                                           +00810000
               EXITYPE=RPL                                              00820000
                                                                        00830000
         USING IVTAMRPA,RCVPARMS  ESTABLISH ADDRESSIBILITY              00840000
                                                                        00850000
*---------------------------------------------------------------------- 00860000
* ESTABLISH RECOVERY ENVIRONMENT                                        00870000
*---------------------------------------------------------------------- 00880000
                                                                        00890000
         LA    R15,IVTXRTRY       RETRY ROUTINE ADDRESS                 00900000
         ST    R15,IVRRETAD       SET RETRY ROUTINE ADDRESS             00910000
         LA    R15,IVTAMRPA       PARAMETERS ADDRESS                    00920000
         ST    R15,IVRRPA@        SET ADDRESS FOR FRR                   00930000
         L     R0,=F'-1'          SHOW REGS RESTORED FROM PARM AREA     00940000
         STM   R0,R15,IVRR00      SAVE RETRY REGISTERS                  00950000
         MVC   IVRMOD,=CL8'IVTMTASK'                                    00960000
         MVC   IVRCSECT,=CL8'IVTMXSYN'                                  00970000
         MVC   IVRFRR,=CL8'IVTMXRCV'                                    00980000
         MVC   IVRTYPE,=CL8'ESTAEX'                                     00990000
         L     R3,=V(IVTMXRCV)    ADDR OF VTAM EXIT RECOVERY ROUTINE    01000000
         ICM   R0,15,PSATOLD      SRB MODE?                             01010000
         BZ    ESTFRR             BRANCH IF YES                         01020000
                                                                        01030000
         MVC   ESTAEMFL(L'ESTAEXPL),ESTAEXL                             01040000
                                                                        01050000
         ESTAEX (R3),                                                  +01060000
               CT,                                                     +01070000
               PARAM=RCVPARMS,                                         +01080000
               TERM=YES,                                               +01090000
               MF=(E,ESTAEMFL)    ESTABLISH RECOVERY                    01100000
                                                                        01110000
         OI    FLAG,FLESTAEX      RECOVERY ENVIRONMENT ESTABLISHED      01120000
         B     RECOVSET           AND CONTINUE                          01130000
                                                                        01140000
ESTFRR   DS    0H                                                       01150000
                                                                        01160000
         MVC   IVRTYPE,=CL8'FRR'                                        01170000
                                                                        01180000
         MODESET EXTKEY=ZERO,                                          +01190000
               SAVEKEY=(2)        SET KEY ZERO                          01200000
                                                                        01210000
         SETFRR A,                                                     +01220000
               FRRAD=(R3),                                             +01230000
               WRKREGS=(14,15),                                        +01240000
               PARMAD=FRRPARM     ESTABLISH RECOVERY                    01250000
                                                                        01260000
         L     R1,FRRPARM         PARM AREA FOR FRR                     01270000
         MVC   0(12,R1),RCVPARMS  SET TYPE & PARM AREA POINTER          01280000
                                                                        01290000
         MODESET KEYADDR=(2)      RESTORE PREVIOUS KEY                  01300000
                                                                        01310000
         OI    FLAG,FLFRR         RECOVERY ENVIRONMENT ESTABLISHED      01320000
         B     RECOVSET           AND CONTINUE                          01330000
                                                                        01340000
RECOVSET DS    0H                                                       01350000
                                                                        01360000
                                                                        01370000
*---------------------------------------------------------------------- 01380000
* IF THE RPL IS INVALID...INVOKE RECORDING AND RECOVERY                 01390000
*---------------------------------------------------------------------- 01400000
                                                                        01410000
         ST    R4,RETR0           RESTORE R0 SETTING FOR MAINLINE       01420000
         MVI   RETR15+(L'RETR15-1),4                                    01430000
         C     R4,=F'16'          DO WE HAVE AN RPL?                    01440000
         BH    BADRPL             BRANCH IF NOT                         01450000
                                                                        01460000
*---------------------------------------------------------------------- 01470000
* ESTABLISH ENVIRONMENT FROM RPL                                        01480000
*---------------------------------------------------------------------- 01490000
                                                                        01500000
         L     RIACB,RPLDACB      ASSOCIATED ACB ADDRESS                01510000
         L     RICVT,IACICVT      ICVT ADDRESSIBILITY                   01520000
         L     RIVTAM,ICTVTCVT    IVTAMCVT ADDRESSIBILITY               01530000
         L     RITASK,IVTITASK    MAIN VTAM ITASK ADDRESSIBILITY        01540000
                                                                        01550000
*---------------------------------------------------------------------- 01560000
* ALLOCATE A SYNAD WORK ELEMENT                                         01570000
*---------------------------------------------------------------------- 01580000
                                                                        01590000
         $VTAMWE L'IWEX8,         SIZE                                 +01600000
               IWECXSYN           CODE                                  01610000
                                                                        01620000
         LR    RIWE,R1                                                  01630000
                                                                        01640000
*---------------------------------------------------------------------- 01650000
* BUILD THE SYNAD WORK ELEMENT                                          01660000
*---------------------------------------------------------------------- 01670000
                                                                        01680000
         ST    RIRPL,IWEX8RP@     SAVE ORIGINAL RPL ADDRESS             01690000
         ST    R4,IWEX8RC         SET RECOVERY ACTION RETURN CODE       01700000
         LA    R14,IWEX8RPL       COPY-TO ADDRESS                       01710000
         LR    R0,RIRPL           COPY-FROM ADDRESS                     01720000
         LA    R1,L'IRP           COPY LENGTH                           01730000
         LR    R15,R1             COPY LENGTH                           01740000
         MVCL  R14,R0             COPY THE IRPL TO THE WORK ELEMENT     01750000
                                                                        01760000
*---------------------------------------------------------------------- 01770000
* TRACE THE MODULE ENTRY                                                01780000
*---------------------------------------------------------------------- 01790000
                                                                        01800000
         $TRACE *=A(TRC_IVTMXSYN),32,STDENV=NO     32 USER BYTES        01810000
                                                                        01820000
         BNZ   NOMTRACE           BRANCH IF TRACING NOT AVAILABLE       01830000
                                                                        01840000
         MVC   0(4,R1),IRPITASK   TRACE ITASK                           01850000
         MVC   4(4,R1),IRPISESS   TRACE ISESS                           01860000
         MVC   8(4,R1),RPLDACB    TRACE IACB                            01870000
         MVC   12(4,R1),RPLARG    TRACE CID                             01880000
         MVC   16(1,R1),RPLREQ    TRACE RPL REQUEST CODE                01890000
         MVC   17(3,R1),RPLFDBK   TRACE RPL FEEDBACK WORD               01900000
         MVC   20(4,R1),RPLUSFLD  TRACE USERFLD                         01910000
         ST    R4,24(,R1)         TRACE RECOVERY ACTION RETURN CODE     01920000
         ST    RIRPL,28(,R1)      TRACE RPL ADDRESS                     01930000
                                                                        01940000
NOMTRACE DS    0H                                                       01950000
                                                                        01960000
*---------------------------------------------------------------------- 01970000
* QUEUE SYNAD WORK ELEMENT TO VTAM MAIN ITASK                           01980000
*---------------------------------------------------------------------- 01990000
                                                                        02000000
         $VTAMQ (RIWE),           WORK ELEMENT                         +02010000
               IVTWEQ,            QUEUE                                +02020000
               STDENV=NO          EXIT ROUTINE                          02030000
                                                                        02040000
         B     RETURN                                                   02050000
                                                                        02060000
*---------------------------------------------------------------------- 02070000
* RETRY ROUTINE SCHEDULED BY RECOVERY                                   02080000
*---------------------------------------------------------------------- 02090000
                                                                        02100000
IVTXRTRY DS    0H                                                       02110000
                                                                        02120000
         LTR   R0,R0              WERE REGISTERS RESTORED FOR RETRY?    02130000
         BM    REGSOK             BRANCH IF YES, READY TO EXIT          02140000
X        USING IVTAMRPA,R1        PARM AREA ADDRESS MUST BE IN R1       02150000
         LM    R0,R15,X.IVRR00    RESTORE ALL THE REGISTERS             02160000
         DROP  X                                                        02170000
                                                                        02180000
REGSOK   DS    0H                                                       02190000
                                                                        02200000
         ICM   R0,15,PSATOLD      SRB MODE?                             02210000
         BNZ   RETURN             BRANCH IF NOT                         02220000
         ICM   R1,B'0001',=X'80'  KEY 8 IN BITS 24-27                   02230000
         MODESET KEYREG=(R1)      SET KEY 8                             02240000
         B     RETURN             AND WE ARE READY TO EXIT              02250000
                                                                        02260000
*---------------------------------------------------------------------- 02270000
* RETURN TO VTAM FROM EXIT ROUTINE                                      02280000
*---------------------------------------------------------------------- 02290000
                                                                        02300000
RETURN   DS    0H                                                       02310000
                                                                        02320000
         TM    FLAG,FLESTAEX      IS ESTAEX ESTABLISHED?                02330000
         BNO   RETFRR             BRANCH IF NOT                         02340000
                                                                        02350000
         ESTAEX 0                 DELETE RECOVERY ENVIRONMENT           02360000
                                                                        02370000
         NI    FLAG,255-FLESTAEX  CLEAR FLAG                            02380000
         B     EXITNOW            AND EXIT                              02390000
                                                                        02400000
RETFRR   DS    0H                                                       02410000
                                                                        02420000
         TM    FLAG,FLFRR         IS FRR ESTABLISHED?                   02430000
         BNO   EXITNOW            BRANCH IF NOT                         02440000
                                                                        02450000
         MODESET EXTKEY=ZERO,                                          +02460000
               SAVEKEY=(2)        SET KEY ZERO                          02470000
                                                                        02480000
         SETFRR D,                                                     +02490000
               WRKREGS=(14,15)    DELETE RECOVERY ENVIRONMENT           02500000
                                                                        02510000
         MODESET KEYADDR=(2)      RESTORE PREVIOUS KEY                  02520000
                                                                        02530000
         NI    FLAG,255-FLFRR     CLEAR FLAG                            02540000
         B     EXITNOW            AND EXIT                              02550000
                                                                        02560000
EXITNOW  DS    0H                                                       02570000
                                                                        02580000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 02590000
                                                                        02600000
         #VTEXIT ,                RETURN                                02610000
                                                                        02620000
*---------------------------------------------------------------------- 02630000
* BAD RPL DETECTED                                                      02640000
*---------------------------------------------------------------------- 02650000
                                                                        02660000
BADRPL   DS    0H                                                       02670000
                                                                        02680000
         EX    0,*                INVOKE RECORDING/RECOVERY             02690000
                                                                        02700000
*---------------------------------------------------------------------- 02710000
*  CONSTANTS AND LITERALS                                               02720000
*---------------------------------------------------------------------- 02730000
                                                                        02740000
ESTAEXL  ESTAEX *-*,CT,MF=L       ESTAEX PLIST                          02750000
ESTAEXPL EQU   ESTAEXL,*-ESTAEXL                                        02760000
                                                                        02770000
         LTORG ,                                                        02780000
         PRINT NOGEN                                                    02790000
         IVTAMRPA ,               INTEGRATOR VTAM RECOVERY PARAMETERS   02800000
         IHAFRRS ,                MVS FRR STACK                         02810000
         IHAPSA ,                 MVS PREFIXED STORAGE AREA             02820000
         ISTDBIND ,               VTAM BIND IMAGE                       02830000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         02840000
         ICVT  ,                  INTEGRATOR CVT                        02850000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   02860000
         ITASK ,                  INTEGRATOR TASK BLOCK                 02870000
         IACB ,                   INTEGRATOR VTAM ACB+                  02880000
         IRPL ,                   INTEGRATOR VTAM RPL+                  02890000
         INIB ,                   INTEGRATOR VTAM NIB+                  02900000
         ISESS ,                  INTEGRATOR SESSION BLOCK              02910000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            02920000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          02930000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       02940000
         EVCODES ,                INTEGRATOR EVENT CODES                02950000
         ABCODES ,                INTEGRATOR $ABEND CODES               02960000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     02970000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             02980000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             02990000
         IFGEXLST ,               VTAM EXIT LIST                        03000000
         END   ,                                                        03010000

IODBCOLS TITLE '- ODBC SQLCOLUMNS() RESULT SET GENERATOR'               00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: IODBCOLS - ODBC SQLColumns() result set generator            00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    That QCS is expected and required to contain the semantic          00080000
*    information acquired from a SQL                                    00090000
*                                                                       00100000
*       SELECT <col-list> FROM SYSVCAT_ODBC_COLS WHERE ...              00110000
*                                                                       00120000
*    statement.  The result set generated by this query can be          00130000
*    fashioned to conform to the ODBC SQLColumns() function             00140000
*    format by appropriate composition of the <col-list> and            00150000
*    the use of an ORDER BY clause.                                     00160000
*                                                                       00170000
*                                                                       00180000
* IMPLEMENTATION NOTES:                                                 00190000
*                                                                       00200000
*    TABLE_QUALIFIER  - Table qualifiers are not implemented.           00210000
*                       This column is nulled.                          00220000
*                                                                       00230000
*    TABLE_OWNER      - Table owners are not implemented.               00240000
*                       This column is nulled.                          00250000
*                                                                       00260000
*    REMARKS          - A remark is generated from the                  00270000
*                       TBCOLDEF description entry.  At this            00280000
*                       time neither catalog table columns nor          00290000
*                       VDB columns include descriptions.               00300000
*                                                                       00310000
* ON ENTRY                                                              00320000
*                                                                       00330000
*    R1  contains the address of the Query Content Summary              00340000
*                                                                       00350000
*    R0  contains the address of a preallocated savearea                00360000
*        not less than 1K in length or zero                             00370000
*                                                                       00380000
*                                                                       00390000
* ON EXIT:                                                              00400000
*                                                                       00410000
*    R15 contains zero or a return code acquired from SQLCODES          00420000
*        if an error is encountered.  R0 and R1 contain reason          00430000
*        and info codes respectively.  The QCSESTAT words are           00440000
*        updated accordingly.                                           00450000
*                                                                       00460000
**<DOC-OFF>****************************************************         00470000
                                                                        00480000
         EJECT                                                          00490000
***************************************************************         00500000
*                                                                       00510000
*  MAINTENANCE:                                                         00520000
*                                                                       00530000
*    01/25/95  R. Turgeon    Rel 2.0  ODCB Support                      00540000
*              Initial version                                          00550000
*                                                                       00560000
*    10/31/95  R. Turgeon    Rel 2.1                                    00570000
*              Create transient result set with NOLOCATOR               00580000
*              option                                                   00590000
*                                                                       00600000
***************************************************************         00610000
                                                                        00620000
         EJECT                                                          00630000
         QCS   ,                  QUERY CONTENT SUMMARY                 00640000
                                                                        00650000
         EJECT                                                          00660000
         SQLSEMAL ,               SQL SEMANTIC SUMMARY                  00670000
                                                                        00680000
         EJECT                                                          00690000
         KYNDXRET ,               RESULT SET NDX DEFINITION RETURN AREA 00700000
                                                                        00710000
         EJECT                                                          00720000
         SPACETYP DSECT=YES       OBJECT SPACE DEFINITION BLOCK         00730000
                                                                        00740000
         EJECT                                                          00750000
         SCTDEF DSECT=YES         SPACE COMPONENT TABLE / ENTRIES       00760000
                                                                        00770000
         EJECT                                                          00780000
         TBSERVIS CREATE,OPEN,CLOSE,GET,ADD,PSARG,COLUMN                00790000
                                                                        00800000
         EJECT                                                          00810000
         ICATALOG TABLE,COLUMNS,VARIABLES                               00820000
                                                                        00830000
         EJECT                                                          00840000
         VCATALOG ODBC_COLS       VIRTUAL CATALOG TABLE COMPOSITION     00850000
                                                                        00860000
         EJECT                                                          00870000
         CATINFO ,                COLUMN AND INDEX DEFINTION HEADER     00880000
                                                                        00890000
         EJECT                                                          00900000
         DDENTRY ,                SYSDICTIONARY ROW FORMAT              00910000
                                                                        00920000
         EJECT                                                          00930000
         ODBCSQLH ,               ODBC CONSTANTS, DEFINITIONS, ETC.     00940000
                                                                        00950000
         EJECT                                                          00960000
         CRSDP ,                  CREATE RESULT SET REQUEST/RESPONSE    00970000
                                                                        00980000
         EJECT                                                          00990000
         DTQUERY ,                DATA TYPE INFO REQUEST/RESPONSE BLOCK 01000000
                                                                        01010000
         EJECT                                                          01020000
         VDBLOADP ,               VDB LOADER PARAMETER LIST             01030000
                                                                        01040000
         EJECT                                                          01050000
         EQUS  ,                                                        01060000
                                                                        01070000
         ABCODES ,                                                      01080000
                                                                        01090000
         EJECT                                                          01100000
         #WORK ,                                                        01110000
                                                                        01120000
@OSC     DS    A             OBJECT SPACE CONTENTS BLOCK ADDRESS        01130000
@NDXDEF  DS    A             RESULT SET INDEX DEFINITION (KYNDXRET)     01140000
SYSTABTK DS    F             SYSTABLES CATALOG - TABLE TOKEN            01150000
                                                                        01160000
RET_CRSD DS    F             RESULT SET DEFINITION SERVICE RTN RETCODE  01170000
$SCNCKPT DS    XL8           ICAT$SCN CHECKPOINT AREA                   01180000
                                                                        01190000
RETCODES DS    0F,0F,0F      COMPLETION STATUS                          01200000
RETCODE  DS    F                RETURN CODE                             01210000
RSNCODE  DS    F                REASON CODE                             01220000
INFCODE  DS    F                INFO CODE                               01230000
                                                                        01240000
REGSAVE  DS    16F           LOCAL SUBROUTINE SAVEAREA #1               01250000
REGSAVEX DS    16F           LOCAL SUBROUTINE SAVEAREA #2               01260000
WK256    DS    XL256         GENERAL PURPOSE WORKAREA                   01270000
                                                                        01280000
*--------------------------------------------------------------         01290000
*   TABLE COLUMN STATUS MAINTAINED FOR NULLABLE COLUMNS                 01300000
*--------------------------------------------------------------         01310000
                                                                        01320000
STATQUAL DS    F             TABLE_QUALIFIER                            01330000
STAOWNER DS    F             TABLE_OWNER                                01340000
STASCALE DS    F             SCALE                                      01350000
STARADIX DS    F             RADIX                                      01360000
STAREMRK DS    F             REMARKS                                    01370000
                                                                        01380000
NULL_IND DS    XL4           NULL INDICATORS FOR 32 COLUMNS             01390000
NULL_SAV DS    XL4           NULL INDICATORS - CONSTANTS                01400000
                                                                        01410000
*--------------------------------------------------------------         01420000
*   PLIST CONSTRUCTION AREAS                                            01430000
*--------------------------------------------------------------         01440000
                                                                        01450000
$VDBLOAD DS    0F,XL(PVDBPLN)    VDB LOAD REQUEST PLIST                 01460000
$DTQUERY DS    0F,XL(DTQLN)      DATA TYPE INFO REQUEST/RESPONSE        01470000
$CRSDP   DS    0F,XL(CRSDPLN)    CREATE RESULT SET DEFINITION REQ/RESP  01480000
$CRSTREF DS    0F,XL(CRSTREFL)   CREATE RESULT SET - TABLE REFERENCE    01490000
                                                                        01500000
*--------------------------------------------------------------         01510000
*   VARDATA COLUMN COLLECTION AND CONSTRUCTION AREA                     01520000
*--------------------------------------------------------------         01530000
                                                                        01540000
VCHAR@   DS    A             FREE AREA PTR IN VARDATA COLLECTION AREA   01550000
VCHAR#   DS    F             FREE STG LEFT IN VARDATA COLLECTION AREA   01560000
VCHAR@T  DS    A             VCHAR@ AFTER TABLE VARDATA POSTED          01570000
VCHAR#T  DS    F             VCHAR# AFTER TABLE VARDATA POSTED          01580000
VCHARBUF DS    XL1024        VARDATA COLLECTION AREA                    01590000
                                                                        01600000
*--------------------------------------------------------------         01610000
*   TABLE SERVICES ROW BUFFERS                                          01620000
*--------------------------------------------------------------         01630000
                                                                        01640000
$ODBCROW DS    XL(ODBCOLS_LENGTH)   SYSVCAT_ODBC_COLS SOURCE ROW BUFFER 01650000
                                                                        01660000
$SYSTAB  DS    XL(STBLN)     SYSTABLES ROW BUFFER                       01670000
                                                                        01680000
$DDEROW  DS    XL(DDELN)     SYSDICTIONARY ROW BUFFER                   01690000
$DDEVX   DS    XL256         VARDATAX EXTENSION AREA                    01700000
                                                                        01710000
         #ENDWORK                                                       01720000
                                                                        01730000
         EJECT                                                          01740000
IODBCOLS #ENTER PREG=R8                                                 01750000
                                                                        01760000
         USING ITASK,R10                                                01770000
                                                                        01780000
         EJECT                                                          01790000
***************************************************************         01800000
*                                                                       01810000
*   First, prepare to materialize the ODBC-defined result set           01820000
*   by initializing a SYSVCAT_ODBC_COLS table in the execution          01830000
*   space.  We leave it to coop to determine the proper                 01840000
*   ordering and row admittance criterea via the use of                 01850000
*   ALL/DISTINCT and ORDER BY in the source SELECT statement.           01860000
*                                                                       01870000
***************************************************************         01880000
                                                                        01890000
         USING QCS,R8             LIFE OF FUNCTION                      01900000
                                                                        01910000
         GENTBLNM QCSTABLE        GENERATE A NAME FOR THE RESULT SET    01920000
                                                                        01930000
C        USING ODBCOLS,$ODBCROW   SYSVCAT_ODBC_COLS ROW                 01940000
                                                                        01950000
*--------------------------------------------------------------         01960000
*   GENERATE A RESULT SET DEFINITION FROM THE BASE TABLE                01970000
*--------------------------------------------------------------         01980000
                                                                        01990000
         L     R7,=V(IVCACOLS)    SYSVCAT_ODBC_COLS TABLE FORMAT        02000000
         USING CATINFO,R7         DEFINITION FORMAT                     02010000
                                                                        02020000
TREF     USING CRSTREF,$CRSTREF   SINGLE VIRTUAL TABLE REFERENCE        02030000
         L     R6,QCSSSMRY        LOCATE THE SEMANTIC SUMMARY           02040000
         USING SQSEMAL,R6                                               02050000
         MVC   TREF.CRSTAB,SQSATBLS    RETAIN PTR TO TABLE IDENTIFIER   02060000
         MVC   TREF.CRSTCOL@,CATCOLS   TBCOLDEF PTR ARRAY ORIGIN        02070000
         MVC   TREF.CRSTCOL#,CAT#COLS  NUMBER OF COLUMNS IN BASE TABLE  02080000
         DROP  R7                 CATINFO                               02090000
                                                                        02100000
CRSD     USING CRSDP,$CRSDP       CREATE RESULT SET DEFINITION REQ/RESP 02110000
         ST    R6,CRSD.CRSDSMRY   PROVIDE SEMANTIC SUMMARY AS PARM      02120000
         LA    R0,TREF.CRSTREF    TABLE REFERENCE LIST ORIGIN           02130000
         ST    R0,CRSD.CRSDTBL@   ANCHOR IN CRSDP                       02140000
         LA    R0,1               TABLE REFERENCE IS A SINGLETON        02150000
         ST    R0,CRSD.CRSDTBL#   ANCHOR IN CRSDP                       02160000
         DROP  TREF,R6            CRSDP TABLE REFERENCE, SQSEMAL        02170000
                                                                        02180000
         LA    R1,CRSD.CRSDP      R1 <== RESULT SET DEFINITION REQ/RESP 02190000
         @CALL ISQLCRSD,CTYPE=STD                                       02200000
                                                                        02210000
         ST    R15,RET_CRSD       RETAIN RESULT SET DEFINITION RETCODE  02220000
         CH    R15,=AL2(RC08)     ANALYZE RETURN CODE                   02230000
         BE    ERR_CREF           INVALID COLUMN REFERENCE              02240000
         BH    ERR_RSD            REQUEST IN ERROR                      02250000
                                                                        02260000
*--------------------------------------------------------------         02270000
*   BUILD RESULT SET INDEX DEFINITIONS, RETURN KYNDXRET IN R1           02280000
*--------------------------------------------------------------         02290000
                                                                        02300000
         @CALL ISQKYNDX,(QCS,*CRSD.CRSDPTR@,*CRSD.CRSDRSC#),           X02310000
               MF=(E,MFE_LIST)                                          02320000
                                                                        02330000
         B     *+4(R15)           ANALYZE COMPLETION CODE               02340000
         B     TBLCRE                RC00 - INDEX DEFINITION RETURNED   02350000
         B     TBLCRE                RC04 - NO INDICIES REQUIRED        02360000
         B     ERR_ORD               RC08 - ORDER-BY CLAUSE IN ERROR    02370000
         B     ERR_DIST              RC12 - ERROR RELATED TO DISTINCT   02380000
         EX    R0,*                  RC16 - DEFINED / NOT ANTICIPATED   02390000
                                                                        02400000
*--------------------------------------------------------------         02410000
*   CREATE THE RESULT SET                                               02420000
*--------------------------------------------------------------         02430000
                                                                        02440000
TBLCRE   DS    0H                                                       02450000
         XC    DWORD,DWORD        TBKEYDEF LIST AND ENTRY COUNT         02460000
         ST    R1,@NDXDEF         INDEX DEFINITION BLOCK OR ZERO        02470000
         LTR   R1,R1              INDEX DEFINITIONS PRESENTED?          02480000
         BZ    TBLCRETB           DONE HERE IF NOT                      02490000
                                                                        02500000
         USING KYNDXRET,R1        INDEX DEFINITION RETURN AREA          02510000
         LA    R0,KYNDXLST        TBKEYDEF LIST ORIGIN                  02520000
         ST    R0,DWORD+0         SAVE IN PARAMETER WORKAREA            02530000
         L     R0,KYNDXCNT        TBKEYDEF LIST ENTRY COUNT             02540000
         ST    R0,DWORD+4         SAVE IN PARAMETER WORKAREA            02550000
         DROP  R1                 KYNDXRET                              02560000
                                                                        02570000
TBLCRETB DS    0H                                                       02580000
         TBCREATE QCSTABLE,       PROVIDE GENERATED TABLE NAME         X02590000
               STOKEN=*ICTXSPT@,  EXECUTION SPACE                      X02600000
               TTOKEN=QCSTTOKN,   TABLE TOKEN IS GLOBAL SQL RESOURCE   X02610000
               COLCNT=*CRSD.CRSDTOT#,   COLUMN COUNT                   X02620000
               COLLST=*CRSD.CRSDPTR@,   COLUMN POINTER ARRAY           X02630000
               KEYCNT=*DWORD+4,   KEY COUNT                            X02640000
               KEYLST=*DWORD+0,   KEY LIST                             X02650000
               OPTS=(REPLACE,NOLOCATOR),                               X02660000
               MF=(E,WK256)                                             02670000
                                                                        02680000
*--------------------------------------------------------------         02690000
*   ANALYZE TBCREATE STATUS, RELEASE INDEX & RSD DEFINITIONS            02700000
*--------------------------------------------------------------         02710000
                                                                        02720000
         STM   R15,R1,RETCODES    PRESERVE TBCREATE COMPLETION STATUS   02730000
         ICM   R2,15,@NDXDEF      INDEX DEFINITION WORKAREA PENDING?    02740000
         BZ    TBLNONDX           SKIP IF NOT                           02750000
                                                                        02760000
         $RETSTOR (R2)            STORAGE OBLIGATION                    02770000
                                                                        02780000
TBLNONDX DS    0H                                                       02790000
                                                                        02800000
         CLC   RET_CRSD,=A(RC00)  RESULT SET DEFINITION CREATED?        02810000
         BNE   TBLNORSD           SKIP IF BASE TABLE DEFINITION USED    02820000
                                                                        02830000
         $RETSTOR *CRSD.CRSDPTR@                                        02840000
                                                                        02850000
TBLNORSD DS    0H                                                       02860000
                                                                        02870000
         LM    R15,R1,RETCODES    RESTORE TBCREATE COMPLETION STATUS    02880000
         LTR   R15,R15            TABLE CREATED WITHOUT INCIDENT?       02890000
         BNZ   ERR_TBSV           TERMINATING ERROR OTHERWISE           02900000
                                                                        02910000
         MVI   QCSTDROP,TRUE      AUTO DROP UPON CLOSE                  02920000
         DROP  CRSD               CREATE RESULT SET DEFINITION REQ/RESP 02930000
                                                                        02940000
*--------------------------------------------------------------         02950000
*   TERMINATE AT THIS POINT IF SQLPREPARE()                             02960000
*--------------------------------------------------------------         02970000
                                                                        02980000
         CLI   QCSCLI,QCSC_PRP    SQLPREPARE()?                         02990000
         BE    NORMRET            DONE IF SO                            03000000
                                                                        03010000
         EJECT                                                          03020000
***************************************************************         03030000
*                                                                       03040000
*   Identify columns that accept nulls included in result set.          03050000
*   Some columns have no local interpretation and are set               03060000
*   null for the life of this function.                                 03070000
*                                                                       03080000
***************************************************************         03090000
                                                                        03100000
         TBCOLUMN BYNAME,         IDENTIFY COLUMNS BY NAME             X03110000
               (('TABLE_QUALIFIER',STATQUAL),                          X03120000
               ('TABLE_OWNER',STAOWNER),                               X03130000
               ('SCALE',STASCALE),                                     X03140000
               ('RADIX',STARADIX),                                     X03150000
               ('REMARKS',STAREMRK)),                                  X03160000
               TTOKEN=QCSTTOKN,                                        X03170000
               MF=(E,WK256)                                             03180000
                                                                        03190000
*--------------------------------------------------------------         03200000
*   PERM NULL COLUMNS NOT POPULATED IN THIS IMPLEMENTATION              03210000
*--------------------------------------------------------------         03220000
                                                                        03230000
         SR    R2,R2              R2 <== COLUMN NUMBER                  03240000
         LA    R3,NULL_SAV        R3 <== NULL INDICATOR MASK ORIGIN     03250000
                                                                        03260000
         ICM   R2,3,STATQUAL      TABLE_QUALIFIER COLUMN NUMBER         03270000
         BZ    *+8                                                      03280000
         BAS   R14,SETNULL                                              03290000
                                                                        03300000
         ICM   R2,3,STAOWNER      TABLE_OWNER COLUMN NUMBER             03310000
         BZ    *+8                                                      03320000
         BAS   R14,SETNULL                                              03330000
                                                                        03340000
         EJECT                                                          03350000
***************************************************************         03360000
*                                                                       03370000
*   Complete the predicate tree.  TBPSARG is issued to complete         03380000
*   the saearch argument passed to this routine, if any, with           03390000
*   references to the result set table created above.  The              03400000
*   near-ready tree is passed in via QCSSITRE and the TBPSARGed         03410000
*   tree is generally returned via QCSSATRE when it will be             03420000
*   used as a true TBGET search argument.  However, because we          03430000
*   will use it instead as a TBADD filter we leave QCSSATRE             03440000
*   null - all of the result set trimming will be accomplished          03450000
*   up front at TBADD time.                                             03460000
*                                                                       03470000
***************************************************************         03480000
                                                                        03490000
         ICM   R2,15,QCSSITRE     SEARCH ARGUMENT TREE PROVIDED?        03500000
         BZ    SARG_FIN           NO FURTHER PROCESSING IF NOT          03510000
                                                                        03520000
         TBPSARG TTOKEN=QCSTTOKN, CONVERT TO TABLE SERVICES EXEC FORM  X03530000
               SARGS=(R2),                                             X03540000
               XSTGMGR=(IGENCSTG,QCSGPSTG,WK256),                      X03550000
               MF=(E,MFE_LIST)                                          03560000
                                                                        03570000
         ST    R15,QCSPSARC       POST TBPSARG RETCODE                  03580000
         ST    R0,QCSPSARS        POST TBPSARG RSNCODE                  03590000
         LTR   R15,R15            NORMAL COMPLETION?                    03600000
         BNZ   ERR_ANAL           QCS ANALYSIS REQUIRED IF NOT          03610000
                                                                        03620000
         CLM   R0,1,=AL1(TRUE)    SEARCH ARG IS CATEGORICALLY TRUE?     03630000
         BNE   *+10               SKIP IF NOT                           03640000
         XC    QCSSITRE,QCSSITRE  SEARCH ARGUMENT / FILTER WITHDRAWN    03650000
                                                                        03660000
SARG_FIN DS    0H                                                       03670000
                                                                        03680000
         EJECT                                                          03690000
***************************************************************         03700000
*                                                                       03710000
*   CATALOG SCAN                                                        03720000
*                                                                       03730000
*   Acquire a description of the catalog tables residing in             03740000
*   the selected object space via repeated calls to ICAT$SCN,           03750000
*   retrieving one catalog component table per call. If EOT             03760000
*   is returned on the first call, we assume that SYSDICTIONARY         03770000
*   does not exist in the target space, and therefore no                03780000
*   formal catalog structure is in use.                                 03790000
*                                                                       03800000
*   Although SYSDICTIONARY drives the catalog formatting                03810000
*   process, no information is extracted from those entries             03820000
*   at this time.                                                       03830000
*                                                                       03840000
***************************************************************         03850000
                                                                        03860000
CCATSCAN DS    0H                                                       03870000
         @CALL ICAT$SCN,(*QCSTSPAC,$SCNCKPT,$DDEROW),                  X03880000
               CTYPE=CVT,                                              X03890000
               MF=(E,MFE_LIST)                                          03900000
                                                                        03910000
         CH    R15,=AL2(RC04)     CATALOG TABLE DESCRIPTORS RETURNED?   03920000
         BE    CCATEOT            END OF TABLE                          03930000
         BH    ERR_CSCN           TERMINATING ERROR WHILE SCANNING CAT  03940000
                                                                        03950000
         ST    R0,@OSC            RETAIN OBJECT SPACE CONTENT BLOCK PTR 03960000
         LTR   R9,R1              SPACE COMPONENT TABLE DEFINITION      03970000
         BZ    CCATSCAN           UNANTICIPATED SPACE CONFIGURATION     03980000
         USING SCTDEF,R9                                                03990000
                                                                        04000000
***************************************************************         04010000
*                                                                       04020000
*   Load static table information into SYSVCAT_ODBC_COLS row            04030000
*                                                                       04040000
*   First, post those data items that are specific to the               04050000
*   current table. This information need not be regenerated             04060000
*   as column information is subsequently collected.                    04070000
*                                                                       04080000
***************************************************************         04090000
                                                                        04100000
D        USING DDENTRY,$DDEROW    SYSDICTIONARY ROW                     04110000
                                                                        04120000
         LA    R0,VCHARBUF        VARDATA COLLECTION AREA               04130000
         ST    R0,VCHAR@          ENTIRE AREA AVAILABLE FOR USE         04140000
         LA    R0,L'VCHARBUF      VARDATA COLLECTION AREA LENGTH        04150000
         ST    R0,VCHAR#          INITAL AMOUNT AVAILABLE FOR USE       04160000
                                                                        04170000
         $VARTRMC SCT_TABLE_NAME,VCHAR@,VCHAR#                          04180000
                                                                        04190000
         BZ    *+8                                                      04200000
         EX    R0,*               ASSERT SPACE AVAILABLE                04210000
         ST    R1,C.ODBCOL_TABLE_NAME                                   04220000
                                                                        04230000
***************************************************************         04240000
*                                                                       04250000
*   Catalog tables are defined by TBCOLDEFs and TBKEYDEFs               04260000
*   residing in a catalog definition module mapped by CATINFO.          04270000
*   Note that SYSDICTIONARY is not a standard catalog                   04280000
*   component table.  Rather, it is defined internally within           04290000
*   table services and its CATINFO structure must be determined         04300000
*   uniquely.                                                           04310000
*                                                                       04320000
***************************************************************         04330000
                                                                        04340000
         USING CATINFO,R7         TBCREATE TIME TABLE DESCRIPTION       04350000
         ICM   R7,15,SCT_TABLE_INFO                                     04360000
         BNZ   CCOLSCAN           SWEEP CATALOG COMPONENT TABLE COLS    04370000
                                                                        04380000
         CLC   SCT_TABLE_NAME,=CL16'SYSDICTIONARY'                      04390000
         BNE   CCOLADV            TABLE COMPOSITION NOT KNOWN           04400000
         L     R7,#DDTABLE        SYSDICTIONARY TABLE FORMAT            04410000
                                                                        04420000
CCOLSCAN DS    0H                                                       04430000
         L     R5,CATCOLS         LOCATE COLUMN DEFINITION ENTRIES      04440000
         L     R6,CAT#COLS        NUMBER OF COLUMN DEFINITION ENTRIES   04450000
                                                                        04460000
         MVC   VCHAR@T,VCHAR@     NEXT INSERTION ADDRESS                04470000
         MVC   VCHAR#T,VCHAR#     SPACE REMAINING                       04480000
                                                                        04490000
*--------------------------------------------------------------         04500000
*   EXAMINE COMPONENT COLS FIRST RESTORING COMMON ROW ENTRIES           04510000
*--------------------------------------------------------------         04520000
                                                                        04530000
CCOLNEXT DS    0H                                                       04540000
         L     R4,0(,R5)                                                04550000
         USING TBCOLDEF,R4        ULTIMATE SOURCE OF TABLE FORMAT       04560000
                                                                        04570000
         MVC   VCHAR@,VCHAR@T     NEXT INSERTION ADDRESS                04580000
         MVC   VCHAR#,VCHAR#T     SPACE REMAINING                       04590000
                                                                        04600000
         MVC   NULL_IND,NULL_SAV  INITIALIZE NULL INDICATOR ARRAY       04610000
                                                                        04620000
*--------------------------------------------------------------         04630000
*   COLUMN NAME RETURNED AS VARDATA                                     04640000
*--------------------------------------------------------------         04650000
                                                                        04660000
         $VARTRMC TBCNAME,VCHAR@,VCHAR#                                 04670000
                                                                        04680000
         BZ    *+8                                                      04690000
         EX    R0,*               ASSERT SPACE AVAILABLE                04700000
         ST    R1,C.ODBCOL_COLUMN_NAME                                  04710000
                                                                        04720000
*--------------------------------------------------------------         04730000
*   COLUMN DESCRIPTION RETURNED AS REMARKS, NULL IF OMITTED             04740000
*--------------------------------------------------------------         04750000
                                                                        04760000
         XC    C.ODBCOL_REMARKS,C.ODBCOL_REMARKS                        04770000
         SR    R1,R1              PREPARE FOR INSERT                    04780000
         ICM   R1,3,TBCDESCL      COLUMN DESCRIPTION PROVIDED?          04790000
         BNZ   CCOLREMA           SKIP IF NOT                           04800000
                                                                        04810000
         LA    R3,NULL_IND        R3 <== NULL INDICATOR MASK ORIGIN     04820000
         SR    R2,R2                                                    04830000
         ICM   R2,3,STAREMRK      R2 <== REMARKS COLUMN NUMBER          04840000
         BZ    *+8                                                      04850000
         BAS   R14,SETNULL                                              04860000
         B     CCOLDESC                                                 04870000
                                                                        04880000
CCOLREMA DS    0H                                                       04890000
         LA    R0,256-2           MAX LENGTH FOR ODBC VARCHAR           04900000
         CLR   R1,R0              TOO LARGE?                            04910000
         BNH   *+6                SKIP IF NOT                           04920000
         LR    R1,R0              ELSE TRUNCATE ACCORDINGLY             04930000
         LR    R2,R1              LENGTH OF SOURCE STRING               04940000
                                                                        04950000
         $VARTRMC (*TBCDESCA,(R2)),VCHAR@,VCHAR#                        04960000
                                                                        04970000
         BZ    *+8                                                      04980000
         EX    R0,*               ASSERT SPACE AVAILABLE                04990000
         ST    R1,C.ODBCOL_REMARKS                                      05000000
                                                                        05010000
CCOLDESC DS    0H                                                       05020000
                                                                        05030000
*--------------------------------------------------------------         05040000
*   ACQUIRE STDENV DATA TYPE INFORMATION                                05050000
*--------------------------------------------------------------         05060000
                                                                        05070000
         LA    R1,$DTQUERY        R1 <== DTQUERY PARM BLOCK             05080000
         USING DTQUERY,R1                                               05090000
         XC    DTQUERY(DTQREQL),DTQUERY                                 05100000
                                                                        05110000
         MVC   DTQDTYPE,TBCDTYPE  PRIMARY DATA TYPE CODE                05120000
         MVC   DTQNTYPE,TBCNTYPE  NUMERIC DATA TYPE SUBCODE             05130000
         L     R0,TBCLENG         ACTUAL COLUMN LENGTH                  05140000
         ST    R0,DTQSTGLN                                              05150000
         LH    R0,TBCMAXLN        MAX DATA LENGTH IF APPLICABLE         05160000
         ST    R0,DTQSTGMX                                              05170000
         MVC   DTQNULL,TBCATTRS   COLUMN ATTRIBUTES                     05180000
         NI    DTQNULL,$ATNULL    ISOLATE NULLABILITY ATTRIBUTE         05190000
                                                                        05200000
         @CALL IODBTYPS                                                 05210000
                                                                        05220000
         LA    R1,$DTQUERY        R1 <== DTQUERY PARM BLOCK             05230000
         LA    R0,C.ODBCOLS       R0 <== SQLCOLUMNS ROW                 05240000
         BAS   R14,DATATYPE       ACQUIRE DATATYPE INFORMATION          05250000
         DROP  R1                 DTQUERY                               05260000
                                                                        05270000
***************************************************************         05280000
*                                                                       05290000
*   ADD THE COMPLETED ROW TO THE RESULT SET                             05300000
*                                                                       05310000
***************************************************************         05320000
                                                                        05330000
         TBADD C.ODBCOLS,         INSERT ROW IN RESULT SET             X05340000
               TTOKEN=QCSTTOKN,                                        X05350000
               FILTER=*QCSSITRE,  SEARCH ARGUMENT AS FILTER            X05360000
               NULLMASK=NULL_IND, NULL INDICATORS                      X05370000
               MF=(E,MFE_LIST)                                          05380000
                                                                        05390000
         CH    R15,=AL2(RC08)     ADDED OR SUPPRESSED PER REQUEST?      05400000
         BH    ERR_TBSV           ERROR OTHERWISE                       05410000
                                                                        05420000
*--------------------------------------------------------------         05430000
*   ADVANCE TO NEXT COLUMN DESCRIPTOR AND REPEAT                        05440000
*--------------------------------------------------------------         05450000
                                                                        05460000
CCOLADV  DS    0H                                                       05470000
         LA    R5,4(,R5)          ADVANCE TO NEXT TBCOLDEF PTR          05480000
         BCT   R6,CCOLNEXT        PROCESS ALL COLUMNS                   05490000
         B     CCATSCAN           NEXT TABLE                            05500000
         DROP  R4,R7              TBCOLDEF, CATINFO                     05510000
                                                                        05520000
CCATEOT  DS    0H                 CATALOG SWEEP COMPLETED               05530000
         DROP  D,R9               DDENTRY, SCTDEF                       05540000
                                                                        05550000
         EJECT                                                          05560000
***************************************************************         05570000
*                                                                       05580000
*   VDB TABLE SCAN                                                      05590000
*                                                                       05600000
*   If the current object space is a "project" space, SYSTABLES         05610000
*   contains the name of each VDB table defined in it. This             05620000
*   segment acquires the name of each VDB table and invokes             05630000
*   IVDBLOAD to fetch the associated SYSCOLUMNS and SYSVARIABLES        05640000
*   rows making up the table definition.  Then, (local) VCOLUMNS        05650000
*   is invoked to format and add the appropriate ODBC_COLS rows.        05660000
*                                                                       05670000
***************************************************************         05680000
                                                                        05690000
         L     R15,@OSC           RESTORE OBJECT SPACE CONTENT DESC     05700000
         USING OSC,R15            TRANSIENT ADDRESSABILITY              05710000
         CLI   OSCSTYPE,SPACE_TYPE_PRJ   PROJECT SPACE?                 05720000
         BNE   VTABFIN            DONE IF NOT                           05730000
         DROP  R15                OSC                                   05740000
                                                                        05750000
*--------------------------------------------------------------         05760000
*   DETERMINE IF SYSTABLES EXISTS IN THIS PROJECT                       05770000
*--------------------------------------------------------------         05780000
                                                                        05790000
         TBOPEN 'SYSTABLES',                                           X05800000
               STOKEN=*QCSTSPAC,                                       X05810000
               TTOKEN=SYSTABTK,                                        X05820000
               MF=(E,MFE_LIST)                                          05830000
                                                                        05840000
         LTR   R15,R15            NORMAL COMPLETION                     05850000
         BNZ   VTABFIN            ASSUME STD (MORE OR LESS) UNAVAILABLE 05860000
                                                                        05870000
*--------------------------------------------------------------         05880000
*   ACQUIRE NAME OF NEXT VDB TABLE RESIDING IN THIS PROJECT             05890000
*--------------------------------------------------------------         05900000
                                                                        05910000
VTABNEXT DS    0H                 ACQUIRE VDB TABLE SUMMARY ENTRY       05920000
         TBGET $SYSTAB,L'$SYSTAB,                                      X05930000
               POS=NEXT,                                               X05940000
               TTOKEN=SYSTABTK,                                        X05950000
               MF=(E,MFE_LIST)                                          05960000
                                                                        05970000
         CH    R15,=AL2(RC04)     ANALYZE COMPLETION STATUS             05980000
         BE    VTABEOT            END OF TABLE / DEFICIENT BUFFER       05990000
         BH    ERR_TBSV           TABLE SERVICES ERROR                  06000000
                                                                        06010000
TAB      USING SYSTABLE,$SYSTAB                                         06020000
                                                                        06030000
*--------------------------------------------------------------         06040000
*   LOAD AND XREF THE VDB TABLE DEFINITION, SKIP IF ANY ERRORS          06050000
*--------------------------------------------------------------         06060000
                                                                        06070000
         LA    R5,$VDBLOAD        VDB LOAD PLIST AND RETURN AREA        06080000
         USING VDBLOADP,R5        FORMAT                                06090000
         XC    VDBLOADP(PVDBPLN),VDBLOADP                               06100000
                                                                        06110000
         LA    R0,QCSPRJNM        PROJECT NAME                          06120000
         ST    R0,PVDBPROJ                                              06130000
         LA    R0,TAB.STBLNAME    TABLE NAME, SELF-OVERLATION TO FOLLOW 06140000
         ST    R0,PVDBTABL                                              06150000
                                                                        06160000
         @CALL IVDBLOAD,CTYPE=CVT,MF=(E,VDBLOADP)                       06170000
                                                                        06180000
         LTR   R15,R15            ANALYZE COMPLETION STATUS             06190000
         BNZ   VTABADV            THOROUGHNESS NOT REQUIRED HERE        06200000
                                                                        06210000
         ST    R1,QCSAVDBL        RETAIN VDB LOAD RETURN AREA PTR       06220000
         LR    R5,R1              ESTABLISH TABLE DEFINITION ...        06230000
         USING VDBLRET,R5         RETURN AREA ADDRESSABILITY            06240000
                                                                        06250000
*--------------------------------------------------------------         06260000
*   INIT VARDATA COLLECTION BUFFER, POST STATIC TABLE INFO              06270000
*--------------------------------------------------------------         06280000
                                                                        06290000
         LA    R0,VCHARBUF        VARDATA COLLECTION AREA               06300000
         ST    R0,VCHAR@          ENTIRE AREA AVAILABLE FOR USE         06310000
         LA    R0,L'VCHARBUF      VARDATA COLLECTION AREA LENGTH        06320000
         ST    R0,VCHAR#          INITAL AMOUNT AVAILABLE FOR USE       06330000
                                                                        06340000
         $VARTRMC TAB.STBLNAME,VCHAR@,VCHAR#                            06350000
                                                                        06360000
         BZ    *+8                                                      06370000
         EX    R0,*               ASSERT SPACE AVAILABLE                06380000
         ST    R1,C.ODBCOL_TABLE_NAME                                   06390000
         DROP  TAB                SYSTABLE ROW                          06400000
                                                                        06410000
*--------------------------------------------------------------         06420000
*   PROCESS VDB COLUMNS                                                 06430000
*--------------------------------------------------------------         06440000
                                                                        06450000
         LA    R1,VDBLRET         R1 <== VDB LOAD RETURN AREA           06460000
         BAS   R14,VCOLUMNS       CONSTRUCT VDB TABLE/COLUMN SUMMARIES  06470000
                                                                        06480000
*--------------------------------------------------------------         06490000
*   FREE RESIDENT VDB RESOURCES AND ADVANCE TO NEXT CANDIDATE           06500000
*--------------------------------------------------------------         06510000
                                                                        06520000
VTABADV  DS    0H                                                       06530000
         ICM   R1,15,QCSAVDBL     VDB LOAD COMPLETED?                   06540000
         BZ    VTABCLN            DONE IF NOT, ELSE R1 IS PARM          06550000
                                                                        06560000
         @CALL IVDBRET,WKA=WK256,CTYPE=CVT                              06570000
                                                                        06580000
         XC    QCSAVDBL,QCSAVDBL  INDICATE STORAGE CLEARED              06590000
                                                                        06600000
VTABCLN  DS    0H                                                       06610000
         B     VTABNEXT           NEXT VDB TABLE                        06620000
         DROP  R5                 VDBLRET                               06630000
                                                                        06640000
*--------------------------------------------------------------         06650000
*   VDB SCAN COMPLETE, CLOSE SYSTABLES                                  06660000
*--------------------------------------------------------------         06670000
                                                                        06680000
VTABEOT  DS    0H                                                       06690000
         TBCLOSE TTOKEN=SYSTABTK,MF=(E,MFE_LIST)                       X06700000
                                                                        06710000
VTABFIN  DS    0H                                                       06720000
                                                                        06730000
         EJECT                                                          06740000
***************************************************************         06750000
*                                                                       06760000
*   RETURN RESULT SET AND/OR COMPLETION STATUS TO REQUESTER             06770000
*                                                                       06780000
***************************************************************         06790000
                                                                        06800000
NORMRET  DS    0H                 FORMAT DATA FOR RETURN                06810000
         MVC   QCSTSPAC,ICTXSPT@  RETURN EXECUTION SPACE TOKEN          06820000
         B     RETURN             DONE                                  06830000
                                                                        06840000
*--------------------------------------------------------------         06850000
*   REFERENCE TO UNDEFINED COLUMN                                       06860000
*--------------------------------------------------------------         06870000
                                                                        06880000
ERR_CREF DS    0H                 INVALID COLUMN REFERENCE              06890000
CREF     USING SQCOLREF,R1        COLUMN OCCURRENCE                     06900000
         MVC   QCSECLEX,CREF.SQCOL@C   #CLEX ADDRESS                    06910000
                                                                        06920000
         SQLSTAT ERC_CREF                                               06930000
                                                                        06940000
         B     RETURN                                                   06950000
         DROP  CREF               SQCOLREF                              06960000
                                                                        06970000
*--------------------------------------------------------------         06980000
*   ORDER BY CLAUSE ERROR                                               06990000
*--------------------------------------------------------------         07000000
                                                                        07010000
ERR_ORD  DS    0H                 ERROR IN 'ORDER BY' CLAUSE            07020000
         LR    R2,R1              SUPPLEMENTAL MESSAGE                  07030000
                                                                        07040000
         SQLSTAT ERC_ORD,INFO=(R15)                                     07050000
                                                                        07060000
         SQLMSG 170,(R2)                                                07070000
                                                                        07080000
         B     RETURN                                                   07090000
                                                                        07100000
*--------------------------------------------------------------         07110000
*   DISTINCT KEYDEF BUILD ERROR                                         07120000
*--------------------------------------------------------------         07130000
                                                                        07140000
ERR_DIST DS    0H                 ERROR BUILDING INDEX serving DISTINCT 07150000
         SQLSTAT ERC_DIST,INFO=(R15)                                    07160000
                                                                        07170000
         B     RETURN                                                   07180000
                                                                        07190000
*--------------------------------------------------------------         07200000
*   RESULT SET DEFINITION - CONSTRUCTION ERROR                          07210000
*--------------------------------------------------------------         07220000
                                                                        07230000
ERR_RSD  DS    0H                 ERROR CONSTRUCTING RSD                07240000
         SQLSTAT ERC_RSD,INFO=(R15)                                     07250000
                                                                        07260000
         B     RETURN                                                   07270000
                                                                        07280000
*--------------------------------------------------------------         07290000
*   CATALOG SCAN FAILURE                                                07300000
*--------------------------------------------------------------         07310000
                                                                        07320000
ERR_CSCN DS    0H                                                       07330000
         SQLIDCMP COMPONENT='CATALOG SCAN'                              07340000
                                                                        07350000
         SQLSTAT ERC_CSCN,INFO=(R15)                                    07360000
                                                                        07370000
         B     RETURN                                                   07380000
                                                                        07390000
*--------------------------------------------------------------         07400000
*   TABLE SERVICE FAILURE                                               07410000
*--------------------------------------------------------------         07420000
                                                                        07430000
ERR_TBSV DS    0H                                                       07440000
         SQLIDCMP COMPONENT='TABLE SERVICES'                            07450000
                                                                        07460000
         SQLSTAT ERC_TBSV,INFO=(R15)                                    07470000
                                                                        07480000
         B     RETURN                                                   07490000
                                                                        07500000
*--------------------------------------------------------------         07510000
*   SERVICE FAILURE, QCS ANALYSIS REQUIRED FOR DETAIL                   07520000
*--------------------------------------------------------------         07530000
                                                                        07540000
ERR_ANAL DS    0H                 QCS ANALYSIS REQUIRED                 07550000
         SQLSTAT ERC_ANALYZE                                            07560000
                                                                        07570000
         B     RETURN                                                   07580000
                                                                        07590000
*--------------------------------------------------------------         07600000
*   RETURN                                                              07610000
*--------------------------------------------------------------         07620000
                                                                        07630000
RETURN   DS    0H                                                       07640000
                                                                        07650000
         #EXIT ,                                                        07660000
                                                                        07670000
         EJECT                                                          07680000
***************************************************************         07690000
*                                                                       07700000
*   CATASTROPHIC FAILURES, PROGRAMMING ERRORS, ETC.                     07710000
*                                                                       07720000
***************************************************************         07730000
                                                                        07740000
ABN_FAIL $ABEND ABE_ENV,DUMP=YES,                                      X07750000
               TITLE='RESULT SET DEFINITION - GENERATION ERROR'         07760000
                                                                        07770000
         EJECT                                                          07780000
***************************************************************         07790000
*                                                                       07800000
* ROUTINE:  VCOLUMNS - Generate VDB column entry                        07810000
*                                                                       07820000
* DESCRIPTION:                                                          07830000
*                                                                       07840000
*    This routine accepts a VDB table definition in VDBLRET             07850000
*    format and generates SQLColumns() entries for each                 07860000
*    column.                                                            07870000
*                                                                       07880000
*    VDB data types include STDENV CHAR, INT, and 3270                  07890000
*    ATTRIBUTE.  Column lengths may be defined in SYSCOLUMNS            07900000
*    or may be inheritted from the associated SYSVARIABLE.              07910000
*                                                                       07920000
* ON ENTRY:                                                             07930000
*                                                                       07940000
*    R1  contains the address of a VDB definition in VDBLRET            07950000
*        format                                                         07960000
*                                                                       07970000
* ON EXIT:                                                              07980000
*                                                                       07990000
*    N/A                                                                08000000
*                                                                       08010000
***************************************************************         08020000
                                                                        08030000
VCOLUMNS DS    0H                                                       08040000
         STM   R0,R15,REGSAVE     PRESERVE MAINLINE REGS                08050000
                                                                        08060000
         LR    R9,R1              ACCEPT VDB LOAD RESPONSE BLOCK        08070000
         USING VDBLRET,R9                                               08080000
         L     R4,LVDBACOL        FIRST COLUMN ENTRY                    08090000
         USING SYSCOLS,R4         SYSCOLUMNS ROW FORMAT                 08100000
                                                                        08110000
         LH    R6,LVDB#COL        NUMBER OF COLUMNS                     08120000
         LTR   R6,R6              DEFENSIVE                             08130000
         BNP   VCOLRET            NO COLUMNS                            08140000
                                                                        08150000
         MVC   VCHAR@T,VCHAR@     NEXT INSERTION ADDRESS                08160000
         MVC   VCHAR#T,VCHAR#     SPACE REMAINING                       08170000
                                                                        08180000
*--------------------------------------------------------------         08190000
*   SCAN VDB COLUMNS                                                    08200000
*--------------------------------------------------------------         08210000
                                                                        08220000
VCOLNEXT DS    0H                                                       08230000
         MVC   VCHAR@,VCHAR@T     NEXT INSERTION ADDRESS                08240000
         MVC   VCHAR#,VCHAR#T     SPACE REMAINING                       08250000
                                                                        08260000
*--------------------------------------------------------------         08270000
*   NULL THE REMARKS FIELD                                              08280000
*--------------------------------------------------------------         08290000
                                                                        08300000
         MVC   NULL_IND,NULL_SAV  INITIALIZE NULL INDICATOR ARRAY       08310000
                                                                        08320000
         XC    C.ODBCOL_REMARKS,C.ODBCOL_REMARKS                        08330000
                                                                        08340000
         LA    R3,NULL_IND        R3 <== NULL INDICATOR MASK ORIGIN     08350000
         SR    R2,R2                                                    08360000
         ICM   R2,3,STAREMRK      R2 <== REMARKS COLUMN NUMBER          08370000
         BZ    *+8                                                      08380000
         BAS   R14,SETNULL                                              08390000
                                                                        08400000
*--------------------------------------------------------------         08410000
*   INSERT COLUMN NAME                                                  08420000
*--------------------------------------------------------------         08430000
                                                                        08440000
         $VARTRMC SCOLNAME,VCHAR@,VCHAR#                                08450000
                                                                        08460000
         BZ    *+8                                                      08470000
         EX    R0,*               ASSERT SPACE AVAILABLE                08480000
         ST    R1,C.ODBCOL_COLUMN_NAME                                  08490000
                                                                        08500000
*--------------------------------------------------------------         08510000
*   LOCATE (SOME) SYSVARIABLE ASSOCIATED WITH THE COLUMN                08520000
*--------------------------------------------------------------         08530000
                                                                        08540000
         LA    R2,SCOLVEXE        VARIABLE SECTION BY DML               08550000
         USING SKEYVAR,R2         PREPARE FOR SCAN                      08560000
         LA    R1,SYSCOLS+SCOLN   END OF SYSCOLS VARIABLE SECTION       08570000
         SR    R3,R3              PREPARE FOR 16-BIT INSERT             08580000
                                                                        08590000
VCOLCSCN DS    0H                 LOCATE AN ASSOCIATED VARIABLE         08600000
         ICM   R3,3,SKVARSC#      VARIABLE BACKS DML PERSPECTIVE?       08610000
         BNZ   VCOLCXTR           SCAN ENDS IF SO                       08620000
         LA    R2,SKEYVARL(,R2)   ELSE ADVANCE TO NEXT PERSPECTIVE      08630000
         CR    R2,R1              END OF VARIABLE SECTION REACHED?      08640000
         BL    VCOLCSCN           AGAIN IF NOT                          08650000
         B     VCOLECHR           NO VARIABLES, TOLERATE BAD DEFINITION 08660000
                                                                        08670000
VCOLCXTR DS    0H                                                       08680000
         AL    R3,LVDBAVAR        CONVERT SYSVARIABLE OFFLINK TO ADDR   08690000
                                                                        08700000
VCOLECHR DS    0H                                                       08710000
         DROP  R2                 SKEYVAR                               08720000
                                                                        08730000
*--------------------------------------------------------------         08740000
*   GENERATE DATA TYPE DESCRIPTOR FROM HIGH LEVEL COLUMN INFO           08750000
*--------------------------------------------------------------         08760000
                                                                        08770000
         USING SVARSECT,R3        SYSVARIABLE FORMAT                    08780000
                                                                        08790000
         LA    R1,$DTQUERY        R1 <== DTQUERY PARM BLOCK             08800000
         USING DTQUERY,R1                                               08810000
                                                                        08820000
         MVC   DTQNULL,SCOLNULL   COLUMN NULLABILITY ATTRIBUTE          08830000
         STC   R14,DTQDTYPE       PRIMARY DATA TYPE                     08840000
         STC   R15,DTQNTYPE       NUMERIC DATA TYPE                     08850000
         ST    R0,DTQSTGLN        DATA LENGTH                           08860000
         ST    R0,DTQSTGMX        SAME AS MAX LENGTH                    08870000
                                                                        08880000
         @CALL IODBTYPI,($DTQUERY,SYSCOLS,SVARSECT),                   X08890000
               MF=(E,MFE_LIST)                                          08900000
                                                                        08910000
         LA    R1,$DTQUERY        R1 <== DTQUERY PARM BLOCK             08920000
         LA    R0,C.ODBCOLS       R0 <== SQLCOLUMNS ROW                 08930000
         BAS   R14,DATATYPE       ACQUIRE DATATYPE INFORMATION          08940000
         DROP  R1,R3              DTQUERY, SVARSECT                     08950000
                                                                        08960000
*--------------------------------------------------------------         08970000
*   ADD THE ROW TO THE RESULT SET                                       08980000
*--------------------------------------------------------------         08990000
                                                                        09000000
VCOLADD  DS    0H                                                       09010000
         TBADD C.ODBCOLS,         INSERT ROW IN RESULT SET             X09020000
               TTOKEN=QCSTTOKN,                                        X09030000
               FILTER=*QCSSITRE,  SEARCH ARGUMENT AS FILTER            X09040000
               NULLMASK=NULL_IND, NULL INDICATORS                      X09050000
               MF=(E,MFE_LIST)                                          09060000
                                                                        09070000
         CH    R15,=AL2(RC08)     ADDED OR SUPPRESSED PER REQUEST?      09080000
         BH    ERR_TBSV           ERROR OTHERWISE                       09090000
                                                                        09100000
*--------------------------------------------------------------         09110000
*   ADVANCE TO THE NEXT COLUMN/VARIABLE DEFINITION                      09120000
*--------------------------------------------------------------         09130000
                                                                        09140000
         AH    R4,LVDBLCOL        ADVANCE TO NEXT COLUMN                09150000
         BCT   R6,VCOLNEXT        PROCESS ALL COLUMNS                   09160000
                                                                        09170000
*--------------------------------------------------------------         09180000
*   RETURN TO REQUESTER                                                 09190000
*--------------------------------------------------------------         09200000
                                                                        09210000
VCOLRET  DS    0H                                                       09220000
         LM    R0,R14,REGSAVE     RESTORE MAINLINE REGS                 09230000
         SR    R15,R15                                                  09240000
         BR    R14                                                      09250000
                                                                        09260000
         DROP  R4,R9                                                    09270000
                                                                        09280000
         EJECT                                                          09290000
***************************************************************         09300000
*                                                                       09310000
* ROUTINE:  DATATYPE - LOAD DTQUERY INFO INTO RESULT ROW                09320000
*                                                                       09330000
* DESCRIPTION:                                                          09340000
*                                                                       09350000
*                                                                       09360000
* ON ENTRY:                                                             09370000
*                                                                       09380000
*    R1  - ADDRESS OF A COMPLETED DTQUERY REQUEST BLOCK                 09390000
*    R0  - ADDRESS OF A ODBCOLS CANDIDATE RESULT SET ROW                09400000
*                                                                       09410000
*                                                                       09420000
* ON EXIT:                                                              09430000
*                                                                       09440000
*    R15 CONTAINS ZERO                                                  09450000
*                                                                       09460000
***************************************************************         09470000
                                                                        09480000
DATATYPE DS    0H                                                       09490000
         STM   R0,R15,REGSAVEX    PRESERVE MAINLINE REGS                09500000
                                                                        09510000
         LR    R4,R0              ODBCOLS ROW                           09520000
DC       USING ODBCOLS,R4                                               09530000
                                                                        09540000
         LR    R5,R1              DTQUERY REQUEST/RESPONSE BLOCK        09550000
DQ       USING DTQUERY,R5                                               09560000
                                                                        09570000
*--------------------------------------------------------------         09580000
*   TRANSFER DATA TYPE INFORMATION TO ODBCOLS ROW                       09590000
*--------------------------------------------------------------         09600000
                                                                        09610000
         MVC   DC.ODBCOL_DATA_TYPE,DQ.DTQRCODE                          09620000
         MVC   DC.ODBCOL_PRECISION,DQ.DTQRPREC                          09630000
         MVC   DC.ODBCOL_LENGTH,DQ.DTQRLEN                              09640000
         MVC   DC.ODBCOL_SCALE,DQ.DTQRSCAL                              09650000
         MVC   DC.ODBCOL_RADIX,DQ.DTQRADIX                              09660000
         MVC   DC.ODBCOL_NULLABLE,DQ.DTQRNULL                           09670000
                                                                        09680000
*--------------------------------------------------------------         09690000
*   SET NULL INDICATORS FOR OMITTED, NON-APPLICABLE ITEMS               09700000
*--------------------------------------------------------------         09710000
                                                                        09720000
         SR    R2,R2              R2 <== COLUMN NUMBER                  09730000
         LA    R3,NULL_IND        R3 <== NULL INDICATOR MASK ORIGIN     09740000
                                                                        09750000
         ICM   R2,3,STASCALE      SCALE REQUIRES NULL IF N/A            09760000
         BZ    NNSCALE                                                  09770000
         CLC   DQ.DTQRSCAL,=AL2(SQL_NULL_DATA)                          09780000
         BNE   NNSCALE                                                  09790000
         BAS   R14,SETNULL                                              09800000
NNSCALE  DS    0H                                                       09810000
                                                                        09820000
         ICM   R2,3,STARADIX      RADIX REQUIRES NULL IF N/A            09830000
         BZ    NNRADIX                                                  09840000
         CLC   DQ.DTQRADIX,=AL2(SQL_NULL_DATA)                          09850000
         BNE   NNRADIX                                                  09860000
         BAS   R14,SETNULL                                              09870000
NNRADIX  DS    0H                                                       09880000
                                                                        09890000
*--------------------------------------------------------------         09900000
*   REFORMAT ZERO DELIMITTED DATA TYPE NAME RETURNED                    09910000
*--------------------------------------------------------------         09920000
                                                                        09930000
         ICM   R3,15,DQ.DTQRNAME  DATA TYPE NAME RETURNED?              09940000
         BZ    DATATRET           DONE IF NOT                           09950000
                                                                        09960000
         MVI   WK256,0                                                  09970000
         MVC   WK256+1(L'WK256-1),WK256                                 09980000
         MVI   WK256,4                                                  09990000
                                                                        10000000
         TRT   0(256,R3),WK256    FIND END OF NAME                      10010000
         BC    MISSES,DATATRET    UNEXPECTED AND PROBABLY BROKEN        10020000
         LR    R2,R1              END OF STRING                         10030000
         SR    R2,R3              LENGTH OF NAME                        10040000
                                                                        10050000
         $VARTRMC ((R3),(R2)),VCHAR@,VCHAR#                             10060000
                                                                        10070000
         BZ    *+8                ASSERT SUCCESS                        10080000
         EX    R0,*               DENIED                                10090000
         ST    R1,DC.ODBCOL_TYPE_NAME                                   10100000
                                                                        10110000
*--------------------------------------------------------------         10120000
*   RETURN TO REQUESTER                                                 10130000
*--------------------------------------------------------------         10140000
                                                                        10150000
DATATRET DS    0H                                                       10160000
         LM    R0,R14,REGSAVEX    RESTORE MAINLINE REGS                 10170000
         SR    R15,R15            RETURN CODES NOT DEFINED              10180000
         BR    R14                RETURN                                10190000
         DROP  DC,DQ              ODBCOLS, DTQUERY                      10200000
                                                                        10210000
         EJECT                                                          10220000
***************************************************************         10230000
*                                                                       10240000
* ROUTINE: SETNULL - SET NULL MASK BIT FOR GIVEN COLUMN                 10250000
*                                                                       10260000
* ON ENTRY:                                                             10270000
*                                                                       10280000
*    R3 - MASK ORIGIN                                                   10290000
*    R2 - COLUMN NUMBER (1 TO N)                                        10300000
*                                                                       10310000
***************************************************************         10320000
                                                                        10330000
SETNULL  DS    0H                                                       10340000
         ST    R14,FWORD          PRESERVE RETURN ADDRESS               10350000
                                                                        10360000
         SETBIT (R3),(R2)                                               10370000
                                                                        10380000
         L     R14,FWORD          RESTORE RETURN ADDRESS                10390000
         BR    R14                RETURN                                10400000
                                                                        10410000
         EJECT                                                          10420000
***************************************************************         10430000
*                                                                       10440000
*   LOCAL READ-ONLY WORKING STORAGE                                     10450000
*                                                                       10460000
***************************************************************         10470000
                                                                        10480000
         LTORG ,                                                        10490000
                                                                        10500000
         EJECT                                                          10510000
         SQLCODES ,                                                     10520000
                                                                        10530000
         EJECT                                                          10540000
         PRINT NOGEN                                                    10550000
         ICVT ,              ICVT                                       10560000
         ITASK ,             ITASK                                      10570000
         END   ,                                                        10580000

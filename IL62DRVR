IL62DRVR TITLE '- INTEGRATOR LU6.2 SESSION DRIVER'                      00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: IL62DRVR - INTEGRATOR LU6.2 SESSION DRIVER                   00100000
*                                                                       00110000
* DESCRIPTION:                                                          00120000
*                                                                       00130000
*                                                                       00140000
* ON ENTRY:                                                             00150000
*                                                                       00160000
*    R15 = ENTRY POINT ADDRESS                                          00170000
*    R14 = RETURN      ADDRESS                                          00180000
*    R13 = SAVE AREA   ADDRESS                                          00190000
*    R11 = ICVT        ADDRESS                                          00200000
*    R10 = ITASK       ADDRESS                                          00210000
*    R01 = $SESS TOKEN ADDRESS                                          00220000
*                                                                       00230000
*          +00 = LENGTH OF TOKEN                                        00240000
*          +01 = TOKEN                                                  00250000
*                                                                       00260000
**<DOC-OFF>************************************************************ 00270000
                                                                        00280000
*********************************************************************** 00290000
*                                                                       00300000
* MAINTENANCE:                                                          00310000
*                                                                       00320000
*   07/01/94 RANDY WITEK - LU6.2 SUPPORT                                00330000
*   08/11/95 RANDY WITEK - FIX DEPENDENT LU SUPPORT TO YIELD SESSION    00340000
*                          AFTER THE BIND PROCESS IS COMPLETE.  THIS    00350000
*                          ALLOWS THE LU TO THEN USE THE SESSION.       00360000
*                          THIS PROBLEM WAS NOTICED AFTER IBM PRODUCED  00370000
*                          APAR FIX JR08596 FOR CM/2 DEPENDENT LU.      00380000
*                                                                       00390000
*********************************************************************** 00400000
                                                                        00410000
         EQUS  ,                  GENERAL EQUATES                       00420000
                                                                        00430000
RICVT    EQU   R11                                                      00440000
RITASK   EQU   R10                                                      00450000
RIVTAM   EQU   R9                                                       00460000
RISESS   EQU   R8                                                       00470000
RIPCB    EQU   R7                                                       00480000
                                                                        00490000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00500000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00510000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00520000
         USING IPCB,RIPCB         ESTABLISH ADDRESSABILITY              00530000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00540000
                                                                        00550000
WORKAREA #WORK ,                  GENERAL WORKAREA                      00560000
                                                                        00570000
@SPL     DS    A                  CURRENT $SESS RECEIVE PLIST PTR       00580000
                                                                        00590000
MSGDESC  DS    0A,0F              MESSAGE BUFFER DESCRIPTOR             00600000
MSGBUFR  DS    F                     MESSAGE BUFFER ADDRESS             00610000
MSGBUFL  DS    F                     MESSAGE BUFFER LENGTH              00620000
MSGDESCL EQU   *-MSGDESC          MESSAGE BUFFER DESCRIPTOR LENGTH      00630000
                                                                        00640000
WRK256   DS    XL256              GENERAL WORKAREA                      00650000
L62MFL   L62TRCS MF=L             PLIST CONSTRUCTION                    00660000
$TASKMFL $TASK MF=L               PLIST CONSTRUCTION                    00670000
$SESSPL  $SESS MF=L,FIELDS=(,,,,,,,,) PLIST CONSTRUCTION                00680000
$SESSPLN EQU   *-$SESSPL          LENGTH OF PLIST                       00690000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00700000
REQPSAVE DS    16F                SAVEAREA FOR MESSAGE PROCESSING RTNS  00710000
REGSAVE  DS    16F                SAVEAREA FOR MESSAGE PROCESSING RTNS  00720000
STATREGS DS    16F                SAVEAREA FOR MESSAGE PROCESSING RTNS  00730000
                                                                        00740000
TRACE@   DS    A                  USED FOR LU6.2 SPLIST TRACE           00750000
TRACELEN DS    F                  USED FOR LU6.2 SPLIST TRACE           00760000
L62RETRC DS    F                  LU6.2 SERVICE RETURN CODE AREA        00770000
EVENTCDE DS    F                  $TASK WAIT EVENT CODE                 00780000
                                                                        00790000
DRCV_R15 DS    F                  IL62DRCV R15 RETURN VALUE             00800000
DRCV_R00 DS    F                  IL62DRCV R00 RETURN VALUE             00810000
DRCV_R01 DS    F                  IL62DRCV R01 RETURN VALUE             00820000
DRCV_RET EQU   DRCV_R15,*-DRCV_R15                                      00830000
                                                                        00840000
FLAG     DS    X                                                        00850000
FLAGLOCK EQU   X'80'              VTAM LOCK IS HELD                     00860000
FLAGLCKD EQU   X'40'              VTAM LOCK WAS HELD ON ENTRY           00870000
SESSTOKN DS    XL(L'ISETK)        $SESS TOKEN                           00880000
WORKLEN  #ENDWORK ,               WORKAREA END                          00890000
                                                                        00900000
         $MSGDFT PREFIX=ICTPID,                                        +00910000
               COMPID='L62',                                           +00920000
               TABLE=*#MSGS,                                           +00930000
               WORKA=0,                                                +00940000
               MF=(E,WRK256),                                          +00950000
               PRINT=NOGEN                                              00960000
                                                                        00970000
IL62DRVR #ENTER BASE=R12,         ENTRY LINKAGE                        +00980000
               PREG=R3,                                                +00990000
               SAVE=(YES.NOFRAME),                                     +01000000
               AMODE=31,                                               +01010000
               RMODE=ANY                                                01020000
                                                                        01030000
*---------------------------------------------------------------------- 01040000
* INITIALIZATION                                                        01050000
*---------------------------------------------------------------------- 01060000
                                                                        01070000
         L     RIVTAM,ICTVTCVT                                          01080000
         L     RIPCB,TSKPCBC                                            01090000
                                                                        01100000
*---------------------------------------------------------------------- 01110000
* OBTAIN SESSION TOKEN.                                                 01120000
*---------------------------------------------------------------------- 01130000
                                                                        01140000
         SR    R15,R15             PREPARE FOR INSERT                   01150000
         IC    R15,0(,R3)          LENGTH OF SESSION TOKEN              01160000
         LA    R0,SESSTOKN         RECEIVING FIELD ADDRESS              01170000
         LA    R1,L'SESSTOKN       RECEIVING FIELD LENGTH               01180000
         LA    R14,1(,R3)          ADDRESS OF TOKEN                     01190000
         MVCL  R0,R14              COPY TOKEN TO LOCAL STORAGE          01200000
                                                                        01210000
         $RETSTOR (R3),OWNER=ITASK RELEASE PLIST                        01220000
                                                                        01230000
*---------------------------------------------------------------------- 01240000
* LOCATE THE ISESS BLOCK                                                01250000
*---------------------------------------------------------------------- 01260000
                                                                        01270000
         $SESS $SESS_FIND_SESSION,                                     +01280000
               SESSION=SESSTOKN,                                       +01290000
               ERRET=ABN_SESS,                                         +01300000
               MF=(E,$SESSPL)     LOCATE ASSOCIATED ISESS               01310000
                                                                        01320000
X        USING SPLIST,$SESSPL                                           01330000
         L     RISESS,X.SPLAREA   ADDRESS OF ASSOCIATED ISESS BLOCK     01340000
         DROP  X                                                        01350000
                                                                        01360000
*---------------------------------------------------------------------- 01370000
* SET DRIVER FSM'S FOR STARTUP                                          01380000
*---------------------------------------------------------------------- 01390000
                                                                        01400000
         MVI   ISE62FSC,ISE62FSC_BETC                                   01410000
         MVI   ISE62FRC,ISE62FRC_BETC                                   01420000
         MVI   ISE62FBR,ISE62FBR_INB                                    01430000
         MVI   ISE62FCD,ISE62FCD_NOCD                                   01440000
         NI    ISES1,255-ISES1DIR                                       01450000
         TM    ISEF2,ISEF2SLU     DID WE SEND THE BIND?                 01460000
         BO    FSMDONE            BRANCH IF NOT                         01470000
         MVI   ISE62FCD,ISE62FCD_CD                                     01480000
         OI    ISES1,ISES1DIR                                           01490000
                                                                        01500000
FSMDONE  DS    0H                                                       01510000
                                                                        01520000
*---------------------------------------------------------------------- 01530000
* IF WE RECEIVED AN UNSOLICITED BIND...ISSUE A FREE SESSION             01540000
* IF WE SENT     AN UNSOLICITED BIND...ISSUE A YIELD SESSION            01550000
*---------------------------------------------------------------------- 01560000
                                                                        01570000
         TM    ISE62FL2,ISE62SOL  SOLICITED SESSION?                    01580000
         BO    NOTFREE            BRANCH IF YES                         01590000
         TM    ISEF2,ISEF2SLU     DID WE SEND THE BIND?                 01600000
         BO    FREESLU            BRANCH IF NOT, WE RECEIVED BIND       01610000
                                                                        01620000
         $VTAMWE L'IWEY6,         LENGTH                               +01630000
               IWECYLD            CODE                                  01640000
                                                                        01650000
Z        USING IWEVTAM,R1                                               01660000
         MVC   Z.IWEY6MDE,ISE62MDE PASS MDE ADDRESS                     01670000
         MVC   Z.IWEY6NME,ISELOGMD PASS THE MODE NAME                   01680000
         MVC   Z.IWEY6TKN,ISETK    PASS THE SESSION TOKEN               01690000
         DROP  Z                                                        01700000
                                                                        01710000
         LA    R0,ISEWEQ          QUEUE ADDRESS                         01720000
         BAS   R14,QWE            QUEUE THE WORK ELEMENT                01730000
         B     NOTFREE                                                  01740000
                                                                        01750000
FREESLU  DS    0H                                                       01760000
                                                                        01770000
         OI    ISE62FL1,ISE62AEX  SESSION IS FREE BUT ATTACH IS COMING  01780000
                                                                        01790000
         $VTAMWE L'IWEY4,         SIZE                                 +01800000
               IWECFRES           CODE                                  01810000
                                                                        01820000
Z        USING IWEVTAM,R1                                               01830000
         MVC   Z.IWEY4MDE,ISE62MDE    PASS MDE ADDRESS                  01840000
         MVC   Z.IWEY4NME,ISELOGMD    PASS MODE NAME                    01850000
         MVC   Z.IWEY4TKN,ISETK       PASS SESSION TOKEN                01860000
         DROP  Z                                                        01870000
                                                                        01880000
         L     R14,ISEIVUSR           IVUSER BLOCK                      01890000
         LA    R0,IVUWEQ-IVUSER(,R14) QUEUE ADDRESS                     01900000
         BAS   R14,QWE                QUEUE TO WORK ELEMENT             01910000
         B     NOTFREE                                                  01920000
                                                                        01930000
NOTFREE  DS    0H                                                       01940000
                                                                        01950000
*---------------------------------------------------------------------- 01960000
*                                                                       01970000
* PREPARE FOR INPUT WHICH CAN BE IN THE FORM OF ANY OF THE              01980000
* FOLLOWING:                                                            01990000
*                                                                       02000000
*  1) STOP OR CANCEL                                                    02010000
*  2) SESSION DATA                                                      02020000
*  3) INTER-TASK MESSAGES                                               02030000
*---------------------------------------------------------------------- 02040000
                                                                        02050000
         BAS   R14,TMSGRECV       PREPARE FOR INITIAL MESSAGE RECEIVE   02060000
                                                                        02070000
PREPSESS DS    0H                                                       02080000
                                                                        02090000
         SR    R0,R0              ASYNC RECV W/ CURRENT BUFFER          02100000
         BAS   R14,SESSRECV       PREPARE FOR SESSION RECEIVE           02110000
         BNZ   ABN_SESS           ERROR IN SESSION RECEIVE API          02120000
                                                                        02130000
*---------------------------------------------------------------------- 02140000
* WAIT FOR NEXT EVENT                                                   02150000
*---------------------------------------------------------------------- 02160000
                                                                        02170000
PROCWAIT DS    0H                                                       02180000
                                                                        02190000
         BAS   R14,FREEMSG        RELEASE MESSAGE BUFFER STORAGE        02200000
                                                                        02210000
         $TASK WAIT,                                                   +02220000
               MESSAGE=MSGIN,                                          +02230000
               STOP=STOP,                                              +02240000
               CANCEL=CANCEL,                                          +02250000
               MF=(E,$TASKMFL)                                          02260000
                                                                        02270000
         ST    R15,EVENTCDE       SAVE EVENT CODE                       02280000
                                                                        02290000
*---------------------------------------------------------------------- 02300000
* DETERMINE EVENT FOR NON-MESSAGE/STOP/CANCEL EVENTS                    02310000
*---------------------------------------------------------------------- 02320000
                                                                        02330000
         LM    R3,R5,EVCRTNTB     EVENT TYPE / PROCESSING RTN TABLE     02340000
                                                                        02350000
PROCSCAN DS    0H                 MATCH EVENT TO PROCESSING ROUTINE     02360000
                                                                        02370000
         C     R15,$ETABTYP(,R3)  MATCHING EVENT CODE                   02380000
         BE    PROCMATC           END SCAN IF SO                        02390000
         BXLE  R3,R4,PROCSCAN     AGAIN IF NOT                          02400000
         B     PROCWAIT           IGNORE SPURIOUS EVENT                 02410000
                                                                        02420000
PROCMATC DS    0H                 EVENT IDENTIFIED                      02430000
                                                                        02440000
         L     R15,$ETABRTN(,R3)  EVENT PROCESSING RTN EPA              02450000
         BASR  R14,R15            CALL                                  02460000
         B     PROCWAIT           AWAIT NEXT EVENT                      02470000
                                                                        02480000
EVCRTNTB DC    A(ETYPTABL,8,ETYPTABE-1)                                 02490000
                                                                        02500000
$ETABTYP EQU   0,4                EVENT TYPE CODE                       02510000
$ETABRTN EQU   4,4                EVENT PROCESSING ROUTINE EPA          02520000
                                                                        02530000
ETYPTABL DS    0A                                                       02540000
         DC    A(EC$SESS_RECEIVE,RECV)                                  02550000
         DC    A(EC$LU62_SHIP,SHIPEND)                                  02560000
         DC    A(EC$LU62_BID,BIDEND)                                    02570000
ETYPTABE EQU   *                                                        02580000
                                                                        02590000
*---------------------------------------------------------------------- 02600000
* ROUTINE: RECV - PROCESS A RECEIVED RU                                 02610000
*---------------------------------------------------------------------- 02620000
                                                                        02630000
RECV     DS    0H                                                       02640000
                                                                        02650000
         STM   R0,R14,REQPSAVE    STORE MAINLINE REGS                   02660000
                                                                        02670000
*                                                                       02680000
* CAPTURE DIAGNOSTIC TRACE INFORMATION                                  02690000
*---------------------------------------------------------------------- 02700000
                                                                        02710000
         SR    R3,R3                                                    02720000
         ST    R3,TRACE@                NO ADDITIONAL TRACE DATA        02730000
         ST    R3,TRACELEN              NO ADDITIONAL TRACE DATA        02740000
         L     R2,@SPL                  COMPLETED SPLIST                02750000
                                                                        02760000
X        USING SPLIST,R2                                                02770000
                                                                        02780000
         TM    X.SPLCNTRL,RPLDATA       WAS IT A DATA RECEIVE?          02790000
         BNO   NOTRCDAT                 BRANCH IF NOT                   02800000
         ICM   R15,15,X.SPLRETCD        SUCCESSFUL?                     02810000
         BNZ   NOTRCDAT                 BRANCH IF NOT                   02820000
         L     R3,X.SPLAREA             TRACE THE DATA                  02830000
         MVC   TRACELEN,X.SPLAREAL      TRACE THE DATA                  02840000
                                                                        02850000
NOTRCDAT DS    0H                                                       02860000
                                                                        02870000
         L62TRCS (R2),                         @ SPLIST                +02880000
               (RISESS),                       @ ISESS                 +02890000
               =CL17'RECEIVE COMPLETED',       @ DESCRIPTION           +02900000
               =F'17',                         @ DESCRIPTION LEN       +02910000
               (R3),                           @ ADDITIONAL DATA       +02920000
               TRACELEN,                       @ ADDITIONAL DATA LEN   +02930000
               L62RETRC,                       @ RETURN CODE AREA      +02940000
               MF=(E,L62MFL)                                            02950000
                                                                        02960000
         DROP  X                                                        02970000
                                                                        02980000
*                                                                       02990000
* CALL RECEIVE SPLIST PROCESSOR                                         03000000
*---------------------------------------------------------------------- 03010000
                                                                        03020000
         L     R0,EVENTCDE        EVENT CODE BEING PROCESSED            03030000
         L     R1,@SPL            PASS RECEIVE SPLIST IN R1             03040000
         L     R15,IL6@DRCV       RECEIVE DATA PROCESSOR                03050000
         BASR  R14,R15            CALL THE SERVICE ROUTINE              03060000
         STM   R15,R1,DRCV_RET    SAVE RETURN CODES                     03070000
                                                                        03080000
*                                                                       03090000
* IF RECEIVE DATA PROCESSOR INDICATES SESSION SHOULD BE ENDED...DO IT   03100000
*---------------------------------------------------------------------- 03110000
                                                                        03120000
         LTR   R15,R15            TERMINATE SESSION?                    03130000
         BZ    RERECV             BRANCH IF NOT                         03140000
                                                                        03150000
         $SESS $SESS_END_SESSION, TERMINATE THE SESSION                +03160000
               SESSION=SESSTOKN,                                       +03170000
               ERRET=ABN_SESS,                                         +03180000
               MF=(E,*@SPL)                                             03190000
                                                                        03200000
         CLC   DRCV_R15,=F'12'    ERROR INDICATED IN RCV SPLIST?        03210000
         BNE   RERECV             BRANCH IF NOT                         03220000
         CLC   DRCV_R00,=A($SESS_RC_CANCELED)                           03230000
         BE    RECVEXIT                                                 03240000
                                                                        03250000
*                                                                       03260000
* REQUEST COMPLETE. REISSUE RECEIVE REQUEST AND RETURN                  03270000
*---------------------------------------------------------------------- 03280000
                                                                        03290000
RERECV   DS    0H                                                       03300000
                                                                        03310000
         BAS   R14,SESSRECV       LISTENING TO APPL                     03320000
                                                                        03330000
RECVEXIT DS    0H                                                       03340000
                                                                        03350000
         LM    R0,R14,REQPSAVE    RESTORE MAINLINE REGS                 03360000
         BR    R14                RETURN                                03370000
                                                                        03380000
*---------------------------------------------------------------------- 03390000
* ROUTINE: SHIPEND - PROCESS COMPLETION OF LU6.2 SHIP                   03400000
*---------------------------------------------------------------------- 03410000
                                                                        03420000
SHIPEND  DS    0H                                                       03430000
                                                                        03440000
         STM   R0,R14,REQPSAVE    STORE MAINLINE REGS                   03450000
                                                                        03460000
*                                                                       03470000
* CAPTURE DIAGNOSTIC TRACE INFORMATION                                  03480000
*---------------------------------------------------------------------- 03490000
                                                                        03500000
         L62TRCS *ISE62SRQ,                    @ SPLIST                +03510000
               (RISESS),                       @ ISESS                 +03520000
               =CL14'SHIP COMPLETED',          @ DESCRIPTION           +03530000
               =F'14',                         @ DESCRIPTION LEN       +03540000
               =F'0',                          @ ADDITIONAL DATA       +03550000
               =F'0',                          @ ADDITIONAL DATA LEN   +03560000
               L62RETRC,                       @ RETURN CODE AREA      +03570000
               MF=(E,L62MFL)                                            03580000
                                                                        03590000
*                                                                       03600000
* CALL THE SPLIST PROCESSOR                                             03610000
*---------------------------------------------------------------------- 03620000
                                                                        03630000
         L     R0,EVENTCDE        EVENT CODE BEING PROCESSED            03640000
         L     R1,ISE62SRQ        SHIP REQUEST SPLIST IN R1             03650000
         L     R15,IL6@DRCV       RECEIVE DATA PROCESSOR                03660000
         BASR  R14,R15            CALL THE SERVICE ROUTINE              03670000
         STM   R15,R1,DRCV_RET    SAVE RETURN CODES                     03680000
                                                                        03690000
*                                                                       03700000
* IF RECEIVE PROCESSOR INDICATES TO END THE SESSION...DO IT             03710000
*---------------------------------------------------------------------- 03720000
                                                                        03730000
         LTR   R15,R15            TERMINATE SESSION?                    03740000
         BZ    SHIPENDX           BRANCH IF NOT                         03750000
                                                                        03760000
         $GETSTOR L'SPL,                                               +03770000
               OWNER=ITASK        ALLOCATE $SESS PLIST                  03780000
                                                                        03790000
         LR    R3,R1              SAVE SPLIST ADDRESS                   03800000
                                                                        03810000
         $SESS $SESS_END_SESSION, TERMINATE THE SESSION                +03820000
               SESSION=SESSTOKN,                                       +03830000
               ERRET=ABN_SESS,                                         +03840000
               MF=(E,(R3))                                              03850000
                                                                        03860000
         $RETSTOR (R3),                                                +03870000
               OWNER=ITASK        RELEASE $SESS PLIST                   03880000
                                                                        03890000
*                                                                       03900000
* EVENT COMPLETE. RETURN TO MAINLINE.                                   03910000
*---------------------------------------------------------------------- 03920000
                                                                        03930000
SHIPENDX DS    0H                                                       03940000
                                                                        03950000
         LM    R0,R14,REQPSAVE    RESTORE MAINLINE REGS                 03960000
         BR    R14                RETURN                                03970000
                                                                        03980000
*---------------------------------------------------------------------- 03990000
* ROUTINE: BIDEND - PROCESS COMPLETION OF LU6.2 BID                     04000000
*---------------------------------------------------------------------- 04010000
                                                                        04020000
BIDEND   DS    0H                                                       04030000
                                                                        04040000
         STM   R0,R14,REQPSAVE    STORE MAINLINE REGS                   04050000
                                                                        04060000
*                                                                       04070000
* CAPTURE DIAGNOSTIC TRACE INFORMATION                                  04080000
*---------------------------------------------------------------------- 04090000
                                                                        04100000
         L62TRCS *ISE62BRQ,                    @ SPLIST                +04110000
               (RISESS),                       @ ISESS                 +04120000
               =CL14'BID COMPLETED',           @ DESCRIPTION           +04130000
               =F'14',                         @ DESCRIPTION LEN       +04140000
               =F'0',                          @ ADDITIONAL DATA       +04150000
               =F'0',                          @ ADDITIONAL DATA LEN   +04160000
               L62RETRC,                       @ RETURN CODE AREA      +04170000
               MF=(E,L62MFL)                                            04180000
                                                                        04190000
*                                                                       04200000
* CALL THE SPLIST PROCESSOR                                             04210000
*---------------------------------------------------------------------- 04220000
                                                                        04230000
         L     R0,EVENTCDE        EVENT CODE BEING PROCESSED            04240000
         L     R1,ISE62BRQ        SHIP REQUEST SPLIST IN R1             04250000
         L     R15,IL6@DRCV       RECEIVE DATA PROCESSOR                04260000
         BASR  R14,R15            CALL THE SERVICE ROUTINE              04270000
         STM   R15,R1,DRCV_RET    SAVE RETURN CODES                     04280000
                                                                        04290000
*                                                                       04300000
* EVENT COMPLETE. RETURN TO MAINLINE.                                   04310000
*---------------------------------------------------------------------- 04320000
                                                                        04330000
         LM    R0,R14,REQPSAVE    RESTORE MAINLINE REGS                 04340000
         BR    R14                RETURN                                04350000
                                                                        04360000
*---------------------------------------------------------------------- 04370000
* MESSAGE EVENT RECEIVED, RESET MESSAGE EPB AND RECEIVE MSGS            04380000
*---------------------------------------------------------------------- 04390000
                                                                        04400000
MSGIN    DS    0H                                                       04410000
                                                                        04420000
         BAS   R14,TMSGRECV       PREPARE FOR NEXT MESSAGE              04430000
                                                                        04440000
MSGNEXT  DS    0H                                                       04450000
                                                                        04460000
         BAS   R14,GETMSG         RECEIVE THE MESSAGE                   04470000
         BZ    MSGRECVD           MESSAGE ACQUIRED                      04480000
         B     PROCWAIT           ALL MESSAGES RECEIVED                 04490000
                                                                        04500000
MSGRECVD DS    0H                                                       04510000
                                                                        04520000
         LR    R6,R1              ADDRESS OF MESSAGE HEADER             04530000
         USING TMSGSTD,R6         MESSAGE ADDRESSABILITY                04540000
         L     R0,TMSGTYPE        DETERMINE MESSAGE TYPE                04550000
         LM    R3,R5,MSGRTNTB     MESSAGE TYPE / PROCESSING RTN TABLE   04560000
                                                                        04570000
MSGSCAN  DS    0H                 MATCH MESSAGE TO PROCESSING ROUTINE   04580000
                                                                        04590000
         C     R0,$MTABTYP(,R3)   MATCHING MESSAGE TYPE?                04600000
         BE    MSGMATCH           END SCAN IF SO                        04610000
         BXLE  R3,R4,MSGSCAN      AGAIN IF NOT                          04620000
         B     MSGNEXT            IGNORE SPURIOUS MSG                   04630000
                                                                        04640000
MSGMATCH DS    0H                                                       04650000
                                                                        04660000
         LA    R1,TMSGSTD         R1 <== MESSAGE ORIGIN                 04670000
         L     R15,$MTABRTN(,R3)  MESSAGE PROCESSING RTN EPA            04680000
         BASR  R14,R15            CALL                                  04690000
         B     MSGNEXT            PROCESS NEXT MESSAGE                  04700000
         DROP  R6                 TMSGSTD                               04710000
                                                                        04720000
*                                                                       04730000
*   MESSAGE TYPES / PROCESSING ROUTINE TABLE                            04740000
*---------------------------------------------------------------------- 04750000
                                                                        04760000
$MTABTYP EQU   0,4                MESSAGE TYPE CODE                     04770000
$MTABRTN EQU   4,4                MESSAGE PROCESSING ROUTINE EPA        04780000
                                                                        04790000
MSGRTNTB DC    A(MTYPTABL,8,MTYPTABE-1)                                 04800000
MTYPTABL DS    0A                                                       04810000
*        DC    A(ITM_LU62_MESSAGE,LU62MSG)                              04820000
         DC    A(0,0)                                                   04830000
MTYPTABE EQU   *                                                        04840000
                                                                        04850000
LU62MSG  DS    0H                                                       04860000
                                                                        04870000
*---------------------------------------------------------------------- 04880000
* STOP EVENT                                                            04890000
*---------------------------------------------------------------------- 04900000
                                                                        04910000
STOP     DS    0H                                                       04920000
                                                                        04930000
*---------------------------------------------------------------------- 04940000
* CANCEL EVENT                                                          04950000
*---------------------------------------------------------------------- 04960000
                                                                        04970000
CANCEL   DS    0H                                                       04980000
                                                                        04990000
         BAS   R14,VTAMLOCK       OBTAIN LOCK                           05000000
         OI    ISE62FL2,ISE62DRD  FLAG THAT DRIVER IS DOWN              05010000
         BAS   R14,VTAMUNLK       RELEASE LOCK                          05020000
                                                                        05030000
*                                                                       05040000
* EXIT TO END LU6.2 SESSION DRIVER PROCESS                              05050000
*---------------------------------------------------------------------- 05060000
                                                                        05070000
         LM    R15,R0,STATREGS    RESTORE RETURN/REASON CODES           05080000
                                                                        05090000
         #EXIT ,                  RETURN                                05100000
                                                                        05110000
*---------------------------------------------------------------------- 05120000
*                                                                       05130000
* ROUTINE: SESSRECV - RECEIVE SESSION DATA                              05140000
*                                                                       05150000
* DESCRIPTION:                                                          05160000
*                                                                       05170000
*    THIS ROUTINE WILL INITIALIZE A REQUEST TO RECEIVE DATA             05180000
*    FROM THE $SESS (SESSION MANAGEMENT) FACILITY. ALL $SESS            05190000
*    RECEIVE REQUESTS ARE ISSUED WITH AN EPB WHICH TO BE                05200000
*    POSTED WHEN THE RECEIVE EVENT COMPLETES.                           05210000
*                                                                       05220000
* ENTRY:   N/A                                                          05230000
*                                                                       05240000
* EXIT:    UPON RETURN FROM THIS ROUTINE R15 WILL CONTAIN               05250000
*          THE RETURN CODE PRESENTED BY $SESS                           05260000
*                                                                       05270000
*---------------------------------------------------------------------- 05280000
                                                                        05290000
SESSRECV DS    0H                                                       05300000
                                                                        05310000
         STM   R0,R15,REGSAVE     SAVE CALLER'S REGISTERS               05320000
                                                                        05330000
*---------------------------------------------------------------------- 05340000
* ACQUIRE A $SESS PARAMETER BLOCK ON FIRST CALL                         05350000
*---------------------------------------------------------------------- 05360000
                                                                        05370000
         ICM   R1,15,@SPL         ADDR OF $SESS PLIST                   05380000
         BNZ   SESS_EPB           INIT SESSION EPB                      05390000
                                                                        05400000
         $GETSTOR L'SPL,                                               +05410000
               OWNER=ITASK        ALLOCATE $SESS PLIST                  05420000
                                                                        05430000
         ST    R1,@SPL            SAVE SPLIST ADDRESS                   05440000
                                                                        05450000
SESS_EPB DS    0H                                                       05460000
                                                                        05470000
*---------------------------------------------------------------------- 05480000
* ACQUIRE A RECEIVE XEPB AND HANG OUT A RECEIVE                         05490000
*---------------------------------------------------------------------- 05500000
                                                                        05510000
         $TASK SETEPB,            INITIALIZE $SESS RECEIVE EPB         +05520000
               ECODE=EC$SESS_RECEIVE,                                  +05530000
               ERRET=ABN_TASK,    SERVICE ROUTINE FAILURE              +05540000
               MF=(E,$TASKMFL)                                          05550000
                                                                        05560000
         LR    R3,R1              EPB TOKEN / ADDR                      05570000
                                                                        05580000
         $SESS $SESS_RECEIVE,     ASYNC RECEIVE                        +05590000
               SESSION=SESSTOKN,                                       +05600000
               EPB=(R3),                                               +05610000
               MF=(E,*@SPL)                                             05620000
                                                                        05630000
*---------------------------------------------------------------------- 05640000
* RETURN $SESS COMPLETION CODES TO REQUESTOR                            05650000
*---------------------------------------------------------------------- 05660000
                                                                        05670000
         LM    R2,R14,REGSAVE+8   RESTORE CALLER'S REGISTERS            05680000
         LTR   R15,R15            SET CONDITION CODE                    05690000
         BR    R14                RETURN                                05700000
                                                                        05710000
*---------------------------------------------------------------------- 05720000
* ROUTINE: TMSGRECV - PREPARE FOR MESSAGE RECEIVE                       05730000
*---------------------------------------------------------------------- 05740000
                                                                        05750000
TMSGRECV DS    0H                                                       05760000
                                                                        05770000
         STM   R0,R15,REGSAVE     SAVE MAINLINE REGISTERS               05780000
                                                                        05790000
         $TASK SETEPB,            INITIALIZE MESSAGE EPB               +05800000
               EPB=PCBMEPB,       MESSAGE EPB                          +05810000
               ECODE=EC$MSG,                                           +05820000
               SCOPE=LOCAL,                                            +05830000
               ERRET=ABN_TASK,    SERVICE ROUTINE FAILURE              +05840000
               MF=(E,$TASKMFL)                                          05850000
                                                                        05860000
         LM    R2,R14,REGSAVE+8   RESTORE MAINLINE REGISTERS            05870000
         LTR   R15,R15            SET CONDITION CODE                    05880000
         BR    R14                RETURN                                05890000
                                                                        05900000
*---------------------------------------------------------------------- 05910000
*                                                                       05920000
* ROUTINE: GETMSG - RECEIVE MESSAGE FROM MESSAGE QUEUE                  05930000
*                                                                       05940000
* DESCRIPTION:                                                          05950000
*                                                                       05960000
*    THIS ROUTINE WILL RECEIVE A MESSAGE FROM THE LOCAL PCB             05970000
*    MESSAGE QUEUE.  RC08 FROM $TRECV INDICATES THAT THE BUFFER         05980000
*    PROVIDED IS TOO SMALL.  THE MINIMUM LENGTH REQUIRED                05990000
*    RETURNED IN R1 IS USED TO REALLOCATE THE BUFFER AND THE            06000000
*    REQUEST IS RETRIED IF NECESSARY.                                   06010000
*                                                                       06020000
* ENTRY:  N/A                                                           06030000
*                                                                       06040000
* EXIT:   R15 CONTAINS THE $TRECV RETURN CODE AS FOLLOWS                06050000
*                                                                       06060000
*            RC00 - MESSAGE RECEIVED AND RETURNED VIA R1                06070000
*            RC04 - NO MESSAGE AVAILABLE                                06080000
*                                                                       06090000
*---------------------------------------------------------------------- 06100000
                                                                        06110000
GETMSG   DS    0H                                                       06120000
                                                                        06130000
         STM   R0,R15,REGSAVE     SAVE CALLER'S REGISTERS               06140000
                                                                        06150000
GETMRECV DS    0H                                                       06160000
                                                                        06170000
         L     R3,MSGBUFR         BUFFER PROVIDED ON INITIAL REQ        06180000
         L     R2,MSGBUFL         ZERO LENGTH BUFFER TO OBTAIN MSGLEN   06190000
                                                                        06200000
         $TRECV ((R3),(R2)),      RECEIVE A MESSAGE                    +06210000
               SCOPE=PCB,                                              +06220000
               MF=(E,MFE_LIST)                                          06230000
                                                                        06240000
         C     R15,=A(RC08)       MESSAGE BUFFER TOO SMALL?             06250000
         BNE   GETMEXIT           NO, RETURN                            06260000
                                                                        06270000
*---------------------------------------------------------------------- 06280000
* MSG BUFFER ALLOCATION INADEQUATE, REALLOCATE AND RETRY                06290000
*---------------------------------------------------------------------- 06300000
                                                                        06310000
         LR    R2,R1              MESSAGE LENGTH                        06320000
                                                                        06330000
         $REALLOC MSGDESC,(R2),   (RE)ALLOCATE MESSAGE BUFFER          +06340000
               MF=(E,MFE_LIST)                                          06350000
                                                                        06360000
         B     GETMRECV           RETRY RECEIVE                         06370000
                                                                        06380000
*---------------------------------------------------------------------- 06390000
* RETURN TO REQUESTOR                                                   06400000
*---------------------------------------------------------------------- 06410000
                                                                        06420000
GETMEXIT DS    0H                                                       06430000
                                                                        06440000
         L     R1,MSGBUFR         ADDRESS OF MESSAGE BUFFER             06450000
         LM    R2,R14,REGSAVE+8   RESTORE CALLER'S REGISTERS            06460000
         LTR   R15,R15            SET CONDITION CODE                    06470000
         BR    R14                RETURN                                06480000
                                                                        06490000
*---------------------------------------------------------------------- 06500000
*                                                                       06510000
* ROUTINE: FREEMSG - FREE $TRECV MESSAGE BUFFER                         06520000
*                                                                       06530000
* DESCRIPTION:                                                          06540000
*                                                                       06550000
*    THIS ROUTINE WILL FREE THE STORAGE PREVIOUSLY ALLOCATED TO         06560000
*    $TRECV ACQUIRE AN INBOUND MESSAGE. THE BUFFER DESCRIPTOR           06570000
*    IS RESET ACCORDINGLY.                                              06580000
*                                                                       06590000
*---------------------------------------------------------------------- 06600000
                                                                        06610000
FREEMSG  DS    0H                                                       06620000
                                                                        06630000
         STM   R0,R15,REGSAVE     SAVE CALLER'S REGISTERS               06640000
                                                                        06650000
         ICM   R3,15,MSGBUFR      MESSAGE BUFFER (ADDR,LEN)             06660000
         BZ    FREEMRET           NOT ALLOCATED                         06670000
                                                                        06680000
         $RETSTOR (R3)                                                  06690000
                                                                        06700000
         XC    MSGDESC(MSGDESCL),MSGDESC                                06710000
                                                                        06720000
FREEMRET DS    0H                                                       06730000
                                                                        06740000
         LM    R0,R14,REGSAVE     RESTORE CALLER'S REGISTERS            06750000
         SR    R15,R15            RETURN CODES NOT DEFINED              06760000
         BR    R14                RETURN                                06770000
                                                                        06780000
*---------------------------------------------------------------------- 06790000
* SUBROUTINE QWE - QUEUE A WORK ELEMENT TO A GIVEN WORK QUEUE           06800000
*                                                                       06810000
* ENTRY            R14 = RETURN ADDRESS                                 06820000
*                  R1  = WORK ELEMENT ADDRESS                           06830000
*                  R0  = QUEUE ADDRESS                                  06840000
*                                                                       06850000
* RETURNS          R15 = 0 --> QUEUEING WAS SUCCESSFUL                  06860000
*                      = 4 --> QUEUEING FAILED, WORK ELEMENT RELEASED   06870000
*---------------------------------------------------------------------- 06880000
                                                                        06890000
QWE      DS    0H                                                       06900000
                                                                        06910000
         STM   R14,R4,SUB0SAVE    SAVE REGISTERS                        06920000
         LR    R3,R0              SAVE QUEUE ADDRESS                    06930000
         LR    R4,R1              SAVE WORK ELEMENT ADDRESS             06940000
                                                                        06950000
         $VTAMQ (R4),             WORK ELEMENT                         +06960000
               (R3)               QUEUE                                 06970000
                                                                        06980000
         L     R14,SUB0SAVE       RESTORE REGISTERS                     06990000
         LM    R0,R4,SUB0SAVE+8   RESTORE REGISTERS                     07000000
         BR    R14                AND RETURN TO CALLER W/R15            07010000
                                                                        07020000
*---------------------------------------------------------------------- 07030000
* SUBROUTINE VTAMLOCK - OBTAIN VTAM GLOBAL LOCK                         07040000
*---------------------------------------------------------------------- 07050000
                                                                        07060000
VTAMLOCK DS    0H                                                       07070000
                                                                        07080000
         TM    FLAG,FLAGLOCK        HAVE WE ALREADY OBTAINED THE LOCK?  07090000
         BOR   R14                  RETURN IF YES                       07100000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             07110000
                                                                        07120000
         $SER  OBTAIN,                                                 +07130000
               VTAM                                                     07140000
                                                                        07150000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              07160000
         BNE   VTAMLOEX             BRANCH IF NOT                       07170000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         07180000
                                                                        07190000
VTAMLOEX DS    0H                                                       07200000
                                                                        07210000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               07220000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          07230000
         BR    R14                  RETURN                              07240000
                                                                        07250000
*---------------------------------------------------------------------- 07260000
* SUBROUTINE VTAMUNLK - RELEASE VTAM GLOBAL LOCK                        07270000
*---------------------------------------------------------------------- 07280000
                                                                        07290000
VTAMUNLK DS    0H                                                       07300000
                                                                        07310000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       07320000
         BNOR  R14                  BRANCH IF NOT                       07330000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             07340000
         BOR   R14                  DON'T RELEASE IF IT WAS             07350000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             07360000
                                                                        07370000
         $SER  RELEASE,                                                +07380000
               VTAM                                                     07390000
                                                                        07400000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  07410000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          07420000
         BR    R14                  RETURN                              07430000
                                                                        07440000
*---------------------------------------------------------------------- 07450000
* ERROR ROUTINES                                                        07460000
*---------------------------------------------------------------------- 07470000
                                                                        07480000
ABN_TASK DS    0H                                                       07490000
                                                                        07500000
         STM   R15,R1,STATREGS                                          07510000
         $ABEND ABE_$TASK,*STATREGS+0,*STATREGS+8,DUMP=YES,SCOPE=PCB,  +07520000
               TITLE='ERROR RETURNED FROM $TASK FUNCTION'               07530000
                                                                        07540000
ABN_SESS DS    0H                                                       07550000
                                                                        07560000
         STM   R15,R1,STATREGS                                          07570000
         $ABEND ABE_$SESS,*STATREGS+0,*STATREGS+8,DUMP=YES,SCOPE=PCB,  +07580000
               TITLE='ERROR ENCOUNTERED IN $SESS FUNCTION'              07590000
                                                                        07600000
*---------------------------------------------------------------------- 07610000
* LITERALS AND CONSTANTS                                                07620000
*---------------------------------------------------------------------- 07630000
                                                                        07640000
         LTORG ,                                                        07650000
                                                                        07660000
         PRINT NOGEN                                                    07670000
         ISTDBIND ,               VTAM BIND IMAGE                       07680000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                07690000
         IKJTCB ,                 MVS TASK CONTROL BLOCK                07700000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         07710000
         ICVT  ,                  INTEGRATOR CVT                        07720000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   07730000
         ITASK ,                  INTEGRATOR TASK BLOCK                 07740000
         IPCB ,                   INTEGRATOR PROCESS BLOCK              07750000
         IACB ,                   INTEGRATOR VTAM ACB                   07760000
         ABCODES ,                INTEGRATOR $ABEND CODES               07770000
         EVCODES ,                INTEGRATOR EVENT CODES                07780000
         TMSG ,                   INTEGRATOR INTERTASK MESSAGING        07790000
         ISESS ,                  INTEGRATOR SESSION BLOCK              07800000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            07810000
         IRPL ,                   INTEGRATOR VTAM RPL                   07820000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          07830000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             07840000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             07850000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             07860000
         END   ,                                                        07870000

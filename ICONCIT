ICONCIT  TITLE 'ICONCIT - INTERTASK CONSOLE COMMAND ROUTER'             00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* Routine:  ICONCIT - Intertask console command router                  00040000
*                                                                       00050000
* Description:                                                          00060000
*                                                                       00070000
*    This routine implements the $COMMAND macro services. It            00080000
*    constructs an intertask command request block, or CITREQ,          00090000
*    that identifies the requesting workunit, the command               00100000
*    string, and the UTOKEN of the requester if available.              00110000
*                                                                       00120000
*    The command string is appended to the CITREQ foundation.           00130000
*    Command strings cannot exceed 256 bytes.  Longer strings           00140000
*    result in IMPROPER REQUEST.                                        00150000
*                                                                       00160000
*    The UTOKEN, if available, is appended to the CITREQ                00170000
*    immediately following the command string regardless of             00180000
*    whether command authorization tests are actually                   00190000
*    requested.                                                         00200000
*                                                                       00210000
*                                                                       00220000
* On entry:                                                             00230000
*                                                                       00240000
*    R1  contains the address of a parameter list described by          00250000
*        the $COMMAND DSECT=YES mapping.                                00260000
*                                                                       00270000
* On exit:                                                              00280000
*                                                                       00290000
*    R15 contains one of the following return codes                     00300000
*                                                                       00310000
*        RC00 - command request forwarded to command scheduler          00320000
*        RC12 - improper request                                        00330000
*                                                                       00340000
**<DOC-OFF>****************************************************         00350000
                                                                        00360000
         EJECT                                                          00370000
**************************************************************          00380000
*                                                                       00390000
* MAINTENANCE:                                                          00400000
*                                                                       00410000
*    08/15/94 R. Turgeon              PAR #137762                       00420000
*             Initial version; intertask command processing             00430000
*                                                                       00440000
*    05/11/95 R. Colmone              PAR #187851                       00450000
*             Added Monitor ID number to uniquely identify              00460000
*             a command monitor process.                                00470000
*                                                                       00480000
**************************************************************          00490000
         EJECT                                                          00500000
         #WORK ,                                                        00510000
                                                                        00520000
         CITREQ DSECT=NO          INTERTASK COMMAND EXECUTION REQ BLOCK 00530000
@CITCMD  DS    CL256    *APPEND*  MAX LENGTH OF INTERTASK COMMAND       00540000
@CITUTKN DS    XL256    *APPEND*  MAX LENGTH OF UTOKEN                  00550000
                                                                        00560000
         #ENDWORK                                                       00570000
                                                                        00580000
         EJECT                                                          00590000
         $COMMAND DSECT=YES       REQUEST PLIST                         00600000
                                                                        00610000
         EJECT                                                          00620000
         $TSEND DSECT=YES         INTERTASK MESSAGE REQUEST             00630000
                                                                        00640000
         EJECT                                                          00650000
         ICHRUTKN ,               SAF UTOKEN                            00660000
                                                                        00670000
         EJECT                                                          00680000
         MSGCODES ,               INTERTASK MESSAGING CODES             00690000
*                                                                       00700000
         EQUS  ,                                                        00710000
                                                                        00720000
         EJECT                                                          00730000
ICONCIT  #ENTER PREG=R8                                                 00740000
                                                                        00750000
         USING ITASK,R10          STDENV                                00760000
         ICM   R9,15,TSKPCBC      PROCESS MODE                          00770000
         BZ    ERR_REQ                                                  00780000
         USING IPCB,R9                                                  00790000
                                                                        00800000
         EJECT                                                          00810000
**<DOC-ON>*****************************************************         00820000
*                                                                       00830000
*   Construct a CITREQ block from request list, environ, proxy          00840000
*                                                                       00850000
*   Generally, the identify of the $COMMAND requester is                00860000
*   extracted from the environment (ITASK, IPCB, etc). However          00870000
*   if the $COMMAND requester is acting as proxy for some other         00880000
*   workunit, it can pass the identity of the original requester        00890000
*   in the $COMMAND macro.  If any of the proxy parameters are          00900000
*   provided, identity information comes exclusively from those         00910000
*   parameters.                                                         00920000
*                                                                       00930000
**<DOC-OFF>****************************************************         00940000
                                                                        00950000
         USING PCITP,R8           PARAMETERS EXPLICITLY DENOTED         00960000
         LA    R4,CITREQ          INTERTASK REQUEST BLOCK IN WORKAREA   00970000
         USING CITREQ,R4          TIGHTEN UP THE ADDRESSABILITY         00980000
                                                                        00990000
         MVC   CITCBID,=CL8'CITREQ'                                     01000000
                                                                        01010000
         SR    R0,R0              PREPARE FOR INSERTION                 01020000
         O     R0,PCITAMN#        PROXY AUTO CMD MONITOR IDNUM   187851 01030000
         O     R0,PCITAMNM        PROXY AUTO CMD SUBMITTER              01040000
         O     R0,PCITITNM        PROXY TASK NAME                       01050000
         O     R0,PCITIPNM        PROXY PROCESS NAME                    01060000
         O     R0,PCITIUNM        PROXY USERID                          01070000
         O     R0,PCITITKN        PROXY WORKUNIT TOKEN                  01080000
         O     R0,PCITCNAM        PROXY MCS CONSOLE NAME                01090000
         O     R0,PCITCNID        PROXY MCS CONSOLE ID                  01100000
         O     R0,PCITCART        PROXY MCS CONSOLE ID                  01110000
         BNZ   PROXY              PROCESS PROXY REQUEST                 01120000
                                                                        01130000
*--------------------------------------------------------------         01140000
*   REQUESTER IDENTITY EXTRACTED FROM ENVIRONMENT                       01150000
*--------------------------------------------------------------         01160000
         MVC   CITITASK,TSKNAME                                         01170000
         MVC   CITIPROC,PCBNAME                                         01180000
         MVC   CITENTKN,PCBENTKN                                        01190000
                                                                        01200000
         ICM   R1,15,PCBUSER      IUSER CONSTRUCTED?                    01210000
         BZ    *+10               SKIP IF NOT                           01220000
         MVC   CITUSER,USRNAME-IUSER(R1)                                01230000
         B     PROCOPTS                                                 01240000
                                                                        01250000
*--------------------------------------------------------------         01260000
*   REQUESTER IDENTITY PROVIDED BY PROXY CALL                           01270000
*--------------------------------------------------------------         01280000
PROXY    DS    0H                                                       01290000
         MVC   CITAMN#,PCITAMN#   AUTO CMD SUBMITTER IDNUM       187851 01300000
         ICM   R2,15,PCITAMNM     AUTO CMD SUBMITTER IDENTIFIER         01310000
         BZ    *+10                                                     01320000
         MVC   CITAMNM,0(R2)                                            01330000
                                                                        01340000
         ICM   R2,15,PCITITNM     REQUESTER ITASK                       01350000
         BZ    *+10                                                     01360000
         MVC   CITITASK,0(R2)                                           01370000
                                                                        01380000
         ICM   R2,15,PCITIPNM     REQUESTER PROCESS                     01390000
         BZ    *+10                                                     01400000
         MVC   CITIPROC,0(R2)                                           01410000
                                                                        01420000
         ICM   R2,15,PCITITKN     REQUESTER WORKUNIT TOKEN              01430000
         BZ    *+10                                                     01440000
         MVC   CITENTKN,0(R2)                                           01450000
                                                                        01460000
         ICM   R2,15,PCITIUNM     REQUESTER USERID                      01470000
         BZ    *+10                                                     01480000
         MVC   CITUSER,0(R2)                                            01490000
                                                                        01500000
         ICM   R2,15,PCITCNAM     MCS CONSOLE NAME                      01510000
         BZ    *+10                                                     01520000
         MVC   CITCONNM,0(R2)                                           01530000
                                                                        01540000
         ICM   R2,15,PCITCNID     MCS CONSOLE ID                        01550000
         BZ    *+10                                                     01560000
         MVC   CITCONID,0(R2)                                           01570000
                                                                        01580000
         ICM   R2,15,PCITCART     MCS COMMAND RESPONSE ID               01590000
         BZ    *+10                                                     01600000
         MVC   CITCART,0(R2)                                            01610000
                                                                        01620000
*--------------------------------------------------------------         01630000
*   COMMAND PROCESSING OPTIONS                                          01640000
*--------------------------------------------------------------         01650000
PROCOPTS DS    0H                                                       01660000
         ICM   R0,15,PCITSCOP     COMMAND SCOPING REQUESTED?            01670000
         BZ    *+8                SKIP IF NOT                           01680000
         OI    CITOPTNS,CITO_SCOPE                                      01690000
                                                                        01700000
         ICM   R0,15,PCITMSGS     $MSG OUTPUT RETURN REQUEST?           01710000
         BZ    *+8                SKIP IF NOT                           01720000
         OI    CITOPTNS,CITO_MSGRET                                     01730000
                                                                        01740000
         ICM   R0,15,PCITAUTH     TEST COMMAND AUTHORIZATION?           01750000
         BZ    *+8                SKIP IF NOT                           01760000
         OI    CITOPTNS,CITO_AUTHTEST                                   01770000
                                                                        01780000
         ICM   R1,15,PCITDSTA     ADDITIONAL MESSAGE DESTINATIONS?      01790000
         BZ    PROCDSTA           SKIP IF NOT                           01800000
         CL    R1,=A(256)         MORE THAN A BYTES WORTH?              01810000
         BNH   *+8                SKIP IF MASK GIVEN EXPLICITLY         01820000
         ICM   R1,1,0(R1)         ELSE FETCH REMOTE MASK                01830000
         STC   R1,CITDESTA        RETAIN ADDITIONAL DESTINATIONS        01840000
                                                                        01850000
PROCDSTA DS    0H                                                       01860000
         LA    R5,CITREQ+CITLN    CIT EXTENSION AREA                    01870000
         LA    R6,CITLN           LENGTH OF CIT WITHOUT EXTENSIONS      01880000
                                                                        01890000
***************************************************************         01900000
*                                                                       01910000
*   APPEND COMMAND TEXT                                                 01920000
*                                                                       01930000
***************************************************************         01940000
         ICM   R3,15,PCITCMDL     LENGTH OF COMMAND TEXT                01950000
         BNP   ERR_REQ            REQUEST INVALID                       01960000
         C     R3,=A(L'@CITCMD)   COMMAND LENGTH IS REASONABLE?         01970000
         BH    ERR_REQ            TERMINATE IF NOT                      01980000
                                                                        01990000
         STH   R3,CITCMDL         INSERT CMD LENGTH IN MESSAGE          02000000
         BCTR  R3,0               PREPARE FOR EX COPY                   02010000
         L     R15,PCITCMD        LOCATE COMMAND STRING                 02020000
         EX    R3,*+4             APPEND COMMAND TO CIT                 02030000
         MVC   0(*-*,R5),0(R15)   EX OBJECT                             02040000
                                                                        02050000
         LR    R0,R5              COMMAND ORIGIN ADDRESS                02060000
         SR    R0,R4              COMMAND ORIGIN OFFSET                 02070000
         STH   R0,CITCMD          SAVE PORTABLE OFFLINK                 02080000
                                                                        02090000
         LA    R5,1(R3,R5)        NEXT AVAILABLE EXTENSION SLOT         02100000
         LA    R6,1(R3,R6)        TOTAL LENGTH OF CIT                   02110000
                                                                        02120000
***************************************************************         02130000
*                                                                       02140000
*   APPEND UTOKEN                                                       02150000
*                                                                       02160000
***************************************************************         02170000
         TM    ICTSAFOP,ICTS$ENA  SECURITY ACTIVE?                      02180000
         BNO   NOAUTH             SKIP IF NOT                           02190000
         ICM   R1,15,PCBUSER      LOCATE IUSER, IF ANY                  02200000
         BZ    NOAUTH             SECURITY ENVIRONMENT REQUIRED         02210000
         ICM   R1,15,USRACEE-IUSER(R1)   LOCATE SAF ACEE                02220000
         BZ    NOAUTH                    SECURITY ENVIRON INCOMPLETE    02230000
         ICM   R7,15,ACEETOKP-ACEE(R1)   LOCATE UTOKEN                  02240000
         BZ    NOAUTH                    SECURITY ENVIRON INCOMPLETE    02250000
                                                                        02260000
         USING TOKEN,R7                                                 02270000
                                                                        02280000
*--------------------------------------------------------------         02290000
*   UTOKEN RESIDES IN FETCH PROTECTED STORAGE                           02300000
*--------------------------------------------------------------         02310000
         MODESET EXTKEY=ZERO,     SWITCH TO KEY ZERO                   X02320000
               SAVEKEY=(2)                                              02330000
                                                                        02340000
         SR    R3,R3              PREPARE FOR INSERT                    02350000
         IC    R3,TOKLEN          ACQUIRE UTOKEN LENGTH                 02360000
         STH   R3,CITUTOKL        SAVE LENGTH                           02370000
         BCTR  R3,0               PREPARE FOR EX                        02380000
         EX    R3,*+4             APPEND UTOKEN TO CITREQ               02390000
         MVC   0(*-*,R5),TOKEN    EX OBJECT                             02400000
                                                                        02410000
         MODESET KEYADDR=(2)      RESTORE KEY                           02420000
                                                                        02430000
*--------------------------------------------------------------         02440000
*   COMPUTE UTOKEN OFFSET AND ADJUST CITREQ ACCORDINGLY                 02450000
*--------------------------------------------------------------         02460000
         LR    R0,R5              COMMAND ORIGIN ADDRESS                02470000
         SR    R0,R4              COMMAND ORIGIN OFFSET                 02480000
         STH   R0,CITUTOK         SAVE PORTABLE OFFLINK                 02490000
                                                                        02500000
         LA    R5,1(R3,R5)        NEXT AVAILABLE EXTENSION SLOT         02510000
         LA    R6,1(R3,R6)        TOTAL LENGTH OF CIT                   02520000
         DROP  R7                 UTOKEN                                02530000
                                                                        02540000
NOAUTH   DS    0H                                                       02550000
                                                                        02560000
***************************************************************         02570000
*                                                                       02580000
*   SEND COMMAND PROCESSING REQUEST TO COMMAND SCHEDULER                02590000
*                                                                       02600000
***************************************************************         02610000
         $TSEND '$CONTASK',       THE ONE AND ONLY                     X02620000
               TYPE=ITM_CONS_SIM,                                      X02630000
               INFO=(CITREQ,(R6)),                                     X02640000
               MF=(E,MFE_LIST)                                          02650000
                                                                        02660000
         LR    R0,R15             TSEND COMPLETION IS OUR REASON        02670000
         LA    R15,RC00           INDICATE SUCCESS                      02680000
         B     RETURN                                                   02690000
                                                                        02700000
***************************************************************         02710000
*                                                                       02720000
*   RETURN COMPLETION STATUS TO CALLER                                  02730000
*                                                                       02740000
***************************************************************         02750000
ERR_REQ  DS    0H                 INVALID REQUEST                       02760000
         LA    R15,RC12           INDICATE ERROR                        02770000
         SR    R0,R0              REASON CODE NOT DEFINED               02780000
                                                                        02790000
RETURN   DS    0H                                                       02800000
         #EXIT ,                                                        02810000
                                                                        02820000
         EJECT                                                          02830000
***************************************************************         02840000
*                                                                       02850000
*   LOCAL READ/ONLY DATA AREAS, ETC.                                    02860000
*                                                                       02870000
***************************************************************         02880000
         LTORG ,                                                        02890000
                                                                        02900000
         PRINT NOGEN                                                    02910000
         ICVT  ,                                                        02920000
         ITASK ,                                                        02930000
         IPCB  ,                                                        02940000
         IUSER ,                                                        02950000
                                                                        02960000
         IHAACEE ,                                                      02970000
         END   ,                                                        02980000

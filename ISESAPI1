ISESAPI1 TITLE 'INTEGRATOR - VTAM SESSION SERVICES API (PART 1)'        00010000
**<DOC-ON>************************************************************* 00020000
*                                                                       00030000
* ROUTINE: ISESAPI1 - INTEGRATOR VTAM SESSION SERVICES API (PART 1)     00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*                                                                       00080000
*                                                                       00090000
*                                                                       00100000
*                                                                       00110000
* ON ENTRY:                                                             00120000
*                                                                       00130000
*    R15 = ENTRY POINT ADDRESS                                          00140000
*    R14 = RETURN ADDRESS                                               00150000
*    R13 = AVAILABLE SAVE AREA                                          00160000
*    R11 = ICVT ADDRESS                                                 00170000
*    R10 = ITASK ADDRESS                                                00180000
*    R09 = IVTAMCVT ADDRESS                                             00190000
*    R08 = ISESS ADDRESS                                                00200000
*    R07 = IVUSER ADDRESS                                               00210000
*    R06 = $SESS PARAMETER LIST ADDRESS                                 00220000
*          (SEE COMMENTS FOR SPECIFIC SERVICE BEING CALLED)             00230000
*                                                                       00240000
* ON EXIT:                                                              00250000
*                                                                       00260000
*    R15 = $SESS_RC_...                                                 00270000
*                                                                       00280000
*    R00 = $SESS_RSN_...                                                00290000
*                                                                       00300000
*    R01 = ADDRESS OF THE $SESS PARAMETER LIST (SPLIST)                 00310000
*                                                                       00320000
*    ALL OTHER REGISTERS ARE RESTORED                                   00330000
*                                                                       00340000
**<DOC-OFF>************************************************************ 00350000
                                                                        00360000
         EJECT ,                                                        00370000
*********************************************************************** 00380000
*                                                                       00390000
* MAINTENANCE:                                                          00400000
*                                                                       00410000
*   08/01/93 RANDY WITEK                                                00420000
*   07/01/94 RANDY WITEK - LU6.2 SUPPORT                                00430000
*                                                                       00440000
*********************************************************************** 00450000
                                                                        00460000
         EQUS  ,                  GENERAL EQUATES                       00470000
                                                                        00480000
RICVT    EQU   R11                                                      00490000
RITASK   EQU   R10                                                      00500000
RIVTAM   EQU   R9                                                       00510000
RISESS   EQU   R8                                                       00520000
RIVUSER  EQU   R7                                                       00530000
RSPLIST  EQU   R6                                                       00540000
RIWE     EQU   R5                                                       00550000
                                                                        00560000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00570000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00580000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00590000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00600000
         USING IVUSER,RIVUSER     ESTABLISH ADDRESSABILITY              00610000
         USING SPLIST,RSPLIST     ESTABLISH ADDRESSABILITY              00620000
         USING IWEVTAM,RIWE       ESTABLISH ADDRESSABILITY              00630000
         USING ISTDBIND,ISEBIND   ESTABLISH ADDRESSABILITY              00640000
                                                                        00650000
*---------------------------------------------------------------------- 00660000
*   S A V E   A N D   W O R K I N G   S T O R A G E                     00670000
*---------------------------------------------------------------------- 00680000
                                                                        00690000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00700000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00710000
SUB1SAVE DS    18F                SUBROUTINE SAVE AREA                  00720000
WRK256   DS    XL256              GENERAL WORKAREA                      00730000
$TASKMFL $TASK MF=L               $TASK PLIST CONSTRUCTION AREA         00740000
RETR15   DS    F                  RETURN CODE                           00750000
RETR0    DS    F                  RETURN REGISTER 0                     00760000
RETR1    DS    F                  RETURN REGISTER 1                     00770000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00780000
EXTVECID DS    X                  ID OF CONTROL VECTOR TO LOCATE        00790000
EXTQRPID DS    X                  ID OF QUERY REPLY TO LOCATE           00800000
FLAG     DS    X                                                        00810000
FLAGLOCK EQU   X'80'              VTAM GLOBAL LOCK HELD                 00820000
FLAGLCKD EQU   X'40'              VTAM GLOBAL LOCK HELD ON ENTRY        00830000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00840000
                                                                        00850000
*---------------------------------------------------------------------- 00860000
*   M E S S A G E   D E F A U L T S                                     00870000
*---------------------------------------------------------------------- 00880000
                                                                        00890000
         $MSGDFT PREFIX=ICTPID,COMPID='VTM',TABLE=*#MSGS,              +00900000
               PRINT=NOGEN,WORKA=0,MF=(E,WRK256)                        00910000
                                                                        00920000
*---------------------------------------------------------------------- 00930000
*   M O D U L E   E N T R Y                                             00940000
*---------------------------------------------------------------------- 00950000
                                                                        00960000
ISESAPI1 #ENTER BASE=R12,         R12 IS BASE REGISTER                 +00970000
               AMODE=31,                                               +00980000
               RMODE=ANY,                                              +00990000
               SAVE=YES,          ALLOCATE SAVE/WORK AREA              +01000000
               RESTENV=NO,        ICVT AND ITASK POINTERS ARE OK       +01010000
               WAPASS=NO,         NO WORK AREA PASSED IN R0            +01020000
               LINKAGE=STD        CALLED BY BAS/BASR                    01030000
                                                                        01040000
*---------------------------------------------------------------------- 01050000
* VALIDATE FUNCTION CODE AND JUMP TO PROCESSING ROUTINE                 01060000
*---------------------------------------------------------------------- 01070000
                                                                        01080000
         L     R1,SPLFUNC         LOAD REQUEST CODE                     01090000
         LTR   R1,R1              TEST VALUE                            01100000
         BNP   RETURN4            BRANCH IF NEGATIVE                    01110000
         BCTR  R1,0               MINUS 1                               01120000
         SLL   R1,2               MULTIPLY BY 4                         01130000
         C     R1,=A(MAXFUNC)     IS REQUEST CODE VALID?                01140000
         BNH   REQTABLE(R1)       BRANCH TO ROUTINE IF VALID            01150000
         B     RETURN4            EXIT TO CALLER                        01160000
                                                                        01170000
REQTABLE B     SENDDATA           1  = $SESS_SEND_DATA                  01180000
         B     SENDPRSP           2  = $SESS_SEND_POSRESP               01190000
         B     SENDNRSP           3  = $SESS_SEND_NEGRESP               01200000
         B     SENDSIG            4  = $SESS_SEND_SIGNAL                01210000
         B     SENDBID            5  = $SESS_SEND_BID                   01220000
         B     SENDLUS            6  = $SESS_SEND_LUSTAT                01230000
         B     SENDCAN            7  = $SESS_SEND_CANCEL                01240000
         B     SENDRTR            8  = $SESS_SEND_RTR                   01250000
         B     SENDCHA            9  = $SESS_SEND_CHASE                 01260000
         B     SENDRLQ            10 = $SESS_SEND_RELQ                  01270000
         B     SENDQEC            11 = $SESS_SEND_QEC                   01280000
         B     SENDQC             12 = $SESS_SEND_QC                    01290000
         B     SENDSBI            13 = $SESS_SEND_SBI                   01300000
         B     SENDBIS            14 = $SESS_SEND_BIS                   01310000
         B     SENDSDT            15 = $SESS_SEND_SDT                   01320000
         B     SENDCLR            16 = $SESS_SEND_CLEAR                 01330000
         B     SENDSTSN           17 = $SESS_SEND_STSN                  01340000
         B     SENDRQR            18 = $SESS_SEND_RQR                   01350000
         B     SENDSHTD           19 = $SESS_SEND_SHUTD                 01360000
         B     SENDSHTC           20 = $SESS_SEND_SHUTC                 01370000
         B     SENDRSHT           21 = $SESS_SEND_RSHUTD                01380000
         B     RECEIVE            22 = $SESS_RECEIVE                    01390000
         B     EXTRACT            23 = $SESS_EXTRACT                    01400000
         B     STRTSESS           24 = $SESS_START_SESSION              01410000
         B     ENDSESS            25 = $SESS_END_SESSION                01420000
MAXFUNC  EQU   (*-REQTABLE)-4                                           01430000
                                                                        01440000
*---------------------------------------------------------------------- 01450000
* QUEUE VTAM-RELATED $SESS REQUESTS TO THE SESSION PROC                 01460000
*                                                                       01470000
* ENTRY  VALUES: R01 = ADDRESS OF $SESS SERVICES PARAMETER LIST         01480000
*                SPLFUNC  = A VALID $SESS FUNCTION CODE                 01490000
*                SPLTOKEN = SESSION TOKEN                               01500000
*                OTHER SPLIST FIELDS AS SPECIFIED ON THE REQUEST        01510000
*                                                                       01520000
* RETURN VALUES: R15 = $SESS_RC_...                                     01530000
*                R00 = $SESS_RSN_...                                    01540000
*                R01 = SPLIST ADDRESS                                   01550000
*                                                                       01560000
*---------------------------------------------------------------------- 01570000
                                                                        01580000
RECEIVE  DS    0H                 $SESS_RECEIVE                         01590000
SENDDATA DS    0H                 $SESS_SEND_DATA                       01600000
SENDPRSP DS    0H                 $SESS_SEND_POSRESP                    01610000
SENDNRSP DS    0H                 $SESS_SEND_NEGRESP                    01620000
SENDSIG  DS    0H                 $SESS_SEND_SIGNAL                     01630000
SENDBID  DS    0H                 $SESS_SEND_BID                        01640000
SENDLUS  DS    0H                 $SESS_SEND_LUSTAT                     01650000
SENDCAN  DS    0H                 $SESS_SEND_CANCEL                     01660000
SENDRTR  DS    0H                 $SESS_SEND_RTR                        01670000
SENDCHA  DS    0H                 $SESS_SEND_CHASE                      01680000
SENDSDT  DS    0H                 $SESS_SEND_SDT                        01690000
SENDCLR  DS    0H                 $SESS_SEND_CLEAR                      01700000
SENDSHTD DS    0H                 $SESS_SEND_SHUTD                      01710000
SENDSHTC DS    0H                 $SESS_SEND_SHUTC                      01720000
SENDRSHT DS    0H                 $SESS_SEND_RSHUTD                     01730000
SENDRLQ  DS    0H                 $SESS_SEND_RELQ                       01740000
SENDQEC  DS    0H                 $SESS_SEND_QEC                        01750000
SENDQC   DS    0H                 $SESS_SEND_QC                         01760000
SENDSBI  DS    0H                 $SESS_SEND_SBI                        01770000
SENDBIS  DS    0H                 $SESS_SEND_BIS                        01780000
SENDSTSN DS    0H                 $SESS_SEND_STSN                       01790000
SENDRQR  DS    0H                 $SESS_SEND_RQR                        01800000
ENDSESS  DS    0H                 $SESS_END_SESSION                     01810000
                                                                        01820000
*                                                                       01830000
* ALLOCATE A SESS WORK ELEMENT                                          01840000
*---------------------------------------------------------------------- 01850000
                                                                        01860000
         $VTAMWE L'IWEXG,         SIZE                                 +01870000
               IWECSESS           CODE                                  01880000
                                                                        01890000
         LR    RIWE,R1            ESTABLISH ADDRESSABILITY              01900000
                                                                        01910000
*                                                                       01920000
* ALLOCATE AN XEPB FOR SYNCHRONOUS REQUESTS                             01930000
*---------------------------------------------------------------------- 01940000
                                                                        01950000
         SR    R4,R4              SHOW NO WAIT NEEDED IN API            01960000
         OC    SPLEPB,SPLEPB      IS EPB PROVIDED FOR ASYNC?            01970000
         BNZ   GOTEPB             BRANCH IF YES                         01980000
                                                                        01990000
         $TASK SETEPB,            INITIALIZE EPB FOR SYNCH REQUEST     +02000000
               ECODE=EC$SESS,     $SESS REQUEST EVENT                  +02010000
               ERRET=ERR$TASK,                                         +02020000
               MF=(E,$TASKMFL)                                          02030000
                                                                        02040000
         LR    R4,R1              R4 HAS THE XEPB ADDRESS               02050000
         ST    R4,SPLEPB          STORE XEPB ADDRESS IN USER'S SPLIST   02060000
                                                                        02070000
GOTEPB   DS    0H                                                       02080000
                                                                        02090000
*                                                                       02100000
* FILL IN THE WORK ELEMENT                                              02110000
*---------------------------------------------------------------------- 02120000
                                                                        02130000
         ST    RSPLIST,IWEXGLST   SET ADDRESS OF $SESS PLIST            02140000
                                                                        02150000
*                                                                       02160000
* QUEUE THE SESS WORK ELEMENT TO THE ISESS WORK QUEUE                   02170000
*---------------------------------------------------------------------- 02180000
                                                                        02190000
         LA    R1,ISEWEQ          QUEUE ADDRESS                         02200000
         BAS   R14,QWE            QUEUE THE WORK ELEMENT                02210000
                                                                        02220000
*                                                                       02230000
* IF THIS IS A SYNCHRONOUS REQUEST, WAIT ON THE XEPB FOR COMPLETION     02240000
*---------------------------------------------------------------------- 02250000
                                                                        02260000
         LTR   R4,R4              SHOULD WE WAIT ON AN XEPB?            02270000
         BZ    RETURN             BRANCH IF NOT                         02280000
                                                                        02290000
         $TASK WAIT,              WAIT FOR SESS WORK TO BE PROCESSED   +02300000
               EPB=(R4),          XEPB ADDRESS                         +02310000
               MF=(E,$TASKMFL)                                          02320000
                                                                        02330000
         B     RETURN                                                   02340000
                                                                        02350000
*---------------------------------------------------------------------- 02360000
* QUEUE $SESS_START_SESSION REQUESTS TO THE MAIN OR THE IVUSER PROC.    02370000
*                                                                       02380000
* ENTRY  VALUES: R01 = ADDRESS OF $SESS SERVICES PARAMETER LIST         02390000
*                SPLFUNC  = $SESS_START_SESSION                         02400000
*                SPLTOKEN = SESSION TOKEN                               02410000
*                         = 0 TO INITIATE A NEW IVUSER FOR THE SESSION  02420000
*                OTHER SPLIST FIELDS AS SPECIFIED ON THE REQUEST        02430000
*                                                                       02440000
* RETURN VALUES: R15 = $SESS_RC_...                                     02450000
*                R00 = $SESS_RSN_...                                    02460000
*                R01 = SPLIST ADDRESS                                   02470000
*                                                                       02480000
*---------------------------------------------------------------------- 02490000
                                                                        02500000
STRTSESS DS    0H                 $SESS_START_SESSION                   02510000
                                                                        02520000
*                                                                       02530000
* VERIFY THAT A SESSION INITIATION REQUEST IS NOT ALREADY ACTIVE        02540000
*---------------------------------------------------------------------- 02550000
                                                                        02560000
         OC    SPLTOKEN+4(4),SPLTOKEN+4 NO TOKEN OR USER TOKEN ONLY?    02570000
         BZ    STRTNBSY           BRANCH IF YES                         02580000
         OC    ISERQSIR,ISERQSIR  IS A SESSION INITIATION REQ. ACTIVE?  02590000
         BNZ   RETURN16           BRANCH IF YES                         02600000
STRTNBSY DS    0H                                                       02610000
                                                                        02620000
*                                                                       02630000
* VERIFY THAT REQUIRED PARAMETERS ARE PRESENT                           02640000
*---------------------------------------------------------------------- 02650000
                                                                        02660000
         ICM   R1,15,SPLUNAME     WE NEED A PARTNER NAME                02670000
         BZ    ERRNOPRM           BRANCH IF MISSING PARAMETER           02680000
                                                                        02690000
*                                                                       02700000
* ALLOCATE A SESSION INITIATION REQUEST WORK ELEMENT                    02710000
*---------------------------------------------------------------------- 02720000
                                                                        02730000
         LA    R3,L'IWEXK         BASE SIZE                             02740000
         ICM   R1,15,SPLAREA      WAS A USERDATA AREA SPECIFIED?        02750000
         BZ    STRTIWE            BRANCH IF NOT                         02760000
         A     R3,SPLAREAL        ADD IN THE SIZE OF USERDATA           02770000
                                                                        02780000
STRTIWE  DS    0H                                                       02790000
                                                                        02800000
         $VTAMWE (R3),            SIZE                                 +02810000
               IWECSIRQ           CODE                                  02820000
                                                                        02830000
         LR    RIWE,R1            ESTABLISH ADDRESSABILITY              02840000
                                                                        02850000
*                                                                       02860000
* ALLOCATE AN XEPB FOR SYNCHRONOUS REQUESTS                             02870000
*---------------------------------------------------------------------- 02880000
                                                                        02890000
         SR    R4,R4              SHOW NO WAIT NEEDED IN API            02900000
         OC    SPLTOKEN+4(4),SPLTOKEN+4 NO TOKEN OR USER TOKEN ONLY?    02910000
         BZ    STRTGEPB           BRANCH IF NOT                         02920000
         OC    SPLEPB,SPLEPB      IS EPB PROVIDED FOR ASYNC?            02930000
         BNZ   STRTGEPB           BRANCH IF YES                         02940000
                                                                        02950000
         $TASK SETEPB,            INITIALIZE EPB FOR SYNCH REQUEST     +02960000
               ECODE=EC$SIRQ,     $SESS INITIATION REQUEST EVENT       +02970000
               ERRET=ERR$TASK,                                         +02980000
               MF=(E,$TASKMFL)                                          02990000
                                                                        03000000
         LR    R4,R1              R4 HAS THE XEPB ADDRESS               03010000
         ST    R4,SPLEPB          STORE XEPB ADDRESS IN USER'S SPLIST   03020000
                                                                        03030000
STRTGEPB DS    0H                                                       03040000
                                                                        03050000
*                                                                       03060000
* FILL IN THE WORK ELEMENT                                              03070000
*---------------------------------------------------------------------- 03080000
                                                                        03090000
         ICM   R14,15,SPLAREA     USERDATA ADDRESS                      03100000
         BZ    STRTNODT           BRANCH IF NOT SPECIFIED               03110000
         L     R15,SPLAREAL       USERDATA LENGTH                       03120000
         LA    R0,IWEXKDT         IWE USERDATA AREA                     03130000
         LR    R1,R15             USERDATA LENGTH                       03140000
         ST    R1,IWEXKDTL        SET USERDATA LENGTH                   03150000
         MVCL  R0,R14             COPY USERDATA TO WORK ELEMENT         03160000
STRTNODT DS    0H                                                       03170000
                                                                        03180000
         ICM   R1,15,SPLPOOL      POOL NAME ADDRESS                     03190000
         BZ    STRTNOPL           BRANCH IF NOT SPECIFIED               03200000
         MVC   IWEXKPOL,0(R1)     COPY REQUESTED POOL NAME              03210000
STRTNOPL DS    0H                                                       03220000
                                                                        03230000
         ICM   R1,15,SPLMASK      MASK ADDRESS                          03240000
         BZ    STRTNOMK           BRANCH IF NOT SPECIFIED               03250000
         MVC   IWEXKMSK,0(R1)     COPY REQUESTED MASK                   03260000
STRTNOMK DS    0H                                                       03270000
                                                                        03280000
         ICM   R1,15,SPLOGMDE     LOGMODE NAME ADDRESS                  03290000
         BZ    STRTNOMD           BRANCH IF NOT SPECIFIED               03300000
         MVC   IWEXKMDE,0(R1)     COPY REQUESTED LOGMODE NAME           03310000
STRTNOMD DS    0H                                                       03320000
                                                                        03330000
         ICM   R1,15,SPLDRIVR     DRIVER NAME ADDRESS                   03340000
         BZ    STRTNODR           BRANCH IF NOT SPECIFIED               03350000
         MVC   IWEXKDRV,0(R1)     COPY REQUESTED DRIVER NAME            03360000
STRTNODR DS    0H                                                       03370000
                                                                        03380000
         OC    SPLTOKEN+4(4),SPLTOKEN+4 NO TOKEN OR USER TOKEN ONLY?    03390000
         BZ    STRTNOTK           BRANCH IF NOT ASSOCIATED              03400000
         MVC   IWEXKTOK,SPLTOKEN  COPY ASSOCIATED SESSION TOKEN         03410000
         B     STRTPLU                                                  03420000
                                                                        03430000
STRTNOTK DS    0H                                                       03440000
         OC    SPLEPB,SPLEPB      IS AN EPB PROVIDED?                   03450000
         BZ    STRTPLU            BRANCH IF NOT                         03460000
         ST    RSPLIST,IWEXKSPL   SET SPL ADDRESS                       03470000
         L     R1,TSKPCBC         CURRENT IPCB                          03480000
         MVC   IWEXKENT,PCBENTKN-IPCB(R1) SET ENTITY TOKEN              03490000
                                                                        03500000
STRTPLU  DS    0H                                                       03510000
         TM    SPLF3,SPLF3PLU     IS PLU SESSION REQUESTED?             03520000
         BZ    STRTNPLU           BRANCH IF NOT                         03530000
         OI    IKF1,IKF1PLU       SHOW PLU SESSION REQUESTED            03540000
STRTNPLU DS    0H                                                       03550000
                                                                        03560000
         TM    SPLF3,SPLF3EXC     IS EXCLUSIVE ACB REQUESTED?           03570000
         BZ    STRTNEXC           BRANCH IF NOT                         03580000
         OI    IKF1,IKF1EXC       SHOW EXCLUSIVE ACB REQUESTED          03590000
STRTNEXC DS    0H                                                       03600000
                                                                        03610000
         TM    SPLF3,SPLF3PSS     IS SINGLE CLSDST PASS EXPECTED?       03620000
         BZ    STRTNPSS           BRANCH IF NOT                         03630000
         OI    IKF1,IKF1PSS       SHOW CLSDST PASS EXPECTED             03640000
STRTNPSS DS    0H                                                       03650000
                                                                        03660000
         TM    SPLF4,SPLF4PAR     PARALLEL SESSION SUPPORT?             03670000
         BZ    STRTNPAR           BRANCH IF NOT                         03680000
         OI    IKF1,IKF1PAR       SHOW PARSESS SUPPORT                  03690000
STRTNPAR DS    0H                                                       03700000
                                                                        03710000
         TM    SPLF4,SPLF4MPS     MULTIPLE PASS/SIMLOGON?               03720000
         BZ    STRTNMPS           BRANCH IF NOT                         03730000
         OI    IKF1,IKF1MPS       SHOW MULTI-PASS/SIMLOGON SUPPORT      03740000
STRTNMPS DS    0H                                                       03750000
                                                                        03760000
         TM    SPLF4,SPLF4FSP     FIRST-SPEAKER SESSION REQUESTED?      03770000
         BZ    STRTNFSP           BRANCH IF NOT                         03780000
         OI    IKF1,IKF1FSP       SHOW FIRST-SPEAKER REQUESTED          03790000
STRTNFSP DS    0H                                                       03800000
                                                                        03810000
         L     R1,SPLUNAME        LU PARTNER NAME ADDRESS               03820000
         MVC   IWEXKLU,0(R1)      COPY REQUESTED LU PARTNER NAME        03830000
         MVC   IWEXKPRM,SPLPARM   COPY REQUESTED SESSION PARM           03840000
                                                                        03850000
*                                                                       03860000
* QUEUE THE SESS WORK ELEMENT TO THE MAIN OR IVUSER WORK QUEUE          03870000
*---------------------------------------------------------------------- 03880000
                                                                        03890000
         LA    R1,IVTWEQ          QUEUE ADDRESS                         03900000
         OC    SPLTOKEN,SPLTOKEN  IS A NEW IVUSER NEEDED ALSO?          03910000
         BZ    STRTQWE            BRANCH IF YES                         03920000
                                                                        03930000
         OC    SPLTOKEN+4(4),SPLTOKEN+4 SESSION TO EXISTING USER?       03940000
         BZ    STRTUSRQ           BRANCH IF YES                         03950000
                                                                        03960000
         LA    R1,IVUWEQ          QUEUE IT TO THE IVUSER PROC           03970000
         ST    RSPLIST,ISERQSIR   QUEUE THE ACTIVE SESS INIT REQUEST    03980000
         B     STRTQWE            QUEUE TO ASSOCIATED IVUSER PROC       03990000
                                                                        04000000
STRTUSRQ DS    0H                                                       04010000
                                                                        04020000
         BAS   R14,VTAMLOCK                                             04030000
                                                                        04040000
         $VTAM FINDUSER,                                               +04050000
               AREA=SPLTOKEN,                                          +04060000
               MF=(E,MFE_LIST)    LOCATE THE IVUSER BLOCK               04070000
                                                                        04080000
         LTR   R15,R15            IVUSER FOUND?                         04090000
         BNZ   STRTTERR           BRANCH IF NOT                         04100000
         LR    RIVUSER,R1         WE HAVE THE IVUSER                    04110000
         CLC   IVUID,=CL8'IVUSER' VALIDATE EYECATCHER                   04120000
         BNE   STRTTERR           BRANCH IF INVALID                     04130000
         LA    R1,IVUWEQ          QUEUE TO SPECIFIED IVUSER PROC        04140000
         B     STRTQWE            QUEUE IT                              04150000
                                                                        04160000
STRTQWE  DS    0H                                                       04170000
                                                                        04180000
         BAS   R14,QWE            QUEUE THE WORK ELEMENT                04190000
                                                                        04200000
*                                                                       04210000
* IF THIS IS A SYNCHRONOUS REQUEST, WAIT ON THE XEPB FOR COMPLETION     04220000
*---------------------------------------------------------------------- 04230000
                                                                        04240000
         LTR   R4,R4              SHOULD WE WAIT ON AN XEPB?            04250000
         BZ    RETURN             BRANCH IF NOT                         04260000
                                                                        04270000
         $TASK WAIT,              WAIT FOR SESS INIT TO BE PROCESSED   +04280000
               EPB=(R4),          XEPB ADDRESS                         +04290000
               MF=(E,$TASKMFL)                                          04300000
                                                                        04310000
         B     RETURN                                                   04320000
                                                                        04330000
*                                                                       04340000
* RELEASE THE WORK ELEMENT AND END THE REQUEST                          04350000
*---------------------------------------------------------------------- 04360000
                                                                        04370000
STRTTERR DS    0H                                                       04380000
                                                                        04390000
         $VTAMFWE (RIWE)                                                04400000
                                                                        04410000
         B     ERRTOKEN                                                 04420000
                                                                        04430000
*---------------------------------------------------------------------- 04440000
* REQUEST - $SESS_EXTRACT                                               04450000
*                                                                       04460000
* ENTRY  VALUES: R01 = ADDRESS OF $SESS SERVICES PARAMETER LIST         04470000
*                SPLFUNC  = $SESS_EXTRACT                               04480000
*                SPLTOKEN = SESSION TOKEN                               04490000
*                SPLFLDS# = COUNT OF FIELDS TO EXTRACT                  04500000
*                SPLFLDS  = A 4-WORD ENTRY FOR EACH FIELD REQUESTED     04510000
*                           +0(4) --> ID OF FIELD                       04520000
*                           +4(4) --> ADDRESS OF RECEIVING AREA         04530000
*                           +8(4) --> ADDRESS OF FULLWORD TO RECEIVE    04540000
*                                     ACTUAL FIELD LENGTH               04550000
*                          +12(4) --> LENGTH OF RECEIVING AREA          04560000
*                                                                       04570000
* RETURN VALUES: R15 = $SESS_RC_...                                     04580000
*                R00 = $SESS_RSN_...                                    04590000
*                R01 = SPLIST ADDRESS                                   04600000
*                                                                       04610000
*---------------------------------------------------------------------- 04620000
                                                                        04630000
EXTRACT  DS    0H                 22 = EXTRACT                          04640000
                                                                        04650000
         L     R4,SPLFLDS#        # OF FIELDS TO EXTRACT                04660000
         LA    R3,SPLFLDS         ADDRESS OF FIRST FIELD ENTRY          04670000
         B     EXTNEXT            GO START THE FIRST FIELD              04680000
                                                                        04690000
*                                                                       04700000
* SELECT NEXT ENTRY IN THE LIST OF FIELDS TO EXTRACT                    04710000
*---------------------------------------------------------------------- 04720000
                                                                        04730000
EXTLOOP  DS    0H                                                       04740000
                                                                        04750000
         LA    R3,16(,R3)         ADDRESS OF NEXT FIELD ENTRY           04760000
         BCT   R4,EXTNEXT         GO PROCESS THE NEXT ENTRY             04770000
         B     RETURN             EXIT WHEN ALL PROCESSED               04780000
                                                                        04790000
*                                                                       04800000
* LOAD RECEIVING FIELD ADDRESS/LENGTH & JUMP OUT TO FIELD-SPECIFIC CODE 04810000
*---------------------------------------------------------------------- 04820000
                                                                        04830000
EXTNEXT  DS    0H                                                       04840000
                                                                        04850000
         L     R0,4(,R3)          ADDRESS OF RECEIVING AREA             04860000
         L     R1,12(,R3)         LENGTH OF RECEIVING AREA              04870000
         L     R2,0(,R3)          ID OF NEXT FIELD TO EXTRACT           04880000
         LTR   R2,R2              TEST VALUE                            04890000
         BM    ERRFIELD           BRANCH IF NEGATIVE                    04900000
         SLL   R2,2               MULTIPLY BY 4                         04910000
                                                                        04920000
         STM   R0,R4,SUB0SAVE     SAVE REGS BEFORE ROUTINE CALL         04930000
                                                                        04940000
         C     R2,=A(EXTMAXFL)    IS FIELD ID VALID?                    04950000
         BNH   EXTTABLE(R2)       BRANCH TO ROUTINE IF VALID            04960000
         B     ERRFIELD           EXIT TO CALLER                        04970000
                                                                        04980000
EXTTABLE B     EXTUDATA           0  = USERDATA                         04990000
         B     EXTLUTYP           1  = LUTYPE                           05000000
         B     EXTBFSIZ           2  = BUFFSIZE                         05010000
         B     EXTPSCSZ           3  = PRISCRSZ                         05020000
         B     EXTASCSZ           4  = ALTSCRSZ                         05030000
         B     EXTSNAST           5  = SNASTATE                         05040000
         B     EXTVEC0D           6  = VECTOR0D                         05050000
         B     EXTVEC0E           7  = VECTOR0E                         05060000
         B     EXTVEC15           8  = VECTOR15                         05070000
         B     EXTVEC16           9  = VECTOR16                         05080000
         B     EXTVEC27          10  = VECTOR27                         05090000
         B     EXTVEC2B          11  = VECTOR2B                         05100000
         B     EXTVEC2C          12  = VECTOR2C                         05110000
         B     EXTVEC2D          13  = VECTOR2D                         05120000
         B     EXTVEC2F          14  = VECTOR2F                         05130000
         B     EXTVEC60          15  = VECTOR60                         05140000
         B     EXTPARM           16  = PARM                             05150000
         B     EXTPLUNM          17  = PLUNAME                          05160000
         B     EXTSLUNM          18  = SLUNAME                          05170000
         B     EXTLOGMD          19  = LOGMODE                          05180000
         B     EXTQUERY          20  = QUERY                            05190000
         B     EXTQRPA6          21  = QREPLYA6                         05200000
         B     EXTRUS            21  = RUS                              05210000
EXTMAXFL EQU   (*-EXTTABLE)-4                                           05220000
                                                                        05230000
*                                                                       05240000
* FIELD-SPECIFIC CODE RETURNS HERE TO SET "ACTUAL LENGTH" FOR USER      05250000
*---------------------------------------------------------------------- 05260000
                                                                        05270000
EXTACTLN DS    0H                                                       05280000
                                                                        05290000
         LM    R0,R4,SUB0SAVE     RESTORE REGS AFTER ROUTINE CALL       05300000
                                                                        05310000
         ICM   R2,15,8(R3)        AREA TO RECEIVE ACTUAL LENGTH         05320000
         BZ    EXTCOPY            BRANCH IF NO "ACTUAL LENGTH" AREA     05330000
         ST    R15,0(,R2)         SET THE ACTUAL LENGTH                 05340000
                                                                        05350000
*                                                                       05360000
* MOVE DATA TO USER AREA                                                05370000
*---------------------------------------------------------------------- 05380000
                                                                        05390000
EXTCOPY  DS    0H                                                       05400000
                                                                        05410000
         CR    R1,R15             IS RECEIVING FIELD LARGE ENOUGH?      05420000
         BL    RETURN12           BRANCH IF NOT, RC=12                  05430000
         MVCL  R0,R14             COPY FIELD TO USER AREA               05440000
         B     EXTLOOP            AND GO DO THE NEXT FIELD              05450000
                                                                        05460000
*                                                                       05470000
* 0 = USERDATA                                                          05480000
*---------------------------------------------------------------------- 05490000
                                                                        05500000
EXTUDATA DS    0H                                                       05510000
                                                                        05520000
         L     R14,ISEUDAT@       USER DATA FIELD ADDRESS               05530000
         L     R15,ISEUDATL       USER DATA LENGTH                      05540000
         B     EXTACTLN           SET ACTUAL LENGTH AND COPY IT         05550000
                                                                        05560000
*                                                                       05570000
* 1 = LUTYPE                                                            05580000
*---------------------------------------------------------------------- 05590000
                                                                        05600000
EXTLUTYP DS    0H                                                       05610000
                                                                        05620000
         LA    R14,BINLUP         ADDRESS OF "LUTYPE" FIELD             05630000
         LA    R15,1              JUST ONE BYTE                         05640000
         B     EXTACTLN           SET ACTUAL LENGTH AND COPY IT         05650000
                                                                        05660000
*                                                                       05670000
* 2 = BUFFSIZE                                                          05680000
*---------------------------------------------------------------------- 05690000
                                                                        05700000
EXTBFSIZ DS    0H                                                       05710000
                                                                        05720000
         LA    R14,ISEASIZE       ADDRESS OF ALT BUFFER SIZE            05730000
         LA    R15,L'ISEASIZE     LENGTH OF THE FIELD                   05740000
         CLC   ISEDSIZE,0(R14)    IS THE ALTERNATE THE LARGEST?         05750000
         BNH   EXTACTLN           BRANCH IF YES                         05760000
         LA    R14,ISEDSIZE       POINT AT THE DEF BUFFER SIZE          05770000
         B     EXTACTLN           SET ACTUAL LENGTH AND COPY IT         05780000
                                                                        05790000
*                                                                       05800000
* 3 = PRISCRSZ                                                          05810000
*---------------------------------------------------------------------- 05820000
                                                                        05830000
EXTPSCSZ DS    0H                                                       05840000
                                                                        05850000
         LA    R14,ISEDROW        ADDRESS OF DEFAULT ROWS/COLUMNS       05860000
         LA    R15,L'ISEDROW+L'ISEDCOL                                  05870000
         B     EXTACTLN           SET ACTUAL LENGTH AND COPY IT         05880000
                                                                        05890000
*                                                                       05900000
* 4 = ALTSCRSZ                                                          05910000
*---------------------------------------------------------------------- 05920000
                                                                        05930000
EXTASCSZ DS    0H                                                       05940000
                                                                        05950000
         LA    R14,ISEAROW        ADDRESS OF ALTERNATE ROWS/COLUMNS     05960000
         LA    R15,L'ISEAROW+L'ISEACOL                                  05970000
         B     EXTACTLN           SET ACTUAL LENGTH AND COPY IT         05980000
                                                                        05990000
*                                                                       06000000
* 5 = SNASTATE                                                          06010000
*---------------------------------------------------------------------- 06020000
                                                                        06030000
EXTSNAST DS    0H                                                       06040000
                                                                        06050000
         LA    R14,ISESTATE       ADDRESS OF SNA STATE FLAGS            06060000
         LA    R15,L'ISESTATE     LENGTH OF SNA STATE FLAGS             06070000
         B     EXTACTLN           SET ACTUAL LENGTH AND COPY IT         06080000
                                                                        06090000
*                                                                       06100000
* 6-15 = CONTROL VECTORS                                                06110000
*---------------------------------------------------------------------- 06120000
                                                                        06130000
EXTVEC0D DS    0H                                                       06140000
                                                                        06150000
         MVI   EXTVECID,X'0D'     0D                                    06160000
         B     EXTVECGO           GO SEARCH FOR THE VECTOR              06170000
                                                                        06180000
EXTVEC0E DS    0H                                                       06190000
                                                                        06200000
         MVI   EXTVECID,X'0E'     0E                                    06210000
         B     EXTVECGO           GO SEARCH FOR THE VECTOR              06220000
                                                                        06230000
EXTVEC15 DS    0H                                                       06240000
                                                                        06250000
         MVI   EXTVECID,X'15'     15                                    06260000
         B     EXTVECGO           GO SEARCH FOR THE VECTOR              06270000
                                                                        06280000
EXTVEC16 DS    0H                                                       06290000
                                                                        06300000
         MVI   EXTVECID,X'16'     16                                    06310000
         B     EXTVECGO           GO SEARCH FOR THE VECTOR              06320000
                                                                        06330000
EXTVEC27 DS    0H                                                       06340000
                                                                        06350000
         MVI   EXTVECID,X'27'     27                                    06360000
         B     EXTVECGO           GO SEARCH FOR THE VECTOR              06370000
                                                                        06380000
EXTVEC2B DS    0H                                                       06390000
                                                                        06400000
         MVI   EXTVECID,X'2B'     2B                                    06410000
         B     EXTVECGO           GO SEARCH FOR THE VECTOR              06420000
                                                                        06430000
EXTVEC2C DS    0H                                                       06440000
                                                                        06450000
         MVI   EXTVECID,X'2C'     2C                                    06460000
         B     EXTVECGO           GO SEARCH FOR THE VECTOR              06470000
                                                                        06480000
EXTVEC2D DS    0H                                                       06490000
                                                                        06500000
         MVI   EXTVECID,X'2D'     2D                                    06510000
         B     EXTVECGO           GO SEARCH FOR THE VECTOR              06520000
                                                                        06530000
EXTVEC2F DS    0H                                                       06540000
                                                                        06550000
         MVI   EXTVECID,X'2F'     2F                                    06560000
         B     EXTVECGO           GO SEARCH FOR THE VECTOR              06570000
                                                                        06580000
EXTVEC60 DS    0H                                                       06590000
                                                                        06600000
         MVI   EXTVECID,X'60'     60                                    06610000
         B     EXTVECGO           GO SEARCH FOR THE VECTOR              06620000
                                                                        06630000
EXTVECGO DS    0H                                                       06640000
                                                                        06650000
         SR    R14,R14            NO VECTOR FOUND YET                   06660000
         SR    R15,R15            NO VECTOR LENGTH YET                  06670000
         ICM   R2,15,ISECVEC@     ANY CONTROL VECTORS?                  06680000
         BZ    EXTACTLN           BRANCH IF NOT                         06690000
         ICM   R3,15,ISECVECL     CONTROL VECTORS LENGTH                06700000
         BZ    EXTACTLN           BRANCH IF NO LENGTH                   06710000
                                                                        06720000
EXTVECLK DS    0H                                                       06730000
                                                                        06740000
         CLC   EXTVECID(1),0(R2)  IS THIS THE VECTOR?                   06750000
         BE    EXTVECOK           BRANCH IF YES                         06760000
         SR    R4,R4              CLEAR                                 06770000
         IC    R4,1(,R2)          LENGTH OF VECTOR DATA                 06780000
         LA    R4,2(,R4)          LENGTH OF CONTROL VECTOR              06790000
         LA    R2,0(R4,R2)        ADDRESS OF NEXT CONTROL VECTOR        06800000
         SR    R3,R4              REMAINING LENGTH                      06810000
         BP    EXTVECLK           KEEP LOOKING IF VECTORS REMAIN        06820000
         B     EXTACTLN           GO NULL OUT THE RECEIVING AREA        06830000
                                                                        06840000
EXTVECOK DS    0H                                                       06850000
                                                                        06860000
         LR    R14,R2             VECTOR ADDRESS                        06870000
         IC    R15,1(,R2)         LENGTH OF VECTOR DATA                 06880000
         LA    R15,2(,R15)        LENGTH OF CONTROL VECTOR              06890000
         B     EXTACTLN           SET THE ACTUAL LENGTH AND COPY IT     06900000
                                                                        06910000
*                                                                       06920000
* 16 = PARM                                                             06930000
*---------------------------------------------------------------------- 06940000
                                                                        06950000
EXTPARM  DS    0H                                                       06960000
                                                                        06970000
         LA    R14,ISEPARM        ADDRESS OF PARM WORD                  06980000
         LA    R15,L'ISEPARM      LENGTH OF PARM WORD                   06990000
         B     EXTACTLN           SET ACTUAL LENGTH AND COPY IT         07000000
                                                                        07010000
*                                                                       07020000
* 17 = PLUNAME                                                          07030000
*---------------------------------------------------------------------- 07040000
                                                                        07050000
EXTPLUNM DS    0H                                                       07060000
                                                                        07070000
         LA    R14,ISERLUNM       ADDRESS OF REMOTE LUNAME              07080000
         LA    R15,L'ISERLUNM     LENGTH OF REMOTE LUNAME               07090000
         TM    ISEF2,ISEF2SLU     ARE WE THE SLU END?                   07100000
         BO    EXTACTLN           BRANCH YES, REMOTE LU IS PLU          07110000
         LA    R14,ISEILUNM       INTEGRATOR ACBNAME IS PLU             07120000
         B     EXTACTLN           SET ACTUAL LENGTH AND COPY IT         07130000
                                                                        07140000
*                                                                       07150000
* 18 = SLUNAME                                                          07160000
*---------------------------------------------------------------------- 07170000
                                                                        07180000
EXTSLUNM DS    0H                                                       07190000
                                                                        07200000
         LA    R14,ISERLUNM       ADDRESS OF REMOTE LUNAME              07210000
         LA    R15,L'ISERLUNM     LENGTH OF REMOTE LUNAME               07220000
         TM    ISEF2,ISEF2SLU     ARE WE THE SLU END?                   07230000
         BNO   EXTACTLN           BRANCH NO, REMOTE LU IS SLU           07240000
         LA    R14,ISEILUNM       INTEGRATOR ACBNAME IS SLU             07250000
         B     EXTACTLN           SET ACTUAL LENGTH AND COPY IT         07260000
                                                                        07270000
*                                                                       07280000
* 19 = LOGMODE                                                          07290000
*---------------------------------------------------------------------- 07300000
                                                                        07310000
EXTLOGMD DS    0H                                                       07320000
                                                                        07330000
         LA    R14,ISELOGMD       ADDRESS OF LOGMODE NAME               07340000
         LA    R15,L'ISELOGMD     LENGTH OF LOGMODE NAME                07350000
         B     EXTACTLN           SET ACTUAL LENGTH AND COPY IT         07360000
                                                                        07370000
*                                                                       07380000
* 20 = QUERY                                                            07390000
*---------------------------------------------------------------------- 07400000
                                                                        07410000
EXTQUERY DS    0H                                                       07420000
                                                                        07430000
         BAS   R14,VTAMLOCK                  SERIALIZE                  07440000
                                                                        07450000
         SR    R14,R14                       NO QUERY ADDRESS           07460000
         SR    R15,R15                       NO QUERY LENGTH            07470000
         LA    R1,IVUIS1ST-(ISENEXT-ISE)     NORMALIZED HDR ADDR        07480000
                                                                        07490000
EXTQRUN  DS    0H                                                       07500000
                                                                        07510000
         ICM   R1,15,ISENEXT-ISE(R1)         NEXT ISESS IN THE CHAIN    07520000
         BM    EXTACTLN                      BRANCH IF END OF CHAIN     07530000
         TM    ISEF1-ISE(R1),ISEF1LGN        LOGON SESSION?             07540000
         BNO   EXTQRUN                       BRANCH IF NOT              07550000
         TM    ISEF2-ISE(R1),ISEF2SLU        IS INTEGRATOR THE SLU?     07560000
         BO    EXTACTLN                      BRANCH IF YES              07570000
         ICM   R15,15,ISEQRPL-ISE(R1)        QUERY DATA LENGTH          07580000
         BZ    EXTACTLN                      BRANCH IF NONE             07590000
         L     R14,ISEQRP-ISE(,R1)           QUERY DATA ADDRESS         07600000
         B     EXTACTLN                      SET ACTUAL LENGTH & COPY   07610000
                                                                        07620000
*                                                                       07630000
* 21 = QUERY REPLIES                                                    07640000
*---------------------------------------------------------------------- 07650000
                                                                        07660000
EXTQRPA6 DS    0H                                                       07670000
                                                                        07680000
         MVI   EXTQRPID,X'A6'     A6                                    07690000
         B     EXTQRPGO           GO SEARCH FOR THE QUERY REPLY         07700000
                                                                        07710000
EXTQRPGO DS    0H                                                       07720000
                                                                        07730000
         SR    R14,R14            NO VECTOR FOUND YET                   07740000
         SR    R15,R15            NO VECTOR LENGTH YET                  07750000
         ICM   R2,15,SPLAREA      IS THERE A QUERY BUFFER?              07760000
         BZ    EXTACTLN           BRANCH IF NOT                         07770000
         ICM   R3,15,SPLAREAL     IS THERE A QUERY BUFFER LENGTH?       07780000
         BZ    EXTACTLN           BRANCH IF NO LENGTH                   07790000
         LA    R2,1(,R2)          ADDRESS OF FIRST REPLY                07800000
         BCTR  R3,0               REMAINING LENGTH                      07810000
         SR    R1,R1              CLEAR                                 07820000
                                                                        07830000
EXTQRPLK DS    0H                                                       07840000
                                                                        07850000
         LTR   R3,R3              ANY REPLIES LEFT?                     07860000
         BNP   EXTACTLN           BRANCH IF NOT                         07870000
         ICM   R1,3,0(R2)         LENGTH OF NEXT REPLY                  07880000
         BNZ   EXTQRPLO           BRANCH IF EXPLICIT LENGTH             07890000
         LR    R1,R3              USE REMAINING LENGTH                  07900000
                                                                        07910000
EXTQRPLO DS    0H                                                       07920000
                                                                        07930000
         CR    R1,R3              IS THE LENGTH VALID?                  07940000
         BH    EXTACTLN           BRANCH IF NOT, CAN'T FIND IT          07950000
         C     R1,=F'4'           IS THE LENGTH VALID?                  07960000
         BL    EXTACTLN           BRANCH IF NOT, CAN'T FIND IT          07970000
         CLI   2(R2),X'81'        DOES IT LOOK LIKE A QUERY REPLY?      07980000
         BNE   EXTACTLN           BRANCH IF NOT, CAN'T FIND IT          07990000
         CLC   3(1,R2),EXTQRPID   IS THIS THE ONE?                      08000000
         BE    EXTQRPOK           BRANCH IF YES                         08010000
         LA    R2,0(R1,R2)        ADDRESS OF NEXT REPLY FIELD           08020000
         SR    R3,R1              REMAINING LENGTH                      08030000
         B     EXTQRPLK           KEEP SEARCHING                        08040000
                                                                        08050000
EXTQRPOK DS    0H                                                       08060000
                                                                        08070000
         LR    R14,R2             QUERY REPLY ADDRESS                   08080000
         LR    R15,R1             QUERY REPLY LENGTH                    08090000
         B     EXTACTLN           SET THE ACTUAL LENGTH AND COPY IT     08100000
                                                                        08110000
*                                                                       08120000
* 22 = RUS                                                              08130000
*---------------------------------------------------------------------- 08140000
                                                                        08150000
EXTRUS   DS    0H                                                       08160000
                                                                        08170000
         LA    R14,WRK256                      TEMPORARY AREA           08180000
         LA    R15,L'ISERU+L'ISERRU            SIZE OF RU SUPPORT FLDS  08190000
         MVC   WRK256(L'ISERU),ISERU           RUS THAT CAN BE SENT     08200000
         MVC   WRK256+L'ISERU(L'ISERRU),ISERRU RUS THAT CAN BE RECEIVED 08210000
         B     EXTACTLN                        SET LENGTH & COPY        08220000
                                                                        08230000
*---------------------------------------------------------------------- 08240000
*   SET RETURN CODE OF 8: FUNCTION ERROR W/REASON CODE OF INVALID TOKEN 08250000
*---------------------------------------------------------------------- 08260000
                                                                        08270000
ERRTOKEN DS    0H                                                       08280000
                                                                        08290000
         MVC   SPLRSNCD,=A($SESS_RSN_TOKEN)                             08300000
         B     RETURN8                                                  08310000
                                                                        08320000
*---------------------------------------------------------------------- 08330000
*   SET RETURN CODE OF 4: FUNCTION ERROR W/REASON CODE OF MISSING PARM  08340000
*---------------------------------------------------------------------- 08350000
                                                                        08360000
ERRNOPRM DS    0H                                                       08370000
                                                                        08380000
         MVC   SPLRSNCD,=A($SESS_RSN_MISSING_PARM)                      08390000
         B     RETURN4                                                  08400000
                                                                        08410000
*---------------------------------------------------------------------- 08420000
*   SET RETURN CODE OF 4: FUNCTION ERROR W/REASON CODE OF FIELD ID      08430000
*---------------------------------------------------------------------- 08440000
                                                                        08450000
ERRFIELD DS    0H                                                       08460000
                                                                        08470000
         MVC   SPLRSNCD,=A($SESS_RSN_FIELD_ERROR)                       08480000
         B     RETURN4                                                  08490000
                                                                        08500000
*---------------------------------------------------------------------- 08510000
*   SET RETURN CODE OF 16: BUSY                                         08520000
*---------------------------------------------------------------------- 08530000
                                                                        08540000
RETURN16 DS    0H                                                       08550000
                                                                        08560000
         MVC   SPLRETCD,=A($SESS_RC_BUSY)                               08570000
         B     RETURN                                                   08580000
                                                                        08590000
*---------------------------------------------------------------------- 08600000
*   SET RETURN CODE OF 12: RECEIVING FIELD TOO SMALL                    08610000
*---------------------------------------------------------------------- 08620000
                                                                        08630000
RETURN12 DS    0H                                                       08640000
                                                                        08650000
         MVC   SPLRETCD,=A($SESS_RC_LENGTH)                             08660000
         B     RETURN                                                   08670000
                                                                        08680000
*---------------------------------------------------------------------- 08690000
*   SET RETURN CODE OF 8: ENVIRONMENT ERROR                             08700000
*---------------------------------------------------------------------- 08710000
                                                                        08720000
RETURN8  DS    0H                                                       08730000
                                                                        08740000
         MVC   SPLRETCD,=A($SESS_RC_ENVIRONMENT)                        08750000
         B     RETURN                                                   08760000
                                                                        08770000
*---------------------------------------------------------------------- 08780000
*   SET RETURN CODE OF 4: FUNCTION CODE ERROR                           08790000
*---------------------------------------------------------------------- 08800000
                                                                        08810000
RETURN4  DS    0H                                                       08820000
                                                                        08830000
         MVC   SPLRETCD,=A($SESS_RC_FUNCTION)                           08840000
         B     RETURN                                                   08850000
                                                                        08860000
*---------------------------------------------------------------------- 08870000
*   R E T U R N   T O   C A L L E R                                     08880000
*---------------------------------------------------------------------- 08890000
                                                                        08900000
RETURN   DS    0H                                                       08910000
                                                                        08920000
         BAS   R14,VTAMUNLK         RELEASE THE LOCK IF WE GOT IT       08930000
                                                                        08940000
         ST    RSPLIST,RETR1        RETURN SPLIST ADDRESS IN R1         08950000
         MVC   RETR15,SPLRETCD      $SESS_RC_...                        08960000
         MVC   RETR0,SPLRSNCD       $SESS_RSN_...                       08970000
         LM    R15,R1,RETREGS       LOAD RETURN REGISTERS               08980000
                                                                        08990000
         #EXIT R1=YES               RETURN W/R15,R0,R1                  09000000
                                                                        09010000
*---------------------------------------------------------------------- 09020000
* SUBROUTINE QWE - QUEUE A WORK ELEMENT TO A GIVEN WORK QUEUE           09030000
*                                                                       09040000
*                  R14 = RETURN ADDRESS                                 09050000
*                  R1  = QUEUE ADDRESS                                  09060000
*                  RIWE= WORK ELEMENT                                   09070000
*---------------------------------------------------------------------- 09080000
                                                                        09090000
QWE      DS    0H                                                       09100000
                                                                        09110000
         STM   R14,R3,SUB0SAVE    SAVE REGISTERS                        09120000
                                                                        09130000
         LR    R3,R1              SAVE QUEUE ADDRESS                    09140000
                                                                        09150000
         $VTAMQ (RIWE),           WORK ELEMENT                         +09160000
               (R3)               QUEUE                                 09170000
                                                                        09180000
         LM    R14,R3,SUB0SAVE    RESTORE REGISTERS                     09190000
         BR    R14                AND RETURN TO CALLER                  09200000
                                                                        09210000
*---------------------------------------------------------------------- 09220000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 09230000
*---------------------------------------------------------------------- 09240000
                                                                        09250000
VTAMLOCK DS    0H                                                       09260000
                                                                        09270000
         STM   R14,R2,SUB1SAVE      SAVE CALLER'S REGISTERS             09280000
         TM    FLAG,FLAGLOCK        WAS THE LOCK ALREADY OBTAINED?      09290000
         BOR   R14                  BRANCH IF YES, DON'T DO IT AGAIN    09300000
                                                                        09310000
         $SER  OBTAIN,                                                 +09320000
               VTAM                                                     09330000
                                                                        09340000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              09350000
         BNE   VTAMLOEX             BRANCH IF NOT                       09360000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         09370000
                                                                        09380000
VTAMLOEX DS    0H                                                       09390000
                                                                        09400000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               09410000
         LM    R14,R2,SUB1SAVE      RESTORE CALLER'S REGISTERS          09420000
         BR    R14                  RETURN                              09430000
                                                                        09440000
*---------------------------------------------------------------------- 09450000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                09460000
*---------------------------------------------------------------------- 09470000
                                                                        09480000
VTAMUNLK DS    0H                                                       09490000
                                                                        09500000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       09510000
         BNOR  R14                  BRANCH IF NOT                       09520000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             09530000
         BOR   R14                  DON'T RELEASE IF IT WAS             09540000
         STM   R14,R2,SUB1SAVE      SAVE CALLER'S REGISTERS             09550000
                                                                        09560000
         $SER  RELEASE,                                                +09570000
               VTAM                                                     09580000
                                                                        09590000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  09600000
         LM    R14,R2,SUB1SAVE      RESTORE CALLER'S REGISTERS          09610000
         BR    R14                  RETURN                              09620000
                                                                        09630000
                                                                        09640000
*---------------------------------------------------------------------- 09650000
*   E R R O R   R O U T I N E S                                         09660000
*---------------------------------------------------------------------- 09670000
                                                                        09680000
ERR$TASK DS    0H                                                       09690000
                                                                        09700000
         $ABEND ABE_VTDIAG,                                            +09710000
               SCOPE=PCB,                                              +09720000
               TITLE='$TASK FAILURE'                                    09730000
                                                                        09740000
*---------------------------------------------------------------------- 09750000
*   C O N S T A N T S   A N D   L I T E R A L S                         09760000
*---------------------------------------------------------------------- 09770000
                                                                        09780000
         LTORG ,                                                        09790000
                                                                        09800000
*---------------------------------------------------------------------- 09810000
*   D S E C T S                                                         09820000
*---------------------------------------------------------------------- 09830000
                                                                        09840000
         PRINT NOGEN                                                    09850000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                09860000
         ISTDBIND ,               VTAM BIND IMAGE                       09870000
         ISTRH ,                  VTAM SNA REQUEST HEADER               09880000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         09890000
         ICVT  ,                  INTEGRATOR CVT                        09900000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   09910000
         ITASK ,                  INTEGRATOR TASK BLOCK                 09920000
         IPCB ,                   INTEGRATOR PROCESS BLOCK              09930000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            09940000
         IACB ,                   INTEGRATOR VTAM ACB+                  09950000
         IRPL ,                   INTEGRATOR VTAM RPL+                  09960000
         INIB ,                   INTEGRATOR VTAM NIB+                  09970000
         ISESS ,                  INTEGRATOR SESSION CONTROL            09980000
         IRQE ,                   INTEGRATOR RECEIVE QUEUE ELEMENT      09990000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENTS         10000000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       10010000
         EVCODES ,                INTEGRATOR EVENT CODES                10020000
         ABCODES ,                INTEGRATOR $ABEND CODES               10030000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     10040000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             10050000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             10060000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             10070000
         IFGEXLST ,               VTAM EXIT LIST                        10080000
         END   ,                                                        10090000

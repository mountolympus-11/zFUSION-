ILU2APSF TITLE 'INTEGRATOR - LU2 SESSION IMAGE WRITE-SF COMMAND'        00010000
                                                                        00020000
**<DOC-ON>************************************************************* 00030000
*                                                                       00040000
* ROUTINE: ILU2APSF - INTEGRATOR SESSION IMAGE WRITE-SF COMMAND         00050000
*                                                                       00060000
* DESCRIPTION: THIS ROUTINE IS CALLED TO PROCESS A 3270 WRITE-SF        00070000
*              COMMAND SENT BY THE HOST APPLICATION.                    00080000
*              IT IS CALLED BY ILU2APWR WHEN A WRITE-SF IS              00090000
*              ENCOUNTERED.                                             00100000
*                                                                       00110000
* ON ENTRY:                                                             00120000
*                                                                       00130000
*    R15 = ENTRY POINT ADDRESS                                          00140000
*    R14 = RETURN      ADDRESS                                          00150000
*    R13 = SAVE AREA   ADDRESS                                          00160000
*    R11 = ICVT        ADDRESS                                          00170000
*    R10 = ITASK       ADDRESS                                          00180000
*    R01 = SLUHANDL    ADDRESS                                          00190000
*    R00 = SPLIST      ADDRESS                                          00200000
*                                                                       00210000
* ON EXIT:                                                              00220000
*                                                                       00230000
*    R15 = GENERAL RETURN CODE                                          00240000
*        = 0 --> INPUT SUCCESSFULLY PROCESSED, SEND POSITIVE RESPONSE   00250000
*                R00 = 0                                                00260000
*                R01 = 0                                                00270000
*        = 4 --> INPUT WAS IN ERROR, SEND NEGATIVE RESPONSE             00280000
*                R00 = SENSE DATA                                       00290000
*                R01 = 0                                                00300000
*        = 8 --> TRANSMISSION OF READ DATA FAILED                       00310000
*                R00 = $SESS SPLRETCD FOR FAILING SEND                  00320000
*                R01 = $SESS SPLRSNCD FOR FAILING SEND                  00330000
*                                                                       00340000
*    ALL OTHER REGISTERS ARE RESTORED.                                  00350000
*                                                                       00360000
**<DOC-OFF>************************************************************ 00370000
                                                                        00380000
*********************************************************************** 00390000
*                                                                       00400000
* MAINTENANCE:                                                          00410000
*                                                                       00420000
*   10/01/93 RANDY WITEK                                                00430000
*                                                                       00440000
*********************************************************************** 00450000
                                                                        00460000
         EQUS  ,                  GENERAL EQUATES                       00470000
                                                                        00480000
RICVT    EQU   R11                                                      00490000
RITASK   EQU   R10                                                      00500000
RIVTAM   EQU   R9                                                       00510000
RSESSIMG EQU   R8                                                       00520000
RSPLIST  EQU   R7                                                       00530000
RDATA    EQU   R6                                                       00540000
RDATALEN EQU   R5                                                       00550000
RFIELD   EQU   R4                                                       00560000
RFIELDLN EQU   R3                                                       00570000
                                                                        00580000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00590000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00600000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00610000
         USING SESSIMAG,RSESSIMG  ESTABLISH ADDRESSABILITY              00620000
         USING SPLIST,RSPLIST     ESTABLISH ADDRESSABILITY              00630000
                                                                        00640000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00650000
WRK256   DS    XL256              GENERAL WORKAREA                      00660000
SAVESLUH DS    A                  SLUHANDL ADDRESS                      00670000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00680000
                                                                        00690000
RETR15   DS    F                                                        00700000
RETR0    DS    F                                                        00710000
RETR1    DS    F                                                        00720000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00730000
                                                                        00740000
APRQSLUH DS    A                  SLUHANDL ADDRESS                      00750000
APRQDATA DS    A                  QUERY ADDRESS                         00760000
APRQLENG DS    F                  QUERY LENGTH                          00770000
APRQLIST EQU   APRQSLUH,*-APRQSLUH                                      00780000
                                                                        00790000
APUPSIMG DS    A                  SESSIMAG ADDRESS                      00800000
APUPDATA DS    A                  DATA ADDRESS                          00810000
APUPLENG DS    F                  DATA LENGTH                           00820000
APUPLIST EQU   APUPSIMG,*-APUPSIMG                                      00830000
                                                                        00840000
FLAGS    DS    B                  FLAGS                                 00850000
FLNONPRI EQU   X'01'              CURRENT DESTINATION IS NON-PRIMARY    00860000
FLREAD   EQU   X'02'              READ COMMAND PROCESSED                00870000
                                                                        00880000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00890000
                                                                        00900000
         $MSGDFT PREFIX=ICTPID,                                        +00910000
               COMPID='LU2',                                           +00920000
               TABLE=*#MSGS,                                           +00930000
               WORKA=0,                                                +00940000
               MF=(E,WRK256),                                          +00950000
               PRINT=NOGEN                                              00960000
                                                                        00970000
ILU2APSF #ENTER BASE=R12,                                              +00980000
               PREG=(R2,RSPLIST),       R1->R2       R0->RSPLIST       +00990000
               AMODE=31,                                               +01000000
               RMODE=ANY                                                01010000
                                                                        01020000
*---------------------------------------------------------------------- 01030000
* INITIALIZE                                                            01040000
*---------------------------------------------------------------------- 01050000
                                                                        01060000
X        USING SLUHANDL,R2                                              01070000
                                                                        01080000
         ST    R2,SAVESLUH         SAVE THE ADDRESS FOR LATER           01090000
         L     RSESSIMG,X.SLHSIMAG SESSIMAG ADDRESS                     01100000
         L     RDATA,SPLAREA       DATASTREAM ADDRESS                   01110000
         L     RDATALEN,SPLAREAL   DATASTREAM LENGTH                    01120000
         LA    RDATA,1(,RDATA)     SKIP WSF COMMAND BYTE                01130000
         BCTR  RDATALEN,0          SKIP WSF COMMAND BYTE                01140000
         B     STARTSF             JUMP TO PROCESS 1ST SF               01150000
                                                                        01160000
         DROP  X                                                        01170000
                                                                        01180000
*---------------------------------------------------------------------- 01190000
* LOCATE AND PROCESS NEXT STRUCTURED FIELD IN THE DATASTREAM            01200000
*---------------------------------------------------------------------- 01210000
                                                                        01220000
NEXTSF   DS    0H                                                       01230000
                                                                        01240000
         SR    RFIELDLN,RFIELDLN   CLEAR                                01250000
         ICM   RFIELDLN,3,0(RDATA) LENGTH OF LAST SF                    01260000
         BZ    RETURN              ZERO LENGTH MUST BE LAST SF          01270000
         SR    RDATALEN,RFIELDLN   REMAINING DATASTREAM LENGTH          01280000
         BZ    RETURN              BRANCH IF DATASTREAM EXHAUSTED       01290000
         AR    RDATA,RFIELDLN      ADDRESS OF NEXT SF                   01300000
                                                                        01310000
STARTSF  DS    0H                                                       01320000
                                                                        01330000
         C     RDATALEN,=F'4'      AT LEAST 4 BYTES?                    01340000
         BL    ERR1003             BRANCH IF NOT                        01350000
         SR    RFIELDLN,RFIELDLN   CLEAR                                01360000
         ICM   RFIELDLN,3,0(RDATA) LENGTH OF CURRENT SF                 01370000
         BNZ   GOTLENG             BRANCH IF LENGTH SPECIFIED           01380000
         LR    RFIELDLN,RDATALEN   MUST BE LAST SF IN DATASTREAM        01390000
                                                                        01400000
GOTLENG  DS    0H                                                       01410000
                                                                        01420000
         CR    RDATALEN,RFIELDLN   DOES THE SF LENGTH LOOK GOOD?        01430000
         BL    ERR1003             BRANCH IF NOT                        01440000
         LR    RFIELD,RDATA        ADDRESS OF CURRENT SF                01450000
         C     RFIELDLN,=F'4'      AT LEAST 4 BYTES LONG?               01460000
         BL    ERR1003             BRANCH IF NOT                        01470000
         SLR   R2,R2               CLEAR                                01480000
         L     R15,IVTXSFID        SF ID TABLE                          01490000
         TRT   2(1,RFIELD),0(R15)  IDENTIFY SF TYPE                     01500000
         SLL   R2,2                VALUE X 4                            01510000
         B     SFBRANCH(R2)        BRANCH TO SF ROUTINE                 01520000
                                                                        01530000
SFBRANCH DS    0F                                                       01540000
         B     NEXTSF              00 = IGNORE                          01550000
         B     ERR1003             01 = UNSUPPORTED (REJECT)            01560000
         B     TYPE0F              02 = X'0FXX' (MUST DECODE SUBTYPE)   01570000
         B     READPART            03 = X'01' READ PARITITION           01580000
         B     ERASRSET            04 = X'03' ERASE/RESET               01590000
         B     OUT3270             05 = X'40' 3270 WRITE DATA           01600000
                                                                        01610000
*---------------------------------------------------------------------- 01620000
* 02 = MULITPLE SUBTYPE STRUCTURED FIELDS (SFID = X'0FXX')              01630000
*---------------------------------------------------------------------- 01640000
                                                                        01650000
TYPE0F   DS    0H                                                       01660000
                                                                        01670000
         C     RFIELDLN,=F'4'        AT LEAST 4 BYTES?                  01680000
         BL    ERR1003               BRANCH IF NOT                      01690000
         CLI   3(RFIELD),X'0A'       MODIFY PARTITION?                  01700000
         BE    ERR1003               BRANCH IF YES                      01710000
         CLI   3(RFIELD),X'02'       DESTINATION/ORIGIN?                01720000
         BNE   NEXTSF                BRANCH IF NOT                      01730000
         C     RFIELDLN,=F'8'        AT LEAST 8 BYTES?                  01740000
         BL    ERR1003               BRANCH IF NOT                      01750000
         OI    FLAGS,FLNONPRI        SHOW NON-PRIMARY DESTINATION       01760000
         CLC   6(2,RFIELD),=X'0000'  PRIMARY DESTINATION?               01770000
         BNE   NEXTSF                BRANCH IF NOT                      01780000
         NI    FLAGS,255-FLNONPRI    SHOW PRIMARY DESTINATION           01790000
         B     NEXTSF                GO GET THE NEXT STRUCTURED FIELD   01800000
                                                                        01810000
*---------------------------------------------------------------------- 01820000
* 03 = READ PARTITION (SFID = X'01')                                    01830000
*---------------------------------------------------------------------- 01840000
                                                                        01850000
READPART DS    0H                                                       01860000
                                                                        01870000
         TM    FLAGS,FLNONPRI      NON-PRIMARY DESTINATION?             01880000
         BO    NEXTSF              BRANCH IF YES                        01890000
         CR    RFIELDLN,RDATALEN   READ MUST BE LAST SF                 01900000
         BNE   ERR1003             BRANCH IF NOT                        01910000
         C     RFIELDLN,=F'5'      AT LEAST 5 BYTES?                    01920000
         BL    ERR1003             BRANCH IF NOT                        01930000
         CLI   4(RFIELD),X'02'     QUERY?                               01940000
         BE    RPQUERY             BRANCH IF YES                        01950000
         CLI   4(RFIELD),X'03'     QUERY LIST?                          01960000
         BE    RPQUERYL            BRANCH IF YES                        01970000
         CLI   3(RFIELD),X'00'     PID 0?                               01980000
         BNE   ERR1005             BRANCH IF NOT                        01990000
         C     RFIELDLN,=F'5'      EXACTLY 5 BYTES?                     02000000
         BNE   ERR1003             BRANCH IF NOT                        02010000
         SLR   R2,R2               CLEAR                                02020000
         L     R15,IVTXCOMM        COMMANDS TRANSLATE                   02030000
         TRT   4(1,RFIELD),0(R15)  IDENTIFY COMMAND                     02040000
         SLL   R2,2                XLATED VALUE TIMES FOUR              02050000
         B     RDBRANCH(R2)        BRANCH BASED ON SF READ CMD          02060000
                                                                        02070000
RDBRANCH DS    0F                                                       02080000
         B     ERR1003             00 = BAD COMMAND BYTE                02090000
         B     RPRMA               01 = RMA (6E)                        02100000
         B     ERR1003             02 = EAU (6F)                        02110000
         B     ERR1003             03 = EWA (7E)                        02120000
         B     ERR1003             04 = W   (F1)                        02130000
         B     RPRB                05 = RB  (F2)                        02140000
         B     ERR1003             06 = WSF (F3)                        02150000
         B     ERR1003             07 = EW  (F5)                        02160000
         B     RPRM                08 = RM  (F6)                        02170000
                                                                        02180000
*                                                                       02190000
* QUERY                                                                 02200000
*---------------------------------------------------------------------- 02210000
                                                                        02220000
RPQUERY  DS    0H                                                       02230000
                                                                        02240000
         C     RFIELDLN,=F'5'        EXACTLY 5 BYTES?                   02250000
         BNE   ERR1003               BRANCH IF NOT                      02260000
         CLI   3(RFIELD),X'FF'       PID = FF?                          02270000
         BNE   ERR1003               BRANCH IF NOT                      02280000
                                                                        02290000
         BAS   R14,SENDPRSP          RESPOND TO THE READ COMMAND, ETC.  02300000
                                                                        02310000
         MVC   APRQSLUH(4),SAVESLUH  SLUHANDL ADDRESS                   02320000
         ST    RFIELD,APRQDATA       QUERY ADDRESS                      02330000
         ST    RFIELDLN,APRQLENG     QUERY LENGTH                       02340000
         LA    R1,APRQLIST           PASS PARM LIST ADDRESS IN R1       02350000
         L     R15,ILU@APRQ          SERVICE ROUTINE ENTRY              02360000
         BASR  R14,R15               SEND QUERY RESPONSE                02370000
         OI    FLAGS,FLREAD          SHOW READ PROCESSED                02380000
         B     NEXTSF                GET NEXT STRUCTURED FIELD          02390000
                                                                        02400000
*                                                                       02410000
* QUERY LIST                                                            02420000
*---------------------------------------------------------------------- 02430000
                                                                        02440000
RPQUERYL DS    0H                                                       02450000
                                                                        02460000
         C     RFIELDLN,=F'6'        AT LEAST 6 BYTES?                  02470000
         BL    ERR1003               BRANCH IF NOT                      02480000
         TM    5(RFIELD),X'3F'       RESERVED BITS ON?                  02490000
         BNZ   ERR1003               BRANCH IF YES                      02500000
         TM    5(RFIELD),X'C0'       RESERVED COMBINATION?              02510000
         BO    ERR1003               BRANCH IF YES                      02520000
         CLI   3(RFIELD),X'FF'       PID = FF?                          02530000
         BNE   ERR1003               BRANCH IF NOT                      02540000
                                                                        02550000
         BAS   R14,SENDPRSP          RESPOND TO THE READ COMMAND, ETC.  02560000
                                                                        02570000
         MVC   APRQSLUH(4),SAVESLUH  SLUHANDL ADDRESS                   02580000
         ST    RFIELD,APRQDATA       QUERY ADDRESS                      02590000
         ST    RFIELDLN,APRQLENG     QUERY LENGTH                       02600000
         LA    R1,APRQLIST           PASS PARM LIST ADDRESS IN R1       02610000
         L     R15,ILU@APRQ          SERVICE ROUTINE ENTRY              02620000
         BASR  R14,R15               SEND QUERY RESPONSE                02630000
         STM   R15,R1,RETREGS        SAVE RETURN CODES                  02640000
         OI    FLAGS,FLREAD          SHOW READ PROCESSED                02650000
         B     NEXTSF                GET NEXT STRUCTURED FIELD          02660000
                                                                        02670000
*                                                                       02680000
* READ MODIFIED                                                         02690000
*---------------------------------------------------------------------- 02700000
                                                                        02710000
RPRM     DS    0H                                                       02720000
                                                                        02730000
         BAS   R14,SENDPRSP          RESPOND TO THE READ COMMAND, ETC.  02740000
                                                                        02750000
         $SLU2 TO_THE_PLU,                                             +02760000
               SLUHANDL=*SAVESLUH,                                     +02770000
               PLUREAD=YES,                                            +02780000
               READCMD=#3270RM     SEND RM  DATA TO PLU APPLICATION     02790000
                                                                        02800000
         STM   R15,R1,RETREGS      SAVE RETURN CODES                    02810000
         OI    FLAGS,FLREAD        SHOW READ PROCESSED                  02820000
         B     NEXTSF              FINISH THE SF PROCESSING             02830000
                                                                        02840000
*                                                                       02850000
* READ MODIFIED ALL                                                     02860000
*---------------------------------------------------------------------- 02870000
                                                                        02880000
RPRMA    DS    0H                                                       02890000
                                                                        02900000
         BAS   R14,SENDPRSP          RESPOND TO THE READ COMMAND, ETC.  02910000
                                                                        02920000
         $SLU2 TO_THE_PLU,                                             +02930000
               SLUHANDL=*SAVESLUH,                                     +02940000
               PLUREAD=YES,                                            +02950000
               READCMD=#3270RMA    SEND RMA DATA TO PLU APPLICATION     02960000
                                                                        02970000
         STM   R15,R1,RETREGS      SAVE RETURN CODES                    02980000
         OI    FLAGS,FLREAD        SHOW READ PROCESSED                  02990000
         B     NEXTSF              FINISH THE SF PROCESSING             03000000
                                                                        03010000
*                                                                       03020000
* READ BUFFER                                                           03030000
*---------------------------------------------------------------------- 03040000
                                                                        03050000
RPRB     DS    0H                                                       03060000
                                                                        03070000
         BAS   R14,SENDPRSP          RESPOND TO THE READ COMMAND, ETC.  03080000
                                                                        03090000
         $SLU2 TO_THE_PLU,                                             +03100000
               SLUHANDL=*SAVESLUH,                                     +03110000
               PLUREAD=YES,                                            +03120000
               READCMD=#3270RB     SEND RB  DATA TO PLU APPLICATION     03130000
                                                                        03140000
         STM   R15,R1,RETREGS      SAVE RETURN CODES                    03150000
         OI    FLAGS,FLREAD        SHOW READ PROCESSED                  03160000
         B     NEXTSF              FINISH THE SF PROCESSING             03170000
                                                                        03180000
*---------------------------------------------------------------------- 03190000
* 04 = ERASE/RESET (SFID = X'03')                                       03200000
*---------------------------------------------------------------------- 03210000
                                                                        03220000
ERASRSET DS    0H                                                       03230000
                                                                        03240000
         TM    FLAGS,FLNONPRI      NON-PRIMARY DESTINATION?             03250000
         BO    NEXTSF              BRANCH IF YES                        03260000
                                                                        03270000
         OI    SEIONCE,SEIO_INP    IMAGE WAS MODIFIED                   03280000
                                                                        03290000
         CLI   3(RFIELD),X'80'     ALTERNATE SIZE?                      03300000
         BE    ERASRALT            BRANCH IF YES                        03310000
         CLI   3(RFIELD),X'00'     DEFAULT SIZE?                        03320000
         BNE   ERR1003             BRANCH IF NOT                        03330000
                                                                        03340000
         XC    SEISCSR,SEISCSR     CUSROR TO ZERO                       03350000
         MVC   SEIS1ROW,SEIPROWS   PRIMARY   ROWS ARE ACTIVE            03360000
         MVC   SEIS1COL,SEIPCOLS   PRIMARY   COLS ARE ACTIVE            03370000
         L     R1,SEIPRISZ         PRIMARY   IMAGE SIZE                 03380000
         ST    R1,SEIS1SIZ         PRIMARY   SIZE IS ACTIVE             03390000
         L     R0,SEIS1IMG         IMAGE ADDRESS                        03400000
         SR    R15,R15             ZERO PAD AND ZERO FROM-LENGTH        03410000
         MVCL  R0,R14              NULL THE IMAGE                       03420000
         ICM   R2,15,SEIS1FLV      FIELD VECTORS                        03430000
         BZ    NEXTSF              BRANCH IF NO FIELD VECTORS           03440000
         STH   R15,0(,R2)          FIELD COUNT                          03450000
         L     R1,SEIS1SIZ         IMAGE SIZE                           03460000
         STH   R1,2(,R2)           FIELD VECTOR TERMINATOR              03470000
         B     NEXTSF              GO GET THE NEXT STRUCTURED FIELD     03480000
                                                                        03490000
ERASRALT DS    0H                                                       03500000
                                                                        03510000
         XC    SEISCSR,SEISCSR     CUSROR TO ZERO                       03520000
         MVC   SEIS1ROW,SEIAROWS   ALTERNATE ROWS ARE ACTIVE            03530000
         MVC   SEIS1COL,SEIACOLS   ALTERNATE COLS ARE ACTIVE            03540000
         L     R1,SEIALTSZ         ALTERNATE IMAGE SIZE                 03550000
         ST    R1,SEIS1SIZ         ALTERNATE SIZE IS ACTIVE             03560000
         L     R0,SEIS1IMG         IMAGE ADDRESS                        03570000
         SR    R15,R15             ZERO PAD AND ZERO FROM-LENGTH        03580000
         MVCL  R0,R14              NULL THE IMAGE                       03590000
         ICM   R2,15,SEIS1FLV      FIELD VECTORS                        03600000
         BZ    NEXTSF              BRANCH IF NO FIELD VECTORS           03610000
         STH   R15,0(,R2)          FIELD COUNT                          03620000
         L     R1,SEIS1SIZ         IMAGE SIZE                           03630000
         STH   R1,2(,R2)           FIELD VECTOR TERMINATOR              03640000
         B     NEXTSF              GO GET THE NEXT STRUCTURED FIELD     03650000
                                                                        03660000
*---------------------------------------------------------------------- 03670000
* 05 = OUTBOUND 3270 DATA (SFID = X'40')                                03680000
*---------------------------------------------------------------------- 03690000
                                                                        03700000
OUT3270  DS    0H                                                       03710000
                                                                        03720000
         TM    FLAGS,FLNONPRI      NON-PRIMARY DESTINATION?             03730000
         BO    NEXTSF              BRANCH IF YES                        03740000
         C     RFIELDLN,=F'5'      AT LEAST 5 BYTES?                    03750000
         BL    ERR1003             BRANCH IF NOT                        03760000
         CLI   3(RFIELD),X'00'     PID = 00 ?                           03770000
         BNE   ERR1005             BRANCH IF NOT                        03780000
         SLR   R2,R2               CLEAR                                03790000
         L     R15,IVTXCOMM        COMMANDS TRANSLATE                   03800000
         TRT   4(1,RFIELD),0(R15)  IDENTIFY COMMAND                     03810000
         SLL   R2,2                XLATED VALUE TIMES FOUR              03820000
         B     WRBRANCH(R2)        BRANCH BASED ON SF WRITE COMMAND     03830000
                                                                        03840000
WRBRANCH DS    0F                                                       03850000
         B     ERR1003             00 = BAD COMMAND BYTE                03860000
         B     ERR1003             01 = RMA (6E)                        03870000
         B     O3270EAU            02 = EAU (6F)                        03880000
         B     O3270EWA            03 = EWA (7E)                        03890000
         B     O3270W              04 = W   (F1)                        03900000
         B     ERR1003             05 = RB  (F2)                        03910000
         B     ERR1003             06 = WSF (F3)                        03920000
         B     O3270EW             07 = EW  (F5)                        03930000
         B     ERR1003             08 = RM  (F6)                        03940000
                                                                        03950000
*                                                                       03960000
* ERASE ALL UNPROTECTED                                                 03970000
*---------------------------------------------------------------------- 03980000
                                                                        03990000
O3270EAU DS    0H                                                       04000000
                                                                        04010000
         C     RFIELDLN,=F'5'      EXACTLY 5 BYTES?                     04020000
         BNE   ERR1003             BRANCH IF NOT                        04030000
         LR    R1,RSESSIMG         PASS SESSIMAG IN R1                  04040000
         L     R15,ILU@APEU        EAU SERVICE ENTRY                    04050000
         BASR  R14,R15             EXECUTE EAU AGAINST THE IMAGE        04060000
         B     NEXTSF              GO GET THE NEXT STRUCTURED FIELD     04070000
                                                                        04080000
*                                                                       04090000
* ERASE WRITE ALTERNATE                                                 04100000
*---------------------------------------------------------------------- 04110000
                                                                        04120000
O3270EWA DS    0H                                                       04130000
                                                                        04140000
         C     RFIELDLN,=F'6'      AT LEAST 6 BYTES?                    04150000
         BL    NEXTSF              BRANCH IF NOT                        04160000
         XC    SEISCSR,SEISCSR     CUSROR TO ZERO                       04170000
         MVC   SEIS1ROW,SEIAROWS   ALTERNATE ROWS ARE ACTIVE            04180000
         MVC   SEIS1COL,SEIACOLS   ALTERNATE COLS ARE ACTIVE            04190000
         L     R1,SEIALTSZ         ALTERNATE IMAGE SIZE                 04200000
         ST    R1,SEIS1SIZ         ALTERNATE SIZE IS ACTIVE             04210000
         L     R0,SEIS1IMG         IMAGE ADDRESS                        04220000
         SR    R15,R15             ZERO PAD AND ZERO FROM-LENGTH        04230000
         MVCL  R0,R14              NULL THE IMAGE                       04240000
         ICM   R2,15,SEIS1FLV      FIELD VECTORS                        04250000
         BZ    O3270WUP            BRANCH IF NO FIELD VECTORS           04260000
         STH   R15,0(,R2)          FIELD COUNT                          04270000
         L     R1,SEIS1SIZ         IMAGE SIZE                           04280000
         STH   R1,2(,R2)           FIELD VECTOR TERMINATOR              04290000
                                                                        04300000
O3270WUP DS    0H                                                       04310000
                                                                        04320000
         ST    RSESSIMG,APUPSIMG   BUILD APUP PARM LIST                 04330000
         LA    R15,4(,RFIELD)      ADDRESS OF WRITE COMMAND             04340000
         ST    R15,APUPDATA        BUILD APUP PARM LIST                 04350000
         LR    R15,RFIELDLN        LENGTH OF COMPLETE STRUCTURED FLD    04360000
         S     R15,=F'4'           LENGTH OF WRITE DATASTREAM           04370000
         ST    R15,APUPLENG        BUILD APUP PARM LIST                 04380000
         LA    R1,APUPLIST         PASS PARM LIST IN R1                 04390000
         L     R15,ILU@APUP        SERVICE ROUTINE ENTRY                04400000
         BASR  R14,R15             CALL SERVICE ROUTINE                 04410000
         STM   R15,R1,RETREGS      SAVE RETURN VALUES                   04420000
         LTR   R15,R15             TEST THE RETURN CODE                 04430000
         BZ    NEXTSF              BRANCH IF DATASTREAM IS GOOD         04440000
         B     RETURN              END PROCESSING                       04450000
                                                                        04460000
*                                                                       04470000
* WRITE                                                                 04480000
*---------------------------------------------------------------------- 04490000
                                                                        04500000
O3270W   DS    0H                                                       04510000
                                                                        04520000
         C     RFIELDLN,=F'6'      AT LEAST 6 BYTES?                    04530000
         BL    NEXTSF              BRANCH IF NOT                        04540000
         B     O3270WUP            CALL THE IMAGE UPDATE ROUTINE        04550000
                                                                        04560000
*                                                                       04570000
* ERASE WRITE                                                           04580000
*---------------------------------------------------------------------- 04590000
                                                                        04600000
O3270EW  DS    0H                                                       04610000
                                                                        04620000
         C     RFIELDLN,=F'6'      AT LEAST 6 BYTES?                    04630000
         BL    NEXTSF              BRANCH IF NOT                        04640000
         XC    SEISCSR,SEISCSR     CUSROR TO ZERO                       04650000
         MVC   SEIS1ROW,SEIPROWS   PRIMARY   ROWS ARE ACTIVE            04660000
         MVC   SEIS1COL,SEIPCOLS   PRIMARY   COLS ARE ACTIVE            04670000
         L     R1,SEIPRISZ         PRIMARY   IMAGE SIZE                 04680000
         ST    R1,SEIS1SIZ         PRIMARY   SIZE IS ACTIVE             04690000
         L     R0,SEIS1IMG         IMAGE ADDRESS                        04700000
         SR    R15,R15             ZERO PAD AND ZERO FROM-LENGTH        04710000
         MVCL  R0,R14              NULL THE IMAGE                       04720000
         ICM   R2,15,SEIS1FLV      FIELD VECTORS                        04730000
         BZ    O3270WUP            BRANCH IF NO FIELD VECTORS           04740000
         STH   R15,0(,R2)          FIELD COUNT                          04750000
         L     R1,SEIS1SIZ         IMAGE SIZE                           04760000
         STH   R1,2(,R2)           FIELD VECTOR TERMINATOR              04770000
         B     O3270WUP            CALL IMAGE UPDATE ROUTINE            04780000
                                                                        04790000
*---------------------------------------------------------------------- 04800000
* EXCEPTION ROUTINES                                                    04810000
*---------------------------------------------------------------------- 04820000
                                                                        04830000
ERR1005  DS     0H                                                      04840000
                                                                        04850000
         MVC   RETR0(4),=X'10050000'                                    04860000
         B     ERRNRESP                                                 04870000
                                                                        04880000
ERR1003  DS    0H                                                       04890000
                                                                        04900000
         MVC   RETR0(4),=X'10030000'                                    04910000
         B     ERRNRESP                                                 04920000
                                                                        04930000
ERRNRESP DS    0H                                                       04940000
                                                                        04950000
         MVC   RETR15,=F'4'          SEND NEGATIVE RESPONSE             04960000
         B     RETURN                RETURN TO CALLER                   04970000
                                                                        04980000
*---------------------------------------------------------------------- 04990000
* RETURN TO CALLER                                                      05000000
*---------------------------------------------------------------------- 05010000
                                                                        05020000
RETURN   DS    0H                                                       05030000
                                                                        05040000
         TM    FLAGS,FLREAD          DID A READ SURRENDER CD?           05050000
         BO    RETREAD               BRANCH IF YES                      05060000
                                                                        05070000
         CLC   RETR15,=F'4'          INPUT REJECTED?                    05080000
         BNL   RETNOEB               BRANCH IF YES                      05090000
                                                                        05100000
         TM    SPLRH2,RHBBI          WAS BEGIN BRACKET SENT?            05110000
         BNO   RETNOBB               BRANCH IF NOT                      05120000
         NI    SEIFSNA,255-SEIF_CMD  TAKE AWAY DIRECTION                05130000
                                                                        05140000
RETNOBB  DS    0H                                                       05150000
                                                                        05160000
         TM    SPLRH2,RHCDI       DID WE RECEIVE THE DIRECTION?         05170000
         BNO   RETNOCD            BRANCH IF NOT                         05180000
         OI    SEIFSNA,SEIF_CMD   WE HAVE DIRECTION                     05190000
                                                                        05200000
RETNOCD  DS    0H                                                       05210000
                                                                        05220000
         TM    SPLRH2,RHEBI       DID WE RECEIVE END BRACKET?           05230000
         BNO   RETNOEB            BRANCH IF NOT                         05240000
         OI    SEIFSNA,SEIF_CMD   WE HAVE DIRECTION                     05250000
         OI    SEIFSNA,SEIF_KBR   KEYBOARD IS RESTORED                  05260000
                                                                        05270000
RETREAD  DS    0H                                                       05280000
                                                                        05290000
RETNOEB  DS    0H                                                       05300000
                                                                        05310000
                                                                        05320000
         LM    R15,R1,RETREGS     LOAD RETURN VALUES                    05330000
                                                                        05340000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    05350000
                                                                        05360000
*---------------------------------------------------------------------- 05370000
* SUBROUTINE: SENDPRSP                                                  05380000
*---------------------------------------------------------------------- 05390000
                                                                        05400000
X        USING SLUHANDL,R3                                              05410000
                                                                        05420000
SENDPRSP DS     0H                                                      05430000
                                                                        05440000
         STM   R14,R12,SUB0SAVE                                         05450000
         L     R3,SAVESLUH          SLUHANDL ADDRESS                    05460000
                                                                        05470000
         $SESS $SESS_SEND_POSRESP,  SEND A RESPONSE AS NEEDED          +05480000
               SESSION=X.SLHSTKN,                                      +05490000
               RH=*,                                                   +05500000
               SEQNO=*,                                                +05510000
               CNTRL=*,                                                +05520000
               SENSE=*,                                                +05530000
               ERRET=ERR$RESP,                                         +05540000
               MF=(E,(RSPLIST))                                         05550000
                                                                        05560000
SENDPRET DS    0H                                                       05570000
                                                                        05580000
         LM    R14,R12,SUB0SAVE                                         05590000
         BR    R14                                                      05600000
                                                                        05610000
ERR$RESP DS    0H                                                       05620000
                                                                        05630000
         CLC   SPLRETCD,=A($SESS_RC_CANCELED)                           05640000
         BE    SENDPRET                                                 05650000
         B     ABNDRESP                                                 05660000
                                                                        05670000
         DROP  X                                                        05680000
                                                                        05690000
*---------------------------------------------------------------------- 05700000
* ERROR ROUTINES                                                        05710000
*---------------------------------------------------------------------- 05720000
                                                                        05730000
ABNDRESP DS    0H                                                       05740000
                                                                        05750000
         $ABEND ABE_VTDIAG,                                            +05760000
               SCOPE=PCB,                                              +05770000
               TITLE='$SESS SEND RESPONSE FAILURE'                      05780000
                                                                        05790000
*---------------------------------------------------------------------- 05800000
*  CONSTANTS AND LITERALS                                               05810000
*---------------------------------------------------------------------- 05820000
                                                                        05830000
         LTORG ,                                                        05840000
         PRINT NOGEN                                                    05850000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                05860000
         ISTDBIND ,               VTAM BIND IMAGE                       05870000
         ISTRH ,                  VTAM SNA REQUEST HEADER               05880000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         05890000
         SESSIMAG ,               INTEGRATOR LU2 IMAGE BLOCK            05900000
         SLUHANDL ,               INTEGRATOR SLUHANDL BLOCK             05910000
         ICVT  ,                  INTEGRATOR CVT                        05920000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   05930000
         ITASK ,                  INTEGRATOR TASK BLOCK                 05940000
         ISESS ,                  INTEGRATOR ISESS BLOCK                05950000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       05960000
         EVCODES ,                INTEGRATOR EVENT CODES                05970000
         ABCODES ,                INTEGRATOR $ABEND CODES               05980000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     05990000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        06000000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             06010000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             06020000
         END   ,                                                        06030000

IFLDREPB TITLE '- IDENTIFY TRAILING REPEAT GROUP'                       00010000
         EQUS  ,                                                        00020000
                                                                        00030000
WORKAREA DSECT ,                                                        00040000
TRTAB    DS    XL256                                                    00050000
REVERSAL DS    XL256                                                    00060000
                                                                        00070000
         EJECT                                                          00080000
***************************************************************         00090000
*                                                                       00100000
* ROUTINE:  IFLDREPB - IDENTIFY TRAILING REPEAT GROUP                   00110000
*                                                                       00120000
* DESCRIPTION:                                                          00130000
*                                                                       00140000
*    THIS ROUTINE RETURNS THE LENGTH OF A SINGLE BYTE REPEATING         00150000
*    GROUP FOUND AT THE END OF A GIVEN STRING.  IF THE LAST             00160000
*    CHARACTER DOES NOT REPEAT THE RETURNED VALUE IS ONE, UNLESS        00170000
*    THE STRING IS NULL, IN WHICH CASE ZERO IS RETURNED.                00180000
*                                                                       00190000
*                                                                       00200000
* ON ENTRY:                                                             00210000
*                                                                       00220000
*    R1  CONTAINS THE ADDRESS OF A PARAMETER LIST CONSTRUCTED           00230000
*        AS FOLLOWS                                                     00240000
*                                                                       00250000
*           +00 - STRING ORIGIN ADDRESS                                 00260000
*           +04 - STRING LENGTH                                         00270000
*                                                                       00280000
*    R0  CONTAINS THE ADDRESS OF A 512 BYTE WORKAREA                    00290000
*                                                                       00300000
*                                                                       00310000
* ON EXIT:                                                              00320000
*                                                                       00330000
*    R15 CONTAINS THE LENGTH OF SINGLE BYTE REPEATING GROUP.            00340000
*        ZERO IS RETURNED ONLY IF THE PASSED STRING LENGTH              00350000
*        IS ZERO.                                                       00360000
*                                                                       00370000
*    R1  CONTAINS THE ADDRESS OF THE LAST CHARACTER, OR ZERO            00380000
*        IF THE SOURCE STRING IS NULL.                                  00390000
*                                                                       00400000
***************************************************************         00410000
         EJECT                                                          00420000
IFLDREPB #ENTER PREG=R8,SAVE=NO                                         00430000
                                                                        00440000
         USING ICVT,R11           STANDARD ENVIRONMENT                  00450000
         USING ITASK,R10                                                00460000
                                                                        00470000
         EJECT                                                          00480000
***************************************************************         00490000
*                                                                       00500000
*   DETERMINE LENGTH OF REPEATING GROUP                                 00510000
*                                                                       00520000
***************************************************************         00530000
         LM    R2,R3,0(R8)        FETCH STRING ORIGIN AND LENGTH        00540000
         LR    R4,R2              MAINTAIN CURRENT POSITION IN STRING   00550000
         SR    R15,R15            INIT NUMBER OF LEADING ZEROS          00560000
         LTR   R3,R3              NULL STRING?                          00570000
         BZ    BWDFIN             DONE IF SO                            00580000
                                                                        00590000
*--------------------------------------------------------------         00600000
*   BUILD STRING SCAN TRANSLATE TABLE                                   00610000
*--------------------------------------------------------------         00620000
         LR    R7,R0              256 BYTE WORKAREA                     00630000
         USING WORKAREA,R7        FORMAT                                00640000
                                                                        00650000
         MVI   TRTAB,4            INITIALIZE TRANS TAB                  00660000
         MVC   TRTAB+1(L'TRTAB-1),TRTAB                                 00670000
                                                                        00680000
         AR    R4,R3              LOCATE END OF STRING                  00690000
         LR    R6,R4              MODIFIABLE COPY                       00700000
         BCTR  R6,0               LAST BYTE PTR                         00710000
                                                                        00720000
         SR    R5,R5              PREPARE FOR INSERT                    00730000
         IC    R5,0(,R6)          FETCH LEAD BYTE                       00740000
         LA    R5,TRTAB(R5)       OFFSET TO PAD BYTE ENTRY              00750000
         MVI   0(R5),0            GLIDE ON BY                           00760000
                                                                        00770000
         LA    R0,256             CAPACITY                              00780000
                                                                        00790000
*--------------------------------------------------------------         00800000
*   SCAN FOR TRAILING REPEATERS IN REVERSED STRING SEGMENT COPY         00810000
*--------------------------------------------------------------         00820000
BWDNEXT  DS    0H                                                       00830000
         LTR   R5,R3              LENGTH REMAINING                      00840000
         BNP   BWDFIN             DONE IF STRING EXHAUSTED              00850000
         CR    R5,R0              LAST PASS?                            00860000
         BNH   *+6                SKIP IF UNLIKELY                      00870000
         LR    R5,R0              ELSE CONFORM TO CAPCITY               00880000
         SR    R4,R5              BEGINNING OF SEGMENT                  00890000
                                                                        00900000
         LA    R9,BACKTRAN+256    END OF REVERSE ARRAY                  00910000
         SR    R9,R5              CORRESPONDENCE WITH STRING SEGMENT    00920000
         BCTR  R5,0               PREPARE FOR EX                        00930000
                                                                        00940000
         EX    R5,TRCPYREV        COPY REVERSING TABLE                  00950000
         EX    R5,TREVERSE        REVERSE STRING SEGMENT                00960000
         EX    R5,TRSCAN          SEARCH FOR END OF REPEAT              00970000
         BC    HITS,BWDCALC       SCAN ENDS                             00980000
                                                                        00990000
         LA    R5,1(,R5)          TRUE LENGTH OF SEGMENT                01000000
         AR    R15,R5             ACCOUNT FOR SEGMENT SPANNED           01010000
         SR    R3,R0              ADJUST LENGTH ACCORDINGLY             01020000
         B     BWDNEXT            AGAIN                                 01030000
                                                                        01040000
BWDCALC  DS    0H                                                       01050000
         LA    R0,REVERSAL        IMAGE SCAN AREA ORIGIN                01060000
         SR    R1,R0              REPEATERS SCANNED                     01070000
         ALR   R15,R1             ROLL INTO TOTAL                       01080000
                                                                        01090000
*--------------------------------------------------------------         01100000
*   RETURN COUNT TO REQUESTOR                                           01110000
*--------------------------------------------------------------         01120000
BWDFIN   DS    0H                                                       01130000
         LTR   R1,R15             NULL STRING?                          01140000
         BZ    *+6                SKIP IF SO                            01150000
         LR    R1,R6              ELSE RETURN PTR TO LAST CHAR          01160000
                                                                        01170000
         #EXIT ,                  RETURN TO REQUESTOR                   01180000
                                                                        01190000
TRCPYREV MVC   REVERSAL(*-*),0(R9)                                      01200000
TREVERSE TR    REVERSAL(*-*),0(R4)                                      01210000
TRSCAN   TRT   REVERSAL(*-*),TRTAB                                      01220000
                                                                        01230000
         EJECT                                                          01240000
***************************************************************         01250000
*                                                                       01260000
*   LOCAL READ ONLY WORKING STORAGE AREAS                               01270000
*                                                                       01280000
***************************************************************         01290000
BACKTRAN DC    256AL1(FF-(*-BACKTRAN))                                  01300000
                                                                        01310000
         LTORG ,                                                        01320000
                                                                        01330000
         PRINT NOGEN                                                    01340000
         ICVT  ,                                                        01350000
         ITASK ,                                                        01360000
         END   ,                                                        01370000

IXRUMSG  TITLE '- ADD MSG TO RUMSGS STRUCTURE'                          00010000
***************************************************************         00020000
*                                                                       00030000
* ROUTINE:  IXRUMSG - ADD MSG TO RUMSGS STRUCTURE                       00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THIS ROUTINE BACKS THE $RUMSG SERVICE WHICH IS USED TO             00080000
*    ADD A MESSAGE TO A REQUEST-UNIT FORMATTED MESSAGE STRUCTURE        00090000
*    MAPPED BY RUMSGS.  THE RUMSGS IS PASSED VIA PTR-PTR,               00100000
*    ALLOWING THE STRUCTURE TO BE REALLOCATED ($REALLOC PROTOCOL)       00110000
*    IF IT IS NOT LARGE ENOUGH TO CONTAIN THE NEW MESSAGE.              00120000
*    ADDITIONALLY, IF THE INITIAL PTR-PTR IS ZERO, A DEFAULT            00130000
*    RUMSGS STRUCTURE IS CREATED.                                       00140000
*                                                                       00150000
*                                                                       00160000
* ON ENTRY:                                                             00170000
*                                                                       00180000
*    R1  CONTAINS THE ADDRESS OF A PARAMTER LIST CONSTRUCTED            00190000
*        AS FOLLOWS:                                                    00200000
*                                                                       00210000
*           +00 - ADDR OF RUMSGS STRUCTURE PTR                          00220000
*           +04 - MESSAGE ORIGIN                                        00230000
*           +08 - MESSAGE LENGTH                                        00240000
*                                                                       00250000
* ON EXIT:                                                              00260000
*                                                                       00270000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES                     00280000
*                                                                       00290000
*        RC00 - MESSAGE ADDED, RUMSGS POSSIBLY REALLOCATED              00300000
*        RC04 - INVALID MESSAGE LENGTH                                  00310000
*                                                                       00320000
***************************************************************         00330000
         #WORK LENGTH=256                                               00340000
                                                                        00350000
         #ENDWORK                                                       00360000
                                                                        00370000
         EJECT                                                          00380000
         RUMSGS BUFSIZE=512       RU MESSAGE RETURN AREA FORMAT         00390000
                                                                        00400000
         EJECT                                                          00410000
         EQUS  ,                                                        00420000
                                                                        00430000
         EJECT ,                                                        00440000
IXRUMSG  #ENTER PREG=R8,WAPASS=YES                                      00450000
                                                                        00460000
         USING ITASK,R10          PROCESS MODE                          00470000
                                                                        00480000
         EJECT                                                          00490000
*--------------------------------------------------------------         00500000
*   FETCH AND VALIDATE REQUEST PARMS                                    00510000
*--------------------------------------------------------------         00520000
         LM    R5,R7,0(R8)        FETCH PASSED PARAMETERS               00530000
*                                 R6 <== MSG ORIGIN                     00540000
*                                 R7 <== MSG LENGTH                     00550000
         LTR   R7,R7              VALIDATE MSG LENGTH                   00560000
         BNP   ERR_MSG                                                  00570000
         C     R7,=F'512'                                               00580000
         BH    ERR_MSG                                                  00590000
                                                                        00600000
*--------------------------------------------------------------         00610000
*   INITIAL ALLOCATION FOR RU MESSAGE STRUCTURE                         00620000
*--------------------------------------------------------------         00630000
         USING RUMSGS,R4          RUMSGS FORMAT                         00640000
         ICM   R4,15,0(R5)        LOCATE RUMSGS STRUCTURE               00650000
         BNZ   RUM_OK             PREVIOUSLY ALLOCATED                  00660000
                                                                        00670000
         $GETSTOR RUMLN           ACQUIRE DEFAULT BLOCK                 00680000
                                                                        00690000
         LR    R4,R1              LIFE OF FUNCTION ADDRESSABILITY       00700000
         ST    R4,0(,R5)          CHARGE TO REQUESTOR                   00710000
                                                                        00720000
         RUMSGS TYPE=INIT         INITIALIZE THE BLOCK                  00730000
                                                                        00740000
*--------------------------------------------------------------         00750000
*   ENSURE SUFFICENT SPACE REMAINS, REALLOCATE IF REQUIRED              00760000
*--------------------------------------------------------------         00770000
RUM_OK   DS    0H                                                       00780000
         L     R4,0(,R5)          REFRESH RUMSGS STRUCTURE PTR          00790000
         L     R3,RUMSIZE         TOTAL SIZE OF BLOCK                   00800000
         S     R3,RUMUSED         MINUS AMOUNT ALREADY USED             00810000
                                                                        00820000
         LA    R0,2(,R7)          TOTAL LENGTH REQUIRED FOR MSG         00830000
         CR    R0,R3              SPACE AVAIL FOR NEW MESSAGE?          00840000
         BNH   RUM_ADD            INSERT THE MESSAGE IF SO              00850000
         BAS   R14,$RUMRALC       ELSE BUFFER REALLOCATION              00860000
         B     RUM_OK             TRY AGAIN                             00870000
                                                                        00880000
*--------------------------------------------------------------         00890000
*   INSERT MSG IN RU MSG STRUCTURE AND RECOMPUTE SPACE STATS            00900000
*--------------------------------------------------------------         00910000
RUM_ADD  DS    0H                                                       00920000
         L     R2,RUMUSED         OFFSET TO AVAILABLE STORAGE           00930000
         AR    R0,R2              ACCOUNT FOR NEW ADDITION              00940000
         ST    R0,RUMUSED         UPDATE ACCORDINGLY                    00950000
                                                                        00960000
         LA    R2,RUMSGS(R2)      ADVANCE TO AVAILABLE AREA             00970000
         STCM  R7,3,0(R2)         INSERT NON-INCLUSIVE LENGTH           00980000
         LA    R0,2(,R2)          TEXT AREA                             00990000
         LR    R1,R7              TEXT LENGTH                           01000000
         MVCL  R0,R6              INSERT                                01010000
                                                                        01020000
         LH    R1,RUMSGCT         MESSAGE COUNT                         01030000
         LA    R1,1(,R1)          ACCOUNT FOR ADDITION                  01040000
         STH   R1,RUMSGCT         UPDATE ACCORDINGLY                    01050000
                                                                        01060000
*--------------------------------------------------------------         01070000
*   RETURN COMPLETION STATUS TO CALLER                                  01080000
*--------------------------------------------------------------         01090000
         LA    R15,RC00           NORMAL COMPLETION                     01100000
         B     RETURN                                                   01110000
                                                                        01120000
ERR_MSG  DS    0H                 INVALID MSG LENGTH PROVIDED           01130000
         LA    R15,RC04                                                 01140000
                                                                        01150000
RETURN   DS    0H                                                       01160000
         #EXIT ,                                                        01170000
                                                                        01180000
         EJECT                                                          01190000
***************************************************************         01200000
*                                                                       01210000
* ROUTINE: $RUMRALC - REALLOCATE/EXTEND RUMSGS BUFFER                   01220000
*                                                                       01230000
***************************************************************         01240000
$RUMRALC DS    0H                                                       01250000
         ST    R14,FWORD          SAVE MAINLINE REGS                    01260000
                                                                        01270000
         USING RUMSGS,R4          JUST A REMINDER                       01280000
         ST    R4,DWORD+0         EXTENT ORIGIN                         01290000
         L     R0,RUMSIZE         TOTAL SIZE OF RUMSG STRUCTURE         01300000
         ST    R0,DWORD+4         (ORIGIN,SIZE) IN $REALLOC FORMAT      01310000
                                                                        01320000
         $REALLOC DWORD,2(R7),    REALLOCATE                           X01330000
               INUSE=*RUMUSED,    COPYING OLD CONTENTS                 X01340000
               MF=(E,MFE_LIST)                                          01350000
                                                                        01360000
         L     R4,DWORD+0         NEW EXTENT PTR                        01370000
         L     R1,DWORD+4         NEW EXTENT LENGTH                     01380000
         ST    R1,RUMSIZE         EXTENT LENGTH RETAINED IN STRUCTURE   01390000
         ST    R4,0(,R5)          REPLACE OLD EXTENT                    01400000
                                                                        01410000
         L     R14,FWORD          RESTORE RETURN ADDR                   01420000
         BR    R14                RETURN                                01430000
                                                                        01440000
         EJECT                                                          01450000
***************************************************************         01460000
*                                                                       01470000
*   LOCAL READ ONLY DATA AREAS, ETC.                                    01480000
*                                                                       01490000
***************************************************************         01500000
         LTORG ,                                                        01510000
                                                                        01520000
         EJECT                                                          01530000
         PRINT NOGEN                                                    01540000
         ICVT  ,                                                        01550000
         ITASK ,                                                        01560000
         END   ,                                                        01570000

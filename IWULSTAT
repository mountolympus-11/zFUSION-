IWULSTAT TITLE 'IWULSTAT - WORKUNIT STATUS SERVICE ROUTINE'             00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: IWULSTAT - WORKUNIT STATUS SERVICE ROUTINE                   00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This service routine will test and set the status of the           00080000
*    specified workunit under control of the dispatch lock.             00090000
*    The disp lock is acquired by this service, but it is               00100000
*    recomdended that the caller be holding the disp lock               00110000
*    prior to invoking the TEST service in order to obtain              00120000
*    an accurate assessment of the status.  Also, the displock          00130000
*    should be held by the caller when providing the address of         00140000
*    a workunit, to ensure the workunit address is still                00150000
*    valid.                                                             00160000
*                                                                       00170000
*                                                                       00180000
* ON ENTRY:                                                             00190000
*                                                                       00200000
*    R1  contains the address of a parameter list mapped by             00210000
*        WUSTATPL, which is expanded via $WUSTAT DSECT=YES              00220000
*                                                                       00230000
* ON EXIT:                                                              00240000
*                                                                       00250000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES                     00260000
*                                                                       00270000
*        RC00 - Request completed sucessfully                           00280000
*                                                                       00290000
*               RSN00 - Workunit active                                 00300000
*               RSN04 - Workunit terminating                            00310000
*                                                                       00320000
*        RC04 - Workunit not found                                      00330000
*                                                                       00340000
*        RC08 - Workunit STATUS Error                                   00350000
*                                                                       00360000
*               RSN04 - Unable to acquire lock                          00370000
*                                                                       00380000
**<DOC-OFF>****************************************************         00390000
                                                                        00400000
***************************************************************         00410000
*                                                                       00420000
* MAINTENANCE:                                                          00430000
*                                                                       00440000
*    12/15/94 Ron Colmone                                               00450000
*             Initial Version                                           00460000
*                                                                       00470000
*    01/19/96 Ron Colmone                                               00480000
*                                                                       00490000
*             Added option to WULOC and WUSTAT service to               00500000
*             in indicate that the caller is holding the                00510000
*             DISP lock.  When this option is set to TRUE,              00520000
*             the service will not attempt to acquire the lock.         00530000
*                                                                       00540000
***************************************************************         00550000
                                                                        00560000
         EJECT ,                                                        00570000
         $WUSTAT DSECT=YES        PARAMETER LIST                        00580000
                                                                        00590000
         EJECT ,                                                        00600000
         $WULOC  DSECT=YES        WORKUNIT LOCATOR PLIST                00610000
                                                                        00620000
         EJECT ,                                                        00630000
         @CB   WORKUNIT=YES       WORKUNIT HEADER                       00640000
                                                                        00650000
         EJECT ,                                                        00660000
         EQUS  ,                  GENERAL EQUATES                       00670000
                                                                        00680000
         EJECT ,                                                        00690000
         #WORK LENGTH=256                                               00700000
         IWUENTUD DSECT=NO        WORKUNIT LOCATE USERDATA              00710000
                                                                        00720000
REGSAVE  DS    16F                REGISTER SAVE AREA                    00730000
                                                                        00740000
FLAGS    DS    X                  CONTROL FLAGS                         00750000
$LOCKED  EQU   X'80'                DISP LOCK ACQUIRED                  00760000
                                                                        00770000
$WUL_MFL $WULOC MF=(L,*)          WORKUNIT LOCATOR PLIST                00780000
                                                                        00790000
         #ENDWORK ,               END OF WORKAREA                       00800000
                                                                        00810000
         EJECT ,                                                        00820000
IWULSTAT #ENTER BASE=R12,PREG=R8,WAPASS=YES                             00830000
                                                                        00840000
         USING ITASK,R10          ITASK ADDRESSABILITY                  00850000
         USING WSTATPL,R8         PARAMETER LIST                        00860000
                                                                        00870000
*--------------------------------------------------------------         00880000
                                                                        00890000
         SR    R2,R2              PREPARE FOR INSERT                    00900000
         IC    R2,WSTREQST        OBTAIN REQUESTED FUNCTION CODE        00910000
         BCTR  R2,0               CONVERT TO INDEX                      00920000
         SLL   R2,2               CONVERT TO BRANCH OFFSET              00930000
                                                                        00940000
         B     *+4(R2)            BRANCH ON REQUEST CODE                00950000
         B     TEST               TEST REQUEST                          00960000
         B     TERM               TERM REQUEST                          00970000
         EX    0,*                UNSUPPORTTED                          00980000
         EX    0,*                UNSUPPORTTED                          00990000
         EX    0,*                UNSUPPORTTED                          01000000
                                                                        01010000
         EJECT ,                                                        01020000
***************************************************************         01030000
*                                                                       01040000
*  This function will locate and test the status of the                 01050000
*  specified workunit.                                                  01060000
*                                                                       01070000
***************************************************************         01080000
TEST     DS    0H                                                       01090000
         BAS   R14,GETLOCK        ACQUIRE DISP LOCK                     01100000
         BNZ   ERR_LOCK           ERROR OBTAINING LOCK                  01110000
         BAS   R14,LOCWU          LOCATE WORKUNIT                       01120000
         BNZ   RET04              WORKUNIT NOT AVAILABLE                01130000
                                                                        01140000
         USING @CB,R1             ADDRESSABILITY                        01150000
                                                                        01160000
         LA    R0,RSN00           ASSUME WORKUNIT ACTIVE                01170000
         TM    @CBWUFLG,@CBWUFLG_TERM   WORKUNIT IN TERM PROCESS        01180000
         BZ    RET00              NORMAL RETURN                         01190000
         LA    R0,RSN04           WORKUNIT IS TERMINATING               01200000
         B     RET00              NORMAL RETURN                         01210000
                                                                        01220000
         DROP  R1                 @CB                                   01230000
                                                                        01240000
         EJECT ,                                                        01250000
***************************************************************         01260000
*                                                                       01270000
*  This function will set the workunit termination in progress          01280000
*  status indicator.                                                    01290000
*                                                                       01300000
***************************************************************         01310000
TERM     DS    0H                                                       01320000
         BAS   R14,GETLOCK        ACQUIRE DISP LOCK                     01330000
         BNZ   ERR_LOCK           ERROR OBTAINING LOCK                  01340000
         BAS   R14,LOCWU          LOCATE WORKUNIT                       01350000
         BNZ   RET04              WORKUNIT NOT AVAILABLE                01360000
                                                                        01370000
         USING @CB,R1             ADDRESSABILITY                        01380000
                                                                        01390000
         OI    @CBWUFLG,@CBWUFLG_TERM  INDICATE WORKUNIT TERM           01400000
         LA    R0,RSN00                                                 01410000
         B     RET00              NORMAL RETURN                         01420000
                                                                        01430000
         DROP  R1                 @CB                                   01440000
                                                                        01450000
         EJECT ,                                                        01460000
***************************************************************         01470000
*                                                                       01480000
*   RETURN COMPLETION STATUS TO CALLER                                  01490000
*                                                                       01500000
***************************************************************         01510000
ERR_LOCK DS    0H                                                       01520000
         LA    R0,RSN04           UNABLE TO ACQUIRE LOCK                01530000
         B     RET08              RETURN ERROR                          01540000
                                                                        01550000
*--------------------------------------------------------------         01560000
RET00    DS    0H                                                       01570000
         LA    R15,RC00           NORMAL COMPLETION                     01580000
         B     RETURN             RETURN                                01590000
                                                                        01600000
RET04    DS    0H                                                       01610000
         LA    R15,RC04           WORKUNIT NOT FOUND (WARNING)          01620000
         B     RETURN             RETURN                                01630000
                                                                        01640000
RET08    DS    0H                                                       01650000
         LA    R15,RC08           SERVICE FAILURE                       01660000
         B     RETURN             RETURN                                01670000
                                                                        01680000
RETURN   DS    0H                                                       01690000
         BAS   R14,RELLOCK        RELEASE DISPATCHER LOCK               01700000
                                                                        01710000
         #EXIT ,                  RETURN                                01720000
                                                                        01730000
         EJECT ,                                                        01740000
***************************************************************         01750000
*                                                                       01760000
* ROUTINE: GETLOCK - OBTAIN DISPATCHER LOCK                             01770000
*                                                                       01780000
***************************************************************         01790000
GETLOCK  DS    0H                                                       01800000
         STM   R0,R15,REGSAVE     SAVE CALLER'S REGISTERS               01810000
                                                                        01820000
         CLI   WSTLOCK,FALSE      CALLER HOLDING DISP LOCK?             01830000
         BNE   LOCK_HAV           YES, SKIP LOCK OBTAIN                 01840000
                                                                        01850000
         $SER  OBTAIN,DISP        ACQUIRE DISP LOCK                     01860000
         B     *+4(R15)           BRANCH ON RETURN CODE                 01870000
         B     LOCK_ACQ           OK, LOCK ACQUIRED                     01880000
         B     LOCK_HAV           LOCK ALREADY OWNED                    01890000
         B     LOCK_RET           ERROR ACQUIRING LOCK                  01900000
                                                                        01910000
LOCK_ACQ DS    0H                                                       01920000
         OI    FLAGS,$LOCKED      LOCK ACQUIRED                         01930000
                                                                        01940000
LOCK_HAV DS    0H                                                       01950000
         LA    R15,RC00           NORMAL COMPLETION                     01960000
                                                                        01970000
LOCK_RET DS    0H                                                       01980000
         LM    R0,R14,REGSAVE     RESTORE CALLER'S REGISTERS            01990000
         LTR   R15,R15            SET CONDITION CODE                    02000000
         BR    R14                RETURN                                02010000
                                                                        02020000
         EJECT ,                                                        02030000
***************************************************************         02040000
*                                                                       02050000
* ROUTINE: RELLOCK - RELEASE DISPATCHER LOCK                            02060000
*                                                                       02070000
***************************************************************         02080000
RELLOCK  DS    0H                                                       02090000
         STM   R0,R15,REGSAVE     SAVE CALLER'S REGISTERS               02100000
                                                                        02110000
         TM    FLAGS,$LOCKED      LOCK ACQUIRED?                        02120000
         BZ    RLK_EXIT           NO RETURN                             02130000
                                                                        02140000
         $SER  RELEASE,DISP       RELEASE DISP LOCK                     02150000
                                                                        02160000
RLK_EXIT DS    0H                                                       02170000
         LM    R0,R15,REGSAVE     RESTORE CALLER'S REGISTERS            02180000
         BR    R14                RETURN                                02190000
                                                                        02200000
         EJECT ,                                                        02210000
***************************************************************         02220000
*                                                                       02230000
* ROUTINE: LOCWU - Locate workunit address                              02240000
*                                                                       02250000
***************************************************************         02260000
LOCWU    DS    0H                                                       02270000
         STM   R0,R15,REGSAVE     SAVE CALLER'S REGISTERS               02280000
                                                                        02290000
         LA    R15,RC00           ASSUME SUCCESSFULL COMPLETION         02300000
                                                                        02310000
         ICM   R1,15,WSTWU@       WORKUNIT ADDRESS PROVIDED?            02320000
         BNZ   LWU_RET            YES, RETURN WORKUNIT ADDRESS          02330000
                                                                        02340000
         $WULOC LOCATE,           WORKUNIT AVAILABLE                   +02350000
               TOKEN=*WSTTKN@,                                         +02360000
               USERDATA=IWUENTUD,                                      +02370000
               LOCKED=YES,                                             +02380000
               MF=(E,$WUL_MFL)                                          02390000
         BNZ   LWU_RET            WORKUNIT NOT AVAILABLE                02400000
                                                                        02410000
         ICM   R1,15,WUDIPCB      PROCESS MODE WORKUNIT                 02420000
         BNZ   LWU_RET            YES, RETURN WORKUNIT ADDRESS          02430000
         ICM   R1,15,WUDITASK     TASK MODE WORKUNIT                    02440000
         BNZ   LWU_RET            YES, RETURN WORKUNIT ADDRESS          02450000
                                                                        02460000
         LA    R15,RC04           WORKUNIT NOT ACTIVE                   02470000
                                                                        02480000
LWU_RET  DS    0H                                                       02490000
         LM    R2,R14,REGSAVE+8   RESTORE CALLER'S REGISTERS            02500000
         LTR   R15,R15            TEST COMPLETION STATUS                02510000
         BR    R14                RETURN                                02520000
                                                                        02530000
         EJECT ,                                                        02540000
***************************************************************         02550000
*                                                                       02560000
*   LOCAL READ/ONLY DATA AREAS, ETC.                                    02570000
*                                                                       02580000
***************************************************************         02590000
                                                                        02600000
         LTORG ,                                                        02610000
                                                                        02620000
         PRINT NOGEN                                                    02630000
         ICVT  ,                                                        02640000
         ITASK ,                                                        02650000
         IPCB  ,                                                        02660000
         PRINT GEN                                                      02670000
                                                                        02680000
         END   ,                                                        02690000

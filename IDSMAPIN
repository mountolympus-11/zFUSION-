IDSMAPIN TITLE 'DATASPACE SERVICES - SPACE MAP INITIALIZATION'          00010000
***************************************************************         00020000
*                                                                       00030000
*   READ / WRITE WORKING STORAGE AREA                                   00040000
*                                                                       00050000
***************************************************************         00060000
WORKAREA DSECT                                                          00070000
                                                                        00080000
         @WORK ,                  STANDARD WORKAREA                     00090001
                                                                        00100000
MAPLOCAL DS    A                  ADDR OF SPACE MAP CONSTRUCTION AREA   00110000
MAPALUS  DS    F                  SIZE OF SPACE MAP IN ALU'S            00120000
MAPBYTES DS    F                  SIZE OF SPACE MAP IN BYTES            00130000
                                                                        00140000
WORKLEN  EQU   *-WORKAREA         WORKAREA LENGTH                       00150000
                                                                        00160001
         EJECT                                                          00170000
         SPCBLOCK ,                                                     00180000
                                                                        00190001
         EJECT                                                          00200000
         SPCEQUS ,                                                      00210000
                                                                        00220001
         EJECT                                                          00230000
         OIE ,                                                          00240000
                                                                        00250001
         EJECT                                                          00260000
         EQUS  LINKAGE=VCON                                             00270002
                                                                        00280001
         EJECT                                                          00290000
**<DOC-ON>*****************************************************         00300001
*                                                                       00310000
* ROUTINE: IDSMAPIN - SPACE MAP INITIALIZATION                          00320000
*                                                                       00330000
* DESCRIPTION:                                                          00340000
*                                                                       00350000
*    THIS ROUTINE CONSTRUCTS A SPACE MAP THAT PARTITIONS A              00360000
*    STORAGE AREA INTO A SERIES OF ALLOCATION UNITS, SOME               00370000
*    OF WHICH ARE MARKED UNAVAILABLE TO ACCOUNT FOR:                    00380000
*                                                                       00390000
*    - THE SPACE MAP ITSELF                                             00400000
*    - THE STORAGE PREFIX AREA                                          00410000
*                                                                       00420000
*    BECAUSE THE SPACE MAP ITSELF IS A RELOCATABLE OBJECT, A            00430000
*    SPECIAL SYSTEM OIE IS MAINTAINED TO REPRESENT IT.                  00440000
*                                                                       00450000
*                                                                       00460000
* METHOD:                                                               00470000
*                                                                       00480000
*    1. DETERMINE SPACE MAP SIZE IN BYTES AND ALU'S                     00490000
*    2. ACQUIRE LOCAL (PRIMARY) STORAGE FOR MAP AND ZERO IT             00500000
*    3. IF A MAP ALREADY EXISTS FOR SPACE, COPY IT INTO THE NEW MAP     00510000
*    4. RESERVE EXTENT FOR PREFIX AREA                                  00520000
*    5. LOCATE AND RESERVE SPACE FOR SPACE MAP EXTENT                   00530000
*    6. IF A MAP PREVIOUSLY EXISTED, RELEASE ITS STORAGE                00540000
*    7. MOVE SPACE MAP INTO RESERVED LOCATION                           00550000
*    8. UPDATE THE SPACE MAP OIE ACCORDINGLY                            00560000
*    9. FREE STORAGE AND EXIT                                           00570000
*                                                                       00580000
*                                                                       00590000
* ON ENTRY:                                                             00600000
*                                                                       00610000
*    A/R10 - ADDRESS OF THE STORAGE SPACE BLOCK (SPCBLOCK)              00620000
*                                                                       00630000
*                                                                       00640000
* ON EXIT:                                                              00650000
*                                                                       00660000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES                     00670000
*                                                                       00680000
*        RC00 - STORAGE MAP CONSTRUCTION COMPLETED                      00690000
*        RC08 - SUFFICIENT STORAGE NOT AVAILABLE TO CONSTRUCT MAP       00700000
*        RC12 - STORAGE NOT AVAILABLE                                   00710000
*        RC16 - INVALID REQUEST                                         00720000
*        RC20 - ALU TRANSLATION ERROR                                   00730000
*                                                                       00740000
**<DOC-OFF>****************************************************         00750001
                                                                        00760001
         EJECT                                                          00770000
IDSMAPIN @ENTER WORKA=(WORKAREA,WORKLEN)                                00780000
                                                                        00790000
         USING SPCBLOCK,R10       CONVENTION                            00800000
                                                                        00810000
*--------------------------------------------------------------         00820000
*   ALLOCATE A NEW SPACE MAP                                            00830001
*--------------------------------------------------------------         00840000
         L     R2,SPC_SIZE        SIZE OF SPACE                         00850000
         L     R3,SPC_ALU_SIZE    SIZE OF ALLOCATION UNIT               00860000
                                                                        00870000
         @CALL IDSMAPSZ,((R2),(R3)),MF=(E,MFE_LIST)                     00880000
                                                                        00890000
         ST    R15,SPC_ALU_COUNT  # USABLE ALU'S                        00900000
         ST    R1,MAPALUS         SIZE OF SPACE MAP IN ALU'S            00910000
         ST    R0,MAPBYTES        SIZE OF SPACE MAP IN BYTES            00920000
                                                                        00930000
         LR    R2,R0              LENGTH IN SAFE REG                    00940000
                                                                        00950001
         $STORAGE OBTAIN,LENGTH=(R2),COND=YES                           00960001
                                                                        00970001
         LTR   R15,R15            STORAGE ACQUIRED?                     00980000
         BNZ   ERR_STG            NO SPACE AVAILABLE                    00990000
                                                                        01000000
         LAE   R9,0(R1,0)         SPACE MAP CONSTRUCTION AREA           01010001
         ST    R9,MAPLOCAL        SAVE MAP ADDRESS                      01020000
         LR    R0,R9              WORKAREA ORIGIN, ALWAYS PRIMARY       01030000
         LR    R1,R2              WORKAREA LENGTH                       01040000
         SR    R15,R15            PREPARE FOR CLEAR                     01050000
         MVCL  R0,R14             CLEAR                                 01060000
                                                                        01070000
*--------------------------------------------------------------         01080000
*   COPY EXISTING SPACE MAP                                             01090000
*--------------------------------------------------------------         01100000
         LAE   R8,SPC_STGMAP_OIE  SPACE MAP OIE                         01110001
         USING OIE,R8             OIE ADDRESSABILITY                    01120000
         ICM   R7,15,OIESTHWM     BYTE LENGTH OF EXISTING SPACE MAP     01130000
         BZ    NEWMAP             MAP DOES NOT YET EXIST                01140000
                                                                        01150000
         LAE   R6,OIESTORG        MAP PTR LOCATION                      01160001
         L     R1,0(,R6)          MAP ORIGIN ALU                        01170000
         @ALU  (1)                CONVERT TO ADDRESS                    01180000
         BNZ   ERR_ALU            ALU TRANSLATION ERROR                 01190000
         LR    R6,R1              RESTORE TO AR WINDOW                  01200000
         LR    R0,R9              LOCAL SPACE MAP AREA                  01210000
         LR    R1,R7              SOURCE LENGTH = TARGET LENGTH         01220000
         MVCL  R0,R6              COPY SPACE MAP                        01230000
         B     UPDMAP             CONSTRUCT NEW MAP                     01240000
                                                                        01250000
*--------------------------------------------------------------         01260000
*   RESERVE STORAGE FOR SPACE PREFIX AND NEW SPACE MAP                  01270000
*--------------------------------------------------------------         01280000
NEWMAP   DS    0H                                                       01290000
         @CALL IDSMAPSV,(STGRSRV,0,*SPC_ALU_PREFIX,(R9)),              X01300000
               MF=(E,MFE_LIST)                                          01310000
                                                                        01320001
         LTR   R15,R15            STORAGE LOCATED?                      01330000
         BNZ   ERR_SV             ERROR                                 01340000
                                                                        01350000
UPDMAP   DS    0H                                                       01360000
         L     R2,MAPALUS         NUMBER OF ALU'S NEEDED FOR MAP        01370000
                                                                        01380001
         @CALL IDSMAPSV,(STGLOC,0,(R2),(R9)),MF=(E,MFE_LIST)            01390000
                                                                        01400001
         LTR   R15,R15            STORAGE LOCATED?                      01410000
         BNZ   ERR_SV             ERROR                                 01420000
                                                                        01430000
         LR    R3,R1              ALU ORIGIN OF EXTENT RETURNED         01440000
                                                                        01450001
         @CALL IDSMAPSV,(STGRSRV,(R3),(R2),(R9)),MF=(E,MFE_LIST)        01460000
                                                                        01470001
         LTR   R15,R15            STORAGE LOCATED?                      01480000
         BNZ   ERR_SV             ERROR                                 01490000
                                                                        01500000
*--------------------------------------------------------------         01510000
*   RELEASE EXTENT OCCUPIED BY OLD SPACE MAP                            01520000
*--------------------------------------------------------------         01530000
         ICM   R5,15,OIESTLEN     SPACE MAP ALREADY EXISTS?             01540000
         BZ    MOVEMAP            SKIP IF NOT                           01550000
                                                                        01560001
         @CALL IDSMAPSV,(STGRLSE,*OIESTORG,(R5),(R9)),                 X01570000
               MF=(E,MFE_LIST)                                          01580000
                                                                        01590001
         LTR   R15,R15            STORAGE LOCATED?                      01600000
         BNZ   ERR_SV             ERROR                                 01610000
                                                                        01620000
*--------------------------------------------------------------         01630000
*   RETURN UPDATED MAP TO STORAGE                                       01640000
*--------------------------------------------------------------         01650000
MOVEMAP  DS    0H                                                       01660000
         @ALU  (R3)               ADDRESS OF NEW SPACE MAP              01670000
         BNZ   ERR_ALU            ALU TRANSLATION ERROR                 01680000
                                                                        01690000
         LAE   R6,SPCBLOCK        OPEN WINDOW TO SPACE                  01700001
         LR    R6,R1              MAP LOCATION                          01710000
         L     R7,MAPALUS         LENGTH OF MAP                         01720000
         L     R15,SPC_ALU_POWER2 FACTOR CONVERTING ALUS TO BYTES       01730000
         SLL   R7,0(R15)          CONVERT BYTES                         01740000
         LR    R0,R9              MAP CONSTRUCTION AREA                 01750000
         L     R1,MAPBYTES        TRUE LENGTH OF SPACE MAP              01760000
         MVCL  R6,R0              RESTORE SPACE MAP                     01770000
                                                                        01780000
*--------------------------------------------------------------         01790000
*   UPDATE SPACE MAP OBJECT INDEX ENTRY ACCORDINGLY                     01800000
*--------------------------------------------------------------         01810000
         MVC   OIETAG,=CL4'OIE '  EYECATCHER                            01820000
         ST    R3,OIESTORG        MAP ORIGIN ALU #                      01830000
         MVC   OIESTLEN,MAPALUS   SIZE OF MAP                           01840000
         MVC   OIESTHWM,MAPBYTES  HIGHWATER MARKS TRUE END OF MAP       01850000
                                                                        01860000
         LA    R2,L'MAPNAME       LENGTH OF SPACE OBJECT NAME           01870000
         STH   R2,OIENAMLN        POST NAME LENGTH                      01880000
         MVC   OIENAME(L'MAPNAME),MAPNAME                               01890000
                                                                        01900000
         OIECHG ,                 STANDARD OIE CHANGE                   01910000
         DROP  R8                 OIE                                   01920000
                                                                        01930000
*--------------------------------------------------------------         01940000
*   RETURN COMPLETION STATUS TO CALLER, FREE RESIDUAL STORAGE           01950000
*--------------------------------------------------------------         01960000
         LA    R15,RC00                                                 01970000
         B     RET                                                      01980000
                                                                        01990000
ERR_STG  DS    0H                                                       02000000
         LA    R15,RC12           LOCAL STORAGE NOT AVAILABLE           02010000
         B     RET                                                      02020000
                                                                        02030000
ERR_ALU  DS    0H                 ALU TRANSLATION ERROR                 02040000
         LA    R15,RC20                                                 02050000
                                                                        02060000
ERR_SV   DS    0H                 IDSMAPSV RETURN CODE PASSED THRU      02070000
RET      DS    0H                 RELEASE ACQUIRED STORAGE              02080000
         ICM   R9,15,MAPLOCAL     MAP CONSTRUCTION AREA ACQUIRED?       02090000
         BZ    RETEXIT                                                  02100000
                                                                        02110000
         L     R2,MAPBYTES        LENGTH OF MAP CONSTRUCTION AREA       02120000
         STM   R15,R1,MFE_LIST    SAVE COMPLETION STATUS                02130000
                                                                        02140001
         $STORAGE RELEASE,ADDR=(R9),LENGTH=(R2)                         02150001
                                                                        02160001
         LM    R15,R1,MFE_LIST    RESTORE COMPLETION STATUS             02170000
                                                                        02180000
RETEXIT  DS    0H                                                       02190000
         @EXIT ,                                                        02200000
                                                                        02210001
         EJECT                                                          02220000
***************************************************************         02230000
*                                                                       02240000
* READ ONLY CONSTANTS, ETC.                                             02250000
*                                                                       02260000
***************************************************************         02270000
MAPNAME  DC    C'STORAGE-MAP-OIE'                                       02280000
                                                                        02290000
         LTORG ,                                                        02300000
         END   ,                                                        02310000

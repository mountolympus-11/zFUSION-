                                                                        00010000
ISVCSBUF TITLE 'INTEGRATOR SERVICE ROUTINE: SBUF OBTAIN/RELEASE'        00020000
                                                                        00030000
**<DOC-ON>************************************************************* 00040000
*                                                                       00050000
* ROUTINE: ISVCSBUF - INTEGRATOR SERVICE ROUTINE: SBUF OBTAIN/RELEASE   00060000
*                                                                       00070000
* DESCRIPTION: "OBTAIN" CALL WILL ALLOCATE OR REALLOCATE (DOUBLE THE    00080000
*              THE SIZE AND COPY THE EXISTING VALID DATA) AN SBUF       00090000
*              (A $SESS SEND BUFFER).                                   00100000
*                                                                       00110000
*              "RELEASE" WILL FREE THE EXISTING BUFFER.                 00120000
*                                                                       00130000
*              THE SBFLIST SERVES AS A "LIFE OF BUFFER" CONTROL AREA    00140000
*              AND PARAMETER LIST IN CALLER STORAGE.                    00150000
*                                                                       00160000
* ON ENTRY:                                                             00170000
*                                                                       00180000
*    R15 = ENTRY POINT ADDRESS                                          00190000
*    R14 = RETURN ADDRESS                                               00200000
*    R13 = AVAILABLE SAVE AREA                                          00210000
*    R11 = ICVT ADDRESS                                                 00220000
*    R10 = ITASK ADDRESS                                                00230000
*    R01 = SBFLIST ADDRESS                                              00240000
*                                                                       00250000
* ON EXIT:                                                              00260000
*                                                                       00270000
*    R15 = 0 --> BUFFER OBTAIN OR RELEASE SUCCESSFUL                    00280000
*          4 --> BUFFER OBTAIN FAILED (SIZE TOO LARGE OR INVALID)       00290000
*    R00 = 0                                                            00300000
*    R01 = SBFLIST ADDRESS                                              00310000
*                                                                       00320000
*    ALL OTHER REGISTERS ARE RESTORED                                   00330000
*                                                                       00340000
**<DOC-OFF>************************************************************ 00350000
         EJECT ,                                                        00360000
*********************************************************************** 00370000
*                                                                       00380000
* MAINTENANCE:                                                          00390000
*                                                                       00400000
*   10/01/93 RANDY WITEK                                                00410000
*                                                                       00420000
*********************************************************************** 00430000
         EQUS  ,                  GENERAL EQUATES                       00440000
RICVT    EQU   R11                                                      00450000
RITASK   EQU   R10                                                      00460000
RIVTAM   EQU   R9                                                       00470000
RSBFLIST EQU   R8                                                       00480000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00490000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00500000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00510000
         USING SBFLIST,RSBFLIST   ESTABLISH ADDRESSABILITY              00520000
                                                                        00530000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00540000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00550000
RETR15   DS    F                  RETURN CODE                           00560000
RETR0    DS    F                  RETURN REGISTER 0                     00570000
RETR1    DS    F                  RETURN REGISTER 1                     00580000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00590000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00600000
                                                                        00610000
ISVCSBUF #ENTER BASE=R12,         R12 IS BASE REGISTER                 +00620000
               AMODE=31,                                               +00630000
               RMODE=ANY,                                              +00640000
               SAVE=YES,          ALLOCATE SAVE/WORK AREA              +00650000
               PREG=RSBFLIST,     R1 --> RSBFLIST                      +00660000
               RESTENV=NO,        ICVT AND ITASK POINTERS ARE OK       +00670000
               WAPASS=NO,         NO WORK AREA PASSED IN R0            +00680000
               LINKAGE=STD        CALLED BY BAS/BASR                    00690000
                                                                        00700000
*---------------------------------------------------------------------- 00710000
* DETERMINE TYPE OF CALL                                                00720000
*---------------------------------------------------------------------- 00730000
                                                                        00740000
         LA    R0,0(,RSBFLIST)    PARM LIST ADDRESS                     00750000
         ST    R0,RETR1           PASS IT BACK IN R1                    00760000
         LTR   RSBFLIST,RSBFLIST  + --> OBTAIN, - --> RELEASE           00770000
         BM    RELEASE            GO PROCESS RELEASE CALL               00780000
                                                                        00790000
*---------------------------------------------------------------------- 00800000
* PROCESS OBTAIN "INITIAL" CALL                                         00810000
*---------------------------------------------------------------------- 00820000
                                                                        00830000
         ICM   R3,15,SBFBUFA      BUFFER ADDRESS                        00840000
         BNZ   REOBTAIN           IF BUFFER EXISTS, DOUBLE THE SIZE     00850000
         ICM   R4,15,SBFOWNER     IS A $GETSTOR QUEUE HEADER SPECIFIED? 00860000
         BNZ   OBTAINSZ           BRANCH IF YES                         00870000
         ST    RITASK,SBFOWNER    SET THE OWNER                         00880000
         LR    R4,RITASK          AND LOAD IT INTO R4                   00890000
                                                                        00900000
OBTAINSZ DS    0H                                                       00910000
                                                                        00920000
         ICM   R5,15,SBFBUFL      IS A LENGTH REQUESTED?                00930000
         BZ    OBDEFSIZ           BRANCH IF NOT, USE DEFAULT            00940000
         C     R5,=A(IVTSBMAX)    IS REQUEST TOO LARGE                  00950000
         BH    BADSIZE            BRANCH IF YES                         00960000
         B     OBTAIN             GET THE BUFFER                        00970000
                                                                        00980000
OBDEFSIZ DS    0H                                                       00990000
                                                                        01000000
         L     R5,=A(IVTSBSIZ)    INITIAL SBUF SIZE CONSTANT            01010000
                                                                        01020000
OBTAIN   DS    0H                                                       01030000
                                                                        01040000
         LR    R1,R4                                                    01050000
         BAS   R14,CHECKTSK       VALIDATE STORAGE ENVIRONMENT          01060000
                                                                        01070000
         $GETSTOR (R5),                                                +01080000
               LOC=ANY,                                                +01090000
               OWNER=(R4)         ALLOCATE AN SBUF                      01100000
                                                                        01110000
         ST    R1,SBFBUFA         SET THE ADDRESS                       01120000
         ST    R5,SBFBUFL         SET THE LENGTH                        01130000
         XC    SBFBUFO,SBFBUFO    OFFSET IS NOW ZERO                    01140000
         B     RETURN             RETURN TO CALLER                      01150000
                                                                        01160000
*---------------------------------------------------------------------- 01170000
* PROCESS OBTAIN "REOBTAIN" CALL                                        01180000
*---------------------------------------------------------------------- 01190000
                                                                        01200000
REOBTAIN DS    0H                                                       01210000
                                                                        01220000
         ICM   R4,15,SBFOWNER     IS A $GETSTOR QUEUE HEADER SPECIFIED? 01230000
         BNZ   REOBSIZ            BRANCH IF YES                         01240000
         ST    RITASK,SBFOWNER    SET THE OWNER                         01250000
         LR    R4,RITASK          AND LOAD IT INTO R4                   01260000
                                                                        01270000
REOBSIZ  DS    0H                                                       01280000
                                                                        01290000
         ICM   R2,15,SBFBUFL      CURRENT BUFFER LENGTH                 01300000
         BZ    BADSIZE            BRANCH IF SOMETHING WRONG             01310000
         C     R2,SBFBUFO         CHECK AGAINST CURRENT CONTENTS        01320000
         BL    BADSIZE            BRANCH IF SOMETHING WRONG             01330000
         LR    R5,R2              CURRENT SIZE                          01340000
         SLL   R5,1               DOUBLE IT                             01350000
         C     R5,=A(IVTSBMAX)    WILL IT BE TOO LARGE?                 01360000
         BH    BADSIZE            BRANCH IF YES                         01370000
                                                                        01380000
         LR    R1,R4                                                    01390000
         BAS   R14,CHECKTSK       VALIDATE STORAGE ENVIRONMENT          01400000
                                                                        01410000
         $GETSTOR (R5),                                                +01420000
               LOC=ANY,                                                +01430000
               OWNER=(R4)         ALLOCATE A LARGER SBUF                01440000
                                                                        01450000
         LR    R6,R3              CURRENT BUFFER ADDRESS                01460000
         L     R7,SBFBUFO         CURRENT AMOUNT OF VALID DATA          01470000
         ST    R1,SBFBUFA         SET THE ADDRESS                       01480000
         ST    R5,SBFBUFL         SET THE LENGTH                        01490000
         LR    R0,R1              NEW     BUFFER ADDRESS                01500000
         LR    R1,R7              NEW     AMOUNT OF VALID DATA          01510000
         MVCL  R0,R6              COPY THE VALID DATA                   01520000
                                                                        01530000
         LR    R1,R4                                                    01540000
         BAS   R14,CHECKTSK       VALIDATE STORAGE ENVIRONMENT          01550000
         LR    R1,R3              IN CASE WE NEED TO QUEUE IT           01560000
         CR    R4,RITASK          ARE WE RUNNING IN THE OWNER TASK?     01570000
         BNE   QSTORAGE           BRANCH IF NOT                         01580000
                                                                        01590000
         $RETSTOR (R3),                                                +01600000
               OWNER=(R4)         RELEASE THE SMALLER SBUF              01610000
                                                                        01620000
         B     RETURN             RETURN TO CALLER                      01630000
                                                                        01640000
*---------------------------------------------------------------------- 01650000
* PROCESS RELEASE CALL                                                  01660000
*---------------------------------------------------------------------- 01670000
                                                                        01680000
RELEASE  DS    0H                                                       01690000
                                                                        01700000
         ICM   R3,15,SBFBUFA      BUFFER ADDRESS                        01710000
         BZ    RETURN             BRANCH IF NO BUFFER                   01720000
         ICM   R4,15,SBFOWNER     IS A $GETSTOR QUEUE HEADER SPECIFIED? 01730000
         BNZ   RELFREE            BRANCH IF YES                         01740000
         LR    R4,RITASK          DEFAULT IS ITASK STORAGE              01750000
                                                                        01760000
RELFREE  DS    0H                                                       01770000
                                                                        01780000
         LR    R1,R4                                                    01790000
         BAS   R14,CHECKTSK       VALIDATE STORAGE ENVIRONMENT          01800000
         XC    SBFBUFA,SBFBUFA    SHOW NO BUFFER                        01810000
         XC    SBFBUFL,SBFBUFL    SHOW NO BUFFER                        01820000
         XC    SBFBUFO,SBFBUFO    SHOW NO BUFFER                        01830000
         LR    R1,R3              IN CASE WE NEED TO QUEUE IT           01840000
         CR    R4,RITASK          ARE WE RUNNING IN THE OWNER TASK?     01850000
         BNE   QSTORAGE           BRANCH IF NOT                         01860000
                                                                        01870000
         $RETSTOR (R3),                                                +01880000
               OWNER=(R4)         RELEASE AN SBUF                       01890000
                                                                        01900000
         B     RETURN             RETURN TO CALLER                      01910000
                                                                        01920000
*---------------------------------------------------------------------- 01930000
* QUEUE STORAGE FOR RELEASE BY SESSION PROCESS UNDER SESSION ITASK      01940000
*---------------------------------------------------------------------- 01950000
                                                                        01960000
QSTORAGE DS    0H                                                       01970000
                                                                        01980000
X        USING ITASK,R4                                                 01990000
         L     R3,X.TSKIVUSR      IVUSER ADDRESS                        02000000
         DROP  X                                                        02010000
                                                                        02020000
X        USING IVUSER,R3                                                02030000
         LA    R2,X.IVURETQ       QUEUE HEADER FOR STORAGE RELEASE      02040000
         DROP  X                                                        02050000
                                                                        02060000
         L     R14,0(,R2)         CURRENT HEAD OF QUEUE                 02070000
                                                                        02080000
QRETRY   DS    0H                                                       02090000
                                                                        02100000
         ST    R14,0(,R1)         LINK OLD TOP TO NEW TOP               02110000
         CS    R14,R1,0(R2)       SWAP NEW ONE ON TOP                   02120000
         BNE   QRETRY             TRY IT AGAIN IF THE TOP CHANGED       02130000
         B     RETURN             RETURN TO CALLER                      02140000
                                                                        02150000
*---------------------------------------------------------------------- 02160000
* ERROR ROUTINES                                                        02170000
*---------------------------------------------------------------------- 02180000
                                                                        02190000
BADSIZE  DS    0H                                                       02200000
                                                                        02210000
         MVI   RETR15+(L'RETR15-1),4                                    02220000
         B     RETURN                                                   02230000
                                                                        02240000
ERRENVIR DS    0H                                                       02250000
                                                                        02260000
         $ABEND ABE_VTDIAG,                                            +02270000
               SCOPE=PCB,                                              +02280000
               TITLE='SBUF OWNER MUST BE A SESSION-ORIENTED TASK'       02290000
                                                                        02300000
*---------------------------------------------------------------------- 02310000
* RETURN TO CALLER                                                      02320000
*---------------------------------------------------------------------- 02330000
                                                                        02340000
RETURN   DS    0H                                                       02350000
                                                                        02360000
         LM    R15,R0,RETREGS     RETURN REGISTERS                      02370000
                                                                        02380000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    02390000
                                                                        02400000
*---------------------------------------------------------------------- 02410000
* SUBROUTINE CHECKTSK: VERIFY THAT SBUF OWNER IS A SESSION TASK         02420000
* ENTRY     R01 = ADDRESS OF OWNER BLOCK (E.G. ITASK)                   02430000
*           R14 = RETURN ADDRESS                                        02440000
*---------------------------------------------------------------------- 02450000
                                                                        02460000
CHECKTSK DS    0H                                                       02470000
                                                                        02480000
X        USING ITASK,R1                                                 02490000
         CLC   X.TSKID,=CL8'ITASK'                                      02500000
         BNE   ERRENVIR                                                 02510000
         ICM   R1,15,X.TSKIVUSR                                         02520000
         BZ    ERRENVIR                                                 02530000
         DROP  X                                                        02540000
                                                                        02550000
X        USING IVUSER,R1                                                02560000
         CLC   X.IVUID,=CL8'IVUSER'                                     02570000
         BNE   ERRENVIR                                                 02580000
         BR    R14                                                      02590000
         DROP  X                                                        02600000
                                                                        02610000
         LTORG ,                                                        02620000
         PRINT NOGEN                                                    02630000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                02640000
         ABCODES ,                INTEGRATOR ABEND CODES                02650000
         ICVT  ,                  INTEGRATOR CVT                        02660000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   02670000
         ITASK ,                  INTEGRATOR TASK BLOCK                 02680000
         IVUSER ,                 INTEGRATOR IVUSER BLOCK               02690000
         SBUF  DSECT=YES          INTEGRATOR SBUF SERVICES              02700000
         END   ,                                                        02710000

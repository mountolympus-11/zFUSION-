ITSKEVIN TITLE '- TASK EVENTS TABLE INITIALIZATION SERVICE'             00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE: ITSKEVIN - Task events table initialization service          00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine will initialize the events table for the              00080000
*    current task if the task was created with TCBAFF=YES.              00090000
*    If the task is not directly responsible for an events              00100000
*    table (i.e. the task runs under a server task), then               00110000
*    the events table address is located by running the parent          00120000
*    ITASK chain looking for a parent task which has created            00130000
*    SERVER tasks.                                                      00140000
*                                                                       00150000
* ON ENTRY:                                                             00160000
*                                                                       00170000
*    R1 Contains the address of the parameter list mapped by            00180000
*    the TASKPL dsect generated by $TASK DSECT=YES.                     00190000
*                                                                       00200000
* ON EXIT:                                                              00210000
*                                                                       00220000
*    R15 contains one of the following return codes:                    00230000
*                                                                       00240000
*        RC00 - Normal completion                                       00250000
*                                                                       00260000
*        RC12 - Service Failure                                         00270000
*                                                                       00280000
*               RSN04 - Invalid server ITASK address                    00290000
*                                                                       00300000
* MODE:                                                                 00310000
*                                                                       00320000
*    TASK                                                               00330000
*    APF/NON-APF                                                        00340000
*    SUP/PROB                                                           00350000
*    AMODE 31, RMODE ANY                                                00360000
*                                                                       00370000
**<DOC-OFF>*****************************************************        00380000
                                                                        00390000
         EJECT ,                                                        00400000
****************************************************************        00410000
*                                                                       00420000
* MAINTENANCE:                                                          00430000
*                                                                       00440000
*   04/21/93 Ron Colmone                                                00450000
*            Initial Version                                            00460000
*                                                                       00470000
****************************************************************        00480000
         EJECT ,                                                        00490000
         $TASK DSECT=YES          TASKMGR PLIST                         00500000
                                                                        00510000
         EJECT ,                                                        00520000
         EQUS  ,                  GENERAL EQUATES                       00530000
                                                                        00540000
         EJECT ,                                                        00550000
         #WORK LENGTH=512         READ/WRITE WORKAREA                   00560000
         #ENDWORK                 END OF WORKAREA                       00570000
                                                                        00580000
#MAXEVNT EQU   (32*1024)-1        MAXIMUM NUMBER OF EVENTS ENTRIES      00590000
                                                                        00600000
         EJECT ,                                                        00610000
ITSKEVIN #ENTER BASE=R12,         ENTRY LINKAGE                        +00620000
               PREG=R8,                                                +00630000
               WAPASS=YES                                               00640000
                                                                        00650000
         USING TASKPL,R8          ESTABLISH ADDRESSABILITY              00660000
                                                                        00670000
         EJECT ,                                                        00680000
****************************************************************        00690000
*                                                                       00700000
*  INITIALIZE EVENTS TABLE FOR TASK                                     00710000
*                                                                       00720000
****************************************************************        00730000
EVINIT   DS    0H                                                       00740000
         ICM   R5,15,TPLTASK      ITASK SUPPLIED ON REQUEST?            00750000
         BNZ   *+6                YES, CONTINUE                         00760000
         LR    R5,R10             ADDR OF CURRENT ITASK                 00770000
T        USING ITASK,R5           ESTAB ADDR TO ITASK                   00780000
                                                                        00790000
         TM    T.TSKFLGS3,TSK3$AFF TASK CREATED WITH TCBAFF=YES? 159456 00800000
         BZ    EVIN_SRV            NO, LOCATE SERVER PARENT      159456 00810000
                                                                        00820000
         L     R2,=A(#MAXEVNT)    ASSUME MAX EVENTS TABLE SIZE   159456 00830000
         ICM   R0,15,T.TSKOWNR    IS THIS THE ROOT ITASK?        159456 00840000
         BZ    EVIN_CRE           YES, CONTINUE                  159456 00850000
         CLI   T.TSKTYPE,TSKT$SRV SERVER ITASK?                         00860000
         BE    EVIN_CRE           YES, CONTINUE WITH MAX EVENTS         00870000
         L     R2,ICTEVNSZ        RETRIEVE EVENTS TABLE SIZE     159456 00880000
                                                                        00890000
EVIN_CRE DS    0H                                                       00900000
         EVENTS  ENTRIES=(R2)     INITIALIZE EVENTS TABLE               00910000
         ST    R1,T.TSKEVNT       ADDR OF EVENTS TABLE                  00920000
         B     RET00              RETURN NORMAL                         00930000
                                                                        00940000
*--------------------------------------------------------------- 159456 00950000
*  Retrieve the events table address from the Server ITASK.      159456 00960000
*--------------------------------------------------------------- 159456 00970000
EVIN_SRV DS    0H                                                159456 00980000
         ICM   R6,15,T.TSKSVTSK   ADDRESS OF SERVER ITASK        159456 00990000
         BZ    ERR_SERV           INVALID SERVER ITASK           159456 01000000
S        USING ITASK,R6           PARENT ITASK ADDRESSABILITY    159456 01010000
                                                                        01020000
         MVC   T.TSKEVNT,S.TSKEVNT  ADDR OF SERVER EVENTS TABLE  159456 01030000
         B     RET00              RETURN NORMAL                  159456 01040000
         DROP  S                  ITASK (PARENT)                 159456 01050000
                                                                        01060000
         EJECT ,                                                        01070000
****************************************************************        01080000
*                                                                       01090000
*  RETURN                                                               01100000
*                                                                       01110000
****************************************************************        01120000
                                                                        01130000
ERR_SERV DS    0H                                                159456 01140000
         LA    R0,RSN04           SERVER TASK NOT AVAILABLE      159456 01150000
         B     RET12                                             159456 01160000
                                                                        01170000
*---------------------------------------------------------------        01180000
RET00    DS    0H                                                159456 01190000
         LA    R15,RC00           NORMAL COMPLETION              159456 01200000
         B     RETURN             RETURN                         159456 01210000
                                                                        01220000
RET12    DS    0H                                                159456 01230000
         LA    R15,RC12           SERVICE FAILURE                159456 01240000
         B     RETURN             RETURN                         159456 01250000
                                                                        01260000
RETURN   DS    0H                                                       01270000
         #EXIT ,                  RETURN                                01280000
                                                                        01290000
         EJECT ,                                                        01300000
****************************************************************        01310000
*                                                                       01320000
*  CONSTANTS AND LITERALS                                               01330000
*                                                                       01340000
****************************************************************        01350000
                                                                        01360000
         LTORG ,                                                        01370000
                                                                        01380000
         PRINT NOGEN                                                    01390000
         ICVT  ,                                                        01400000
         ITASK ,                                                        01410000
                                                                        01420000
         IHAPSA ,                                                       01430000
         CVT   DSECT=YES,LIST=NO                                        01440000
         IKJTCB ,                                                       01450000
         PRINT GEN                                                      01460000
                                                                        01470000
         END   ,                                                        01480000

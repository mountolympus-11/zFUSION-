IRUNAAPC TITLE '- AAP# SERVICE, ACQUIRE AAP COUNT BY STATE'             00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE:  IRUNAAPC - AAP# service, acquire AAP count by state         00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine implements the VDB virtual session tally              00080000
*    service described in the AAP# macro.                               00090000
*                                                                       00100000
*                                                                       00110000
* METHOD:                                                               00120000
*                                                                       00130000
*    Active and terminating virtual sessions with host                  00140000
*    applications are represented by an AAP block chained off           00150000
*    IUSER.USRAPPLQ.  Each AAP contains a summary of the                00160000
*    virtual session state and use in AAPFLAG1 allowing AAPs            00170000
*    to be matched to the state specified on entry.                     00180000
*                                                                       00190000
*                                                                       00200000
* LINKAGE:                                                              00210000
*                                                                       00220000
*    Invoked via the AAP# macro                                         00230000
*    Standard BASR linkage                                              00240000
*    No savearea allocated                                              00250000
*                                                                       00260000
*                                                                       00270000
* ON ENTRY:                                                             00280000
*                                                                       00290000
*    R1  address of an IUSER block or zero to designate the             00300000
*        current IUSER                                                  00310000
*                                                                       00320000
*    R0  an AAP session state code as generated by AAP# DSECT=YES       00330000
*                                                                       00340000
*                                                                       00350000
* ON EXIT:                                                              00360000
*                                                                       00370000
*    R15 contains one of the following return codes                     00380000
*                                                                       00390000
*        RC00 - request complete                                        00400000
*                                                                       00410000
*               R0 - number of matching AAPs                            00420000
*               R1 - IUSER block address                                00430000
*                                                                       00440000
*        RC04 - IUSER block not available                               00450000
*                                                                       00460000
*               R0 - zero                                               00470000
*               R1 - IUSER block address                                00480000
*                                                                       00490000
**<DOC-OFF>****************************************************         00500000
                                                                        00510000
         EJECT                                                          00520000
***************************************************************         00530000
*                                                                       00540000
*  Maintenance:                                                         00550000
*                                                                       00560000
*    01/12/96  R. Turgeon         Rel 2.1                               00570000
*              Initial version                                          00580000
*                                                                       00590000
***************************************************************         00600000
                                                                        00610000
         EJECT                                                          00620000
         AAP#  DSECT=YES          CONSTANTS, MAPPINGS                   00630000
                                                                        00640000
         EJECT                                                          00650000
         NAV   ,                  NAVIGATION BLOCKS INCLUDING AAP       00660000
                                                                        00670000
         EJECT                                                          00680000
         IUSER ,                  USER BLOCK                            00690000
                                                                        00700000
         EJECT                                                          00710000
         EQUS  ,                                                        00720000
                                                                        00730000
         EJECT                                                          00740000
IRUNAAPC #ENTER SAVE=NO,PREG=(R6,R7)                                    00750000
                                                                        00760000
         USING ITASK,R10          STDENV                                00770000
                                                                        00780000
         EJECT                                                          00790000
***************************************************************         00800000
*                                                                       00810000
*   Locate the designated IUSER anchor block                            00820000
*                                                                       00830000
***************************************************************         00840000
                                                                        00850000
         LTR   R6,R6              IUSER PROVIDED?                       00860000
         BNZ   USER_LOC           DONE IF SO                            00870000
                                                                        00880000
         L     R9,TSKPCBC         CURRENT PROCESS                       00890000
         ICM   R6,15,PCBUSER-IPCB(R9)   IUSER ALLOCATED?                00900000
         BZ    WRN_USER           WARNING OTHERWISE                     00910000
                                                                        00920000
USER_LOC DS    0H                                                       00930000
                                                                        00940000
         USING IUSER,R6           LIFE OF FUNCTION                      00950000
                                                                        00960000
***************************************************************         00970000
*                                                                       00980000
*   Accumulate AAP counters by state                                    00990000
*                                                                       01000000
***************************************************************         01010000
                                                                        01020000
         SR    R1,R1              ALL                                   01030000
         SR    R2,R2              UP, RUNNING SESSIONS                  01040000
         SR    R3,R3              TERMINATING / TERMINATED SESSIONS     01050000
         SR    R4,R4              SESSIONS DRIVEN BY LAST VDB REQUEST   01060000
                                                                        01070000
         ICM   R8,15,USRAPPLQ     ANY AAPS?                             01080000
         BZ    COMPLETE           TALLY COMPLETE IF NOT                 01090000
         USING AAP,R8                                                   01100000
                                                                        01110000
*--------------------------------------------------------------         01120000
*   Tally loop                                                          01130000
*--------------------------------------------------------------         01140000
                                                                        01150000
NEXT_AAP DS    0H                                                       01160000
         LA    R1,1(,R1)          ACCOUNT FOR AAP                       01170000
                                                                        01180000
         TM    AAPFLAG1,AAPFRAN   DRIVEN FOR VDB OPERATION?             01190000
         BNO   *+8                SKIP IF NOT                           01200000
         LA    R4,1(,R4)          RAN                                   01210000
                                                                        01220000
         TM    AAPFLAG1,AAPFTERM  TERMINATING?                          01230000
         BNO   NTERM              SKIP IF NOT                           01240000
         LA    R3,1(,R3)          TERM                                  01250000
         B     ADV_AAP                                                  01260000
                                                                        01270000
NTERM    DS    0H                                                       01280000
         TM    AAPFLAG1,AAPFUP    RUNNING?                              01290000
         BNO   ADV_AAP            SKIP IF NOT (STRANGE)                 01300000
         LA    R2,1(,R2)          UP                                    01310000
                                                                        01320000
ADV_AAP  DS    0H                 SCAN ALL AAPS                         01330000
         ICM   R8,15,AAPNEXT      NEXT AAP                              01340000
         BNZ   NEXT_AAP           CONTINUE                              01350000
         DROP  R8                 AAP                                   01360000
                                                                        01370000
***************************************************************         01380000
*                                                                       01390000
*   Return completion status to caller                                  01400000
*                                                                       01410000
***************************************************************         01420000
                                                                        01430000
COMPLETE DS    0H                 TALLY COMPLETE                        01440000
         LA    R15,RC00           INDICATE SUCCESS                      01450000
         SR    R0,R0              NO MATCHES IF UNRECOGNIZED REQUEST    01460000
                                                                        01470000
         CH    R7,=AL2(AAP#SCN_ALL)  ALL AAPS?                          01480000
         BNE   *+6                                                      01490000
         LR    R0,R1                                                    01500000
                                                                        01510000
         CH    R7,=AL2(AAP#SCN_UP)   RUNNING SESSIONS?                  01520000
         BNE   *+6                                                      01530000
         LR    R0,R2                                                    01540000
                                                                        01550000
         CH    R7,=AL2(AAP#SCN_TERM) TERMINATED / TERMINATING SESSIONS? 01560000
         BNE   *+6                                                      01570000
         LR    R0,R3                                                    01580000
                                                                        01590000
         CH    R7,=AL2(AAP#SCN_RAN)  DRIVEN SESSION?                    01600000
         BNE   *+6                                                      01610000
         LR    R0,R4                                                    01620000
         B     RETURN             COMPLETE                              01630000
                                                                        01640000
*--------------------------------------------------------------         01650000
*   IUSER block not available                                           01660000
*--------------------------------------------------------------         01670000
                                                                        01680000
WRN_USER DS    0H                 IUSER NOT AVAILABLE                   01690000
         LA    R15,RC04           WARNING                               01700000
         SR    R0,R0              NO APPS                               01710000
                                                                        01720000
*--------------------------------------------------------------         01730000
*   Return to caller                                                    01740000
*--------------------------------------------------------------         01750000
                                                                        01760000
RETURN   DS    0H                                                       01770000
         LA    R1,IUSER           RETURN / ECHO IUSER                   01780000
                                                                        01790000
         #EXIT ,                                                        01800000
                                                                        01810000
         EJECT                                                          01820000
***************************************************************         01830000
*                                                                       01840000
*   Local read-only data areas, etc.                                    01850000
*                                                                       01860000
***************************************************************         01870000
                                                                        01880000
         LTORG ,                                                        01890000
                                                                        01900000
         EJECT                                                          01910000
         PRINT NOGEN                                                    01920000
         ICVT  ,                                                        01930000
         ITASK ,                                                        01940000
         IPCB  ,                                                        01950000
         END   ,                                                        01960000

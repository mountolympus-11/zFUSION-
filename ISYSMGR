ISYSMGR TITLE 'INTEGRATOR - SYSTEMS RESOURCE MANAGER'                   00010000
**<DOC-ON>************************************************************* 00020000
*                                                                       00030000
* ROUTINE: ISYSMGR - INTEGRATOR SYSTEMS RESOURCE MANAGER                00040000
*                                                                       00050000
* DESCRIPTION: 1) PERFORM CLEANUP FOR SYSTEMS DRIVER PROCESS TERM       00060000
*                                                                       00070000
* ON ENTRY:                                                             00080000
*                                                                       00090000
*    R15 = ENTRY POINT ADDRESS                                          00100000
*    R14 = RETURN ADDRESS                                               00110000
*    R13 = AVAILABLE SAVE AREA                                          00120000
*    R11 = ICVT ADDRESS                                                 00130000
*    R10 = ITASK ADDRESS                                                00140000
*    R01 = IVUSER TOKEN WORK OF CONNECTION                              00150000
*                                                                       00160000
* ON EXIT:                                                              00170000
*                                                                       00180000
*    R15 = 0                                                            00190000
*    R00 = 0                                                            00200000
*    R01 = 0                                                            00210000
*                                                                       00220000
*    ALL OTHER REGISTERS ARE RESTORED                                   00230000
*                                                                       00240000
*                                                                       00250000
**<DOC-OFF>************************************************************ 00260000
                                                                        00270000
         EJECT ,                                                        00280000
*********************************************************************** 00290000
*                                                                       00300000
* MAINTENANCE:                                                          00310000
*                                                                       00320000
*   04/15/94 RANDY WITEK                                                00330000
*                                                                       00340000
*********************************************************************** 00350000
                                                                        00360000
         EQUS  ,                  GENERAL EQUATES                       00370000
                                                                        00380000
RICVT    EQU   R11                                                      00390000
RITASK   EQU   R10                                                      00400000
RIVTAM   EQU   R9                 ISYSRU EXPECTS THIS                   00410000
RIPCB    EQU   R8                 ISYSRU EXPECTS THIS                   00420000
RISY     EQU   R7                 ISYSRU EXPECTS THIS                   00430000
RTOKEN   EQU   R6                                                       00440000
                                                                        00450000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00460000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00470000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00480000
         USING ISY,RISY           ESTABLISH ADDRESSABILITY              00490000
                                                                        00500000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00510000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00520000
WRK256   DS    XL256              GENERAL WORKAREA                      00530000
RETR15   DS    F                  RETURN CODE VALUE                     00540000
RETR0    DS    F                  RETURN REGISTER 0                     00550000
RETR1    DS    F                  RETURN REGISTER 1                     00560000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00570000
FLAG     DS    X                                                        00580000
FLAGLOCK EQU   X'80'              VTAM GLOBAL LOCK HELD                 00590000
FLAGLCKD EQU   X'40'              VTAM GLOBAL LOCK HELD ON ENTRY        00600000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00610000
                                                                        00620000
         $MSGDFT PREFIX=ICTPID,                                        +00630000
               COMPID='VTM',                                           +00640000
               TABLE=*#MSGS,                                           +00650000
               WORKA=0,                                                +00660000
               MF=(E,WRK256),                                          +00670000
               PRINT=NOGEN                                              00680000
                                                                        00690000
ISYSMGR  #ENTER BASE=R12,         ENTRY LINKAGE                        +00700000
               PREG=RTOKEN,                                            +00710000
               AMODE=31,                                               +00720000
               RMODE=ANY                                                00730000
                                                                        00740000
*---------------------------------------------------------------------- 00750000
* PROCESS ISYS DRIVER PROCESS TERMINATION                               00760000
*---------------------------------------------------------------------- 00770000
                                                                        00780000
         L     RIVTAM,ICTVTCVT    VTAM CVT ADDRESSIBILITY               00790000
         SR    RIPCB,RIPCB        SHOW NO IPCB                          00800000
                                                                        00810000
*                                                                       00820000
* LOCATE THE ISYS BLOCK FOR THE SPECIFIED APPLID                        00830000
*---------------------------------------------------------------------- 00840000
                                                                        00850000
         BAS   R14,VTAMLOCK       OBTAIN VTAM GLOBAL SERIALIZATION      00860000
                                                                        00870000
         LA    RISY,IVTSY1ST             ADDRESS OF ISYS CHAIN HEAD     00880000
         S     RISY,=A(ISYNEXT-ISY)      NORMALIZE FOR CHAIN RUN        00890000
                                                                        00900000
FNDRNCHN DS    0H                                                       00910000
                                                                        00920000
         ICM   RISY,15,ISYNEXT           LINK TO NEXT ISYS              00930000
         BM    NOTFOUND                  SPECIFIED TOKEN NOT FOUND      00940000
         C     RTOKEN,ISYTKUSR           COMPARE THE TOKENS             00950000
         BNE   FNDRNCHN                  KEEP LOOKING IF UNEQUAL        00960000
         TM    ISYF1,ISYF1ACT            IS ISYS ACTIVE?                00970000
         BNO   NOTFOUND                  BRANCH IF NOT, NO CLEANUP      00980000
                                                                        00990000
         BAS   R14,VTAMUNLK       RELEASE VTAM GLOBAL SERIALIZATION     01000000
                                                                        01010000
*                                                                       01020000
* CLEAN UP THE ISYS BLOCK (MUST BE ABNORMAL TERMINATION)                01030000
*---------------------------------------------------------------------- 01040000
                                                                        01050000
*                                                                       01060000
* PERFORM CLEANUP OF ANY ACTIVE TRANSACTIONS                            01070000
*---------------------------------------------------------------------- 01080000
                                                                        01090000
         LA    R1,ISYPTWA         PRI-TO-SEC ITWA ADDRESS               01100000
         O     R1,=X'80000000'    MARK PARM AS ITWA ADDRESS             01110000
         L     R0,=F'-1'          CLEANUP TRANSACTION CODE              01120000
         L     R15,ISY@RU         TRANSACTION PROGRAM ROUTER            01130000
         BASR  R14,R15            CALL THE ROUTER TO CLEANUP TP         01140000
                                                                        01150000
         LA    R0,ISYPTWA         PRI-TO-SEC ITWA ADDRESS               01160000
         LA    R1,L'ITWMAX        LENGTH OF ITWA                        01170000
         SR    R15,R15            ZERO LENGTH AND ZERO PAD              01180000
         MVCL  R0,R14             CLEAR THE ITWA                        01190000
                                                                        01200000
         LA    R1,ISYSTWA         SEC-TO-PRI ITWA ADDRESS               01210000
         O     R1,=X'80000000'    MARK PARM AS ITWA ADDRESS             01220000
         L     R0,=F'-1'          CLEANUP TRANSACTION CODE              01230000
         L     R15,ISY@RU         TRANSACTION PROGRAM ROUTER            01240000
         BASR  R14,R15            CALL THE ROUTER TO CLEANUP TP         01250000
                                                                        01260000
         LA    R0,ISYSTWA         SEC-TO-PRI ITWA ADDRESS               01270000
         LA    R1,L'ITWMAX        LENGTH OF ITWA                        01280000
         SR    R15,R15            ZERO LENGTH AND ZERO PAD              01290000
         MVCL  R0,R14             CLEAR THE ITWA                        01300000
                                                                        01310000
*                                                                       01320000
* PERFORM CLEANUP OF ISYS                                               01330000
*---------------------------------------------------------------------- 01340000
                                                                        01350000
         BAS   R14,VTAMLOCK       SERIALIZE THE ISYS                    01360000
                                                                        01370000
         XC    ISYTNAME,ISYTNAME  CLEAR TASK NAME                       01380000
         XC    ISYPNAME,ISYPNAME  CLEAR PROC NAME                       01390000
         XC    ISYITASK,ISYITASK  CLEAR ITASK ADDRESS                   01400000
         XC    ISYIPCB,ISYIPCB    CLEAR IPCB ADDRESS                    01410000
         XC    ISYTK,ISYTK        CLEAR SESSION TOKEN                   01420000
         XC    ISYRMSG#,ISYRMSG#  CLEAR COUNTERS                        01430000
         XC    ISYRBYT#,ISYRBYT#  CLEAR COUNTERS                        01440000
         XC    ISYSMSG#,ISYSMSG#  CLEAR COUNTERS                        01450000
         XC    ISYSBYT#,ISYSBYT#  CLEAR COUNTERS                        01460000
         NI    ISYF1,255-ISYF1ACT CLEAR "STARTED" FLAG                  01470000
         NI    ISYF1,255-ISYF1DRN CLEAR "DRAINING" FLAG                 01480000
         NI    ISYF1,255-ISYF1ORI CLEAR "ORIGINATOR" FLAG               01490000
                                                                        01500000
*                                                                       01510000
* DESERIALIZE AND EXIT                                                  01520000
*---------------------------------------------------------------------- 01530000
                                                                        01540000
NOTFOUND DS    0H                                                       01550000
                                                                        01560000
         BAS   R14,VTAMUNLK       RELEASE VTAM GLOBAL SERIALIZATION     01570000
                                                                        01580000
         B     RETURN                                                   01590000
                                                                        01600000
*---------------------------------------------------------------------- 01610000
* RETURN TO CALLER                                                      01620000
*---------------------------------------------------------------------- 01630000
                                                                        01640000
RETURN   DS    0H                                                       01650000
                                                                        01660000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 01670000
                                                                        01680000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    01690000
                                                                        01700000
*---------------------------------------------------------------------- 01710000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 01720000
*---------------------------------------------------------------------- 01730000
                                                                        01740000
VTAMLOCK DS    0H                                                       01750000
                                                                        01760000
         TM    FLAG,FLAGLOCK        WAS THE LOCK ALREAY OBTAINED?       01770000
         BOR   R14                  RETURN IF YES                       01780000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             01790000
                                                                        01800000
         $SER  OBTAIN,                                                 +01810000
               VTAM                                                     01820000
                                                                        01830000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              01840000
         BNE   VTAMLOEX             BRANCH IF NOT                       01850000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         01860000
                                                                        01870000
VTAMLOEX DS    0H                                                       01880000
                                                                        01890000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               01900000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          01910000
         BR    R14                  RETURN                              01920000
                                                                        01930000
*---------------------------------------------------------------------- 01940000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                01950000
*---------------------------------------------------------------------- 01960000
                                                                        01970000
VTAMUNLK DS    0H                                                       01980000
                                                                        01990000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       02000000
         BNOR  R14                  BRANCH IF NOT                       02010000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             02020000
         BOR   R14                  DON'T RELEASE IF IT WAS             02030000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             02040000
                                                                        02050000
         $SER  RELEASE,                                                +02060000
               VTAM                                                     02070000
                                                                        02080000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  02090000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          02100000
         BR    R14                  RETURN                              02110000
                                                                        02120000
*---------------------------------------------------------------------- 02130000
* LITERALS                                                              02140000
*---------------------------------------------------------------------- 02150000
                                                                        02160000
         LTORG ,                                                        02170000
                                                                        02180000
*---------------------------------------------------------------------- 02190000
* DSECTS                                                                02200000
*---------------------------------------------------------------------- 02210000
                                                                        02220000
         PRINT NOGEN                                                    02230000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                02240000
         ISTDBIND ,               VTAM BIND IMAGE                       02250000
         ISTRH ,                  VTAM SNA RH                           02260000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         02270000
         ICVT  ,                  INTEGRATOR CVT                        02280000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   02290000
         IRPL ,                   INTEGRATOR VTAM RPL+                  02300000
         IACB ,                   INTEGRATOR VTAM ACB+                  02310000
         INIB ,                   INTEGRATOR VTAM NIB+                  02320000
         ISESS ,                  INTEGRATOR SESSION BLOCK              02330000
         IRQE ,                   INTEGRATOR REQUEST QUEUE ELEMENT      02340000
         IPOOL ,                  INTEGRATOR POOL BLOCK                 02350000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            02360000
         ITASK ,                  INTEGRATOR TASK BLOCK                 02370000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          02380000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       02390000
         EVCODES ,                INTEGRATOR EVENT CODES                02400000
         ABCODES ,                INTEGRATOR $ABEND CODES               02410000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     02420000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        02430000
         $SYSTEMS DSECT=YES       INTEGRATOR $SYSTEMS SERVICES          02440000
         END   ,                                                        02450000

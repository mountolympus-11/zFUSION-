ICAT$DEF TITLE '- SPACETYP DEFINE SERVICE'                              00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: ICAT$DEF - SPACETYP DEFINE service                           00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine is invoked by the SPACETYP macro to create            00080000
*    an object space content (OSC) block that associates an             00090000
*    object space type code with a set of predefined tables             00100000
*    declared using SCTDEF.  These tables are generically               00110000
*    referred to as the catalog for that space.                         00120000
*                                                                       00130000
*    OSC blocks are acquired from the STGMGR global storage             00140000
*    pool and queued to ICVT.ICTOSCQ after verifying that the           00150000
*    type code provided is not already in use.                          00160000
*                                                                       00170000
*    If the requester has extended the length of the standard           00180000
*    SCTDEF entry, the composite entry length must be provided          00190000
*    and must be at least as long as the standard SCTDEF entry.         00200000
*                                                                       00210000
*                                                                       00220000
* NOTES:                                                                00230000
*                                                                       00240000
*    The SCTDEFs provided by the caller are appended to the             00250000
*    OSC, allowing the requester to free its own storage,               00260000
*    supporting RELOAD, etc.                                            00270000
*                                                                       00280000
*                                                                       00290000
* ON ENTRY:                                                             00300000
*                                                                       00310000
*    R1  contains the address of a parameter list constructed           00320000
*        as follows:                                                    00330000
*                                                                       00340000
*        +00 - space type code value in the range of 0-255 or           00350000
*              the address of a type code byte.                         00360000
*                                                                       00370000
*        +04 - the number of SCTDEFs provided                           00380000
*                                                                       00390000
*        +08 - SCTDEF list origin                                       00400000
*                                                                       00410000
*        +12 - length of each SCTDEF entry.  If zero, the               00420000
*              standard length is assumed.                              00430000
*                                                                       00440000
*                                                                       00450000
* ON EXIT:                                                              00460000
*                                                                       00470000
*    R15 contains one of the following return codes                     00480000
*                                                                       00490000
*        RC00 - OSC created and queued                                  00500000
*                                                                       00510000
*               R1 - addr of the OSC                                    00520000
*                                                                       00530000
*        RC04 - improper or duplicate definition                        00540000
*                                                                       00550000
**<DOC-OFF>****************************************************         00560000
                                                                        00570000
         EJECT                                                          00580000
***************************************************************         00590000
*                                                                       00600000
*  MAINTENANCE:                                                         00610000
*                                                                       00620000
*    01/25/95  R. Turgeon    virtual catalog support                    00630000
*              Initial version                                          00640000
*                                                                       00650000
***************************************************************         00660000
                                                                        00670000
         EJECT                                                          00680000
         #WORK ,                                                        00690000
         #ENDWORK                                                       00700000
                                                                        00710000
         EJECT                                                          00720000
         SPACETYP DSECT=YES  OBJECT SPACE CONTENT BLOCK                 00730000
                                                                        00740000
         EJECT                                                          00750000
         SCTDEF DSECT=YES    SPACE COMPONENT TABLE DEFINITION           00760000
                                                                        00770000
         EJECT                                                          00780000
         EQUS  ,                                                        00790000
                                                                        00800000
         EJECT                                                          00810000
ICAT$DEF #ENTER PREG=R8                                                 00820000
                                                                        00830000
         EJECT                                                          00840000
***************************************************************         00850000
*                                                                       00860000
*   FETCH AND VALIDATE THE PASSED PARAMETERS.  ACQUIRE THE              00870000
*   CANDIDATE SPACE TYPE CODE AND ENSURE THAT IT IS NOT ALREADY         00880000
*   DEFINED.                                                            00890000
*                                                                       00900000
***************************************************************         00910000
                                                                        00920000
         LM    R4,R7,0(R8)        FETCH PASSED PARMS                    00930000
*                                 R4 <== SPACE IDENTIFIER (TYPE CODE)   00940000
*                                 R5 <== SCTDEF COUNT                   00950000
*                                 R6 <== SCTDEF LIST ORIGIN             00960000
*                                 R7 <== SCTDEF ENTRY LENGTH OR ZERO    00970000
                                                                        00980000
         LTR   R7,R7              SCTDEF ENTRY LENGTH EXTENDED?         00990000
         BNZ   *+8                SKIP IF SO                            01000000
         LA    R7,SCT_DEF_LENGTH  USE DEFAULT LENGTH                    01010000
         CH    R7,=AL2(SCT_DEF_LENGTH)                                  01020000
         BL    ERR_DEF            INVALID ENTRY LENGTH                  01030000
                                                                        01040000
         CL    R4,=A(FF)          ID VALUE PROVIDED?                    01050000
         BNH   PARMID             SKIP IF SO                            01060000
         SR    R0,R0              PREPARE FOR INSERT                    01070000
         IC    R0,0(,R4)          FETCH ID                              01080000
         LR    R4,R0              MODULE CONVENTION                     01090000
                                                                        01100000
PARMID   DS    0H                                                       01110000
                                                                        01120000
*--------------------------------------------------------------         01130000
*   ENSURE TYPE CODE AVAILABLE FOR USE                                  01140000
*--------------------------------------------------------------         01150000
         ICM   R9,15,ICTOSCQ      INIT OSC QUEUE SCAN                   01160000
         BZ    SDEFAVAL           NO OSCS, ID IS AVAILABLE              01170000
         USING OSC,R9                                                   01180000
                                                                        01190000
SDEFNEXT DS    0H                                                       01200000
         CLM   R4,1,OSCSTYPE      TYPE CODE ALREADY DECLARED?           01210000
         BE    ERR_DEF            REJECT IF SO                          01220000
         ICM   R9,15,OSCNEXT      ELSE ADVANCE TO NEXT DEFINITION       01230000
         BNZ   SDEFNEXT           AGAIN                                 01240000
                                                                        01250000
SDEFAVAL DS    0H                                                       01260000
                                                                        01270000
***************************************************************         01280000
*                                                                       01290000
*   COMPUTE THE STORAGE LENGTH REQUIRED AS THE SUM OF THE OSC           01300000
*   SIZE PLUS (SCTDEF COUNT * SCTDEF ENTRY LENGTH). ACQUIRE             01310000
*   THE APPROPRIATE STORAGE FROM A GLOBAL STORAGE POOL.                 01320000
*                                                                       01330000
***************************************************************         01340000
         LR    R1,R5              SCTDEF ENTRY COUNT                    01350000
         MR    R0,R7              TIMES THE ENTRY LENGTH                01360000
         LR    R3,R1              RETAIN LENGTH OF SCTDEF LIST          01370000
         LA    R2,OSCLN(,R1)      TOTAL SPACE REQUIREMENT               01380000
                                                                        01390000
         STGGET (R2),QH=ICTSTG    ACQUIRE GLOBAL, CLEAR STG             01400000
                                                                        01410000
         BNZ   ERR_DEF            NOT AVAILABLE, REJECT                 01420000
                                                                        01430000
*--------------------------------------------------------------         01440000
*   COMPLETE THE OSC APPENDING THE SOURCE SCTDEF TABLE                  01450000
*--------------------------------------------------------------         01460000
         LR    R9,R1              OSC ADDRESSABILITY                    01470000
         USING OSC,R9                                                   01480000
                                                                        01490000
         MVC   OSCEYE,=CL4'OSC'   CONTROL BLOCK ID                      01500000
         ST    R2,OSCLENG         TOTAL STORAGE LENGTH                  01510000
         STC   R4,OSCSTYPE        SPACE TYPE CODE (ID)                  01520000
         STH   R5,OSCSCTN         SCTDEF ENTRY COUNT                    01530000
         ST    R7,OSCSCTL         SCTDEF ENTRY LENGTH                   01540000
         LA    R0,OSC+OSCLN       APPEND SOURCE SCTDEFS                 01550000
         ST    R0,OSCSCTA         NEW SCTDEF ORIGIN                     01560000
                                                                        01570000
         LR    R14,R6             SOURCE SCTDEFS                        01580000
         LR    R1,R3              SCTDEF LIST LENGTH                    01590000
         LR    R15,R3             SOURCE LENGTH = TARGET LENGTH         01600000
         MVCL  R0,R14             MAKE PERM COPY                        01610000
                                                                        01620000
*--------------------------------------------------------------         01630000
*   ADD THE NEW OSC TO THE GLOBAL OSC QUEUE                             01640000
*--------------------------------------------------------------         01650000
         L     R1,ICTOSCQ         ADDR OF CURRENT TOP OF STACK          01660000
         ST    R1,OSCNEXT         SET FORWARD LINK                      01670000
         CS    R1,R9,ICTOSCQ      INTERLOCKED PUSH                      01680000
         BNE   *-8                UNTIL IT STICKS                       01690000
                                                                        01700000
***************************************************************         01710000
*                                                                       01720000
*   RETURN COMPLETION STATUS TO REQUESTER                               01730000
*                                                                       01740000
***************************************************************         01750000
         LA    R15,RC00           INDICATE SUCCESS                      01760000
         LA    R1,OSC             RETURN THE NEW OSC BLOCK              01770000
         B     EXIT                                                     01780000
                                                                        01790000
ERR_DEF  DS    0H                 INVALID OR DUPLICATE REQUEST          01800000
         LA    R15,RC04           INDICATE ERROR                        01810000
                                                                        01820000
EXIT     DS    0H                                                       01830000
                                                                        01840000
         #EXIT                                                          01850000
                                                                        01860000
         DROP  R9                                                       01870000
                                                                        01880000
         EJECT                                                          01890000
***************************************************************         01900000
*                                                                       01910000
*   LOCAL READ-ONLY WORKING STORAGE                                     01920000
*                                                                       01930000
***************************************************************         01940000
         LTORG ,                                                        01950000
                                                                        01960000
         PRINT NOGEN                                                    01970000
         ICVT ,                                                         01980000
         END   ,                                                        01990000

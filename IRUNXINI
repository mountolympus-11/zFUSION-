IRUNXINI TITLE '- PLAN EXECUTION INITIALIZATION'                        00010000
**<DOC-ON>*******************************************************       00020000
*                                                                       00030000
* ROUTINE:  IRUNXINI - Plan execution initialization                    00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine is used to establish resource managers for            00080000
*    jointly managed data areas created to support plan                 00090000
*    execution.  The resource manager is established under the          00100000
*    DISP lock to ensure that the requesting process does not           00110000
*    terminate and tear down shared data areas during this              00120000
*    initialization.                                                    00130000
*                                                                       00140000
*                                                                       00150000
* ON ENTRY:                                                             00160000
*                                                                       00170000
*    R1  contains the address of the SLU session handle (SLUHANDL)      00180000
*                                                                       00190000
*                                                                       00200000
* ON EXIT:                                                              00210000
*                                                                       00220000
*    R15 contains one of the following return codes                     00230000
*                                                                       00240000
*        RC00 - function complete                                       00250000
*                                                                       00260000
*        RC04 - requesting workunit has terminated                      00270000
*                                                                       00280000
**<DOC-OFF>******************************************************       00290000
                                                                        00300000
         EJECT                                                          00310000
*****************************************************************       00320000
*                                                                       00330000
* MAINTENANCE:                                                          00340000
*                                                                       00350000
*    12/18/95 R. Turgeon          Rel 2.1                               00360000
*             Initial version                                           00370000
*                                                                       00380000
*****************************************************************       00390000
                                                                        00400000
         EJECT                                                          00410000
         SLUHANDL ,               SLU SESSION HANDLE (COMM AREA)        00420000
                                                                        00430000
         EJECT                                                          00440000
         NAV   ,                  NAVIGATION STRUCTURES, INCLUDING AAP  00450000
                                                                        00460000
         EJECT                                                          00470000
         $NAVPARM ,               COLUMN / VARIABLE RELATIONSHIPS       00480000
                                                                        00490000
         EJECT                                                          00500000
         $RESMGR DSECT=YES        RESOURCE MANAGER PLIST                00510000
                                                                        00520000
         EJECT                                                          00530000
         $WUSTAT DSECT=YES        WU STATUS SERVICE                     00540000
                                                                        00550000
         EJECT                                                          00560000
         EQUS  ,                  GENERAL EQUATES                       00570000
                                                                        00580000
         EJECT                                                          00590000
         #WORK ,                                                        00600000
                                                                        00610000
ENVFLGS  DS    X                  ENVIRONMENTAL FLAGS                   00620000
ENVLOCK  EQU   X'80'                 DISP LOCK ACQUIRED                 00630000
                                                                        00640000
RSVD1    DS    XL3                RESERVED                              00650000
                                                                        00660000
STATREGS DS    3F                 R15-R1 STATUS REGS                    00670000
REGSAVE  DS    16F                LOCAL SUBROUTINE SAVEAREA #1          00680000
                                                                        00690000
$RESMFL  $RESMGR MF=(L,*)         $RESMGR PLIST CONSTRUCTION            00700000
$WUMFL   $WUSTAT MF=(L,*)         $WUSTAT PLIST CONSTRUCTION            00710000
                                                                        00720000
         #ENDWORK ,               WORKAREA END                          00730000
                                                                        00740000
         EJECT                                                          00750000
***************************************************************         00760000
*                                                                       00770000
*   General initialization                                              00780000
*                                                                       00790000
***************************************************************         00800000
                                                                        00810000
IRUNXINI #ENTER PREG=R8                                                 00820000
                                                                        00830000
         USING ITASK,R10          STDENV                                00840000
                                                                        00850000
         EJECT                                                          00860000
***************************************************************         00870000
*                                                                       00880000
*   Determine whether the requesting workunit is still active.          00890000
*   If not, the shared data areas jointly managed by plan               00900000
*   execution and the requester are not (reliably) available.           00910000
*   The DISP lock is acquired to ensure that the requester              00920000
*   does not terminate in flight.                                       00930000
*                                                                       00940000
***************************************************************         00950000
                                                                        00960000
         USING SLUHANDL,R8        SLU SESSION HANDLE                    00970000
                                                                        00980000
         BAS   R14,DISPLOCK       ACQUIRE THE DISP LOCK                 00990000
                                                                        01000000
         $WUSTAT TEST,TOKEN=SLHMPTKN,                                  X01010000
               ERROR=ERR_REQ,TERM=ERR_REQ,                             X01020000
               MF=(E,$WUMFL)                                            01030000
                                                                        01040000
**************************************************************          01050000
*                                                                       01060000
*   Add SQL workarea resource manager                                   01070000
*                                                                       01080000
**************************************************************          01090000
                                                                        01100000
         ICM   R5,15,SLHAAP       ASSOCIATED AAP                        01110000
         BZ    PLNNORMX                                                 01120000
         USING AAP,R5                                                   01130000
                                                                        01140000
         ICM   R3,15,AAPNAVP      ADDRESS OF VDB NAV PARM               01150000
         BZ    PLNNORMX           NO NAVPARM AVAILABLE                  01160000
         USING $NAVPARM,R3        TEMP ADDRESSABILITY                   01170000
                                                                        01180000
         $RESMGR ADD,             ADD SQL WORKAREA RESMGR              X01190000
               TOKEN=AAPSQLTK,    RESMGR TOKEN RETAINED IN AAP         X01200000
               OWNER=*TSKPCBC,    ASSOCIATE WITH DRIVER PROCESS        X01210000
               ROUTINE=*#RMXSQLW,                                      X01220000
               PARM=*IXRRCVPL,                                         X01230000
               USECOUNT=*IXRRCVUS,                                     X01240000
               MF=(E,$RESMFL)                                           01250000
                                                                        01260000
PLNNORMX DS    0H                                                       01270000
         DROP  R3,R5              NAVPARM, AAP                          01280000
                                                                        01290000
         EJECT                                                          01300000
**************************************************************          01310000
*                                                                       01320000
*   Return normal / abnormal termination                                01330000
*                                                                       01340000
**************************************************************          01350000
                                                                        01360000
         LA    R15,RC00           SUCCESSFUL COMPLETION                 01370000
         B     RETURN                                                   01380000
                                                                        01390000
ERR_REQ  DS    0H                 REQUESTING WORKUNIT HAS TERMINATED    01400000
         LA    R15,RC04           INDICATE ERROR                        01410000
                                                                        01420000
*-------------------------------------------------------------          01430000
*   Release acquired locks and exit                                     01440000
*-------------------------------------------------------------          01450000
                                                                        01460000
RETURN   DS    0H                                                       01470000
         STM   R15,R1,STATREGS    PRESERVE ENDING STATUS                01480000
         BAS   R14,DISPUNLK       RELEASE DISP LOCK                     01490000
         LM    R15,R1,STATREGS    RESTORE RETURN CODE                   01500000
                                                                        01510000
         #EXIT ,                  RETURN TO CALLER                      01520000
                                                                        01530000
         EJECT                                                          01540000
***************************************************************         01550000
*                                                                       01560000
* ROUTINE: DISPLOCK - Acquire DISP lock                                 01570000
*                                                                       01580000
***************************************************************         01590000
                                                                        01600000
DISPLOCK DS    0H                                                       01610000
         STM   R0,R15,REGSAVE     PRESERVE MAINLINE REGS                01620000
                                                                        01630000
         $SER  OBTAIN,DISP        ACQUIRE DISP LOCK                     01640000
                                                                        01650000
         BNZ   *+8                BRANCH IF ALREADY OWNED               01660000
         OI    ENVFLGS,ENVLOCK    ELSE INDICATE LOCK ACQUIRED           01670000
                                                                        01680000
         LM    R0,R14,REGSAVE     RESTORE MAINLINE REGS                 01690000
         BR    R14                RETURN                                01700000
                                                                        01710000
         EJECT                                                          01720000
***************************************************************         01730000
*                                                                       01740000
* ROUTINE: DISPUNLK - Release DISP lock                                 01750000
*                                                                       01760000
***************************************************************         01770000
                                                                        01780000
DISPUNLK DS    0H                                                       01790000
         STM   R0,R15,REGSAVE     PRESERVE MAINLINE REGS                01800000
         SR    R15,R15            PRESUME SUCCESS                       01810000
                                                                        01820000
         TM    ENVFLGS,ENVLOCK    LOCK ACQUIRED?                        01830000
         BNO   DISPUNX            NO RELEASE OTHERWISE                  01840000
         NI    ENVFLGS,FF-ENVLOCK INDICATE LOCK NOT HELD                01850000
                                                                        01860000
         $SER  RELEASE,DISP       RELEASE DISP LOCK                     01870000
                                                                        01880000
DISPUNX  DS    0H                                                       01890000
         LM    R0,R14,REGSAVE     RESTORE MAINLINE REGS                 01900000
         BR    R14                RETURN                                01910000
                                                                        01920000
         EJECT                                                          01930000
***************************************************************         01940000
*                                                                       01950000
*   Local read-only constants, etc.                                     01960000
*                                                                       01970000
***************************************************************         01980000
                                                                        01990000
         LTORG ,                                                        02000000
                                                                        02010000
         PRINT NOGEN                                                    02020000
         ICVT  ,                                                        02030000
         ITASK ,                                                        02040000
         END   ,                                                        02050000

ICFGPOOL TITLE '- GENERATE POOL AND ACB DEFINITIONS'                    00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE: ICFGPOOL - GENERATE POOL AND ACB DEFINITIONS                 00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*   This routine retrieves the SYSPOOLS table and generates a           00080000
*   pool control block for each row of the table and allocates          00090000
*   an ACB for the range specified in the SYSPOOLS table.  This         00100000
*   routine is called from the VTAM main task to initially build        00110000
*   the POOLs and ACBs.  This routine is also called when               00120000
*   updates occur to the SYSPOOLS global table.                         00130000
*                                                                       00140000
*   Updates the SYSPOOLs global table forces an attempt to build        00150000
*   the entire POOL and ACB structure over.  If GENPOOL or              00160000
*   GENACB requests fail due to duplicate entries, processing           00170000
*   will continue as normal.  Deleting pool definitions or ACBs         00180000
*   from a range in the SYSPOOLS table will not cause any               00190000
*   deletion of POOLs or ACBs.  The change will become effective        00200000
*   the next time the product is initialized.                           00210000
*                                                                       00220000
*                                                                       00230000
* ENTRY:  R1 Contains the address of the parameter list                 00240000
*         as follows:                                                   00250000
*                                                                       00260000
* EXIT:   R15 will contain one of the following return codes:           00270000
*                                                                       00280000
*             RC00 - Pools and ACBs successfully generated              00290000
*                                                                       00300000
*             RC08 - SYSPOOLS table open failure                        00310000
*                                                                       00320000
*                    R0 = Return code from TBOPEN                       00330000
*                    R1 = Reason code from TBOPEN                       00340000
*                                                                       00350000
*             RC12 - Service failure                                    00360000
*                                                                       00370000
*                    R0 = RSN04 - Table positioning failed              00380000
*                         RSN08 - $VTAM getpool failure                 00390000
*                                                                       00400000
**<DOC-OFF>*****************************************************        00410000
                                                                        00420000
         EJECT ,                                                        00430000
****************************************************************        00440000
*                                                                       00450000
* MAINTENANCE:                                                          00460000
*                                                                       00470000
*    09/07/93 RON COLMONE                                               00480000
*             INITIAL VERSION                                           00490000
*                                                                       00500000
*    12/06/94 R. Turgeon                                                00510000
*             Removed PAGE= / SHRPAGE= for $SPACE, $OBJECT,             00520000
*             and TB* service requests                                  00530000
*                                                                       00540000
****************************************************************        00550000
                                                                        00560000
         EJECT ,                                                        00570000
         ICATALOG POOLS                                                 00580000
                                                                        00590000
         EJECT ,                                                        00600000
         $VTAM DSECT=YES                                                00610000
                                                                        00620000
         EJECT ,                                                        00630000
         EQUS  ,                                                        00640000
                                                                        00650000
         EJECT ,                                                        00660000
         TBSERVIS OPEN,SET,GET                                          00670000
                                                                        00680000
         EJECT ,                                                        00690000
         #WORK ,                                                        00700000
ACBNAME  DS    CL8                GENERATED ACB NAME                    00710000
DIGITS   DS    CL7                ACBNAME SUFFIX                        00720000
$VTM_MFL $VTAM MF=(L,*)           $VTAM PLIST                           00730000
POOLREC  DS    XL(SYSPOLEN)       SYSPOOL RECORD                        00740000
         #ENDWORK ,                                                     00750000
                                                                        00760000
         EJECT ,                                                        00770000
ICFGPOOL #ENTER BASE=R12,PREG=R8                                        00780000
                                                                        00790000
         USING ITASK,R10          ADDRESSABILITY                        00800000
                                                                        00810000
*---------------------------------------------------------------        00820000
*  OPEN TABLE ON INITIAL POOL CONFIGURATION REQUEST                     00830000
*---------------------------------------------------------------        00840000
         ICM   R0,15,ICTSPOOL     SYSPOOLS TABLE AREADY OPEN?           00850000
         BNZ   SET_TOP            YES,  POISITION TO TOP OF TABLE       00860000
                                                                        00870000
         TBOPEN 'SYSPOOLS',       OPEN SYSPOOLS CATALOG TABLE          +00880000
               STOKEN=*ICTSYSP@,                                       +00890000
               TTOKEN=ICTSPOOL,                                        +00900000
               MF=(E,MFE_LIST)                                          00910000
         LTR   R15,R15            SUCCESSFUL COMPLETION?                00920000
         BNZ   ERR_OPEN           TABLE OPEN FAILED                     00930000
                                                                        00940000
*---------------------------------------------------------------        00950000
*  POSITIION SYSPOOLS TABLE TO TOP                                      00960000
*---------------------------------------------------------------        00970000
SET_TOP  DS    0H                                                       00980000
         TBSET TTOKEN=ICTSPOOL,   POSITION AT TOP OF TABLE             +00990000
               POS=TOP,                                                +01000000
               MF=(E,MFE_LIST)                                          01010000
         LTR   R15,R15            SUCCESSFUL COMPLETION?                01020000
         BNZ   ERR_SET            TBSET FAILED                          01030000
                                                                        01040000
         EJECT ,                                                        01050000
*---------------------------------------------------------------        01060000
*  RETRIEVE NEXT SYSPOOLS TABLE ROW                                     01070000
*---------------------------------------------------------------        01080000
GET_POOL DS    0H                                                       01090000
         TBGET POOLREC,           RETRIEVE NEXT SYSPOOL TABLE ROW      +01100000
               LENGTH=L'POOLREC,                                       +01110000
               TTOKEN=ICTSPOOL,                                        +01120000
               POS=NEXT,                                               +01130000
               MF=(E,MFE_LIST)                                          01140000
         LTR   R15,R15            SUCCESSFUL COMPLETION?                01150000
         BNZ   POOL_END           END OF SYSPOOLS ROW                   01160000
                                                                        01170000
         LA    R7,POOLREC         ADDRESS OF POOL RECORD                01180000
         USING SYSPOOLS,R7        ADDRESSABILITY                        01190000
                                                                        01200000
         EJECT ,                                                        01210000
*---------------------------------------------------------------        01220000
*  ALLOCATE ACB POOL                                                    01230000
*---------------------------------------------------------------        01240000
         $VTAM GETPOOL,           ALLOCATE ACB POOL                    +01250000
               POOL=SPOLNAME,     ADDR OF POOL NAME                    +01260000
               TASK=*ICTTSKVT,    TASK OWNING STORAGE                  +01270000
               MF=(E,$VTM_MFL)                                          01280000
                                                                        01290000
         C     R15,=A(RC04)       POOL ALREADY EXIST?                   01300000
         BH    ERR_GETP           NO, ERROR ALLOCATING POOL             01310000
                                                                        01320000
         EJECT ,                                                        01330000
*---------------------------------------------------------------        01340000
*  GENERATE AN ACBNAME FOR EACH ACB IN THE POOL                         01350000
*---------------------------------------------------------------        01360000
         MVC   ACBNAME,SPOLROOT   COPY ACB ROOT NAME                    01370000
         LH    R3,SPOL#ELM        NUMBER OF ELEMENTS IN POOL            01380000
                                                                        01390000
GEN_ACB  DS    0H                                                       01400000
         LR    R1,R3              CURRENT ENTRY                         01410000
         CVD   R1,DWORD           CONVERT SUFFIX TO DECIMAL             01420000
         UNPK  DIGITS,DWORD+4(4)  CONVERT SUFFIX TO EBCDIC              01430000
         OI    DIGITS+L'DIGITS-1,X'F0'    ENSURE SIGN CORRECT           01440000
                                                                        01450000
         LH    R1,SPOLRTLN        LENGTH OF ROOT PREFIX                 01460000
         LA    R1,ACBNAME(R1)     ADDRESS OF NUMERIC EXTENSION          01470000
         LH    R2,SPOLNSLN        LENGTH OF NUMERIC SUFFIX              01480000
         LA    R4,L'DIGITS        LENGTH OF SUFFIX DIGITS               01490000
         SR    R4,R2              OFFSET TO SIGNIFICANT DIGITS          01500000
         LA    R4,DIGITS(R4)      ADDRESS OF SIGNIFICANT DIGITS         01510000
                                                                        01520000
         BCTR  R2,0               PREPARE FOR EX INSTR                  01530000
         EX    R2,*+4             MOVE SUFFIX TO ACBNAME                01540000
         MVC   0(*-*,R1),0(R4)    *** EX OBJECT ***                     01550000
                                                                        01560000
*---------------------------------------------------------------        01570000
*  ALLOCATE ACB FOR EACH ACB IN POOL                                    01580000
*---------------------------------------------------------------        01590000
         $VTAM GETACB,            ALLOCATE AN ACB IN THE POOL          +01600000
               POOL=SPOLNAME,                                          +01610000
               ACBNAME=ACBNAME,                                        +01620000
               TASK=*ICTTSKVT,                                         +01630000
               MF=(E,$VTM_MFL)                                          01640000
                                                                        01650000
         LTR   R15,R15            ACB ALLOCATION SUCCESSFUL?            01660000
         BZ    GEN_NEXT           YES, GENERATE NEXT ACB                01670000
                                                                        01680000
GEN_NEXT DS    0H                                                       01690000
         BCT   R3,GEN_ACB         GENERATE NEXT ACB                     01700000
         B     GET_POOL           RETRIEVE NEXT POOL RECORD             01710000
                                                                        01720000
POOL_END DS    0H                                                       01730000
         LA    R15,RC00           NORMAL COMPLETION                     01740000
         B     RETURN             RETURN                                01750000
         DROP  R7                 SYSPOOLS                              01760000
                                                                        01770000
         EJECT ,                                                        01780000
*---------------------------------------------------------------        01790000
*  RETURN                                                               01800000
*---------------------------------------------------------------        01810000
ERR_OPEN DS    0H                                                       01820000
         LA    R15,RC08           SYSPOOLS FAILED TO OPEN               01830000
         LR    R0,R15             TBOPEN RETURN CODE                    01840000
         LR    R1,R0              TBOPEN REASON CODE                    01850000
         B     RETURN             RETURN                                01860000
                                                                        01870000
ERR_SET  DS    0H                                                       01880000
         LA    R15,RC12           SERVICE FAILURE                       01890000
         LA    R0,RSN04           TBSET FAILURE                         01900000
         B     RETURN             RETURN                                01910000
                                                                        01920000
ERR_GETP DS    0H                                                       01930000
         LA    R15,RC12           SERVICE FAILURE                       01940000
         LA    R0,RSN08           $VTAM GETPOOL FAILURE                 01950000
         B     RETURN                                                   01960000
                                                                        01970000
RETURN   DS    0H                                                       01980000
                                                                        01990000
         #EXIT ,                  RETURN                                02000000
                                                                        02010000
         EJECT ,                                                        02020000
****************************************************************        02030000
*                                                                       02040000
*  LITERALS, CONSTANTS, AND MAPPINGS                                    02050000
*                                                                       02060000
****************************************************************        02070000
                                                                        02080000
         LTORG ,                                                        02090000
                                                                        02100000
         PRINT NOGEN                                                    02110000
         ICVT  ,                                                        02120000
         ITASK ,                                                        02130000
         IVTAMCVT ,                                                     02140000
         PRINT GEN                                                      02150000
                                                                        02160000
         END   ,                                                        02170000

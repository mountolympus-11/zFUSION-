ICMDDMP  TITLE 'ICMDDUMP - DUMP COMMAND PROCESSOR'                      00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: ICMDDMP - DUMP COMMAND PROCESSOR                             00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine processes the various forms of the                    00080000
*    DUMP command to; dump the InfoSession address space and            00090000
*    selected dataspaces; reset (zero) the number of SDUMPs             00100000
*    taken; display the current number of SDUMPS taken and              00110000
*    maximum number of SDUMPS allowed (until reset).                    00120000
*                                                                       00130000
*    The space is dumped using an SVC dump.                             00140000
*                                                                       00150000
* SYNTAX:                                                               00160000
*                                                                       00170000
*    DUMP DISPLAY                                                       00180000
*         RESET                                                         00190000
*         MAXIMUM                                                       00200000
*         ADDR                                                          00210000
*         DSPNAME(dataspace-name)                                       00220000
*                                                                       00230000
* NOTES:                                                                00240000
*    Address space/dataspace dumps do not count towards the             00250000
*    maximum allowed SDUMPs (startup parm).                             00260000
*                                                                       00270000
*    This command requires InfoSession be running APF authorized.       00280000
*                                                                       00290000
*    Selected dataspaces that are not found, are not dumped.  If no     00300000
*    selected dataspace is found then a message is issued.              00310000
*                                                                       00320000
*    It is possible that not all dataspaces requested for dumping       00330000
*    will be dumped.  This can happen if a dataspace is freed           00340000
*    after project serialization is released by this routine and        00350000
*    before the dump is taken.  This situation is unlikely and          00360000
*    would be reflected by the return and reason codes in the           00370000
*    dump completion message.  So, rather than hold things up by        00380000
*    not releasing project serialization until after the dump           00390000
*    completes, it is assumed that the message is sufficient.           00400000
*                                                                       00410000
* ON ENTRY:                                                             00420000
*                                                                       00430000
*    R1  ADDR OF COMMAND REQUEST BLOCK (CMDREQ) IN LOCAL                00440000
*        CMDPROC FORMAT                                                 00450000
*                                                                       00460000
**<DOC-OFF>****************************************************         00470000
                                                                        00480000
***************************************************************         00490000
*                                                                       00500000
* MAINTENANCE:                                                          00510000
*                                                                       00520000
*    06/15/94 T. Weltzer                                                00530000
*             INITIAL VERSION                                           00540000
*                                                                       00550000
***************************************************************         00560000
                                                                        00570000
         EJECT ,                                                        00580000
         CMDREQ ,            COMMAND REQUEST BLOCK                      00590000
         EJECT ,                                                        00600000
         CCSUMRY ,           COMMAND OPERAND PREPARSE SUMMARY           00610000
         EJECT ,                                                        00620000
         $TOKEN ,            OBJECT TOKEN                               00630000
         EJECT ,                                                        00640000
         IPROJ ,             ACTIVE PROJECT                             00650000
         EJECT ,                                                        00660000
         $ENTITY DSECT=ALL   ENTITY REGISTRATION STRUCTURES             00670000
         EJECT ,                                                        00680000
         $SDUMP DSECT=YES    SDUMP STRUCTURES                           00690000
         EJECT ,                                                        00700000
         KEYCODES COMMANDSET=DUMP                                       00710000
         CMDCODES ,                                                     00720000
         EQUS  ,                                                        00730000
         EJECT ,                                                        00740000
         $MSGDFT PREFIX=ICTPID,COMPID='CMD',TABLE=*#MSGS,              X00750000
               CONID=*CMRQCNID,CONNAME=CMRQCNAM,CART=CMRQCART,         X00760000
               DESTADD=*CMRQDMSK,                                      X00770000
               MSGQA=*CMRQMQA,STGQH=*CMRQSTGQ,                         X00780000
               MF=(E,MFE_LIST),                                        X00790000
               PRINT=GEN                                                00800000
                                                                        00810000
         EJECT ,                                                        00820000
#DSPNMAX EQU   10                 MAXIMUM ALLOWED DATASPACE NAMES       00830000
                                                                        00840000
*--------------------------------------------------------------         00850000
* STOKEN-QUALIFIED SDUMP PARAMETER (SDP)                                00860000
*--------------------------------------------------------------         00870000
                                                                        00880000
SDP      DSECT                    STOKEN-QUALIFIED SDUMP PARMLIST       00890000
SDPHLEN  DS    F                  PARMLIST LENGTH                       00900000
SDPHL    EQU   *-SDP              HEADER LENGTH                         00910000
                                                                        00920000
SDPE     DS    0F                 PARMLIST ENTRY                        00930000
SDPESTKN DS    CL(L'$STOKEN)      STOKEN                                00940000
SDPER#   DS    F                  STOKEN RANGES (ONE)                   00950000
SDPERS@  DS    F                  RANGE START ADDRESS (0)               00960000
SDPERE@  DS    F                  RANGE END ADDRESS (X'7FFFFFFF')       00970000
SDPEL    EQU   *-SDPE             ENTRY LENGTH                          00980000
                                                                        00990000
         EJECT ,                                                        01000000
*--------------------------------------------------------------         01010000
* DATASPACE NAME AREA (DNA)                                             01020000
*--------------------------------------------------------------         01030000
                                                                        01040000
DNA      DSECT                    DATASPACE NAME AREA                   01050000
DNADSPN  DS    CL(L'$GENNAME)     DATASPACE NAME                        01060000
DNANAMEL DS    X                  DATASPACE NAME LENGTH                 01070000
DNAFLAGS DS    X                  FLAGS                                 01080000
#DNAFFND EQU   X'80'                DATASPACE NAME FOUND                01090000
                                                                        01100000
DNAL     EQU   *-DNA              ENTRY LENGTH                          01110000
                                                                        01120000
         EJECT ,                                                        01130000
*--------------------------------------------------------------         01140000
* LOCAL WORK AREA                                                       01150000
*--------------------------------------------------------------         01160000
         #WORK ,             BEGIN WORKAREA                             01170000
         ORG   MFE_LIST                                                 01180000
WSDUMP   $SDUMP MF=L                                                    01190000
WSDUMPL  EQU   *-WSDUMP                                                 01200000
         ORG                                                            01210000
                                                                        01220000
WMKLREGS DS    16F           SUBROUTINE REGISTER SAVE AREA              01230000
         ORG   WMKLREGS                                                 01240000
WHDRREGS DS    16F           SUBROUTINE REGISTER SAVE AREA              01250000
         ORG                                                            01260000
                                                                        01270000
WFLAGS   DS    X             CONTROL/STATUS FLAGS                       01280000
#WFADDR  EQU   X'80'           DUMP ADDRESS SPACE                       01290000
#WFDSPN  EQU   X'40'           DUMP DATASPACE                           01300000
#WFDUMP  EQU   #WFADDR+#WFDSPN DUMP SOMETHING                           01310000
#WFRESET EQU   X'08'           RESET SDUMPS TAKEN                       01320000
#WFDSP   EQU   X'04'           DISPLAY SDUMPS TAKEN                     01330000
#WFMAX   EQU   X'02'           UPDATE MAXIMUM ALLOWED SDUMPS            01340000
                                                                        01350000
WSDMPMXL DS    H             NEW SDUMP MAXIMUM STRING LENGTH            01360000
WSDMPMAX DS    XL8           NEW SDUMP MAXIMUM STRING                   01370000
                                                                        01380000
WCMDRC   DS    F             COMMAND'S RETURN CODE                      01390000
WCMDRSN  DS    F             COMMAND'S REASON CODE                      01400000
                                                                        01410000
WDMPRSLT DS    2F            $SDUMP RESULT                              01420000
         ORG   WDMPRSLT                                                 01430000
WDMPRC   DS    F             $SDUMP RETURN CODE                         01440000
WDMPRSN  DS    F             $SDUMP REASON CODE                         01450000
                                                                        01460000
WCMDORG  DS    A             COMMAND LINE ORIGIN                        01470000
WVL@     DS    A             VALUE LIST ORIGIN (DATASPACE NAMES)        01480000
WVL#     DS    F             VALUE LIST COUNT                           01490000
WVNAME   DS    CL(L'$GENNAME) BLANK PADDED DATASPACE NAME - WORK        01500000
WSTOKENS DS    F             COUNT OF DATASPACE NAMES STOKENIZED        01510000
WSDP@    DS    A             A(WSDP) OR ZERO                            01520000
         DS    0D            STOKEN QUALIFIED SDUMP PARAMETER           01530000
WSDP     DS    XL(SDPHL+SDPEL*#DSPNMAX)                                 01540000
                                                                        01550000
WHDR     DS    X,XL99        ROOM FOR MAXIMUM SIZED SVC DUMP HEADER     01560000
WDNAE#   DS    F                                                        01570000
                                                                        01580000
WFSL     DS    F             FOUND-DATASPACE-NAMES STRING LENGTH        01590000
WFS      DS    XL((L'$GENNAME+1)*#DSPNMAX) DATASPACE NAME STRING        01600000
                                                                        01610000
WNFSL    DS    F             NOT-FOUND-DATASPACE-NAMES STRING LENGTH    01620000
WNFS     DS    XL((L'$GENNAME+1)*#DSPNMAX) DATASPACE NAME STRING        01630000
                                                                        01640000
         DS    0X            DATASPACE NAME AREA                        01650000
WDNA     DS    XL(DNAL*#DSPNMAX)                                        01660000
                                                                        01670000
         #ENDWORK ,          END WORKAREA                               01680000
                                                                        01690000
         EJECT ,                                                        01700000
*--------------------------------------------------------------         01710000
* Main                                                                  01720000
*--------------------------------------------------------------         01730000
                                                                        01740000
ICMDDMP  #ENTER PREG=R8                                                 01750000
                                                                        01760000
         USING ICVT,R11           R11 --> ICVT                          01770000
         USING ITASK,R10          R10 --> ITASK                         01780000
                                                                        01790000
         TM    ICTSTAT2,ICT2$APF  APF AUTHORIZED ?                      01800000
         BZ    ERRAPF               NO, ERROR. IT'S REQUIRED            01810000
                                                                        01820000
*--------------------------------------------------------------         01830000
* LOCATE COMMAND REQUEST BLOCK, COMMAND SUMMARY, AND OPS                01840000
*--------------------------------------------------------------         01850000
                                                                        01860000
         USING CMDREQ,R8          R8 --> COMMAND REQUEST BLOCK          01870000
                                                                        01880000
         ICM   R7,15,CMRQSMRY     COMMAND SUMMARY ?                     01890000
         BZ    ANALREQ              NO, DONE                            01900000
                                                                        01910000
         USING CCSUMRY,R7         R7 --> CCSUMRY                        01920000
                                                                        01930000
         ICM   R5,15,CMRQSMR#     OPERAND ENTRIES ?                     01940000
         BZ    ANALREQ              NO, DONE                            01950000
                                                                        01960000
         L     R1,CMRQOPST        SAVE OPERAND STRING ORIGIN            01970000
         ST    R1,WCMDORG                                               01980000
                                                                        01990000
*--------------------------------------------------------------         02000000
* IDENTIFY THE OPERANDS PROVIDED AND VALIDATE                           02010000
*--------------------------------------------------------------         02020000
                                                                        02030000
PARSENXT DS    0H                                                       02040000
         CLC   CCSID,=AL2(DMP_DSPNAME)                                  02050000
         BE    PARSDSPN           DATASPACE SELECTED                    02060000
                                                                        02070000
         CLC   CCSID,=AL2(DMP_PASN)                                     02080000
         BE    PARSADR            ADDRESS SPACE SELECTED                02090000
                                                                        02100000
         CLC   CCSID,=AL2(DMP_RESET)                                    02110000
         BE    PARSRST            RESET SELECTED                        02120000
                                                                        02130000
         CLC   CCSID,=AL2(DMP_DISPLAY)                                  02140000
         BE    PARSDSP            DISPLAY SELECTED                      02150000
                                                                        02160000
         CLC   CCSID,=AL2(DMP_MAX)                                      02170000
         BE    PARSMAX            MAXIMUM SELECTED                      02180000
                                                                        02190000
         B     ERREJECT ,         REJECT OTHERWISE                      02200000
                                                                        02210000
*--------------------------------------------------------------         02220000
* COMMAND REQUESTS                                                      02230000
*--------------------------------------------------------------         02240000
                                                                        02250000
PARSDSPN DS    0H                                                       02260000
         TM    WFLAGS,#WFDSPN     ALREADY PROCESSED ?                   02270000
         BO    ERRCNFLC             YES, CONFLICT                       02280000
                                                                        02290000
         LA    R0,CCSVALS         SAVE VALUE LIST ORIGIN                02300000
         ST    R0,WVL@                                                  02310000
         LH    R0,CCSVALCT        SAVE NUMBER OF ENTRIES                02320000
         ST    R0,WVL#                                                  02330000
         OI    WFLAGS,#WFDSPN     DUMP DATASPACE                        02340000
         B     ADVANCE            NEXT KEYWORD                          02350000
                                                                        02360000
PARSMAX  DS    0H                                                       02370000
         TM    WFLAGS,#WFMAX      ALREADY PROCESSED ?                   02380000
         BO    ERRCNFLC             YES, CONFLICT                       02390000
                                                                        02400000
         LA    R2,WSDMPMAX        SETUP TO COPY VALUE                   02410000
         LA    R3,L'WSDMPMAX      MAX SIZE                              02420000
         MVC   WSDMPMXL,CCSVLEN   SAVE VALUE LENGTH                     02430000
         OI    WFLAGS,#WFMAX      SET SDUMP MAXIMUM                     02440000
         B     PARSCOMM           EXTRACT SINGLE VALUE                  02450000
                                                                        02460000
                                                                        02470000
PARSADR  DS    0H                                                       02480000
         TM    WFLAGS,#WFADDR     ALREADY PROCESSED ?                   02490000
         BO    ERRCNFLC             YES, CONFLICT                       02500000
         OI    WFLAGS,#WFADDR     DUMP ADDRESS SPACE                    02510000
         B     ADVANCE            NEXT KEYWORD                          02520000
                                                                        02530000
PARSRST  DS    0H                                                       02540000
         TM    WFLAGS,#WFRESET    ALREADY PROCESSED ?                   02550000
         BO    ERRCNFLC             YES, CONFLICT                       02560000
         OI    WFLAGS,#WFRESET    RESET # OF SDUMPS TAKEN               02570000
         B     ADVANCE            NEXT KEYWORD                          02580000
                                                                        02590000
PARSDSP  DS    0H                                                       02600000
         TM    WFLAGS,#WFDSP      ALREADY PROCESSED ?                   02610000
         BO    ERRCNFLC             YES, CONFLICT                       02620000
         OI    WFLAGS,#WFDSP      DISPLAY SDUMPS TAKEN                  02630000
         B     ADVANCE            NEXT KEYWORD                          02640000
                                                                        02650000
PARSCOMM DS    0H                                                       02660000
         CLC   CCSVALCT,=H'1'        SINGLE VALUE SPECIFIED?            02670000
         BNE   ERRSYNTX              BRANCH IF NOT                      02680000
         LH    R15,CCSVLEN           LENGTH OF SPECIFIED VALUE          02690000
         LTR   R15,R15               IS THE LENGTH OK?                  02700000
         BNP   ERRSYNTX              BRANCH IF NOT                      02710000
         CR    R15,R3                IS THE LENGTH OK?                  02720000
         BH    ERRSYNTX              BRANCH IF NOT                      02730000
         L     R14,CCSVDISP          OFFSET TO PARM IN CMD LINE         02740000
         A     R14,CMRQOPST          CONVERT OFFSET TO ADDRESS          02750000
         ICM   R15,8,=C' '           MVCL PAD BYTE                      02760000
         MVCL  R2,R14                COPY PARM                          02770000
         B     ADVANCE               CONTINUE WITH PARSE                02780000
*--------------------------------------------------------------         02790000
* PROCESS ALL KEYWORDS, VALIDATE REQUEST COMPLETENESS                   02800000
*--------------------------------------------------------------         02810000
                                                                        02820000
ADVANCE  DS    0H                                                       02830000
         LA    R15,CCSVSLN        LENGTH OF EACH VALUE ENTRY            02840000
         MH    R15,CCSVALCT       TOTAL SIZE CONSUMED BY VALUES         02850000
         LA    R7,CCSUMRY+CCSPFXL(R15) REPOSITION                       02860000
         BCT   R5,PARSENXT        EXAMINE ALL OPERANDS                  02870000
         DROP  R7                 CCSUMRY                               02880000
                                                                        02890000
*--------------------------------------------------------------         02900000
* ANALYZE AND PROCESS REQUEST                                           02910000
*                                                                       02920000
*   Verify dump source exists                                           02930000
*   Set the appropriate dump type                                       02940000
*   Prepare dataspace dump list if needed                               02950000
*   Dump selected spaces                                                02960000
*   Report the results                                                  02970000
*   Cleanup                                                             02980000
*--------------------------------------------------------------         02990000
                                                                        03000000
ANALREQ  DS    0H                                                       03010000
         TM    WFLAGS,#WFMAX      SET NEW MAXIMUM SDUMP ?               03020000
         BNO   CHKRST               NO, CHECK TO RESET                  03030000
                                                                        03040000
         LA    R2,WSDMPMAX        CONVERT CHARACTER TO BINARY           03050000
         LH    R3,WSDMPMXL                                              03060000
         BCTR  R3,0                                                     03070000
         EX    R3,PACKIT                                                03080000
         ZAP   DWORD,DWORD                                              03090000
         CVB   R2,DWORD           CONVERT TO BINARY                     03100000
         ST    R2,ICTDMPMX        UPDATE MAXIMUM                        03110000
         OI    WFLAGS,#WFDSP      FORCE DISPLAY                         03120000
                                                                        03130000
CHKRST   DS    0H                                                       03140000
         TM    WFLAGS,#WFRESET    RESET SDUMPS TAKEN ?                  03150000
         BNO   CHKNONE              NO, CHECK IF NOTHING SPECFIED       03160000
                                                                        03170000
         SR    R1,R1              CLEAR CURRENT DUMPS TAKEN             03180000
         ST    R1,ICTDMPC#                                              03190000
         OI    WFLAGS,#WFDSP      FORCE DISPLAY                         03200000
                                                                        03210000
CHKNONE  DS    0H                                                       03220000
         ICM   R1,15,WFLAGS       ANYTHING SPECIFIED ?                  03230000
         BZ    DODISP               NO, DEFAULT IS DISPLAY              03240000
                                                                        03250000
         TM    WFLAGS,#WFDSP      DISPLAY SDUMPS TAKEN ?                03260000
         BNO   CHKDMP               NO, CHECK DUMP SOURCES              03270000
                                                                        03280000
DODISP   DS    0H                                                       03290000
                                                                        03300000
         $MSG  363,FIELDS=(ICTDMPC#,ICTDMPMX)                           03310000
                                                                        03320000
CHKDMP   DS    0H                                                       03330000
         TM    WFLAGS,#WFDUMP     DUMP SOURCE(S) SELECTED ?             03340000
         BZ    NORMRET              NO, NO MORE TO DO                   03350000
                                                                        03360000
         LA    R2,#SDRT1          ASSUME DATASPACE DUMP ONLY            03370000
         MVC   WHDR(L'CHDR1),CHDR1                                      03380000
         TM    WFLAGS,#WFADDR     DUMP ADDRESS SPACE ?                  03390000
         BNO   CHKDSP               NO, AS ASSUMED.                     03400000
         LA    R2,#SDRT0            YES, INCLUDE ADDRESS SPACE          03410000
         MVC   WHDR(L'CHDR0),CHDR0                                      03420000
                                                                        03430000
CHKDSP   DS    0H                                                       03440000
         XC    WSDP@,WSDP@        ASSUME ADDRESS SPACE DUMP ONLY        03450000
         TM    WFLAGS,#WFDSPN     DATASPACE(S) TO DUMP ?                03460000
         BNO   DUMPIT               NO, AS ASSUMED. JUST DUMP IT        03470000
                                                                        03480000
         BAS   R14,MAKELIST       PREPARE DATASPACE DUMP PARM           03490000
                                                                        03500000
         LTR   R15,R15            BUILT ?                               03510000
         BNZ   ERRLIST              NO, HANDLE ERROR                    03520000
                                                                        03530000
DUMPWSPC DS    0H                 DUMP WITH DATASPACE(S)                03540000
         LA    R1,WSDP            SET DATASPACE DUMP PARAMETER          03550000
         ST    R1,WSDP@                                                 03560000
                                                                        03570000
DUMPHDR  DS    0H                                                       03580000
         BAS   R14,MAKEHDRS       BUILD STRINGS OF DATASPACE NAMES      03590000
                                                                        03600000
         ICM   R4,15,WFSL         ANY DATASPACE NAMES TO APPEND ?       03610000
         BZ    DUMPIT               NO, HEADER IS READY                 03620000
                                                                        03630000
         SR    R1,R1              CURRENT HEADER LENGTH                 03640000
         IC    R1,WHDR                                                  03650000
         LA    R3,WHDR(R1)        APPEND TARGET IS CURRENT HEADER TAIL  03660000
         LA    R0,0(R1,R4)        NEW HEADER LENGTH                     03670000
         CH    R0,=H'100'         TOO BIG ?                             03680000
         BNH   APPENDIT             NO, APPEND IT                       03690000
         LH    R0,=H'100'         FINAL HEADER LENGTH                   03700000
         LR    R4,R0              STRING LENGTH TO MOVE                 03710000
         SR    R4,R1                                                    03720000
APPENDIT DS    0H                                                       03730000
         BCTR  R4,0               APPEND NAMES STRING                   03740000
         EX    R4,*+4                                                   03750000
         MVC   0(0,R3),WFS                                              03760000
         STC   R0,WHDR            UPDATE HEADER LENGTH                  03770000
                                                                        03780000
DUMPIT   DS    0H                                                       03790000
         XC    WSDUMP(WSDUMPL),WSDUMP PREPARE $SDUMP PLIST              03800000
                                                                        03810000
         $SDUMP HDR=WHDR,         I/  - DUMP HEADER                    +03820000
               DTYPE=(R2),        I/  - SELECTED DUMP TYPE             +03830000
               STOKENL=*WSDP@,    I/  - DATASPACE STOKEN RANGE LIST    +03840000
               OPTIONS=NOCOUNT,   I/  - BYPASS SDUMP ATTENUATOR        +03850000
               MF=(E,WSDUMP)                                            03860000
                                                                        03870000
         STM   R15,R0,WDMPRSLT    SAVE RESULT                           03880000
         LA    R2,CSUCCESS        ASSUME DUMP "SUCCESSFUL" MESSAGE      03890000
         LA    R3,L'CSUCCESS                                            03900000
         LTR   R15,R15            REQUEST ERROR ?                       03910000
         BM    DMPFAIL              YES, FAILED                         03920000
         C     R15,=F'8'          SOMEWHAT SUCCESSFUL ?                 03930000
         BL    DMPMSG               YES, AS ASSUMED                     03940000
                                                                        03950000
DMPFAIL  DS    0H                                                       03960000
         LA    R2,CFAILED         DUMP "FAILED" MESSAGE                 03970000
         LA    R3,L'CFAILED                                             03980000
                                                                        03990000
DMPMSG   DS    0H                                                       04000000
*                                                                       04010000
* SVC dump <failed/succeeded> RC: <rc> RSN: <rsn>                       04020000
*                                                                       04030000
         $MSG  360,FIELDS=(((R2),(R3)),WDMPRC,WDMPRSN)                  04040000
                                                                        04050000
         ICM   R3,15,WNFSL        ANY NOT-FOUND DATASPACE NAMES ?       04060000
         BZ    NORMRET              NO, RETURN                          04070000
         LA    R2,WNFS            STRING OF NOT-FOUND DATASPACE NAMES   04080000
*                                                                       04090000
* Dataspaces not found. <S>. Not dumped.                                04100000
*                                                                       04110000
         $MSG  362,FIELDS=(((R2),(R3)))                                 04120000
                                                                        04130000
         B     NORMRET                                                  04140000
                                                                        04150000
PACKIT   PACK  DWORD,0(0,R2)      CONVERT EBCDIC TO DECIMAL             04160000
         EJECT ,                                                        04170000
*--------------------------------------------------------------------   04180000
* RETURN COMPLETION STATUS TO REQUESTOR                                 04190000
*--------------------------------------------------------------------   04200000
                                                                        04210000
ERRLIST  DS    0H                                                       04220000
         LA    R1,RC04            SET COMMAND'S RETURN CODE             04230000
         ST    R1,WCMDRC                                                04240000
         ST    R15,WCMDRSN        SET COMMAND'S REASON CODE             04250000
         C     R15,=F'04'         ANY SPACE(S) FOUND ?                  04260000
         BNE   ERRMANY              NO, TEST IF TOO MANY                04270000
                                                                        04280000
         LA    R2,CMSGSPC         DATASPACE NOT FOUND                   04290000
         LA    R3,L'CMSGSPC                                             04300000
         B     ERRMSG                                                   04310000
                                                                        04320000
ERRMANY  DS    0H                                                       04330000
         C     R15,=F'08'         TOO MANY SPACES ?                     04340000
         BNE   ERRLOCK              NO, TEST LOCK                       04350000
                                                                        04360000
         LA    R2,CMSGMANY        TOO MANY SPACES SELECTED              04370000
         LA    R3,L'CMSGMANY                                            04380000
         B     ERRMSG                                                   04390000
                                                                        04400000
ERRLOCK  DS    0H                                                       04410000
         C     R15,=F'16'         PROJECT LOCK ERROR ?                  04420000
         BNE   ERRNAME              NO, TEST DATASPACE NAME             04430000
                                                                        04440000
         LA    R2,CMSGLOCK        TOO MANY SPACES SELECTED              04450000
         LA    R3,L'CMSGLOCK                                            04460000
         B     ERRMSG                                                   04470000
                                                                        04480000
ERRNAME  DS    0H                                                       04490000
         LA    R2,CMSGNAME        INVALID DATASPACE NAME (LENGTH)       04500000
         LA    R3,L'CMSGNAME                                            04510000
         B     ERRMSG                                                   04520000
*---------------------------------------------------------------------- 04530000
ERRAPF   DS    0H                                                       04540000
         LA    R1,RC08            SET COMMAND'S RETURN CODE             04550000
         ST    R1,WCMDRC                                                04560000
         LA    R2,CMSGAPF         NOT RUNNING APF AUTHORIZED            04570000
         LA    R3,L'CMSGAPF                                             04580000
         B     ERRMSG                                                   04590000
                                                                        04600000
ERRSEL   DS    0H                                                       04610000
         LA    R1,RC12            SET COMMAND'S RETURN CODE             04620000
         ST    R1,WCMDRC                                                04630000
         LA    R2,CMSGSEL         NO SPACES SPECIFIED                   04640000
         LA    R3,L'CMSGSEL                                             04650000
         B     ERRMSG                                                   04660000
                                                                        04670000
ERRMSG   DS    0H                                                       04680000
         $MSG  361,FIELDS=(((R2),(R3)),WCMDRC,WCMDRSN)                  04690000
         B     ERREJECT                                                 04700000
                                                                        04710000
ERRSYNTX DS    0H                                                       04720000
         LA    R15,CCODE_SYNTAX   SYNTAX ERROR                          04730000
         B     CMDRET             DONE                                  04740000
                                                                        04750000
ERRCNFLC DS    0H                                                       04760000
         LA    R15,CCODE_CONFLICT CONFLICTING OPERANDS                  04770000
         B     CMDRET             DONE                                  04780000
                                                                        04790000
ERREJECT DS    0H                                                       04800000
         LA    R15,CCODE_REJECT   COMMAND REJECTED                      04810000
         B     CMDRET             DONE                                  04820000
                                                                        04830000
NORMRET  DS    0H                                                       04840000
         LA    R15,CCODE_NORESP   NO ADDITIONAL RESPONSE REQUIRED       04850000
         B     CMDRET                                                   04860000
                                                                        04870000
CMDRET   DS    0H                                                       04880000
         ST    R15,CMRQCOMP       POST COMPLETION CODE PER CONVENTION   04890000
         #EXIT ,                                                        04900000
                                                                        04910000
         EJECT ,                                                        04920000
*---------------------------------------------------------------------- 04930000
*                                                                       04940000
* PREPARE STOKEN QUALIFIED SDUMP PARAMETER                              04950000
*                                                                       04960000
* Loop through the list of supplied values.  For each value             04970000
* verify that it has a valid length and drop duplicates.                04980000
*                                                                       04990000
* Inspect the catalog ,execution and project dataspaces to convert      05000000
* dataspace names to STOKENs for dumping the requested space(s).        05010000
* The project dataspace names are checked by walking through the        05020000
* project entity list.  Along the way, the STOKEN qualified storage-    05030000
* range dump parameter is built.                                        05040000
*                                                                       05050000
* ENTRY:                                                                05060000
*   none - data obtained from workarea                                  05070000
*                                                                       05080000
* EXIT:                                                                 05090000
*   R15 =  0 - STOKEN qualified SDUMP parameter built                   05100000
*   R15 =  4 - not built. Dataspaces not found.                         05110000
*   R15 =  8 - too many dataspace names specified                       05120000
*   R15 = 12 - invalid dataspace name length                            05130000
*                                                                       05140000
*---------------------------------------------------------------------- 05150000
                                                                        05160000
MAKELIST DS 0H                                                          05170000
         PUSH  USING                                                    05180000
         STM   R0,R15,WMKLREGS    PROTECT CALLER'S REGISTERS            05190000
                                                                        05200000
*---------------------------------------------------------------------- 05210000
* Uniquify name values into dataspace name area (unique name            05220000
* collection).                                                          05230000
*                                                                       05240000
* R8 - candidate-dataspace-name value list origin                       05250000
* R7 - unique collection start address                                  05260000
* R6 - unique collection name count                                     05270000
* R5 - unique collection name count - dupilicate-check loop control     05280000
* R4 - candidate count - loop control                                   05290000
*---------------------------------------------------------------------- 05300000
                                                                        05310000
         ICM   R4,15,WVL#         VALUE COUNT - # DATASPACE NAMES       05320000
         BZ    MKL_NONE           ANY ? NO, DONE                        05330000
         C     R4,CVLMAX#                                               05340000
         BH    MKL_TOO_MANY       TOO MANY ? YES, ERROR                 05350000
                                                                        05360000
         L     R8,WVL@            VALUE LIST ORIGIN                     05370000
                                                                        05380000
         USING CCSVALS,R8         R8 --> CCSVALS                        05390000
                                                                        05400000
         SR    R6,R6              INITIALIZE UNIQUE NAME COUNT          05410000
         LA    R7,WDNA            UNIQUE NAME COLLECTION START ADDRESS  05420000
*                                                                       05430000
* Validate and prepare the candidate name                               05440000
*                                                                       05450000
MKL_TEST_CAN   DS 0H                                                    05460000
         LH    R1,CCSVLEN         VALID CANDIDATE LENGTH ?              05470000
         LTR   R1,R1                                                    05480000
         BNP   MKL_BAD_VLEN         NO, ERROR                           05490000
         CH    R1,=AL2(L'DNADSPN) VALID CANDIDATE LENGTH ?              05500000
         BH    MKL_BAD_VLEN         NO, ERROR                           05510000
         L     R2,CCSVDISP        CANDIDATE'S COMMAND LINE OFFSET       05520000
         A     R2,WCMDORG         CANDIDATE'S COMMAND LINE ADDRESS      05530000
         MVC   WVNAME,BLANKS      BLANK PAD INPUT CANDIDATE             05540000
         BCTR  R1,0                                                     05550000
         EX    R1,*+4                                                   05560000
         MVC   WVNAME(0),0(R2)                                          05570000
*                                                                       05580000
* Drop duplicates                                                       05590000
*                                                                       05600000
         LR    R2,R7              FIRST IN UNIQUE COLLECTION            05610000
         LTR   R5,R6              ANY UNIQUE ONES YET ?                 05620000
         BZ    MKL_UNIQUE           NO, THE FIRST IS ALWAYS UNIQUE      05630000
                                                                        05640000
         USING DNA,R2             R2 --> DNA                            05650000
                                                                        05660000
MKL_TEST_DUPE DS 0H                                                     05670000
         CLC   DNADSPN,WVNAME     CANDIDATE IN THE COLLECTION ?         05680000
         BE    MKL_NEXT_CAN          YES, NEXT CANDIDATE PLEASE         05690000
         LA    R2,DNAL(0,R2)      NEXT IN COLLECTION                    05700000
         BCT   R5,MKL_TEST_DUPE   CHECK ENTIRE CURRENT COLLECTION       05710000
*                                                                       05720000
* Save dataspace name and update delimitted dataspace name string.      05730000
*                                                                       05740000
MKL_UNIQUE DS 0H                                                        05750000
         LA    R6,1(0,R6)         ADD ONE TO THE UNIQUE COLLECTION      05760000
         MVC   DNADSPN,WVNAME     SAVE DATASPACE NAME                   05770000
         LA    R1,1(0,R1)         SAVE DATASPACE NAME LENGTH            05780000
         STC   R1,DNANAMEL                                              05790000
         DROP  R2                 R2                                    05800000
                                                                        05810000
MKL_NEXT_CAN DS 0H                                                      05820000
         LA    R8,CCSVSLN(0,R8)   NEXT CANDIDATE                        05830000
         DROP  R8                 R8                                    05840000
         BCT   R4,MKL_TEST_CAN    PROCESS ALL CANDIDATES                05850000
                                                                        05860000
         ST    R6,WDNAE#          SAVE SIZE OF COLLECTION               05870000
                                                                        05880000
*---------------------------------------------------------------------- 05890000
* Build STOKEN qualified dump range parameter entries                   05900000
*   Extract STOKENs for catalog/execution dataspaces which              05910000
*   match selected dataspace names and format the STOKEN                05920000
*   qualified dump range parameter entry.                               05930000
*                                                                       05940000
*   Extract STOKENs from opened projects having a matching              05950000
*   dataspace name and format the STOKEN qualified range parm entry.    05960000
*                                                                       05970000
* R8 - project entity entry                                             05980000
* R7 - IPROJ                                                            05990000
* R6 - current STOKENized (matched) name count                          06000000
* R5 - dump parm list's STOKEN range entry                              06010000
* R3 - unique name count - loop control                                 06020000
* R2 - unique name address                                              06030000
*---------------------------------------------------------------------- 06040000
*                                                                       06050000
* Prepare to build a STOKENized dump-range entry in the STOKEN          06060000
* qualified SDUMP parameter.                                            06070000
*                                                                       06080000
         SR    R6,R6              NUMBER OF NAMES STOKENIZED            06090000
X        USING SDP,WSDP                                                 06100000
         LA    R5,X.SDPE          FIRST STOKEN RANGE ENTRY              06110000
         DROP  X                                                        06120000
                                                                        06130000
         USING SDPE,R5            R5 --> SDPE                           06140000
*                                                                       06150000
* Determine if any/all input dataspace names match execution's or       06160000
* catalog's dataspace name.                                             06170000
*                                                                       06180000
         L     R3,WDNAE#          NAME COUNT                            06190000
         LA    R2,WDNA            FIRST NAME IN COLLECTION              06200000
                                                                        06210000
         USING DNA,R2             R2 --> DNA                            06220000
                                                                        06230000
SYS_TEST_MATCH DS 0H                                                    06240000
         L     R1,ICTXSPT@        EXECUTION SPACE TOKEN                 06250000
         USING $TOKEN,R1                                                06260000
         CLC   DNADSPN,$GENNAME   SAME ?                                06270000
         BE    SYS_STOKENIZE        YES, STOKENIZE IT                   06280000
         L     R1,ICTSYSP@        CATALOG SPACE TOKEN                   06290000
         USING $TOKEN,R1                                                06300000
         CLC   DNADSPN,$GENNAME   SAME ?                                06310000
         BNE   SYS_NEXT_NAME        NO, NEXT NAME IN COLLECTION         06320000
                                                                        06330000
SYS_STOKENIZE DS 0H                                                     06340000
*                                                                       06350000
* Format stoken-qualified range-to-dump parm entry (stokenize)          06360000
*                                                                       06370000
         MVC   SDPESTKN,$STOKEN   DATASPACE'S STOKEN                    06380000
         DROP  R1                                                       06390000
         MVC   SDPER#(CRSPECL),CRSPEC DUMP-ENTIRE-SPACE CONSTANT        06400000
         OI    DNAFLAGS,#DNAFFND  STOKENIZED                            06410000
         LA    R6,1(0,R6)         INCREMENT STOKENIZED COUNT            06420000
         C     R6,WDNAE#          COLLECTION STOKENIZED ?               06430000
         BE    MKL_ALL_STOKENIZED   YES, DONE                           06440000
                                                                        06450000
         LA    R5,SDPEL(R5)       PREPARE FOR NEXT STOKENIZATION        06460000
*                                                                       06470000
* Get next input dataspace name                                         06480000
*                                                                       06490000
SYS_NEXT_NAME DS 0H                                                     06500000
         LA    R2,DNAL(0,R2)      NEXT NAME IN COLLECTION               06510000
         DROP  R2                 R2                                    06520000
         BCT   R3,SYS_TEST_MATCH  TEST FOR A MATCH                      06530000
                                                                        06540000
*---------------------------------------------------------------------- 06550000
* STOKENize selected project dataspaces.                                06560000
* Walk through the project entity list and the list of uniquified       06570000
* input dataspace names.                                                06580000
*---------------------------------------------------------------------- 06590000
*                                                                       06600000
* Prepare project entity list walk                                      06610000
*                                                                       06620000
         ICM   R2,15,ICTIPRJ      PROJECT LIST                          06630000
         BZ    MKL_ALL_STOKENIZED ANY ? NO, DONE                        06640000
                                                                        06650000
         USING ENTCNTL,R2         R2 --> ENTCNTL                        06660000
                                                                        06670000
         $SER  OBTAIN,PROJ        HOLD IT !                             06680000
                                                                        06690000
         C     R15,=F'8'          GET LOCK ?                            06700000
         BNL   MKL_LOCKERR          NO, LOCK ERROR                      06710000
                                                                        06720000
         ICM   R8,15,ENTQ         ANY ENTRIES ?                         06730000
         DROP  R2                 R2                                    06740000
         BZ    MKL_PROJ_STOKENIZED  NO, PROJECT SPACES STOKENIZED       06750000
                                                                        06760000
         USING ENENTRY,R8         R8 --> ENENTRY                        06770000
*                                                                       06780000
* Access project control block via project entity list                  06790000
*                                                                       06800000
MKL_GET_PROJ   DS 0H                                                    06810000
         ICM   R7,15,ENEUSER      PROJECT ?                             06820000
         BZ    MKL_NEXT_ENTRY       NO, NEXT PROJECT ENTITY ENTRY       06830000
                                                                        06840000
         USING IPROJ,R7           R7 --> IPROJ                          06850000
X        USING $TOKEN,PRJTOKEN    X  --> $TOKEN                         06860000
                                                                        06870000
         L     R3,WDNAE#          NAME COUNT                            06880000
         LA    R2,WDNA            ADDRESS FIRST NAME                    06890000
                                                                        06900000
         USING DNA,R2             R2 --> DNA                            06910000
*                                                                       06920000
* Determine if any input dataspace name matches project's               06930000
*                                                                       06940000
MKL_TEST_MATCH DS 0H                                                    06950000
         TM    DNAFLAGS,#DNAFFND  STOKENIZED ?                          06960000
         BO    MKL_NEXT_NAME        YES, NEXT NAME                      06970000
         CLC   DNADSPN,X.$GENNAME SAME ?                                06980000
         BNE   MKL_NEXT_NAME        NO, NEXT NAME                       06990000
*                                                                       07000000
* Format stoken-qualified range-to-dump parameter entry (stokenize)     07010000
*                                                                       07020000
         MVC   SDPESTKN,X.$STOKEN DATASPACE'S STOKEN                    07030000
         DROP  X                  X                                     07040000
         DROP  R7                 R7                                    07050000
         MVC   SDPER#(CRSPECL),CRSPEC DUMP-ENTIRE-SPACE CONSTANT        07060000
         OI    DNAFLAGS,#DNAFFND  STOKENIZED                            07070000
         LA    R6,1(0,R6)         INCREMENT STOKENIZED COUNT            07080000
         C     R6,WDNAE#          COLLECTION STOKENIZED ?               07090000
         BE    MKL_PROJ_STOKENIZED  YES, DONE                           07100000
                                                                        07110000
         LA    R5,SDPEL(R5)       PREPARE FOR NEXT STOKENIZATION        07120000
         B     MKL_NEXT_ENTRY     NEXT PROJECT ENTITY ENTRY             07130000
*                                                                       07140000
* Get next input dataspace name                                         07150000
*                                                                       07160000
MKL_NEXT_NAME DS 0H                                                     07170000
         LA    R2,DNAL(0,R2)      NEXT NAME IN COLLECTION               07180000
         DROP  R2                 R2                                    07190000
         BCT   R3,MKL_TEST_MATCH  TEST FOR A MATCH                      07200000
*                                                                       07210000
* Get next project entity list entry                                    07220000
*                                                                       07230000
MKL_NEXT_ENTRY DS 0H                                                    07240000
         ICM   R8,15,ENEQFWD      NEXT PROJECT ENTITY ENTRY             07250000
         DROP  R8                 R8                                    07260000
         BNZ   MKL_GET_PROJ       MORE ? YES, CHECK IT OUT              07270000
                                                                        07280000
MKL_PROJ_STOKENIZED DS 0H                                               07290000
         $SER  RELEASE,PROJ       LET THINGS HAPPEN                     07300000
*                                                                       07310000
* Finish building STOKEN qualified dump range parameter                 07320000
*                                                                       07330000
MKL_ALL_STOKENIZED DS 0H                                                07340000
         LTR   R6,R6              ANY STOKENIZED ?                      07350000
         BZ    MKL_NONE             NO, NO DATASPACE TO DUMP            07360000
         ST    R6,WSTOKENS        NUMER OF STOKENIZED NAMES             07370000
         MH    R6,=Y(SDPEL)       * PARM-RANGE-ENTRY'S LENGTH           07380000
         LA    R6,SDPHL(R6)       + PARM'S HEADER LENGTH                07390000
X        USING SDP,WSDP                                                 07400000
         ST    R6,X.SDPHLEN       = PARM'S LENGTH                       07410000
         DROP  X                                                        07420000
         SR    R15,R15            RC = 0                                07430000
         B     MKL_EXIT                                                 07440000
                                                                        07450000
MKL_NONE DS 0H                                                          07460000
         LA    R15,RC04           NO MATCHES                            07470000
         B     MKL_EXIT                                                 07480000
                                                                        07490000
MKL_TOO_MANY DS 0H                TOO MANY NAMES SPECIFIED              07500000
         LA    R15,RC08                                                 07510000
         B     MKL_EXIT                                                 07520000
                                                                        07530000
MKL_BAD_VLEN DS 0H                INVALID VALUE LENGTH                  07540000
         LA    R15,RC12                                                 07550000
         B     MKL_EXIT                                                 07560000
                                                                        07570000
MKL_LOCKERR DS 0H                 UNABLE TO OBTAIN PROJECT LOCK         07580000
         LA    R15,RC16                                                 07590000
         B     MKL_EXIT                                                 07600000
                                                                        07610000
MKL_EXIT DS 0H                                                          07620000
         LM    R0,R14,WMKLREGS    RESTORE CALLER'S REGISTERS            07630000
         BR    R14                                                      07640000
         POP   USING                                                    07650000
                                                                        07660000
         EJECT ,                                                        07670000
*---------------------------------------------------------------------- 07680000
* Build 2 strings:                                                      07690000
*  - Delimitted dataspace names found                                   07700000
*  - Delimitted dataspace names not found                               07710000
*---------------------------------------------------------------------- 07720000
                                                                        07730000
MAKEHDRS DS 0H                                                          07740000
         PUSH  USING                                                    07750000
         STM   R0,R15,WHDRREGS    PROTECT CALLER'S REGISTERS            07760000
                                                                        07770000
         XC    WFSL,WFSL          NO FOUND DATASPACE NAMES YET          07780000
         XC    WNFSL,WNFSL        NO NOT-FOUND DATASPACE NAMES YET      07790000
         MVI   WFS,C' '           PRE-FORMAT DELIMITERS                 07800000
         MVC   WFS+1(L'WFS-1),WFS                                       07810000
         MVI   WNFS,C' '                                                07820000
         MVC   WNFS+1(L'WNFS-1),WNFS                                    07830000
                                                                        07840000
         LA    R4,WFS             STRING OF FOUND DATASPACES            07850000
         LA    R5,WNFS            STRING OF NOT FOUND DATASPACES        07860000
         L     R3,WDNAE#          DATASPACE NAME COUNT                  07870000
         LA    R2,WDNA                                                  07880000
         USING DNA,R2             R2 --> DNA                            07890000
                                                                        07900000
MKH_NEXT DS    0H                                                       07910000
         SR    R1,R1                                                    07920000
         IC    R1,DNANAMEL        NAME LENGTH                           07930000
         BCTR  R1,0               EX LENGTH                             07940000
         TM    DNAFLAGS,#DNAFFND  NAME FOUND ?                          07950000
         BNO   MKH_NFND             NO, NOT FOUND                       07960000
*                                                                       07970000
* Format string of dataspaces found                                     07980000
*                                                                       07990000
         EX    R1,*+4             COPY FOUND NAME                       08000000
         MVC   0(0,R4),DNADSPN                                          08010000
         LA    R1,2(0,R1)         TRUE LENGTH + ROOM FOR DELIMITTER     08020000
         LA    R4,0(R1,R4)        UPDATE STRING TARGET ADDRESS          08030000
         A     R1,WFSL                                                  08040000
         ST    R1,WFSL            UPDATE STRING LENGTH                  08050000
         B     MKH_GET_NEXT                                             08060000
*                                                                       08070000
* Format string of dataspaces not found                                 08080000
*                                                                       08090000
MKH_NFND DS 0H                                                          08100000
         EX    R1,*+4             COPY NOT-FOUND NAME                   08110000
         MVC   0(0,R5),DNADSPN                                          08120000
         DROP  R2                 R2                                    08130000
         LA    R1,2(0,R1)         TRUE LENGTH + ROOM FOR DELIMITTER     08140000
         LA    R5,0(R1,R5)        UPDATE STRING TARGET ADDRESS          08150000
         A     R1,WNFSL           UPDATE STRING LENGTH                  08160000
         ST    R1,WNFSL                                                 08170000
                                                                        08180000
MKH_GET_NEXT DS 0H                                                      08190000
         LA    R2,DNAL(0,R2)      UPDATE SOURCE ADDRESS                 08200000
         BCT   R3,MKH_NEXT        PROCESS NEXT DATASPACE NAME           08210000
                                                                        08220000
MKH_EXIT DS 0H                                                          08230000
         LM    R0,R15,WHDRREGS    RESTORE CALLER'S REGISTERS            08240000
         BR    R14                                                      08250000
         POP   USING                                                    08260000
                                                                        08270000
         EJECT ,                                                        08280000
*--------------------------------------------------------------------   08290000
* LOCAL READ/ONLY DATA AREAS, ETC.                                      08300000
*--------------------------------------------------------------------   08310000
                                                                        08320000
CVLMAX#  DC    A(#DSPNMAX)                                              08330000
BLANKS   DC    CL16' '                                                  08340000
*                                                                       08350000
* Partial SDUMP parm entry constants                                    08360000
*                                                                       08370000
CRSPEC   DC    F'1'               STOKEN ADDRESS RANGES                 08380000
         DC    A(0)               RANGE START ADDRESS                   08390000
         DC    X'7FFFFFFF'        RANGE END ADDRESS                     08400000
CRSPECL  EQU   *-CRSPEC                                                 08410000
*                                                                       08420000
* SDUMP header constants                                                08430000
*                                                                       08440000
CHDR0LEN DC    AL1(L'CHDR0)                                             08450000
         DC    C'InfoSession dump spaces: Primary '                     08460000
CHDR0    EQU   CHDR0LEN,*-CHDR0LEN                                      08470000
                                                                        08480000
CHDR1LEN DC    AL1(L'CHDR1)                                             08490000
         DC    C'InfoSession dump spaces: '                             08500000
CHDR1    EQU   CHDR1LEN,*-CHDR1LEN                                      08510000
*                                                                       08520000
* Message constants                                                     08530000
*                                                                       08540000
CSUCCESS DC    C'successful'                                            08550000
CFAILED  DC    C'failed'                                                08560000
CMSGAPF  DC    C'Not running APF authorized'                            08570000
CMSGSEL  DC    C'No spaces selected'                                    08580000
*                                                                       08590000
* MAKELIST errors                                                       08600000
*                                                                       08610000
CMSGSPC  DC    C'No selected dataspace(s) found'                        08620000
CMSGMANY DC    C'Too many dataspaces specified'                         08630000
CMSGNAME DC    C'Invalid dataspace name'                                08640000
CMSGLOCK DC    C'Unable to obtain project lock'                         08650000
         LTORG ,                                                        08660000
                                                                        08670000
         EJECT ,                                                        08680000
         PRINT NOGEN                                                    08690000
         ICVT  ,                                                        08700000
         ITASK ,                                                        08710000
         END   ,                                                        08720000

IGENASYE TITLE 'IGENASYE - SCHEDULE AN ASYNCHRONOUS WORKUNIT EXIT RTN'  00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: IGENASYE - SCHEDULE AN ASNYCH WORKUNIT EXIT RTN              00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THIS ROUTINE IS INVOKED BY THE $ASYEXIT MACRO TO SCHEDULE          00080000
*    AN IRB TO THE DESIGNATED ITASK.  THE METHOD USED IS THE            00090000
*    'OLD STYLE' STAGE 1, 2, 3 EXIT EFFECTORS.  THOSE FACILITIES        00100000
*    ARE AVAILABLE ONLY TO APF-AUTHORIZED REQUESTERS.                   00110000
*    ARE AVAILABLE ONLY TO APF-AUTHORIZED REQUESTERS.                   00120000
*                                                                       00130000
*                                                                       00140000
* METHOD:                                                               00150000
*                                                                       00160000
*    1) VERIFY APF AUTHORIZATION                                        00170000
*                                                                       00180000
*    2) IF THE WORKUNIT (ITASK) IS IDENTIFIED BY NAME, THE              00190000
*       DISP LOCK IS ACQUIRED PRIOR TO ISSUING $WULOC TO                00200000
*       DERIVE THE ITASK ADDRESS.  IF AN ITASK ADDRESS IS               00210000
*       SPECIFIED DIRECTLY, WE ASSUME THAT THE DISP LOCK IS             00220000
*       HELD BY THE CALLER.                                             00230000
*                                                                       00240000
*    2) CREATE AN IRB                                                   00250000
*                                                                       00260000
*    3) SCHEDULE THE IRB TO RUN UNDER THE DESIGNATED ITASK              00270000
*                                                                       00280000
*    4) RELEASE LOCKS AND RETURN COMPLETION STATUS                      00290000
*                                                                       00300000
*                                                                       00310000
* ON ENTRY:                                                             00320000
*                                                                       00330000
*    R1  CONTAINS THE ADDRESS OF A PARAMETER LIST DESCRIBED             00340000
*        BY THE $ASYEPRM MAPPING GENERATED BY THE $ASYEXIT MACRO        00350000
*                                                                       00360000
* ON EXIT:                                                              00370000
*                                                                       00380000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES                     00390000
*                                                                       00400000
*        RC00 - ASYNCH EXIT SCHEDULED                                   00410000
*                                                                       00420000
*        RC04 - APF AUTHORIZATION IS REQUIRED                           00430000
*                                                                       00440000
*        RC08 - NAMED ITASK NOT FOUND                                   00450000
*                                                                       00460000
*        RC12 - SERVICE/ROUTINE FAILURE                                 00470000
*                                                                       00480000
*               R0 - SERVICE/ROUTINE RETCODE                            00490000
*               R1 - SERVICE NAME (CL8)                                 00500000
*                                                                       00510000
**<DOC-OFF>****************************************************         00520000
                                                                        00530000
***************************************************************         00540000
*                                                                       00550000
* MAINTENANCE:                                                          00560000
*                                                                       00570000
*    07/10/94 R. TURGEON                                                00580000
*             INITIAL VERSION                                           00590000
*                                                                       00600000
***************************************************************         00610000
                                                                        00620000
         #WORK ,                  BEGIN WORKAREA                        00630000
                                                                        00640000
FLAGS    DS    X                  FLAG BYTE                             00650000
FDISP    EQU   X'80'                 DISP LOCK HELD                     00660000
FLOCAL   EQU   X'40'                 MVS LOCAL LOCK HELD                00670000
                                                                        00680000
RETREGS  DS    3F                 R15-R1 COMPLETION STATUS REGS         00690000
                                                                        00700000
TASKINFO DS    XL(WUDLN)          TASK INFORMATION RETURN AREA          00710000
$WUL_MFL $WULOC MF=L              WORKUNIT LOCATOR PLIST                00720000
                                                                        00730000
WK1K     DS    0D,XL1024          1024 BYTE WORKAREA                    00740000
                                                                        00750000
         #ENDWORK ,               END WORKAREA                          00760000
                                                                        00770000
         EJECT                                                          00780000
         $ASYEXIT DSECT=YES       ASYNC EXIT SCHEDULER PLIST            00790000
                                                                        00800000
         EJECT                                                          00810000
         $WULOC  DSECT=YES        WORKUNIT LOCATOR PARAMETER LIST       00820000
                                                                        00830000
         IWUENTUD ,               WORKUNIT ENTITY INFO RETURN AREA      00840000
                                                                        00850000
         EQUS  ,                                                        00860000
                                                                        00870000
         EJECT                                                          00880000
IGENASYE #ENTER PREG=R8                                                 00890000
                                                                        00900000
         USING ITASK,R10          LIKE MVS, TASK MODE REQUESTERS ONLY   00910000
         USING $ASYEPRM,R8        PARAMETER LIST                        00920000
                                                                        00930000
***************************************************************         00940000
*                                                                       00950000
*   ENSURE OPERATION IN AN APF-AUTHORIZED ENVIRONMENT                   00960000
*                                                                       00970000
***************************************************************         00980000
         TM    ICTSTAT2,ICT2$APF  APF-AUTHORIZED ENVIRONMENT?           00990000
         BNO   ERR_AUTH           CANT COMPLY IF NOT                    01000000
                                                                        01010000
***************************************************************         01020000
*                                                                       01030000
*   THE TARGET ITASK MAY BE IDENTIFIED BY ADDRESS OR BY NAME.           01040000
*   IF A NAME IS GIVEN, THE ITASK IS LOCATED VIA $WULOC AFTER           01050000
*   ACQUIRING THE DISP LOCK.                                            01060000
*                                                                       01070000
***************************************************************         01080000
         ICM   R5,15,$ASYEADR     ITASK ADDRESS PROVIDED?               01090000
         BNZ   ETASKLOC           READY IF SO                           01100000
                                                                        01110000
         BAS   R14,DISPGET        ACQUIRE DISP LOCK                     01120000
         BNZ   ERR_SERV           DIAGNOSE SERVICE ROUTINE FAILURES     01130000
                                                                        01140000
         $WULOC LOCATE,           LOCATE AN ITASK                      X01150000
               TSKNAME=*$ASYENAM, TASK NAME                            X01160000
               USERDATA=TASKINFO, TASK INFO RETURN AREA                X01170000
               WKA=WK1K,          WORK AREA                            X01180000
               MF=(E,$WUL_MFL)    CONSTRUCTION AREA                     01190000
                                                                        01200000
         CH    R15,=AL2(RC04)     TEST COMPLETION CODE                  01210000
         BL    XTRITASK           ITASK INFORMATION RETURNED            01220000
         BE    ERR_TASK           ITASK NOT FOUND                       01230000
         LA    R1,LBL$WULO        SERVICE ROUTINE NAME                  01240000
         B     ERR_SERV           IDENTIFY POINT OF FAILURE             01250000
                                                                        01260000
XTRITASK DS    0H                                                       01270000
WU       USING IWUENTUD,TASKINFO  WORKUNIT INFORMATION RETURN           01280000
         L     R5,WU.WUDITASK     ITASK CONTROL BLOCK ADDR              01290000
         DROP  WU                 IWUENTID                              01300000
                                                                        01310000
ETASKLOC DS    0H                 R5 <== TARGET ITASK                   01320000
TSK      USING ITASK,R5           ADDRESSABILITY TO TARGET ITASK        01330000
                                                                        01340000
***************************************************************         01350000
*                                                                       01360000
*   STAGE 1:  CREATE AN IRB DESCRIBING THE EXIT                         01370000
*                                                                       01380000
*   AN IRB WORKAREA IS ALLOCATED TO CONTAIN BOTH THE IQE AND            01390000
*   THE PARAMETER LIST PASSED THROUGH TO THE ASYNCH EXIT                01400000
*   ROUTINE.  THE WORKAREA SIZE EXPRESSED BY THE CIRB WKAREA=           01410000
*   OPERAND MUST ALLOW FOR THE IQE CREATED BY THE (VERY                 01420000
*   INTUITIVE) RETIQE=NO OPERAND.                                       01430000
*                                                                       01440000
***************************************************************         01450000
         L     R3,$ASYENP         NUMBER OF PARAMETERS                  01460000
         SLL   R3,2               FOUR BYTES FOR EACH                   01470000
         LA    R3,IQELEN+7(,R3)   ROLL IN SIZE OF AN IQE                01480000
         SRL   R3,3               CONVERT TO DOUBLEWORDS                01490000
                                                                        01500000
         L     R2,$ASYEEP         ASYNCH EXIT RTN EPA                   01510000
         LA    R2,0(,R2)          SANITIZE                              01520000
                                                                        01530000
         CIRB  EP=(R2),KEY=PP,    KEY OF REQUESTER                     X01540000
               MODE=PP,           STATE OF REQUESTER                   X01550000
               SVAREA=YES,        EXIT ROUTINE RECEIVES SAVEAREA       X01560000
               RETIQE=NO,         IQU SCHEDULING METHOD (SEE DEVGDE)   X01570000
               WKAREA=(R3),       SIZE OF IRB RESIDENT WORKAREA        X01580000
               STAB=(DYN),        RELEASE IRB AFTER USE                X01590000
               RETRN=NO           RELEASE THE IQE AFTER USE             01600000
                                                                        01610000
***************************************************************         01620000
*                                                                       01630000
*   BUILD THE EXIT ROUTINE PLIST WITHIN WORKAREA PROVIDED               01640000
*                                                                       01650000
***************************************************************         01660000
         LR    R7,R1              ACCEPT RETURNED IRB                   01670000
         USING RBBASIC,R7         RB ADDRESSABILITY                     01680000
         L     R6,RBNEXAV         LOCATE THE IQE                        01690000
         USING IQESECT,R6                                               01700000
                                                                        01710000
         MODESET EXTKEY=ZERO,SAVEKEY=(2)                                01720000
                                                                        01730000
         SR    R4,R4              ASSUME NO PLIST PROVIDED              01740000
         ICM   R1,15,$ASYENP      NUMBER OF (FULLWORD) PARMS            01750000
         BZ    EPARAM             DONE IF NONE                          01760000
         SLL   R1,2               EACH PARM IS FOUR BYTES               01770000
         BCTR  R1,0               PREPARE FOR EX                        01780000
                                                                        01790000
         LA    R4,IQESECT+IQELEN  BUILD PLIST AFTER THE IQE             01800000
         EX    R1,*+4             PRIVATE COPY OF PLIST                 01810000
         MVC   0(*-*,R4),$ASYEP   COPY PASSED ASYNC EXIT PLIST          01820000
                                                                        01830000
EPARAM   DS     0H                                                      01840000
                                                                        01850000
***************************************************************         01860000
*                                                                       01870000
*   STAGE 2:  COMPLETE THE IQE AND SCHEDXIT                             01880000
*                                                                       01890000
*   THE IQE CONSTRUCTED BY CIRB ABOVE IS COMPLETED WITH THE             01900000
*   ADDRESS OF THE IRB, THE TARGET TCB AND THE EXIT ROUTINE             01910000
*   PARAMETER LIST.  KEY0 IS REQUIRED TO FORMAT THE IQE.                01920000
*   KEY0 AND LOCAL LOCK HELD ARE REQUIRED FOR ISSUERS OF                01930000
*   SCHEDXIT.                                                           01940000
*                                                                       01950000
***************************************************************         01960000
         ST    R7,IQEIRB          POST ADDR OF IRB                      01970000
         MVC   IQETCB,TSK.TSKTCB@ POST ADDR OF TARGET TCB               01980000
         ST    R4,IQEPARAM        POST ASYNC EXIT PLIST ADDR            01990000
                                                                        02000000
         BAS   R14,MVSLGET        ACQUIRE MVS LOCAL LOCK                02010000
                                                                        02020000
         SCHEDXIT IQE=(R6)        SCHEDULE THE IRB                      02030000
                                                                        02040000
         MODESET KEYADDR=(2)      RESTORE PSW KEY                       02050000
         DROP  TSK                TARGET ITASK                          02060000
                                                                        02070000
***************************************************************         02080000
*                                                                       02090000
*   POST COMPLETION STATUS FOR RETURN                                   02100000
*                                                                       02110000
***************************************************************         02120000
NORMRET  DS    0H                 ASYNCH ROUTINE READY FOR EXECUTION    02130000
         LA    R15,RC00           INDICATE SUCCESS                      02140000
         B     RETURN             DONE                                  02150000
                                                                        02160000
ERR_AUTH DS    0H                 APF AUTHORIZATION REQUIRED            02170000
         LA    R15,RC04           INDICATE ENVIRONMENTAL ERROR          02180000
         B     RETURN             FAIL                                  02190000
                                                                        02200000
ERR_TASK DS    0H                 NAMED ITASK NOT FOUND                 02210000
         LA    R15,RC08                                                 02220000
         B     RETURN                                                   02230000
                                                                        02240000
ERR_SERV DS    0H                 SERVICE/ROUTINE FAILURE               02250000
         LR    R0,R15             PRESERVE SERV/RTN COMPLETION CODE     02260000
         LA    R15,RC12           LOCAL INDICATION OF ERROR             02270000
                                                                        02280000
***************************************************************         02290000
*                                                                       02300000
*   CLEANUP THE CURRENT ENVIRONMENT                                     02310000
*                                                                       02320000
***************************************************************         02330000
RETURN   DS    0H                                                       02340000
         STM   R15,R1,RETREGS     PRESERVE RETURN REGS                  02350000
                                                                        02360000
         BAS   R14,MVSLFREE       RELEASE LOCAL LOCK                    02370000
         BAS   R14,DISPFREE       RELEASE DISP LOCK                     02380000
                                                                        02390000
         LM    R15,R1,RETREGS     RESTORE MAINLINE REGS                 02400000
                                                                        02410000
*--------------------------------------------------------------         02420000
*   RETURN TO REQUESTER                                                 02430000
*--------------------------------------------------------------         02440000
         #EXIT ,                                                        02450000
                                                                        02460000
         EJECT                                                          02470000
***************************************************************         02480000
*                                                                       02490000
* ROUTINE: DISPGET - ACQUIRE DISP LOCK                                  02500000
*                                                                       02510000
* RETURNS:                                                              02520000
*                                                                       02530000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES.                    02540000
*        THE CONDITION CODE IS SET ACCORDINGLY.                         02550000
*                                                                       02560000
*        RC00 - LOCK ACQUIRED                                           02570000
*        RC04 - LOCK REQUEST FAILED (R1 CONTAINS SERVICE NAME)          02580000
*                                                                       02590000
***************************************************************         02600000
DISPGET  DS    0H                                                       02610000
         ST    R14,FWORD          PRESERVE RETURN ADDRESS               02620000
                                                                        02630000
         $SER  OBTAIN,DISP        ACQUIRE DISP LOCK                     02640000
         B     *+4(R15)           ANALYZE COMPLETION                    02650000
         B     DLG_ACQ               ACQUIRED                           02660000
         B     DLG_PREV              PREVIOUSLY ACQUIRED                02670000
         B     DLG_FAIL              ERROR                              02680000
                                                                        02690000
DLG_ACQ  DS    0H                                                       02700000
         OI    FLAGS,FDISP        DISP LOCK LOCALLY ACQUIRED            02710000
                                                                        02720000
DLG_PREV DS    0H                                                       02730000
         LA    R15,RC00           DISP LOCK IS HELD, INDICATE SUCCESS   02740000
         B     DLG_RET            DONE                                  02750000
                                                                        02760000
DLG_FAIL DS    0H                 LOCK REQUEST FAILURE                  02770000
         LA    R15,RC04           DISP LOCK IS HELD, INDICATE SUCCESS   02780000
         LA    R1,LBL$SER         RETURN FAILING SERVICE NAME           02790000
                                                                        02800000
DLG_RET  DS    0H                                                       02810000
         L     R14,FWORD          RESTORE RETURN ADDRESS                02820000
         LTR   R15,R15            REFLECT COMPLETION STATUS VIA CC      02830000
         BR    R14                RETURN                                02840000
                                                                        02850000
         EJECT                                                          02860000
***************************************************************         02870000
*                                                                       02880000
* ROUTINE: DISPFREE - RELEASE DISP LOCK                                 02890000
*                                                                       02900000
***************************************************************         02910000
DISPFREE DS    0H                                                       02920000
         ST    R14,FWORD          PRESERVE RETURN ADDRESS               02930000
                                                                        02940000
         TM    FLAGS,FDISP        DISP LOCK LOCALLY ACQUIRED?           02950000
         BNO   DLF_RET            DONE IF NOT                           02960000
         NI    FLAGS,FF-FDISP     CLEAR FLAG BIT ACCORDINGLY            02970000
                                                                        02980000
         $SER  RELEASE,DISP       ACQUIRE DISP LOCK                     02990000
                                                                        03000000
DLF_RET  DS    0H                                                       03010000
         L     R14,FWORD          RESTORE RETURN ADDRESS                03020000
         LTR   R15,R15            REFLECT COMPLETION STATUS VIA CC      03030000
         BR    R14                RETURN                                03040000
                                                                        03050000
         EJECT                                                          03060000
***************************************************************         03070000
*                                                                       03080000
* ROUTINE: MVSLGET - ACQUIRE LOCAL LOCK                                 03090000
*                                                                       03100000
* RETURNS:                                                              03110000
*                                                                       03120000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES.                    03130000
*        THE CONDITION CODE IS SET ACCORDINGLY.                         03140000
*                                                                       03150000
*        RC00 - LOCK ACQUIRED                                           03160000
*        RC04 - LOCK REQUEST FAILED (R1 CONTAINS SERVICE NAME)          03170000
*                                                                       03180000
***************************************************************         03190000
MVSLGET  DS    0H                                                       03200000
         ST    R14,FWORD          PRESERVE RETURN ADDRESS               03210000
                                                                        03220000
         $SER  OBTAIN,LOCAL       ACQUIRE DISP LOCK                     03230000
         B     *+4(R15)           ANALYZE COMPLETION                    03240000
         B     LLG_ACQ               ACQUIRED                           03250000
         B     LLG_PREV              PREVIOUSLY ACQUIRED                03260000
         B     LLG_FAIL              ERROR                              03270000
                                                                        03280000
LLG_ACQ  DS    0H                                                       03290000
         OI    FLAGS,FLOCAL       LOCAL LOCK LOCALLY ACQUIRED           03300000
                                                                        03310000
LLG_PREV DS    0H                                                       03320000
         LA    R15,RC00           DISP LOCK IS HELD, INDICATE SUCCESS   03330000
         B     LLG_RET            DONE                                  03340000
                                                                        03350000
LLG_FAIL DS    0H                 LOCK REQUEST FAILURE                  03360000
         LA    R15,RC04           DISP LOCK IS HELD, INDICATE SUCCESS   03370000
         LA    R1,LBL$SER         RETURN FAILING SERVICE NAME           03380000
                                                                        03390000
LLG_RET  DS    0H                                                       03400000
         L     R14,FWORD          RESTORE RETURN ADDRESS                03410000
         LTR   R15,R15            REFLECT COMPLETION STATUS VIA CC      03420000
         BR    R14                RETURN                                03430000
                                                                        03440000
         EJECT                                                          03450000
***************************************************************         03460000
*                                                                       03470000
* ROUTINE: MVSLFREE - RELEASE (MVS) LOCAL LOCK                          03480000
*                                                                       03490000
***************************************************************         03500000
MVSLFREE DS    0H                                                       03510000
         ST    R14,FWORD          PRESERVE RETURN ADDRESS               03520000
                                                                        03530000
         TM    FLAGS,FLOCAL       DISP LOCK LOCALLY ACQUIRED?           03540000
         BNO   LLF_RET            DONE IF NOT                           03550000
         NI    FLAGS,FF-FLOCAL    CLEAR FLAG BIT ACCORDINGLY            03560000
                                                                        03570000
         $SER  RELEASE,LOCAL      ACQUIRE DISP LOCK                     03580000
                                                                        03590000
LLF_RET  DS    0H                                                       03600000
         L     R14,FWORD          RESTORE RETURN ADDRESS                03610000
         LTR   R15,R15            REFLECT COMPLETION STATUS VIA CC      03620000
         BR    R14                RETURN                                03630000
                                                                        03640000
         EJECT                                                          03650000
***************************************************************         03660000
*                                                                       03670000
*   LOCAL READ/ONLY DATA AREAS, ETC.                                    03680000
*                                                                       03690000
***************************************************************         03700000
LBL$SER  DC    CL8'$SER'          LOCK SERVICE                          03710000
LBL$WULO DC    CL8'$WULOC'        WORKUNIT LOCATOR                      03720000
                                                                        03730000
         LTORG ,                                                        03740000
                                                                        03750000
         PRINT NOGEN                                                    03760000
         ICVT  ,                                                        03770000
         ITASK ,                                                        03780000
                                                                        03790000
         IHAIQE ,                 MVS/ESA INTERRUPTION QUEUE ELEMENT    03800000
         IHARB ,                  MVS/ESA REQUEST BLOCKS                03810000
         END   ,                                                        03820000

IRECDIFF TITLE '- SCREEN IMAGE COMPARE'                                 00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: IRECDIFF - SCREEN IMAGE COMPARE                              00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THIS ROUTINE IS USED TO COMPARE TWO PRESENTATION SPACE             00080000
*    IMAGES, CREATING AN SYSSKS IMAGE IN INTERMEDIATE (TRECAUX)         00090000
*    FORMAT IF FIELDS ARE FOUND TO DIFFER BETWEEN THE CANDIDATE         00100000
*    BUFR-A (OUTBOUND FROM HOST) AND BUFR-B (INBOUND FROM               00110000
*    TERMINAL) IMAGES.                                                  00120000
*                                                                       00130000
*                                                                       00140000
* METHOD:                                                               00150000
*                                                                       00160000
*    THE STRUCTURE (FIELD PLACEMENT AND LENGTH) OF THE BUFR-A           00170000
*    AND BUFR-B IMAGES ARE EXPECTED TO BE IDENTICAL.  THE               00180000
*    MAINLINE LOCATES FIELD PAIRS, ONE FROM BUFR-A AND ONE FROM         00190000
*    BUFR-B, AND INVOKES THE FIELD COMPARE SERVICE IF THE               00200000
*    FIELDS ARE UNPROTECTED.  ANY TEXTUAL DIFFERENCES FOUND             00210000
*    RESULT IN AN EXTENSION OF THE SKS-RESIDENT SCRIPT.                 00220000
*                                                                       00230000
*    WE FIRST ATTEMPT TO BUILD THE INTERMEDIATE SYSSKS (AUX),           00240000
*    TABLE ROW IN THE SESSIMAG.SEISKSRS WORKAREA. IF THAT AREA          00250000
*    OVERFLOWS, DYNAMICALLY ACQUIRED ($GETSTOR) STORAGE IS              00260000
*    SUBSTITUTED.                                                       00270000
*                                                                       00280000
*                                                                       00290000
* ON ENTRY:                                                             00300000
*                                                                       00310000
*    R1  CONTAINS THE ADDRESS OF THE SESSIMAG                           00320000
*                                                                       00330000
*                                                                       00340000
* ON EXIT:                                                              00350000
*                                                                       00360000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES. REASON             00370000
*        CODES, WHEN DEFINED, ARE RETURNED IN R0.                       00380000
*                                                                       00390000
*           RC00 - FUNCTION COMPLETE. IF PRES SPACE DIFFERENCES         00400000
*                  ARE FOUND, R1 CONTAINS THE ADDRESS OF THE AUX        00410000
*                  TABLE-READY INTERMEDIATE SYSSKS REPRESENTATION       00420000
*                  OF THE DELTAS.  OTHERWISE R1 CONTAINS ZERO.          00430000
*                                                                       00440000
*           RC04 - RESULT SCREEN IS CLEAR, NO SKS REQUIRED              00450000
*                                                                       00460000
**<DOC-OFF>****************************************************         00470000
                                                                        00480000
         EJECT                                                          00490000
***************************************************************         00500000
*                                                                       00510000
* MAINTENANCE:                                                          00520000
*                                                                       00530000
*   12/06/94 R. Turgeon                                                 00540000
*            Removed PAGE= / SHRPAGE= for $SPACE, $OBJECT,              00550000
*            and TB* service requests                                   00560000
*                                                                       00570000
***************************************************************         00580000
                                                                        00590000
         EJECT                                                          00600000
         #WORK ,                                                        00610000
                                                                        00620000
#FIELDS  DS    F                  # FIELD PENDING COMPARE               00630000
#OFF1ST  DS    H                  OFFSET TO FIRST FIELD, USED FOR       00640000
*                                 ...RECOGNIZING FIELD WRAP             00650000
CURFIELD DS    A                  FOR INVISIBLE ATTR TEST IN SKSADD     00660000
                                                                        00670000
$TSKSA   DS    A                  ADDR OF TRECAUX/SKS ORIGIN OR ZERO    00680000
$TSKSLN  DS    F                  LENGTH OF ROW PREP BUFFER             00690000
                                                                        00700000
REGSAVE  DS    16F                LOCAL REGISTER SAVEAREA               00710000
REGSAVE2 DS    16F                LOCAL REGISTER SAVEAREA               00720000
                                                                        00730000
WK1K     DS    XL1024             1K WORKAREA FOR SERVICE ROUTINES      00740000
                                                                        00750000
         EJECT                                                          00760000
         FLDCMPRM DSECT=NO        FIELD COMPARE PLIST AND RETURN AREA   00770000
                                                                        00780000
         #ENDWORK ,                                                     00790000
                                                                        00800000
         EJECT                                                          00810000
         ICATALOG SKS             SYSSKS ROW FORMAT                     00820000
                                                                        00830000
         EJECT                                                          00840000
         SESSIMAG ,               EMULATOR SESS / RECORDING AREA        00850000
                                                                        00860000
         EJECT                                                          00870000
         TRECAUX ,                TEMP TABLE FOR CANDIDATE RECORDINGS   00880000
                                                                        00890000
         EJECT                                                          00900000
         PUSH  PRINT                                                    00910000
         PRINT NOGEN                                                    00920000
         ISTDBIND ,               VTAM BIND DEFINITION USED IN ISESS    00930000
         POP   PRINT                                                    00940000
                                                                        00950000
         EJECT                                                          00960000
         ISESS    ,               3270 MAPPINGS                         00970000
                                                                        00980000
         EJECT                                                          00990000
         $SKS  ,                  SCRIPT LANGUAGE MAPPINGS & EQUATES    01000000
                                                                        01010000
         EJECT                                                          01020000
         ABCODES ,                                                      01030000
         EQUS  ,                                                        01040000
                                                                        01050000
         EJECT                                                          01060000
IRECDIFF #ENTER PREG=R8                                                 01070000
                                                                        01080000
         USING ICVT,R11           STDENV                                01090000
         USING ITASK,R10          PROCESS MODE                          01100000
         USING IPCB,R9                                                  01110000
         L     R9,TSKPCBC                                               01120000
                                                                        01130000
         EJECT                                                          01140000
***************************************************************         01150000
*                                                                       01160000
*   FETCH PARAMETERS, VALIDATE REQUEST                                  01170000
*                                                                       01180000
***************************************************************         01190000
         USING SESSIMAG,R8        LIFE OF FUNCTION                      01200000
                                                                        01210000
         TM    SEIS1ATR,SEIA_CLR  SOURCE IMAGE CLEARED?                 01220000
         BO    RET_CLR            DONE IF SO                            01230000
         TM    SEIS1ATR,SEIA_UNF  UNFORMATTED IMAGE?                    01240000
         BO    SCANUNF            PROCESS ACCORDINGLY                   01250000
         B     SCANSTD            FIELD-BY-FIELD COMPARE OTHERWISE      01260000
                                                                        01270000
         EJECT                                                          01280000
***************************************************************         01290000
*                                                                       01300000
*   UNFORMATTED IMAGES ARE TREATED AS A SINGLE FIELD THAT               01310000
*   BEGINS AT THE OFFSET IN EACH WHERE A DIFFERENCE OCCURS              01320000
*   AND CONTINUES THRU TO THE END OF THE SCREEN. THIS TREATMENT         01330000
*   IS CONSISTANT WITH THE OPERATION OF THE 3270 ERASE-EOF KEY          01340000
*   ON AN UNFORMATTED SCREEN.                                           01350000
*                                                                       01360000
***************************************************************         01370000
SCANUNF  DS    0H                                                       01380000
         L     R4,SEIS1IMG        CURRENT IMAGE ORIGIN                  01390000
         L     R5,SEIS1SIZ        CURRENT IMAGE SIZE                    01400000
                                                                        01410000
         TM    SEIS0ATR,SEIA_CLR  SOURCE IMAGE CLEAR?                   01420000
         BO    UNFCMP             BYPASS IMAGE COMPARE                  01430000
         ICM   R15,15,SEIS0SIZ    S0 IMAGE DEFINED?                     01440000
         BZ    UNFCMP             BYPASS IMAGE COMPARE IF NOT           01450000
                                                                        01460000
         L     R14,SEIS0IMG       BASE IMAGE ORIGIN                     01470000
         CLCL  R4,R14             IMAGES MATCH EXACTLY?                 01480000
         BE    RET_FIN            DONE IF SO, ELSE NEW (R4,R5)          01490000
                                                                        01500000
*--------------------------------------------------------------         01510000
*   GENERATE PARTIAL IMAGE-REPLACE SKS VIA MOCK-UP FLDCMPRM             01520000
*--------------------------------------------------------------         01530000
UNFCMP   DS    0H                                                       01540000
         XC    FLDCMPRM(FLDCMPLN),FLDCMPRM                              01550000
         MVC   FBUFRB,SEIS1IMG    S1 IS BUFFERB - DELTA                 01560000
         LR    R0,R4              MODIFIABLE COPY OF DIFF ORIGIN        01570000
         S     R0,SEIS1IMG        OFFSET TO FIELD ORIGIN                01580000
         ST    R0,FOFF1           FIELD COMPARE FORMAT                  01590000
         ST    R5,FLEN1           FIELD LENGTH / TO END OF IMAGE        01600000
                                                                        01610000
         CLI   0(R4),0            LEADING NULLS?                        01620000
         BNE   UNFJUST            SKIP IF NOT                           01630000
                                                                        01640000
         $REPS FWD,(R4),(R5),WORKAREA=WK1K                              01650000
                                                                        01660000
         AR    R4,R15             BYPASS LEADING ZEROS                  01670000
         SR    R5,R15             ADJUST LENGTH ACCORDINGLY             01680000
         BP    UNFJUST            TEXT REMAINS                          01690000
         LA    R0,RC04            ELSE FIELD WAS ZEROED                 01700000
         B     UNFSKS             CREATE APPROPRIATE SKS                01710000
                                                                        01720000
*--------------------------------------------------------------         01730000
*   DIFFERENCES EXIST IN NEW IMAGE, TRIM TRAILING REPEATERS             01740000
*--------------------------------------------------------------         01750000
UNFJUST  DS    0H                                                       01760000
         ST    R4,FRETEX1         REPLACEMENT ORIGIN                    01770000
         ST    R5,FRETEX1L        REPLACEMENT LENGTH                    01780000
                                                                        01790000
         $REPS BWD,(R4),(R5),WORKAREA=WK1K                              01800000
                                                                        01810000
         C     R15,=F'1'          REPEATERS AT END?                     01820000
         BNH   UNFSKS             SKIP IF NOT                           01830000
         ST    R1,FRETPAD         POST REPEATER CHAR PTR                01840000
         SR    R5,R15             TRIM REPLACEMENT TEXT                 01850000
         ST    R5,FRETEX1L        UPDATE LENGTH ACCORDINGLY             01860000
         LA    R0,RC08            IMAGES DIFFER                         01870000
                                                                        01880000
*--------------------------------------------------------------         01890000
*   POST REPLACEMENT DATA                                               01900000
*--------------------------------------------------------------         01910000
UNFSKS   DS    0H                 R0 CONTAINS IFLDCMP-LIKE RC           01920000
         XC    CURFIELD,CURFIELD  NOT AVAILABLE                         01930000
         LA    R1,FLDCMPRM        FIELD COMPARE RESULTS                 01940000
         BAS   R14,SKSADD         UPDATE SKS                            01950000
         B     RET_FIN            DONE                                  01960000
                                                                        01970000
         EJECT  ,                                                       01980000
***************************************************************         01990000
*                                                                       02000000
*   SCAN FORMATTED IMAGES COMPARING CONTENT OF UNPROTECTED FLDS         02010000
*                                                                       02020000
***************************************************************         02030000
SCANSTD  DS    0H                                                       02040000
         ICM   R7,15,SEIS1FLV     FIELD VECTOR                          02050000
         BZ    ERR_REQ            INCOMPLETE REQ IF NOT                 02060000
         C     R7,SEIS0FLV        S0 - S1 IMAGES STRUCTURALLY SAME?     02070000
         BNE   ERR_REQ            NO INTERPRETATION POSSIBLE OTHERWISE  02080000
                                                                        02090000
         SR    R1,R1              PREPARE FOR INSERT                    02100000
         ICM   R1,3,0(R7)         FETCH FIELD COUNT                     02110000
         BZ    ERR_REQ            ERROR IF ZERO                         02120000
         ST    R1,#FIELDS         SAVE LOCAL, MODIFIABLE COPY           02130000
         LA    R7,2(,R7)          ADVANCE TO ENTRY SECTION              02140000
         MVC   #OFF1ST,0(R7)      RETAIN OFFSET TO FIRST FIELD          02150000
                                                                        02160000
*--------------------------------------------------------------         02170000
*   COMPARE NEXT FIELD PAIR                                             02180000
*--------------------------------------------------------------         02190000
SCANFLD  DS    0H                                                       02200000
         LH    R3,2(,R7)          DISP TO FOLLOWING FLD LESS DISP ...   02210000
         SH    R3,0(,R7)          TO CURR FLD GIVES FIELD LENGTH        02220000
         BCTR  R3,0               DISCARD ATTRIBUTE BYTE                02230000
                                                                        02240000
         SR    R2,R2              LENGTH OF WRAP EXTENT                 02250000
         L     R0,#FIELDS         CURRENT FIELD NUMBER, ONE IF LAST     02260000
         C     R0,=F'1'           LAST FIELD MAY WRAP                   02270000
         BNE   *+8                BUT NO OTHER                          02280000
         LH    R2,#OFF1ST         FETCH WRAP EXTENT LENGTH              02290000
                                                                        02300000
         LA    R5,0(R2,R3)        TOTAL LENGTH OF FIELD                 02310000
         LTR   R5,R5              ROOM FOR TEXT?                        02320000
         BNP   SCANADV            SKIP IF NULL                          02330000
                                                                        02340000
         LH    R4,0(,R7)          FIELD OFFSET                          02350000
         AL    R4,SEIS0IMG        LOCATE FIELD ORIGIN                   02360000
         TM    0(R4),#3270PRO     PROTECTED FIELD?                      02370000
         BO    SCANADV            NOT INTERESTED IF SO                  02380000
         ST    R4,CURFIELD        SAVE FOR INVISIBLE TEST IN SKSADD     02390000
                                                                        02400000
*--------------------------------------------------------------         02410000
*   CONSTRUCT FIELD COMPARE PLIST AND INVOKE COMPARE ROUTINE            02420000
*--------------------------------------------------------------         02430000
         XC    FLDCMPRM(FLDCMPLN),FLDCMPRM                              02440000
         MVC   FBUFRA,SEIS0IMG    S0 IS BUFFERA - BASE                  02450000
         MVC   FBUFRB,SEIS1IMG    S1 IS BUFFERB - DELTA                 02460000
         LH    R4,0(,R7)          FIELD OFFSET IN BOTH BUFFERS          02470000
         LA    R4,1(,R4)          BYPASS ATTRIBUTE BYTE                 02480000
         ST    R4,FOFF1           ORIGIN OF FIRST (BOTTOM) SEGMENT      02490000
                                                                        02500000
         ST    R3,FLEN1           LENGTH OF 1ST EXTENT                  02510000
         ST    R2,FLEN2           LENGTH OF 2ND EXTENT                  02520000
                                                                        02530000
         L     R0,WK1K            1K WORKAREA SATISFIES REQMTS          02540000
         LA    R1,FLDCMPRM        FIELD COMPARE PLIST                   02550000
         @CALL IFLDCMP,CTYPE=CVT  INVOKE SERVICE ROUTINE                02560000
                                                                        02570000
         LTR   R0,R15             DIFFERENCES ENCOUNTERED?              02580000
         BZ    SCANADV            ONWARD IF NOT                         02590000
         LA    R1,FLDCMPRM        FIELD COMPARE PLIST / RETURN AREA     02600000
         BAS   R14,SKSADD         UPDATE SKS                            02610000
                                                                        02620000
*--------------------------------------------------------------         02630000
*   ADVANCE TO NEXT FIELD - FINALIZE SKS UPON COMPLETION                02640000
*--------------------------------------------------------------         02650000
SCANADV  DS    0H                                                       02660000
         LA    R7,2(,R7)          ADVANCE TO NEXT FIELD OFFSET          02670000
         L     R15,#FIELDS        NUMBER OF FIELDS PENDING COMPARE      02680000
         BCTR  R15,0              ACCOUNT FOR THIS PASS                 02690000
         ST    R15,#FIELDS        SAVE UPDATED COUNT                    02700000
         LTR   R15,R15            WORK PENDING?                         02710000
         BNZ   SCANFLD                                                  02720000
                                                                        02730000
         EJECT                                                          02740000
***************************************************************         02750000
*                                                                       02760000
*   RETURN COMPLETION STATUS AND TRECAUX/SYSSKS TO REQUESTOR            02770000
*                                                                       02780000
***************************************************************         02790000
RET_FIN  DS    0H                                                       02800000
         LA    R15,RC00           SUCCESFUL COMPLETION                  02810000
         L     R1,$TSKSA          RETURN TABLE-READY AUX ROW            02820000
         SR    R0,R0              REASON CODES NOT DEFINED              02830000
         B     EXIT                                                     02840000
                                                                        02850000
RET_CLR  DS    0H                                                       02860000
         LA    R15,RC04           CURRENT IMSAGE IS CLEAR               02870000
         SR    R1,R1              NO SKS REQUIRED                       02880000
         SR    R0,R0              REASON CODES NOT DEFINED              02890000
         B     EXIT                                                     02900000
                                                                        02910000
ERR_REQ  DS    0H                 PROGRAMMING ERROR                     02920000
         EX    R0,*               TRAP                                  02930000
         LA    R15,RC08           INCOMPLETE OR UNNECESSARY REQUEST     02940000
         SR    R1,R1              NO DIFFERENCE SKS GENERATED           02950000
         SR    R0,R0              REASON CODES NOT DEFINED              02960000
                                                                        02970000
EXIT     DS    0H                                                       02980000
         #EXIT ,                                                        02990000
                                                                        03000000
         EJECT                                                          03010000
**<DOC-ON>*****************************************************         03020000
*                                                                       03030000
* ROUTINE:  SKSADD - ADD IMAGE DELTA TO SKS                             03040000
*                                                                       03050000
* DESCRIPTION:                                                          03060000
*                                                                       03070000
*    THIS ROUTINE IS CALLED TO INCLUDE A DESCRIPTION OF A FIELD         03080000
*    CHANGE IN THE SYSSKS REPRESENTING AN S0 TO S1 TRANSITION.          03090000
*    THE PORTION OF THE SKS WHICH CONTAINS THE 3270 KEYSTROKES          03100000
*    IS REFERRED TO AS A SCRIPT.  IT CONVEYS EACH FIELD CHANGE          03110000
*    VIA SCRIPT STATEMENTS WHICH CONSIST OF A STATEMENT VERB            03120000
*    FOLLOWED BY VERB-DEPENDENT OPERANDS.  THE SCRIPT CREATED           03130000
*    DURING A RECORDING IS CONFINED TO THE FOLLOWING STATEMENT          03140000
*    TYPES:                                                             03150000
*                                                                       03160000
*       _CSR   - ESTABLISH POSITION                                     03170000
*       _EOF   - ERASE EOF (OPTIONALLY, DEPENDING ON FIELD CONTENT)     03180000
*       _TEXT  - TEXT ENTRY                                             03190000
*       _END   - END OF SCRIPT (LAST STATEMENT OF SCRIPT)               03200000
*                                                                       03210000
*                                                                       03220000
* ON ENTRY:                                                             03230000
*                                                                       03240000
*     R1 - FLDCMPRM PARAMETER / RETURN AREA                             03250000
*                                                                       03260000
*     R0 - IFLDCMP COMPLETION CODE                                      03270000
*                                                                       03280000
*          00 - FIELDS ARE IDENTICAL                                    03290000
*          04 - S1 IMAGE ZEROED                                         03300000
*          08 - S1 IMAGE CHANGE                                         03310000
*                                                                       03320000
*     $TSKSA  - ADDR OF TRECAUX / SYSSKS CONSTRUCTION AREA              03330000
*     $TSKSLN - LENGTH OF CONSTRUCTION AREA                             03340000
*                                                                       03350000
**<DOC-OFF>****************************************************         03360000
                                                                        03370000
SKSADD   DS    0H                                                       03380000
         STM   R0,R15,REGSAVE     SAVE MAINLINE REGS                    03390000
         LTR   R0,R0              CHANGE INDICATED?                     03400000
         BZ    SKSAFIN            DONE IF NOT                           03410000
                                                                        03420000
         LR    R4,R1              FIELD COMPARE PLIST / RETURN AREA     03430000
         USING FLDCMPRM,R4        MAPPED                                03440000
         USING TRECAUX,R6         MAP CONTAINER ROW                     03450000
         USING SYSSKS,R5          MAP SKS ROW                           03460000
                                                                        03470000
         ICM   R6,15,$TSKSA       SYSSKS CONSTRUCTION INITIATED?        03480000
         BZ    SKSAINIT           DO IT NOW IF NOT                      03490000
         LA    R5,TRECAUX+TRECAUXL   SYSSKS ORIGIN                      03500000
         B     SKSACONT           CONTINUE IF SO                        03510000
                                                                        03520000
SKSAINIT DS    0H                                                       03530000
         XC    SEISKSRS,SEISKSRS  INITIALIZE                            03540000
         LA    R6,SEISKSRS        SELECT SESSIMAG RESIDENT BUILD AREA   03550000
         ST    R6,$TSKSA          SAVE ADDR OF ROW UNDER CONSTRUCTION   03560000
         LA    R0,L'SEISKSRS      LENGTH OF BUILD AREA                  03570000
         ST    R0,$TSKSLN         SAVE BUFFER CONFIG INFO               03580000
         LA    R5,TRECAUX+TRECAUXL   SYSSKS ORIGIN                      03590000
         LA    R0,1               LENGTH OF END-OF-SCRIPT STMT          03600000
         ST    R0,SSKSCRPT+0      NULL PROGRAM SHELL                    03610000
                                                                        03620000
*--------------------------------------------------------------         03630000
*   ESTABLISH START POSITION                                            03640000
*--------------------------------------------------------------         03650000
SKSACONT DS    0H                                                       03660000
         L     R2,FOFF1           OFFSET TO IMAGE FIELD                 03670000
         ICM   R0,15,FLEN1        SEGMENT 1 USED?                       03680000
         BNZ   *+8                SKIP IF SO                            03690000
         L     R2,FOFF2           ELSE TEXT IN SEGMENT 2                03700000
                                                                        03710000
         LA    R1,$SKVCL          LENGTH OF _CSR STATEMENT              03720000
         BAS   R14,SKALLOC        ALLOCATE SPACE FOR STATEMENT          03730000
                                                                        03740000
         USING $SKVCSR,R1         STATEMENT MAP                         03750000
         MVI   $SKVC,$SKSV_CSR    VERB CODE                             03760000
         STH   R2,$SKVCPOS        IMAGE POSTION AT FIELD ORIGIN         03770000
         DROP  R1                 STATEMENT                             03780000
                                                                        03790000
*--------------------------------------------------------------         03800000
*   ERASE-EOF IF FIELD TERMINATES WITH A ZERO                           03810000
*--------------------------------------------------------------         03820000
         L     R2,REGSAVE         REFETCH IFLDCMP COMPLETION CODE       03830000
         C     R2,=A(RC04)        FIELD IS NULL                         03840000
         BE    SKSAEOF            ERASE EOF IF SO                       03850000
         ICM   R1,15,FRETPAD      TRAILING FILL CHARACTER?              03860000
         BZ    SKSATEXT           SKIP IF NOT                           03870000
         CLI   0(R1),0            NULL CHAR                             03880000
         BNE   SKSATEXT           SKIP IF NOT                           03890000
                                                                        03900000
SKSAEOF  DS    0H                 ERASE EOF OPERATION                   03910000
         LA    R1,1               LENGTH OF _EOF STATEMENT              03920000
         BAS   R14,SKALLOC        ALLOCATE SPACE FOR STATEMENT          03930000
         MVI   0(R1),$SKSV_EOF    VERB CODE                             03940000
                                                                        03950000
*--------------------------------------------------------------         03960000
*   TEXT ENTRY IF TEXT DEFINED                                          03970000
*--------------------------------------------------------------         03980000
SKSATEXT DS    0H                                                       03990000
         L     R2,FRETEX1L        EXTENT 1 TEXT LENGTH                  04000000
         A     R2,FRETEX2L        PLUS EXTENT 2 TEXT LENGTH             04010000
         LA    R1,$SKVTL(,R2)     TEXT STATEMENT TOTAL REQMT            04020000
         BAS   R14,SKALLOC        ALLOCATE SPACE FOR STATEMENT          04030000
                                                                        04040000
         USING $SKVTEXT,R1        STATEMENT MAP                         04050000
         MVI   $SKVT,$SKSV_TEXT   VERB CODE                             04060000
         ICM   R15,15,FRETPAD     TRAILING FILL CHARACTER?              04070000
         BZ    *+10               SKIP IF NOT                           04080000
         MVC   $SKVTPAD,0(R15)    RETAINED OTHERWISE                    04090000
         STH   R2,$SKVTXLN        TEXT LENGTH                           04100000
         ICM   R2,15,CURFIELD     FIELD IN IMAGE                        04110000
         BZ    SKSTEX0            SKIP IF N/A                           04120000
         TM    0(R2),#3270INV     INVISIBLE ?                           04130000
         BNO   SKSTEX0            SKIP IF NOT                           04140000
         MVI   $SKVTFLG,$SKVT$IF  TEXT IS INVISIBLE                     04150000
                                                                        04160000
SKSTEX0  DS    0H                                                       04170000
         LA    R3,$SKVTDAT        TEXT INSERTION AREA                   04180000
         ICM   R2,15,FRETEX1L     EXTENT 1 TEXT LENGTH                  04190000
         BZ    SKSTEX1            SKIP IF N/A                           04200000
         BCTR  R2,0               LENGTH CODE                           04210000
         L     R14,FRETEX1        TEXT ORIGIN                           04220000
         EX    R2,SKSAMVC         TEXT SEGMENT 1                        04230000
         LA    R3,1(R2,R3)        ADVANCE TO END OF TEXT SO FAR         04240000
                                                                        04250000
SKSTEX1  DS    0H                                                       04260000
         ICM   R2,15,FRETEX2L     EXTENT 2 TEXT LENGTH                  04270000
         BZ    SKSTEX2            SKIP IF N/A                           04280000
         BCTR  R2,0               LENGTH CODE                           04290000
         L     R14,FRETEX2        TEXT ORIGIN                           04300000
         EX    R2,SKSAMVC         TEXT SEGMENT 1                        04310000
                                                                        04320000
SKSTEX2  DS    0H                                                       04330000
         B     SKSAFIN            DONE                                  04340000
                                                                        04350000
SKSAMVC  MVC   0(*-*,R3),0(R14)   EX OBJECT                             04360000
         DROP  R1                 STATEMENT                             04370000
                                                                        04380000
*--------------------------------------------------------------         04390000
*   RETURN TO MAINLINE                                                  04400000
*--------------------------------------------------------------         04410000
SKSAFIN  DS    0H                                                       04420000
         LM    R0,R14,REGSAVE     RESTORE MAINLINE REGS                 04430000
         SR    R15,R15            RETURN CODES NOT DEFINED              04440000
         BR    R14                RETURN                                04450000
         DROP  R5,R6              SYSSKS, TRECAUX                       04460000
                                                                        04470000
         EJECT                                                          04480000
**<DOC-ON>*****************************************************         04490000
*                                                                       04500000
* ROUTINE:  SKALLOC - ACQUIRE SYSSKS STATEMENT ENTRY                    04510000
*                                                                       04520000
* DESCRIPTION:                                                          04530000
*                                                                       04540000
*    ACQUIRE A STATEMENT EXTENT AT THE END OF THE CURRENT               04550000
*    SYSSKS BUFFER HAVING THE GIVEN LENGTH.  THE LOGIC ENSURES          04560000
*    THAT THE NEW SCRIPT STATEMENT IS FOLLOWED BY AN END-SCRIPT         04570000
*    MARKER. THE VARX SCRIPT LENGTH FIELD IS UPDATED                    04580000
*    ACCORDINGLY. IF SUFFICIENT SPACE IS NOT AVAILABLE IN THE           04590000
*    CURRENT SKS BUFFER, A NEW BUFFER IS ALLOCATED, ETC.                04600000
*                                                                       04610000
*                                                                       04620000
* ON ENTRY:                                                             04630000
*                                                                       04640000
*    R1 - LENGTH OF STATEMENT                                           04650000
*                                                                       04660000
*                                                                       04670000
* ON EXIT:                                                              04680000
*                                                                       04690000
*    R1 - STATEMENT INSERTION ADDRESS                                   04700000
*                                                                       04710000
**<DOC-OFF>****************************************************         04720000
                                                                        04730000
SKALLOC  DS    0H                                                       04740000
         STM   R0,R15,REGSAVE2    SAVE MAINLINE REGS                    04750000
                                                                        04760000
         LR    R9,R1              LENGTH OF CANDIDATE STATEMENT         04770000
                                                                        04780000
*--------------------------------------------------------------         04790000
*   ALLOCATE STATMENT FROM END OF SKS BUFFER IF SPACE IS AVAIL          04800000
*--------------------------------------------------------------         04810000
SKARETRY DS    0H                                                       04820000
         L     R6,$TSKSA          TREC / SYSSKS CONSTRUCTION AREA       04830000
         USING TRECAUX,R6         CONTAINER ROW                         04840000
         LA    R5,TRECAUX+TRECAUXL                                      04850000
         USING SYSSKS,R5          MAP SYSSKS UNDER CONSTRUCTION         04860000
                                                                        04870000
         LA    R4,SYSSKS+SSKSLN   END OF FIXED PORTION OF SKS ROW       04880000
         A     R4,SSKSCRPT+0      END OF SCRIPT                         04890000
         LR    R0,R6              BUFFER ORIGIN                         04900000
         A     R0,$TSKSLN         END OF BUFFER                         04910000
         SR    R0,R4              LENGTH REMAINING                      04920000
         CR    R9,R0              ENOUGH SPACE FOR NEW STATEMENT?       04930000
         BH    SKANEWBF           NEW BUFFER REQUIRED IF NOT            04940000
                                                                        04950000
         A     R9,SSKSCRPT+0      SKS EXTENDED BY REQUEST AMOUNT        04960000
         ST    R9,SSKSCRPT+0      SAVE NEW SCRIPT LENGTH                04970000
         BCTR  R4,0               INSERT OVER OLD END-OF-SCRIPT STMT    04980000
         LR    R1,R4              RETURN INSERTION AREA                 04990000
         B     SKAEXIT            DONE                                  05000000
                                                                        05010000
*--------------------------------------------------------------         05020000
*   REALLOCATE THE BUFFER AND COPY THE OLD DATA                         05030000
*--------------------------------------------------------------         05040000
SKANEWBF DS    0H                                                       05050000
         L     R2,$TSKSLN         CURRENT LENGTH OF ROW BUFFER          05060000
                                                                        05070000
SKASIZE  DS    0H                 DERIVE EXTENSION SIZE                 05080000
         CR    R2,R1              DOUBLED EXTENT SATISFIES REQ?         05090000
         BNL   SKAREACQ           CONTINUE IF SO                        05100000
         AR    R2,R2              DOUBLE SPACE FOR NEXT ATTEMPT         05110000
         B     SKASIZE            REPEAT SIZE TEST                      05120000
                                                                        05130000
SKAREACQ DS    0H                 ACQUIRE NEW ROW BUFFER                05140000
         A     R2,$TSKSLN         ACCOUNT FOR OLD ALLOCATION            05150000
                                                                        05160000
         $GETSTOR (R2)            ACQUIRE NEW BUFFER                    05170000
                                                                        05180000
         LR    R3,R1              PRESERVE NEW BUFFER ADDR              05190000
         LR    R14,R1             BUFFER COPY                           05200000
         L     R15,$TSKSLN        LARGEST AMOUNT POSSIBLY USED          05210000
         L     R0,$TSKSA          SOURCE BUFFER                         05220000
         LR    R1,R15             SOURCE LENGTH = TARGET LENGTH         05230000
         MVCL  R14,R0             COPY                                  05240000
                                                                        05250000
*--------------------------------------------------------------         05260000
*   RELEASE THE OLD BUFFER IF DYNAMICALLY ALLOCATED                     05270000
*--------------------------------------------------------------         05280000
         L     R4,$TSKSA          OLD BUFFER                            05290000
         LA    R0,SEISKSRS        USUAL CONSTRUCTION AREA               05300000
         CR    R4,R0              STORAGE RELEASE OBLIGATION?           05310000
         BE    SKASTSET           SKIP IF NOT                           05320000
                                                                        05330000
         $RETSTOR (R4)            RELEASE OLD BUFFER                    05340000
                                                                        05350000
SKASTSET DS    0H                 REPLACE OLD BUFFER WITH LARGER ONE    05360000
         ST    R3,$TSKSA          ROW ORIGIN                            05370000
         ST    R2,$TSKSLN         ROW LENGTH                            05380000
         B     SKARETRY           RETRY                                 05390000
                                                                        05400000
*--------------------------------------------------------------         05410000
*   RETURN STORAGE SLOT TO CALLER                                       05420000
*--------------------------------------------------------------         05430000
SKAEXIT  DS    0H                                                       05440000
         LM    R2,R14,REGSAVE2+8  RESTORE MAINLINE REGS                 05450000
         BR    R14                RETURN                                05460000
                                                                        05470000
         EJECT                                                          05480000
***************************************************************         05490000
*                                                                       05500000
*   LOCAL READ-ONLY DATA AREAS                                          05510000
*                                                                       05520000
***************************************************************         05530000
         LTORG ,                                                        05540000
                                                                        05550000
         EJECT                                                          05560000
         PRINT NOGEN                                                    05570000
         ICVT  ,                                                        05580000
         ITASK ,                                                        05590000
         IPCB  ,                                                        05600000
         END   ,                                                        05610000

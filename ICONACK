ICONACK TITLE 'ICONACK - ACKNOWLEDGE COMMAND REQUEST/RESPONSE'          00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE:  ICONACK - Acknowledge command REQUEST/RESPONSE              00040000
*                                                                       00050000
* Description:                                                          00060000
*                                                                       00070000
*    This routine implements the $COMACK macro services.                00080000
*    It provides a common facility for recipients of command            00090000
*    REQUEST or RESPONSE messages to extract the CMDREQ                 00100000
*    and MSGRSRCID components from the command buffer.                  00110000
*    Refer to the $COMACK macro prolog for details.                     00120000
*                                                                       00130000
*                                                                       00140000
* On entry:                                                             00150000
*                                                                       00160000
*    R1  contains the address of a parameter list described by          00170000
*        the $COMACK DSECT=YES mapping.                                 00180000
*                                                                       00190000
*                                                                       00200000
* On exit:                                                              00210000
*                                                                       00220000
*    R15 Contains zero or an error code generated by the                00230000
*        ICONACK service routine as summarized below                    00240000
*                                                                       00250000
*    R1  contains the address of the CMDREQ component of                00260000
*        the command message                                            00270000
*                                                                       00280000
*    R0  contains the addres of the MSGRSRCID component of              00290000
*        the command message or zero if $MSG collection is              00300000
*        not active                                                     00310000
*                                                                       00320000
*                                                                       00330000
*           RC00 - normal completion                                    00340000
*                                                                       00350000
*           RC04 - CMDMSGIN is not a command REQUEST or                 00360000
*                  RESPONSE message - no action taken                   00370000
*                                                                       00380000
*           RC08 - $TASK POST failed                                    00390000
*                                                                       00400000
*                  R0 contains the $TASK return code                    00410000
*                                                                       00420000
*           RC12 - $SRM ACQUIRE failed                                  00430000
*                                                                       00440000
*                  R0 contains the $SRM return code                     00450000
*                                                                       00460000
**<DOC-OFF>****************************************************         00470000
                                                                        00480000
         EJECT                                                          00490000
**************************************************************          00500000
*                                                                       00510000
* MAINTENANCE:                                                          00520000
*                                                                       00530000
*    08/15/94 R. Turgeon              PAR #137762                       00540000
*             Initial version; intertask command processing             00550000
*                                                                       00560000
**************************************************************          00570000
                                                                        00580000
         EJECT                                                          00590000
         $COMACK DSECT=YES        REQUEST PLIST                         00600000
                                                                        00610000
         EJECT                                                          00620000
         CMDREQ ,                 COMMAND EXECUTION REQUEST BLOCK       00630000
                                                                        00640000
         EJECT                                                          00650000
         $TASK DSECT=YES          $TASK SERVICES                        00660000
                                                                        00670000
         EJECT                                                          00680000
         $SRM  DSECT=YES          SHARED RESOURCE MANAGEMENT            00690000
                                                                        00700000
         EJECT                                                          00710000
         TMSG  ,                  INTERTASK MESSAGE FORMAT              00720000
                                                                        00730000
         EJECT                                                          00740000
         MSGCODES ,               INTERTASK MESSAGING CODES             00750000
                                                                        00760000
         EQUS  ,                                                        00770000
                                                                        00780000
         EJECT                                                          00790000
         #WORK ,                                                        00800000
                                                                        00810000
SRMRETCD DS    F                  $SRM SERVICE RETURN CODE              00820000
                                                                        00830000
$SRMMFL  $SRM  MF=(L,*)           $SRM  PLIST CONSTRUCTION AREA         00840000
$TASKMFL $TASK MF=(L,*)           $TASK PLIST CONSTRUCTION AREA         00850000
                                                                        00860000
         #ENDWORK                                                       00870000
                                                                        00880000
         EJECT                                                          00890000
ICONACK  #ENTER PREG=R8                                                 00900000
                                                                        00910000
         USING ITASK,R10          STDENV                                00920000
                                                                        00930000
         EJECT                                                          00940000
***************************************************************         00950000
*                                                                       00960000
*   VALIDATE PASSED PARAMETERS                                          00970000
*                                                                       00980000
***************************************************************         00990000
         USING PCOACK,R8          PARAMETER LIST                        01000000
         L     R7,PCOAMSGB        COMMAND MESSAGE BUFFER                01010000
         USING TMSGSTD,R7         $TSEND/$TRECV FORMAT                  01020000
                                                                        01030000
         CLC   TMSGTYPE,=A(ITM_CONS_CMD)                                01040000
         BE    FVALID                                                   01050000
         CLC   TMSGTYPE,=A(ITM_COMMAND_RESP)                            01060000
         BNE   ERR_TYPE                                                 01070000
                                                                        01080000
FVALID   DS    0H                                                       01090000
                                                                        01100000
***************************************************************         01110000
*                                                                       01120000
*   ACQUIRE $MSG COLLECTOR AREA RESOURCE IF IDENTIFIER PASSED           01130000
*                                                                       01140000
***************************************************************         01150000
         LA    R6,TMSGINFO        INFO AREA BEGINS WITH CMDREQ          01160000
         ICM   R5,15,TMSGW1       PARM#1 IS MSGRSRCID OFFSET            01170000
         BZ    NORSRCID           NOT PROVIDED                          01180000
         AR    R5,R6              RETURNING MSGRSRCID ADDRESS           01190000
                                                                        01200000
         $SRM  ACQUIRE,           ACQUIRE CONTROL OF $MSG COLLECTOR    X01210000
               RESOWNER=*TSKPCBC, ASSIGN TO CURRENT PROCESS            X01220000
               RSRCID=(R5),       RESOURCE IDENTIFIER                  X01230000
               MF=(E,$SRMMFL)                                           01240000
                                                                        01250000
         ST    R15,SRMRETCD       RETAIN RETCODE                        01260000
                                                                        01270000
NORSRCID DS    0H                                                       01280000
                                                                        01290000
***************************************************************         01300000
*                                                                       01310000
*   POST SENDER IF REPLY IS OUTSTANDING                                 01320000
*                                                                       01330000
***************************************************************         01340000
         ICM   R3,15,TMSGEPB      MESSAGE REPLY REQUESTED?              01350000
         BZ    NORMRET            SKIP IF NOT                           01360000
                                                                        01370000
         $TASK POST,EPB=(R3),     NOTIFY REQUESTOR OF MSG RECEIPT      X01380000
               PCODE=*SRMRETCD,   STATUS DETERMINED BY $SRM            X01390000
               ERRET=ERR_RPLY,                                         X01400000
               MF=(E,$TASKMFL)                                          01410000
                                                                        01420000
***************************************************************         01430000
*                                                                       01440000
*   ANALYZE $SRM COMPLETION                                             01450000
*                                                                       01460000
***************************************************************         01470000
         ICM   R0,15,SRMRETCD     $SRM COMPLETION CODE OR ZERO          01480000
         BNZ   ERR_$SRM                                                 01490000
                                                                        01500000
***************************************************************         01510000
*                                                                       01520000
*   RETURN COMPLETION STATUS TO CALLER                                  01530000
*                                                                       01540000
***************************************************************         01550000
NORMRET  DS    0H                 NORMAL COMPLETION                     01560000
         LR    R1,R6              RETURN CMDREQ ADDRESS                 01570000
         LR    R0,R5              RETURN MSGRSRCID ADDRESS OR ZERO      01580000
         LA    R15,RC00           INDICATE SUCCESS                      01590000
         B     RETURN                                                   01600000
                                                                        01610000
ERR_TYPE DS    0H                 IMPROPER MESSAGE                      01620000
         LA    R15,RC04                                                 01630000
         SR    R1,R1                                                    01640000
         SR    R0,R0                                                    01650000
         B     RETURN                                                   01660000
                                                                        01670000
ERR_RPLY DS    0H                 UNABLE TO REPLY TO SENDER             01680000
         LR    R0,R15             $TASK POST RETURN CODE                01690000
         SR    R1,R1                                                    01700000
         LA    R15,RC08                                                 01710000
         B     RETURN                                                   01720000
                                                                        01730000
ERR_$SRM DS    0H                 $SRM FAILURE, DESCRIPTOR IN R1        01740000
         L     R0,SRMRETCD                                              01750000
         LA    R15,RC12                                                 01760000
                                                                        01770000
RETURN   DS    0H                                                       01780000
         #EXIT ,                                                        01790000
                                                                        01800000
         EJECT                                                          01810000
***************************************************************         01820000
*                                                                       01830000
*   LOCAL READ/ONLY DATA AREAS, ETC.                                    01840000
*                                                                       01850000
***************************************************************         01860000
         LTORG ,                                                        01870000
                                                                        01880000
         PRINT NOGEN                                                    01890000
         ICVT  ,                                                        01900000
         ITASK ,                                                        01910000
         END   ,                                                        01920000

ITXPREAL TITLE '- REALLOCATE / EXPAND TXP BUFFER'                       00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: ITXPREAL - REALLOCATE / EXPAND TXP BUFFFER                   00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THIS ROUTINE IS USED TO REALLOCATE A TXP BUFFER, EXPANDING         00080000
*    THE AMOUNT OF FREE SPACE AVAILABLE IN ACCORDANCE WITH THE          00090000
*    REALLOCATION SIZE CONTROL PROVIDED IN TXPHDR.TXPRELTY.             00100000
*    THE TXP BUFFER MANAGEMENT DATA CONSISTING LARGELY OF               00110000
*    SELF-REFERRENTIAL POINTERS AND LENGTHS ARE UPDATED                 00120000
*    APPROPRIATELY.                                                     00130000
*                                                                       00140000
*    THE BOUND PTR LIST IS THEN RUN, RELOCATING PTRS BOUND TO           00150000
*    THE PRIOR TXP BUFFER LOCATION TO THE APPROPRIATE ADDRESSES         00160000
*    IN THE REPLACEMENT BUFFER.                                         00170000
*                                                                       00180000
*                                                                       00190000
* ON ENTRY:                                                             00200000
*                                                                       00210000
*    R1  CONTAINS THE ADDR OF A PARAMETER LIST CONSTRUCTED AS           00220000
*        FOLLOWS:                                                       00230000
*                                                                       00240000
*        +00 - EXTENSION SIZE OR ZERO FOR STANDARD REALLOC              00250000
*                                                                       00260000
*                                                                       00270000
* ON EXIT:                                                              00280000
*                                                                       00290000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES                     00300000
*                                                                       00310000
*        RC00 - TXP BUFFER REALLOCATED, PTR RETURNED IN R1              00320000
*                                                                       00330000
*        RC12 - IMPROPER REQUEST                                        00340000
*                                                                       00350000
**<DOC-OFF>****************************************************         00360000
                                                                        00370000
         EJECT                                                          00380000
         #WORK ,                                                        00390000
         #ENDWORK ,                                                     00400000
                                                                        00410000
         EJECT                                                          00420000
         TXPHDR ,                 TXP BUFFER / FUNCTION ARRAY FORMAT    00430000
                                                                        00440000
         EJECT                                                          00450000
         EQUS  ,                                                        00460000
                                                                        00470000
         EJECT                                                          00480000
ITXPREAL #ENTER PREG=R8                                                 00490000
                                                                        00500000
         USING ITASK,R10          STDENV                                00510000
         USING IPCB,R9                                                  00520000
                                                                        00530000
         L     R9,TSKPCBC         PROCESS MODE                          00540000
                                                                        00550000
*--------------------------------------------------------------         00560000
*   VERIFY EXISTENCE OF TXP BUFFER                                      00570000
*--------------------------------------------------------------         00580000
         USING TXPHDR,R3          TXP BUFFER PREFIX                     00590000
                                                                        00600000
         LA    R7,PCBXPB          CURRENT PCB TXP BUFFER DESCRIPTOR     00610000
         ICM   R3,15,0(R7)        TXB BUFFER ANCHOR                     00620000
         BNZ   REALCONT           LOCATED IN CURRENT PCB                00630000
         ICM   R9,15,PCBMPCB      ELSE EXAMINE PARENT PCB               00640000
         BZ    ERR_REQ            INVALID REQUEST IF NOT AVAILABLE      00650000
         LA    R7,PCBXPB          PARENT PCB TXP BUFFER DESCRIPTOR      00660000
         ICM   R3,15,0(R7)        TXB BUFFER ANCHOR                     00670000
         BZ    ERR_REQ            INVALID REQUEST                       00680000
                                                                        00690000
REALCONT DS    0H                                                       00700000
                                                                        00710000
*--------------------------------------------------------------         00720000
*   DETERMINE SIZE OF ADDITION FROM REALLOC OPTION                      00730000
*--------------------------------------------------------------         00740000
         L     R5,0(,R8)          EXTENSION SIZE OR ZERO                00750000
                                                                        00760000
         ICM   R4,15,TXPRELTY     REALLOCATION LENGTH OR OPTION         00770000
         BP    ROUNDLN            FIXED LENGTH EXTENSION                00780000
         LR    R4,R5              MINIMUM LENGTH EXTENSION              00790000
         BM    ROUNDLN                                                  00800000
         L     R4,TXPTOTLN        DOUBLE ALLOCATED SPACE                00810000
                                                                        00820000
ROUNDLN  DS    0H                 ENSURE SELECTED LENGTH COVERS REQ     00830000
         LTR   R4,R4              LENGTH DECLARED?                      00840000
         BP    *+8                ONWARD IF SO                          00850000
         L     R4,TXPTOTLN        SELECT SIZE OF CURRENT ALLOCATION     00860000
                                                                        00870000
         CR    R4,R5              REALLOC AMOUNT SATISFIES REQUEST?     00880000
         BNL   REALLOC            ONWARD IF SO                          00890000
         BCTR  R5,0               PREPARE FOR USE IN BXLE               00900000
         BXLE  R4,R4,*            ROUND UP TO APPROPRIATE MULTIPLE      00910000
                                                                        00920000
*--------------------------------------------------------------         00930000
*   REALLOCATE TXP BUFFER USING $REALLOC SERVICE                        00940000
*--------------------------------------------------------------         00950000
REALLOC  DS    0H                                                       00960000
         LR    R6,R3              R6 <== ADDRESS OF OLD BUFFER          00970000
         L     R5,TXPTOTLN        R5 <== TOTAL SIZE OF OLD BUFFER       00980000
                                                                        00990000
         L     R2,TXPAVAIL        FREE SPACE PTR IN CURRENT BUFFER      01000000
         SR    R2,R3              MINUS ORG GIVES TOTAL STORAGE USED    01010000
                                                                        01020000
         $REALLOC (R7),           DESCRIPTOR (PTR,LEN)                 X01030000
               (R4),              EXTENSION SIZE                       X01040000
               INUSE=(R2),        AMOUNT OF STORAGE OCCUPIED           X01050000
               OWNER=IPCB,        STORAGE OWNER IS TXP BUFFER OWNER    X01060000
               MF=(E,MFE_LIST)                                          01070000
                                                                        01080000
*--------------------------------------------------------------         01090000
*   ADJUST BUFFER MGMT INFO IN TXP PREFIX ACCORDINGLY                   01100000
*--------------------------------------------------------------         01110000
         L     R3,0(,R7)          LOCATE REALLOCATED TXP BUFFER         01120000
         MVC   TXPTOTLN,4(R7)     TOTAL TXP BUFFER LENGTH               01130000
                                                                        01140000
         LA    R0,TXPHDR+TXPHDRLN FIRST BYTE OF BULK AREA               01150000
         ST    R0,TXPXPH          XMIT AREA                             01160000
                                                                        01170000
         LA    R0,TXPHDR(R2)      RELOCATE FREE AREA PTR                01180000
         ST    R0,TXPAVAIL                                              01190000
                                                                        01200000
         L     R0,TXPTOTLN        TOTAL LENGTH OF NEW BUFFER            01210000
         SR    R0,R5              MINUS LENGTH OF OLD BUFFER            01220000
         A     R0,TXPAVREM        PLUS PREVIOUSLY UNUSED STG AMOUNT     01230000
         ST    R0,TXPAVREM        GIVES TOTAL AMOUNT FREE IN NEW BUFFER 01240000
                                                                        01250000
         ICM   R1,15,TXPREPTR     BOUND PTR LIST IN LOCAL STORAGE?      01260000
         BNM   NOBPL              SKIP IF NOT                           01270000
         LA    R1,TXPIBPL         RELOCATE ORIGIN OF BPL                01280000
         O     R1,=X'80000000'    INDICATE RESIDENCE IN LOCAL STORAGE   01290000
         ST    R1,TXPREPTR        SAVE RELOCATED LIST ORIGIN            01300000
NOBPL    DS    0H                                                       01310000
                                                                        01320000
*--------------------------------------------------------------         01330000
*   RELOCATE THE FUNCTION ARRAY                                         01340000
*--------------------------------------------------------------         01350000
         ICM   R0,15,TXPSFORG     OLD FUNCTION ARRAY ORIGIN             01360000
         BZ    NOFSTCK            NO FUNCTION STACKING                  01370000
         SR    R0,R6              OFFSET IN OLD BUFFER                  01380000
         AR    R0,R3              LOCATION IN NEW BUFFER                01390000
         ST    R0,TXPSFORG        SAVE RELOCATED PTR                    01400000
                                                                        01410000
         L     R0,TXPSFNXT        OLD FUNCTION ARRAY SLOT ADDR          01420000
         SR    R0,R6              OFFSET IN OLD BUFFER                  01430000
         AR    R0,R3              LOCATION IN NEW BUFFER                01440000
         ST    R0,TXPSFNXT        SAVE RELOCATED PTR                    01450000
NOFSTCK  DS    0H                                                       01460000
                                                                        01470000
*--------------------------------------------------------------         01480000
*   RELOCATE BOUND PTRS                                                 01490000
*--------------------------------------------------------------         01500000
         LA    R5,0(R5,R6)        R5 <== END OF OLD BUFFER              01510000
         L     R1,TXPREPTR        BOUND PTR LIST ORIGIN                 01520000
         LA    R1,0(,R1)          REMOVE $REALLOC FLAG BIT              01530000
         LR    R2,R1              LOCATE END OF BOUND PTR LIST          01540000
         A     R2,TXPRELEN        BY ADDING LENGTH TO ORIGIN            01550000
                                                                        01560000
BPLMOVE  DS    0H                                                       01570000
         ICM   R15,15,0(R1)       ADDRESS OF PTR                        01580000
         BZ    BPLADV             ADVANCE IF SLOT NOT USED              01590000
         L     R14,0(,R15)        FETCH CANDIDATE PTR                   01600000
         LA    R14,0(,R14)        CLEAR FLAG BITS                       01610000
         CR    R14,R6             POSSIBLY WITHIN OLD TXP BUFFER?       01620000
         BL    BPLADV             SKIP IF NOT                           01630000
         CR    R14,R5             WITHIN OLD TXP BUFFER?                01640000
         BNL   BPLADV             SKIP IF NOT                           01650000
                                                                        01660000
         SR    R14,R6             OFFSET WITHIN OLD BUFFER              01670000
         AR    R14,R3             ADDRESS IN NEW BUFFER                 01680000
         ST    R14,0(,R15)        SAVE RELOCATED PTR                    01690000
                                                                        01700000
BPLADV   DS    0H                                                       01710000
         LA    R1,4(,R1)          ADVANCE TO NEXT PTR                   01720000
         CR    R1,R2              END OF THE LIST?                      01730000
         BL    BPLMOVE            CONTINUE IF NOT                       01740000
                                                                        01750000
*--------------------------------------------------------------         01760000
*   RETURN COMPLETION STATUS TO REQUESTOR                               01770000
*--------------------------------------------------------------         01780000
         LA    R15,RC00           NORMAL COMPLETION                     01790000
         LA    R1,TXPHDR          RETURN BLOCK PTR                      01800000
         B     STDRET             DONE                                  01810000
                                                                        01820000
ERR_REQ  DS    0H                 REQUEST INCOMPATIBLE WITH STG         01830000
         LA    R15,RC12           ERROR                                 01840000
                                                                        01850000
STDRET   DS    0H                                                       01860000
         #EXIT ,                  REQUEST COMPLETE                      01870000
                                                                        01880000
         EJECT                                                          01890000
***************************************************************         01900000
*                                                                       01910000
*   LOCAL READ/ONLY STORAGE AREAS                                       01920000
*                                                                       01930000
***************************************************************         01940000
         LTORG ,                                                        01950000
                                                                        01960000
         PRINT NOGEN                                                    01970000
         ICVT  ,                                                        01980000
         ITASK ,                                                        01990000
         IPCB  ,                                                        02000000
         END   ,                                                        02010000

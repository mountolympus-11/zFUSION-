IPRJCLN  TITLE '- PROJECT SPACE CLEANUP'                                00010000
*************************************************************           00020000
*                                                                       00030000
* ROUTINE: IPRJCLN - PROJECT SPACE CLEANUP                              00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THIS ROUTINE IS USED TO DELETE ALL TEMPORARY TABLES FROM           00080000
*    A PROJECT AT OPEN AND CLOSE TIME.  THIS OPERATION ENSURES          00090000
*    THAT TEMPORARY TABLES OCCUPYING THE PROJECT DATA BASE              00100000
*    BECAUSE OF WORKBENCH SAVE AND SAVE-AS OPERATIONS ARE NOT           00110000
*    CARRIED AS AN ADDITIONAL EXPENSE DURING SUBSEQUENT USE.            00120000
*                                                                       00130000
* METHOD:                                                               00140000
*                                                                       00150000
*    IF SYSDICTIONARY IS AVAILABLE                                      00160000
*        TBSET(SYSDICTIONARY) TO PREPARE FOR SEQUENTIAL SCAN            00170000
*        FOR EACH TABLE DEFINED IN SYSDICTIONARY                        00180000
*            IF SYSTEMP* TABLE                                          00190000
*                TBOPEN - ACCESS ALL ASSOCIATED OBJECTS                 00200000
*                TBDROP - DELETE ALL OBJECTS                            00210000
*            }                                                          00220000
*        }                                                              00230000
*    }                                                                  00240000
*                                                                       00250000
*                                                                       00260000
* ON ENTRY:                                                             00270000
*                                                                       00280000
*    ALL PARAMETERS ARE PROVIDED BY THE IPROJ ASSOCIATED WITH           00290000
*    THE CURRENT WORKUNIT.                                              00300000
*                                                                       00310000
*                                                                       00320000
* ON EXIT:                                                              00330000
*                                                                       00340000
*    R15 CONTAINS ZERO                                                  00350000
*                                                                       00360000
***************************************************************         00370000
                                                                        00380000
         EJECT                                                          00390000
***************************************************************         00400000
*                                                                       00410000
* MAINTENANCE:                                                          00420000
*                                                                       00430000
*   12/06/94 R. Turgeon                                                 00440000
*            Removed PAGE= / SHRPAGE= for $SPACE, $OBJECT,              00450000
*            and TB* service requests                                   00460000
*                                                                       00470000
***************************************************************         00480000
         EJECT ,                                                        00490000
                                                                        00500000
         #WORK ,                                                        00510000
                                                                        00520000
$DDE     DDENTRY DSECT=NO         SYSDICTIONARY ROW                     00530000
         DS    XL256              VARX EXTENSIONS                       00540000
$DDELN   EQU   *-DDENTRY          LENGTH RESERVED                       00550000
                                                                        00560000
WK256    DS    0F,XL256           GENERAL PURPOSE WORKAREA              00570000
                                                                        00580000
         #ENDWORK ,                                                     00590000
                                                                        00600000
         EJECT                                                          00610000
         IUSER ,                  USER CONTROL BLOCK                    00620000
                                                                        00630000
         EJECT                                                          00640000
         IPROJ ,                  PROJECT CONTROL BLOCK                 00650000
                                                                        00660000
         EJECT                                                          00670000
         $TOKEN ,                 TOKEN FORMAT, REF'D IN IPROJ          00680000
                                                                        00690000
         EJECT                                                          00700000
         TBSERVIS SET,GET,OPEN,DROP,PRINT=NOGEN                         00710000
                                                                        00720000
         EJECT                                                          00730000
         ABCODES ,                                                      00740000
                                                                        00750000
         EQUS  ,                                                        00760000
                                                                        00770000
         EJECT ,                                                        00780000
IPRJCLN  #ENTER ,                                                       00790000
                                                                        00800000
         USING ICVT,R11           STDENV                                00810000
         USING ITASK,R10                                                00820000
                                                                        00830000
         L     R9,TSKPCBC         PROCESS MODE                          00840000
         USING IPCB,R9                                                  00850000
                                                                        00860000
         ICM   R7,15,PCBUSER      USER BLOCK                            00870000
         BZ    EOT                DONE IF NONE                          00880000
         USING IUSER,R7           TEMP ADDRESSABILITY                   00890000
         ICM   R7,15,USRPROJ      ADDRESS OF PROJECT                    00900000
         BZ    EOT                DONE IF NONE                          00910000
         USING IPROJ,R7           LIFE OF FUNCTION                      00920000
                                                                        00930000
         EJECT ,                                                        00940000
***************************************************************         00950000
*                                                                       00960000
*   SCAN SYSDICTIONARY FOR RESIDUAL TEMPORARY TABLES                    00970000
*                                                                       00980000
***************************************************************         00990000
         ICM   R0,15,PRJTKDIC     DICTIONARY OPENED?                    01000000
         BZ    EOT                FAILURE AVOIDANCE                     01010000
                                                                        01020000
         TBSET POS=TOP,           POSITION TO TOP OF DATA DICTIONARY   X01030000
               TTOKEN=PRJTKDIC,                                        X01040000
               MF=(E,WK256)                                             01050000
                                                                        01060000
*--------------------------------------------------------------         01070000
*   SCAN THE DICTIONARY FOR TEMPORARY TABLES                            01080000
*--------------------------------------------------------------         01090000
SCANDIC  DS    0H                                                       01100000
                                                                        01110000
         TBGET DDENTRY,           ACQUIRE NEXT DICTIONARY ENTRY        X01120000
               LENGTH=$DDELN,                                          X01130000
               POS=NEXT,                                               X01140000
               TTOKEN=PRJTKDIC,                                        X01150000
               MF=(E,WK256)                                             01160000
                                                                        01170000
         CH    R15,=AL2(RC04)     TEST COMPLETION STATUS                01180000
         BL    TEMPCHK            ROW RETURNED                          01190000
         BE    EOT                END OF TABLE OR BUFFER OVERFLOW       01200000
         EX    R0,*               TRAP CATALOG DAMAGE                   01210000
                                                                        01220000
*--------------------------------------------------------------         01230000
*   IF TABLE IS TEMPORARY, OPEN IT AND THEN DROP                        01240000
*--------------------------------------------------------------         01250000
TEMPCHK  DS    0H                                                       01260000
         CLC   =C'SYSTEMP',DDETABNM                                     01270000
         BNE   SCANDIC                                                  01280000
                                                                        01290000
         TBOPEN DDETABNM,         TABLE NAME                           X01300000
               STOKEN=PRJTOKEN,   SPACE TOKEN                          X01310000
               TTOKEN=FWORD,      TABLE TOKEN (OUTPUT)                 X01320000
               MF=(E,WK256)                                             01330000
                                                                        01340000
         LTR   R15,R15            TEST COMPLETION                       01350000
         BNZ   SCANDIC            AVOID UNECESSARY FAILURES             01360000
                                                                        01370000
         TBDROP TTOKEN=FWORD,                                          X01380000
               MF=(E,WK256)                                             01390000
         B     SCANDIC                                                  01400000
                                                                        01410000
*--------------------------------------------------------------         01420000
*   CLEANUP COMPLETE, RETURN TO REQUESTOR                               01430000
*--------------------------------------------------------------         01440000
EOT      DS    0H                                                       01450000
         LA    R15,RC00           RETURN CODE                           01460000
         SR    R0,R0              REASON CODE UNDEFINED                 01470000
                                                                        01480000
         #EXIT ,                                                        01490000
                                                                        01500000
         EJECT                                                          01510000
***************************************************************         01520000
*                                                                       01530000
*   LOCAL READ-ONLY DATA AREAS, ETC.                                    01540000
*                                                                       01550000
***************************************************************         01560000
         LTORG ,                                                        01570000
                                                                        01580000
         EJECT                                                          01590000
         PRINT NOGEN                                                    01600000
         ICVT  ,                                                        01610000
         ITASK ,                                                        01620000
         IPCB  ,                                                        01630000
         END   ,                                                        01640000

IVTMNNSX TITLE 'INTEGRATOR - NSEXIT MAIN TASK EXTENSION'                00010000
                                                                        00020000
**<DOC-ON>************************************************************* 00030000
*                                                                       00040000
* ROUTINE: IVTMNNSX - INTEGRATOR NSEXIT MAIN TASK EXTENSION             00050000
*                                                                       00060000
* DESCRIPTION: NOTIFY RU'S RECEIVED BY THE NSEXIT ARE QUEUED TO THE     00070000
*              MAIN TASK FOR PROCESSING WHEN THE ASSOCIATED USERFLD     00080000
*              IS ZERO (WHICH IS AN UNEXPECTED CONDITION) OR WHEN       00090000
*              THE ASSOCIATED USERFLD IS NEGATIVE (INDICATING IT IS     00100000
*              AN ISQE ADDRESS).                                        00110000
*                                                                       00120000
*              ALL OTHER NSEXIT RU'S SHOULD HAVE BEEN ASSOCIATED        00130000
*              WITH A SESSION BY THE NSEXIT AND DIRECTLY QUEUED         00140000
*              TO THAT SESSION.                                         00150000
*                                                                       00160000
*              WHEN AN ISQE ADDRESS IS PRESENT, THE APPROPRIATE         00170000
*              SESSION IS LOCATED (IF IT STILL EXISTS) AND A            00180000
*              COPY OF THE NSEXIT WORK ELEMENT IS QUEUED TO THE ISESS.  00190000
*                                                                       00200000
* ON ENTRY:                                                             00210000
*                                                                       00220000
*    R15 = ENTRY POINT ADDRESS                                          00230000
*    R14 = RETURN ADDRESS                                               00240000
*    R13 = AVAILABLE SAVE AREA                                          00250000
*    R11 = ICVT ADDRESS                                                 00260000
*    R10 = ITASK ADDRESS                                                00270000
*    R01 = IWE ADDRESS (WORK ELEMENT)                                   00280000
*                                                                       00290000
* ON EXIT:                                                              00300000
*                                                                       00310000
*    R15 = 0                                                            00320000
*    R00 = 0                                                            00330000
*    R01 = 0                                                            00340000
*                                                                       00350000
*    ALL OTHER REGISTERS ARE RESTORED                                   00360000
*                                                                       00370000
**<DOC-OFF>************************************************************ 00380000
                                                                        00390000
         EJECT ,                                                        00400000
*********************************************************************** 00410000
*                                                                       00420000
* MAINTENANCE:                                                          00430000
*                                                                       00440000
*   08/01/93 RANDY WITEK                                                00450000
*                                                                       00460000
*********************************************************************** 00470000
                                                                        00480000
         EQUS  ,                  GENERAL EQUATES                       00490000
                                                                        00500000
RICVT    EQU   R11                                                      00510000
RITASK   EQU   R10                                                      00520000
RIVTAM   EQU   R9                                                       00530000
RIACB    EQU   R8                                                       00540000
RIRPL    EQU   R7                                                       00550000
RIWE     EQU   R6                                                       00560000
RISQE    EQU   R5                                                       00570000
RISESS   EQU   R4                                                       00580000
                                                                        00590000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00600000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00610000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00620000
         USING IACB,RIACB         ESTABLISH ADDRESSABILITY              00630000
         USING IRPL,RIRPL         ESTABLISH ADDRESSABILITY              00640000
         USING IWEVTAM,RIWE       ESTABLISH ADDRESSABILITY              00650000
         USING ISQE,RISQE         ESTABLISH ADDRESSABILITY              00660000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00670000
                                                                        00680000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00690000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00700000
SAVEQTOK DS    F                  VALIDATED ISQE TOKEN                  00710000
$SESSMFL $SESS MF=L               $SESS PLIST CONSTRUCTION              00720000
WRK256   DS    XL256              GENERAL WORKAREA                      00730000
RETR15   DS    F                  RETURN CODE VALUE                     00740000
RETR0    DS    F                  RETURN REGISTER 0                     00750000
RETR1    DS    F                  RETURN REGISTER 1                     00760000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00770000
FLAG     DS    X                                                        00780000
FLAGLOCK EQU   X'80'              VTAM GLOBAL LOCK HELD                 00790000
FLAGLCKD EQU   X'40'              VTAM GLOBAL LOCK HELD ON ENTRY        00800000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00810000
                                                                        00820000
         $MSGDFT PREFIX=ICTPID,                                        +00830000
               COMPID='VTM',                                           +00840000
               TABLE=*#MSGS,                                           +00850000
               WORKA=0,                                                +00860000
               MF=(E,WRK256),                                          +00870000
               PRINT=NOGEN                                              00880000
                                                                        00890000
IVTMNNSX #ENTER BASE=R12,         ENTRY LINKAGE                        +00900000
               AMODE=31,                                               +00910000
               PREG=(RIWE),                                            +00920000
               RMODE=ANY                                                00930000
                                                                        00940000
*---------------------------------------------------------------------- 00950000
* NSEXIT EXIT WORK ELEMENT                                              00960000
*---------------------------------------------------------------------- 00970000
                                                                        00980000
         L     RIACB,IWEX4ACB     SET IACB ADDRESS                      00990000
         LA    RIRPL,IWEX4RPL     SET RPL ADDRESS                       01000000
         L     RISQE,IWEX4USR     ISQE ADDRESS FOR SOLICITED BIND       01010000
                                                                        01020000
*---------------------------------------------------------------------- 01030000
* IF THE USERFLD IS NOT AN ISQE ADDRESS WE SHOULDN'T BE PROCESSING IT   01040000
*---------------------------------------------------------------------- 01050000
                                                                        01060000
         LTR   RISQE,RISQE        IS USERFLD AN ISQE ADDRESS?           01070000
         BM    GOTISQE            BRANCH IF YES                         01080000
                                                                        01090000
NOSESS   DS    0H                                                       01100000
                                                                        01110000
         BAS   R14,VTAMUNLK       RELEASE SERIALIZATION                 01120000
                                                                        01130000
         $MSG  976,                                                    +01140000
               FIELDS=((IACNAME,8),                                    +01150000
               (IWEX4CID,4),                                           +01160000
               (IWEX4USR,4),                                           +01170000
               (RIRPL),                                                +01180000
               (IWEX4RU,4))       "NSEXIT NO SESSION FOUND"             01190000
                                                                        01200000
         $VTAM DUMPRPL,                                                +01210000
               AREA=(RIRPL),                                           +01220000
               ERRET=ERR$VTAM,                                         +01230000
               MF=(E,MFE_LIST)    DUMP THE COMPLETE RPL                 01240000
                                                                        01250000
         B     RETURN             RETURN TO PROCESS OTHER WORK          01260000
                                                                        01270000
*---------------------------------------------------------------------- 01280000
* LOCATE THE APPROPRIATE ISESS TO RECEIVE THE NSEXIT WORK ELEMENT       01290000
*---------------------------------------------------------------------- 01300000
                                                                        01310000
GOTISQE  DS    0H                                                       01320000
                                                                        01330000
         BAS   R14,VTAMLOCK          SERIALIZE                          01340000
                                                                        01350000
         LA    RISQE,0(,RISQE)       CLEAR THE HI-ORDER BIT             01360000
         ST    RISQE,SAVEQTOK        SAVE ISQE TOKEN                    01370000
                                                                        01380000
         $VTAM LOCISQE,                                                +01390000
               AREA=SAVEQTOK,                                          +01400000
               ERRET=NOSESS,                                           +01410000
               MF=(E,MFE_LIST)       LOCATE THE ISQE                    01420000
                                                                        01430000
         LR    RISQE,R1              ISQE ADDRESS                       01440000
                                                                        01450000
         $SESS $SESS_FIND_SESSION,                                     +01460000
               SESSION=ISQSTOK,                                        +01470000
               ERRET=NOSESS,                                           +01480000
               MF=(E,$SESSMFL)       RETRIEVE THE ISESS BLOCK           01490000
                                                                        01500000
X        USING SPLIST,$SESSMFL                                          01510000
         L     RISESS,X.SPLAREA      ADDRESS OF ISESS BLOCK             01520000
         DROP  X                                                        01530000
                                                                        01540000
*---------------------------------------------------------------------- 01550000
* COPY THE NSEXIT WORK ELEMENT.                                         01560000
*---------------------------------------------------------------------- 01570000
                                                                        01580000
         $VTAMWE *IWELEN,               SIZE                           +01590000
               IWECXNSX                 CODE                            01600000
                                                                        01610000
L        USING IWE,R3                   REFERENCE TO LOGON IWE          01620000
                                                                        01630000
         LR    R3,R1                    ESTABLISH ADDRESSIBILITY        01640000
         LR    R0,R3                    COPY-TO   ADDRESS               01650000
         L     R1,IWELEN                COPY-TO   LENGTH                01660000
         LR    R14,RIWE                 COPY-FROM ADDRESS               01670000
         LR    R15,R1                   COPY-FROM LENGTH                01680000
         MVCL  R0,R14                   COPY THE LOGON WORK ELEMENT     01690000
         XC    L.IWELINK,L.IWELINK      NO WE'S LINKED TO NEW COPY      01700000
         XC    L.IWEECB,L.IWEECB        ENSURE ECB CLEAR IN NEW COPY    01710000
                                                                        01720000
         LA    RIRPL,L.IWEX4RPL         ADDR OF NEW RPL COPY AREA       01730000
         LA    R1,L.IWEX4RU             ADDR OF NEW RU COPY AREA        01740000
         ST    R1,RPLAREA               SET CINIT ADDR IN NEW RPL COPY  01750000
                                                                        01760000
         DROP  L                        REF. TO LOGON IWE               01770000
                                                                        01780000
*---------------------------------------------------------------------- 01790000
* QUEUE THE NSEXIT WORK ELEMENT TO THE ISESS.                           01800000
*---------------------------------------------------------------------- 01810000
                                                                        01820000
         LR    R1,R3                    WORK ELEMENT ADDRESS            01830000
         LA    R0,ISEWEQ                QUEUE ADDRESS                   01840000
         BAS   R14,QWE                  GO TRY TO QUEUE THE WE          01850000
                                                                        01860000
*---------------------------------------------------------------------- 01870000
* RETURN TO MAIN TASK MAINLINE                                          01880000
*---------------------------------------------------------------------- 01890000
                                                                        01900000
RETURN   DS    0H                                                       01910000
                                                                        01920000
         BAS   R14,VTAMUNLK       UNLOCK IF REQUIRED                    01930000
                                                                        01940000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 01950000
                                                                        01960000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    01970000
                                                                        01980000
*---------------------------------------------------------------------- 01990000
* SUBROUTINE QWE - QUEUE A WORK ELEMENT TO A GIVEN WORK QUEUE           02000000
*                                                                       02010000
* ENTRY            R14 = RETURN ADDRESS                                 02020000
*                  R1  = WORK ELEMENT ADDRESS                           02030000
*                  R0  = QUEUE ADDRESS                                  02040000
*                                                                       02050000
* RETURNS          R15 = 0 --> QUEUEING SUCCESSFUL                      02060000
*                      = 4 --> QUEUEING FAILED, WORK ELEMENT RELEASED   02070000
*---------------------------------------------------------------------- 02080000
                                                                        02090000
QWE      DS    0H                                                       02100000
                                                                        02110000
         STM   R14,R4,SUB0SAVE    SAVE REGISTERS                        02120000
         LR    R3,R0              SAVE QUEUE ADDRESS                    02130000
         LR    R4,R1              SAVE WORK ELEMENT ADDRESS             02140000
                                                                        02150000
         $VTAMQ (R4),             WORK ELEMENT                         +02160000
               (R3)               QUEUE                                 02170000
                                                                        02180000
         L     R14,SUB0SAVE       RESTORE REGISTERS                     02190000
         LM    R0,R4,SUB0SAVE+8   RESTORE REGISTERS                     02200000
         BR    R14                AND RETURN TO CALLER                  02210000
                                                                        02220000
*---------------------------------------------------------------------- 02230000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 02240000
*---------------------------------------------------------------------- 02250000
                                                                        02260000
VTAMLOCK DS    0H                                                       02270000
                                                                        02280000
         TM    FLAG,FLAGLOCK        WAS THE LOCK ALREADY OBTAINED?      02290000
         BOR   R14                  RETURN IF YES                       02300000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             02310000
                                                                        02320000
         $SER  OBTAIN,                                                 +02330000
               VTAM                                                     02340000
                                                                        02350000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              02360000
         BNE   VTAMLOEX             BRANCH IF NOT                       02370000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         02380000
                                                                        02390000
VTAMLOEX DS    0H                                                       02400000
                                                                        02410000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               02420000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          02430000
         BR    R14                  RETURN                              02440000
                                                                        02450000
*---------------------------------------------------------------------- 02460000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                02470000
*---------------------------------------------------------------------- 02480000
                                                                        02490000
VTAMUNLK DS    0H                                                       02500000
                                                                        02510000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       02520000
         BNOR  R14                  BRANCH IF NOT                       02530000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             02540000
         BOR   R14                  DON'T RELEASE IF IT WAS             02550000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             02560000
                                                                        02570000
         $SER  RELEASE,                                                +02580000
               VTAM                                                     02590000
                                                                        02600000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  02610000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          02620000
         BR    R14                  RETURN                              02630000
                                                                        02640000
*---------------------------------------------------------------------- 02650000
* ERROR ROUTINES                                                        02660000
*---------------------------------------------------------------------- 02670000
                                                                        02680000
ERR$VTAM DS    0H                                                       02690000
                                                                        02700000
         $ABEND ABE_VTDIAG,                                            +02710000
               SCOPE=PCB,                                              +02720000
               TITLE='$VTAM FAILURE'                                    02730000
                                                                        02740000
*---------------------------------------------------------------------- 02750000
*  CONSTANTS AND LITERALS                                               02760000
*---------------------------------------------------------------------- 02770000
                                                                        02780000
         LTORG ,                                                        02790000
         PRINT NOGEN                                                    02800000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                02810000
         ISTDBIND ,               VTAM BIND IMAGE                       02820000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         02830000
         ICVT  ,                  INTEGRATOR CVT                        02840000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   02850000
         IRPL ,                   INTEGRATOR VTAM RPL+                  02860000
         IACB ,                   INTEGRATOR VTAM ACB+                  02870000
         INIB ,                   INTEGRATOR VTAM NIB+                  02880000
         ISESS ,                  INTEGRATOR SESSION BLOCK              02890000
         ISQE ,                   INTEGRATOR SESS INIT QUEUE ELEMENT    02900000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            02910000
         ITASK ,                  INTEGRATOR TASK BLOCK                 02920000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          02930000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       02940000
         EVCODES ,                INTEGRATOR EVENT CODES                02950000
         ABCODES ,                INTEGRATOR $ABEND CODES               02960000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     02970000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        02980000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             02990000
         $PROC DSECT=YES          INTEGRATOR $PROC SERVICES             03000000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             03010000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             03020000
         IFGEXLST ,               VTAM EXIT LIST                        03030000
         END   ,                                                        03040000

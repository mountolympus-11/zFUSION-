IVTMSTMS TITLE 'INTEGRATOR - SESSION $TIMER SET'                        00010000
**<DOC-ON>************************************************************* 00020000
*                                                                       00030000
* ROUTINE: IVTMSTMS - INTEGRATOR SESSION $TIMER SET                     00040000
*                                                                       00050000
* DESCRIPTION: THIS ROUTINE IS CALLED TO SET A SESSION $TIMER           00060000
*                                                                       00070000
* ON ENTRY:                                                             00080000
*                                                                       00090000
*    R15 = ENTRY POINT ADDRESS                                          00100000
*    R14 = RETURN      ADDRESS                                          00110000
*    R13 = SAVE AREA   ADDRESS                                          00120000
*    R11 = ICVT        ADDRESS                                          00130000
*    R10 = ITASK       ADDRESS                                          00140000
*    R01 = STMLIST     ADDRESS                                          00150000
*                                                                       00160000
* ON EXIT:                                                              00170000
*                                                                       00180000
*    R15 = 0 --> TIMER SET                                              00190000
*        =!0 --> TIMER NOT SET                                          00200000
*    R00 = REASON CODE                                                  00210000
*    R01 = STMLIST ADDRESS                                              00220000
*                                                                       00230000
*    ALL OTHER REGISTERS ARE RESTORED                                   00240000
*                                                                       00250000
*                                                                       00260000
**<DOC-OFF>************************************************************ 00270000
                                                                        00280000
         EJECT ,                                                        00290000
*********************************************************************** 00300000
*                                                                       00310000
* MAINTENANCE:                                                          00320000
*                                                                       00330000
*   10/01/93 RANDY WITEK                                                00340000
*   08/18/95 RANDY WITEK - REWORKED TO USE $TIMER SERVICE               00350000
*                                                                       00360000
*********************************************************************** 00370000
                                                                        00380000
         EQUS  ,                  GENERAL EQUATES                       00390000
                                                                        00400000
RICVT    EQU   R11                                                      00410000
RITASK   EQU   R10                                                      00420000
RIVTAM   EQU   R9                                                       00430000
RISESS   EQU   R8                                                       00440000
RSTMLIST EQU   R7                                                       00450000
                                                                        00460000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00470000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00480000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00490000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00500000
         USING STMLIST,RSTMLIST   ESTABLISH ADDRESSABILITY              00510000
                                                                        00520000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00530000
                                                                        00540000
$SESSMFL $SESS MF=L               $SESS   PLIST CONSTRUCTION            00550000
                                                                        00560000
TIMERMFL $TIMER TERM,MF=L         $TIMER  PLIST CONSTRUCTION            00570000
                                                                        00580000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00590000
                                                                        00600000
WRK256   DS    XL256              GENERAL WORKAREA                      00610000
                                                                        00620000
RETR15   DS    F                  RETURN CODE VALUE                     00630000
RETR0    DS    F                  RETURN REGISTER 0                     00640000
RETR1    DS    F                  RETURN REGISTER 1                     00650000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00660000
                                                                        00670000
MILLSECS DS    F                  TIMER INTERVAL IN MILLISECONDS        00680000
                                                                        00690000
FLAG     DS    X                                                        00700000
FLAGLOCK EQU   X'80'              VTAM LOCK IS HELD                     00710000
FLAGLCKD EQU   X'40'              VTAM LOCK WAS HELD ON ENTRY           00720000
                                                                        00730000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00740000
                                                                        00750000
         $MSGDFT PREFIX=ICTPID,                                        +00760000
               COMPID='VTM',                                           +00770000
               TABLE=*#MSGS,                                           +00780000
               WORKA=0,                                                +00790000
               MF=(E,WRK256),                                          +00800000
               PRINT=NOGEN                                              00810000
                                                                        00820000
IVTMSTMS #ENTER BASE=R12,         ENTRY LINKAGE                        +00830000
               PREG=RSTMLIST,     R1 --> RSTMLIST                      +00840000
               AMODE=31,                                               +00850000
               RMODE=ANY                                                00860000
                                                                        00870000
*---------------------------------------------------------------------- 00880000
* INITIALIZATION                                                        00890000
*---------------------------------------------------------------------- 00900000
                                                                        00910000
         L     RIVTAM,ICTVTCVT    IVTAMCVT ADDRESS                      00920000
                                                                        00930000
         ST    RSTMLIST,RETR1      RETURN PLIST IN R1                   00940000
                                                                        00950000
         ICM   R1,15,STMBINTV      REQUESTED TIMER INTERVAL             00960000
         BNP   RSNINTVL            BRANCH IF NOT GOOD                   00970000
         MH    R1,=H'10'           MAKE IT MILLISECONDS                 00980000
         ST    R1,MILLSECS         SAVE TIMER INTERVAL IN MILLISECONDS  00990000
                                                                        01000000
         ICM   R3,15,STMCLASS      REQUESTED TIMER CLASS                01010000
         BNP   RSNCLASS            BRANCH IF NOT GOOD                   01020000
         C     R3,=A($SESSTMR_CLASS_MAXIMUM)                            01030000
         BH    RSNCLASS            BRANCH IF NOT GOOD                   01040000
         BCTR  R3,0                                                     01050000
         SLL   R3,3                TIMER ID SLOT OFFSET ((CLASS-1)*8)   01060000
                                                                        01070000
         ICM   RISESS,15,STMISESS  ISESS ADDRESS PROVIDED?              01080000
         BNZ   INITDONE            BRANCH IF YES                        01090000
         ICM   RISESS,15,STMTOKEN  TOKEN ADDRESS PROVIDED?              01100000
         BZ    RSNSESS             BRANCH IF NOT                        01110000
         OC    0(L'ISETK,RISESS),0(RISESS) IS THERE A TOKEN?            01120000
         BZ    RSNSESS             BRANCH IF NOT                        01130000
                                                                        01140000
         BAS   R14,VTAMLOCK                                             01150000
                                                                        01160000
         $SESS $SESS_FIND_SESSION,                                     +01170000
               SESSION=(RISESS),                                       +01180000
               ERRET=RSNSESS,                                          +01190000
               MF=(E,$SESSMFL)     LOCATE ASSOCIATED ISESS, IF ANY      01200000
                                                                        01210000
X        USING SPLIST,$SESSMFL                                          01220000
         L     RISESS,X.SPLAREA    ADDRESS OF ASSOCIATED ISESS BLOCK    01230000
         DROP  X                                                        01240000
                                                                        01250000
INITDONE DS    0H                                                       01260000
                                                                        01270000
*---------------------------------------------------------------------- 01280000
* SET A SESSION $TIMER                                                  01290000
*---------------------------------------------------------------------- 01300000
                                                                        01310000
         LA    R3,ISETID01(R3)    ADDRESS OF TIMER CLASS SLOT           01320000
         OC    0(8,R3),0(R3)      IS THERE AN ACTIVE TIMER?             01330000
         BNZ   RSNACTIV           BRANCH IF YES                         01340000
                                                                        01350000
         L     R2,IVT@STMX        TIMER EXIT ROUTINE                    01360000
                                                                        01370000
         $TIMER SET,                                                   +01380000
               TID=(R3),                                               +01390000
               INTVL=*MILLSECS,                                        +01400000
               EXIT=(R2),                                              +01410000
               PARM=(RISESS),                                          +01420000
               MF=(E,TIMERMFL)    SET A TIMER                           01430000
                                                                        01440000
TIMESET  DS    0H                                                       01450000
                                                                        01460000
         ST    R15,STMRETCD       SAVE RETURN CODE                      01470000
                                                                        01480000
         $TRACE *=A(TRC_ISESS_TIMERSET),32 TRACE ENTRY W/32 USER BYTES  01490000
                                                                        01500000
         BNZ   NOTIMER            BRANCH IF NOT TRACING                 01510000
                                                                        01520000
         ST    RISESS,0(,R1)      TRACE ISESS ADDRESS                   01530000
         MVC   4(4,R1),ISECID     TRACE VTAM CID                        01540000
         MVC   8(8,R1),ISETK      TRACE SESSION TOKEN                   01550000
         MVC   16(8,R1),0(R3)     TRACE $TIMER TIMER ID                 01560000
         MVC   24(4,R1),STMCLASS  TRACE TIMER CLASS                     01570000
         MVC   28(4,R1),STMRETCD  TRACE $TIMER RETURN CODE              01580000
                                                                        01590000
NOTIMER  DS    0H                                                       01600000
                                                                        01610000
*---------------------------------------------------------------------- 01620000
* ISSUE AN ERROR MESSAGE IF SET FAILED                                  01630000
*---------------------------------------------------------------------- 01640000
                                                                        01650000
         OC    STMRETCD,STMRETCD  DID $TIMER WORK OK?                   01660000
         BZ    RETURN             BRANCH IF YES                         01670000
         MVC   STMRSNCD,=A($SESSTMR_RSN_$TIMER_SERVICE)                 01680000
                                                                        01690000
         $MSG  969,               "$TIMER SET FAILED..."               +01700000
               FIELDS=((RISESS),     ISESS ADDRESS                     +01710000
               (ISETKUSR,4),         IVUSER TOKEN                      +01720000
               (ISETKSES,4),         ISESS  TOKEN                      +01730000
               (RITASK),             ITASK ADDRESS                     +01740000
               (TSKPCBC,4),          IPROC ADDRESS                     +01750000
               (TSKNAME,8),          ITASK NAME                        +01760000
               (STMRETCD,4))         $TIMER RC                          01770000
                                                                        01780000
         B     RETURN             BRANCH IF YES                         01790000
                                                                        01800000
*---------------------------------------------------------------------- 01810000
* INVALID TIMER CLASS SPECIFIED                                         01820000
*---------------------------------------------------------------------- 01830000
                                                                        01840000
RSNCLASS DS    0H                                                       01850000
                                                                        01860000
         MVC   STMRETCD,=A($SESSTMR_RC_UNSUCCESSFUL)                    01870000
         MVC   STMRSNCD,=A($SESSTMR_RSN_BAD_CLASS)                      01880000
         B     RETURN                                                   01890000
                                                                        01900000
*---------------------------------------------------------------------- 01910000
* A TIMER IS ALREADY ACTIVE                                             01920000
*---------------------------------------------------------------------- 01930000
                                                                        01940000
RSNACTIV DS    0H                                                       01950000
                                                                        01960000
         MVC   STMRETCD,=A($SESSTMR_RC_UNSUCCESSFUL)                    01970000
         MVC   STMRSNCD,=A($SESSTMR_RSN_TIMER_ACTIVE)                   01980000
         B     RETURN                                                   01990000
                                                                        02000000
*---------------------------------------------------------------------- 02010000
* REQUESTED TIME INTERVAL NOT VALID                                     02020000
*---------------------------------------------------------------------- 02030000
                                                                        02040000
RSNINTVL DS    0H                                                       02050000
                                                                        02060000
         MVC   STMRETCD,=A($SESSTMR_RC_UNSUCCESSFUL)                    02070000
         MVC   STMRSNCD,=A($SESSTMR_RSN_BAD_BINTVL)                     02080000
         B     RETURN                                                   02090000
                                                                        02100000
*---------------------------------------------------------------------- 02110000
* NO TARGET SESSION COULD BE FOUND                                      02120000
*---------------------------------------------------------------------- 02130000
                                                                        02140000
RSNSESS  DS    0H                                                       02150000
                                                                        02160000
         MVC   STMRETCD,=A($SESSTMR_RC_UNSUCCESSFUL)                    02170000
         MVC   STMRSNCD,=A($SESSTMR_RSN_NO_SESSION)                     02180000
         B     RETURN                                                   02190000
                                                                        02200000
*---------------------------------------------------------------------- 02210000
* RETURN TO CALLER                                                      02220000
*---------------------------------------------------------------------- 02230000
                                                                        02240000
RETURN   DS    0H                                                       02250000
                                                                        02260000
         BAS   R14,VTAMUNLK                                             02270000
                                                                        02280000
         MVC   RETR15,STMRETCD    RETURN CODE IN R15                    02290000
         MVC   RETR0,STMRSNCD     REASON CODE IN R0                     02300000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 02310000
                                                                        02320000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    02330000
                                                                        02340000
*---------------------------------------------------------------------- 02350000
* SUBROUTINE VTAMLOCK - OBTAIN VTAM GLOBAL LOCK                         02360000
*---------------------------------------------------------------------- 02370000
                                                                        02380000
VTAMLOCK DS    0H                                                       02390000
                                                                        02400000
         TM    FLAG,FLAGLOCK        HAVE WE ALREADY OBTAINED THE LOCK?  02410000
         BOR   R14                  RETURN IF YES                       02420000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             02430000
                                                                        02440000
         $SER  OBTAIN,                                                 +02450000
               VTAM                                                     02460000
                                                                        02470000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              02480000
         BNE   VTAMLOEX             BRANCH IF NOT                       02490000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         02500000
                                                                        02510000
VTAMLOEX DS    0H                                                       02520000
                                                                        02530000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               02540000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          02550000
         BR    R14                  RETURN                              02560000
                                                                        02570000
*---------------------------------------------------------------------- 02580000
* SUBROUTINE VTAMUNLK - RELEASE VTAM GLOBAL LOCK                        02590000
*---------------------------------------------------------------------- 02600000
                                                                        02610000
VTAMUNLK DS    0H                                                       02620000
                                                                        02630000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       02640000
         BNOR  R14                  BRANCH IF NOT                       02650000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             02660000
         BOR   R14                  DON'T RELEASE IF IT WAS             02670000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             02680000
                                                                        02690000
         $SER  RELEASE,                                                +02700000
               VTAM                                                     02710000
                                                                        02720000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  02730000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          02740000
         BR    R14                  RETURN                              02750000
                                                                        02760000
*---------------------------------------------------------------------- 02770000
*  CONSTANTS AND LITERALS                                               02780000
*---------------------------------------------------------------------- 02790000
                                                                        02800000
         LTORG ,                                                        02810000
         PRINT NOGEN                                                    02820000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                02830000
         ISTDBIND ,               VTAM BIND IMAGE                       02840000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         02850000
         ICVT  ,                  INTEGRATOR CVT                        02860000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   02870000
         IRPL ,                   INTEGRATOR VTAM RPL+                  02880000
         IACB ,                   INTEGRATOR VTAM ACB+                  02890000
         INIB ,                   INTEGRATOR VTAM NIB+                  02900000
         ISESS ,                  INTEGRATOR SESSION BLOCK              02910000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            02920000
         ITASK ,                  INTEGRATOR TASK BLOCK                 02930000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          02940000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       02950000
         EVCODES ,                INTEGRATOR EVENT CODES                02960000
         ABCODES ,                INTEGRATOR $ABEND CODES               02970000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     02980000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        02990000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             03000000
         $PROC DSECT=YES          INTEGRATOR $PROC SERVICES             03010000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             03020000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             03030000
         $SESSTMR DSECT=YES       INTEGRATOR $SESSTMR SERVICES          03040000
         $TIMER DSECT=YES         INTEGRATOR $TIMER SERVICES            03050000
         IFGEXLST ,               VTAM EXIT LIST                        03060000
         END   ,                                                        03070000

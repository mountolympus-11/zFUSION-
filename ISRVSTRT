ISRVSTRT TITLE '- Start Server Task(s)'                                 00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE: ISRVSTRT - Start Server Task(s)                              00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine will start the specified number of server             00080000
*    task.  If zero is specified,  the PCCAVT is examined to            00090000
*    determine the number of processors online to the machine.          00100000
*    This number will then be used as the count of server               00110000
*    tasks to create.  An EPB is initialized for each server            00120000
*    task TERMEPB.  After the task is created,  the EPB address         00130000
*    is placed in the SERVERX block, so that the server stop            00140000
*    support can await its termination.                                 00150000
*                                                                       00160000
*                                                                       00170000
* ON ENTRY:                                                             00180000
*                                                                       00190000
*    R1 Contains the address of the parameter list mapped by            00200000
*    the SRVPL dsect generated by $SERVER DSECT=YES.                    00210000
*                                                                       00220000
* ON EXIT:                                                              00230000
*                                                                       00240000
*    R15 Contains one of the following return codes:                    00250000
*                                                                       00260000
*        RC00 - Normal completion                                       00270000
*                                                                       00280000
*        RC12 - Service failure                                         00290000
*               RSN04 - Task Create failure                             00300000
*               RSN08 - Invalid count of online CPUs                    00310000
*                                                                       00320000
*        RC16 - Internal Error                                          00330000
*               RSN04 - Storage allocation failure                      00340000
*                                                                       00350000
* MODE:                                                                 00360000
*                                                                       00370000
*    TASK                                                               00380000
*    APF/NON-APF                                                        00390000
*    SUP/PROB                                                           00400000
*    AMODE 31, RMODE ANY                                                00410000
*                                                                       00420000
**<DOC-OFF>*****************************************************        00430000
                                                                        00440000
         EJECT ,                                                        00450000
****************************************************************        00460000
*                                                                       00470000
* MAINTENANCE:                                                          00480000
*                                                                       00490000
*   01/06/95 Ron Colmone          Par# 159456                           00500000
*            Initial Version                                            00510000
*                                                                       00520000
****************************************************************        00530000
                                                                        00540000
         EJECT ,                                                        00550000
         $SERVER DSECT=YES        SERVER TASK MANAGER PLIST             00560000
                                                                        00570000
         EJECT ,                                                        00580000
         $TASK   DSECT=YES        TASKMGR PLIST                         00590000
                                                                        00600000
         EJECT ,                                                        00610000
         @EPB  ,                  EVENT PROCESS BLOCK ADDRESS           00620000
                                                                        00630000
         EJECT ,                                                        00640000
         EQUS  ,                  GENERAL EQUATES                       00650000
*                                                                       00660000
         EVCODES ,                EVENT CODES                           00670000
*                                                                       00680000
         ABCODES ,                $ABEND CODES                          00690000
                                                                        00700000
         EJECT ,                                                        00710000
         #WORK LENGTH=512         READ/WRITE WORKAREA                   00720000
REGSAVE  DS    16F                REGISTER SAVE AREA                    00730000
SVTASKNM DS    CL8                SERVER TASK NAME                      00740000
TERMEPB  DS    A                  ADDRESS OF SERVER TERM EPB            00750000
                                                                        00760000
$TSK_MFL $TASK MF=(L,*)           $TASK PLIST CONSTRUCTION AREA         00770000
         #ENDWORK                 END OF WORKAREA                       00780000
                                                                        00790000
         EJECT ,                                                        00800000
ISRVSTRT #ENTER BASE=R12,         ENTRY LINKAGE                        +00810000
               PREG=R8,                                                +00820000
               WAPASS=YES                                               00830000
                                                                        00840000
         USING SRVPL,R8           ESTABLISH ADDRESSABILITY              00850000
         USING ITASK,R10          ESTABLISH ADDRESSABILITY              00860000
                                                                        00870000
         EJECT ,                                                        00880000
****************************************************************        00890000
*                                                                       00900000
*  Start Server Task(s)                                                 00910000
*                                                                       00920000
****************************************************************        00930000
                                                                        00940000
*---------------------------------------------------------------        00950000
*  Determine the number of SERVER tasks to create.  If zero             00960000
*  is specified,  then obtain the number of CPUs that are online        00970000
*  on this processor.  Use number of CPUs as default number of          00980000
*  server tasks.                                                        00990000
*---------------------------------------------------------------        01000000
         ICM   R3,15,SVPLSRV#     NUMBER OF SERVER TASKS TO START       01010000
         BNZ   SRV_NEXT           ZERO, ASSUME DEFAULT (# OF CPUS)      01020000
                                                                        01030000
         L     R1,CVTPTR          ADDRESS OF SYSTEM CVT                 01040000
         USING CVT,R1             TEMP ADDRESSABILITY                   01050000
         L     R1,CVTPCCAT        ADDRESS OF PCCA VECTOR TABLE          01060000
         DROP  R1                 CVT                                   01070000
                                                                        01080000
         LA    R2,#PCCA           COUNT OF PCCA VECTOR ENTRIES          01090000
         SR    R0,R0              PREPARE FOR ZERO COMPARE              01100000
                                                                        01110000
PCCA_NXT DS    0H                                                       01120000
         C     R0,0(,R1)          PCCA AVAILABLE                        01130000
         BE    *+8                NO, CONTINUE                          01140000
         LA    R3,1(,R3)          INCREMENT SERVER TASK COUNT           01150000
         LA    R1,4(,R1)          INCREMENT TO NEXT PCCAVT ENTRY        01160000
         BCT   R2,PCCA_NXT        CHECK NEXT PCCA ENTRY                 01170000
                                                                        01180000
         LTR   R3,R3              SERVER TASK COUNT > 0                 01190000
         BZ    ERR_PCCA           INVALID NUMBER OF ONLINE CPUS         01200000
                                                                        01210000
         EJECT ,                                                        01220000
*---------------------------------------------------------------        01230000
*  Allocate and initialize EPB for Server task termination              01240000
*---------------------------------------------------------------        01250000
SRV_NEXT DS    0H                                                       01260000
         $GETSTOR EPBLENG,OWNER=ITASK,COND=YES                          01270000
         BNZ   ERR_STG            ERROR ACQUIRING STORAGE               01280000
         ST    R1,TERMEPB         ADDRESS OF SERVER TERM EPB            01290000
                                                                        01300000
         $TASK SETEPB,            Initialize termination EPB           +01310000
               EPB=*TERMEPB,                                           +01320000
               ECODE=EC$TERM_TASK,                                     +01330000
               MF=(E,$TSK_MFL)                                          01340000
                                                                        01350000
*---------------------------------------------------------------        01360000
*  Create server task                                                   01370000
*---------------------------------------------------------------        01380000
                                                                        01390000
         L     R1,ICTSRVT#        HIGHEST SUFFIX OF SERVER TASKS        01400000
         LA    R0,1(,R1)          INCREMENT SERVER TASK SUFFIX          01410000
         CS    R1,R0,ICTSRVT#     UPDATE SUFFIX COUNT                   01420000
         BNE   *-8                RETRY                                 01430000
         LA    R1,SVTASKNM        NAME OF SERVER TASK                   01440000
         BAS   R14,GETNAME        CONSTRUCT TASK NAME                   01450000
                                                                        01460000
         $TASK CREATE,            CREATE SERVER TASK                   +01470000
               NAME=SVTASKNM,                                          +01480000
               EP=*#SRVMAIN,                                           +01490000
               PARM=0,                                                 +01500000
               SYNC=YES,                                               +01510000
               TYPE=SERVER,                                            +01520000
               TCBAFF=YES,                                             +01530000
               DPMOD=*=F'-10',                                         +01540000
               TERMEPB=*TERMEPB,                                       +01550000
               MF=(E,$TSK_MFL)                                          01560000
                                                                        01570000
         BNZ   ERR_CREA           TASK CREATE FAILED                    01580000
         LR    R5,R1              ADDRESS OF ITASK                      01590000
S        USING ITASK,R5           ADDRESSABILITY                        01600000
                                                                        01610000
         L     R6,S.TSKSRV        ADDRESS OF SERVER EXTENSION           01620000
         USING SERVERX,R6         ADDRESSABILITY                        01630000
         MVC   SRVTEPB@,TERMEPB   ADDRESS OF SERVER TERMEPB             01640000
         L     R0,ICTSRVT#        GET CURRENT SERVER NUMBER             01650000
         STH   R0,SRVIDNUM        SET SERVER ID NUMBER                  01660000
                                                                        01670000
         BCT   R3,SRV_NEXT        CREATE NEXT SERVER TASK               01680000
                                                                        01690000
         LA    R15,RC00           NORMAL COMPLETION                     01700000
         LA    R0,RSN00           NORMAL COMPLETION                     01710000
         B     RETURN             RETURN                                01720000
                                                                        01730000
         DROP  S,R6               ITASK (SERVER), SERVERX               01740000
                                                                        01750000
         EJECT ,                                                        01760000
****************************************************************        01770000
*                                                                       01780000
*   ERROR EXIT                                                          01790000
*                                                                       01800000
****************************************************************        01810000
                                                                        01820000
ERR_CREA DS    0H                                                       01830000
         LR    R1,R15             $TASK RETURN CODE                     01840000
         LA    R0,RSN04           TASK CREATE FAILURE                   01850000
         B     RET_RC12           SERVICE FAILURE                       01860000
                                                                        01870000
ERR_PCCA DS    0H                                                       01880000
         LA    R0,RSN08           INVALID NUMBER OF CPUS                01890000
         B     RET_RC12           SERVICE FAILURE                       01900000
                                                                        01910000
ERR_STG  DS    0H                                                       01920000
         LA    R0,RSN04           STORAGE ALLOCATION ERROR              01930000
         B     RET_RC16           INTERNAL ERROR                        01940000
                                                                        01950000
         EJECT ,                                                        01960000
****************************************************************        01970000
*                                                                       01980000
*   RETURN                                                              01990000
*                                                                       02000000
****************************************************************        02010000
                                                                        02020000
RET_RC12 DS    0H                                                       02030000
         LA    R15,RC12           SERVICE FAILURE                       02040000
         B     RETURN                                                   02050000
                                                                        02060000
RET_RC16 DS    0H                                                       02070000
         LA    R15,RC16           ABNORMAL RETURN (INTERNAL ERR)        02080000
         B     RETURN                                                   02090000
                                                                        02100000
RETURN   DS    0H                                                       02110000
         #EXIT ,                  RETURN                                02120000
                                                                        02130000
         EJECT ,                                                        02140000
****************************************************************        02150000
*                                                                       02160000
*  Routine: Getname - Construct Server task name                        02170000
*                                                                       02180000
*  Entry:  R0 - Server Task Suffix                                      02190000
*          R1 - Address of area to construct name                       02200000
*                                                                       02210000
****************************************************************        02220000
                                                                        02230000
GETNAME  DS    0H                                                       02240000
         STM   R0,R15,REGSAVE     SAVE CALLERS REGISTERS                02250000
                                                                        02260000
         LR    R3,R0              GET SERVER NAME SUFFIX                02270000
         CVD   R3,DWORD           CONVERT SUFFIX TO DECIMAL             02280000
         UNPK  3(5,R1),DWORD+5(3) MAKE TO PRINTABLE                     02290000
         OI    7(R1),X'F0'        FIX SIGN                              02300000
         MVC   0(4,R1),=C'$SRV'   SERVER NAME PREFIX                    02310000
                                                                        02320000
         LM    R0,R15,REGSAVE     RESTORE CALLERS REGISTERS             02330000
         BR    R14                RETURN                                02340000
                                                                        02350000
         EJECT ,                                                        02360000
****************************************************************        02370000
*                                                                       02380000
*  CONSTANTS AND LITERALS                                               02390000
*                                                                       02400000
****************************************************************        02410000
                                                                        02420000
         LTORG ,                                                        02430000
                                                                        02440000
         PRINT NOGEN                                                    02450000
         ICVT  ,                                                        02460000
         ITASK ,                                                        02470000
         SERVERX ,                                                      02480000
                                                                        02490000
         CVT   DSECT=YES                                                02500000
         IHAPCCAT ,                                                     02510000
#PCCA    EQU   (*-PCCAVT)/4       NUMBER OF PCCA VECTOR ENTRIES         02520000
                                                                        02530000
         END   ,                                                        02540000

ITRNTEST TITLE 'INTEGRATOR - SYSTEMS CONNECTION TEST TRANSACTION'       00010000
**<DOC-ON>************************************************************* 00020000
*                                                                       00030000
* ROUTINE: ITRNTEST - SYSTEMS CONNECTION TEST TRANSACTION               00040000
*                                                                       00050000
* DESCRIPTION: THIS ROUTINE IS A SYSTEMS-TO-SYSTEMS TRANSACTION         00060000
*              PROGRAM.  IT IMPLEMENTS THE SYSTEMS CONNECTION TEST      00070000
*              TRANSACTION.                                             00080000
*                                                                       00090000
* ON ENTRY:                                                             00100000
*                                                                       00110000
*    R15 = ENTRY POINT ADDRESS                                          00120000
*    R14 = RETURN ADDRESS                                               00130000
*    R13 = AVAILABLE SAVE AREA                                          00140000
*    R11 = ICVT ADDRESS                                                 00150000
*    R10 = ITASK ADDRESS                                                00160000
*    R01 = ITWA ADDRESS                                                 00170000
*    R00 = ISYS ADDRESS                                                 00180000
*                                                                       00190000
* ON EXIT:                                                              00200000
*                                                                       00210000
*    R15 = 0 RESPOND AND WAIT FOR MORE INPUT                            00220000
*                                                                       00230000
*            R00 = 0                                                    00240000
*            R01 = 0                                                    00250000
*                                                                       00260000
*        = 4 RESPOND AND SEND A MESSAGE                                 00270000
*                                                                       00280000
*            R00 = LENGTH OF MESSAGE TO SEND                            00290000
*            R01 = ADDRESS OF MESSAGE TO SEND                           00300000
*                                                                       00310000
*        = 8 RESPOND AND END TRANSACTION                                00320000
*                                                                       00330000
*            R00 = 0                                                    00340000
*            R01 = 0                                                    00350000
*                                                                       00360000
*        =12 RESPOND AND TERMINATE SYSTEMS CONNECTION                   00370000
*                                                                       00380000
*            R00 = 0                                                    00390000
*            R01 = 0                                                    00400000
*                                                                       00410000
*    ALL OTHER REGISTERS ARE RESTORED.                                  00420000
*                                                                       00430000
**<DOC-OFF>************************************************************ 00440000
                                                                        00450000
         EJECT ,                                                        00460000
*********************************************************************** 00470000
*                                                                       00480000
* MAINTENANCE:                                                          00490000
*                                                                       00500000
*   12/31/93 RANDY WITEK                                                00510000
*                                                                       00520000
*********************************************************************** 00530000
                                                                        00540000
         EQUS  ,                  GENERAL EQUATES                       00550000
                                                                        00560000
RITASK   EQU   R10                                                      00570000
RITWA    EQU   R9                                                       00580000
RISMH    EQU   R8                                                       00590000
                                                                        00600000
         USING ITASK,RITASK       ESTABLISH ADDRESSIBILITY              00610000
         USING ITWA,RITWA         ESTABLISH ADDRESSABILITY              00620000
         USING ISMH,RISMH                                               00630000
                                                                        00640000
WORKAREA #WORK ,                  GENERAL WORKAREA                      00650000
                                                                        00660000
RETR15   DS    F                                                        00670000
RETR0    DS    F                                                        00680000
RETR1    DS    F                                                        00690000
RETREGS  EQU   RETR15,*-RETR15    RETURN REGSITERS                      00700000
                                                                        00710000
         DS    0D                                                       00720000
WRK256   DS    XL256              GENERAL PURPOSE WORKAREA              00730000
                                                                        00740000
WORKLEN  #ENDWORK ,               WORKAREA END                          00750000
                                                                        00760000
         $MSGDFT PREFIX=ICTPID,COMPID='VTM',TABLE=*#MSGS,              +00770000
               CONID=*ICTCONID,CONNAME=ICTCONNM,                       +00780000
               MF=(E,WRK256)                                            00790000
                                                                        00800000
ITRNTEST #ENTER BASE=R12,                                              +00810000
               PREG=(RITWA),       R1 --> RITWA                        +00820000
               AMODE=31,                                               +00830000
               RMODE=ANY                                                00840000
                                                                        00850000
*---------------------------------------------------------------------- 00860000
* INITIALIZATION                                                        00870000
*---------------------------------------------------------------------- 00880000
                                                                        00890000
         L     R1,ITWPARM         GET PARM WORD                         00900000
         SLL   R1,2               TIMES 4                               00910000
         B     PARMJUMP(R1)       JUMP TO APPROPRIATE ROUTINE           00920000
                                                                        00930000
PARMJUMP B     INITIATE           0 = TRANSACTION INITIATION ROUTINE    00940000
         B     REQUEST            1 = REQUEST RECEIVED                  00950000
         B     RESPONSE           2 = RESPONSE RECEIVED                 00960000
         B     CLEANUP            3 = CLEANUP TRANSACTION               00970000
                                                                        00980000
*---------------------------------------------------------------------- 00990000
* WE ARE CALLED TO PROCESS A REQUEST MESSAGE THAT HAS BEEN RECEIVED     01000000
*---------------------------------------------------------------------- 01010000
                                                                        01020000
REQUEST  DS    0H                                                       01030000
                                                                        01040000
         ICM   RISMH,15,ITWDATA@  ADDRESS OF REQUEST MESSAGE            01050000
         BNP   ABN_ENV            BRANCH IF NO REQUEST MESSAGE          01060000
                                                                        01070000
         L     R1,ITWDATAL        MESSAGE LENGTH                        01080000
         C     R1,=A(L'ISMMAX+12) EXPECTED MESSAGE LENGTH               01090000
         BL    ABN_ENV            BRANCH IF MESSAGE LOOKS INCORRECT     01100000
                                                                        01110000
         $SYSTEMS FIND,                                                +01120000
               APPLID=ISMDATA,                                         +01130000
               ERRET=REQERRAP,                                         +01140000
               MF=(E,MFE_LIST)                                          01150000
                                                                        01160000
X        USING SYLIST,R1                                                01170000
         L     R2,X.SYLRSNCD      ISYS ADDRESS IS THE REASON CODE       01180000
         DROP  X                                                        01190000
                                                                        01200000
X        USING ISY,R2                                                   01210000
         CLC   X.ISYSMFID,ISMDATA+8                                     01220000
         BNE   REQERRID           BRANCH IF PARTNER SMFID INCORRECT     01230000
         DROP  X                                                        01240000
                                                                        01250000
         B     REQEND             GO TO END OF REQUEST PROCESSING       01260000
                                                                        01270000
REQERRAP DS    0H                                                       01280000
                                                                        01290000
         $MSG  025,                                                    +01300000
               FIELDS=((ISMDATA,8))                                     01310000
                                                                        01320000
         B     REQERROR                                                 01330000
                                                                        01340000
REQERRID DS    0H                                                       01350000
                                                                        01360000
         $MSG  026,                                                    +01370000
               FIELDS=((ISMDATA+8,4),                                  +01380000
               (ISMDATA,8))                                             01390000
                                                                        01400000
         B     REQERROR                                                 01410000
                                                                        01420000
REQERROR DS    0H                                                       01430000
                                                                        01440000
         MVI   ITWWORK+1,X'FF'        FLAG "TERMINATION REQUIRED"       01450000
         MVC   ITWSENSE,=X'080A0000'  SENSE INFO FOR RESPONSE           01460000
                                                                        01470000
REQEND   DS    0H                                                       01480000
                                                                        01490000
         TM    ISMF,ISMFEND       IS THIS AN END OF TRANSACTION?        01500000
         BNO   INITSEND           IF NOT, SEND A TRANSACTION BACK       01510000
         CLI   ITWWORK+1,X'FF'    IS TERMINATION REQUIRED?              01520000
         BE    RET12              SET RC=12 TO END CONNECTION           01530000
         B     RET8               SET RC=8  TO END TRANSACTION          01540000
                                                                        01550000
*---------------------------------------------------------------------- 01560000
* WE ARE CALLED TO PROCESS A RESPONSE MESSAGE THAT HAS BEEN RECEIVED    01570000
*---------------------------------------------------------------------- 01580000
                                                                        01590000
RESPONSE DS    0H                                                       01600000
                                                                        01610000
         ICM   RISMH,15,ITWDATA@  ADDRESS OF RESPONSE MESSAGE           01620000
         BNP   ABN_ENV            BRANCH IF NO RESPONSE MESSAGE         01630000
                                                                        01640000
         OC    ISMSENSE,ISMSENSE  IS IT AN ERROR RESPONSE?              01650000
         BZ    RESPEND            BRANCH IF NOT                         01660000
                                                                        01670000
RESPERR  DS    0H                                                       01680000
                                                                        01690000
         MVI   ITWWORK+1,X'FF'    FLAG "SESSION TERMINATION REQUIRED"   01700000
                                                                        01710000
         $MSG  024,                                                    +01720000
               FIELDS=(ISMSENSE)                                        01730000
                                                                        01740000
RESPEND  DS    0H                                                       01750000
                                                                        01760000
         TM    ISMF,ISMFEND       IS END FLAGGED?                       01770000
         BNO   RETURN             BRANCH IF NOT TO WAIT FOR REQUEST     01780000
         CLI   ITWWORK+1,X'FF'    IS TERMINATION REQUIRED?              01790000
         BE    RET12              SET RC=12 TO END CONNECTION IF YES    01800000
         B     RET8               SET RC=8  TO END TRANSACTION          01810000
                                                                        01820000
*---------------------------------------------------------------------- 01830000
* WE ARE CALLED TO INITIATE A TRANSACTION                               01840000
*---------------------------------------------------------------------- 01850000
                                                                        01860000
INITIATE DS    0H                                                       01870000
                                                                        01880000
         MVI   ITWWORK,X'FF'      REMEMBER THAT WE ARE INITIATOR        01890000
                                                                        01900000
INITSEND DS    0H                                                       01910000
                                                                        01920000
         LA    RISMH,ITWWORK+4    ADDRESSIBILITY                        01930000
         ST    RISMH,RETR1        ADDRESS OF MESSAGE TO SEND            01940000
         MVC   RETR0,=A(L'ISMMAX+12) LENGTH OF MESSAGE TO SEND          01950000
         MVC   ITWRNAME,=CL8'ITRNTEST'                                  01960000
         MVC   ISMDATA(8),ICTAPLID                                      01970000
         MVC   ISMDATA+8(4),ICTSMFID                                    01980000
         CLI   ITWWORK,X'FF'      ARE WE THE INITIATOR?                 01990000
         BE    RET4               BRANCH IF YES, DON'T SET END FLAG     02000000
         OI    ISMF,ISMFEND       SET THE END FLAG                      02010000
         B     RET4               SET RC=4 TO SEND THE MESSAGE          02020000
                                                                        02030000
*---------------------------------------------------------------------- 02040000
* WE ARE CALLED TO CLEANUP FOR SOME UNEXPECTED REASON                   02050000
*---------------------------------------------------------------------- 02060000
                                                                        02070000
CLEANUP  DS    0H                                                       02080000
                                                                        02090000
         B     RET8               SET RC=8 TO END TRANSACTION           02100000
                                                                        02110000
*---------------------------------------------------------------------- 02120000
* RETURN TO CALLER (ISYSRU)                                             02130000
*---------------------------------------------------------------------- 02140000
                                                                        02150000
RET12    DS    0H                                                       02160000
                                                                        02170000
         MVI   RETR15+(L'RETR15-1),12                                   02180000
         B     RETURN                                                   02190000
                                                                        02200000
RET8     DS    0H                                                       02210000
                                                                        02220000
         MVI   RETR15+(L'RETR15-1),8                                    02230000
         B     RETURN                                                   02240000
                                                                        02250000
RET4     DS    0H                                                       02260000
                                                                        02270000
         MVI   RETR15+(L'RETR15-1),4                                    02280000
         B     RETURN                                                   02290000
                                                                        02300000
RETURN   DS    0H                                                       02310000
                                                                        02320000
         LM    R15,R1,RETREGS     SET RETURN REGISTERS                  02330000
                                                                        02340000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    02350000
                                                                        02360000
*---------------------------------------------------------------------- 02370000
* CATASTROPHIC ERRORS                                                   02380000
*---------------------------------------------------------------------- 02390000
                                                                        02400000
ABN_ENV  DS    0H                                                       02410000
                                                                        02420000
         STM   R15,R1,RETREGS                                           02430000
                                                                        02440000
         $ABEND ABE_VTDIAG,                                            +02450000
               DUMP=YES,                                               +02460000
               SCOPE=PCB,                                              +02470000
               TITLE='ENVIRONMENTAL ERROR IN ITRNTEST'                  02480000
                                                                        02490000
*---------------------------------------------------------------------- 02500000
* LOCAL READ-ONLY CONSTANTS, ETC.                                       02510000
*---------------------------------------------------------------------- 02520000
                                                                        02530000
         LTORG ,                                                        02540000
                                                                        02550000
         PRINT NOGEN                                                    02560000
         ICVT  ,                                                        02570000
         IVTAMCVT ,                                                     02580000
         ITASK ,                                                        02590000
         IPCB  ,                                                        02600000
         $SYSTEMS DSECT=YES       SYSTEMS SERVICES PLIST                02610000
         ABCODES PRINT=NOGEN      $ABEND CODES                          02620000
         MSGCODES ,               INTERTASK MESSAGE CODES               02630000
         EVCODES ,                TASK EVENT CODES                      02640000
         NAV ,                                                          02650000
         END   ,                                                        02660000

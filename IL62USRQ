IL62USRQ TITLE 'INTEGRATOR - IVUSER LU6.2 SESSION REQ COMPLETION'       00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: IL62USRQ - IVUSER LU6.2 SESSION REQ COMPLETION               00100000
*                                                                       00110000
* DESCRIPTION:                                                          00120000
*                                                                       00130000
* ON ENTRY:                                                             00140000
*                                                                       00150000
*    R15 = ENTRY POINT ADDRESS                                          00160000
*    R14 = RETURN ADDRESS                                               00170000
*    R13 = AVAILABLE SAVE AREA                                          00180000
*    R11 = ICVT ADDRESS                                                 00190000
*    R10 = ITASK ADDRESS                                                00200000
*    R09 = IVTAMCVT ADDRESS                                             00210000
*    R08 = IVUSER ADDRESS                                               00220000
*    R01 = ADDRESS OF LU6.2 SESSION REQUEST COMPLETION WORK ELEMENT     00230000
*                                                                       00240000
* ON EXIT:                                                              00250000
*                                                                       00260000
*    R15 = 0                                                            00270000
*    R00 = 0                                                            00280000
*    R01 = 0                                                            00290000
*                                                                       00300000
*    ALL OTHER REGISTERS ARE RESTORED.                                  00310000
*                                                                       00320000
**<DOC-OFF>************************************************************ 00330000
                                                                        00340000
         EJECT ,                                                        00350000
*********************************************************************** 00360000
*                                                                       00370000
* MAINTENANCE:                                                          00380000
*                                                                       00390000
*   07/01/94 RANDY WITEK - LU6.2 SUPPORT                                00400000
*                                                                       00410000
*********************************************************************** 00420000
                                                                        00430000
         EQUS  ,                  GENERAL EQUATES                       00440000
                                                                        00450000
RICVT    EQU   R11                                                      00460000
RITASK   EQU   R10                                                      00470000
RIVTAM   EQU   R9                                                       00480000
RIVUSER  EQU   R8                                                       00490000
RIWE     EQU   R7                                                       00500000
RAQE     EQU   R6                                                       00510000
RMDE     EQU   R5                                                       00520000
                                                                        00530000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00540000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00550000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00560000
         USING IVUSER,RIVUSER     ESTABLISH ADDRESSABILITY              00570000
         USING IWEVTAM,RIWE       ESTABLISH ADDRESSABILITY              00580000
         USING AQE,RAQE           ESTABLISH ADDRESSABILITY              00590000
         USING MDE,RMDE           ESTABLISH ADDRESSABILITY              00600000
                                                                        00610000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00620000
WRK256   DS    XL256              GENERAL WORKAREA                      00630000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00640000
$SESSMFL $SESS MF=L               PLIST CONSTRUCTION                    00650000
$TASKMFL $TASK MF=L               PLIST CONSTRUCTION                    00660000
$WUMFL   $WULOC MF=L              PLIST CONSTRUCTION                    00670000
L62MFL   L62POST MF=L             PLIST CONSTRUCTION                    00680000
L62RETRC DS    F                  LU6.2 RETURN CODE RETURN AREA         00690000
WUDATA   DS    XL16               WULOC RETURN AREA                     00700000
RETR15   DS    F                                                        00710000
RETR0    DS    F                                                        00720000
RETR1    DS    F                                                        00730000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00740000
FLAG     DS    X                                                        00750000
FLAGLOCK EQU   X'80'                                                    00760000
FLAGLCKD EQU   X'40'                                                    00770000
FLAGDLCK EQU   X'20'              DISP LOCK HELD                        00780000
FLAGDLKD EQU   X'10'              DISP LOCK HELD ON ENTRY               00790000
                                                                        00800000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00810000
                                                                        00820000
         $MSGDFT PREFIX=ICTPID,                                        +00830000
               COMPID='L62',                                           +00840000
               TABLE=*#MSGS,                                           +00850000
               WORKA=0,                                                +00860000
               MF=(E,WRK256),                                          +00870000
               PRINT=NOGEN                                              00880000
                                                                        00890000
IL62USRQ #ENTER BASE=R12,         ENTRY LINKAGE                        +00900000
               PREG=RIWE,                                              +00910000
               AMODE=31,                                               +00920000
               RMODE=ANY                                                00930000
                                                                        00940000
*---------------------------------------------------------------------- 00950000
* ESTABLISH ENVIRONMENT                                                 00960000
*---------------------------------------------------------------------- 00970000
                                                                        00980000
         BAS   R14,VTAMLOCK       SERIALIZE                             00990000
                                                                        01000000
         L     RAQE,IWEXSAQE      ASSOCIATED AQE ADDRESS                01010000
         CLC   AQEID,=CL8'AQE'    DOES IT LOOK RIGHT?                   01020000
         BNE   ERRENVIR           BRANCH IF NOT                         01030000
                                                                        01040000
         L     RMDE,AQEMDE        ASSOCIATED MDE ADDRESS                01050000
         CLC   MDEID,=CL8'MDE'    DOES IT LOOK RIGHT?                   01060000
         BNE   ERRENVIR           BRANCH IF NOT                         01070000
                                                                        01080000
         LA    R14,MDEWR1ST       ADDRESS OF WAITING REQUEST HEAD       01090000
         S     R14,=A(AQENEXT-AQE) NORMALIZE FOR CHAIN RUN              01100000
                                                                        01110000
AQERUN   DS    0H                                                       01120000
                                                                        01130000
         ICM   R14,15,AQENEXT-AQE(R14) NEXT AQE IN LIST                 01140000
         BM    ERRENVIR           ERROR IF GIVEN AQE NOT IN LIST        01150000
         CR    R14,RAQE           IS THIS THE ONE?                      01160000
         BNE   AQERUN             BRANCH IF NOT                         01170000
         LM    R14,R15,AQENEXT    R14=NEXT AQE R15=PREVIOUS AQE         01180000
         ST    R15,AQEPREV-AQE(,R14) POINT NEXT AQE AT THE PREVIOUS     01190000
         ST    R14,AQENEXT-AQE(,R15) POINT PREVIOUS AQE AT THE NEXT     01200000
                                                                        01210000
*---------------------------------------------------------------------- 01220000
* UPDATE THE SESSION COUNTS                                             01230000
*---------------------------------------------------------------------- 01240000
                                                                        01250000
         L     R14,MDEPSC         PENDING SESSION COUNT                 01260000
         S     R14,=F'1'          MINUS ONE                             01270000
         BM    ERRENVIR           BRANCH IF COUNT IS BAD                01280000
         ST    R14,MDEPSC         SET UPDATED PENDING SESSION COUNT     01290000
                                                                        01300000
         LA    R15,MDEPCWC        PENDING CONWINNER COUNT               01310000
         TM    AQEF1,AQEF1WIN     WAS THIS A CONWINNER REQUEST?         01320000
         BO    *+8                BRANCH IF YES                         01330000
         LA    R15,MDEPCLC        PENDING CONLOSER COUNT                01340000
         L     R14,0(,R15)        CURRENT WIN/LOSE COUNT                01350000
         S     R14,=F'1'          MINUS ONE                             01360000
         BM    ERRENVIR           BRANCH IF COUNT IS BAD                01370000
         ST    R14,0(,R15)        SET UPDATED WIN/LOSE COUNT            01380000
                                                                        01390000
*---------------------------------------------------------------------- 01400000
* PROCESS SUCCESSFUL REQUEST                                            01410000
*---------------------------------------------------------------------- 01420000
                                                                        01430000
         CLC   AQE$SRET,=A($SESS_RC_SUCCESS)                            01440000
         BNE   FAILED                                                   01450000
                                                                        01460000
*                                                                       01470000
* LOCATE THE ISESS BLOCK OF THE NEW SESSION AND LINK IT TO MDE          01480000
*---------------------------------------------------------------------- 01490000
                                                                        01500000
         $SESS $SESS_FIND_SESSION,                                     +01510000
               SESSION=AQE$STKN,                                       +01520000
               ERRET=FAILED,                                           +01530000
               MF=(E,$SESSMFL)    LOCATE ASSOCIATED ISESS, IF ANY       01540000
                                                                        01550000
W        USING SPLIST,$SESSMFL                                          01560000
         L     R4,W.SPLAREA       ADDRESS OF ASSOCIATED ISESS BLOCK     01570000
                                                                        01580000
         DROP  W                                                        01590000
                                                                        01600000
X        USING ISESS,R4                                                 01610000
         ST    RMDE,X.ISE62MDE    LINK MDE TO ISESS                     01620000
                                                                        01630000
*                                                                       01640000
* UPDATE THE ACTIVE SESSION COUNTS                                      01650000
*---------------------------------------------------------------------- 01660000
                                                                        01670000
         L     R15,MDEASC         UPDATE ACTIVE SESSION COUNT           01680000
         LA    R15,1(,R15)        UPDATE ACTIVE SESSION COUNT           01690000
         ST    R15,MDEASC         UPDATE ACTIVE SESSION COUNT           01700000
                                                                        01710000
         LA    R15,MDEACWC        ACTIVE CONWINNER COUNT                01720000
         TM    AQEF1,AQEF1WIN     WAS THIS A CONWINNER REQUEST?         01730000
         BO    *+8                BRANCH IF YES                         01740000
         LA    R15,MDEACLC        ACTIVE CONLOSER COUNT                 01750000
         L     R14,0(,R15)        UPDATE WINNER/LOSER ACTIVE COUNT      01760000
         LA    R14,1(,R14)        UPDATE WINNER/LOSER ACTIVE COUNT      01770000
         ST    R14,0(,R15)        UPDATE WINNER/LOSER ACTIVE COUNT      01780000
                                                                        01790000
*                                                                       01800000
* IF THIS WAS NOT THE "SNASVCMG" MODE, COMPLETE THE GETSESSION REQUEST. 01810000
* - CONNECT THE RCB TO THE SESSION.                                     01820000
* - POST THE PENDING REQUEST.                                           01830000
* - RELEASE THE AQE.                                                    01840000
*---------------------------------------------------------------------- 01850000
                                                                        01860000
         CLC   MDENAME,=CL8'SNASVCMG'                                   01870000
         BE    ACTSVCMG           BRANCH IF SPECIAL MODE                01880000
                                                                        01890000
CONNECT  DS    0H                                                       01900000
                                                                        01910000
         BAS   R14,DISPLOCK       SERIALIZE                             01920000
                                                                        01930000
         $WULOC LOCATE,           FIND THE WORK UNIT                   +01940000
               TOKEN=AQEENT,      WORK UNIT TOKEN ADDRESS              +01950000
               USERDATA=WUDATA,   XL16 AREA TO RECEIVE USER DATA       +01960000
               MF=(E,$WUMFL)      VALIDATE WORK UNIT                    01970000
                                                                        01980000
         LTR   R15,R15            LOCATE SUCCESS?                       01990000
         BNZ   REQGONE            BRANCH IF NOT, LET POST ISSUE MSG     02000000
         L     R3,AQERCB          ASSOCIATED RCB ADDRESS SHOULD BE OK   02010000
                                                                        02020000
Y        USING RCB,R3                                                   02030000
         MVC   Y.RCBHSID,AQE$STKN  SET SESSION TOKEN IN RCB             02040000
         MVC   X.ISE62ENT,Y.RCBENT WORK UNIT ASSOCIATED WITH OWNING RCB 02050000
         ST    R3,X.ISE62RCB       TIE ISESS TO RCB                     02060000
                                                                        02070000
         DROP  Y                                                        02080000
                                                                        02090000
POSTIT   DS    0H                                                       02100000
                                                                        02110000
         SR    R0,R0              POSTCODE = SUCCESS                    02120000
         BAS   R14,POSTREQ        POST THE REQUEST                      02130000
         BAS   R14,DISPUNLK       DESERIALIZE                           02140000
         BAS   R14,FREEAQE        RELEASE THE QUEUE ELEMENT             02150000
         B     RETURN                                                   02160000
                                                                        02170000
*                                                                       02180000
* SESSION REQUEST WAS SUCCESSFUL BUT THE REQUESTOR IS GONE.             02190000
* RELEASE THE SESSION.                                                  02200000
*---------------------------------------------------------------------- 02210000
                                                                        02220000
REQGONE  DS    0H                                                       02230000
                                                                        02240000
         SR    R0,R0              POSTCODE = SUCCESS                    02250000
         BAS   R14,POSTREQ        POST THE REQUEST                      02260000
         BAS   R14,DISPUNLK       DESERIALIZE                           02270000
         BAS   R14,FREEAQE        RELEASE THE QUEUE ELEMENT             02280000
                                                                        02290000
         $VTAMWE L'IWEY6,         LENGTH                               +02300000
               IWECYLD            CODE                                  02310000
                                                                        02320000
Z        USING IWEVTAM,R1                                               02330000
         ST    RMDE,Z.IWEY6MDE    PASS THE MDE ADDRESS                  02340000
         MVC   Z.IWEY6NME,MDENAME PASS THE MODE NAME                    02350000
         MVC   Z.IWEY6TKN,X.ISETK PASS THE SESSION TOKEN                02360000
                                                                        02370000
         DROP  Z                                                        02380000
                                                                        02390000
         LA    R0,X.ISEWEQ        QUEUE ADDRESS                         02400000
         BAS   R14,QWE            QUEUE THE WORK ELEMENT                02410000
         B     RETURN                                                   02420000
                                                                        02430000
*                                                                       02440000
* THE "SNASVCMG" MODE IS ACTIVE.                                        02450000
* YIELD THE SESSION AND ALLOW "FREE SESSION" LOGIC TO SERVICE WAITING   02460000
* REQUESTORS.                                                           02470000
*---------------------------------------------------------------------- 02480000
                                                                        02490000
ACTSVCMG DS    0H                                                       02500000
                                                                        02510000
         OC    AQEEPB,AQEEPB      IS THIS A DUMMY AQE FOR SNASVCMG?     02520000
         BNZ   CONNECT            BRANCH IF IT IS NOT A DUMMY           02530000
         BAS   R14,FREEAQE        RELEASE THE SNASVCMG DUMMY AQE        02540000
                                                                        02550000
         $VTAMWE L'IWEY6,         LENGTH                               +02560000
               IWECYLD            CODE                                  02570000
                                                                        02580000
Z        USING IWEVTAM,R1                                               02590000
         ST    RMDE,Z.IWEY6MDE    PASS THE MDE ADDRESS                  02600000
         MVC   Z.IWEY6NME,MDENAME PASS THE MODE NAME                    02610000
         MVC   Z.IWEY6TKN,X.ISETK PASS THE SESSION TOKEN                02620000
                                                                        02630000
         DROP  Z                                                        02640000
                                                                        02650000
         LA    R0,X.ISEWEQ        QUEUE ADDRESS                         02660000
         BAS   R14,QWE            QUEUE THE WORK ELEMENT                02670000
         B     RETURN                                                   02680000
                                                                        02690000
         DROP  X                                                        02700000
                                                                        02710000
*---------------------------------------------------------------------- 02720000
* PROCESS UNSUCCESSFUL REQUEST                                          02730000
*---------------------------------------------------------------------- 02740000
                                                                        02750000
FAILED   DS    0H                                                       02760000
                                                                        02770000
*                                                                       02780000
* IF "SNASVCMG" MODE FAILED TO ACTIVATE...                              02790000
* - REMOVE THE MDE FOR SNASVCMG                                         02800000
* - REMOVE THE PARALLEL SESSION CAPABILITY FLAG                         02810000
* - FIND THE REAL MODE THAT WAS REQUESTED                               02820000
* - SET SESSION LIMITS FOR A SINGLE SESSION MODE                        02830000
* - TRY TO START A SINGLE SESSION USING THAT MODE                       02840000
*---------------------------------------------------------------------- 02850000
                                                                        02860000
         CLC   MDENAME,=CL8'SNASVCMG'                                   02870000
         BNE   FAILREAL              BRANCH IF NOT SPECIAL MODE         02880000
                                                                        02890000
         LM    R14,R15,MDENEXT       R14=FOLLOWING MDE R15=PREVIOUS MDE 02900000
         ST    R14,MDENEXT-MDE(,R15) POINT PREVIOUS MDE AT FOLLOWING    02910000
         ST    R15,MDEPREV-MDE(,R14) POINT FOLLOWING MDE AT PREVIOUS    02920000
         BAS   R14,FREEAQE           RELEASE THE SNASVCMG AQE           02930000
                                                                        02940000
         $RETSTOR (RMDE),                                              +02950000
               OWNER=(RITASK)        RELEASE THE SNASVCMG MDE           02960000
                                                                        02970000
         NI    IVUF1,255-IVUF1PSC    NOT PARALLEL SESSION CAPABLE       02980000
                                                                        02990000
         ICM   RMDE,15,IVUMD1ST      FIRST MDE                          03000000
         BNP   RETURN                EXIT IF NO OTHER MDE ?????         03010000
                                                                        03020000
         TM    MDEF1,MDEF1WSS        WAITING FOR SNASVCMG?              03030000
         BNO   ERRENVIR              BRANCH IF NOT ?????                03040000
         NI    MDEF1,255-MDEF1WSS    NO LONGER WAITING                  03050000
         MVC   MDESESSL,=F'1'        SET FOR SINGLE SESSION MODE        03060000
         ICM   R1,15,MDEWR1ST        GET THE FIRST REQUEST              03070000
         BNP   ERRENVIR              EXIT IF NOT WAITING REQUEST        03080000
         L     R15,IL6@USTS          START SESSION ROUTINE              03090000
         BASR  R14,R15               GO START A SESSION                 03100000
                                                                        03110000
* RELEASE ANY OTHER MDE'S THAT MAY HAVE BEEN QUEUED                     03120000
                                                                        03130000
         L     RMDE,MDENEXT          ADDRESS OF NEXT MDE                03140000
                                                                        03150000
MDELOOP  DS    0H                                                       03160000
                                                                        03170000
         LTR   RMDE,RMDE             IS THERE ANOTHER MDE?              03180000
         BM    RETURN                IF NOT...WE ARE DONE               03190000
                                                                        03200000
AQELOOP  DS    0H                                                       03210000
                                                                        03220000
         ICM   RAQE,15,MDEWR1ST      ADDRESS OF FIRST AQE               03230000
         BM    MDEFREE               BRANCH IF AQE'S EXHAUSTED          03240000
         LM    R14,R15,AQENEXT       R14=NEXT AQE R15=PREVIOUS AQE      03250000
         ST    R14,AQENEXT-AQE(,R15) LINK NEXT TO PREVIOUS              03260000
         ST    R15,AQEPREV-AQE(,R14) LINK PREVIOUS TO NEXT              03270000
         LA    R0,4                  POSTCODE = FAILURE                 03280000
         BAS   R14,POSTREQ           POST THE REQUEST                   03290000
         BAS   R14,FREEAQE           RELEASE THE QUEUE ELEMENT          03300000
         B     AQELOOP               POST ALL PENDING AQE'S             03310000
                                                                        03320000
MDEFREE  DS    0H                                                       03330000
                                                                        03340000
         LM    R14,R15,MDENEXT       R14=FOLLOWING MDE R15=PREVIOUS MDE 03350000
         ST    R14,MDENEXT-MDE(,R15) POINT PREVIOUS MDE AT FOLLOWING    03360000
         ST    R15,MDEPREV-MDE(,R14) POINT FOLLOWING MDE AT PREVIOUS    03370000
         LR    R2,RMDE               SAVE ADDRESS OF CURRENT MDE        03380000
         LR    RMDE,R14              ADDRESS OF NEXT MDE                03390000
                                                                        03400000
         $RETSTOR (R2),                                                +03410000
               OWNER=(RITASK)        RELEASE THE CURRENT MDE            03420000
                                                                        03430000
         B     MDELOOP               AND CHECK FOR ANOTHER MDE          03440000
                                                                        03450000
*                                                                       03460000
* A REAL MODE FAILED TO ACTIVE.                                         03470000
* - POST THE PENDING REQUEST.                                           03480000
* - RELEASE THE AQE.                                                    03490000
*---------------------------------------------------------------------- 03500000
                                                                        03510000
FAILREAL DS    0H                                                       03520000
                                                                        03530000
         LA    R0,4               POSTCODE = FAILURE                    03540000
         BAS   R14,POSTREQ        POST THE REQUEST                      03550000
         BAS   R14,FREEAQE        RELEASE THE QUEUE ELEMENT             03560000
         L     R15,IL6@USUC       STOP USER CHECK ROUTINE               03570000
         BASR  R14,R15            LINK TO ROUTINE                       03580000
         B     RETURN                                                   03590000
                                                                        03600000
*---------------------------------------------------------------------- 03610000
* RETURN TO CALLER                                                      03620000
*---------------------------------------------------------------------- 03630000
                                                                        03640000
RETURN   DS    0H                                                       03650000
                                                                        03660000
         BAS   R14,VTAMUNLK       SERIALIZE                             03670000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 03680000
                                                                        03690000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    03700000
                                                                        03710000
*---------------------------------------------------------------------- 03720000
* SUBROUTINE QWE - QUEUE A WORK ELEMENT TO A GIVEN WORK QUEUE           03730000
*                                                                       03740000
* ENTRY            R14 = RETURN ADDRESS                                 03750000
*                  R1  = WORK ELEMENT ADDRESS                           03760000
*                  R0  = QUEUE ADDRESS                                  03770000
*                                                                       03780000
* RETURNS          R15 = 0 --> QUEUEING WAS SUCCESSFUL                  03790000
*                      = 4 --> QUEUEING FAILED, WORK ELEMENT RELEASED   03800000
*---------------------------------------------------------------------- 03810000
                                                                        03820000
QWE      DS    0H                                                       03830000
                                                                        03840000
         STM   R14,R4,SUB0SAVE    SAVE REGISTERS                        03850000
         LR    R3,R0              SAVE QUEUE ADDRESS                    03860000
         LR    R4,R1              SAVE WORK ELEMENT ADDRESS             03870000
                                                                        03880000
         $VTAMQ (R4),             WORK ELEMENT                         +03890000
               (R3)               QUEUE                                 03900000
                                                                        03910000
         L     R14,SUB0SAVE       RESTORE REGISTERS                     03920000
         LM    R0,R4,SUB0SAVE+8   RESTORE REGISTERS                     03930000
         BR    R14                AND RETURN TO CALLER W/R15            03940000
                                                                        03950000
*---------------------------------------------------------------------- 03960000
*   SUBROUTINE: POST THE REQUEST (R0 CONTAINS POSTCODE)                 03970000
*---------------------------------------------------------------------- 03980000
                                                                        03990000
POSTREQ  DS    0H                                                       04000000
                                                                        04010000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             04020000
                                                                        04030000
         L62POST *AQEEPB,         ADDRESS OF EPB TO BE POSTED          +04040000
               SUB0SAVE+8,        ADDRESS OF POST CODE                 +04050000
               AQEENT,            ADDRESS OF ENTITY TOKEN              +04060000
               L62RETRC,          RETURN CODE AREA                     +04070000
               MF=(E,L62MFL)                                            04080000
                                                                        04090000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          04100000
         BR    R14                  RETURN                              04110000
                                                                        04120000
*---------------------------------------------------------------------- 04130000
*   SUBROUTINE: FREE THE AQE                                            04140000
*---------------------------------------------------------------------- 04150000
                                                                        04160000
FREEAQE  DS    0H                                                       04170000
                                                                        04180000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             04190000
                                                                        04200000
         $RETSTOR (RAQE),                                              +04210000
               OWNER=(RITASK)                                           04220000
                                                                        04230000
         SR    RAQE,RAQE            SHOW NO AQE                         04240000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          04250000
         BR    R14                  RETURN                              04260000
                                                                        04270000
*---------------------------------------------------------------------- 04280000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 04290000
*---------------------------------------------------------------------- 04300000
                                                                        04310000
VTAMLOCK DS    0H                                                       04320000
                                                                        04330000
         TM    FLAG,FLAGLOCK        WAS THE LOCK ALREADY OBTAINED?      04340000
         BOR   R14                  RETURN IF YES                       04350000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             04360000
                                                                        04370000
         $SER  OBTAIN,                                                 +04380000
               VTAM                                                     04390000
                                                                        04400000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              04410000
         BNE   VTAMLOEX             BRANCH IF NOT                       04420000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         04430000
                                                                        04440000
VTAMLOEX DS    0H                                                       04450000
                                                                        04460000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               04470000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          04480000
         BR    R14                  RETURN                              04490000
                                                                        04500000
*---------------------------------------------------------------------- 04510000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                04520000
*---------------------------------------------------------------------- 04530000
                                                                        04540000
VTAMUNLK DS    0H                                                       04550000
                                                                        04560000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       04570000
         BNOR  R14                  BRANCH IF NOT                       04580000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             04590000
         BOR   R14                  DON'T RELEASE IF IT WAS             04600000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             04610000
                                                                        04620000
         $SER  RELEASE,                                                +04630000
               VTAM                                                     04640000
                                                                        04650000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  04660000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          04670000
         BR    R14                  RETURN                              04680000
                                                                        04690000
*---------------------------------------------------------------------- 04700000
*   SUBROUTINE: OBTAIN DISP GLOBAL LOCK                                 04710000
*---------------------------------------------------------------------- 04720000
                                                                        04730000
DISPLOCK DS    0H                                                       04740000
                                                                        04750000
         TM    FLAG,FLAGDLCK        WAS THE LOCK ALREADY OBTAINED?      04760000
         BOR   R14                  RETURN IF YES                       04770000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             04780000
                                                                        04790000
         $SER  OBTAIN,                                                 +04800000
               DISP                                                     04810000
                                                                        04820000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              04830000
         BNE   DISPLOEX             BRANCH IF NOT                       04840000
         OI    FLAG,FLAGDLKD        REMEMBER LOCK HELD ON ENTRY         04850000
                                                                        04860000
DISPLOEX DS    0H                                                       04870000
                                                                        04880000
         OI    FLAG,FLAGDLCK        REMEMBER LOCK IS HELD               04890000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          04900000
         BR    R14                  RETURN                              04910000
                                                                        04920000
*---------------------------------------------------------------------- 04930000
*   SUBROUTINE: RELEASE DISP GLOBAL LOCK                                04940000
*---------------------------------------------------------------------- 04950000
                                                                        04960000
DISPUNLK DS    0H                                                       04970000
                                                                        04980000
         TM    FLAG,FLAGDLCK        IS LOCK HELD?                       04990000
         BNOR  R14                  BRANCH IF NOT                       05000000
         TM    FLAG,FLAGDLKD        WAS LOCK HELD ON ENTRY?             05010000
         BOR   R14                  DON'T RELEASE IF IT WAS             05020000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             05030000
                                                                        05040000
         $SER  RELEASE,                                                +05050000
               DISP                                                     05060000
                                                                        05070000
         NI    FLAG,255-FLAGDLCK    SHOW LOCK NOT HELD                  05080000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          05090000
         BR    R14                  RETURN                              05100000
                                                                        05110000
*---------------------------------------------------------------------- 05120000
* ERROR ROUTINES                                                        05130000
*---------------------------------------------------------------------- 05140000
                                                                        05150000
ERRENVIR DS    0H                                                       05160000
                                                                        05170000
         $ABEND ABE_VTDIAG,                                            +05180000
               SCOPE=PCB,                                              +05190000
               TITLE='ENVIRONMENT ERROR'                                05200000
                                                                        05210000
*---------------------------------------------------------------------- 05220000
*  CONSTANTS AND LITERALS                                               05230000
*---------------------------------------------------------------------- 05240000
                                                                        05250000
         LTORG ,                                                        05260000
         PRINT NOGEN                                                    05270000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                05280000
         ISTDBIND ,               VTAM BIND IMAGE                       05290000
         TRACODES ,               INTEGRATOR TRACE CODES                05300000
         ICVT  ,                  INTEGRATOR CVT                        05310000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   05320000
         IRPL ,                   INTEGRATOR VTAM RPL+                  05330000
         IACB ,                   INTEGRATOR VTAM ACB+                  05340000
         INIB ,                   INTEGRATOR VTAM NIB+                  05350000
         ISESS ,                  INTEGRATOR SESSION BLOCK              05360000
         IRQE ,                   INTEGRATOR RECEIVE QUEUE ELEMENT      05370000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            05380000
         ITASK ,                  INTEGRATOR TASK BLOCK                 05390000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          05400000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       05410000
         EVCODES ,                INTEGRATOR EVENT CODES                05420000
         ABCODES ,                INTEGRATOR $ABEND CODES               05430000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     05440000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        05450000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             05460000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             05470000
         $WULOC DSECT=YES         INTEGRATOR $WULOC SERVICES            05480000
         IFGEXLST ,               VTAM EXIT LIST                        05490000
         END   ,                                                        05500000

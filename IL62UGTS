IL62UGTS TITLE 'INTEGRATOR - IVUSER GET SESSION WE PROCESSOR'           00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C SERVICES             00040000
         L62INCL ,                INTEGRATOR LU6.2 SERVICES             00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: IL62UGTS - IVUSER GET SESSION WORK ELEMENT PROCESSOR         00100000
*                                                                       00110000
* DESCRIPTION:                                                          00120000
*                                                                       00130000
* ON ENTRY:                                                             00140000
*                                                                       00150000
*    R15 = ENTRY POINT ADDRESS                                          00160000
*    R14 = RETURN ADDRESS                                               00170000
*    R13 = AVAILABLE SAVE AREA                                          00180000
*    R11 = ICVT ADDRESS                                                 00190000
*    R10 = ITASK ADDRESS                                                00200000
*    R09 = IVTAMCVT ADDRESS                                             00210000
*    R08 = IVUSER ADDRESS                                               00220000
*    R01 = ADDRESS OF GET SESSION WORK ELEMENT (IWE)                    00230000
*                                                                       00240000
* ON EXIT:                                                              00250000
*                                                                       00260000
*    R15 = 0                                                            00270000
*    R00 = 0                                                            00280000
*    R01 = 0                                                            00290000
*                                                                       00300000
*    ALL OTHER REGISTERS ARE RESTORED.                                  00310000
*                                                                       00320000
**<DOC-OFF>************************************************************ 00330000
                                                                        00340000
         EJECT ,                                                        00350000
*********************************************************************** 00360000
*                                                                       00370000
* MAINTENANCE:                                                          00380000
*                                                                       00390000
*   07/01/94 RANDY WITEK                                                00400000
*                                                                       00410000
*********************************************************************** 00420000
                                                                        00430000
         EQUS  ,                  GENERAL EQUATES                       00440000
                                                                        00450000
RICVT    EQU   R11                                                      00460000
RITASK   EQU   R10                                                      00470000
RIVTAM   EQU   R9                                                       00480000
RIVUSER  EQU   R8                                                       00490000
RAQE     EQU   R7                                                       00500000
RMDE     EQU   R6                                                       00510000
RISESS   EQU   R5                                                       00520000
                                                                        00530000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00540000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00550000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00560000
         USING IVUSER,RIVUSER     ESTABLISH ADDRESSABILITY              00570000
         USING AQE,RAQE           ESTABLISH ADDRESSABILITY              00580000
         USING MDE,RMDE           ESTABLISH ADDRESSABILITY              00590000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00600000
         USING ISTDBIND,ISEBIND   ESTABLISH ADDRESSABILITY              00610000
                                                                        00620000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00630000
WRK256   DS    XL256              GENERAL WORKAREA                      00640000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00650000
L62MFL   L62DFMD MF=L             PLIST CONSTRUCTION                    00660000
$WUMFL   $WULOC MF=L              PLIST CONSTRUCTION                    00670000
WUDATA   DS    XL16               WULOC RETURN AREA                     00680000
L62RETMD DS    F                  LU6.2 MDE         RETURN AREA         00690000
L62RETCD DS    F                  LU6.2 RETURN CODE RETURN AREA         00700000
MDESVCMG DS    A                  TEMPORARY SAVE FOR SNASVCMG MDE       00710000
RETR15   DS    F                                                        00720000
RETR0    DS    F                                                        00730000
RETR1    DS    F                                                        00740000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00750000
FLAG     DS    X                                                        00760000
FLAGLOCK EQU   X'80'                                                    00770000
FLAGLCKD EQU   X'40'                                                    00780000
FLAGDLCK EQU   X'20'              DISP LOCK HELD                        00790000
FLAGDLKD EQU   X'10'              DISP LOCK HELD ON ENTRY               00800000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00810000
                                                                        00820000
         $MSGDFT PREFIX=ICTPID,                                        +00830000
               COMPID='L62',                                           +00840000
               TABLE=*#MSGS,                                           +00850000
               WORKA=0,                                                +00860000
               MF=(E,WRK256),                                          +00870000
               PRINT=NOGEN                                              00880000
                                                                        00890000
IL62UGTS #ENTER BASE=R12,         ENTRY LINKAGE                        +00900000
               PREG=R3,                                                +00910000
               AMODE=31,                                               +00920000
               RMODE=ANY                                                00930000
                                                                        00940000
*---------------------------------------------------------------------- 00950000
* CREATE AN ALLOCATE QUEUE ELEMENT FOR THIS REQUEST                     00960000
*---------------------------------------------------------------------- 00970000
                                                                        00980000
         $GETSTOR L'AQEMAX,                                            +00990000
               LOC=ANY,                                                +01000000
               OWNER=(RITASK)                                           01010000
                                                                        01020000
         LR    RAQE,R1                  REFERENCE TO BLOCK              01030000
         MVC   AQEID,=CL8'AQE'          SET EYECATCHER                  01040000
         MVC   AQELEN,=A(L'AQEMAX)      SET THE LENGTH                  01050000
                                                                        01060000
         USING IWEVTAM,R3               ESTABLISH ADDRESSABILITY        01070000
         MVC   AQEENT,IWEXRENT          COPY IWE INFO TO AQE            01080000
         MVC   AQEEPB,IWEXREPB          COPY IWE INFO TO AQE            01090000
         MVC   AQETKB,IWEXRTKB          COPY IWE INFO TO AQE            01100000
         MVC   AQERCB,IWEXRRCB          COPY IWE INFO TO AQE            01110000
         MVC   AQELLU,IWEXRLLU          COPY IWE INFO TO AQE            01120000
         MVC   AQEPLU,IWEXRPLU          COPY IWE INFO TO AQE            01130000
         MVC   AQEPLL,IWEXRPLL          COPY IWE INFO TO AQE            01140000
         MVC   AQEMODE,IWEXRMDE         COPY IWE INFO TO AQE            01150000
         MVC   AQEMODEL,IWEXRMDL        COPY IWE INFO TO AQE            01160000
         MVC   AQERCT,IWEXRRCT          COPY IWE INFO TO AQE            01170000
         MVC   AQESYN,IWEXRSYN          COPY IWE INFO TO AQE            01180000
         MVC   AQESEC,IWEXRSEC          COPY IWE INFO TO AQE            01190000
         DROP  R3                                                       01200000
                                                                        01210000
*---------------------------------------------------------------------- 01220000
* NO ALLOCATES DURING SYSTEM/TASK TERMINATION                           01230000
* NO ALLOCATES IF MAIN LU6.2 ACB IS NOW UNUSABLE                        01240000
*---------------------------------------------------------------------- 01250000
                                                                        01260000
         TM    ICTSTAT3,ICT3$P+ICT3$PX                                  01270000
         BNZ   ERRPOST            BRANCH IF SYSTEM TERMINATING          01280000
         TM    IVTF1,IVTF1TRM                                           01290000
         BO    ERRPOST            BRANCH IF VTAM MAIN TASK TERMINATING  01300000
                                                                        01310000
X        USING IACB,R1                                                  01320000
         ICM   R1,15,IVTACB62     MAIN LU6.2 ACB ADDRESS                01330000
         BNP   ERRPOST            BRANCH IF NONE                        01340000
         TM    X.IACF1,IACF1TPN+IACF1CLS+IACF1QUI+IACF1TRM+IACF1UNU     01350000
         BNZ   ERRPOST            BRANCH IF ACB IS UNUSABLE             01360000
         TM    X.IACF1,IACF1OPN                                         01370000
         BNO   ERRPOST            BRANCH IF ACB IS NOT OPEN             01380000
         DROP  X                                                        01390000
                                                                        01400000
*---------------------------------------------------------------------- 01410000
* LOCATE/CREATE THE REQUESTED MODE                                      01420000
*---------------------------------------------------------------------- 01430000
                                                                        01440000
         BAS   R14,VTAMLOCK       SERIALIZE                             01450000
                                                                        01460000
         L62DSMD (RIVUSER),       PARTNER_LU ADDRESS                   +01470000
               AQEMODE,           MODE NAME ADDRESS                    +01480000
               AQEMODEL,          MODE NAME LENGTH ADDRESS             +01490000
               L62RETMD,          MDE ADDRESS RETURN AREA              +01500000
               L62RETCD,          RETURN CODE AREA                     +01510000
               MF=(E,L62MFL)                                            01520000
                                                                        01530000
         CLC   L62RETCD,=A(LU62_OK)                                     01540000
         BE    OLDMODE            BRANCH IF MODE NAME FOUND             01550000
         CLC   L62RETCD,=A(LU62_RESOURCE_NOT_FOUND)                     01560000
         BE    NEWMODE            BRANCH IF WE SHOULD CREATE ONE        01570000
         B     ERRPOST            KILL REQUEST FOR OTHER RETURN CODES   01580000
                                                                        01590000
*---------------------------------------------------------------------- 01600000
* A EXISTING MDE WAS FOUND.  TRY TO FIND AN AVAILABLE SESSION.          01610000
*---------------------------------------------------------------------- 01620000
                                                                        01630000
OLDMODE  DS    0H                                                       01640000
                                                                        01650000
         ICM   RMDE,15,L62RETMD   RETURNED MDE                          01660000
         BNP   ERRPOST            BRANCH IF DOESN'T LOOK GOOD           01670000
         ST    RMDE,AQEMDE        SET MDE POINTER IN THE AQE            01680000
                                                                        01690000
*                                                                       01700000
* IF THE MDE IS NOT ACTIVE YET, QUEUE THE REQUEST UNTIL IT IS.          01710000
*---------------------------------------------------------------------- 01720000
                                                                        01730000
         TM    MDEF1,MDEF1STO          ARE TRANSACTIONS STOPPED?        01740000
         BO    ERRPOST                 BRANCH IF YES                    01750000
         TM    MDEF1,MDEF1CNI+MDEF1WSS NEGOTIATION OR ACTIVATION?       01760000
         BZ    OLDSTART                BRANCH IF NOT                    01770000
         BAS   R14,AQETOMDE            QUEUE THE REQUEST TO THE MDE     01780000
         B     RETURN                  AND RETURN                       01790000
                                                                        01800000
*                                                                       01810000
* THE MODE IS ACTIVE.                                                   01820000
* IF THERE IS NO FREE SESSION, TRY TO START ONE.                        01830000
*---------------------------------------------------------------------- 01840000
                                                                        01850000
OLDSTART DS    0H                                                       01860000
                                                                        01870000
         LA    RISESS,MDEFS1ST    SET TO RUN FREE SESSION CHAIN         01880000
         S     RISESS,=A(ISE62FSN-ISESS)                                01890000
                                                                        01900000
OLDLOOP  DS    0H                                                       01910000
                                                                        01920000
         ICM   RISESS,15,ISE62FSN IS THERE A FREE SESSION?              01930000
         BNP   OLDNONE            BRANCH IF NOT, TRY TO START           01940000
         TM    ISE62FL1,ISE62AEX  IS AN ATTACH EXPECTED?                01950000
         BO    OLDLOOP            BRANCH IF YES                         01960000
         TM    ISE62FL2,ISE62BID  IS A BID SEQUENCE IN PROGRESS?        01970000
         BO    OLDLOOP            BRANCH IF YES                         01980000
         TM    ISE62FL3,ISE62TRM  IS SESSION PENDING TERMINATION?       01990000
         BO    OLDLOOP            BRANCH IF YES                         02000000
         TM    ISEF1,ISEF1TRM     IS SESSION TERMINATING?               02010000
         BO    OLDLOOP            BRANCH IF YES                         02020000
         B     OLDFREE            BRANCH IF YES, USE IT                 02030000
                                                                        02040000
OLDNONE  DS    0H                                                       02050000
                                                                        02060000
         LR    R1,RAQE            PASS AQE IN R1                        02070000
         L     R15,IL6@USTS       START SESSION ROUTINE                 02080000
         BASR  R14,R15            TRY TO START ONE                      02090000
         BAS   R14,AQETOMDE       QUEUE THE REQUEST...EITHER A SESSION  02100000
*                                 REQUEST WAS ISSUED AND WE MUST WAIT   02110000
*                                 OR WE MUST JUST WAIT FOR A FREE SESS. 02120000
         B     RETURN             AND RETURN                            02130000
                                                                        02140000
*                                                                       02150000
* THERE IS A FREE SESSION.                                              02160000
* IF IT IS A CONWINNER SESSION TAKE IT.                                 02170000
*---------------------------------------------------------------------- 02180000
                                                                        02190000
OLDFREE  DS    0H                                                       02200000
                                                                        02210000
         TM    BINCMNP2,BINBKFS   IS THIS A CONWINNER?                  02220000
         BNO   OLDBID             BRANCH IF NOT                         02230000
                                                                        02240000
         LM    R14,R15,ISE62FSN         DEQUEUE SESSION FROM FREE QUEUE 02250000
         ST    R14,ISE62FSN-ISESS(,R15) LINK NEXT TO PREV               02260000
         ST    R15,ISE62FSP-ISESS(,R14) LINK PREV TO NEXT               02270000
         XC    ISE62FSN,ISE62FSN        NO LONGER ON QUEUE              02280000
         XC    ISE62FSP,ISE62FSP        NO LONGER ON QUEUE              02290000
                                                                        02300000
         BAS   R14,DISPLOCK       SERIALIZE                             02310000
                                                                        02320000
         $WULOC LOCATE,           FIND THE WORK UNIT                   +02330000
               TOKEN=AQEENT,      WORK UNIT TOKEN ADDRESS              +02340000
               USERDATA=WUDATA,   XL16 AREA TO RECEIVE USER DATA       +02350000
               MF=(E,$WUMFL)      VALIDATE WORK UNIT                    02360000
                                                                        02370000
         LTR   R15,R15            LOCATE SUCCESS?                       02380000
         BNZ   OLDFGONE           BRANCH IF NOT, REQUESTOR IS GONE      02390000
         L     R4,AQERCB          ASSOCIATED RCB ADDRESS SHOULD BE OK   02400000
                                                                        02410000
X        USING RCB,R4                                                   02420000
         MVC   X.RCBHSID,ISETK    SET SESSION TOKEN IN RCB              02430000
         MVC   ISE62ENT,X.RCBENT  ASSOCIATED WORK UNIT TOKEN            02440000
         ST    R4,ISE62RCB        LINK ISESS TO RCB                     02450000
         DROP  X                                                        02460000
                                                                        02470000
OLDFPOST DS    0H                                                       02480000
                                                                        02490000
         SR    R0,R0              POSTCODE = SUCCESS                    02500000
         BAS   R14,POSTREQ        POST THE REQUEST                      02510000
         BAS   R14,DISPUNLK       DESERIALIZE                           02520000
         BAS   R14,FREEAQE        RELEASE THE QUEUE ELEMENT             02530000
         B     RETURN                                                   02540000
                                                                        02550000
OLDFGONE DS    0H                                                       02560000
                                                                        02570000
         LA    R0,4               POSTCODE = FAILURE                    02580000
         BAS   R14,POSTREQ        CALL POST TO ISSUE ERROR MESSAGE      02590000
         BAS   R14,DISPUNLK       DESERIALIZE                           02600000
         BAS   R14,FREEAQE        RELEASE THE QUEUE ELEMENT             02610000
                                                                        02620000
         $VTAMWE L'IWEY4,         SIZE                                 +02630000
               IWECFRES           FREE SESSION WORK ELEMENT             02640000
                                                                        02650000
Z        USING IWEVTAM,R1                                               02660000
         ST    RMDE,Z.IWEY4MDE    PASS MDE ADDRESS                      02670000
         MVC   Z.IWEY4NME,MDENAME PASS MODE NAME                        02680000
         MVC   Z.IWEY4TKN,ISETK   PASS SESSION TOKEN                    02690000
         DROP  Z                                                        02700000
                                                                        02710000
         LA    R0,IVUWEQ          QUEUE ADDRESS                         02720000
         BAS   R14,QWE            QUEUE WORK ELEMENT                    02730000
         B     RETURN                                                   02740000
                                                                        02750000
*                                                                       02760000
* THERE IS A FREE BIDDER SESSION.                                       02770000
* SEND A BID AND WAIT FOR THE BID RESPONSE.                             02780000
*---------------------------------------------------------------------- 02790000
                                                                        02800000
OLDBID   DS    0H                                                       02810000
                                                                        02820000
         OI    ISE62FL2,ISE62BID  SHOW BID SEQUENCE IN PROGRESS         02830000
         MVC   AQE$STKN,ISETK     SET SESSION TOKEN IN AQE              02840000
                                                                        02850000
         $VTAMWE L'IWEY5,         LENGTH                               +02860000
               IWECBID            CODE                                  02870000
                                                                        02880000
X        USING IWEVTAM,R1                                               02890000
         ST    RAQE,X.IWEY5AQE    PASS THE AQE ADDRESS                  02900000
         DROP  X                                                        02910000
                                                                        02920000
         LA    R0,ISEWEQ          QUEUE ADDRESS                         02930000
         BAS   R14,QWE            QUEUE THE WORK ELEMENT                02940000
         LTR   R15,R15            SUCCESSFUL QUEUEING?                  02950000
         BZ    RETURN             EXIT IF YES                           02960000
         EX    0,*                HALT HERE                             02970000
                                                                        02980000
*---------------------------------------------------------------------- 02990000
* A NEW MODE MUST BE CREATED.                                           03000000
*---------------------------------------------------------------------- 03010000
                                                                        03020000
NEWMODE  DS    0H                                                       03030000
                                                                        03040000
*                                                                       03050000
* IF THIS IS THE VERY FIRST MDE, CREATE SNASVCMG FIRST.                 03060000
*---------------------------------------------------------------------- 03070000
                                                                        03080000
         ICM   R1,15,IVUMD1ST     IS THIS THE FIRST MDE?                03090000
         BP    NEWNOT1            BRANCH IF NOT                         03100000
                                                                        03110000
         L62DFMD (RIVUSER),       PARTNER_LU ADDRESS                   +03120000
               =CL8'SNASVCMG',    MODE NAME ADDRESS                    +03130000
               =F'8',             MODE NAME LENGTH ADDRESS             +03140000
               L62RETMD,          MDE ADDRESS RETURN AREA              +03150000
               L62RETCD,          RETURN CODE AREA                     +03160000
               MF=(E,L62MFL)                                            03170000
                                                                        03180000
         OC    L62RETCD,L62RETCD  GOOD RETURN CODE?                     03190000
         BNZ   ERRPOST            BRANCH IF DEFINITION FAILED           03200000
         MVC   MDESVCMG,L62RETMD  SAVE THE MDE ADDRESS                  03210000
                                                                        03220000
*                                                                       03230000
* NOW CREATE THE MDE FOR THE USER REQUESTED MODE AND QUEUE THE REQUEST  03240000
*---------------------------------------------------------------------- 03250000
                                                                        03260000
         L62DFMD (RIVUSER),       PARTNER_LU ADDRESS                   +03270000
               AQEMODE,           MODE NAME ADDRESS                    +03280000
               AQEMODEL,          MODE NAME LENGTH ADDRESS             +03290000
               L62RETMD,          MDE ADDRESS RETURN AREA              +03300000
               L62RETCD,          RETURN CODE AREA                     +03310000
               MF=(E,L62MFL)                                            03320000
                                                                        03330000
         OC    L62RETCD,L62RETCD  GOOD RETURN CODE?                     03340000
         BNZ   ERRPOST            BRANCH IF REQUESTED MODE DEF. FAILED  03350000
         ICM   RMDE,15,L62RETMD   RETURNED MDE                          03360000
         BNP   ERRPOST            BRANCH IF DOESN'T LOOK GOOD           03370000
         OI    MDEF1,MDEF1WSS     MDE IS WAITING FOR SNASVCMG TO START  03380000
         BAS   R14,AQETOMDE       QUEUE THE USER REQUEST TO MDE         03390000
                                                                        03400000
*                                                                       03410000
* CREATE A DUMMY ALLOCATE QUEUE ELEMENT FOR AN SNASVCMG REQUEST         03420000
*---------------------------------------------------------------------- 03430000
                                                                        03440000
         LR    R4,RAQE            SAVE USER REQUEST'S AQE               03450000
                                                                        03460000
X        USING AQE,R4             TEMPORARY REFERENCE                   03470000
                                                                        03480000
         $GETSTOR L'AQEMAX,                                            +03490000
               LOC=ANY,                                                +03500000
               OWNER=(RITASK)                                           03510000
                                                                        03520000
         LR    RAQE,R1                  REFERENCE TO BLOCK              03530000
         MVC   AQEID,=CL8'AQE'          SET EYECATCHER                  03540000
         MVC   AQELEN,=A(L'AQEMAX)      SET THE LENGTH                  03550000
                                                                        03560000
         MVC   AQELLU,X.AQELLU                                          03570000
         MVC   AQEPLU,X.AQEPLU                                          03580000
         MVC   AQEPLL,X.AQEPLL                                          03590000
         MVC   AQEMODE,=CL8'SNASVCMG'                                   03600000
         MVC   AQEMODEL,=F'8'                                           03610000
                                                                        03620000
         DROP  X                                                        03630000
                                                                        03640000
*                                                                       03650000
* TRY TO START THE SNASVCMG SESSION                                     03660000
*---------------------------------------------------------------------- 03670000
                                                                        03680000
         L     RMDE,MDESVCMG      NOW USING SNASVCMG MDE                03690000
         BAS   R14,AQETOMDE       QUEUE THE REQUEST                     03700000
         LR    R1,RAQE            PASS AQE IN R1                        03710000
         L     R15,IL6@USTS       START SESSION ROUTINE                 03720000
         BASR  R14,R15            TRY TO START ONE                      03730000
         B     RETURN             AND RETURN                            03740000
                                                                        03750000
*                                                                       03760000
* THIS IS NOT THE FIRST MDE.  IF WE ARE NOT PARALLEL, DON'T ALLOW IT.   03770000
*---------------------------------------------------------------------- 03780000
                                                                        03790000
NEWNOT1  DS    0H                                                       03800000
                                                                        03810000
         TM    IVUF1,IVUF1PSC     ARE WE PARALLEL SESSION CAPABLE?      03820000
         BNO   ERRPOST            BRANCH IF NOT                         03830000
                                                                        03840000
*                                                                       03850000
* CREATE AN MDE FOR THE USER REQUESTED MODE AND QUEUE THE REQUEST       03860000
*---------------------------------------------------------------------- 03870000
                                                                        03880000
         L62DFMD (RIVUSER),       PARTNER_LU ADDRESS                   +03890000
               AQEMODE,           MODE NAME ADDRESS                    +03900000
               AQEMODEL,          MODE NAME LENGTH ADDRESS             +03910000
               L62RETMD,          MDE ADDRESS RETURN AREA              +03920000
               L62RETCD,          RETURN CODE AREA                     +03930000
               MF=(E,L62MFL)                                            03940000
                                                                        03950000
         OC    L62RETCD,L62RETCD  GOOD RETURN CODE?                     03960000
         BNZ   ERRPOST            BRANCH IF REQUESTED MODE DEF. FAILED  03970000
         ICM   RMDE,15,L62RETMD   RETURNED MDE                          03980000
         BNP   ERRPOST            BRANCH IF DOESN'T LOOK GOOD           03990000
         BAS   R14,AQETOMDE       QUEUE THE USER REQUEST TO MDE         04000000
                                                                        04010000
*                                                                       04020000
* INITIALIZE SESSION LIMITS FOR NEW MODE.                               04030000
*---------------------------------------------------------------------- 04040000
                                                                        04050000
         NI    MDEF1,255-MDEF1WSS ENSURE WAITING FLAG IS OFF            04060000
                                                                        04070000
         L62ISL *IVTACB62,        IACB ADDRESS                         +04080000
               IVULOCAL,          PARTNER LUNAME                       +04090000
               MDENAME,           MODE NAME                            +04100000
               =F'8',             SESSION LIMIT                        +04110000
               =F'4',             MINIMUM CONWINNERS                   +04120000
               =F'4',             MINIMUM CONLOSERS                    +04130000
               L62RETCD,          RETURN CODE AREA                     +04140000
               MF=(E,L62MFL)                                            04150000
                                                                        04160000
         B     RETURN             IGNORE RETURN CODE                    04170000
                                                                        04180000
*---------------------------------------------------------------------- 04190000
* POST THE REQUESTOR                                                    04200000
*---------------------------------------------------------------------- 04210000
                                                                        04220000
ERRPOST  DS    0H                                                       04230000
                                                                        04240000
         LA    R0,4               SET ERROR POST CODE                   04250000
         BAS   R14,POSTREQ        POST THE REQUEST                      04260000
         BAS   R14,FREEAQE        RELEASE THE QUEUE ELEMENT             04270000
         B     RETURN                                                   04280000
                                                                        04290000
*---------------------------------------------------------------------- 04300000
* RETURN TO IVUSER MAINLINE                                             04310000
*---------------------------------------------------------------------- 04320000
                                                                        04330000
RETURN   DS    0H                                                       04340000
                                                                        04350000
         BAS   R14,VTAMUNLK                                             04360000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 04370000
                                                                        04380000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    04390000
                                                                        04400000
*---------------------------------------------------------------------- 04410000
* SUBROUTINE QWE - QUEUE A WORK ELEMENT TO A GIVEN WORK QUEUE           04420000
*                                                                       04430000
* ENTRY            R14 = RETURN ADDRESS                                 04440000
*                  R1  = WORK ELEMENT ADDRESS                           04450000
*                  R0  = QUEUE ADDRESS                                  04460000
*                                                                       04470000
* RETURNS          R15 = 0 --> QUEUEING WAS SUCCESSFUL                  04480000
*                      = 4 --> QUEUEING FAILED, WORK ELEMENT RELEASED   04490000
*---------------------------------------------------------------------- 04500000
                                                                        04510000
QWE      DS    0H                                                       04520000
                                                                        04530000
         STM   R14,R4,SUB0SAVE    SAVE REGISTERS                        04540000
         LR    R3,R0              SAVE QUEUE ADDRESS                    04550000
         LR    R4,R1              SAVE WORK ELEMENT ADDRESS             04560000
                                                                        04570000
         $VTAMQ (R4),             WORK ELEMENT                         +04580000
               (R3)               QUEUE                                 04590000
                                                                        04600000
         L     R14,SUB0SAVE       RESTORE REGISTERS                     04610000
         LM    R0,R4,SUB0SAVE+8   RESTORE REGISTERS                     04620000
         BR    R14                AND RETURN TO CALLER W/R15            04630000
                                                                        04640000
*---------------------------------------------------------------------- 04650000
*   SUBROUTINE: QUEUE THE AQE TO THE MDE                                04660000
*---------------------------------------------------------------------- 04670000
                                                                        04680000
AQETOMDE DS    0H                                                       04690000
                                                                        04700000
         STM   R14,R15,SUB0SAVE       SAVE CALLER'S REGISTERS           04710000
                                                                        04720000
         L     R15,MDEWRLST           TAIL OF WAITING-REQUESTS QUEUE    04730000
         L     R14,AQENEXT-AQE(,R15)                                    04740000
         STM   R14,R15,AQENEXT        LINK NEW AQE TO END OF QUEUE      04750000
         ST    RAQE,AQEPREV-AQE(,R14)                                   04760000
         ST    RAQE,AQENEXT-AQE(,R15)                                   04770000
         ST    RMDE,AQEMDE            SET MDE POINTER                   04780000
                                                                        04790000
         LM    R14,R15,SUB0SAVE       RESTORE CALLER'S REGISTERS        04800000
         BR    R14                    RETURN                            04810000
                                                                        04820000
*---------------------------------------------------------------------- 04830000
*   SUBROUTINE: FREE THE AQE                                            04840000
*---------------------------------------------------------------------- 04850000
                                                                        04860000
FREEAQE  DS    0H                                                       04870000
                                                                        04880000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             04890000
                                                                        04900000
         $RETSTOR (RAQE),                                              +04910000
               OWNER=(RITASK)                                           04920000
                                                                        04930000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          04940000
         BR    R14                  RETURN                              04950000
                                                                        04960000
*---------------------------------------------------------------------- 04970000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 04980000
*---------------------------------------------------------------------- 04990000
                                                                        05000000
VTAMLOCK DS    0H                                                       05010000
                                                                        05020000
         TM    FLAG,FLAGLOCK        WAS THE LOCK ALREADY OBTAINED?      05030000
         BOR   R14                  RETURN IF YES                       05040000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             05050000
                                                                        05060000
         $SER  OBTAIN,                                                 +05070000
               VTAM                                                     05080000
                                                                        05090000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              05100000
         BNE   VTAMLOEX             BRANCH IF NOT                       05110000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         05120000
                                                                        05130000
VTAMLOEX DS    0H                                                       05140000
                                                                        05150000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               05160000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          05170000
         BR    R14                  RETURN                              05180000
                                                                        05190000
*---------------------------------------------------------------------- 05200000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                05210000
*---------------------------------------------------------------------- 05220000
                                                                        05230000
VTAMUNLK DS    0H                                                       05240000
                                                                        05250000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       05260000
         BNOR  R14                  BRANCH IF NOT                       05270000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             05280000
         BOR   R14                  DON'T RELEASE IF IT WAS             05290000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             05300000
                                                                        05310000
         $SER  RELEASE,                                                +05320000
               VTAM                                                     05330000
                                                                        05340000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  05350000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          05360000
         BR    R14                  RETURN                              05370000
                                                                        05380000
*---------------------------------------------------------------------- 05390000
*   SUBROUTINE: POST THE REQUEST (R0 CONTAINS POSTCODE)                 05400000
*---------------------------------------------------------------------- 05410000
                                                                        05420000
POSTREQ  DS    0H                                                       05430000
                                                                        05440000
         STM   R14,R2,SUB0SAVE    SAVE CALLER'S REGISTERS               05450000
                                                                        05460000
         L62POST *AQEEPB,         ADDRESS OF EPB TO BE POSTED          +05470000
               SUB0SAVE+8,        ADDRESS OF POST CODE                 +05480000
               AQEENT,            ADDRESS OF ENTITY TOKEN              +05490000
               L62RETCD,          RETURN CODE AREA                     +05500000
               MF=(E,L62MFL)                                            05510000
                                                                        05520000
         LM    R14,R2,SUB0SAVE    RESTORE CALLER'S REGISTERS            05530000
         BR    R14                RETURN                                05540000
                                                                        05550000
*---------------------------------------------------------------------- 05560000
*   SUBROUTINE: OBTAIN DISP GLOBAL LOCK                                 05570000
*---------------------------------------------------------------------- 05580000
                                                                        05590000
DISPLOCK DS    0H                                                       05600000
                                                                        05610000
         TM    FLAG,FLAGDLCK        WAS THE LOCK ALREADY OBTAINED?      05620000
         BOR   R14                  RETURN IF YES                       05630000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             05640000
                                                                        05650000
         $SER  OBTAIN,                                                 +05660000
               DISP                                                     05670000
                                                                        05680000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              05690000
         BNE   DISPLOEX             BRANCH IF NOT                       05700000
         OI    FLAG,FLAGDLKD        REMEMBER LOCK HELD ON ENTRY         05710000
                                                                        05720000
DISPLOEX DS    0H                                                       05730000
                                                                        05740000
         OI    FLAG,FLAGDLCK        REMEMBER LOCK IS HELD               05750000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          05760000
         BR    R14                  RETURN                              05770000
                                                                        05780000
*---------------------------------------------------------------------- 05790000
*   SUBROUTINE: RELEASE DISP GLOBAL LOCK                                05800000
*---------------------------------------------------------------------- 05810000
                                                                        05820000
DISPUNLK DS    0H                                                       05830000
                                                                        05840000
         TM    FLAG,FLAGDLCK        IS LOCK HELD?                       05850000
         BNOR  R14                  BRANCH IF NOT                       05860000
         TM    FLAG,FLAGDLKD        WAS LOCK HELD ON ENTRY?             05870000
         BOR   R14                  DON'T RELEASE IF IT WAS             05880000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             05890000
                                                                        05900000
         $SER  RELEASE,                                                +05910000
               DISP                                                     05920000
                                                                        05930000
         NI    FLAG,255-FLAGDLCK    SHOW LOCK NOT HELD                  05940000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          05950000
         BR    R14                  RETURN                              05960000
                                                                        05970000
*---------------------------------------------------------------------- 05980000
*  CONSTANTS AND LITERALS                                               05990000
*---------------------------------------------------------------------- 06000000
                                                                        06010000
         LTORG ,                                                        06020000
         PRINT NOGEN                                                    06030000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                06040000
         ISTDBIND ,               VTAM BIND IMAGE                       06050000
         TRACODES ,               INTEGRATOR TRACE CODES                06060000
         ICVT  ,                  INTEGRATOR CVT                        06070000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   06080000
         IRPL ,                   INTEGRATOR VTAM RPL+                  06090000
         IACB ,                   INTEGRATOR VTAM ACB+                  06100000
         INIB ,                   INTEGRATOR VTAM NIB+                  06110000
         ISESS ,                  INTEGRATOR SESSION BLOCK              06120000
         IRQE ,                   INTEGRATOR RECEIVE QUEUE ELEMENT      06130000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            06140000
         ITASK ,                  INTEGRATOR TASK BLOCK                 06150000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          06160000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       06170000
         EVCODES ,                INTEGRATOR EVENT CODES                06180000
         ABCODES ,                INTEGRATOR $ABEND CODES               06190000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     06200000
         $WULOC DSECT=YES         INTEGRATOR $WULOC SERVICES            06210000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        06220000
         IFGEXLST ,               VTAM EXIT LIST                        06230000
         END   ,                                                        06240000

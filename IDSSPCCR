IDSSPCCR TITLE 'DATASPACE SERVICES - SPACE CREATE'                      00010000
***************************************************************         00020000
*                                                                       00030000
* MAPPING: SCRPARMS - SPACE CREATE PARAMETER LIST                       00040000
*                                                                       00050000
***************************************************************         00060000
SCRPARMS DSECT ,                                                        00070000
SCRTOKEN DS    A                  $SPACE TOKEN RETURN AREA              00080000
SCRMODEL DS    A                  ADDR OF MODEL SPCBLOCK OR ZERO        00090000
SCRNAME  DS    A                  ADDR OF SPACE NAME                    00100000
SCRSIZE  DS    F                  SIZE OF SPACE IN BYTES                00110000
SCRALUSZ DS    F                  PROPOSED SIZE OF ALLOCATION UNIT      00120000
SCRALTYP DS    F                  ALET TYPE: 0 - WORKUNIT, 1 - PASN     00130000
SCRSERAC DS    A                  SERIALIZATION: 0-NO, 1-YES, @-ASSIST  00140000
SCRINOIE DS    F                  INITIAL OIE COUNT OR ZERO             00150000
SCRTTOKN DS    A                  ADDR OF TCB TOKEN OF OWNING TASK      00160000
                                                                        00170000
         EJECT ,                                                        00180000
***************************************************************         00190000
*                                                                       00200000
*   READ / WRITE WORKING STORAGE AREA                                   00210000
*                                                                       00220000
***************************************************************         00230000
WORKAREA DSECT                                                          00240000
                                                                        00390000
         @WORK PLIST=(MFE_LIST,80)                                      00391001
                                                                        00410000
         ORG   MFE_LIST                                                 00420000
         DSPSERV PLISTVER=1,MF=(L,MFL_DSP,0F)                           00430000
                                                                        00440000
         ORG   MFE_LIST                                                 00450000
ALE_MFL  ALESERV MF=L                                                   00460000
                                                                        00470000
         ORG   ,                                                        00480000
                                                                        00480101
SIZE     DS    F                  SIZE OF SPACE - BYTES                 00480201
SIZEALUS DS    F                  SIZE OF SPACE - ALUS                  00480301
PAGES    DS    F                  SIZE OF SPACE - PAGES                 00480401
                                                                        00480501
ALUSIZE  DS    F                  ALU SIZE PROPOSAL                     00480601
ALUEXP2  DS    F                  ALU SIZE EXPRESSED AS POWER OF 2      00480701
ACTPAGES DS    F                  SPACE SIZE (PAGES) FROM DSPSERV       00480801
OIEPLSZ  DS    F                  COMPUTED OIE POOL SIZE IN ALU'S       00480901
OIEPBYTS DS    F                  COMPUTED OIE POOL SIZE IN BYTES       00481001
ACTUALS  DS    F                  NUMBER PAGES ALLOCATED TO SPACE       00481101
                                                                        00482001
SPCTOKEN $TOKEN  TYPE=BLOCK       CONSTRUCT $SPACE TOKEN                00490000
WORKLEN  EQU   *-WORKAREA         WORKAREA LENGTH                       00500000
                                                                        00501001
         EJECT                                                          00510000
         SPCBLOCK ,               SPACE BLOCK - ALU0                    00520000
                                                                        00521001
         EJECT                                                          00530000
         OIE ,                    OBJECT INDEX ENTRY                    00540000
                                                                        00541001
         EJECT                                                          00550000
         $TOKEN ,                 $SPACE/$OBJECT TOKEN                  00560000
                                                                        00561001
         EJECT                                                          00570000
         SPINPRMS ,               SPACE INIT SERVICE PLIST              00580000
                                                                        00581001
         EJECT                                                          00590000
         SPCEQUS ,                                                      00600000
                                                                        00601001
         EJECT                                                          00610000
         EQUS  LINKAGE=VCON                                             00620000
                                                                        00621001
         EJECT                                                          00630000
**<DOC-ON>*****************************************************         00640001
*                                                                       00650000
* ROUTINE: IDSSPCCR - SPACE CREATE (MVS/ESA)                            00660000
*                                                                       00670000
* DESCRIPTION:                                                          00680000
*                                                                       00690000
*    THE SPACE CREATE SERVICE PROVIDES A PARAMETERIZED METHOD           00700000
*    FOR ALLOCATING AND TAILORING A DATASPACE FOR USE BY                00710000
*    $OBJECT AND OTHER SERVICES.  A TOKEN IS RETURNED THAT              00720000
*    IDENTIFIES THE DATASPACE FOR SUBSEQUENT $SPACE AND                 00730000
*    $OBJECT CALLS.  THE TOKEN IS REFERRED TO AS THE "$SPACE            00740000
*    TOKEN" TO DISTINGUISH IT FROM AN MVS "SPACE TOKEN".                00750000
*                                                                       00760000
*    THE REQUESTOR PROVIDES A SPACE NAME THAT IS VALIDATED BY           00770000
*    THIS SERVICE.  THE GENNAME=COND OPERAND OF THE DSPSERV             00780000
*    SERVICE IS USED TO ENSURE THAT NAME DUPLICATION DOES NOT           00790000
*    PRECLUDE THE SPACE CREATION.  INVALID NAMES ARE REJECTED.          00800000
*                                                                       00810000
*    THE REQUESTOR MUST IDENTIFY THE NEED FOR SPACE SERIALIZATION       00820000
*    WHEN MULTITASKED ACCESS TO THE SPACE MAY OCCUR.  SCRSERAC=0        00830000
*    INDICATES THAT NO SERIALIZATION IS REQUIRED. WHEN SCRSERAC=1,      00840000
*    SERIALIZATION IS PERFORMED USING STANDARD MVS ENQ AND DEQ.         00850000
*    SCRSERAC > 1 CONVEYS THE ADDRESS OF AN EXTERNALLY MANAGED          00860000
*    SERIALIZATION FACILITY NOT DEFINED IN THE SPACE SERVICES           00870000
*    API.                                                               00880000
*                                                                       00890000
*                                                                       00900000
* ON ENTRY:                                                             00910000
*                                                                       00920000
*    R1 POINTS TO AN OS/VS PARAMETER LIST DESCRIBED BY THE              00930000
*       SCRPARMS MAPPING                                                00940000
*                                                                       00950000
*                                                                       00960000
* ON EXIT:                                                              00970000
*                                                                       00980000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES                     00990000
*                                                                       01000000
*         RC00 - SUCCESSFUL COMPLETION                                  01010000
*                                                                       01020000
*         RC04 - IDSSPCIN (SPACE INIT) FAILURE                          01030000
*                                                                       01040000
*         RC08 - DSPSERV OR ALESERV REQUEST FAILURE                     01050000
*                                                                       01060000
*              R1 - SYSTEM SERVICE RETCODE ORIGINALLY IN R15            01070000
*              R0 - SYSTEM SERVICE RSNCODE                              01080000
*                                                                       01090000
*         RC16 - INVALID REQUEST                                        01100000
*                                                                       01110000
**<DOC-OFF>****************************************************         01120001
         EJECT ,                                                        01130000
IDSSPCCR @ENTER WORKA=(WORKAREA,WORKLEN)                                01140000
                                                                        01150000
         LAE   R11,0(R1,0)        PASSED PARAMETERS                     01160000
         USING SCRPARMS,R11       ESTABLISH ADDRESSABILITY              01170000
                                                                        01180000
         ICM   R2,15,SCRTOKEN     TOKEN RETURN AREA                     01190000
         BZ    ERR_REQ            REQUIRED PARAMETER                    01200000
                                                                        01210000
         LAE   R8,SPCTOKEN        SPACE TOKEN CONSTRUCTION AREA         01220000
         USING $TOKEN,R8                                                01230000
         XC    $TOKEN($TOKLN),$TOKEN                                    01240000
         MVC   $TOKTAG,=CL8'SPCTOKEN'                                   01250000
                                                                        01260000
*--------------------------------------------------------------         01270000
*   CONSTRUCT SPACE USING MODEL SPACE BLOCK IF AVAILABLE                01280000
*--------------------------------------------------------------         01290000
         ICM   R9,15,SCRMODEL     MODEL SPCBLOCK PROVIDED?              01300000
         BZ    NOMODEL            CONSTRUCT FROM SCRATCH OTHERWISE      01310000
         LAE   R9,0(R9,0)         MUST RESIDE IN PSPACE                 01320000
         USING SPCBLOCK,R9        ADDRESSABILITY                        01330000
                                                                        01340000
         MVC   $NAME,SPC_NAME     POSSIBLE REUSE OF SPACE NAME          01350000
         MVC   PAGES,SPC_PAGES    SPACE SIZE IN PAGES                   01360000
         MVC   ALUSIZE,SPC_ALU_SIZE     ALU SIZE                        01370000
         MVC   ALUEXP2,SPC_ALU_POWER2 ALU SIZE AS 2**N                  01380000
         MVC   OIEPLSZ,SPC_OIEPOOLSZ     OIE POOL SIZE IN ALU'S         01390000
         B     DEFSPACE           ONWARD                                01400000
         DROP  R9                 MODEL SPCBLOCK                        01410000
                                                                        01420000
         EJECT ,                                                        01430000
***************************************************************         01440000
*                                                                       01450000
*   ALLOCATE SPACE ACCORDING TO REQUEST PARAMETERS                      01460000
*                                                                       01470000
***************************************************************         01480000
NOMODEL  DS    0H                                                       01490000
         L     R1,SCRALUSZ        R1 <== ALU SIZE PROPOSAL OR ZERO      01500000
         @CALL IDSALUSZ           ALU INFO                              01510000
         ST    R15,ALUSIZE        SAVE RECOMMENDATION                   01520000
         ST    R1,ALUEXP2         BYTE/ALU CONVERSION FACTOR            01530000
                                                                        01540000
         ICM   R3,15,SCRINOIE     OIE ALLOCATION COUNT PROVIDED?        01550000
         BNZ   *+8                USE IF SO                             01560000
         LA    R3,32              DEFAULT VALUE OTHERWISE               01570000
         CL    R3,=X'00FFFFFF'    ABSOULTE MAX                          01580000
         BH    ERR_REQ            REJECT IF EXCEEDED                    01590000
                                                                        01600000
         M     R2,=A(OIELN)       COMPUTE TOTAL LENGTH                  01610000
         AL    R3,ALUSIZE         EXPRESS AS # ALU'S                    01620000
         D     R2,ALUSIZE         COMPUTE WHOLE ALU'S                   01630000
         ST    R3,OIEPLSZ         SAVE COMPUTED POOL SIZE               01640000
         M     R2,ALUSIZE         AND BACK TO BYTES                     01650000
         ST    R3,OIEPBYTS        RETAIN                                01660000
                                                                        01670000
*--------------------------------------------------------------         01680000
*   USER-SPECIFIED AREA SIZE MUST EASILY ALLOW FOR OVERHEAD             01690000
*--------------------------------------------------------------         01700000
         L     R1,=F'524288'      ASSUME MAX SIZE SPACE (PAGES)         01710000
         ST    R1,PAGES           POST REQUEST AMOUNT                   01720000
         ICM   R3,15,SCRSIZE      REQUESTED SPACE SIZE (BYTES)          01730000
         BNP   DEFSPACE           MAX SIZE SPACE IF OMITTED             01740000
                                                                        01750000
         AL    R3,ALUSIZE         EXPRESS AS # ALU'S                    01760000
         D     R2,ALUSIZE         COMPUTE WHOLE ALU'S                   01770000
         ST    R3,SIZEALUS        USABLE SIZE IN ALU'S                  01780000
                                                                        01790000
*--------------------------------------------------------------         01800000
*   COMPUTE TYPICAL SPACE OVERHEAD FOR PREFIX, MAPS, OIEPOOL            01810000
*--------------------------------------------------------------         01820000
         L     R5,OIEPLSZ         OIE POOL ALUS                         01830000
         AR    R5,R5              ALLOW FOR ALIGNMENT                   01840000
         LA    R5,1(,R5)          SINGLE OIE FOR PREFIX IS TYPICAL      01850000
         LA    R5,#MAP_ALUS_BYTE(,R5)   ACCOUNT FOR SPACEMAP ROUNDING   01860000
         LR    R0,R5              RETAIN TOTAL TO-DATE                  01870000
         M     R4,=F'5'           COMPUTE FIVE-PERCENT                  01880000
         D     R4,=F'100'                                               01890000
         LA    R5,1(,R5)          ... AS (MAX) SPACE MAP OVERHEAD       01900000
         AR    R5,R0              TOTAL ESTIMATED REQUIREMENT           01910000
                                                                        01920000
         L     R1,SIZEALUS        SPACE SIZE IN ALU'S                   01930000
         CR    R1,R5              USER REQUEST HAS IT COVERED?          01940000
         BNL   *+6                ONWARD IF SO                          01950000
         LR    R1,R5              ELSE MOVE TO COMPUTED SIZE            01960000
         M     R0,ALUSIZE         AND BACK TO BYTES                     01970000
                                                                        01980000
*--------------------------------------------------------------         01990000
*   ESA SERVICES EXPRESS STORAGE AMOUNTS IN PAGES                       02000000
*--------------------------------------------------------------         02010000
CALCPAGE DS    0H                                                       02020000
         LA    R1,4095(,R1)       PREPARE FOR PAGE ROUNDING             02030000
         SRL   R1,12              SIZE OF SPACE IN PAGES                02040000
         C     R1,=F'524288'      REASONABLE SIZE?                      02050000
         BNH   *+8                SKIP IF NOT                           02060000
         L     R1,=F'524288'      REPLACE WITH MAX                      02070000
         ST    R1,PAGES           SAVED                                 02080000
         B     DEFSPACE                                                 02090000
                                                                        02100000
         EJECT ,                                                        02110000
***************************************************************         02120000
*                                                                       02130000
*   CREATE DATASPACE OF SIZE PREVIOUSLY STORED IN .PAGES                02140000
*                                                                       02150000
***************************************************************         02160000
DEFSPACE DS    0H                                                       02170000
         ICM   R1,15,SCRNAME      SPACE NAME EXPLICITLY PROVIDED        02180000
         LAE   R1,0(R1,0)         SPACE NAME RESIDES IN PRIMARY         02190000
         BZ    *+10               ONWARD IF NOT                         02200000
         MVC   $NAME,0(R1)        SAVE NAME                             02210000
                                                                        02220000
         MVC   $GENNAME,$NAME     ENSURE VALID SPACE NAME IS CARRIED    02230000
         LA    R1,$GENNAME        R1 <== CANDIDATE SPACE NAME           02240000
         BAS   R14,VALNAME        VALIDATE SPACE NAME                   02250000
         LTR   R15,R15            OK?                                   02260000
         BNZ   ERR_REQ            FAIL OTHERWISE                        02270000
                                                                        02280000
*--------------------------------------------------------------         02290000
*   CREATE DATASPACE W/ OPTIONAL ASSIGNMENT OF SPACE OWNERSHIP          02300000
*--------------------------------------------------------------         02310000
         ICM   R3,15,SCRTTOKN     OPTIONAL ASSIGNMENT OF OWNERSHIP      02320000
         BNZ   *+8                USE IF TASK TOKEN PROVIDED            02330000
         LA    R3,=XL16'00'       ELSE SUPPLY NULLS                     02340000
                                                                        02350000
         DSPSERV CREATE,                                               X02360000
               SCOPE=SINGLE,                                           X02370000
               NAME=$NAME,        SPACE NAME                           X02380000
               GENNAME=COND,      USE GIVEN NAME IF POSSIBLE           X02390000
               OUTNAME=$GENNAME,  RETURN UPDATED NAME IF CONFLICT      X02400000
               BLOCKS=(524288,PAGES),  (MAX,INITIAL) # OF BLOCKS       X02410000
               STOKEN=$STOKEN,    MVS DATASPACE TOKEN                  X02420000
               TTOKEN=(R3),       OPT ASSIGMENT OF SPACE OWNERSHIP     X02430000
               ORIGIN=$SPCBASE,   DATASPACE ORIGIN (0 OR 4K)           X02440000
               NUMBLKS=ACTUALS,   NUMBER OF PAGES ACTUALLY ALLOCATED   X02450000
               MF=(E,MFL_DSP)     MAINTAIN REENTRANCY                   02460000
                                                                        02470000
         CH    R15,=AL2(RC04)     SPACE CREATED?                        02480000
         BH    ERR_DSP            FAIL IF NOT                           02490000
                                                                        02500000
         L     R0,PAGES           TRUE SIZE OF RESULT SPACE             02510000
         SLL   R0,12              CONVERT TO BYTES                      02520000
         ST    R0,SIZE            PRESERVE SIZE                         02530000
                                                                        02540000
*--------------------------------------------------------------         02550000
*   ATTACH SPACE TO CURRENT WORKUNIT OR PASN AS SPECIFIED               02560000
*--------------------------------------------------------------         02570000
         ICM   R0,15,SCRALTYP     IDENTIFY TARGET ACCESS LIST           02580000
         BZ    ADDWUNIT           WORKUNIT                              02590000
                                                                        02600000
ADDPASN  DS    0H                                                       02610000
         ALESERV ADD,                                                  X02620000
               STOKEN=$STOKEN,    ATTACH SPACE                         X02630000
               AL=PASN,           TO ADDRSPC                           X02640000
               ALET=$ALET,        RETURN APPROPRIATE ALET              X02650000
               MF=(E,ALE_MFL)     MAINTAIN REENTRANCY                   02660000
         B     ADDCOMN                                                  02670000
                                                                        02680000
ADDWUNIT DS    0H                                                       02690000
         ALESERV ADD,                                                  X02700000
               STOKEN=$STOKEN,    ATTACH SPACE                         X02710000
               AL=WORKUNIT,       TO WORKUNIT                          X02720000
               ALET=$ALET,        RETURN APPROPRIATE ALET              X02730000
               MF=(E,ALE_MFL)     MAINTAIN REENTRANCY                   02740000
                                                                        02750000
ADDCOMN  DS    0H                                                       02760000
         LTR   R15,R15            SUCCESS?                              02770000
         BNZ   ERR_ALE                                                  02780000
                                                                        02790000
         EJECT ,                                                        02800000
***************************************************************         02810000
*                                                                       02820000
*   INVOKE SPACE INITIALIZATION TO COMPLETE SPACE CONSTRUCTION          02830000
*                                                                       02840000
***************************************************************         02850000
         L     R10,$SPCBASE       ESTABLISH SPACE ACCESS WINDOW         02860000
         USING SPCBLOCK,R10                                             02870000
         LAM   R10,R10,$ALET                                            02880000
                                                                        02890000
         LAE   R1,MFE_LIST        SPACE INIT PLIST                      02900000
         USING SPINPRMS,R1                                              02910000
         LA    R0,$NAME           ADDR OF SPACE NAME                    02920000
         ST    R0,SPINNAME                                              02930000
         LA    R0,$STOKEN         $SPACE TOKEN ADDR                     02940000
         ST    R0,SPINTOKN                                              02950000
         MVC   SPINSIZE,SIZE      COMPUTED SIZE OF SPACE                02960000
         MVC   SPINALU,ALUSIZE    SIZE OF EACH ALU                      02970000
         MVC   SPINEXP2,ALUEXP2   ALU SIZE EXPRESSED AS POWER OF 2      02980000
         MVC   SPINBASE,$SPCBASE  SPACE ORIGIN ADDR                     02990000
         MVC   SPINOPSZ,OIEPLSZ   SIZE DESIRED FOR OIE POOL IN ALU'S    03000000
         MVC   SPINSER,SCRSERAC   SERIALIZATION CONTROLS                03010000
                                                                        03020000
         @CALL IDSSPCIN           SPACE INITIALIZATION                  03030000
                                                                        03040000
         LTR   R15,R15            SUCCESS?                              03050000
         BNZ   ERR_INIT           SOME SORT OF FAILURE                  03060000
         DROP  R1                 SPINPRMS                              03070000
                                                                        03080000
         EJECT ,                                                        03090000
***************************************************************         03100000
*                                                                       03110000
*   RETURN SPACE TOKEN AND COMPLETION STATUS TO CALLER                  03120000
*                                                                       03130000
***************************************************************         03140000
NORMRET  DS    0H                                                       03150000
         L     R2,SCRTOKEN        TOKEN RETURN AREA                     03160000
         LAE   R2,0(R2,0)         RESIDES IN PRIMARY                    03170000
         MVC   0($TOKLN,R2),SPCTOKEN                                    03180000
                                                                        03190000
         LA    R15,RC00           NORMAL COMPLETION                     03200000
         SR    R1,R1                                                    03210000
         SR    R0,R0                                                    03220000
         B     RET                                                      03230000
                                                                        03240000
ERR_INIT DS    0H                 SPACE INIT ENCOUNTERED ERROR          03250000
         LA    R15,RC04                                                 03260000
         B     RET                                                      03270000
                                                                        03280000
ERR_DSP  DS    0H                 DSPSERV SERVICE FAILED                03290000
ERR_ALE  DS    0H                 ALESERV SERVICE FAILED                03300000
         LR    R1,R15             PRESERVE RETCODE                      03310000
         LA    R15,RC08           IDENTIFY FAILURE                      03320000
         B     RET                                                      03330000
                                                                        03340000
ERR_REQ  DS    0H                 INVALID REQUEST                       03350000
         SR    R1,R1                                                    03360000
         LA    R15,RC16           PER CONVENTION                        03370000
                                                                        03380000
*--------------------------------------------------------------         03390000
*   RETURN                                                              03400000
*--------------------------------------------------------------         03410000
RET      DS    0H                 RETURN TO CALLER                      03420000
         LAE   R15,0(R15,0)                                             03430000
         LAE   R1,0(R1,0)                                               03440000
         @EXIT ,                                                        03450000
                                                                        03460000
         EJECT ,                                                        03470000
***************************************************************         03480000
*                                                                       03490000
* ROUTINE: VALNAME - VALIDATE CANDIDATE SPACE NAME                      03500000
*                                                                       03510000
***************************************************************         03520000
VALNAME  DS    0H                                                       03530000
         BAKR  R14,0                                                    03540000
         LA    R15,RC00           PRESUME VALID NAME                    03550000
                                                                        03560000
         LR    R3,R1              NAME ORIGIN                           03570000
         TRT   0(8,R3),VALTAB     ALL VALID CHARS?                      03580000
         BC    MISSES,VALRET      DONE IF SO                            03590000
                                                                        03600000
         TM    0(R3),X'F0'        LEADING NUMERIC                       03610000
         BO    VALERR             IS NOT ALLOWED                        03620000
                                                                        03630000
         LA    R2,8               LENGTH OF NAME                        03640000
         LR    R4,R1              STOP CHAR PTR                         03650000
         SR    R1,R3              LENGTH TIL HIT                        03660000
         SR    R2,R1              NUMBER OF PAD CHARS                   03670000
         BNP   VALERR             INVALID NAME                          03680000
                                                                        03690000
VALPAD   DS    0H                                                       03700000
         CLI   0(R4),C' '                                               03710000
         BNE   VALERR                                                   03720000
         LA    R4,1(,R4)                                                03730000
         BCT   R2,VALPAD                                                03740000
         B     VALRET                                                   03750000
                                                                        03760000
VALERR   DS    0H                                                       03770000
         LA    R15,RC04                                                 03780000
                                                                        03790000
VALRET   DS    0H                                                       03800000
         PR    ,                                                        03810000
                                                                        03820000
         EJECT ,                                                        03830000
***************************************************************         03840000
*                                                                       03850000
*   READ ONLY CONSTANTS, ETC.                                           03860000
*                                                                       03870000
***************************************************************         03880000
VALTAB   DC    256AL1(4)          ALL CHARS ARE STOPPERS                03890000
         ORG   VALTAB+C'A'                                              03900000
         DC    9AL1(0)                                                  03910000
         ORG   VALTAB+C'J'                                              03920000
         DC    9AL1(0)                                                  03930000
         ORG   VALTAB+C'S'                                              03940000
         DC    8AL1(0)                                                  03950000
         ORG   VALTAB+C'0'                                              03960000
         DC    10AL1(0)                                                 03970000
         ORG    ,                                                       03980000
                                                                        03990000
         LTORG ,                                                        04000000
         END   ,                                                        04010000

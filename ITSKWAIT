ITSKWAIT TITLE '- WORKUNIT WAIT FOR EVENT COMPLETION'                   00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE: ITSKWAIT - Workunit Wait for Event Completion                00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine processes requests to block a workunit                00080000
*    until completion of an event previously identified by a            00090000
*    SETEPB request. The task manager wait routine will save            00100000
*    the environment of the requester and will call the                 00110000
*    task/process dispatcher to dispatch any ready workunits            00120000
*    for the current ITASK.                                             00130000
*                                                                       00140000
*    If the current ITASK does not have any workunits ready             00150000
*    for dispatch,  the ITASK will be placed into a waiting             00160000
*    for event completion status.  If the ITASK was created             00170000
*    with TCBAFF=YES,  this is accomplished by invoking the             00180000
*    MVS events service.  For ITASKs that are dispatched under          00190000
*    a server ITASK, the server dispatcher is entered via a             00200000
*    $SERVER CALLDSP request to give up the dispatch to the             00210000
*    server ITASK.  The server ITASK will then dispatch a               00220000
*    ready ITASK or fall into a $TASK CALLDSP to wait for the           00230000
*    completion of events within the server task.                       00240000
*                                                                       00250000
*    When ECB are posted to the events table,  the ECB/EPB              00260000
*    is processed and attached to the appropriate workunit.             00270000
*    After all completed ecbs have been processed,  the                 00280000
*    task/process dispatcher is called again to dispatch                00290000
*    a ready workunit.  If this is the Server task,  the                00300000
*    server task manager is reentered via a $SERVER CALLDSP             00310000
*    request.                                                           00320000
*                                                                       00330000
* ON ENTRY:                                                             00340000
*                                                                       00350000
*    R1 contains the address of the parameter list mapped by            00360000
*    the TASKPL dsect generated by $TASK DSECT=YES.                     00370000
*                                                                       00380000
* ON EXIT:                                                              00390000
*                                                                       00400000
*    This routine does not directly return control via the              00410000
*    standard savearea linkage.  The workunit to be dispatched          00420000
*    will receive control at the appropriate resume address.            00430000
*                                                                       00440000
* NOTE:                                                                 00450000
*                                                                       00460000
*    Due to the nature of this routine and the method used to           00470000
*    return control, a workarea must be provided to the task            00480000
*    manager services for a $TASK wait request.  By default             00490000
*    the @CB@WRKA indirect address is specified in the $TASK            00500000
*    macro.  Coding $TASK WAIT,WORKA=0,... could result in              00510000
*    abandoned storage.                                                 00520000
*                                                                       00530000
* MODE:                                                                 00540000
*                                                                       00550000
*    TASK                                                               00560000
*    APF/NON-APF                                                        00570000
*    SUP/PROB                                                           00580000
*    AMODE 31, RMODE ANY                                                00590000
*                                                                       00600000
**<DOC-OFF>*****************************************************        00610000
                                                                        00620000
         EJECT ,                                                        00630000
****************************************************************        00640000
*                                                                       00650000
* MAINTENANCE:                                                          00660000
*                                                                       00670000
*   04/21/93 Ron Colmone                                                00680000
*            Initial Version                                            00690000
*                                                                       00700000
*   12/21/94 Ron Colmone          Par# 159456                           00710000
*            Added support for Task manager server.                     00720000
*                                                                       00730000
****************************************************************        00740000
                                                                        00750000
         EJECT ,                                                        00760000
         $TASK   DSECT=YES        TASKMGR PLIST                         00770000
         EJECT ,                                                        00780000
         $SERVER DSECT=YES        TASK MANAGER SERVER PLIST      159456 00790000
         EJECT ,                                                        00800000
         @CB     WORKUNIT=YES     STANDARD CONTROL BLOCK HEADER         00810000
         EJECT ,                                                        00820000
         $QLOCK  TYPE=DSECT       LOCK ENTRY MAPPING                    00830000
         EJECT ,                                                        00840000
         @EPB    TYPE=DSECT       EVENT PROCESS BLOCK                   00850000
         EJECT ,                                                        00860000
         ABCODES ,                $ABEND CODES                          00870000
         EJECT ,                                                        00880000
         TRACODES ,               TRACE EVENT CODES                     00890000
         EJECT ,                                                        00900000
         EQUS  ,                  GENERAL EQUATES                       00910000
                                                                        00920000
         EJECT ,                                                        00930000
         #WORK LENGTH=512         READ/WRITE WORKAREA                   00940000
SAVEPCB  DS    A                  ADDRESS OF LAST DISP WORKUNIT  159456 00950000
EVENTLST DS    A                  ADDRESS OF COMPLETED EVENTS    159456 00960000
                                                                        00970000
WAITFLGS DS    X                  WAIT FLAGS                            00980000
WAIT$PRC EQU   X'80'                PROCESS WAITING                     00990000
WAIT$SRV EQU   X'40'                CALL SERVER DISPATCHER              01000000
$RBTYPE  DS    X                  COPY OF RBSTAB1                       01010000
                                                                        01020000
WRK256   DS    0F,XL256           GENERAL WORKAREA                      01030000
$TSK_MFL $TASK   MF=(L,*)         $TASK   PLIST AREA                    01040000
$SRV_MFL $SERVER MF=(L,*)         $SERVER PLIST AREA                    01050000
         #ENDWORK                 END OF WORKAREA                       01060000
                                                                        01070000
         EJECT ,                                                        01080000
ITSKWAIT #ENTER BASE=R12,         ENTRY LINKAGE                        +01090000
               PREG=R8,                                                +01100000
               WAPASS=YES                                               01110000
                                                                        01120000
         USING TASKPL,R8          ESTABLISH ADDRESSABILITY              01130000
                                                                        01140000
         EJECT ,                                                        01150000
****************************************************************        01160000
*                                                                       01170000
*  Workunit wait for event completion                                   01180000
*                                                                       01190000
****************************************************************        01200000
WAIT     DS    0H                                                       01210000
         ICM   R5,15,TPLTASK      TASK SPECIFIED?                       01220000
         BZ    *+6                YES, CONTINUE                         01230000
         LR    R10,R5             USE CURRENT TASK                      01240000
         USING ITASK,R10          ESTAB ADDR TO ITASK                   01250000
                                                                        01260000
*---------------------------------------------------------------        01270000
*  Verify wait request is not being issued from Recovery                01280000
*  Environment.                                                         01290000
*---------------------------------------------------------------        01300000
         TM    TSKFLGS,TSK$ABE    ABEND IN PROGRESS                     01310000
         BO    ABN_RCVY           NOT ALLOWED FROM RCVY ENV             01320000
                                                                        01330000
*---------------------------------------------------------------        01340000
*  Verify wait request is being issued in standard environment          01350000
*  from the PRB.                                                        01360000
*---------------------------------------------------------------        01370000
         USING PSA,0              ADDRESSABILITY                        01380000
         ICM   R4,15,PSATOLD      ADDRESS OF CURRENT TCB                01390000
         BZ    ABN_WENV           TASK WAIT NOT AVAIL IN SRBMODE        01400000
         USING TCB,R4             ADDRESSABILITY                        01410000
                                                                        01420000
         ICM   R4,15,TCBRBP       ADDRESS OF CURRENT RB                 01430000
         BZ    ABN_WENV           INVALID WAIT ENVIRONMENT              01440000
         USING RBBASIC,R4         ADDRESSABILITY                        01450000
                                                                        01460000
         MVC   $RBTYPE,RBSTAB1    COPY RB STATUS BYTE                   01470000
         NI    $RBTYPE,RBFTP      RESET NON-TYPE BITS                   01480000
         CLI   $RBTYPE,RBFTPRB    REQUEST ISSUED FROM PRB               01490000
         BNE   ABN_WENV           NO, CATASTROPHIC ERROR                01500000
         DROP  R4                 RB                                    01510000
                                                                        01520000
*---------------------------------------------------------------        01530000
*  Verify wait request is not being issued with NOWAIT type             01540000
*  locks held.                                                          01550000
*---------------------------------------------------------------        01560000
         CLI   TPLFUNC,TPLF$DSP   CALLDSP REQUEST                       01570000
         BE    SAVE_ENV           SKIP NOWAIT LOCK TEST                 01580000
                                                                        01590000
         USING @CB,R1             TEMP ADDRESSABILITY                   01600000
         ICM   R1,15,TSKPCBC      ASSUME PROCESS WAIT                   01610000
         BNZ   *+6                AVAIL, CONTINUE                       01620000
         LR    R1,R10             TASK LEVEL WAIT                       01630000
                                                                        01640000
         ICM   R1,15,@CBSERQ      ADDRESS OF QUEUE LOCK                 01650000
         BZ    SAVE_ENV           NONE, SAVE CALLERS ENVIRONMENT        01660000
         USING QLOCK,R1           ADDRESSABILITY                        01670000
         SR    R0,R0              PREPARE FOR INSERT                    01680000
         ICM   R0,3,QLONWAIT      COUNT OF NOWAIT LOCKS HELD            01690000
         BNZ   ABN_LOCK           > 0,  TERMINATE REQUEST               01700000
         DROP  R1                 QLOCK                                 01710000
                                                                        01720000
         EJECT ,                                                        01730000
*---------------------------------------------------------------        01740000
*  Retrieve the current active workunit and save current                01750000
*  environment and event resume addresses.                              01760000
*---------------------------------------------------------------        01770000
SAVE_ENV DS    0H                                                       01780000
         ICM   R6,15,TSKPCBC      ADDRESS OF ACTIVE PCB                 01790000
         BZ    WAIT_TSK           NONE, SAVE TASK MGRS REGS             01800000
         USING IPCB,R6            ESTABLISH ADDRESSABILITY              01810000
         ST    R6,SAVEPCB         ADDRESS OF LAST DISPATCHER WU  159456 01820000
                                                                        01830000
         CLI   TPLFUNC,TPLF$DSP   CALLDSP REQUEST                       01840000
         BE    WAIT_RDY           SKIP ENVIRONMENT SAVE                 01850000
                                                                        01860000
         TM    PCBFLGS,PCB$WAIT   PROCESS ALREADY WAITING               01870000
         BO    ABN_WAIT           YES, NOT ALLOWED                      01880000
         OI    PCBFLGS,PCB$WAIT   INDICATE PCB WAITING                  01890000
                                                                        01900000
         CLI   TPLTWAIT,FALSE     TASK WAIT REQUEST                     01910000
         BE    *+8                NO, CONTINUE                          01920000
         ST    R6,TSKTWPCB        YES, SAVE RESUME PCB ADDRESS          01930000
                                                                        01940000
         LA    R2,PCBREGS         PROCESS RESUME REGS ADDR              01950000
         MVC   PCBMSG@,TPLR@MSG   MESSAGE RESUME ADDRESS                01960000
         MVC   PCBSTP@,TPLR@STP   STOP    RESUME ADDRESS                01970000
         MVC   PCBCNL@,TPLR@CNL   CANCEL  RESUME ADDRESS                01980000
         MVC   PCBEVN@,TPLR@EVN   EVENT   RESUME ADDRESS                01990000
                                                                        02000000
         OI    WAITFLGS,WAIT$PRC  PROCESS WAITING                       02010000
         B     WAIT_SAV           SAVE CURRENT ENVIRONMENT              02020000
                                                                        02030000
*---------------------------------------------------------------        02040000
*  $TASK WAIT issue while running in task manager mode (PCBC=0).        02050000
*  Save environment and wait for specific EPB to be posted.             02060000
*  ITASK is non dispatchable until event occurs.                        02070000
*---------------------------------------------------------------        02080000
WAIT_TSK DS    0H                                                       02090000
         MVC   SAVEPCB,TSKPCBAS   ADDRESS OF ASYNC RTN EPBPCB    159456 02100000
         XC    TSKPCBAS,TSKPCBAS  CLEAR ADDR OF ASYNC RTN EPBPCB 159456 02110000
                                                                        02120000
         CLI   TPLFUNC,TPLF$DSP   CALLDSP REQUEST                       02130000
         BE    TRC_CDSP           YES TRACE CALLDSP REQUEST             02140000
                                                                        02150000
         LA    R2,TSKMREGS        TASK MANAGER RESUME REGS ADDR         02160000
         OI    TSKFLGS,TSK$TMW    TASK MANAGER WAITING                  02170000
                                                                        02180000
         ICM   R0,15,TSKREPB@     RESUME EPB ALREADY POSTED      159456 02190000
         BZ    WAITNDSP           NO, MAKE TASK NON DISPATCHABLE 159456 02200000
         ICM   R1,15,TPLEPB       SPECIFIC EPB POSTED            159456 02210000
         BZ    WAIT_SAV           NO, SAVE CURRENT ENVIRONMENT   159456 02220000
         CR    R0,R1              CORRECT EPB POSTED             159456 02230000
         BE    WAIT_SAV           YES, SAVE CURRENT ENVIRONMENT  159456 02240000
                                                                        02250000
WAITNDSP DS    0H                                                159456 02260000
         OI    TSKFLGS,TSK$NDSP   MARK TASK NON-DISPATCHABLE     159456 02270000
         MVC   TSKREPB@,TPLEPB    WAITING FOR SPECIFIC EPB       159456 02280000
                                                                        02290000
*---------------------------------------------------------------        02300000
*  Save workunit current registers                                      02310000
*---------------------------------------------------------------        02320000
WAIT_SAV DS    0H                                                       02330000
         L     R1,4(,R13)         ADDR OF ITSKSERV SAVE AREA            02340000
         L     R1,4(,R1)          ADDR OF CALLER'S SAVE AREA            02350000
         ST    R1,(13*4)(,R2)          COPY R13                         02360000
         MVC   (14*4)((4*2),R2),12(R1) COPY R14-R15                     02370000
         MVC   0((13*4),R2),20(R1)     COPY R0-R12                      02380000
                                                                        02390000
         CLI   TPLTWAIT,FALSE     TWAIT=YES SPECIFIED                   02400000
         BE    *+8                NO, CONTINUE                          02410000
         OI    TSKFLGS3,TSK3$TWA  YES, INDICATE TASK MANAGER WAITING    02420000
                                                                        02430000
*---------------------------------------------------------------        02440000
*  Trace workunit wait request                                          02450000
*---------------------------------------------------------------        02460000
         $TRACE TRC_DISPWAIT,4*4  INITIALIZE TRACE ENTRY                02470000
         BNZ   WAIT_EPB           TRACE NOT ACTIVE                      02480000
         MVC   4(4,R1),(14*4)(R2)     R14 OF WAIT ISSUER                02490000
         MVC   8(L'TPLEPB,R1),TPLEPB  EPB ADDRESS                       02500000
         B     WAIT_EPB           CONTINUE                              02510000
                                                                        02520000
*---------------------------------------------------------------        02530000
*  Trace Task manager CALLDSP request                                   02540000
*---------------------------------------------------------------        02550000
TRC_CDSP DS    0H                                                       02560000
         $TRACE TRC_DISPCDSP,4    INITIALIZE TRACE ENTRY                02570000
         BNZ   WAIT_RDY           TRACE NOT ACTIVE                      02580000
         L     R15,4(,R13)        ADDR OF ITSKSERV SAVE AREA            02590000
         L     R15,4(,R15)        ADDR OF CALLER'S SAVE AREA            02600000
         MVC   0(4,R1),12(R15)    COPY R14                              02610000
         B     WAIT_RDY           CONTINUE                              02620000
                                                                        02630000
         EJECT ,                                                        02640000
*---------------------------------------------------------------        02650000
*  If this is a wait from a PCB workunit and a specific EPB             02660000
*  is specified,  then save the address of the EPB in the               02670000
*  workunit to enable the specific event wait.                          02680000
*---------------------------------------------------------------        02690000
WAIT_EPB DS    0H                                                       02700000
         TM    WAITFLGS,WAIT$PRC  PROCESS WAITING                       02710000
         BZ    WAIT_RDY           NO,  TEST FOR READY PCBS              02720000
         ICM   R2,15,TPLEPB       WAIT FOR SPEC EPB COMPL               02730000
         BZ    WAIT_PSY           NO, CHECK FOR SYNC EPB                02740000
         N     R2,=F'-2'          CHANGE TOKEN TO ADDRESS               02750000
         ST    R2,PCBWEPB         WAIT FOR SPECIFIC EVENT               02760000
                                                                        02770000
         EJECT ,                                                        02780000
*---------------------------------------------------------------        02790000
*  If the task was created with SYNC=YES and the sync EPB               02800000
*  has not been posted, then post the SYNC EPB to resume                02810000
*  the creating task.                                                   02820000
*---------------------------------------------------------------        02830000
WAIT_PSY DS    0H                                                       02840000
         TM    WAITFLGS,WAIT$PRC  PROCESS WAITING                       02850000
         BZ    WAIT_RDY           NO, TOO EARLY TO POST                 02860000
         TM    TSKFLGS,TSK$SYNC   TASK SYNC REQUIRED                    02870000
         BZ    WAIT_RDY           NO, TEST FOR READY PCBS               02880000
         NI    TSKFLGS,FF-TSK$SYNC RESET SYNC FLAG                      02890000
                                                                        02900000
         $TASK POST,              POST TASK SYNC EPB                   +02910000
               EPB=*TSKSEPB@,                                          +02920000
               PCODE=0,                                                +02930000
               WORKA=0,                                                +02940000
               MF=(E,$TSK_MFL)                                          02950000
                                                                        02960000
         EJECT ,                                                        02970000
*---------------------------------------------------------------        02980000
*  Call service routine to mark workunits ready for dispatch.           02990000
*---------------------------------------------------------------        03000000
WAIT_RDY DS    0H                                                       03010000
         XC    TSKPCBC,TSKPCBC    TASK MANAGER ACTIVE            159456 03020000
                                                                        03030000
         @CALL ITSKREDY,(0,*SAVEPCB),WKA=WRK256,                 159456+03040000
               MF=(E,MFE_LIST)                                   159456 03050000
                                                                        03060000
*---------------------------------------------------------------        03070000
*  Call task manager workunit dispatcher to dispatch ready              03080000
*  workunits.  Control will only return if there are no                 03090000
*  workunits ready to be dispatched with the current ITASK.             03100000
*---------------------------------------------------------------        03110000
WAIT_DSP DS    0H                                                       03120000
         CLI   TSKTYPE,TSKT$SRV   RUNNING SERVER TASK            159456 03130000
         BNE   WAIT_DP2           NO, CONTINUE                   159456 03140000
         TM    TSKFLGS3,TSK3$SDP  SERVER DISPATCH REQUIRED       159456 03150000
         BZ    *+8                NO, SKIP LOCAL FLAG SET        159456 03160000
         OI    WAITFLGS,WAIT$SRV  SET LOCAL FLAG                 159456 03170000
         OI    TSKFLGS3,TSK3$SDP  INDICATE SERVER DISPATCH REQ   159456 03180000
                                                                        03190000
WAIT_DP2 DS    0H                                                159456 03200000
         LA    R0,WRK256          ADDR OF WORKAREA                      03210000
         @CALL ITSKDISP           CALL DISPATCHER                       03220000
                                                                        03230000
         CLI   TSKTYPE,TSKT$SRV   RUNNING SERVER TASK            159456 03240000
         BNE   *+8                NO, CONTINUE                   159456 03250000
         NI    TSKFLGS3,FF-TSK3$SDP INDICATE SERVER DISPATCH REQ 159456 03260000
                                                                        03270000
         EJECT ,                                                        03280000
*---------------------------------------------------------------        03290000
*  If current ITASK was created with TCBAFF=YES, then issue             03300000
*  the MVS events service to wait for the completion of an              03310000
*  event associated with this task.  For ITASKs created with            03320000
*  TCBAFF=NO, call the $SERVER manager to dispatch ready                03330000
*  ITASKs running under the server task.                                03340000
*---------------------------------------------------------------        03350000
WAIT_EVN DS    0H                                                       03360000
         TM    TSKFLGS3,TSK3$TWA  TWAIT=YES SPECIFIED ON WAIT REQ159456 03370000
         BO    WAIT_EVT           CAN'T SWITCH ITASK             159456 03380000
         TM    TSKFLGS3,TSK3$AFF  TASK CREATED WITH TCB AFFINITY 159456 03390000
         BZ    WAIT_SRV           NO,  CALL SERVER DISPATCHER    159456 03400000
         CLI   TSKTYPE,TSKT$SRV   RUNNING SERVER TASK            159456 03410000
         BNE   WAIT_EVT           NO, CONTINUE WITH WAIT         159456 03420000
         TM    WAITFLGS,WAIT$SRV  SERVER DISPATCH REQUIRED?      159456 03430000
         BO    WAIT_SRV           YES, CALL SERVER DISPATCHER    159456 03440000
                                                                        03450000
WAIT_EVT DS    0H                                                159456 03460000
         ICM   R5,15,TSKSVTSK     ADDRESS OF SERVER TASK         159456 03470000
         BNZ   *+6                SERVER AVAIL AND OWNS EVNTS TBL159456 03480000
         LR    R5,R10             CURRENT ITASK OWNS EVENTS TBL  159456 03490000
E        USING ITASK,R5           ADDRESSABILITY TO ITASK        159456 03500000
                                                                        03510000
         L     R3,E.TSKEVNTL      ADDR OF LAST EVENT PROCESSED          03520000
         TM    ICTSTAT2,ICT2$SUP  RUNNING SUPERVISOR STATE?             03530000
*??????  BO    WAIT_SUP           YES, TEST BRANCH ENTRY                03540000
                                                                        03550000
         EVENTS TABLE=E.TSKEVNT,  TEST FOR EVENT COMPLETION            +03560000
               WAIT=YES,                                               +03570000
               LAST=(R3)                                                03580000
                                                                        03590000
         ST    R1,EVENTLST        SAVE ADDR OF COMPLETED EVENTS  159456 03600000
         B     WAIT_PRC           PROCESS COMPLETED EVENTS              03610000
                                                                        03620000
*---------------------------------------------------------------        03630000
*  Wait for completion of events.  If running in supervisor             03640000
*  State,  the events service is called via branch entry linkage.       03650000
*  When branch entering the MVS events service for WAIT=YES             03660000
*  requests, the registers and resume PSW must be set in the TCB/RB     03670000
*  prior to issuing the events service.  The MVS Local lock must        03680000
*  be obtained prior to invoking the service but will be released       03690000
*  by events prior to redispatching the RB.                             03700000
*---------------------------------------------------------------        03710000
WAIT_SUP DS    0H                                                       03720000
         MODESET EXTKEY=ZERO,     SWITCH TO KEY ZERO                   +03730000
               SAVEKEY=(2)                                              03740000
                                                                        03750000
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,REGS=USE          159456 03760000
                                                                        03770000
         USING PSA,0              ADDRESSABILITY                 159456 03780000
         L     R4,PSATOLD         ADDRESS OF CURRENT TCB         159456 03790000
         USING TCB,R4             ADDRESSABILITY                 159456 03800000
         STM   R0,R15,TCBGRS      SAVE GENERAL PURPOSE REGISTERS 159456 03810000
                                                                        03820000
         L     R4,TCBRBP          ADDRESS OF CURRENT RB          159456 03830000
         USING RBBASIC,R4         ADDRESSABILITY                 159456 03840000
         LA    R1,WAIT_RSM        EVENTS RESUME ADDRES           159456 03850000
         O     R1,=X'80000000'    AMODE=31                       159456 03860000
         ST    R1,RBOPSWA         SAVE RESUME ADDRESS            159456 03870000
                                                                        03880000
         NI    RBOPSWB2,X'0E'     ENSURE KEY=0, SUPERVISOR STATE 159456 03890000
         IPM   R1                 RETRIEVE PROGRAM MASK, CC      159456 03900000
         STCM  R1,8,RBOPSW+2      PRESERVE PROGRAM MASK IN RBOPSW159456 03910000
         DROP  R4                 RB                             159456 03920000
                                                                        03930000
         EVENTS TABLE=E.TSKEVNT,  TEST FOR EVENT COMPLETION      159456+03940000
               WAIT=YES,                                         159456+03950000
               LAST=(R3),                                        159456+03960000
               BRANCH=YES                                        159456 03970000
                                                                        03980000
WAIT_RSM DS    0H                                                159456 03990000
         ST    R1,EVENTLST        SAVE ADDR OF COMPLETED EVENTS  159456 04000000
                                                                        04010000
         MODESET KEYADDR=(2)      RESTORE CALLERS KEY                   04020000
                                                                        04030000
         EJECT ,                                                        04040000
*---------------------------------------------------------------        04050000
* Process completed Events.  Attach EPB to associated workunit          04060000
* and mark workunit and associated ITASK ready for dispatch.            04070000
*---------------------------------------------------------------        04080000
WAIT_PRC DS    0H                                                       04090000
         ICM   R3,15,EVENTLST     ADDR OF COMPLETED EVENTS       159456 04100000
         BZ    WAIT_DPX           NO EVENTS TO MARK READY        159456 04110000
                                                                        04120000
WAIT_NXT DS    0H                                                       04130000
         ST    R3,E.TSKEVNTL      SAVE ADDR OF LAST EVENT ENTRY         04140000
         L     R2,0(,R3)          ADDR OF COMPLETED ECB                 04150000
                                                                        04160000
         @CALL ITSKREDY,((R2),0),WKA=WRK256,                     159456+04170000
               MF=(E,MFE_LIST)                                   159456 04180000
                                                                        04190000
         TM    0(R3),X'80'        LAST ECB IN EVENTS PLIST?             04200000
         BO    WAIT_DPX           YES, GO DISPATCH READY WORKUNIT       04210000
         LA    R3,4(,R3)          ADDR OF NEXT ECB IN EVENTS LIST       04220000
         B     WAIT_NXT           PROCESS NEXT COMPLETED EVENT          04230000
                                                                        04240000
         DROP  R6,E               PCB, ITASK (EVENTS)                   04250000
                                                                        04260000
*--------------------------------------------------------------- 159456 04270000
*  Recall dispatcher to dispatch a ready workunit.  If the       159456 04280000
*  current ITASK is a server task,  the server dispatcher is     159456 04290000
*  reentered via a $SERVER CALLDSP.                              159456 04300000
*--------------------------------------------------------------- 159456 04310000
WAIT_DPX DS    0H                                                159456 04320000
         CLI   TSKTYPE,TSKT$SRV   IS THIS A SERVER TASK          159456 04330000
         BE    WAIT_SRV           YES,  CALL SERVER DISPATCHER   159456 04340000
         B     WAIT_DSP           NO,  CALL TASK DISPATCHER      159456 04350000
                                                                        04360000
         EJECT ,                                                        04370000
*--------------------------------------------------------------- 159456 04380000
*  Call the server task dispatcher to wait for the completion    159456 04390000
*  of events within the server task and dispatch ready ITASKs    159456 04400000
*  within the server.                                            159456 04410000
*--------------------------------------------------------------- 159456 04420000
WAIT_SRV DS    0H                                                159456 04430000
         ICM   R2,15,TSKSVTSK     ADDRESS OF SERVER ITASK        159456 04440000
         BNZ   *+6                CONTINUE                       159456 04450000
         LR    R2,R10             MUST BE SERVER TASK            159456 04460000
S        USING ITASK,R2           TEMP ADDRESSABILITY            159456 04470000
                                                                        04480000
         NI    S.TSKFLGS3,FF-TSK3$SDP  RESET SERVER DISPATCH     159456 04490000
         L     R3,S.TSKSRV        ADDRESS OF SERVER EXTENSION    159456 04500000
X        USING SERVERX,R3                                        159456 04510000
                                                                        04520000
         TM    TSKFLGS,TSK$TMW    TASK MANAGER WAITING           159456 04530000
         BO    WAIT_SUS           YES,  SUSPEND ITASK            159456 04540000
                                                                        04550000
         $SERVER CALLDSP,         CALL SERVER DISPATCHER         159456+04560000
               WORKA=*X.SRVWRKA@,                                159456+04570000
               MF=(E,$SRV_MFL)                                   159456 04580000
         EX    0,*                SHOULD NEVER OCCUR             159456 04590000
                                                                        04600000
*--------------------------------------------------------------- 159456 04610000
WAIT_SUS DS    0H                                                159456 04620000
         $SERVER SUSPEND,         SUSPEND CURRENT ITASK          159456+04630000
               WORKA=*X.SRVWRKA@,                                159456+04640000
               MF=(E,$SRV_MFL)                                   159456 04650000
                                                                        04660000
         B     WAIT_DSP           REDISPATCH ITASK               159456 04670000
                                                                        04680000
         DROP  S,X                ITASK, SERVERX                 159456 04690000
                                                                        04700000
         EJECT ,                                                        04710000
****************************************************************        04720000
*                                                                       04730000
*  CATASTROPHIC ERRORS                                                  04740000
*                                                                       04750000
****************************************************************        04760000
                                                                        04770000
ABN_RCVY DS    0H                                                       04780000
         ABEND SYSABE_RECURS      RECOVERY IN PROGRESS                  04790000
                                                                        04800000
ABN_LOCK DS    0H                                                       04810000
         $ABEND ABE_WLCK,                                              +04820000
               SCOPE=ITASK,                                            +04830000
               TITLE='TASK WAIT ISSUED WITH MVS/TASKMGR LOCKS HELD'     04840000
                                                                        04850000
ABN_WAIT DS    0H                                                       04860000
         $ABEND ABE_WAIT,                                              +04870000
               SCOPE=ITASK,                                            +04880000
               TITLE='INVALID WAIT REQ - PROCESS ALREADY IN WAIT ENV'   04890000
                                                                        04900000
ABN_WENV DS    0H                                                       04910000
         $ABEND ABE_WENV,                                              +04920000
               SCOPE=ITASK,                                            +04930000
               TITLE='INVALID WAIT ENVIRONMENT'                         04940000
                                                                        04950000
         EJECT ,                                                        04960000
****************************************************************        04970000
*                                                                       04980000
*  CONSTANTS AND LITERALS                                               04990000
*                                                                       05000000
****************************************************************        05010000
                                                                        05020000
         LTORG ,                                                        05030000
                                                                        05040000
         PRINT NOGEN                                                    05050000
         ICVT  ,                                                        05060000
         ITASK ,                                                        05070000
         SERVERX ,                                               159456 05080000
         IPCB  ,                                                        05090000
                                                                        05100000
         IHAPSA ,                                                       05110000
         CVT   DSECT=YES,LIST=NO                                        05120000
         IKJTCB ,                                                       05130000
         IHARB ,                                                        05140000
         PRINT GEN                                                      05150000
                                                                        05160000
         END   ,                                                        05170000

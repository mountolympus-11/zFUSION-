ICPSSBUF TITLE 'INTEGRATOR - CPIC SERVICE - LOCATE/ALLOCATE SBUF'       00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: ICPSSBUF - CPIC SERVICE - LOCATE/ALLOCATE SBUF               00100000
*                                                                       00110000
* DESCRIPTION:                                                          00120000
*                                                                       00130000
*    THIS ROUTINE IS CALLED TO ALLOCATE A SEND BUFFER IF ONE IS NOT     00140000
*    ALREADY ASSOICATED WITH THE SESSION.                               00150000
*                                                                       00160000
* ON ENTRY:                                                             00170000
*                                                                       00180000
*    R15 = ENTRY POINT ADDRESS                                          00190000
*    R14 = RETURN      ADDRESS                                          00200000
*    R13 = SAVE AREA   ADDRESS                                          00210000
*    R01 = PARMLIST    ADDRESS                                          00220000
*                                                                       00230000
*          +00 (4) = ISESS ADDRESS                                      00240000
*                                                                       00250000
*          THE ISESS IS SERIALIZED BY THE CALLER HOLDING THE VTAMLOCK   00260000
*                                                                       00270000
* ON EXIT:                                                              00280000
*                                                                       00290000
*    R15 = 0                                                            00300000
*                                                                       00310000
*    ISE62SBF = ADDRESS OF SBUF PLIST WITH A BUFFER ALLOCATED           00320000
*                                                                       00330000
**<DOC-OFF>************************************************************ 00340000
         EJECT ,                                                        00350000
*********************************************************************** 00360000
*                                                                       00370000
* MAINTENANCE:                                                          00380000
*                                                                       00390000
*   07/01/94 RANDY WITEK                                                00400000
*                                                                       00410000
*********************************************************************** 00420000
                                                                        00430000
         EQUS  ,                  GENERAL EQUATES                       00440000
                                                                        00450000
RICVT    EQU   R11                                                      00460000
RITASK   EQU   R10                                                      00470000
RBASE    EQU   R9                                                       00480000
RIVTAM   EQU   R8                                                       00490000
RISESS   EQU   R7                                                       00500000
                                                                        00510000
         USING DSA,R13            ESTABLISH ADDRESSABILITY              00520000
         USING CRAB,R12           ESTABLISH ADDRESSABILITY              00530000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00540000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00550000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00560000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00570000
                                                                        00580000
         COPY  CRAB               "C" RUNTIME ANCHOR BLOCK              00590000
         COPY  DSA                DYNAMIC SAVE AREA                     00600000
WORKAREA DS    0H                 READ/WRITE WORKAREA                   00610000
WRK256   DS    XL256              GENERAL WORKAREA                      00620000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00630000
WORKLEN  EQU   *-WORKAREA         LENGTH OF USER DSA AREA               00640000
DSALEN   EQU   *-DSA              LENGTH OF DSA                         00650000
                                                                        00660000
         $MSGDFT PREFIX=ICTPID,                                        +00670000
               COMPID='CPI',                                           +00680000
               TABLE=*#MSGS,                                           +00690000
               WORKA=0,                                                +00700000
               MF=(E,WRK256),                                          +00710000
               PRINT=NOGEN                                              00720000
                                                                        00730000
ICPSBUF@ CSECT ,                                                        00740000
ICPSSBUF CENTRY DSA=DSALEN,BASE=RBASE,INDEP=YES                         00750000
                                                                        00760000
*---------------------------------------------------------------------- 00770000
* ENTRY                                                                 00780000
*---------------------------------------------------------------------- 00790000
                                                                        00800000
         L     RISESS,0(,R1)      SAVE ADDRESS OF ISESS                 00810000
                                                                        00820000
         LA    R0,WORKAREA        ADDRESS OF USER DSA SECTION           00830000
         LA    R1,WORKLEN         LENGTH  OF USER DSA SECTION           00840000
         SR    R15,R15            PREPARE FOR CLEAR                     00850000
         MVCL  R0,R14             CLEAR USER DSA SECTION                00860000
                                                                        00870000
*---------------------------------------------------------------------- 00880000
* INITIALIZATION                                                        00890000
*---------------------------------------------------------------------- 00900000
                                                                        00910000
         @RESTENV ,               ENSURE ENVIRONMENT                    00920000
                                                                        00930000
         L     RIVTAM,ICTVTCVT    ESTABLISH IVTAMCVT POINTER            00940000
                                                                        00950000
*---------------------------------------------------------------------- 00960000
* ALLOCATE AN SBUF PLIST AND BUFFER IF ONE IS NOT PRESENT FOR THE ISESS 00970000
*---------------------------------------------------------------------- 00980000
                                                                        00990000
         ICM   R3,15,ISE62SBF     IS THERE AN SBUF FOR THE SESSION?     01000000
         BNZ   GOTPLIST           BRANCH IF YES                         01010000
                                                                        01020000
         $GETSTOR L'SBF,                                               +01030000
               LOC=ANY,                                                +01040000
               OWNER=*ISEITASK    ALLOCATE SBUF PLIST TO ISESS TASK     01050000
                                                                        01060000
         LR    R3,R1              ADDRESS OF PLIST                      01070000
         ST    R3,ISE62SBF        SAVE ADDRESS OF PLIST                 01080000
                                                                        01090000
GOTPLIST DS    0H                                                       01100000
                                                                        01110000
X        USING SBFLIST,R3                                               01120000
         OC    X.SBFBUFA,X.SBFBUFA IS THERE A BUFFER ALLOCATED?         01130000
         BNZ   GOTBUFR            BRANCH IF YES                         01140000
                                                                        01150000
         SBUF  OBTAIN,                                                 +01160000
               OWNER=*ISEITASK,                                        +01170000
               ERRET=ERRSBUF,                                          +01180000
               MF=(E,*ISE62SBF)   ALLOCATE INITIAL SBUF                 01190000
                                                                        01200000
GOTBUFR  DS    0H                                                       01210000
                                                                        01220000
*---------------------------------------------------------------------- 01230000
* EXCEPTION ROUTINES                                                    01240000
*---------------------------------------------------------------------- 01250000
                                                                        01260000
*---------------------------------------------------------------------- 01270000
* EXIT TRACE AND RETURN TO CALLER                                       01280000
*---------------------------------------------------------------------- 01290000
                                                                        01300000
RETURN   DS    0H                                                       01310000
                                                                        01320000
         SR    R15,R15            FUNCTION RETURN CODE = 0              01330000
         CEXIT RC=(R15),INDEP=YES RETURN                                01340000
                                                                        01350000
*---------------------------------------------------------------------- 01360000
* ERROR ROUTINES                                                        01370000
*---------------------------------------------------------------------- 01380000
                                                                        01390000
ERRSBUF  DS    0H                                                       01400000
                                                                        01410000
         $ABEND ABE_VTDIAG,                                            +01420000
               SCOPE=PCB,                                              +01430000
               TITLE='SBUF FAILURE'                                     01440000
                                                                        01450000
*---------------------------------------------------------------------- 01460000
* LITERALS AND CONSTANTS                                                01470000
*---------------------------------------------------------------------- 01480000
                                                                        01490000
         LTORG ,                                                        01500000
                                                                        01510000
         PRINT NOGEN                                                    01520000
         ISTDBIND ,               VTAM BIND IMAGE                       01530000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                01540000
         IKJTCB ,                 MVS TASK CONTROL BLOCK                01550000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         01560000
         ICVT  ,                  INTEGRATOR CVT                        01570000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   01580000
         ITASK ,                  INTEGRATOR TASK BLOCK                 01590000
         IPCB ,                   INTEGRATOR PROCESS BLOCK              01600000
         IACB ,                   INTEGRATOR VTAM ACB                   01610000
         ABCODES ,                INTEGRATOR $ABEND CODES               01620000
         EVCODES ,                INTEGRATOR EVENT CODES                01630000
         ISESS ,                  INTEGRATOR SESSION BLOCK              01640000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            01650000
         IRPL ,                   INTEGRATOR VTAM RPL                   01660000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          01670000
         SBUF  DSECT=YES          INTEGRATOR SBUF  SERVICES             01680000
         END   ,                                                        01690000

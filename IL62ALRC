IL62ALRC TITLE 'INTEGRATOR - LU6.2 DELETE RESOURCE_CONTROL_BLOCK'       00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: IL62ALRC - LU6.2 DELETE RESOURCE_CONTROL_BLOCK               00100000
*                                                                       00110000
* DESCRIPTION:                                                          00120000
*                                                                       00130000
*    THIS ROUTINE IS CALLED TO DELETE A RESOURCE_CONTROL_BLOCK          00140000
*    (RCB) ON BEHALF OF THE CURRENT PROCESS.                            00150000
*                                                                       00160000
* ON ENTRY:                                                             00170000
*                                                                       00180000
*    R15 = ENTRY POINT ADDRESS                                          00190000
*    R14 = RETURN      ADDRESS                                          00200000
*    R13 = SAVE AREA   ADDRESS                                          00210000
*    R01 = PARM LIST   ADDRESS                                          00220000
*                                                                       00230000
*          +00 = ADDRESS OF RCB                                         00240000
*          +04 = ADDRESS OF RETURN CODE AREA                            00250000
*                                                                       00260000
* ON EXIT:                                                              00270000
*                                                                       00280000
*    R15 = 0                                                            00290000
*                                                                       00300000
*    RETURN_CODE = LU62_OK --> RCB SUCCESSFULLY ALLOCATED               00310000
*                  LU62_PRODUCT_SPECIFIC_ERROR --> NO CURRENT IPCB      00320000
*                  LU62_PRODUCT_SPECIFIC_ERROR --> TKB DOESN'T VERIFY   00330000
*                                                                       00340000
**<DOC-OFF>************************************************************ 00350000
         EJECT ,                                                        00360000
*********************************************************************** 00370000
*                                                                       00380000
* MAINTENANCE:                                                          00390000
*                                                                       00400000
*   07/01/94 RANDY WITEK                                                00410000
*                                                                       00420000
*********************************************************************** 00430000
                                                                        00440000
         EQUS  ,                  GENERAL EQUATES                       00450000
                                                                        00460000
RICVT    EQU   R11                                                      00470000
RITASK   EQU   R10                                                      00480000
RBASE    EQU   R9                                                       00490000
RIVTAM   EQU   R8                                                       00500000
RPLIST   EQU   R7                                                       00510000
RTKB     EQU   R6                                                       00520000
RIPCB    EQU   R5                                                       00530000
RRCB     EQU   R4                                                       00540000
                                                                        00550000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00560000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00570000
         USING L62LIST,RPLIST     ESTABLISH ADDRESSABILITY              00580000
         USING TKB,RTKB           ESTABLISH ADDRESSABILITY              00590000
         USING IPCB,RIPCB         ESTABLISH ADDRESSABILITY              00600000
         USING RCB,RRCB           ESTABLISH ADDRESSABILITY              00610000
                                                                        00620000
         COPY  CRAB               "C" RUNTIME ANCHOR BLOCK              00630000
         USING CRAB,R12           ADDRESSABILITY                        00640000
                                                                        00650000
         COPY  DSA                DYNAMIC SAVE AREA                     00660000
WORKAREA DS    0H                 READ/WRITE WORKAREA                   00670000
WRK256   DS    XL256              GENERAL WORKAREA                      00680000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00690000
$SESSMFL $SESS MF=L               PLIST CONSTRUCTION                    00700000
CONVID   DS    XL8                CONVID FOR DIAG MESSAGE               00710000
SESSID   DS    XL8                SESSION TOKEN FOR DIAG MESSAGE        00720000
SAVERCB@ DS    A                  RCB ADDRESS FOR DIAG MESSAGE          00730000
RETCODE  DS    F                  TEMPORARY RETURN CODE AREA            00740000
FLAG     DS    X                                                        00750000
FLAGLOCK EQU   X'80'                                                    00760000
FLAGLCKD EQU   X'40'                                                    00770000
WORKLEN  EQU   *-WORKAREA         LENGTH OF USER DSA AREA               00780000
DSALEN   EQU   *-DSA              LENGTH OF DSA                         00790000
                                                                        00800000
         $MSGDFT PREFIX=ICTPID,                                        +00810000
               COMPID='L62',                                           +00820000
               TABLE=*#MSGS,                                           +00830000
               WORKA=0,                                                +00840000
               MF=(E,WRK256),                                          +00850000
               PRINT=NOGEN                                              00860000
                                                                        00870000
IL6ALRC@ CSECT ,                                                        00880000
IL62ALRC CENTRY DSA=DSALEN,BASE=RBASE,INDEP=YES                         00890000
                                                                        00900000
         USING DSA,R13            ADDRESSABILITY                        00910000
         LR    RPLIST,R1          SAVE ADDRESS OF PLIST                 00920000
                                                                        00930000
         LA    R0,WORKAREA        ADDRESS OF USER DSA SECTION           00940000
         LA    R1,WORKLEN         LENGTH  OF USER DSA SECTION           00950000
         SR    R15,R15            PREPARE FOR CLEAR                     00960000
         MVCL  R0,R14             CLEAR USER DSA SECTION                00970000
                                                                        00980000
*---------------------------------------------------------------------- 00990000
* INITIALIZATION                                                        01000000
*---------------------------------------------------------------------- 01010000
                                                                        01020000
         @RESTENV ,               ENSURE ENVIRONMENT                    01030000
                                                                        01040000
         L     RIVTAM,ICTVTCVT    ESTABLISH IVTAMCVT POINTER            01050000
         USING IVTAMCVT,RIVTAM    ADDRESSABILITY                        01060000
         L     RRCB,L62PARM1      ESTABLISH RCB POINTER                 01070000
                                                                        01080000
*---------------------------------------------------------------------- 01090000
* ENTRY TRACE                                                           01100000
*---------------------------------------------------------------------- 01110000
                                                                        01120000
         $TRACE *=A(TRC_LU62_IL62ALRC),48 TRACE ENTRY W/ 48 USER BYTES  01130000
         BNZ   NOETRACE                   BRANCH IF NOT TRACING         01140000
         $APITRC IL62ALRC                 TRACE COMMON STUFF            01150000
         ST    RPLIST,24(,R1)             TRACE PARMLIST ADDRESS        01160000
         MVC   28(4,R1),RCBTKBID          TRACE TKBID                   01170000
         MVC   32(8,R1),RCBCNVID          TRACE CONVERSATION ID         01180000
         MVC   40(8,R1),RCBHSID           TRACE SESSION TOKEN           01190000
NOETRACE DS    0H                                                       01200000
                                                                        01210000
*---------------------------------------------------------------------- 01220000
* LOCATE THE TKB FOR THIS TRANSACTION PROGRAM                           01230000
*---------------------------------------------------------------------- 01240000
                                                                        01250000
         ICM   RIPCB,15,TSKPCBC   ACCESS CURRENT IPCB                   01260000
         BZ    ERRPROD            BRANCH IF NOT FOUND                   01270000
         ICM   RTKB,15,PCBIVTAM   ACCESS THE TKB                        01280000
         BNP   ERRPROD            BRANCH IF NOT FOUND                   01290000
         C     RTKB,RCBTKBID      IS IT CORRECT?                        01300000
         BNE   ERRPROD            BRANCH IF NOT                         01310000
                                                                        01320000
*---------------------------------------------------------------------- 01330000
* DEQUEUE THE RESOURCE_CONTROL_BLOCK                                    01340000
*---------------------------------------------------------------------- 01350000
                                                                        01360000
         LM    R14,R15,RCBNEXT          R14=NEXT R15=PREV               01370000
         ST    R15,RCBPREV-RCB(,R14)    LINK NEXT TO PREV               01380000
         ST    R14,RCBNEXT-RCB(,R15)    LINK PREV TO NEXT               01390000
                                                                        01400000
*---------------------------------------------------------------------- 01410000
* SEND A FREE SESSION IF APPROPRIATE                                    01420000
*---------------------------------------------------------------------- 01430000
                                                                        01440000
         OC    RCBHSID,RCBHSID    IS THERE A SESSION TOKEN?             01450000
         BZ    SESSFRED           BRANCH IF NOT                         01460000
                                                                        01470000
         BAS   R14,VTAMLOCK                                             01480000
                                                                        01490000
         $SESS $SESS_FIND_SESSION,                                     +01500000
               SESSION=RCBHSID,                                        +01510000
               ERRET=SESSFRED,                                         +01520000
               MF=(E,$SESSMFL)    LOCATE ASSOCIATED ISESS, IF ANY       01530000
                                                                        01540000
X        USING SPLIST,$SESSMFL                                          01550000
         L     R3,X.SPLAREA       ADDRESS OF ASSOCIATED ISESS BLOCK     01560000
         DROP  X                                                        01570000
Y        USING ISESS,R3                                                 01580000
                                                                        01590000
         XC    Y.ISE62RCB,Y.ISE62RCB  CLEAR RCB ASSOCIATION             01600000
         XC    Y.ISE62ENT,Y.ISE62ENT  CLEAR ENTITY ASSOCIATION          01610000
                                                                        01620000
         $VTAMWE L'IWEY4,             SIZE                             +01630000
               IWECFRES               CODE                              01640000
                                                                        01650000
Z        USING IWEVTAM,R1                                               01660000
         MVC   Z.IWEY4MDE,Y.ISE62MDE  PASS MDE ADDRESS                  01670000
         MVC   Z.IWEY4NME,RCBMDNM     PASS MODE NAME                    01680000
         MVC   Z.IWEY4TKN,RCBHSID     PASS SESSION TOKEN                01690000
                                                                        01700000
         L     R14,Y.ISEIVUSR         IVUSER BLOCK                      01710000
         LA    R0,IVUWEQ-IVUSER(,R14) QUEUE ADDRESS                     01720000
         BAS   R14,QWE                QUEUE TO WORK ELEMENT             01730000
         DROP  Y                                                        01740000
         DROP  Z                                                        01750000
                                                                        01760000
SESSFRED DS     0H                                                      01770000
                                                                        01780000
         BAS   R14,VTAMUNLK                                             01790000
                                                                        01800000
*---------------------------------------------------------------------- 01810000
* RELEASE THE RESOURCE_CONTROL_BLOCK STORAGE                            01820000
*---------------------------------------------------------------------- 01830000
                                                                        01840000
         ST    RRCB,SAVERCB@            SAVE FOR DIAG MESSAGE           01850000
         MVC   CONVID,RCBCNVID          SAVE FOR DIAG MESSAGE           01860000
         MVC   SESSID,RCBHSID           SAVE FOR DIAG MESSAGE           01870000
                                                                        01880000
         $RETSTOR (RRCB),                                              +01890000
               OWNER=(RIPCB)                                            01900000
                                                                        01910000
         $MSG  991,                     "CONV START....'               +01920000
               FIELDS=((RTKB),          TKB ADDRESS                    +01930000
               (SAVERCB@,4),            RCB ADDRESS                    +01940000
               (SESSID,4),              SESSION TOKEN                  +01950000
               (SESSID+4,4),            SESSION TOKEN                  +01960000
               (TSKNAME,8),             ITASK NAME                     +01970000
               (RITASK),                ITASK ADDRESS                  +01980000
               (PCBNAME,8),             IPCB  NAME                     +01990000
               (RIPCB),                 IPCB  ADDRESS                  +02000000
               (CONVID,4),              CONVERSATION ID                +02010000
               (CONVID+4,4),            CONVERSATION ID                +02020000
               (TKBTPN,64))             TP NAME                         02030000
                                                                        02040000
         B     RETURN                                                   02050000
                                                                        02060000
*---------------------------------------------------------------------- 02070000
* EXCEPTION ROUTINES                                                    02080000
*---------------------------------------------------------------------- 02090000
                                                                        02100000
ERRPROD  DS    0H                                                       02110000
                                                                        02120000
         MVC   RETCODE,=A(LU62_PRODUCT_SPECIFIC_ERROR)                  02130000
         B     RETURN                                                   02140000
                                                                        02150000
*---------------------------------------------------------------------- 02160000
* EXIT TRACE AND RETURN TO CALLER                                       02170000
*---------------------------------------------------------------------- 02180000
                                                                        02190000
RETURN   DS    0H                                                       02200000
                                                                        02210000
         $TRACE *=A(TRC_LU62_EXIT),16 TRACE ENTRY W/ 16 USER BYTES      02220000
         BNZ   NOXTRACE               BRANCH IF TRACING NOT AVAILABLE   02230000
         MVC   0(8,R1),=CL8'IL62ALRC' MODULE NAME                       02240000
         MVC   8(4,R1),RETCODE        RETURN_CODE VALUE                 02250000
         ST    RRCB,12(,R1)           RCB ADDRESS                       02260000
NOXTRACE DS    0H                                                       02270000
                                                                        02280000
         L     R1,L62PARM2        ADDRESS OF RETURN_CODE AREA           02290000
         MVC   0(4,R1),RETCODE    SET RETURN_CODE VARIABLE              02300000
                                                                        02310000
         SR    R15,R15            FUNCTION RETURN CODE = 0              02320000
         CEXIT RC=(R15),INDEP=YES RETURN                                02330000
                                                                        02340000
*---------------------------------------------------------------------- 02350000
* SUBROUTINE QWE - QUEUE A WORK ELEMENT TO A GIVEN WORK QUEUE           02360000
*                                                                       02370000
* ENTRY            R14 = RETURN ADDRESS                                 02380000
*                  R1  = WORK ELEMENT ADDRESS                           02390000
*                  R0  = QUEUE ADDRESS                                  02400000
*                                                                       02410000
* RETURNS          R15 = 0 --> QUEUEING WAS SUCCESSFUL                  02420000
*                      = 4 --> QUEUEING FAILED, WORK ELEMENT RELEASED   02430000
*---------------------------------------------------------------------- 02440000
                                                                        02450000
QWE      DS    0H                                                       02460000
                                                                        02470000
         STM   R14,R4,SUB0SAVE    SAVE REGISTERS                        02480000
         LR    R3,R0              SAVE QUEUE ADDRESS                    02490000
         LR    R4,R1              SAVE WORK ELEMENT ADDRESS             02500000
                                                                        02510000
         $VTAMQ (R4),             WORK ELEMENT                         +02520000
               (R3)               QUEUE                                 02530000
                                                                        02540000
         L     R14,SUB0SAVE       RESTORE REGISTERS                     02550000
         LM    R0,R4,SUB0SAVE+8   RESTORE REGISTERS                     02560000
         BR    R14                AND RETURN TO CALLER W/R15            02570000
                                                                        02580000
*---------------------------------------------------------------------- 02590000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 02600000
*---------------------------------------------------------------------- 02610000
                                                                        02620000
VTAMLOCK DS    0H                                                       02630000
                                                                        02640000
         TM    FLAG,FLAGLOCK        WAS THE LOCK ALREADY OBTAINED?      02650000
         BOR   R14                  RETURN IF YES                       02660000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             02670000
                                                                        02680000
         $SER  OBTAIN,                                                 +02690000
               VTAM                                                     02700000
                                                                        02710000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              02720000
         BNE   VTAMLOEX             BRANCH IF NOT                       02730000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         02740000
                                                                        02750000
VTAMLOEX DS    0H                                                       02760000
                                                                        02770000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               02780000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          02790000
         BR    R14                  RETURN                              02800000
                                                                        02810000
*---------------------------------------------------------------------- 02820000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                02830000
*---------------------------------------------------------------------- 02840000
                                                                        02850000
VTAMUNLK DS    0H                                                       02860000
                                                                        02870000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       02880000
         BNOR  R14                  BRANCH IF NOT                       02890000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             02900000
         BOR   R14                  DON'T RELEASE IF IT WAS             02910000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             02920000
                                                                        02930000
         $SER  RELEASE,                                                +02940000
               VTAM                                                     02950000
                                                                        02960000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  02970000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          02980000
         BR    R14                  RETURN                              02990000
                                                                        03000000
*---------------------------------------------------------------------- 03010000
* LITERALS AND CONSTANTS                                                03020000
*---------------------------------------------------------------------- 03030000
                                                                        03040000
         LTORG ,                                                        03050000
                                                                        03060000
         PRINT NOGEN                                                    03070000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                03080000
         IKJTCB ,                 MVS TASK CONTROL BLOCK                03090000
         ISTDBIND ,               VTAM BIND IMAGE                       03100000
         TRACODES ,               INTEGRATOR TRACE CODES                03110000
         ICVT  ,                  INTEGRATOR CVT                        03120000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   03130000
         IRPL ,                   INTEGRATOR VTAM RPL+                  03140000
         IACB ,                   INTEGRATOR VTAM ACB+                  03150000
         INIB ,                   INTEGRATOR VTAM NIB+                  03160000
         ISESS ,                  INTEGRATOR SESSION BLOCK              03170000
         IRQE ,                   INTEGRATOR RECEIVE QUEUE ELEMENT      03180000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            03190000
         ITASK ,                  INTEGRATOR TASK BLOCK                 03200000
         IPCB ,                   INTEGRATOR PROCESS BLOCK              03210000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          03220000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       03230000
         EVCODES ,                INTEGRATOR EVENT CODES                03240000
         ABCODES ,                INTEGRATOR $ABEND CODES               03250000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     03260000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        03270000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             03280000
         IFGEXLST ,               VTAM EXIT LIST                        03290000
         END   ,                                                        03300000

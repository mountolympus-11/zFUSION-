IVTMSDIN TITLE 'INTEGRATOR - ISESS DRIVER INITIALIZATION'               00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: IVTMSDIN - ISESS DRIVER INITIALIZATION                       00100000
*                                                                       00110000
* DESCRIPTION: THIS ROUTINE IS CALLED BY IVTMSLOG AND IVTMSBND AFTER    00120000
*              A SESSION HAS BEEN SUCCESSFULLY ESTABLISHED BY OPNDST    00130000
*              OR OPNSEC.  DRIVER INITIALIZATION POSTS ANY ASSOCIATED   00140000
*              REQUESTOR AND STARTS THE SESSION DRIVER PROCESS.         00150000
*                                                                       00160000
*                                                                       00170000
* ON ENTRY:                                                             00180000
*                                                                       00190000
*    R15 = ENTRY POINT ADDRESS                                          00200000
*    R14 = RETURN      ADDRESS                                          00210000
*    R13 = SAVE AREA   ADDRESS                                          00220000
*    R11 = ICVT        ADDRESS                                          00230000
*    R10 = ITASK       ADDRESS                                          00240000
*    R09 = IVTAMCVT    ADDRESS                                          00250000
*    R08 = ISESS       ADDRESS                                          00260000
*    R07 = IACB        ADDRESS                                          00270000
*                                                                       00280000
* ON EXIT:                                                              00290000
*                                                                       00300000
*    R15 = 0                                                            00310000
*    R00 = 0                                                            00320000
*    R01 = 0                                                            00330000
*                                                                       00340000
*    ALL OTHER REGISTERS ARE RESTORED.                                  00350000
*                                                                       00360000
**<DOC-OFF>************************************************************ 00370000
                                                                        00380000
         EJECT ,                                                        00390000
*********************************************************************** 00400000
*                                                                       00410000
* MAINTENANCE:                                                          00420000
*                                                                       00430000
*   08/01/93 RANDY WITEK                                                00440000
*   07/01/94 RANDY WITEK - LU6.2 SUPPORT                                00450000
*                                                                       00460000
*********************************************************************** 00470000
                                                                        00480000
         EQUS  ,                  GENERAL EQUATES                       00490000
                                                                        00500000
RICVT    EQU   R11                                                      00510000
RITASK   EQU   R10                                                      00520000
RIVTAM   EQU   R9                                                       00530000
RISESS   EQU   R8                                                       00540000
RIACB    EQU   R7                                                       00550000
                                                                        00560000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00570000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00580000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00590000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00600000
         USING IACB,RIACB         ESTABLISH ADDRESSABILITY              00610000
         USING ISTDBIND,ISEBIND   ESTABLISH ADDRESSABILITY              00620000
                                                                        00630000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00640000
$SESSMFL $SESS MF=L,                                                   +00650000
               FIELDS=((USERDATA,WRK256,SUB0SAVE,256))                  00660000
DWORK    DS    D                  DOUBLEWORD                            00670000
WRK256   DS    XL256              GENERAL WORKAREA                      00680000
$WUMFL   $WULOC MF=L              PLIST CONSTRUCTION                    00690000
L62MFL   L62DFMD MF=L             PLIST CONSTRUCTION                    00700000
L62RETRC DS    F                  LU6.2 RETURN CODE RETURN AREA         00710000
WUDATA   DS    XL16               $WULOC USERDATA RETURN AREA           00720000
PLUNAME  DS    CL8                PLU NAME                              00730000
SLUNAME  DS    CL8                SLU NAME                              00740000
DRIVERNM DS    CL8                DRIVER NAME                           00750000
DRVRPROC DS    CL8                DRIVER PROC NAME                      00760000
SAVEATOK DS    CL8                ASSOCIATED SESSION TOKEN              00770000
SAVEENT  DS    XL8                ASSOCIATED ENTITY TOKEN               00780000
SAVESPL  DS    A                  ASSOCIATED SPL ADDRESS                00790000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00800000
RETR15   DS    F                                                        00810000
RETR0    DS    F                                                        00820000
RETR1    DS    F                                                        00830000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00840000
FLAG     DS    X                                                        00850000
FLAGLOCK EQU   X'80'              VTAM LOCK IS HELD                     00860000
FLAGLCKD EQU   X'40'              VTAM LOCK WAS HELD ON ENTRY           00870000
FLAGDLCK EQU   X'20'              DISP LOCK HELD                        00880000
FLAGDLKD EQU   X'10'              DISP LOCK WAS HELD ON ENTRY           00890000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00900000
                                                                        00910000
         $MSGDFT PREFIX=ICTPID,                                        +00920000
               COMPID='VTM',                                           +00930000
               TABLE=*#MSGS,                                           +00940000
               WORKA=0,                                                +00950000
               MF=(E,WRK256),                                          +00960000
               PRINT=NOGEN                                              00970000
                                                                        00980000
IVTMSDIN #ENTER BASE=R12,         ENTRY LINKAGE                        +00990000
               AMODE=31,                                               +01000000
               RMODE=ANY                                                01010000
                                                                        01020000
*---------------------------------------------------------------------- 01030000
* NOTIFY THE ASSOCIATED REQUESTOR AND DELETE THE ISQE, IF ANY           01040000
*---------------------------------------------------------------------- 01050000
                                                                        01060000
         BAS   R14,VTAMLOCK                                             01070000
                                                                        01080000
         $VTAM FINDISQE,                                               +01090000
               AREA=ISETK,                                             +01100000
               ERRET=NOISQE,                                           +01110000
               MF=(E,MFE_LIST)       CHECK FOR AN ISQE FOR THIS SESS    01120000
                                                                        01130000
         LR    R3,R1                    R3 HAS ISQE ADDRESS             01140000
         MVC   SAVEATOK,ISQATOK-ISQ(R3) SAVE ASSC. SESSION TOKEN IF ANY 01150000
         MVC   SAVEENT,ISQENT-ISQ(R3)   SAVE ASSC. ENTITY TOKEN IF ANY  01160000
         MVC   SAVESPL,ISQSPL-ISQ(R3)   SAVE ASSC. SPL ADDR IF ANY      01170000
                                                                        01180000
         $VTAM RETISQE,                                                +01190000
               AREA=ISQTOKEN-ISQ(,R3),                                 +01200000
               MF=(E,MFE_LIST)       DELETE THE ISQE FROM CHAIN         01210000
                                                                        01220000
         OC    SAVEATOK,SAVEATOK     IS THERE AN ASSOCIATED REQUESTOR?  01230000
         BZ    CKENTITY              BRANCH IF NOT                      01240000
                                                                        01250000
         $SESS $SESS_FIND_SESSION,                                     +01260000
               SESSION=SAVEATOK,                                       +01270000
               ERRET=NOISQE,                                           +01280000
               MF=(E,$SESSMFL)    LOCATE ASSOCIATED ISESS, IF ANY       01290000
                                                                        01300000
X        USING SPLIST,$SESSMFL                                          01310000
         L     R3,X.SPLAREA       ADDRESS OF ASSOCIATED ISESS BLOCK     01320000
         DROP  X                                                        01330000
                                                                        01340000
         LA    R3,ISEWEQ-ISE(,R3) ADDRESS OF ASSOCIATED WORK QUEUE      01350000
                                                                        01360000
         $VTAMWE L'IWEXM,         SIZE                                 +01370000
               IWECSICM           CODE (SESS INIT COMPLETION)           01380000
                                                                        01390000
X        USING IWEVTAM,R1                                               01400000
         MVC   X.IWEXMRET,=A($SESS_RC_SUCCESS)                          01410000
         MVC   X.IWEXMATK,SAVEATOK SET ASSOCIATED SESSION TOKEN         01420000
         MVC   X.IWEXMSTK,ISETK    SET NEW SESSION TOKEN                01430000
         DROP  X                                                        01440000
                                                                        01450000
         LR    R0,R3              QUEUE ADDRESS                         01460000
         BAS   R14,QWE            GO QUEUE THE WORK ELEMENT             01470000
         B     NOISQE                                                   01480000
                                                                        01490000
CKENTITY DS    0H                                                       01500000
                                                                        01510000
         OC    SAVEENT,SAVEENT    ENTITY TOKEN PRESENT?                 01520000
         BZ    NOISQE             BRANCH IF NOT                         01530000
         BAS   R14,DISPLOCK       SERIALIZE                             01540000
                                                                        01550000
         $WULOC LOCATE,           FIND THE WORK UNIT                   +01560000
               TOKEN=SAVEENT,     WORK UNIT TOKEN ADDRESS              +01570000
               USERDATA=WUDATA,   XL16 AREA TO RECEIVE USER DATA       +01580000
               MF=(E,$WUMFL)      VALIDATE WORK UNIT                    01590000
                                                                        01600000
         LTR   R15,R15            LOCATE SUCCESS?                       01610000
         BNZ   L62POST            BRANCH IF NOT                         01620000
                                                                        01630000
         L     R1,SAVESPL         SPL ADDRESS                           01640000
X        USING SPL,R1                                                   01650000
         MVC   X.SPLRETCD,=A($SESS_RC_SUCCESS) SET RETURN CODE          01660000
         MVC   X.SPLTOKEN,ISETK                SET NEW SESSION TOKEN    01670000
         L     R2,X.SPLEPB                     GET EPB ADDRESS          01680000
         L     R15,IVT@ATSP                    $SESS TRACE ROUTINE      01690000
         BASR  R14,R15                         TRACE THE SPLIST         01700000
         DROP  X                                                        01710000
                                                                        01720000
L62POST  DS    0H                                                       01730000
                                                                        01740000
         L62POST (R2),            ADDRESS OF EPB TO BE POSTED          +01750000
               =F'0',             ADDRESS OF POST CODE                 +01760000
               SAVEENT,           ADDRESS OF ENTITY TOKEN              +01770000
               L62RETRC,          RETURN CODE AREA                     +01780000
               MF=(E,L62MFL)                                            01790000
                                                                        01800000
         BAS   R14,DISPUNLK           RELEASE THE LOCK IF NECESSARY     01810000
                                                                        01820000
NOISQE   DS    0H                                                       01830000
                                                                        01840000
         BAS   R14,VTAMUNLK                                             01850000
                                                                        01860000
*---------------------------------------------------------------------- 01870000
* IDENTIFY THE APPROPRIATE SESSION DRIVER PROCESS                       01880000
*---------------------------------------------------------------------- 01890000
                                                                        01900000
*                                                                       01910000
* IF THIS IS A SECONDARY BIND THE DRIVER IS ALREADY ACTIVE              01920000
*---------------------------------------------------------------------- 01930000
                                                                        01940000
         TM    ISEF1,ISEF1DRV     IS THERE A DRIVER?                    01950000
         BO    RETURN             BRANCH IF YES, ALL DONE               01960000
                                                                        01970000
*                                                                       01980000
* $SESS_EXTRACT THE USERDATA FROM THE LOGON                             01990000
*---------------------------------------------------------------------- 02000000
                                                                        02010000
         $SESS $SESS_EXTRACT,                                          +02020000
               SESSION=ISETK,                                          +02030000
               FIELDS=((USERDATA,WRK256,SUB0SAVE,256)),                +02040000
               ERRET=ERR$SESS,                                         +02050000
               MF=(E,$SESSMFL)                                          02060000
                                                                        02070000
*                                                                       02080000
* SETUP TO USE DEFAULT DRIVER                                           02090000
*---------------------------------------------------------------------- 02100000
                                                                        02110000
         LA    R4,DRVR62DF        DEFAULT LU6.2 SESSION DRIVER          02120000
         CLC   BINLUP(2),=X'0602' LU TYPE 6.2?                          02130000
         BE    DEFDRSET           BRANCH IF YES                         02140000
                                                                        02150000
         LA    R4,DRVRSDEF        DEFAULT SLU SESSION DRIVER            02160000
         TM    ISEF2,ISEF2SLU     ARE WE SLU?                           02170000
         BO    DEFDRSET           BRANCH IF YES                         02180000
                                                                        02190000
         LA    R4,DRVRPDEF        DEFAULT PLU SESSION DRIVER            02200000
                                                                        02210000
DEFDRSET DS    0H                                                       02220000
                                                                        02230000
*                                                                       02240000
* CHECK IF DRIVER NAME WAS PROVIDED WITH SOLICITED LOGON                02250000
*---------------------------------------------------------------------- 02260000
                                                                        02270000
         OC    ISEDRIVE,ISEDRIVE    IS THERE A DRIVER NAME?             02280000
         BZ    NOSOLDRV             BRANCH IF NOT                       02290000
         MVC   DRIVERNM(8),ISEDRIVE COPY SUPPLIED DRIVER NAME           02300000
         MVC   ISEDRIVE,=CL8' '     SHOW NO DRIVER NAME                 02310000
         B     DRVRSCAN             VALIDATE SUPPLIED DRIVER NAME       02320000
                                                                        02330000
NOSOLDRV DS    0H                                                       02340000
                                                                        02350000
*                                                                       02360000
* DETERMINE DRIVER NAME FROM LOGON USERDATA                             02370000
*---------------------------------------------------------------------- 02380000
                                                                        02390000
         MVC   ISEDRIVE,=CL8' '      SHOW NO DRIVER NAME                02400000
         LA    R1,WRK256             ADDRESS OF USERDATA                02410000
         LR    R15,R1                SAVE BEGINNING ADDRESS             02420000
         ICM   R0,15,SUB0SAVE        LENGTH OF USERDATA                 02430000
         BNP   DRVRFIND              BRANCH IF NO USERDATA OVERRIDE     02440000
         OC    WRK256(256),=CL256' ' CONVERT TO UPPERCASE               02450000
         SR    R2,R2                 ACCUMULATE LENGTH OF NAME          02460000
                                                                        02470000
         CLI   0(R1),C'('         PL/1 FORMAT USERDATA?                 02480000
         BNE   DRVRNAME           BRANCH IF NOT                         02490000
         LA    R1,1(,R1)          BUMP PAST PAREN                       02500000
         LR    R15,R1             SAVE BEGINNING ADDRESS                02510000
         BCT   R0,DRVRNAME        AND DETERMINE THE NAME                02520000
         B     DRVRFIND           USE THE DEFAULT                       02530000
                                                                        02540000
DRVRNAME DS    0H                                                       02550000
                                                                        02560000
         CLI   0(R1),C'A'         UPPERCASE ALPHA-NUMERIC?              02570000
         BL    DRVRNMED           BRANCH IF NOT                         02580000
         LA    R1,1(,R1)          POINT AT NEXT CHARACTER               02590000
         LA    R2,1(,R2)          INCREMENT THE LENGTH                  02600000
         BCT   R0,DRVRNAME        AND ISOLATE A NAME                    02610000
                                                                        02620000
DRVRNMED DS    0H                                                       02630000
                                                                        02640000
         LTR   R2,R2              SOMETHING THAT MIGHT BE A NAME?       02650000
         BNP   DRVRFIND           BRANCH IF NOT, USE DEFAULT            02660000
         C     R2,=F'8'           IS THE NAME TOO LONG?                 02670000
         BNH   DRVRCOPY           BRANCH IF NOT                         02680000
         LA    R2,8               JUST LOOK AT THE FIRST 8-BYTES        02690000
                                                                        02700000
DRVRCOPY DS    0H                                                       02710000
                                                                        02720000
         MVC   DRIVERNM(8),=CL256' ' BLANK IT OUT                       02730000
         BCTR  R2,0               LENGTH CODE OF NAME                   02740000
         EX    R2,DRVRMVC         COPY THE NAME                         02750000
                                                                        02760000
DRVRSCAN DS    0H                                                       02770000
                                                                        02780000
         LA    R2,DRVRTABL        TABLE OF DRIVER NAMES                 02790000
         LA    R0,DRVRSIZE        NUMBER OF ENTRIES                     02800000
                                                                        02810000
DRVRLOOK DS    0H                                                       02820000
                                                                        02830000
         CLC   DRIVERNM(8),0(R2)  IS THERE A MATCH?                     02840000
         BE    DRVRMTCH           BRANCH IF YES                         02850000
         LA    R2,L'DRVRNTRY(,R2) POINT AT NEXT ENTRY                   02860000
         BCT   R0,DRVRLOOK        AND CHECK THE NEXT ENTRY              02870000
         B     DRVRFIND           NOT FOUND, USE THE DEFAULT            02880000
                                                                        02890000
DRVRMTCH DS    0H                                                       02900000
                                                                        02910000
         LR    R4,R2              DRIVER ENTRY TO  USE                  02920000
                                                                        02930000
DRVRFIND DS    0H                                                       02940000
                                                                        02950000
         MVC   ISEDRIVE,0(R4)     SET THE DRIVER NAME FOR SESSION       02960000
         L     R15,8(,R4)         DRIVER RESOLUTION ROUTINE             02970000
         BASR  R14,R15            CALL RESOLUTION ROUTINE               02980000
         ST    R1,ISEDRVEP        SET DRIVER ENTRY ADDRESS              02990000
         B     DRVRSET            USE THE SPECIFIED DRIVER              03000000
                                                                        03010000
DRVRMVC  MVC   DRIVERNM(*-*),0(R15) LEFT-JUSTIFIED, BLANK-PADDED        03020000
                                                                        03030000
DRVRTABL DS    0F                                                       03040000
DRVRPDEF DC    CL8'HLLAPI  ',A(DRVR1),X'80000000'  3270                 03050000
DRVRNTRY EQU   DRVRTABL,*-DRVRTABL                                      03060000
         DC    CL8'ISLUDRV ',A(DRVR6),X'80000000'  3270                 03070000
         DC    CL8'TESTLU2 ',A(DRVR2),X'80000000'  3270                 03080000
DRVRSDEF DC    CL8'TESTSU2 ',A(DRVR3),X'C0000000'  3270,SLU             03090000
         DC    CL8'TESTSIN ',A(DRVR4),X'00000000'                       03100000
         DC    CL8'TESTPIN ',A(DRVR5),X'00000000'                       03110000
         DC    CL8'ISYSDRVR',A(DRVR7),X'00000000'                       03120000
DRVR62DF DC    CL8'IL62DRVR',A(DRVR8),X'00000000'                       03130000
DRVRSIZE EQU   (*-DRVRTABL)/L'DRVRNTRY                                  03140000
                                                                        03150000
DRVR1    L     R1,#HXPSERV        HLLAPI DRIVER                         03160000
         BR    R14                RETURN                                03170000
DRVR2    L     R1,IVT@TPL2        TEST PLU LU2 DRIVER                   03180000
         BR    R14                RETURN                                03190000
DRVR3    L     R1,IVT@TSL2        TEST SLU LU2 DRIVER                   03200000
         BR    R14                RETURN                                03210000
DRVR4    L     R1,IVT@TSIN        TEST SLU INTEGRATOR DRIVER            03220000
         BR    R14                RETURN                                03230000
DRVR5    L     R1,IVT@TPIN        TEST PLU INTEGRATOR DRIVER            03240000
         BR    R14                RETURN                                03250000
DRVR6    L     R1,#SLUDRV         SLU LU0/2 INTEGRATOR DRIVER           03260000
         BR    R14                RETURN                                03270000
DRVR7    L     R1,ISY@DRVR        INTEGRATOR TO INTEGRATOR DRIVER       03280000
         BR    R14                RETURN                                03290000
DRVR8    L     R1,IL6@DRVR        LU6.2 DRIVER                          03300000
         BR    R14                RETURN                                03310000
                                                                        03320000
DRVRSET  DS    0H                                                       03330000
                                                                        03340000
*---------------------------------------------------------------------- 03350000
* ISSUE GENERAL INFORMATION MESSAGE                                     03360000
*---------------------------------------------------------------------- 03370000
                                                                        03380000
         MVC   PLUNAME(8),ISEILUNM   ASSUME WE ARE PLU                  03390000
         MVC   SLUNAME(8),ISERLUNM   ASSUME THEY ARE THE SLU            03400000
         TM    ISEF2,ISEF2SLU        ARE WE THE SLU?                    03410000
         BNO   MESS17                BRANCH IF NOT                      03420000
         MVC   PLUNAME(8),ISERLUNM   WE ARE SLU                         03430000
         MVC   SLUNAME(8),ISEILUNM   THEY ARE THE PLU                   03440000
                                                                        03450000
MESS17   DS    0H                                                       03460000
                                                                        03470000
         $MSG  017,               "VTAM ISESS PROCESS STARTED..."      +03480000
               FIELDS=((RISESS),     ISESS ADDRESS                     +03490000
               (ISETKUSR,4),         IVUSER TOKEN                      +03500000
               (ISETKSES,4),         ISESS  TOKEN                      +03510000
               (RITASK),             ITASK ADDRESS                     +03520000
               (TSKPCBC,4),          IPROC ADDRESS                     +03530000
               (TSKNAME,8),          ITASK NAME                        +03540000
               (ISECID,4),           CID                               +03550000
               (PLUNAME,8),          PLU NAME                          +03560000
               (SLUNAME,8),          SLU NAME                          +03570000
               (ISEDRIVE,8))         DRIVER NAME                        03580000
                                                                        03590000
*---------------------------------------------------------------------- 03600000
* CALL FOR 3270 INITIALIZATION IF APPROPRIATE                           03610000
*---------------------------------------------------------------------- 03620000
                                                                        03630000
         CLI   BINLUP,BINLUP2C    LU2 SESSION?                          03640000
         BE    CALLSD02           BRANCH IF YES                         03650000
         CLI   BINLUP,BINLUP0C    LU0 SESSION?                          03660000
         BNE   STARTDRV           BRANCH IF NOT                         03670000
         TM    12(R4),X'80'       IS DRIVER FLAGGED AS 3270 DRIVER?     03680000
         BNO   STARTDRV           BRANCH IF NOT                         03690000
         TM    12(R4),X'40'       IS DRIVER FLAGGED AS A SLU DRIVER?    03700000
         BNO   CALLSD02           BRANCH IF NOT                         03710000
                                                                        03720000
         $VTAMWE L'IWEXH,         LENGTH                               +03730000
               IWECENDS           CODE, KILL VIRTUAL 3270 SLU 0         03740000
                                                                        03750000
         LA    R0,ISEWEQ          QUEUE ADDRESS                         03760000
         BAS   R14,QWE            QUEUE THE WORK ELEMENT                03770000
                                                                        03780000
         $MSG  970,               "VTAM DRIVER TOKEN...VIRTUAL LU0..." +03790000
               FIELDS=((ISETK,4),    SESSION TOKEN                     +03800000
               (ISETK+4,4),          SESSION TOKEN PART2               +03810000
               (RITASK),             ITASK ADDRESS                     +03820000
               (TSKPCBC,4),          IPROC ADDRESS                     +03830000
               (TSKNAME,8))          ITASK NAME                         03840000
                                                                        03850000
         B     RETURN                                                   03860000
                                                                        03870000
CALLSD02 DS    0H                                                       03880000
                                                                        03890000
         L     R15,IVT@SD02       3270 INITIALIZATION ROUTINE           03900000
         BASR  R14,R15            PERFORM LU0/LU2 3270 INITIALIZATION   03910000
         B     RETURN                                                   03920000
                                                                        03930000
*---------------------------------------------------------------------- 03940000
* IF FURTHER INITIALIZATION IS NOT REQUIRED START THE DRIVER PROCESS    03950000
*---------------------------------------------------------------------- 03960000
                                                                        03970000
STARTDRV DS    0H                                                       03980000
                                                                        03990000
         L     R15,IVT@SDST       DRIVER START ROUTINE                  04000000
         BASR  R14,R15            START THE SELECTED DRIVER             04010000
         B     RETURN                                                   04020000
                                                                        04030000
*---------------------------------------------------------------------- 04040000
* RETURN TO CALLER                                                      04050000
*---------------------------------------------------------------------- 04060000
                                                                        04070000
RETURN   DS    0H                                                       04080000
                                                                        04090000
         LM    R15,R1,RETREGS     LOAD RETURN VALUES                    04100000
                                                                        04110000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    04120000
                                                                        04130000
*---------------------------------------------------------------------- 04140000
* SUBROUTINE QWE - QUEUE A WORK ELEMENT TO A GIVEN WORK QUEUE           04150000
*                                                                       04160000
* ENTRY            R14 = RETURN ADDRESS                                 04170000
*                  R1  = WORK ELEMENT ADDRESS                           04180000
*                  R0  = QUEUE ADDRESS                                  04190000
*                                                                       04200000
* RETURNS          R15 = 0 --> QUEUEING WAS SUCCESSFUL                  04210000
*                      = 4 --> QUEUEING FAILED, WORK ELEMENT RELEASED   04220000
*---------------------------------------------------------------------- 04230000
                                                                        04240000
QWE      DS    0H                                                       04250000
                                                                        04260000
         STM   R14,R4,SUB0SAVE    SAVE REGISTERS                        04270000
         LR    R3,R0              SAVE QUEUE ADDRESS                    04280000
         LR    R4,R1              SAVE WORK ELEMENT ADDRESS             04290000
                                                                        04300000
         $VTAMQ (R4),             WORK ELEMENT                         +04310000
               (R3)               QUEUE                                 04320000
                                                                        04330000
         L     R14,SUB0SAVE       RESTORE REGISTERS                     04340000
         LM    R0,R4,SUB0SAVE+8   RESTORE REGISTERS                     04350000
         BR    R14                AND RETURN TO CALLER W/R15            04360000
                                                                        04370000
*---------------------------------------------------------------------- 04380000
* SUBROUTINE VTAMLOCK - OBTAIN VTAM GLOBAL LOCK                         04390000
*---------------------------------------------------------------------- 04400000
                                                                        04410000
VTAMLOCK DS    0H                                                       04420000
                                                                        04430000
         TM    FLAG,FLAGLOCK        HAVE WE ALREADY OBTAINED THE LOCK?  04440000
         BOR   R14                  RETURN IF YES                       04450000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             04460000
                                                                        04470000
         $SER  OBTAIN,                                                 +04480000
               VTAM                                                     04490000
                                                                        04500000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              04510000
         BNE   VTAMLOEX             BRANCH IF NOT                       04520000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         04530000
                                                                        04540000
VTAMLOEX DS    0H                                                       04550000
                                                                        04560000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               04570000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          04580000
         BR    R14                  RETURN                              04590000
                                                                        04600000
*---------------------------------------------------------------------- 04610000
* SUBROUTINE VTAMUNLK - RELEASE VTAM GLOBAL LOCK                        04620000
*---------------------------------------------------------------------- 04630000
                                                                        04640000
VTAMUNLK DS    0H                                                       04650000
                                                                        04660000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       04670000
         BNOR  R14                  BRANCH IF NOT                       04680000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             04690000
         BOR   R14                  DON'T RELEASE IF IT WAS             04700000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             04710000
                                                                        04720000
         $SER  RELEASE,                                                +04730000
               VTAM                                                     04740000
                                                                        04750000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  04760000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          04770000
         BR    R14                  RETURN                              04780000
                                                                        04790000
*---------------------------------------------------------------------- 04800000
*   SUBROUTINE: OBTAIN DISP GLOBAL LOCK                                 04810000
*---------------------------------------------------------------------- 04820000
                                                                        04830000
DISPLOCK DS    0H                                                       04840000
                                                                        04850000
         TM    FLAG,FLAGDLCK        WAS THE LOCK ALREADY OBTAINED?      04860000
         BOR   R14                  RETURN IF YES                       04870000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             04880000
                                                                        04890000
         $SER  OBTAIN,                                                 +04900000
               DISP                                                     04910000
                                                                        04920000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              04930000
         BNE   DISPLOEX             BRANCH IF NOT                       04940000
         OI    FLAG,FLAGDLKD        REMEMBER LOCK HELD ON ENTRY         04950000
                                                                        04960000
DISPLOEX DS    0H                                                       04970000
                                                                        04980000
         OI    FLAG,FLAGDLCK        REMEMBER LOCK IS HELD               04990000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          05000000
         BR    R14                  RETURN                              05010000
                                                                        05020000
*---------------------------------------------------------------------- 05030000
*   SUBROUTINE: RELEASE DISP GLOBAL LOCK                                05040000
*---------------------------------------------------------------------- 05050000
                                                                        05060000
DISPUNLK DS    0H                                                       05070000
                                                                        05080000
         TM    FLAG,FLAGDLCK        IS LOCK HELD?                       05090000
         BNOR  R14                  BRANCH IF NOT                       05100000
         TM    FLAG,FLAGDLKD        WAS LOCK HELD ON ENTRY?             05110000
         BOR   R14                  DON'T RELEASE IF IT WAS             05120000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             05130000
                                                                        05140000
         $SER  RELEASE,                                                +05150000
               DISP                                                     05160000
                                                                        05170000
         NI    FLAG,255-FLAGDLCK    SHOW LOCK NOT HELD                  05180000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          05190000
         BR    R14                  RETURN                              05200000
                                                                        05210000
*---------------------------------------------------------------------- 05220000
* ERROR ROUTINES                                                        05230000
*---------------------------------------------------------------------- 05240000
                                                                        05250000
ERR$SESS DS    0H                                                       05260000
                                                                        05270000
         $ABEND ABE_VTDIAG,                                            +05280000
               SCOPE=PCB,                                              +05290000
               TITLE='$SESS FAILURE'                                    05300000
                                                                        05310000
*---------------------------------------------------------------------- 05320000
*  CONSTANTS AND LITERALS                                               05330000
*---------------------------------------------------------------------- 05340000
                                                                        05350000
         LTORG ,                                                        05360000
         PRINT NOGEN                                                    05370000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                05380000
         ISTDBIND ,               VTAM BIND IMAGE                       05390000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         05400000
         ICVT  ,                  INTEGRATOR CVT                        05410000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   05420000
         IRPL ,                   INTEGRATOR VTAM RPL+                  05430000
         IACB ,                   INTEGRATOR VTAM ACB+                  05440000
         INIB ,                   INTEGRATOR VTAM NIB+                  05450000
         ISESS ,                  INTEGRATOR SESSION BLOCK              05460000
         ISQE ,                   INTEGRATOR SESS INIT QUEUE ELEMENT    05470000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            05480000
         ITASK ,                  INTEGRATOR TASK BLOCK                 05490000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          05500000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       05510000
         EVCODES ,                INTEGRATOR EVENT CODES                05520000
         ABCODES ,                INTEGRATOR $ABEND CODES               05530000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     05540000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        05550000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             05560000
         $PROC DSECT=YES          INTEGRATOR $PROC SERVICES             05570000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             05580000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             05590000
         $WULOC DSECT=YES         INTEGRATOR $WULOC SERVICES            05600000
         IFGEXLST ,               VTAM EXIT LIST                        05610000
         END   ,                                                        05620000

IL62SBND TITLE 'INTEGRATOR - ISESS LU6.2 BIND PROCESSING'               00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: IL62SBND - ISESS LU6.2 BIND PROCESSING                       00100000
*                                                                       00110000
* DESCRIPTION: THIS ROUTINE IS CALLED TO PERFORM LU6.2 SPECIFIC         00120000
*              ACTIVITY JUST PRIOR TO ISSUING AN OPNSEC TO ACCEPT A     00130000
*              A PENDING BIND OR AN OPNDST TO ISSUE A BIND.             00140000
*                                                                       00150000
* ON ENTRY:                                                             00160000
*                                                                       00170000
*    R15 = ENTRY POINT ADDRESS                                          00180000
*    R14 = RETURN ADDRESS                                               00190000
*    R13 = AVAILABLE SAVE AREA                                          00200000
*    R11 = ICVT ADDRESS                                                 00210000
*    R10 = ITASK ADDRESS                                                00220000
*    R09 = IVTAMCVT ADDRESS                                             00230000
*    R08 = ISESS ADDRESS                                                00240000
*    R07 = IACB  ADDRESS                                                00250000
*    R06 = IRPL  ADDRESS                                                00260000
*    R05 = IBQE (PENDING BIND) OR IWE (PENDING CINIT)                   00270000
*    R04 = INIB  ADDRESS                                                00280000
*    R01 = 0 --> PENDING BIND                                           00290000
*        = -1--> PENDING CINIT                                          00300000
*                                                                       00310000
* ON EXIT:                                                              00320000
*                                                                       00330000
*    R15 = 0 --> CONTINUE WITH SESSION ACCEPTANCE                       00340000
*        = 4 --> REJECT THE SESSION                                     00350000
*    R00 = 0                                                            00360000
*    R01 = 0                                                            00370000
*                                                                       00380000
*    ALL OTHER REGISTERS ARE RESTORED.                                  00390000
*                                                                       00400000
**<DOC-OFF>************************************************************ 00410000
                                                                        00420000
         EJECT ,                                                        00430000
*********************************************************************** 00440000
*                                                                       00450000
* MAINTENANCE:                                                          00460000
*                                                                       00470000
*   07/01/94 RANDY WITEK - LU6.2 SUPPORT                                00480000
*                                                                       00490000
*********************************************************************** 00500000
                                                                        00510000
         EQUS  ,                  GENERAL EQUATES                       00520000
                                                                        00530000
RICVT    EQU   R11                                                      00540000
RITASK   EQU   R10                                                      00550000
RIVTAM   EQU   R9                                                       00560000
RISESS   EQU   R8                                                       00570000
RIACB    EQU   R7                                                       00580000
RIRPL    EQU   R6                                                       00590000
RINIB    EQU   R4                                                       00600000
RIBN     EQU   R3                                                       00610000
                                                                        00620000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00630000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00640000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00650000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00660000
         USING IACB,RIACB         ESTABLISH ADDRESSABILITY              00670000
         USING IRPL,RIRPL         ESTABLISH ADDRESSABILITY              00680000
         USING ISTDNIB,RINIB      ESTABLISH ADDRESSABILITY              00690000
         USING IBN,RIBN           ESTABLISH ADDRESSABILITY              00700000
         USING ISTDBIND,IBNDPARM  ESTABLISH ADDRESSABILITY              00710000
                                                                        00720000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00730000
WRK256   DS    XL256              GENERAL WORKAREA                      00740000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00750000
RETR15   DS    F                                                        00760000
RETR0    DS    F                                                        00770000
RETR1    DS    F                                                        00780000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00790000
FLAG     DS    X                                                        00800000
FLAGBIND EQU   X'80'              1=BIND, 0=CINIT                       00810000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00820000
                                                                        00830000
         $MSGDFT PREFIX=ICTPID,                                        +00840000
               COMPID='VTM',                                           +00850000
               TABLE=*#MSGS,                                           +00860000
               WORKA=0,                                                +00870000
               MF=(E,WRK256),                                          +00880000
               PRINT=NOGEN                                              00890000
                                                                        00900000
IL62SBND #ENTER BASE=R12,         ENTRY LINKAGE                        +00910000
               PREG=R3,           R1 --> R3                            +00920000
               AMODE=31,                                               +00930000
               RMODE=ANY                                                00940000
                                                                        00950000
*---------------------------------------------------------------------- 00960000
* SET THE BRACKET REGISTERS FOR A NEWLY INITIALIZED SESSION             00970000
*---------------------------------------------------------------------- 00980000
                                                                        00990000
         MVC   ISE62PBR,=X'8000'  PRIMARY                               01000000
         MVC   ISE62SBR,=X'0000'  SECONDARY                             01010000
         MVC   ISE62CBS,=X'8000'  CURRENT BELONGS TO PRIMARY            01020000
                                                                        01030000
*---------------------------------------------------------------------- 01040000
* DETERMINE BIND OR CINIT                                               01050000
*---------------------------------------------------------------------- 01060000
                                                                        01070000
         LTR   R3,R3              TEST THE PARM REG                     01080000
         BNZ   *+8                BRANCH IF CINIT                       01090000
         OI    FLAG,FLAGBIND      SHOW BIND PROCESSING                  01100000
                                                                        01110000
*---------------------------------------------------------------------- 01120000
* REJECT BIND OR CINIT FOR LU6.2 IF ACB IS NOT SET FOR LU6.2 SESSIONS   01130000
*---------------------------------------------------------------------- 01140000
                                                                        01150000
         TM    IACF1,IACF162      IS ACB FOR LU6.2 SESSIONS?            01160000
         BO    ACBOK              BRANCH IF YES                         01170000
                                                                        01180000
         $MSG  001,COMPID='L62',  "LU6.2 SESSION REJECT...'            +01190000
               FIELDS=((RISESS),     ISESS ADDRESS                     +01200000
               (ISETKUSR,4),         IVUSER TOKEN                      +01210000
               (ISETKSES,4),         ISESS  TOKEN                      +01220000
               (RITASK),             ITASK ADDRESS                     +01230000
               (TSKPCBC,4),          IPROC ADDRESS                     +01240000
               (TSKNAME,8),          ITASK NAME                        +01250000
               (ISEILUNM,8),         FROM ...                          +01260000
               (ISERLUNM,8),         TO ...                            +01270000
               (ISELOGMD,8),         USING LOGMODE ...                 +01280000
               (ISEPOOL,16),         USING POOL ...                    +01290000
               BADACB)               ENGLISH EXPLANATION                01300000
                                                                        01310000
         B     REJECT             REJECT THE CINIT OR BIND              01320000
                                                                        01330000
ACBOK    DS    0H                                                       01340000
                                                                        01350000
*---------------------------------------------------------------------- 01360000
* INDICATE NEGOTIABLE BIND OR BIND RESPONSE                             01370000
*---------------------------------------------------------------------- 01380000
                                                                        01390000
         OI    PROPROC2,PRONEGBD  SET NEGOTIABLE                        01400000
                                                                        01410000
*---------------------------------------------------------------------- 01420000
* ALLOCATE A BIND PARAMETERS AREA FOR BUILDING BIND OR BIND RESPONSE    01430000
*---------------------------------------------------------------------- 01440000
                                                                        01450000
         $GETSTOR L'IBNMAX,                                            +01460000
               LOC=ANY,                                                +01470000
               OWNER=(RITASK)     BIND PARAMETERS AREA                  01480000
                                                                        01490000
         LR    RIBN,R1            ADDRESSIBILITY TO BIND PARMS AREA     01500000
         ST    RIBN,IRPIBNDA      SAVE ADDRESS FOR LATER RELEASE        01510000
         MVC   IBNID,=CL8'IBNDAREA'                                     01520000
         MVC   IBNLEN,=A(L'IBNMAX)                                      01530000
         LA    R1,IBNDPARM        ADDRESS OF PARAMETERS AREA            01540000
         ST    R1,NIBNDAR         SET THE AREA ADDRESS FOR OPNSEC       01550000
                                                                        01560000
*---------------------------------------------------------------------- 01570000
* PROCESS A BIND                                                        01580000
*---------------------------------------------------------------------- 01590000
                                                                        01600000
         TM    FLAG,FLAGBIND      ARE WE PROCESSING A BIND?             01610000
         BNO   CINIT              BRANCH IF NOT                         01620000
                                                                        01630000
*                                                                       01640000
* COPY FIXED PORTION OF BIND TO BIND PARAMETERS AREA                    01650000
*---------------------------------------------------------------------- 01660000
                                                                        01670000
         USING IBQE,R5                                                  01680000
                                                                        01690000
         MVC   BINFMTY(BINCRCTL-BINFMTY),IBQRU+1                        01700000
                                                                        01710000
         DROP  R5                                                       01720000
                                                                        01730000
         MVI   BINCRCTL,X'00'     NO CRYTPOGRAPHIC CONTROL INFO         01740000
         MVI   BINPRIML,X'00'     NO PRIMARY LU NAME FIELD              01750000
         MVC   BINPRIML+1(8),=CL8' '                                    01760000
         MVI   BINPRIML+9,X'01'   ONE BYTE OF USERDATA                  01770000
         MVI   BINPRIML+10,X'00'  STRUCTURED SUBFIELDS FOLLOW           01780000
                                                                        01790000
*                                                                       01800000
* DOWNGRADE FULL-DUPLEX TO HALF-DUPLEX                                  01810000
*---------------------------------------------------------------------- 01820000
                                                                        01830000
         TM    BINCMNP2,BINHDXFF  HALF-DUPLEX-FF SPECIFIED?             01840000
         BO    ENDFDXCK           BRANCH IF YES...OK                    01850000
         NI    BINCMNP2,255-BINFMTRM                                    01860000
         OI    BINCMNP2,BINHDXFF  SELECT HALF-DUPLEX-FF                 01870000
                                                                        01880000
ENDFDXCK DS    0H                                                       01890000
                                                                        01900000
*                                                                       01910000
* SET PARTNER SECURITY CAPABILITIES AND                                 01920000
* DOWNGRADE PSERVIC FLAGS (IF NECESSARY) BASED ON OUR CAPABILITIES      01930000
*---------------------------------------------------------------------- 01940000
                                                                        01950000
         L     R15,ISEIVUSR       ASSOCIATED IVUSER BLOCK               01960000
X        USING IVUSER,R15                                               01970000
                                                                        01980000
         TM    BINFLG1,BINCLSS    ACCEPT SECURITY INFO SPECIFIED?       01990000
         BNO   ENDBCLSS           BRANCH IF NOT                         02000000
         OI    X.IVUF3,IVUF3SIA   PARTNER ACCEPTS SECURITY INFO         02010000
ENDBCLSS DS    0H                                                       02020000
                                                                        02030000
         TM    BINFLG1,BINAVFS    ACCEPT ALREADY VERIFIED SPECIFIED?    02040000
         BNO   ENDBAVFS           BRANCH IF NOT                         02050000
         OI    X.IVUF3,IVUF3AVA   PARTNER ACCEPTS ALREADY VERIFIED      02060000
ENDBAVFS DS    0H                                                       02070000
                                                                        02080000
         TM    BINFLG1,BINPV      PERSISTENT VERIFICATION SPECIFIED?    02090000
         BNO   ENDBPV             BRANCH IF NOT                         02100000
         OI    X.IVUF3,IVUF3PVA   PARTNER USES PERSISTENT VERIFICATION  02110000
ENDBPV   DS    0H                                                       02120000
                                                                        02130000
         NI    BINFLG1,255-BINSLAPS NO SESS LVL SEC PROT CM/2 V1.11     02140000
         NI    BINFLG1,B'11111011'  NO X'04' BIT         CM/2 V1.11     02150000
                                                                        02160000
         NI    BINFLG1,255-BINCLSS TURN IT OFF                          02170000
         TM    X.IVUF2,IVUF2SIA   CAN WE DO IT?                         02180000
         BNO   ENDCLSS            BRANCH IF NOT                         02190000
         OI    BINFLG1,BINCLSS    ACCEPT SECURITY INFO                  02200000
ENDCLSS  DS    0H                                                       02210000
                                                                        02220000
         NI    BINFLG1,255-BINAVFS TURN IT OFF                          02230000
         TM    X.IVUF2,IVUF2AVA   CAN WE DO IT?                         02240000
         BNO   ENDAVFS            BRANCH IF NOT                         02250000
         OI    BINFLG1,BINAVFS    ACCEPT ALREADY VERIFIED               02260000
ENDAVFS  DS    0H                                                       02270000
                                                                        02280000
         NI    BINFLG1,255-BINPV  TURN IT OFF                           02290000
         TM    X.IVUF2,IVUF2PVA   CAN WE DO IT?                         02300000
         BNO   ENDPV              BRANCH IF NOT                         02310000
         OI    BINFLG1,BINPV      ACCEPT PERSISTEN VERIFICATION         02320000
         BNO   ENDPV              BRANCH IF NOT                         02330000
ENDPV    DS    0H                                                       02340000
                                                                        02350000
         TM    BINFLG2,BINCSBK    CONF/SYNCPT/BACKOUT SPECIFIED?        02360000
         BNO   ENDCSBK            BRANCH IF NOT                         02370000
         TM    X.IVUF2,IVUF2SPB   CAN WE DO IT?                         02380000
         BO    ENDSYNC            BRANCH IF YES, LEAVE IT               02390000
         NI    BINFLG2,255-BINCSBK TURN IT OFF                          02400000
         OI    BINFLG2,BINCONF    DOWNGRADE TO CONFIRM ONLY             02410000
ENDCSBK  DS    0H                                                       02420000
         TM    BINFLG2,BINCONF    CONFIRM SPECIFIED?                    02430000
         BNO   ENDSYNC            BRANCH IF NOT                         02440000
         TM    X.IVUF2,IVUF2CFM   CAN WE DO IT?                         02450000
         BO    ENDSYNC            BRANCH IF YES, LEAVE IT               02460000
         NI    BINFLG2,255-BINCONF TURN IT OFF                          02470000
ENDSYNC  DS    0H                                                       02480000
                                                                        02490000
         TM    BINFLG2,BINRS      RECONNECT SUPPORT SPECIFIED?          02500000
         BNO   ENDRS              BRANCH IF NOT                         02510000
         TM    X.IVUF2,IVUF2REC   CAN WE DO IT?                         02520000
         BO    ENDRS              BRANCH IF YES, LEAVE IT               02530000
         NI    BINFLG2,255-BINRS  TURN IT OFF                           02540000
ENDRS    DS    0H                                                       02550000
                                                                        02560000
         TM    BINFLG2,BINPSS     PARALLEL SESSION SUPPORT?             02570000
         BNO   ENDPSS             BRANCH IF NOT                         02580000
         TM    X.IVUF1,IVUF1PSC   CAN WE DO IT?                         02590000
         BO    ENDPSS             BRANCH IF YES, LEAVE IT               02600000
         NI    BINFLG2,255-BINPSS TURN IT OFF                           02610000
         NI    BINFLG2,255-BINGDSVF TURN IT OFF                         02620000
ENDPSS   DS    0H                                                       02630000
                                                                        02640000
         DROP  X                                                        02650000
                                                                        02660000
*                                                                       02670000
* COPY AND MODIFY APPROPRIATE FIELDS FROM THE BIND USERDATA             02680000
*---------------------------------------------------------------------- 02690000
                                                                        02700000
         ICM   R1,15,ISEUDATL     ANY USERDATA?                         02710000
         BNP   UDATDONE           BRANCH IF NOT, USERDATA COMPLETE      02720000
         L     R2,ISEUDAT@        USERDATA ADDRESS                      02730000
         CLI   0(R2),X'00'        STRUCTURED SUBFIELDS?                 02740000
         BNE   UDATDONE           BRANCH IF NOT                         02750000
                                                                        02760000
         LA    R2,1(,R2)          ADDRESS OF 1ST SUBFIELD               02770000
         BCTR  R1,0               LENGTH REMAINING                      02780000
                                                                        02790000
UDATLOOP DS    0H                                                       02800000
                                                                        02810000
         LTR   R1,R1              ANY SUBFIELDS REMAINING?              02820000
         BNP   UDATDONE           BRANCH IF NOT                         02830000
         SR    R0,R0              CLEAR FOR INSERT                      02840000
         ICM   R0,B'0001',0(R2)   LENGTH OF CURRENT SUBFIELD            02850000
         BNP   REJECT             BRANCH IF SOMETHING'S FUNNY           02860000
         SR    R1,R0              LENGTH REMAINING AFTER CURRENT        02870000
         BCTR  R1,0               LENGTH REMAINING AFTER CURRENT        02880000
         LR    R14,R2             ADDRESS OF CURRENT SUBFIELD           02890000
         AR    R2,R0              ADDRESS OF NEXT VECTOR                02900000
         LA    R2,1(R2)           ADDRESS OF NEXT VECTOR                02910000
         LA    R15,UDATSFTB       USERDATA SUBFIELDS-TO-COPY TABLE      02920000
                                                                        02930000
UDATCHEK DS    0H                                                       02940000
                                                                        02950000
         CLI   0(R15),X'FF'       END OF TABLE?                         02960000
         BE    UDATNCPY           BRANCH IF YES                         02970000
         CLC   0(1,R15),1(R14)    COPY THIS SUBFIELD TO RESPONSE?       02980000
         BE    UDATCOPY           BRANCH IF MATCH, COPY THIS SUBFIELD   02990000
         LA    R15,1(,R15)        BUMP TO NEXT TABLE ENTRY              03000000
         B     UDATCHEK           AND CHECK ALL TABLE ENTRIES           03010000
                                                                        03020000
UDATSFTB DS    0H                                                       03030000
                                                                        03040000
         DC    X'000203FF'                                              03050000
                                                                        03060000
UDATNCPY DS    0H                                                       03070000
                                                                        03080000
         CLI   1(R14),X'04'       IS THIS THE FQ PLU NAME?              03090000
         BNE   UDATLOOP           BRANCH IF NOT                         03100000
         STM   R14,R1,SUB0SAVE    TEMPORARY SAVE                        03110000
         LR    R1,R0              LENGTH OF FQ NAME                     03120000
         BCTR  R1,0               LENGTH OF FQ NAME                     03130000
         LTR   R1,R1              IS THERE A NAME?                      03140000
         BNP   UDATENFQ           BRANCH IF NOT                         03150000
         ICM   R1,B'1000',=C' '   BLANK PAD THE NAME                    03160000
         LA    R0,2(,R14)         ADDRESS OF THE FQ NAME                03170000
         L     R15,ISEIVUSR       ASSOCIATED IVUSER BLOCK               03180000
X        USING IVUSER,R15                                               03190000
         STC   R1,X.IVUFQLNL      SAVE FQ NAME LENGTH                   03200000
         LA    R14,X.IVUFQLN      AREA TO SAVE FQ NAME                  03210000
         LA    R15,L'IVUFQLN      LENGTH OF FQ NAME AREA                03220000
         DROP  X                                                        03230000
         MVCL  R14,R0                                                   03240000
UDATENFQ DS    0H                                                       03250000
         LM    R14,R1,SUB0SAVE    AND CONTINUE                          03260000
         B     UDATLOOP           CONTINUE THE SCAN OF SUBFIELDS        03270000
                                                                        03280000
UDATCOPY DS    0H                                                       03290000
                                                                        03300000
         SR    R15,R15            CLEAR FOR IC                          03310000
         IC    R15,BINPRIML+9     CURRENT USERDATA LENGTH               03320000
         LA    R15,BINPRIML+10(R15) CURRENT USERDATA ADDRESS            03330000
                                                                        03340000
         ST    R3,SUB0SAVE                                              03350000
         LR    R3,R0                                                    03360000
         MVC   0(0,R15),0(R14)    COPY THE SUBFIELD TO RESPONSE AREA    03370000
         EX    R3,*-6             COPY THE SUBFIELD TO RESPONSE AREA    03380000
         L     R3,SUB0SAVE                                              03390000
                                                                        03400000
         CLI   1(R15),X'02'       MODE NAME SUBFIELD?                   03410000
         BNE   UDATNO02           BRANCH IF NOT X'02'                   03420000
         STM   R14,R1,SUB0SAVE    SAVE THOSE REGISTERS                  03430000
         LA    R0,ISELOGMD        PLACE TO PUT MODE NAME                03440000
         LA    R1,L'ISELOGMD      AND THIS IS THE LENGTH                03450000
         SR    R15,R15            CLEAR                                 03460000
         ICM   R15,B'0001',0(R14) LENGTH OF SUBFIELD                    03470000
         BCTR  R15,0              LENGTH OF NAME IN SUBFIELD            03480000
         ICM   R15,B'1000',=C' '  BLANK PAD FOR NAME                    03490000
         LA    R14,2(,R14)        ADDRESS OF THE NAME                   03500000
         MVCL  R0,R14             SAVE THE NAME IN THE ISESS            03510000
         LM    R14,R1,SUB0SAVE    RESTORE THOSE REGISTERS               03520000
UDATNO02 DS    0H                                                       03530000
                                                                        03540000
         CLC   1(2,R15),=X'0301'  SESSION INSTANCE IDENTIFIER SUBFIELD? 03550000
         BNE   UDATNO03           BRANCH IF NOT X'03'                   03560000
         MVI   2(R15),X'02'       SET FORMAT BYTE FOR RESPONSE          03570000
UDATNO03 DS    0H                                                       03580000
                                                                        03590000
         SR    R15,R15            CLEAR FOR IC                          03600000
         IC    R15,BINPRIML+9     CURRENT USERDATA LENGTH               03610000
         AR    R15,R0             UPDATE USERDATA LENGTH                03620000
         LA    R15,1(,R15)        UPDATE USERDATA LENGTH                03630000
         STC   R15,BINPRIML+9     UPDATE USERDATA LENGTH                03640000
         B     UDATLOOP           GO CHECK THE NEXT VECTOR              03650000
                                                                        03660000
UDATDONE DS    0H                                                       03670000
                                                                        03680000
*                                                                       03690000
* PUT THE FULLY QUALIFIED SLUNAME (IF AVAILABLE) IN THE USERDATA        03700000
*---------------------------------------------------------------------- 03710000
                                                                        03720000
         SR    R15,R15            CLEAR FOR IC                          03730000
         ICM   R15,B'0001',IACFQNML FQ NAME LENGTH                      03740000
         BZ    FQNMDONE           BRANCH IF NO FQ NAME                  03750000
         SR    R2,R2              CLEAR FOR IC                          03760000
         IC    R2,BINPRIML+9      CURRENT USERDATA LENGTH               03770000
         LA    R1,BINPRIML+10(R2) CURRENT USERDATA ADDRESS              03780000
         BCTR  R15,0              LENGTH CODE OF FQ NAME                03790000
         MVC   2(0,R1),IACFQNM    COPY FQ SLU NAME TO RESPONSE          03800000
         EX    R15,*-6            COPY FQ SLU NAME TO RESPONSE          03810000
         MVI   1(R1),X'05'        IDENTIFY FQ SLU NAME SUBFIELD         03820000
         LA    R14,2(,R15)        SUBFIELD LENGTH                       03830000
         STC   R14,0(R1)          SET FQ SLU NAME SUBFIELD LENGTH       03840000
         LA    R2,1(R14,R2)       UPDATE CURRENT USERDATA LENGTH        03850000
         STC   R2,BINPRIML+9      UPDATE USERDATA LENGTH                03860000
                                                                        03870000
FQNMDONE DS    0H                                                       03880000
                                                                        03890000
*                                                                       03900000
* CORRECT USERDATA LENGTH TO ZERO IF NO USERDATA WAS SET IN RESPONSE    03910000
*---------------------------------------------------------------------- 03920000
                                                                        03930000
         CLI   BINPRIML+9,X'01'   ANY USERDATA SET?                     03940000
         BNE   REPBIND            BRANCH IF YES, RESPONSE IS COMPLETE   03950000
         MVI   BINPRIML+9,X'00'   SHOW NO USERDATA                      03960000
         B     REPBIND            RESPONSE IS COMPLETE                  03970000
                                                                        03980000
*                                                                       03990000
* REPLACE THE BIND IMAGE IN THE ISESS IN CASE IT WAS MODIFIED           04000000
*---------------------------------------------------------------------- 04010000
                                                                        04020000
REPBIND  DS    0H                                                       04030000
                                                                        04040000
         MVC   ISEBIND(L'ISEBIND),BINFMTY REPLACE ISESS COPY            04050000
         B     RETURN                     RETURN TO SEND BIND RESPONSE  04060000
                                                                        04070000
*---------------------------------------------------------------------- 04080000
* PROCESS A CINIT                                                       04090000
*---------------------------------------------------------------------- 04100000
                                                                        04110000
CINIT    DS    0H                                                       04120000
                                                                        04130000
*                                                                       04140000
* COPY FIXED PORTION OF CINIT TO BIND PARAMETERS AREA                   04150000
*---------------------------------------------------------------------- 04160000
                                                                        04170000
         USING IWEVTAM,R5                                               04180000
                                                                        04190000
         MVC   BINFMTY(BINCRCTL-BINFMTY),IWEX2RU+12                     04200000
                                                                        04210000
         DROP  R5                                                       04220000
                                                                        04230000
         MVI   BINCRCTL,X'00'     NO CRYTPOGRAPHIC CONTROL INFO         04240000
         MVI   BINPRIML,X'00'     NO PRIMARY LU NAME FIELD              04250000
         MVC   BINPRIML+1(8),=CL8' '                                    04260000
         MVI   BINPRIML+9,X'01'   ONE BYTE OF USERDATA                  04270000
         MVI   BINPRIML+10,X'00'  STRUCTURED SUBFIELDS FOLLOW           04280000
                                                                        04290000
*                                                                       04300000
* DOWNGRADE FULL-DUPLEX TO HALF-DUPLEX                                  04310000
*---------------------------------------------------------------------- 04320000
                                                                        04330000
         TM    BINCMNP2,BINHDXFF  HALF-DUPLEX-FF SPECIFIED?             04340000
         BO    DNEFDXCK           BRANCH IF YES...OK                    04350000
         NI    BINCMNP2,255-BINFMTRM                                    04360000
         OI    BINCMNP2,BINHDXFF  SELECT HALF-DUPLEX-FF                 04370000
                                                                        04380000
DNEFDXCK DS    0H                                                       04390000
                                                                        04400000
*                                                                       04410000
* SET PSERVIC FLAGS BASED ON OUR CAPABILITIES                           04420000
*---------------------------------------------------------------------- 04430000
                                                                        04440000
         L     R15,ISEIVUSR       ASSOCIATED IVUSER BLOCK               04450000
X        USING IVUSER,R15                                               04460000
                                                                        04470000
         NI    BINFLG1,255-BINCLSS TURN IT OFF                          04480000
         TM    X.IVUF2,IVUF2SIA    SECURITY INFORMATION ACCEPTED?       04490000
         BNO   DNECLSS             BRANCH IF NOT                        04500000
         OI    BINFLG1,BINCLSS     TURN IT ON                           04510000
DNECLSS  DS    0H                                                       04520000
                                                                        04530000
         NI    BINFLG1,255-BINAVFS TURN IT OFF                          04540000
         TM    X.IVUF2,IVUF2AVA    ALREADY VERIFIED ACCEPTED?           04550000
         BNO   DNEAVFS             BRANCH IF NOT                        04560000
         OI    BINFLG1,BINAVFS     TURN IT ON                           04570000
DNEAVFS  DS    0H                                                       04580000
                                                                        04590000
         NI    BINFLG1,255-BINPV   TURN IT OFF                          04600000
         TM    X.IVUF2,IVUF2PVA    PERSISTENT VERIFICATION?             04610000
         BNO   DNEPV               BRANCH IF NOT                        04620000
         OI    BINFLG1,BINPV       TURN IT ON                           04630000
DNEPV    DS    0H                                                       04640000
                                                                        04650000
         TM    BINFLG1,BINCLSS    ACCEPT SECURITY INFO SPECIFIED?       04660000
         BNO   ENDCCLSS           BRANCH IF NOT                         04670000
         OI    X.IVUF3,IVUF3SIA   PARTNER ACCEPTS SECURITY INFO         04680000
ENDCCLSS DS    0H                                                       04690000
                                                                        04700000
         TM    BINFLG1,BINAVFS    ACCEPT ALREADY VERIFIED SPECIFIED?    04710000
         BNO   ENDCAVFS           BRANCH IF NOT                         04720000
         OI    X.IVUF3,IVUF3AVA   PARTNER ACCEPTS ALREADY VERIFIED      04730000
ENDCAVFS DS    0H                                                       04740000
                                                                        04750000
         TM    BINFLG1,BINPV      PERSISTENT VERIFICATION SPECIFIED?    04760000
         BNO   ENDCPV             BRANCH IF NOT                         04770000
         OI    X.IVUF3,IVUF3PVA   PARTNER USES PERSISTENT VERIFICATION  04780000
ENDCPV   DS    0H                                                       04790000
                                                                        04800000
         NI    BINFLG2,255-BINCSBK TURN IT OFF                          04810000
         NI    BINFLG2,255-BINCONF TURN IT OFF                          04820000
         TM    X.IVUF2,IVUF2SPB    CAN WE DO IT ALL?                    04830000
         BNO   DNECSBK             BRANCH IF NOT                        04840000
         OI    BINFLG2,BINCONF     CONFIRM SUPPORTED                    04850000
         OI    BINFLG2,BINCSBK     CONFIRM/SYNCPT/BACKOUT SUPPORTED     04860000
         B     DNESYNC             AND WE'RE DONE                       04870000
DNECSBK  DS    0H                                                       04880000
         TM    X.IVUF2,IVUF2CFM    CAN WE DO CONFIRM?                   04890000
         BNO   DNESYNC             BRANCH IF NOT                        04900000
         OI    BINFLG2,BINCONF     CONFIRM SUPPORTED                    04910000
DNESYNC  DS    0H                                                       04920000
                                                                        04930000
         NI    BINFLG2,255-BINRS   TURN IT OFF                          04940000
         TM    X.IVUF2,IVUF2REC    RECONNECT SUPPORTED?                 04950000
         BNO   DNERS               BRANCH IF NOT                        04960000
         OI    BINFLG2,BINRS       RECONNECT SUPPORTED                  04970000
DNERS    DS    0H                                                       04980000
                                                                        04990000
         NI    BINFLG2,255-BINPSS   TURN IT OFF                         05000000
         NI    BINFLG2,255-BINGDSVF TURN IT OFF                         05010000
         TM    X.IVUF1,IVUF1PSC     PARALLEL SESSION CAPABLE?           05020000
         BNO   DNEPSS               BRANCH IF NOT                       05030000
         OI    BINFLG2,BINPSS       PARALLEL SESSION CAPABLE            05040000
         OI    BINFLG2,BINGDSVF     CNOS SUPPORTED                      05050000
         NI    BINFLG2,255-BINRSR   CLEAR SESS RE-INITIATION FLAGS      05060000
DNEPSS   DS    0H                                                       05070000
                                                                        05080000
         DROP  X                                                        05090000
                                                                        05100000
*                                                                       05110000
* SET FIRST-SPEAKER BASED ON THE SESSION REQUEST                        05120000
*---------------------------------------------------------------------- 05130000
                                                                        05140000
         NI    BINCMNP2,255-BINBKFS TURN IT OFF (SLU IS FIRST SPEAKER)  05150000
         TM    ISEF4,ISEF4FSP       FIRST-SPEAKER SESSION REQUESTED?    05160000
         BNO   DNEFSP               BRANCH IF NOT                       05170000
         OI    BINCMNP2,BINBKFS     PLU (THIS SIDE) WILL BE 1ST-SPEAKER 05180000
DNEFSP   DS    0H                                                       05190000
                                                                        05200000
*                                                                       05210000
* PUT THE LOGMODE NAME (IF AVAILABLE) IN THE USERDATA                   05220000
*---------------------------------------------------------------------- 05230000
                                                                        05240000
         SR    R15,R15            ACCUMULATE MODE NAME LENGTH           05250000
         LA    R14,ISELOGMD       ADDRESS OF MODE NAME                  05260000
         LA    R2,8               MAX OF 8 CHARACTERS                   05270000
                                                                        05280000
MODELP   DS    0H                                                       05290000
                                                                        05300000
         CLI   0(R14),C' '        CHECK FOR VALID CHARACTER             05310000
         BNH   MODELPDN           BRANCH IF END REACHED                 05320000
         LA    R14,1(,R14)        BUMP POINTER IN MODE NAME             05330000
         LA    R15,1(,R15)        BUMP COUNT OF MODE NAME LENGTH        05340000
         BCT   R2,MODELP          DETERMINE TRUE LENGTH OF MODE NAME    05350000
                                                                        05360000
MODELPDN DS    0H                                                       05370000
                                                                        05380000
         LTR   R15,R15            WAS THERE A MODE NAME?                05390000
         BNP   MODEDONE           BRANCH IF NOT                         05400000
         SR    R2,R2              CLEAR FOR IC                          05410000
         IC    R2,BINPRIML+9      CURRENT USERDATA LENGTH               05420000
         LA    R1,BINPRIML+10(R2) CURRENT USERDATA ADDRESS              05430000
         BCTR  R15,0              LENGTH CODE OF MODE NAME              05440000
         MVC   2(0,R1),ISELOGMD   COPY MODE NAME TO USERDATA            05450000
         EX    R15,*-6            COPY MODE NAME TO USERDATA            05460000
         MVI   1(R1),X'02'        IDENTIFY MODE NAME SUBFIELD           05470000
         LA    R14,2(,R15)        SUBFIELD LENGTH                       05480000
         STC   R14,0(R1)          SET MODE NAME SUBFIELD LENGTH         05490000
         LA    R2,1(R14,R2)       UPDATE CURRENT USERDATA LENGTH        05500000
         STC   R2,BINPRIML+9      UPDATE USERDATA LENGTH                05510000
                                                                        05520000
MODEDONE DS    0H                                                       05530000
                                                                        05540000
*                                                                       05550000
* PUT THE SESSION INSTANCE IDENTIFIER IN THE USERDATA                   05560000
*---------------------------------------------------------------------- 05570000
                                                                        05580000
         SR    R2,R2              CLEAR FOR IC                          05590000
         IC    R2,BINPRIML+9      CURRENT USERDATA LENGTH               05600000
         LA    R1,BINPRIML+10(R2) CURRENT USERDATA ADDRESS              05610000
         MVI   0(R1),X'09'        LENGTH IS 9 BYTES                     05620000
         MVI   1(R1),X'03'        IDENTIFY SESS INSTANCE ID SUBFIELD    05630000
         MVI   2(R1),X'01'        FORMAT-1 SESS INSTANCE ID SUBFIELD    05640000
         MVC   3(7,R1),ISETK+1    ID IS BYTES 1-7 OF SESSION TOKEN      05650000
         LA    R2,10(,R2)         UPDATE CURRENT USERDATA LENGTH        05660000
         STC   R2,BINPRIML+9      UPDATE USERDATA LENGTH                05670000
                                                                        05680000
*                                                                       05690000
* PUT THE FULLY QUALIFIED PLUNAME (IF AVAILABLE) IN THE USERDATA        05700000
*---------------------------------------------------------------------- 05710000
                                                                        05720000
         SR    R15,R15            CLEAR FOR IC                          05730000
         ICM   R15,B'0001',IACFQNML FQ NAME LENGTH                      05740000
         BZ    FQNMDON2           BRANCH IF NO FQ NAME                  05750000
         SR    R2,R2              CLEAR FOR IC                          05760000
         IC    R2,BINPRIML+9      CURRENT USERDATA LENGTH               05770000
         LA    R1,BINPRIML+10(R2) CURRENT USERDATA ADDRESS              05780000
         BCTR  R15,0              LENGTH CODE OF FQ NAME                05790000
         MVC   2(0,R1),IACFQNM    COPY FQ SLU NAME TO RESPONSE          05800000
         EX    R15,*-6            COPY FQ SLU NAME TO RESPONSE          05810000
         MVI   1(R1),X'04'        IDENTIFY FQ SLU NAME SUBFIELD         05820000
         LA    R14,2(,R15)        SUBFIELD LENGTH                       05830000
         STC   R14,0(R1)          SET FQ SLU NAME SUBFIELD LENGTH       05840000
         LA    R2,1(R14,R2)       UPDATE CURRENT USERDATA LENGTH        05850000
         STC   R2,BINPRIML+9      UPDATE USERDATA LENGTH                05860000
                                                                        05870000
FQNMDON2 DS    0H                                                       05880000
                                                                        05890000
*                                                                       05900000
* SET IRPL TO RECEIVE A NEGOTIABLE BIND RESPONSE                        05910000
*---------------------------------------------------------------------- 05920000
                                                                        05930000
         LA    R1,IBNDRESP        ADDRESS OF RESPONSE AREA              05940000
         ST    R1,RPLAAREA        SET RESPONSE AREA ADDRESS             05950000
         LA    R1,L'IBNDRESP      LENGTH OF RESPONSE AREA               05960000
         ST    R1,RPLAARLN        SET LENGTH OF RESPONSE AREA           05970000
                                                                        05980000
*                                                                       05990000
* REPLACE THE BIND IMAGE IN THE ISESS IN CASE IT WAS MODIFIED           06000000
*---------------------------------------------------------------------- 06010000
                                                                        06020000
         MVC   ISEBIND(L'ISEBIND),BINFMTY                               06030000
                                                                        06040000
*                                                                       06050000
* BIND IMAGE IS COMPLETE. RETURN TO SEND BIND.                          06060000
*---------------------------------------------------------------------- 06070000
                                                                        06080000
         B     RETURN                                                   06090000
                                                                        06100000
*---------------------------------------------------------------------- 06110000
* SET RETURN CODE TO REJECT THE PENDING BIND                            06120000
*---------------------------------------------------------------------- 06130000
                                                                        06140000
REJECT   DS    0H                                                       06150000
                                                                        06160000
         MVI   RETR15+(L'RETR15-1),4     SET RC TO REJECT BIND          06170000
         B     RETURN                    AND RETURN                     06180000
                                                                        06190000
*---------------------------------------------------------------------- 06200000
* RETURN TO CALLER                                                      06210000
*---------------------------------------------------------------------- 06220000
                                                                        06230000
RETURN   DS    0H                                                       06240000
                                                                        06250000
         LM    R15,R1,RETREGS     LOAD RETURN VALUES                    06260000
                                                                        06270000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    06280000
                                                                        06290000
*---------------------------------------------------------------------- 06300000
* ERROR ROUTINES                                                        06310000
*---------------------------------------------------------------------- 06320000
                                                                        06330000
*---------------------------------------------------------------------- 06340000
*  CONSTANTS AND LITERALS                                               06350000
*---------------------------------------------------------------------- 06360000
                                                                        06370000
BADACB   DC    C'INTEGRATOR ACB NOT COMPATIBLE'                         06380000
                                                                        06390000
         LTORG ,                                                        06400000
         PRINT NOGEN                                                    06410000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                06420000
         ISTDBIND ,               VTAM BIND IMAGE                       06430000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         06440000
         ICVT  ,                  INTEGRATOR CVT                        06450000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   06460000
         IRPL ,                   INTEGRATOR VTAM RPL+                  06470000
         IACB ,                   INTEGRATOR VTAM ACB+                  06480000
         INIB ,                   INTEGRATOR VTAM NIB+                  06490000
         ISESS ,                  INTEGRATOR SESSION BLOCK              06500000
         ISQE ,                   INTEGRATOR SESS INIT QUEUE ELEMENT    06510000
         IRQE ,                   INTEGRATOR RECEIVE   QUEUE ELEMENT    06520000
         IBQE ,                   INTEGRATOR BIND      QUEUE ELEMENT    06530000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            06540000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          06550000
         ITASK ,                  INTEGRATOR TASK BLOCK                 06560000
                                                                        06570000
IBNDUMMY DSECT                                                          06580000
         IBNDAREA ,               INTEGRATOR BIND PARAMETERS AREA       06590000
                                                                        06600000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       06610000
         EVCODES ,                INTEGRATOR EVENT CODES                06620000
         ABCODES ,                INTEGRATOR $ABEND CODES               06630000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     06640000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        06650000
         END   ,                                                        06660000

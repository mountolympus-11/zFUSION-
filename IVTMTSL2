IVTMTSL2 TITLE 'INTEGRATOR - SLU LU2 SESSION DRIVER (TEST)'             00010000
**<DOC-ON>************************************************************* 00020000
*                                                                       00030000
* ROUTINE: IVTMTSL2 - SLU LU2 SESSION DRIVER (TEST)                     00040000
*                                                                       00050000
* DESCRIPTION: THE SESSION DRIVER IS STARTED AS A NEW PROC UNDER        00060000
*              THE SESSION ITASK WHEN A NEW SESSION IS ESTABLISHED.     00070000
*                                                                       00080000
* ON ENTRY:                                                             00090000
*                                                                       00100000
*    R15 = ENTRY POINT ADDRESS                                          00110000
*    R14 = RETURN ADDRESS                                               00120000
*    R13 = AVAILABLE SAVE AREA                                          00130000
*    R11 = ICVT ADDRESS                                                 00140000
*    R10 = ITASK ADDRESS                                                00150000
*    R01 = ADDRESS OF THE SESSION TOKEN                                 00160000
*                                                                       00170000
* ON EXIT:                                                              00180000
*                                                                       00190000
*    R15 = 0                                                            00200000
*    R00 = 0                                                            00210000
*    R01 = 0                                                            00220000
*                                                                       00230000
*    ALL OTHER REGISTERS ARE RESTORED.                                  00240000
*                                                                       00250000
**<DOC-OFF>************************************************************ 00260000
                                                                        00270000
         EJECT ,                                                        00280000
*********************************************************************** 00290000
*                                                                       00300000
* MAINTENANCE:                                                          00310000
*                                                                       00320000
*   08/01/93 RANDY WITEK                                                00330000
*                                                                       00340000
*********************************************************************** 00350000
                                                                        00360000
         EQUS  ,                  GENERAL EQUATES                       00370000
                                                                        00380000
RICVT    EQU   R11                                                      00390000
RITASK   EQU   R10                                                      00400000
RIVTAM   EQU   R9                                                       00410000
RSPLISTR EQU   R8                                                       00420000
RSPLISTS EQU   R7                                                       00430000
RSLUHNDL EQU   R6                                                       00440000
RSESSIMG EQU   R5                                                       00450000
RIMAGE   EQU   R4                                                       00460000
                                                                        00470000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00480000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00490000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00500000
         USING SPLIST,RSPLISTR    ESTABLISH ADDRESSABILITY              00510000
S        USING SPLIST,RSPLISTS    ESTABLISH ADDRESSABILITY              00520000
         USING SLUHANDL,RSLUHNDL  ESTABLISH ADDRESSABILITY              00530000
         USING SESSIMAG,RSESSIMG  ESTABLISH ADDRESSABILITY              00540000
                                                                        00550000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00560000
SVTOKN   DS    CL8                TOKEN COPY                            00570000
SAVEIMAG DS    A                  IMAGE BUFFER ADDRESS                  00580000
SAVESLUH DS    A                  SLUHANDL ADDRESS                      00590000
SAVESIMG DS    A                  SESSIMAG ADDRESS                      00600000
WRK256   DS    XL256              GENERAL WORKAREA                      00610000
                                                                        00620000
LV1SAVE  DS    18F                SUBROUTINE SAVE AREA                  00630000
LV0SAVE  DS    18F                SUBROUTINE SAVE AREA                  00640000
                                                                        00650000
SNASTATE DS    F                  EXTRACT AREA                          00660000
                                                                        00670000
$TASKMFL $TASK MF=L               $TASK PLIST CONSTRUCTION              00680000
$SESSRCV DS    A                  $SESS PLIST ADDRESS                   00690000
$SESSSND DS    A                  $SESS PLIST ADDRESS                   00700000
$SESSEX  $SESS MF=L,FIELDS=((SNASTATE,SNASTATE,,4))                     00710000
                                                                        00720000
RCVEPB   DS    F                  RECEIVE EPB ADDRESS                   00730000
                                                                        00740000
ECODE    DS    F                  LAST EVENT CODE                       00750000
                                                                        00760000
RETR15   DS    F                                                        00770000
RETR0    DS    F                                                        00780000
RETR1    DS    F                                                        00790000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00800000
                                                                        00810000
FLAGS    DS    X                  FLAG BYTE                             00820000
FLAGSQUI EQU   X'80'              QUIET MODE                            00830000
FLAGSRCV EQU   X'40'              $SESS RECEIVE SPLIST IS ACTIVE        00840000
FLAGSSTP EQU   X'20'              STOP REQUESTED                        00850000
                                                                        00860000
DATASAVE DS    XL4096                                                   00870000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00880000
                                                                        00890000
         $MSGDFT PREFIX=ICTPID,                                        +00900000
               COMPID='VTM',                                           +00910000
               TABLE=*#MSGS,                                           +00920000
               WORKA=0,                                                +00930000
               MF=(E,WRK256),                                          +00940000
               PRINT=NOGEN                                              00950000
                                                                        00960000
IVTMTSL2 #ENTER BASE=R12,         ENTRY LINKAGE                        +00970000
               AMODE=31,                                               +00980000
               PREG=R3,           R1 --> R3                            +00990000
               RMODE=ANY                                                01000000
                                                                        01010000
*---------------------------------------------------------------------- 01020000
* ESTABLISH ENVIRONMENT                                                 01030000
*---------------------------------------------------------------------- 01040000
                                                                        01050000
         L     RIVTAM,ICTVTCVT    IVTAMCVT ADDRESS                      01060000
         MVC   SVTOKN(8),1(R3)    COPY THE TOKEN                        01070000
                                                                        01080000
         $RETSTOR (R3),                                                +01090000
               OWNER=(RITASK)     RELEASE TOKEN STORAGE                 01100000
                                                                        01110000
*---------------------------------------------------------------------- 01120000
* SET "QUIET MODE" IF REQUESTED                                         01130000
*---------------------------------------------------------------------- 01140000
                                                                        01150000
         BAS   R14,QUIETEST       CHECK FOR QUIET MODE                  01160000
                                                                        01170000
*---------------------------------------------------------------------- 01180000
* ISSUE AN INFORMATIVE MESSAGE                                          01190000
*---------------------------------------------------------------------- 01200000
                                                                        01210000
         TM    FLAGS,FLAGSQUI     QUIET MODE?                           01220000
         BO    SKIP12             BRANCH IF YES                         01230000
                                                                        01240000
         $MSG  012,               "VTAM DRIVER TOKEN...STARTING"       +01250000
               FIELDS=((SVTOKN,4),   SESSION TOKEN                     +01260000
               (SVTOKN+4,4),         SESSION TOKEN PART2               +01270000
               (RITASK),             ITASK ADDRESS                     +01280000
               (TSKPCBC,4),          IPROC ADDRESS                     +01290000
               (TSKNAME,8))          ITASK NAME                         01300000
                                                                        01310000
SKIP12   DS    0H                                                       01320000
                                                                        01330000
*---------------------------------------------------------------------- 01340000
* INITIALIZE THE EPB FOR $SESS_RECEIVE OPERATIONS                       01350000
*---------------------------------------------------------------------- 01360000
                                                                        01370000
         $TASK SETEPB,                                                 +01380000
               ECODE=1025,                                             +01390000
               ERRET=ERR$TASK,                                         +01400000
               MF=(E,$TASKMFL)    ALLOCATE AN XEPB                      01410000
                                                                        01420000
         ST    R1,RCVEPB          SAVE XEPB ADDRESS                     01430000
                                                                        01440000
*---------------------------------------------------------------------- 01450000
* ALLOCATE SEND AND RECEIVE SPLISTS FROM ITASK STORAGE                  01460000
*---------------------------------------------------------------------- 01470000
                                                                        01480000
         $GETSTOR L'SPL,                                               +01490000
               LOC=ANY,                                                +01500000
               OWNER=(RITASK)                                           01510000
                                                                        01520000
         ST    R1,$SESSRCV                                              01530000
                                                                        01540000
         $GETSTOR L'SPL,                                               +01550000
               LOC=ANY,                                                +01560000
               OWNER=(RITASK)                                           01570000
                                                                        01580000
         ST    R1,$SESSSND                                              01590000
                                                                        01600000
*---------------------------------------------------------------------- 01610000
* ALLOCATE AN IMAGE BUFFER, A SLUHANDL, AND A SESSIMAG BLOCK            01620000
*---------------------------------------------------------------------- 01630000
                                                                        01640000
         L     R2,=A(4096)                                              01650000
                                                                        01660000
         $GETSTOR (R2),LOC=ANY          ALLOCATE IMAGE BUFFER           01670000
                                                                        01680000
         LR    RIMAGE,R1                IMAGE BUFFER ADDRESS            01690000
         ST    RIMAGE,SAVEIMAG          SAVE THE IMAGE BUFFER ADDRESS   01700000
                                                                        01710000
         L     R2,=A(SEILN)                                             01720000
                                                                        01730000
         $GETSTOR (R2),LOC=ANY          ALLOCATE SESSIMAG BLOCK         01740000
                                                                        01750000
         LR    RSESSIMG,R1              SESSIMAG                        01760000
         ST    RSESSIMG,SAVESIMG        SAVE THE ADDRESS                01770000
         MVC   SEIS1SIZ(4),=F'1920'     IMAGE LENGTH                    01780000
         MVC   SEIS1ROW(2),=H'24'       MOD2 24X80                      01790000
         MVC   SEIS1COL(2),=H'80'       MOD2 24X80                      01800000
         MVC   SEIS1IMG,SAVEIMAG        IMAGE BUFFER ADDRESS            01810000
         MVI   SEIAID,X'60'             NO AID YET                      01820000
                                                                        01830000
         MVC   SEIPRISZ(4),=F'1920'     IMAGE LENGTH                    01840000
         MVC   SEIPROWS(2),=H'24'       MOD2 24X80                      01850000
         MVC   SEIPCOLS(2),=H'80'       MOD2 24X80                      01860000
                                                                        01870000
         MVC   SEIALTSZ(4),=F'1920'     IMAGE LENGTH                    01880000
         MVC   SEIAROWS(2),=H'24'       MOD2 24X80                      01890000
         MVC   SEIACOLS(2),=H'80'       MOD2 24X80                      01900000
                                                                        01910000
         L     R2,=A(SLHLN)                                             01920000
                                                                        01930000
         $GETSTOR (R2),LOC=ANY          ALLOCATE SLUHANDL BLOCK         01940000
                                                                        01950000
         LR    RSLUHNDL,R1              SLUHANDL                        01960000
         ST    RSLUHNDL,SAVESLUH        SAVE THE ADDRESS                01970000
         ST    RSESSIMG,SLHSIMAG        SET SESSIMAG ADDRESS            01980000
         MVC   SLHSTKN(8),SVTOKN        SET SESSION TOKEN               01990000
                                                                        02000000
*---------------------------------------------------------------------- 02010000
* START THE FIRST RECEIVE                                               02020000
*---------------------------------------------------------------------- 02030000
                                                                        02040000
         $SESS $SESS_RECEIVE,                                          +02050000
               SESSION=SVTOKN,                                         +02060000
               EPB=*RCVEPB,                                            +02070000
               ERRET=ERR$RCV,                                          +02080000
               MF=(E,*$SESSRCV)                                         02090000
                                                                        02100000
         OI    FLAGS,FLAGSRCV     SHOW SPLIST IS ACTIVE                 02110000
                                                                        02120000
*---------------------------------------------------------------------- 02130000
* WAIT FOR AN EVENT TO OCCUR AND JUMP TO THE PROCESSING ROUTINE         02140000
*---------------------------------------------------------------------- 02150000
                                                                        02160000
WAITWORK DS    0H                                                       02170000
                                                                        02180000
         TM    FLAGS,FLAGSSTP     IS STOP REQUESTED?                    02190000
         BNO   WAITNOW            BRANCH IF NOT                         02200000
         TM    FLAGS,FLAGSRCV     IS $SESS RECEIVE ACTIVE?              02210000
         BO    WAITNOW            BRANCH IF YES TO WAIT FOR COMPLETION  02220000
         B     EXIT               IT IS OK TO STOP                      02230000
                                                                        02240000
WAITNOW  DS    0H                                                       02250000
                                                                        02260000
         $TASK WAIT,              WAIT FOR EVENT                       +02270000
               MF=(E,$TASKMFL)                                          02280000
                                                                        02290000
         ST    R15,ECODE          SAVE THE EVENT CODE                   02300000
                                                                        02310000
         C     R15,=A(1025)       IS A RCV COMPLETE?                    02320000
         BE    RCV                BRANCH IF YES                         02330000
                                                                        02340000
         C     R15,=A(EC$STOP)    IS PROC STOP REQUESTED?               02350000
         BE    PSTP               BRANCH IF YES                         02360000
                                                                        02370000
         C     R15,=A(EC$CNCL)    IS PROC CANCEL REQUESTED?             02380000
         BE    PCAN               BRANCH IF YES                         02390000
                                                                        02400000
         B     WAITWORK           IGNORE ANYTHING ELSE                  02410000
                                                                        02420000
*---------------------------------------------------------------------- 02430000
* PROCESS A $SESS_RECEIVE COMPLETION                                    02440000
*---------------------------------------------------------------------- 02450000
                                                                        02460000
RCV      DS    0H                                                       02470000
                                                                        02480000
         NI    FLAGS,255-FLAGSRCV SHOW SPLIST IS NOT ACTIVE             02490000
                                                                        02500000
         L     RSPLISTR,$SESSRCV  THE RECEIVE PARM LIST                 02510000
         L     RSPLISTS,$SESSSND  THE SEND    PARM LIST                 02520000
         BAS   R14,DISPRCV        DIAGNOSTIC DISPLAY                    02530000
                                                                        02540000
*                                                                       02550000
* TEST THE RETURN CODE                                                  02560000
*---------------------------------------------------------------------- 02570000
                                                                        02580000
         CLC   SPLRETCD,=A($SESS_RC_SUCCESS)                            02590000
         BE    RCVCONT                          CHECK WHAT WAS RECEIVED 02600000
                                                                        02610000
         CLC   SPLRETCD,=A($SESS_RC_FUNCTION)                           02620000
         BE    ERR$RCV                          HOW DID THIS HAPPEN     02630000
                                                                        02640000
         CLC   SPLRETCD,=A($SESS_RC_ENVIRONMENT)                        02650000
         BE    ERR$RCV                          HOW DID THIS HAPPEN     02660000
                                                                        02670000
         CLC   SPLRETCD,=A($SESS_RC_LENGTH)                             02680000
         BE    ERR$RCV                          HOW DID THIS HAPPEN     02690000
                                                                        02700000
         CLC   SPLRETCD,=A($SESS_RC_BUSY)                               02710000
         BE    ERR$RCV                          HOW DID THIS HAPPEN     02720000
                                                                        02730000
         CLC   SPLRETCD,=A($SESS_RC_CANCELED)                           02740000
         BE    WAITWORK                         WAIT FOR PROC STOP      02750000
                                                                        02760000
         CLC   SPLRETCD,=A($SESS_RC_VTAMRC)                             02770000
         BE    RCVISSUE                                                 02780000
                                                                        02790000
         CLC   SPLRETCD,=A($SESS_RC_PROTOCOL)                           02800000
         BE    RCVISSUE                                                 02810000
         B     RCVISSUE                                                 02820000
                                                                        02830000
*                                                                       02840000
* CALL $SLU2 SERVICES TO ANALYZE THE RECEIVE AND MAP DATA IF ANY        02850000
*---------------------------------------------------------------------- 02860000
                                                                        02870000
RCVCONT  DS    0H                                                       02880000
                                                                        02890000
         $SLU2 FROM_THE_PLU,                                           +02900000
               SLUHANDL=(RSLUHNDL),                                    +02910000
               SPLIST=(RSPLISTR)  CALL THE RECEIVE SERVICE              02920000
                                                                        02930000
*                                                                       02940000
* CHECK THE RECEIVED DATA                                               02950000
*---------------------------------------------------------------------- 02960000
                                                                        02970000
         TM    SPLCNTRL,RPLDATA   WAS IT A DATA REQUEST?                02980000
         BNO   RCVISSUE           BRANCH IF NOT, JUST RECEIVE AGAIN     02990000
         TM    SEIFSNA,SEIF_CMD   DO WE HAVE DIRECTION NOW?             03000000
         BNO   RCVISSUE           BRANCH IF NOT                         03010000
                                                                        03020000
BREAKPT  DS    0H                 BREAK HERE TO ANALYZE AND RESPOND     03030000
                                                                        03040000
         B     RCVISSUE           BRANCH IF NO SEND DESIRED             03050000
                                                                        03060000
*                                                                       03070000
* HAND-FILL THE IMAGE BUFFER AND LET $SLU2 SERVICES SEND IT IN          03080000
*---------------------------------------------------------------------- 03090000
                                                                        03100000
         $SLU2 TO_THE_PLU,                                             +03110000
               SLUHANDL=(RSLUHNDL),                                    +03120000
               READCMD=#3270RM    CALL THE TRANSMIT SERVICE             03130000
                                                                        03140000
*                                                                       03150000
* RE-ISSUE THE RECEIVE                                                  03160000
*---------------------------------------------------------------------- 03170000
                                                                        03180000
RCVISSUE DS    0H                                                       03190000
                                                                        03200000
         $TASK SETEPB,                                                 +03210000
               ECODE=1025,                                             +03220000
               ERRET=ERR$TASK,                                         +03230000
               MF=(E,$TASKMFL)    ALLOCATE AN XEPB                      03240000
                                                                        03250000
         ST    R1,RCVEPB          SAVE XEPB ADDRESS                     03260000
                                                                        03270000
         $SESS $SESS_RECEIVE,                                          +03280000
               SESSION=SVTOKN,                                         +03290000
               EPB=*RCVEPB,                                            +03300000
               ERRET=ERR$RCV,                                          +03310000
               MF=(E,*$SESSRCV)                                         03320000
                                                                        03330000
         OI    FLAGS,FLAGSRCV     SHOW SPLIST IS ACTIVE                 03340000
                                                                        03350000
         B     WAITWORK                                                 03360000
                                                                        03370000
*---------------------------------------------------------------------- 03380000
* PROCESS A PROC STOP REQUEST                                           03390000
*---------------------------------------------------------------------- 03400000
                                                                        03410000
PSTP     DS    0H                                                       03420000
                                                                        03430000
         OI    FLAGS,FLAGSSTP     STOP REQUESTED                        03440000
         TM    FLAGS,FLAGSQUI     QUIET MODE?                           03450000
         BO    WAITWORK           BRANCH IF YES                         03460000
                                                                        03470000
         $MSG  982,                 "DRIVER PROC STOP"                 +03480000
               FIELDS=((SVTOKN,4),   SESSION TOKEN                     +03490000
               (SVTOKN+4,4),         SESSION TOKEN PART2               +03500000
               (RITASK),             ITASK ADDRESS                     +03510000
               (TSKPCBC,4),          IPROC ADDRESS                     +03520000
               (TSKNAME,8))          ITASK NAME                         03530000
                                                                        03540000
         B     WAITWORK           WAIT FOR ORDERLY COMPLETION           03550000
                                                                        03560000
*---------------------------------------------------------------------- 03570000
* PROCESS A PROC CANCEL REQUEST                                         03580000
*---------------------------------------------------------------------- 03590000
                                                                        03600000
PCAN     DS    0H                                                       03610000
                                                                        03620000
         TM    FLAGS,FLAGSQUI     QUIET MODE?                           03630000
         BO    EXITCNCL           BRANCH IF YES                         03640000
                                                                        03650000
         $MSG  979,                 "DRIVER PROC CANCEL"               +03660000
               FIELDS=((SVTOKN,4),   SESSION TOKEN                     +03670000
               (SVTOKN+4,4),         SESSION TOKEN PART2               +03680000
               (RITASK),             ITASK ADDRESS                     +03690000
               (TSKPCBC,4),          IPROC ADDRESS                     +03700000
               (TSKNAME,8))          ITASK NAME                         03710000
                                                                        03720000
         B     EXITCNCL           END TASK IMMEDIATELY                  03730000
                                                                        03740000
*---------------------------------------------------------------------- 03750000
* EXIT TO END DRIVER PROCESS                                            03760000
*---------------------------------------------------------------------- 03770000
                                                                        03780000
EXIT     DS    0H                                                       03790000
                                                                        03800000
*                                                                       03810000
* RELEASE SEND AND RECEIVE SPLISTS FROM ITASK STORAGE                   03820000
*---------------------------------------------------------------------- 03830000
                                                                        03840000
         $RETSTOR *$SESSRCV,                                           +03850000
               OWNER=(RITASK)                                           03860000
                                                                        03870000
         $RETSTOR *$SESSSND,                                           +03880000
               OWNER=(RITASK)                                           03890000
                                                                        03900000
*                                                                       03910000
* RELEASE IMAGE BUFFER, SLUHANDL, AND SESSIMAG                          03920000
*---------------------------------------------------------------------- 03930000
                                                                        03940000
         $RETSTOR *SAVEIMAG             RELEASE IMAGE BUFFER            03950000
                                                                        03960000
         $RETSTOR *SAVESIMG             RELEASE SESSIMAG BLOCK          03970000
                                                                        03980000
         $RETSTOR *SAVESLUH             RELEASE SLUHANDL BLOCK          03990000
                                                                        04000000
*                                                                       04010000
* LOAD RETURN REGISTERS AND EXIT THE PROCESS                            04020000
*---------------------------------------------------------------------- 04030000
                                                                        04040000
EXITCNCL DS    0H                                                       04050000
                                                                        04060000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 04070000
                                                                        04080000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    04090000
                                                                        04100000
*---------------------------------------------------------------------- 04110000
* SUBROUTINE: SENDPRSP                                                  04120000
*---------------------------------------------------------------------- 04130000
                                                                        04140000
SENDPRSP DS     0H                                                      04150000
                                                                        04160000
         STM   R14,R12,LV1SAVE                                          04170000
                                                                        04180000
         $SESS $SESS_SEND_POSRESP,  SEND A RESPONSE AS NEEDED          +04190000
               SESSION=SVTOKN,                                         +04200000
               RH=*,                                                   +04210000
               SEQNO=*,                                                +04220000
               CNTRL=*,                                                +04230000
               SENSE=*,                                                +04240000
               ERRET=ERR$RCV,                                          +04250000
               MF=(E,*$SESSRCV)                                         04260000
                                                                        04270000
         BAS   R14,DISPRCV          DIAGNOSTIC DISPLAY                  04280000
                                                                        04290000
         LM    R14,R12,LV1SAVE                                          04300000
         BR    R14                                                      04310000
                                                                        04320000
*---------------------------------------------------------------------- 04330000
* SUBROUTINE: SENDNRSP                                                  04340000
*---------------------------------------------------------------------- 04350000
                                                                        04360000
SENDNRSP DS     0H                                                      04370000
                                                                        04380000
         STM   R14,R12,LV1SAVE                                          04390000
                                                                        04400000
         $SESS $SESS_SEND_NEGRESP,  SEND A NEGATIVE RESPONSE           +04410000
               SESSION=SVTOKN,                                         +04420000
               RH=*,                                                   +04430000
               SEQNO=*,                                                +04440000
               CNTRL=*,                                                +04450000
               SENSE=SNS1005,                                          +04460000
               ERRET=ERR$RCV,                                          +04470000
               MF=(E,*$SESSRCV)                                         04480000
                                                                        04490000
         BAS   R14,DISPRCV          DIAGNOSTIC DISPLAY                  04500000
                                                                        04510000
         LM    R14,R12,LV1SAVE                                          04520000
         BR    R14                                                      04530000
                                                                        04540000
SNS1005  DC    XL4'10050000'                                            04550000
                                                                        04560000
*---------------------------------------------------------------------- 04570000
* SUBROUTINE: DISPSND                                                   04580000
*---------------------------------------------------------------------- 04590000
                                                                        04600000
DISPSND  DS     0H                                                      04610000
                                                                        04620000
         STM   R14,R12,LV0SAVE                                          04630000
         L     RSPLISTS,$SESSSND                                        04640000
                                                                        04650000
         TM    FLAGS,FLAGSQUI        QUIET MODE?                        04660000
         BO    DISPSEND              BRANCH IF YES                      04670000
                                                                        04680000
DISPSOK  DS     0H                                                      04690000
                                                                        04700000
         $SESS $SESS_EXTRACT,                                          +04710000
               SESSION=SVTOKN,                                         +04720000
               FIELDS=((SNASTATE,SNASTATE,,4)),                        +04730000
               MF=(E,$SESSEX)                                           04740000
                                                                        04750000
         $MSG  978,                  "DRIVER RECEIVE COMPLETE"         +04760000
               FIELDS=((SVTOKN,4),   SESSION TOKEN                     +04770000
               (SVTOKN+4,4),         SESSION TOKEN PART2               +04780000
               (RSPLISTS),           SPLIST ADDRESS                    +04790000
               (S.SPLSENSE,4),       SENSE                             +04800000
               (S.SPLF1,4),          FLAGS                             +04810000
               (SNASTATE,4),         SESSION STATE                     +04820000
               (S.SPLAREA,4),        AREA  ADDRESS                     +04830000
               (S.SPLAREAL,4),       AREA  LENGTH                      +04840000
               (S.SPLCNTRL,3),       RPL CNTRL FLAGS                   +04850000
               (S.SPLRH,3),          RPL USERRH                        +04860000
               (S.SPLSEQNO,2),       RPL SEQNO                         +04870000
               (S.SPLRETCD,4),       THE RETURN CODE                   +04880000
               (S.SPLRSNCD,4),       THE REASON CODE                   +04890000
               (S.SPLFUNC,4))        THE FUNCTION                       04900000
                                                                        04910000
DISPSEND DS     0H                                                      04920000
                                                                        04930000
         LM    R14,R12,LV0SAVE                                          04940000
         BR    R14                                                      04950000
                                                                        04960000
*---------------------------------------------------------------------- 04970000
* SUBROUTINE: DISPRCV                                                   04980000
*---------------------------------------------------------------------- 04990000
                                                                        05000000
DISPRCV  DS     0H                                                      05010000
                                                                        05020000
         STM   R14,R12,LV0SAVE                                          05030000
         L     RSPLISTR,$SESSRCV                                        05040000
                                                                        05050000
         TM    FLAGS,FLAGSQUI        QUIET MODE?                        05060000
         BO    DISPREND              BRANCH IF YES                      05070000
                                                                        05080000
DISPROK  DS     0H                                                      05090000
                                                                        05100000
                                                                        05110000
         $SESS $SESS_EXTRACT,                                          +05120000
               SESSION=SVTOKN,                                         +05130000
               FIELDS=((SNASTATE,SNASTATE,,4)),                        +05140000
               MF=(E,$SESSEX)                                           05150000
                                                                        05160000
         $MSG  978,                  "DRIVER RECEIVE COMPLETE"         +05170000
               FIELDS=((SVTOKN,4),   SESSION TOKEN                     +05180000
               (SVTOKN+4,4),         SESSION TOKEN PART2               +05190000
               (RSPLISTR),           SPLIST ADDRESS                    +05200000
               (SPLSENSE,4),         SENSE                             +05210000
               (SPLF1,4),            FLAGS                             +05220000
               (SNASTATE,4),         SESSION STATE                     +05230000
               (SPLAREA,4),          AREA  ADDRESS                     +05240000
               (SPLAREAL,4),         AREA  LENGTH                      +05250000
               (SPLCNTRL,3),         RPL CNTRL FLAGS                   +05260000
               (SPLRH,3),            RPL USERRH                        +05270000
               (SPLSEQNO,2),         RPL SEQNO                         +05280000
               (SPLRETCD,4),         THE RETURN CODE                   +05290000
               (SPLRSNCD,4),         THE REASON CODE                   +05300000
               (SPLFUNC,4))          THE FUNCTION                       05310000
                                                                        05320000
DISPREND DS     0H                                                      05330000
                                                                        05340000
         LM    R14,R12,LV0SAVE                                          05350000
         BR    R14                                                      05360000
                                                                        05370000
*---------------------------------------------------------------------- 05380000
* SUBROUTINE: QUIETEST                                                  05390000
*---------------------------------------------------------------------- 05400000
                                                                        05410000
QUIETEST DS     0H                                                      05420000
                                                                        05430000
         STM   R14,R12,LV0SAVE                                          05440000
         L     RSPLISTS,$SESSSND                                        05450000
                                                                        05460000
         $SESS $SESS_EXTRACT,                                          +05470000
               SESSION=SVTOKN,                                         +05480000
               FIELDS=((USERDATA,WRK256,,256)),                        +05490000
               MF=(E,$SESSEX)                                           05500000
                                                                        05510000
         LA    R2,WRK256          START OF USERDATA                     05520000
         CLC   0(1,R2),C'('       PL/1 FORMAT?                          05530000
         BNE   QUICHECK           BRANCH IF NOT                         05540000
         LA    R2,1(,R2)          PAST '('                              05550000
                                                                        05560000
QUICHECK DS     0H                                                      05570000
                                                                        05580000
         CLC   8(5,R2),=C'QUIET'  QUIET MODE REQUESTED?                 05590000
         BNE   QUIDONE            BRANCH IF NOT                         05600000
         OI    FLAGS,FLAGSQUI     SET QUIET MODE                        05610000
                                                                        05620000
QUIDONE  DS     0H                                                      05630000
                                                                        05640000
         LM    R14,R12,LV0SAVE                                          05650000
         BR    R14                                                      05660000
                                                                        05670000
*---------------------------------------------------------------------- 05680000
* ERROR ROUTINES                                                        05690000
*---------------------------------------------------------------------- 05700000
                                                                        05710000
ERR$TASK DS    0H                                                       05720000
                                                                        05730000
         $ABEND ABE_VTDIAG,                                            +05740000
               SCOPE=PCB,                                              +05750000
               TITLE='$TASK FAILURE'                                    05760000
                                                                        05770000
ERR$RCV  DS    0H                                                       05780000
                                                                        05790000
         CLC   SPLRETCD,=A($SESS_RC_CANCELED)                           05800000
         BE    WAITWORK                                                 05810000
                                                                        05820000
         $ABEND ABE_VTDIAG,                                            +05830000
               SCOPE=PCB,                                              +05840000
               TITLE='$SESS RECEIVE FAILURE'                            05850000
                                                                        05860000
ERR$SEND DS    0H                                                       05870000
                                                                        05880000
         CLC   S.SPLRETCD,=A($SESS_RC_CANCELED)                         05890000
         BE    WAITWORK                                                 05900000
                                                                        05910000
         $ABEND ABE_VTDIAG,                                            +05920000
               SCOPE=PCB,                                              +05930000
               TITLE='$SESS SEND FAILURE'                               05940000
                                                                        05950000
                                                                        05960000
*---------------------------------------------------------------------- 05970000
*  CONSTANTS AND LITERALS                                               05980000
*---------------------------------------------------------------------- 05990000
                                                                        06000000
         LTORG ,                                                        06010000
         PRINT NOGEN                                                    06020000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                06030000
         ISTDBIND ,               VTAM BIND IMAGE                       06040000
         ISTRH ,                  VTAM SNA REQUEST HEADER               06050000
         ICVT  ,                  INTEGRATOR CVT                        06060000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   06070000
         IRPL ,                   INTEGRATOR VTAM RPL+                  06080000
         IACB ,                   INTEGRATOR VTAM ACB+                  06090000
         INIB ,                   INTEGRATOR VTAM NIB+                  06100000
         ISESS ,                  INTEGRATOR SESSION BLOCK              06110000
         IRQE ,                   INTEGRATOR RECEIVE QUEUE ELEMENT      06120000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            06130000
         ITASK ,                  INTEGRATOR TASK BLOCK                 06140000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          06150000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       06160000
         EVCODES ,                INTEGRATOR EVENT CODES                06170000
         ABCODES ,                INTEGRATOR $ABEND CODES               06180000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     06190000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        06200000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             06210000
         $PROC DSECT=YES          INTEGRATOR $PROC SERVICES             06220000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             06230000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             06240000
         SLUHANDL ,               INTEGRATOR SLUHANDL                   06250000
         SESSIMAG ,               INTEGRATOR SESSIMAGE                  06260000
         IFGEXLST ,               VTAM EXIT LIST                        06270000
         END   ,                                                        06280000

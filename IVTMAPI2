IVTMAPI2 TITLE 'INTEGRATOR - VTAM SERVICES API (PART 2)'                00010000
**<DOC-ON>************************************************************* 00020000
*                                                                       00030000
* ROUTINE: IVTMAPI2 - INTEGRATOR VTAM SERVICES API (PART 2)             00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*                                                                       00080000
*                                                                       00090000
*                                                                       00100000
*                                                                       00110000
* ON ENTRY:                                                             00120000
*                                                                       00130000
*    R15 = ENTRY POINT ADDRESS                                          00140000
*    R14 = RETURN ADDRESS                                               00150000
*    R13 = AVAILABLE SAVE AREA                                          00160000
*    R11 = ICVT ADDRESS                                                 00170000
*    R10 = ITASK ADDRESS                                                00180000
*    R09 = IVTAMCVT ADDRESS                                             00190000
*    R01 = $VTAM PARAMETER LIST ADDRESS                                 00200000
*          (SEE COMMENTS FOR SPECIFIC SERVICE BEING CALLED)             00210000
*                                                                       00220000
* ON EXIT:                                                              00230000
*                                                                       00240000
*    R15 = SEE COMMENTS FOR SPECIFIC SERVICE BEING CALLED               00250000
*    R00 = SEE COMMENTS FOR SPECIFIC SERVICE BEING CALLED               00260000
*    R01 = SEE COMMENTS FOR SPECIFIC SERVICE BEING CALLED               00270000
*                                                                       00280000
*    ALL OTHER REGISTERS ARE RESTORED                                   00290000
*                                                                       00300000
**<DOC-OFF>************************************************************ 00310000
                                                                        00320000
         EJECT ,                                                        00330000
*********************************************************************** 00340000
*                                                                       00350000
* MAINTENANCE:                                                          00360000
*                                                                       00370000
*   08/01/93 RANDY WITEK                                                00380000
*                                                                       00390000
*********************************************************************** 00400000
                                                                        00410000
         EQUS  ,                  GENERAL EQUATES                       00420000
                                                                        00430000
RICVT    EQU   R11                                                      00440000
RITASK   EQU   R10                                                      00450000
RIVTAM   EQU   R9                                                       00460000
RIACB    EQU   R8                                                       00470000
RIRPL    EQU   R7                                                       00480000
RIVUSER  EQU   R6                                                       00490000
RIWE     EQU   R5                                                       00500000
                                                                        00510000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00520000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00530000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00540000
         USING IACB,RIACB         ESTABLISH ADDRESSABILITY              00550000
         USING IRPL,RIRPL         ESTABLISH ADDRESSABILITY              00560000
         USING IVUSER,RIVUSER     ESTABLISH ADDRESSABILITY              00570000
         USING IWEVTAM,RIWE       ESTABLISH ADDRESSABILITY              00580000
                                                                        00590000
*---------------------------------------------------------------------- 00600000
*   S A V E   A N D   W O R K I N G   S T O R A G E                     00610000
*---------------------------------------------------------------------- 00620000
                                                                        00630000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00640000
WRK256   DS    XL256              GENERAL WORKAREA                      00650000
CONVERSN DS    XL512              HEX TO CHAR CONVERSION AREA           00660000
LV0SAVE  DS    18F                SUBROUTINE SAVE AREA                  00670000
$TASKMFL $TASK MF=L               $TASK PLIST CONSTRUCTION              00680000
$VTAMMFL $VTAM MF=L               $VTAM PLIST COPY AREA                 00690000
RETR15   DS    F                  RETURN CODE                           00700000
RETR0    DS    F                  RETURN REGISTER 0                     00710000
RETR1    DS    F                  RETURN REGISTER 1                     00720000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00730000
FLAG     DS    X                                                        00740000
FLAGLOCK EQU   X'80'              VTAM GLOBAL LOCK HELD                 00750000
FLAGLCKD EQU   X'40'              VTAM GLOBAL LOCK HELD ON ENTRY        00760000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00770000
                                                                        00780000
*---------------------------------------------------------------------- 00790000
*   M E S S A G E   D E F A U L T S                                     00800000
*---------------------------------------------------------------------- 00810000
                                                                        00820000
         $MSGDFT PREFIX=ICTPID,COMPID='VTM',TABLE=*#MSGS,              +00830000
               PRINT=NOGEN,WORKA=0,MF=(E,WRK256)                        00840000
                                                                        00850000
*---------------------------------------------------------------------- 00860000
*   M O D U L E   E N T R Y                                             00870000
*---------------------------------------------------------------------- 00880000
                                                                        00890000
IVTMAPI2 #ENTER BASE=R12,         R12 IS BASE REGISTER                 +00900000
               AMODE=31,                                               +00910000
               RMODE=ANY,                                              +00920000
               SAVE=YES,          ALLOCATE SAVE/WORK AREA              +00930000
               PREG=R2,           SAVE R1 PARM IN R2                   +00940000
               RESTENV=NO,        ICVT AND ITASK POINTERS ARE OK       +00950000
               WAPASS=NO,         NO WORK AREA PASSED IN R0            +00960000
               LINKAGE=STD        CALLED BY BAS/BASR                    00970000
                                                                        00980000
         L     RIVTAM,ICTVTCVT    SET IVTAMCVT BASE                     00990000
                                                                        01000000
*---------------------------------------------------------------------- 01010000
* SET BLOCK ID                                                          01020000
*---------------------------------------------------------------------- 01030000
                                                                        01040000
         MVC   VPLID-VPLIST(4,R2),=CL4'VPL '                            01050000
                                                                        01060000
*---------------------------------------------------------------------- 01070000
* COPY PARM LIST TO WORKING STORAGE                                     01080000
*---------------------------------------------------------------------- 01090000
                                                                        01100000
         MVC   $VTAMMFL(L'VPL),0(R2) COPY PARM LIST TO WORKING AREA     01110000
         USING VPLIST,$VTAMMFL                                          01120000
                                                                        01130000
*---------------------------------------------------------------------- 01140000
* TRACE THE MODULE ENTRY                                                01150000
*---------------------------------------------------------------------- 01160000
                                                                        01170000
         $TRACE *=A(TRC_IVTMAPIX_ENTER),48 TRACE ENTRY W/ 48 USER BYTES 01180000
         BNZ   NOETRACE                    BRANCH IF NOT TRACING        01190000
         $APITRC IVTMAPI2                  TRACE COMMON STUFF           01200000
         MVC   24(4,R1),VPLFUNC            TRACE FUNC & FLAGS           01210000
         L     R14,4(,R13)                 CALLER'S SAVE AREA           01220000
         MVC   28(4,R1),24(R14)            TRACE VPLIST ADDRESS         01230000
         MVC   32(4,R1),VPLTASK            TRACE PROVIDED ITASK ADDRESS 01240000
         MVC   36(4,R1),VPLAREA            TRACE PROVIDED AREA  ADDRESS 01250000
NOETRACE DS    0H                                                       01260000
                                                                        01270000
*---------------------------------------------------------------------- 01280000
* JUMP TO PROCESSING ROUTINE BASED ON REQUEST CODE                      01290000
*---------------------------------------------------------------------- 01300000
                                                                        01310000
         SR    R1,R1              CLEAR                                 01320000
         ICM   R1,B'0011',VPLFUNC LOAD REQUEST CODE                     01330000
         S     R1,=F'8'           NORMALIZE FUNCTION CODE TO 0          01340000
         SLL   R1,2               MULTIPLY BY 4                         01350000
         C     R1,=A(MAXFUNC)     IS REQUEST CODE VALID?                01360000
         BNH   REQTABLE(R1)       BRANCH TO ROUTINE IF VALID            01370000
         MVC   RETR15,=F'-1'      SET RC=-1                             01380000
         B     RETURN             EXIT TO CALLER                        01390000
                                                                        01400000
REQTABLE B     CHECKPH1         8 CHECK VTAM REQUEST ACCEPTANCE         01410000
         B     ADDUSER          9 ADD IVUSER TO THE LOOKUP TABLE        01420000
         B     DELUSER         10 DELETE IVUSER FROM THE LOOKUP TABLE   01430000
         B     GETPOOL         11 CREATE A NEW IPOOL CONTROL BLOCK      01440000
         B     STOPUSER        12 TRIGGER IVUSER TERMINATION            01450000
         B     TPEND           13 TRIGGER CLOSE OF VTAM ACB             01460000
         B     CLOSEACB        14 CLOSE A VTAM ACB                      01470000
         B     TPSTART         15 TRIGGER OPEN OF VTAM ACB              01480000
         B     FINDPOOL        16 RETURN THE REQUESTED IPOOL BLOCK      01490000
         B     ADDISESS        17 ADD ISESS TO THE IACB CHAIN           01500000
         B     DELISESS        18 DELETE ISESS FROM THE IACB CHAIN      01510000
         B     FINDUSER        19 LOCATE IVUSER BLOCK GIVEN TOKEN       01520000
         B     GETISQE         20 ADD AN ISQE                           01530000
         B     RETISQE         21 DELETE AN ISQE                        01540000
         B     FINDISQE        22 FIND ISQE BY SESSION TOKEN            01550000
         B     LOCISQE         23 LOCATE ISQE BY ISQE TOKEN             01560000
MAXFUNC  EQU   (*-REQTABLE)-4                                           01570000
                                                                        01580000
*---------------------------------------------------------------------- 01590000
* REQUEST 08 - CHECK VTAM REQUEST ACCEPTANCE                            01600000
*                                                                       01610000
* ENTRY  VALUES: R01 = ADDRESS OF $VTAM SERVICES PARAMETER LIST         01620000
*                VPLFUNC  = 8                                           01630000
*                VPLAREA  = ADDRESS OF IRPL TO BE CHECKED               01640000
*                                                                       01650000
* RETURN VALUES: R15 = 0                                                01660000
*                R00 = 0                                                01670000
*                R01 = 0                                                01680000
*                                                                       01690000
*---------------------------------------------------------------------- 01700000
                                                                        01710000
CHECKPH1 DS    0H                                                       01720000
                                                                        01730000
         ICM   RIRPL,15,VPLAREA   ADDRESS OF IRPL TO BE CHECKED         01740000
         BZ    ERRIRPL            BRANCH IF IRPL INVALID                01750000
         CLC   IRPID,=CL8'IRPL'   VALIDATE EYECATCHER                   01760000
         BNE   ERRIRPL            BRANCH IF IRPL INVALID                01770000
                                                                        01780000
         ICM   R15,15,IRPACCWD    ADDRESS OF "ACTIVE RPL" ACCT. WORD    01790000
         BZ    CPH1NOAW           BRANCH IF NO ACCOUNTING WORD          01800000
         L     R1,0(,R15)         CURRENT ACCOUNTING WORD               01810000
                                                                        01820000
CPH1UPAW DS    0H                                                       01830000
                                                                        01840000
         LR    R2,R1              COPY CURRENT WORD                     01850000
         A     R2,=F'1'           PLUS 1                                01860000
         LTR   R2,R2              QUICK CHECK                           01870000
         BNP   ERRIRPL            SOMETHING IS WRONG                    01880000
         CS    R1,R2,0(R15)       UPDATE THE WORD                       01890000
         BNE   CPH1UPAW           TRY THE UPDATE AGAIN                  01900000
                                                                        01910000
CPH1NOAW DS    0H                                                       01920000
                                                                        01930000
         ICM   R2,15,IRPR15       VTAM RETURN REGISTER 15               01940000
         BZ    RETURN             EXIT IF REQUEST IS UNDERWAY           01950000
                                                                        01960000
*                                                                       01970000
* THE REQUEST WASN'T ACCEPTED.  QUEUE RPL AS IF RPL EXIT WAS            01980000
* DRIVEN & INDICATE TO THE CALLER THAT THE REQUEST WAS ACCEPTED.        01990000
*---------------------------------------------------------------------- 02000000
                                                                        02010000
         ST    R2,IRPFR15         SET PHASE1 CODE AS FINAL RETURN CODE  02020000
         MVC   IRPFR0,IRPR0       SET FINAL R0 VALUE ALSO               02030000
                                                                        02040000
*                                                                       02050000
* ALLOCATE AN RPLEXIT WORK ELEMENT                                      02060000
*---------------------------------------------------------------------- 02070000
                                                                        02080000
         $VTAMWE L'IWEXA,         SIZE                                 +02090000
               IWECXRPL           CODE                                  02100000
                                                                        02110000
         LR    RIWE,R1                                                  02120000
                                                                        02130000
*                                                                       02140000
* BUILD THE RPLEXIT WORK ELEMENT                                        02150000
*---------------------------------------------------------------------- 02160000
                                                                        02170000
         ST    RIRPL,IWEXARP@     SET RPL ADDRESS                       02180000
                                                                        02190000
*                                                                       02200000
* QUEUE RPLEXIT WORK ELEMENT TO SPECIFIED WORK QUEUE                    02210000
*---------------------------------------------------------------------- 02220000
                                                                        02230000
         L     R1,IRP@WEQ         DESTINATION WORK ELEMENT QUEUE        02240000
         BAS   R14,QWE            GO QUEUE THE WORK ELEMENT             02250000
         B     RETURN             AND RETURN                            02260000
                                                                        02270000
*---------------------------------------------------------------------- 02280000
* REQUEST 09 - ADD IVUSER BLOCK TO LOOKUP TABLE                         02290000
*                                                                       02300000
* ENTRY  VALUES: R01 = ADDRESS OF $VTAM SERVICES PARAMETER LIST         02310000
*                VPLFUNC  = 9                                           02320000
*                VPLAREA  = ADDRESS OF IVUSER TO BE ADDED               02330000
*                                                                       02340000
* RETURN VALUES: R15 = 0                                                02350000
*                R00 = 0                                                02360000
*                R01 = 0                                                02370000
*                                                                       02380000
*---------------------------------------------------------------------- 02390000
                                                                        02400000
ADDUSER  DS    0H                                                       02410000
                                                                        02420000
         ICM   RIVUSER,15,VPLAREA ADDRESS OF IVUSER BLOCK               02430000
         BZ    ERRUSER            BRANCH IF INVALID                     02440000
         CLC   IVUID,=CL8'IVUSER' VALIDATE EYECATCHER                   02450000
         BNE   ERRUSER            BRANCH IF INVALID                     02460000
                                                                        02470000
         BAS   R14,VTAMLOCK       GET VTAM GLOBAL LOCK                  02480000
                                                                        02490000
         L     R4,IVUTKUSR        LOAD TOKEN VALUE                      02500000
         N     R4,=X'000003FF'    LOW 10 BITS INDEX A 1024-WORD TABLE   02510000
         SLL   R4,2               OFFSET OF ANCHOR FOR IVUSER CHAIN     02520000
         AL    R4,IVT@UTBL        ADDR   OF ANCHOR FOR IVUSER CHAIN     02530000
                                                                        02540000
         LA    R3,0(,R4)          COPY ANCHOR ADDRESS                   02550000
         S     R3,=A(IVUNEXT-IVU) NORMALIZE FOR CHAIN RUN               02560000
                                                                        02570000
ADDRUNCH DS    0H                                                       02580000
                                                                        02590000
         ICM   R3,15,IVUNEXT-IVU(R3) LINK TO NEXT IVUSER                02600000
         BZ    ADDENDCH           BRANCH IF END OF CHAIN                02610000
         CLC   IVUTKUSR(L'IVUTKUSR),IVUTKUSR-IVU(R3) DUPLICATE TOKEN?   02620000
         BNE   ADDRUNCH           BRANCH IF NOT, CHECK THE WHOLE CHAIN  02630000
         B     ERRUSER            BRANCH IF DUPLICATE TOKEN IS PRESENT  02640000
                                                                        02650000
ADDENDCH DS    0H                                                       02660000
                                                                        02670000
         MVC   IVUNEXT(4),0(R4)   LINK CURRENT HEAD TO NEXT PTR         02680000
         ST    RIVUSER,0(,R4)     SET NEW IVUSER AS 1ST IN THE CHAIN    02690000
                                                                        02700000
         L     R1,IVT#USER        CURRENT NUMBER OF IVUSER'S            02710000
         A     R1,=F'1'           BUMP IT BY ONE                        02720000
         ST    R1,IVT#USER        SAVE THE UPDATED IVUSER COUNT         02730000
         B     RETURN             RETURN TO CALLER                      02740000
                                                                        02750000
*---------------------------------------------------------------------- 02760000
* REQUEST 10 - DELETE IVUSER BLOCK FROM LOOKUP TABLE                    02770000
*                                                                       02780000
* ENTRY  VALUES: R01 = ADDRESS OF $VTAM SERVICES PARAMETER LIST         02790000
*                VPLFUNC  = 10                                          02800000
*                VPLAREA  = ADDRESS OF IVUSER TO BE DELETED             02810000
*                                                                       02820000
* RETURN VALUES: R15 = 0                                                02830000
*                R00 = 0                                                02840000
*                R01 = 0                                                02850000
*                                                                       02860000
*---------------------------------------------------------------------- 02870000
                                                                        02880000
DELUSER  DS    0H                                                       02890000
                                                                        02900000
         ICM   RIVUSER,15,VPLAREA ADDRESS OF IVUSER BLOCK               02910000
         BZ    ERRUSER            BRANCH IF INVALID                     02920000
         CLC   IVUID,=CL8'IVUSER' VALIDATE EYECATCHER                   02930000
         BNE   ERRUSER            BRANCH IF INVALID                     02940000
                                                                        02950000
         BAS   R14,VTAMLOCK       OBTAIN VTAM GLOBAL LOCK               02960000
                                                                        02970000
         L     R4,IVUTKUSR        LOAD TOKEN VALUE                      02980000
         N     R4,=X'000003FF'    LOW 10 BITS INDEX A 1024-WORD TABLE   02990000
         SLL   R4,2               OFFSET OF ANCHOR FOR IVUSER CHAIN     03000000
         AL    R4,IVT@UTBL        ADDR   OF ANCHOR FOR IVUSER CHAIN     03010000
                                                                        03020000
         LA    R3,0(,R4)          COPY ANCHOR ADDRESS                   03030000
         S     R3,=A(IVUNEXT-IVU) NORMALIZE FOR CHAIN RUN               03040000
                                                                        03050000
DELRUNCH DS    0H                                                       03060000
                                                                        03070000
         LR    R2,R3              SAVE PREVIOUS IVUSER ADDRESS          03080000
         ICM   R3,15,IVUNEXT-IVU(R3) LINK TO NEXT IVUSER                03090000
         BZ    ERRUSER            BRANCH IF END OF CHAIN AND NOT FOUND  03100000
         CR    RIVUSER,R3         IS THIS THE IVUSER WE'RE DELETING?    03110000
         BE    DELFOUND           BRANCH IF YES                         03120000
         B     DELRUNCH           BRANCH IF NOT TO CONTINUE SEARCH      03130000
                                                                        03140000
DELFOUND DS    0H                                                       03150000
                                                                        03160000
         MVC   IVUNEXT-IVU(4,R2),IVUNEXT SET "NEXT" PTR IN PRIOR IVUSER 03170000
                                                                        03180000
         L     R1,IVT#USER        CURRENT NUMBER OF IVUSER'S            03190000
         S     R1,=F'1'           DECREMENT BY ONE                      03200000
         ST    R1,IVT#USER        SAVE THE UPDATED IVUSER COUNT         03210000
         BM    ERRUSER            BRANCH IF COUNT WORD IS BAD           03220000
         B     RETURN             RETURN TO CALLER                      03230000
                                                                        03240000
*---------------------------------------------------------------------- 03250000
* REQUEST 11 - CREATE IPOOL BLOCK                                       03260000
*                                                                       03270000
* ENTRY  VALUES: R01 = ADDRESS OF $VTAM SERVICES PARAMETER LIST         03280000
*                VPLFUNC  = 11                                          03290000
*                VPLTASK  = 0 --> CURRENT ITASK IS STORAGE OWNER        03300000
*                        != 0 --> ITASK TO ASSIGN AS STORAGE OWNER      03310000
*                VPLAREA  =   --> ADDRESS OF 16-BYTE NAME FOR IPOOL     03320000
*                                                                       03330000
* RETURN VALUES: R15 = 0 --> REQUEST COMPLETE                           03340000
*                      4 --> INVALID IPOOL NAME                         03350000
*                R00 = 0                                                03360000
*                R01 = ADDRESS OF IPOOL                                 03370000
*                                                                       03380000
*---------------------------------------------------------------------- 03390000
                                                                        03400000
GETPOOL  DS    0H                                                       03410000
                                                                        03420000
*                                                                       03430000
* SERIALIZE AND ALLOCATE A NEW IPOOL BLOCK                              03440000
*---------------------------------------------------------------------- 03450000
                                                                        03460000
         BAS   R14,VTAMLOCK       OBTAIN VTAM GLOBAL LOCK               03470000
                                                                        03480000
         ICM   R2,15,VPLTASK      ITASK FOR STORAGE ASSOCIATION         03490000
         BNZ   GETPGETS           BRANCH IF ITASK PROVIDED              03500000
         LR    R2,RITASK          USE CURRENT ITASK                     03510000
                                                                        03520000
GETPGETS DS    0H                                                       03530000
                                                                        03540000
         $GETSTOR L'IPO,          GET STORAGE FOR BLOCK                +03550000
               LOC=ANY,                                                +03560000
               OWNER=(R2)                                               03570000
                                                                        03580000
         LR    R4,R1              ADDRESS OF THE NEW IPOOL              03590000
         ST    R4,RETR1           SET RETURN VALUE                      03600000
                                                                        03610000
         PUSH  USING                                                    03620000
         USING IPOOL,R4                                                 03630000
                                                                        03640000
*                                                                       03650000
* INITIALIZE NEW IPOOL BLOCK                                            03660000
*---------------------------------------------------------------------- 03670000
                                                                        03680000
         MVC   IPOID,=CL8'IPOOL'   SET EYECATCHER                       03690000
         MVC   IPOLEN(4),=A(L'IPO) SET LENGTH OF BLOCK                  03700000
         L     R1,VPLAREA          ADDRESS OF NAME                      03710000
         MVC   IPONAME(L'IPONAME),0(R1)    SET THE IPOOL NAME           03720000
         LA    R1,IPOIA1ST         ADDRESS OF IACB HEADER               03730000
         S     R1,=A(IACIANXT-IAC) NORMALIZE                            03740000
         O     R1,=X'80000000'     FLAG HI BIT ON                       03750000
         ST    R1,IPOIA1ST         INITIALIZE POINTER                   03760000
         ST    R1,IPOIALST         INITIALIZE POINTER                   03770000
                                                                        03780000
*                                                                       03790000
* INSERT NEW IPOOL INTO THE CHAIN OF ALL IPOOLS IN THE SYSTEM           03800000
*---------------------------------------------------------------------- 03810000
                                                                        03820000
         LA    R14,IVTIP1ST-(IPONEXT-IPO) ADDRESS OF CHAIN HEADER       03830000
                                                                        03840000
GETPFIPO DS    0H                                                       03850000
                                                                        03860000
         ICM   R14,15,IPONEXT-IPO(R14) NEXT IPOOL IN THE CHAIN          03870000
         BM    GETPINSR               BRANCH IF NEW NAME IS HIGHEST     03880000
         CLC   IPONAME(L'IPONAME),IPONAME-IPO(R14) COMPARE POOL NAMES   03890000
         BH    GETPFIPO               KEEP LOOKING IF NEW NAME IS HI    03900000
         BNE   GETPINSR               BRANCH TO INSERT NEW IPOOL        03910000
         B     GETPFREE               RELEASE IPOOL, UNLOCK, AND EXIT   03920000
                                                                        03930000
GETPINSR DS    0H                                                       03940000
                                                                        03950000
         CLC   IPONAME(L'IPONAME),=CL16'MAIN' RESERVED NAME REQUESTED?  03960000
         BE    GETPFREE               BRANCH IF YES, ERROR              03970000
                                                                        03980000
         L     R15,IPOPREV-IPO(,R14)  LINK TO PREVIOUS IPOOL            03990000
         ST    R4,IPONEXT-IPO(,R15)   LINK NEW IACB TO PREVIOUS         04000000
         ST    R4,IPOPREV-IPO(,R14)   LINK NEW IACB TO NEXT             04010000
         STM   R14,R15,IPONEXT        SET NEXT/PREV IN NEW IACB         04020000
         B     RETURN                 UNLOCK, AND EXIT                  04030000
                                                                        04040000
*                                                                       04050000
* FREE THE IPOOL DUE TO ERROR                                           04060000
*---------------------------------------------------------------------- 04070000
                                                                        04080000
GETPFREE DS    0H                                                       04090000
                                                                        04100000
         XC    RETR1,RETR1        DON'T RETURN THE IPOOL POINTER        04110000
         ICM   R2,15,VPLTASK      ITASK FOR STORAGE ASSOCIATION         04120000
         BNZ   GETPRETS           BRANCH IF ITASK PROVIDED              04130000
         LR    R2,RITASK          USE CURRENT ITASK                     04140000
                                                                        04150000
GETPRETS DS    0H                                                       04160000
                                                                        04170000
         $RETSTOR (R4),           RELEASE THE BLOCK                    +04180000
               OWNER=(R2)                                               04190000
                                                                        04200000
         B     RETURN4                                                  04210000
                                                                        04220000
         POP   USING                                                    04230000
                                                                        04240000
*---------------------------------------------------------------------- 04250000
* REQUEST 12 - BEGIN IVUSER TERMINATION                                 04260000
*                                                                       04270000
* ENTRY  VALUES: R01 = ADDRESS OF $VTAM SERVICES PARAMETER LIST         04280000
*                VPLFUNC  = 12                                          04290000
*                VPLAREA  = ADDRESS OF IVUSER/ISESS TOKEN               04300000
*                                                                       04310000
* RETURN VALUES: R15 = 0 --> TERMINATION STARTED                        04320000
*                    = 4 --> SPECIFIED IVUSER NOT FOUND                 04330000
*                R00 = 0                                                04340000
*                R01 = 0                                                04350000
*                                                                       04360000
*---------------------------------------------------------------------- 04370000
                                                                        04380000
STOPUSER DS    0H                                                       04390000
                                                                        04400000
         BAS   R14,VTAMLOCK       OBTAIN VTAM GLOBAL LOCK               04410000
                                                                        04420000
         ICM   R4,15,VPLAREA      ADDRESS OF TOKEN                      04430000
         BZ    RETURN4            BRANCH IF NO ADDRESS                  04440000
         L     R2,0(,R4)          LOAD USER TOKEN VALUE                 04450000
         N     R2,=X'000003FF'    LOW 10 BITS INDEX A 1024-WORD TABLE   04460000
         SLL   R2,2               OFFSET OF ANCHOR FOR IVUSER CHAIN     04470000
         AL    R2,IVT@UTBL        ADDR   OF ANCHOR FOR IVUSER CHAIN     04480000
         LA    RIVUSER,0(,R2)     COPY ANCHOR ADDRESS                   04490000
         S     RIVUSER,=A(IVUNEXT-IVU) NORMALIZE FOR CHAIN RUN          04500000
                                                                        04510000
STPRUNCH DS    0H                                                       04520000
                                                                        04530000
         ICM   RIVUSER,15,IVUNEXT LINK TO NEXT IVUSER                   04540000
         BZ    RETURN4            BRANCH IF END OF CHAIN AND NOT FOUND  04550000
         CLC   0(L'IVUTKUSR,R4),IVUTKUSR                                04560000
         BNE   STPRUNCH           BRANCH IF NOT TO CONTINUE SEARCH      04570000
                                                                        04580000
         $VTAMWE L'IWEXI,                                              +04590000
               IWECSTPU           ALLOCATE "STOP USER" WORK ELEMENT     04600000
                                                                        04610000
         LR    RIWE,R1            SAVE WORK ELEMENT ADDRESS             04620000
         LA    R1,IVUWEQ          WORK QUEUE ADDRESS                    04630000
         BAS   R14,QWE            QUEUE STOP WORK ELEMENT TO IVUSER     04640000
         B     RETURN             RETURN TO CALLER                      04650000
                                                                        04660000
*---------------------------------------------------------------------- 04670000
* REQUEST 13 - BEGIN IACB TERMINATION                                   04680000
*                                                                       04690000
* ENTRY  VALUES: R01 = ADDRESS OF $VTAM SERVICES PARAMETER LIST         04700000
*                VPLFUNC  = 13                                          04710000
*                VPLAREA  = ADDRESS OF IACB ACBNAME                     04720000
*                                                                       04730000
* RETURN VALUES: R15 = 0 --> TERMINATION STARTED OR ALREADY UNDERWAY    04740000
*                    = 4 --> SPECIFIED IACB NOT FOUND                   04750000
*                R00 = 0                                                04760000
*                R01 = 0                                                04770000
*                                                                       04780000
*---------------------------------------------------------------------- 04790000
                                                                        04800000
TPEND    DS    0H                                                       04810000
                                                                        04820000
         BAS   R14,VTAMLOCK       OBTAIN VTAM GLOBAL LOCK               04830000
                                                                        04840000
         ICM   R4,15,VPLAREA      ADDRESS OF TOKEN                      04850000
         BZ    RETURN4            BRANCH IF NO ADDRESS                  04860000
                                                                        04870000
         LA    R14,IVTIA1ST                ADDRESS OF IACB CHAIN HEAD   04880000
         S     R14,=A(IACNEXT-IAC)         NORMALIZE FOR CHAIN RUN      04890000
                                                                        04900000
TPNRUNCH DS    0H                                                       04910000
                                                                        04920000
         ICM   R14,15,IACNEXT-IAC(R14)     LINK TO NEXT IACB            04930000
         BM    RETURN4                     BRANCH IF IACB NOT FOUND     04940000
         CLC   0(8,R4),IACNAME-IAC(R14)    IS THIS THE SPECIFIED IACB?  04950000
         BH    TPNRUNCH                    BRANCH IF MORE TO CHECK      04960000
         BE    TPNFOUND                    BRANCH IF IACB FOUND         04970000
         B     RETURN4                     SPECIFIED IACBNAME NOT FOUND 04980000
                                                                        04990000
TPNFOUND DS    0H                                                       05000000
                                                                        05010000
         LR    RIACB,R14                   SAVE IACB ADDRESS            05020000
         TM    IACF1,IACF1OPN              IS THE ACB OPEN?             05030000
         BNO   RETURN                      BRANCH IF NOT                05040000
         TM    IACF1,IACF1TPN+IACF1CLS     TPEND ALREADY SIGNALED?      05050000
         BNZ   RETURN                      BRANCH IF YES                05060000
         OI    IACF1,IACF1CLS              SHOW CLOSE REQUESTED         05070000
                                                                        05080000
         $VTAMWE L'IWEX9,                                              +05090000
               IWECXTPN           ALLOCATE TPEND WORK ELEMENT           05100000
                                                                        05110000
         LR    RIWE,R1            SAVE WORK ELEMENT ADDRESS             05120000
         MVC   IWEX9RC,=F'-1'     SHOW THIS IS A SIMULATED TPEND        05130000
         ST    RIACB,IWEX9ACB     SET THE ACB ADDRESS                   05140000
         LA    R1,IVTWEQ          WORK QUEUE ADDRESS                    05150000
         BAS   R14,QWE            QUEUE STOP WORK ELEMENT TO MAIN       05160000
         B     RETURN             RETURN TO CALLER                      05170000
                                                                        05180000
*---------------------------------------------------------------------- 05190000
* REQUEST 14 - CLOSE ACB                                                05200000
*                                                                       05210000
* ENTRY  VALUES: R01 = ADDRESS OF $VTAM SERVICES PARAMETER LIST         05220000
*                VPLFUNC  = 14                                          05230000
*                VPLAREA  = ADDRESS OF IACB TO BE CLOSED                05240000
*                                                                       05250000
* RETURN VALUES: R15 = 0 --> ACB CLOSE SUCCESSFUL OR ALREADY CLOSED     05260000
*                    = 4 --> OS CLOSE ERROR                             05270000
*                    = 8 --> OS CLOSE ERROR                             05280000
*                    =12 --> OS CLOSE ERROR                             05290000
*                    =16 --> ACB TERMINATION HAS NOT BEEN REQUESTED     05300000
*                    =20 --> ACB TERMINATION HAS NOT BEEN STARTED       05310000
*                    =24 --> ACB STILL HAS ACTIVE SESSIONS              05320000
*                R00 = 0                                                05330000
*                R01 = 0                                                05340000
*                                                                       05350000
*---------------------------------------------------------------------- 05360000
                                                                        05370000
CLOSEACB DS    0H                                                       05380000
                                                                        05390000
*                                                                       05400000
* CHECK IF SESSIONS HAVE BEEN PROPERLY TERMINATED                       05410000
*---------------------------------------------------------------------- 05420000
                                                                        05430000
         L     RIACB,VPLAREA           ACB ADDRESS PASSED IN PLIST      05440000
                                                                        05450000
         TM    IACF1,IACF1OPN          IS THE ACB OPEN?                 05460000
         BNO   RETURN                  RETURN WITH SUCCESS IF NOT       05470000
         TM    IACF1,IACF1TPN+IACF1CLS WAS TERMINATION REQUESTED?       05480000
         BZ    RETURN16                BRANCH IF NOT                    05490000
         TM    IACF1,IACF1QUI+IACF1TRM TERMINATION STARTED & QUIESCED?  05500000
         BNO   RETURN20                BRANCH IF NOT                    05510000
         ICM   R1,15,IACIS1ST          ARE THERE ANY SESSIONS ACTIVE?   05520000
         BNM   RETURN24                BRANCH IF SESSIONS ARE ACTIVE    05530000
                                                                        05540000
*                                                                       05550000
* CHECK IF WE ARE UNDER THE MAIN VTAM TASK                              05560000
*---------------------------------------------------------------------- 05570000
                                                                        05580000
         C     RITASK,IVTITASK    EXECUTING IN VTAM MAIN TASK?          05590000
         BE    CLSMAIN            BRANCH IF YES                         05600000
                                                                        05610000
*                                                                       05620000
* CLOSE NOT ISSUED IN MAIN TASK.  ALLOCATE CLOSE WORK ELEMENT           05630000
*---------------------------------------------------------------------- 05640000
                                                                        05650000
         $VTAMWE L'IWEXJ,         SIZE                                 +05660000
               IWECLOSE           CODE                                  05670000
                                                                        05680000
         LR    RIWE,R1                                                  05690000
                                                                        05700000
*                                                                       05710000
* CLOSE NOT ISSUED IN MAIN TASK.  ALLOCATE XEPB                         05720000
*---------------------------------------------------------------------- 05730000
                                                                        05740000
         $TASK SETEPB,            INITIALIZE EPB TO WAIT FOR CLOSE     +05750000
               ECODE=EC$VTCL,     CLOSE ACB EVENT                      +05760000
               MF=(E,$TASKMFL)                                          05770000
                                                                        05780000
         LR    R3,R1              SAVE XEPB ADDRESS                     05790000
         ST    R3,IWEXJEPB        SET XEPB ADDRESS IN WORK ELEMENT      05800000
         MVC   IWEXJACB,VPLAREA   SET ACB ADDRESS IN WORK ELEMENT       05810000
                                                                        05820000
*                                                                       05830000
* CLOSE NOT ISSUED IN MAIN TASK.  QUEUE WORK ELEMENT TO MAIN TASK       05840000
*---------------------------------------------------------------------- 05850000
                                                                        05860000
         LA    R1,IVTWEQ          WORK QUEUE ADDRESS                    05870000
         BAS   R14,QWE            QUEUE STOP WORK ELEMENT TO MAIN       05880000
                                                                        05890000
*                                                                       05900000
* CLOSE NOT ISSUED IN MAIN TASK.  WAIT FOR MAIN TO PERFORM CLOSE        05910000
*---------------------------------------------------------------------- 05920000
                                                                        05930000
         $TASK WAIT,              WAIT FOR MAIN TO COMPLETE CLOSE      +05940000
               EPB=(R3),                                               +05950000
               MF=(E,$TASKMFL)                                          05960000
                                                                        05970000
         ST    R0,RETR15          POST CODE IN R0 IS CLOSE RETURN CODE  05980000
         B     RETURN             RETURN TO ISSUER OF $VTAM CLOSEACB    05990000
                                                                        06000000
*                                                                       06010000
* PROCESS CLOSE ACB IN MAIN TASK.                                       06020000
*---------------------------------------------------------------------- 06030000
                                                                        06040000
CLSMAIN  DS    0H                                                       06050000
                                                                        06060000
         XC    MFE_LIST(8),MFE_LIST CLEAR OPEN LIST                     06070000
         MVI   MFE_LIST,X'80'     SET FLAG FOR LAST ENTRY               06080000
         SR    R15,R15            CLEAR R15                             06090000
         OI    IACF1,IACF1UNU     MARK ACB UNUSABLE                     06100000
                                                                        06110000
         CLOSE ((RIACB)),                                              +06120000
               MF=(E,MFE_LIST),                                        +06130000
               MODE=31            ISSUE OS OPEN                         06140000
                                                                        06150000
         ST    R15,RETR15         SAVE RETURN CODE                      06160000
                                                                        06170000
         $TRACE *=A(TRC_CLOSEACB),32 TRACE ENTRY W/32 USER BYTES        06180000
                                                                        06190000
         BNZ   NOCTRACE           BRANCH IF TRACING NOT AVAILABLE       06200000
                                                                        06210000
         ST    RIACB,0(R1)        TRACE IACB ADDRESS                    06220000
         MVC   4(4,R1),RETR15     TRACE OPEN RETURN CODE                06230000
         MVC   8(8,R1),IACNAME    TRACE ACBNAME                         06240000
         MVC   16(4,R1),IACF1     TRACE IACF1-IACF4                     06250000
         MVC   20(1,R1),ACBERFLG  TRACE ACBERFLG                        06260000
         MVC   21(1,R1),ACBOFLGS  TRACE ACBOFGLS                        06270000
                                                                        06280000
NOCTRACE DS    0H                                                       06290000
                                                                        06300000
         ICM   R15,15,RETR15      RESTORE CLOSE RETURN CODE             06310000
         BZ    CLSOK              BRANCH IF CLOSE OK                    06320000
                                                                        06330000
         $MSG  013,               SHOW CLOSE ERROR INFORMATION         +06340000
               FIELDS=(IACNAME,                                        +06350000
               RETR15,                                                 +06360000
               ACBERFLG)                                                06370000
                                                                        06380000
         B     RETURN                                                   06390000
                                                                        06400000
CLSOK    DS    0H                                                       06410000
                                                                        06420000
         NI    IACF1,255-IACF1OPN-IACF1TPN-IACF1CLS-IACF1QUI-IACF1TRM   06430000
                                                                        06440000
         L     R1,IVT#OPEN        NUMBER OF OPEN ACB'S                  06450000
         S     R1,=F'1'           MINUS ONE                             06460000
         ST    R1,IVT#OPEN        SAVE UPDATED COUNT                    06470000
         BM    ERR#OPEN           SHOULD NEVER GO NEGATIVE              06480000
                                                                        06490000
         $MSG  015,               TELL THAT CLOSE IS COMPLETE          +06500000
               FIELDS=(IACNAME)                                         06510000
                                                                        06520000
         B     RETURN                                                   06530000
                                                                        06540000
*---------------------------------------------------------------------- 06550000
* REQUEST 15 - START IACB ACTIVATION                                    06560000
*                                                                       06570000
* ENTRY  VALUES: R01 = ADDRESS OF $VTAM SERVICES PARAMETER LIST         06580000
*                VPLFUNC  = 15                                          06590000
*                VPLAREA  = ADDRESS OF ACBNAME                          06600000
*                                                                       06610000
* RETURN VALUES: R15 = 0 --> ACTIVATION SUCCESSFUL OR ALREADY ACTIVE    06620000
*                    = 4 --> OS OPEN ERROR                              06630000
*                    = 8 --> OS OPEN ERROR                              06640000
*                    =12 --> OS OPEN ERROR                              06650000
*                    =16 --> SPECIFIED IACB NOT FOUND                   06660000
*                    =20 --> IACB IS BEING TERMINATED                   06670000
*                R00 = 0                                                06680000
*                R01 = 0                                                06690000
*                                                                       06700000
*---------------------------------------------------------------------- 06710000
                                                                        06720000
TPSTART  DS    0H                                                       06730000
                                                                        06740000
         BAS   R14,VTAMLOCK                OBTAIN VTAM GLOBAL LOCK      06750000
                                                                        06760000
         ICM   R4,15,VPLAREA               ADDRESS OF TOKEN             06770000
         BZ    RETURN16                    BRANCH IF NO ADDRESS         06780000
                                                                        06790000
         LA    R14,IVTIA1ST                ADDRESS OF IACB CHAIN HEAD   06800000
         S     R14,=A(IACNEXT-IAC)         NORMALIZE FOR CHAIN RUN      06810000
                                                                        06820000
TPSRUNCH DS    0H                                                       06830000
                                                                        06840000
         ICM   R14,15,IACNEXT-IAC(R14)     LINK TO NEXT IACB            06850000
         BM    RETURN16                    BRANCH IF IACB NOT FOUND     06860000
         CLC   0(8,R4),IACNAME-IAC(R14)    IS THIS THE SPECIFIED IACB?  06870000
         BH    TPSRUNCH                    BRANCH IF MORE TO CHECK      06880000
         BE    TPSFOUND                    BRANCH IF IACB FOUND         06890000
         B     RETURN16                    SPECIFIED IACBNAME NOT FOUND 06900000
                                                                        06910000
TPSFOUND DS    0H                                                       06920000
                                                                        06930000
         LR    RIACB,R14                   SAVE IACB ADDRESS            06940000
         TM    IACF1,IACF1OPN              IS THE ACB OPEN?             06950000
         BNO   TPSOPEN                     BRANCH IF NOT                06960000
         TM    IACF1,IACF1TPN+IACF1CLS     TERMINATION UNDERWAY?        06970000
         BNZ   RETURN20                    BRANCH IF YES                06980000
         B     RETURN                      ACB IS ALREADY ACTIVE        06990000
                                                                        07000000
TPSOPEN  DS    0H                                                       07010000
                                                                        07020000
         NI    IACF1,255-IACF1UNU          OPEN FAIL/TPEND UNU FLAG OFF 07030000
         BAS   R14,VTAMUNLK                RELEASE VTAM GLOBAL LOCK     07040000
                                                                        07050000
         $VTAM OPENACB,                                                +07060000
               AREA=(RIACB),                                           +07070000
               MF=(E,MFE_LIST)                                          07080000
                                                                        07090000
         ST    R15,RETR15                  PASS OPENACB RETURN CODE     07100000
         B     RETURN                      RETURN TO CALLER             07110000
                                                                        07120000
*---------------------------------------------------------------------- 07130000
* REQUEST 16 - FIND A SPECIFIED IPOOL BLOCK                             07140000
*                                                                       07150000
* ENTRY  VALUES: R01 = ADDRESS OF $VTAM SERVICES PARAMETER LIST         07160000
*                VPLFUNC  = 16                                          07170000
*                VPLAREA  =!0 --> ADDRESS OF 8-BYTE POOL NAME           07180000
*                         = 0 --> RETURN THE DEFAULT IPOOL BLOCK        07190000
*                                                                       07200000
* RETURN VALUES: R15 = 0 --> REQUEST COMPLETE                           07210000
*                      4 --> REQUESTED IPOOL NOT FOUND                  07220000
*                R00 = 0                                                07230000
*                R01 = ADDRESS OF IPOOL                                 07240000
*                                                                       07250000
*---------------------------------------------------------------------- 07260000
                                                                        07270000
FINDPOOL DS    0H                                                       07280000
                                                                        07290000
         PUSH  USING                                                    07300000
         USING IPOOL,R4                                                 07310000
                                                                        07320000
*                                                                       07330000
* LOCATE THE REQUESTED IPOOL                                            07340000
*---------------------------------------------------------------------- 07350000
                                                                        07360000
         ICM   R3,15,VPLAREA          WAS A POOL NAME SPECIFIED?        07370000
         BNZ   FINDPNME               BRANCH IF YES                     07380000
         ICM   R4,15,IVTIP1ST         DEFAULT IS THE FIRST IPOOL        07390000
         BM    RETURN4                RETURN TO CALLER (RC4=NOT FOUND)  07400000
         B     FINDPOK                BRANCH TO RETURN IPOOL BLOCK      07410000
                                                                        07420000
FINDPNME DS    0H                                                       07430000
                                                                        07440000
         BAS   R14,VTAMLOCK           SERIALIZE FOR CHAIN RUN           07450000
                                                                        07460000
         LA    R4,IVTIP1ST-(IPONEXT-IPO) ADDRESS OF CHAIN HEADER        07470000
                                                                        07480000
FINDPNXT DS    0H                                                       07490000
                                                                        07500000
         ICM   R4,15,IPONEXT          NEXT IPOOL IN THE CHAIN           07510000
         BM    RETURN4                RETURN TO CALLER (RC4=NOT FOUND)  07520000
         CLC   IPONAME(L'IPONAME),0(R3)       COMPARE POOL NAMES        07530000
         BE    FINDPOK                BRANCH IF IPOOL IS FOUND          07540000
         BL    FINDPNXT               BRANCH IF NAMES MAY BE PRESENT    07550000
         B     RETURN4                RETURN TO CALLER (RC4=NOT FOUND)  07560000
                                                                        07570000
FINDPOK  DS    0H                                                       07580000
                                                                        07590000
         ST    R4,RETR1               RETURN IPOOL POINTER IN R1        07600000
         B     RETURN                 RETURN TO CALLER                  07610000
                                                                        07620000
         POP   USING                                                    07630000
                                                                        07640000
*---------------------------------------------------------------------- 07650000
* REQUEST 17 - ADD ISESS TO THE IACB CHAIN & GLOBAL LOOKUP TABLE        07660000
*                                                                       07670000
* ENTRY  VALUES: R01 = ADDRESS OF $VTAM SERVICES PARAMETER LIST         07680000
*                VPLFUNC  = 17                                          07690000
*                VPLAREA  = ADDRESS OF ISESS TO BE ADDED                07700000
*                ISEACB@  = ADDRESS OF IACB                             07710000
*                                                                       07720000
* RETURN VALUES: R15 = 0                                                07730000
*                R00 = 0                                                07740000
*                R01 = 0                                                07750000
*                                                                       07760000
*---------------------------------------------------------------------- 07770000
                                                                        07780000
         PUSH  USING                                                    07790000
         DROP  RIVUSER                                                  07800000
         USING ISESS,RIVUSER                                            07810000
                                                                        07820000
ADDISESS DS    0H                                                       07830000
                                                                        07840000
         ICM   RIVUSER,15,VPLAREA        ADDRESS OF ISESS BLOCK         07850000
         BZ    ERRSESS                   BRANCH IF INVALID              07860000
         CLC   ISEID,=CL8'ISESS'         VALIDATE EYECATCHER            07870000
         BNE   ERRSESS                   BRANCH IF INVALID              07880000
         ICM   R3,15,ISEACB@             ADDRESS OF IACB                07890000
         BZ    ERRSESS                   BRANCH IF NO IACB              07900000
                                                                        07910000
         BAS   R14,VTAMLOCK                                             07920000
                                                                        07930000
*                                                                       07940000
* ADD THE ISESS TO THE IACB CHAIN                                       07950000
*---------------------------------------------------------------------- 07960000
                                                                        07970000
         L     R1,IACIS1ST-IAC(,R3)      FIRST ISESS ON IACB QUEUE      07980000
         L     R2,ISEISPRV-ISE(,R1)      ISESS PREVIOUS TO 1ST          07990000
         ST    RIVUSER,ISEISNXT-ISE(,R2) LINK NEW ISESS IN STRUCTURE    08000000
         ST    RIVUSER,ISEISPRV-ISE(,R1) LINK NEW ISESS IN STRUCTURE    08010000
         STM   R1,R2,ISEISNXT            LINK NEW ISESS IN STRUCTURE    08020000
         L     R1,IAC#SESS-IAC(,R3)      CURRENT # OF ISESS'S ON IACB   08030000
         A     R1,=F'1'                  BUMP BY ONE                    08040000
         ST    R1,IAC#SESS-IAC(,R3)      SAVE UPDATED COUNT             08050000
                                                                        08060000
*                                                                       08070000
* ADD THE ISESS TO THE GLOBAL LOOKUP TABLE                              08080000
*---------------------------------------------------------------------- 08090000
                                                                        08100000
         LA    R4,0(,RIVUSER)            ISESS ADDRESS                  08110000
         N     R4,=X'000FFF00'           12-BITS INDEX 4096-WORD TABLE  08120000
         SRL   R4,6                      OFFSET OF ISESS ANCHOR         08130000
         AL    R4,IVT@STBL               ADDRESS OF ISESS CHAIN ANCHOR  08140000
                                                                        08150000
         L     R3,0(,R4)                 CURRENT HEAD OF SYNONYM CHAIN  08160000
         ST    R3,ISEISENX-ISE(,RIVUSER) LINK PREVIOUS HEAD TO NEW ONE  08170000
         ST    RIVUSER,0(,R4)            NEW ONE IS HEAD OF SYN. CHAIN  08180000
                                                                        08190000
         B     RETURN                    RETURN TO CALLER               08200000
                                                                        08210000
         POP   USING                                                    08220000
                                                                        08230000
*---------------------------------------------------------------------- 08240000
* REQUEST 18 - DELETE ISESS FROM THE IACB CHAIN & THE GLOBAL LOOKUP TBL 08250000
*                                                                       08260000
* ENTRY  VALUES: R01 = ADDRESS OF $VTAM SERVICES PARAMETER LIST         08270000
*                VPLFUNC  = 18                                          08280000
*                VPLAREA  = ADDRESS OF ISESS TO BE DELETED              08290000
*                                                                       08300000
* RETURN VALUES: R15 = 0                                                08310000
*                R00 = 0                                                08320000
*                R01 = 0                                                08330000
*                                                                       08340000
*---------------------------------------------------------------------- 08350000
                                                                        08360000
         PUSH  USING                                                    08370000
         DROP  RIVUSER                                                  08380000
         USING ISESS,RIVUSER                                            08390000
                                                                        08400000
DELISESS DS    0H                                                       08410000
                                                                        08420000
         ICM   RIVUSER,15,VPLAREA      ADDRESS OF ISESS BLOCK           08430000
         BZ    ERRSESS                 BRANCH IF INVALID                08440000
         CLC   ISEID,=CL8'ISESS'       VALIDATE EYECATCHER              08450000
         BNE   ERRSESS                 BRANCH IF INVALID                08460000
                                                                        08470000
         BAS   R14,VTAMLOCK                                             08480000
                                                                        08490000
*                                                                       08500000
* DELETE THE ISESS FROM THE IACB CHAIN                                  08510000
*---------------------------------------------------------------------- 08520000
                                                                        08530000
         LM    R1,R2,ISEISNXT          NEXT/PREV ISESS'S ON SAME IACB   08540000
         ST    R2,ISEISPRV-ISE(,R1)    REMOVE ISESS FROM QUEUE          08550000
         ST    R1,ISEISNXT-ISE(,R2)    REMOVE ISESS FROM QUEUE          08560000
                                                                        08570000
         L     RIACB,ISEACB@           ACB ADDRESS                      08580000
         L     R1,IAC#SESS             CURRENT # OF ISESS'S ON IACB     08590000
         S     R1,=F'1'                DECREMENT BY ONE                 08600000
         ST    R1,IAC#SESS             SAVE UPDATED COUNT               08610000
                                                                        08620000
*                                                                       08630000
* DELETE THE ISESS FROM THE GLOBAL LOOKUP TABLE                         08640000
*---------------------------------------------------------------------- 08650000
                                                                        08660000
         LA    R4,0(,RIVUSER)            ISESS ADDRESS                  08670000
         N     R4,=X'000FFF00'           12-BITS INDEX 4096-WORD TABLE  08680000
         SRL   R4,6                      OFFSET OF ISESS ANCHOR         08690000
         AL    R4,IVT@STBL               ADDRESS OF ISESS CHAIN ANCHOR  08700000
                                                                        08710000
         LA    R3,0(,R4)                 COPY ANCHOR ADDRESS            08720000
         S     R3,=A(ISEISENX-ISE)       NORMALIZE FOR CHAIN RUN        08730000
                                                                        08740000
DELISERN DS    0H                                                       08750000
                                                                        08760000
         LR    R2,R3                     SAVE PREVIOUS ISESS ADDRESS    08770000
         ICM   R3,15,ISEISENX-ISE(R3)    LINK TO NEXT ISESS             08780000
         BZ    ERRSESS                   BRANCH IF NOT FOUND IN CHAIN   08790000
         CR    RIVUSER,R3                IS THIS THE ISESS?             08800000
         BE    DELISEGO                  BRANCH IF YES                  08810000
         B     DELISERN                  BRANCH IF NOT TO CONTINUE      08820000
                                                                        08830000
DELISEGO DS    0H                                                       08840000
                                                                        08850000
         MVC   ISEISENX-ISE(4,R2),ISEISENX SET"NEXT" PTR IN PRIOR ISESS 08860000
                                                                        08870000
*                                                                       08880000
* CLEAR EXCLUSIVE/MULTI-PASS/PASS INDICATIONS FROM IACB FOR THIS ISESS  08890000
*---------------------------------------------------------------------- 08900000
                                                                        08910000
         C     RIVUSER,IACISEXC        DOES ISESS HAVE EXCLUSIVE USE?   08920000
         BNE   DELINEXC                BRANCH IF NOT                    08930000
         XC    IACISEXC,IACISEXC       CLEAR THE INDICATION             08940000
DELINEXC DS    0H                                                       08950000
                                                                        08960000
         C     RIVUSER,IACISMPS        DOES ISESS HAVE MULTI-PASS USE?  08970000
         BNE   DELINMPS                BRANCH IF NOT                    08980000
         XC    IACISMPS,IACISMPS       CLEAR THE INDICATION             08990000
DELINMPS DS    0H                                                       09000000
                                                                        09010000
         C     RIVUSER,IACISPSS        DOES ISESS HAVE CLSDST-PASS USE? 09020000
         BNE   DELINPSS                BRANCH IF NOT                    09030000
         XC    IACISPSS,IACISPSS       CLEAR THE INDICATION             09040000
DELINPSS DS    0H                                                       09050000
                                                                        09060000
         BAS   R14,VTAMUNLK                                             09070000
                                                                        09080000
*                                                                       09090000
* QUEUE CLOSE WE IF ACB IS BEING TERMINATED & THIS IS THE LAST SESSION  09100000
*---------------------------------------------------------------------- 09110000
                                                                        09120000
         L     RIACB,ISEACB@           ASSOCIATED IACB                  09130000
         ICM   R2,15,IACIS1ST          HEAD OF ISESS CHAIN              09140000
         BNM   RETURN                  BRANCH IF SESSIONS ARE ACTIVE    09150000
         TM    IACF1,IACF1TRM+IACF1QUI IACB BEING TERMINATED?           09160000
         BNO   RETURN                  BRANCH IF NOT                    09170000
                                                                        09180000
         $VTAMWE L'IWEXJ,              SIZE                            +09190000
               IWECLOSE                CODE                             09200000
                                                                        09210000
         LR    RIWE,R1                                                  09220000
         ST    RIACB,IWEXJACB          SET ACB ADDRESS IN WORK ELEMENT  09230000
                                                                        09240000
         LA    R1,IVTWEQ               WORK QUEUE ADDRESS               09250000
         BAS   R14,QWE                 QUEUE STOP WORK ELEMENT TO MAIN  09260000
                                                                        09270000
         B     RETURN                  RETURN TO CALLER                 09280000
                                                                        09290000
         POP   USING                                                    09300000
                                                                        09310000
*---------------------------------------------------------------------- 09320000
* REQUEST 19 - FIND IVUSER BLOCK IN LOOKUP TABLE                        09330000
*                                                                       09340000
* ENTRY  VALUES: R01 = ADDRESS OF $VTAM SERVICES PARAMETER LIST         09350000
*                VPLFUNC  = 19                                          09360000
*                VPLAREA  = ADDRESS OF IVUSER/ISESS TOKEN               09370000
*                                                                       09380000
* RETURN VALUES: R15 = 0  IVUSER FOUND                                  09390000
*                    = 4  IVUSER NOT FOUND                              09400000
*                R00 = 0                                                09410000
*                R01 = 0  IVUSER NOT FOUND                              09420000
*                    = !0 IVUSER ADDRESS                                09430000
*                                                                       09440000
*---------------------------------------------------------------------- 09450000
                                                                        09460000
FINDUSER DS    0H                                                       09470000
                                                                        09480000
         ICM   R3,15,VPLAREA      ADDRESS OF IVUSER/ISESS TOKEN         09490000
         BZ    RETURN4            BRANCH IF INVALID                     09500000
                                                                        09510000
         BAS   R14,VTAMLOCK       OBTAIN VTAM GLOBAL LOCK               09520000
                                                                        09530000
         L     R4,0(,R3)          LOAD IVUSER PORTION OF TOKEN VALUE    09540000
         N     R4,=X'000003FF'    LOW 10 BITS INDEX A 1024-WORD TABLE   09550000
         SLL   R4,2               OFFSET OF ANCHOR FOR IVUSER CHAIN     09560000
         AL    R4,IVT@UTBL        ADDR   OF ANCHOR FOR IVUSER CHAIN     09570000
         S     R4,=A(IVUNEXT-IVU) NORMALIZE FOR CHAIN RUN               09580000
                                                                        09590000
FNDURUN  DS    0H                                                       09600000
                                                                        09610000
         ICM   R4,15,IVUNEXT-IVU(R4) LINK TO NEXT IVUSER                09620000
         BZ    RETURN4            BRANCH IF END OF CHAIN AND NOT FOUND  09630000
         CLC   IVUTKUSR-IVU(4,R4),0(R3) IS THIS THE USER?               09640000
         BNE   FNDURUN            BRANCH IF NOT                         09650000
         ST    R4,RETR1           RETURN THE IVUSER ADDRESS             09660000
         B     RETURN             RETURN TO CALLER                      09670000
                                                                        09680000
*---------------------------------------------------------------------- 09690000
* REQUEST 20 - GET SESSION INITIATION QUEUE ELEMENT & LINK IT UP        09700000
*                                                                       09710000
* ENTRY  VALUES: R01 = ADDRESS OF $VTAM SERVICES PARAMETER LIST         09720000
*                VPLFUNC  = 20                                          09730000
*                VPLAREA  = ADDRESS OF SESSION TOKEN FOR THE SESSION    09740000
*                           THAT IS BEING INITIATED                     09750000
*                                                                       09760000
* RETURN VALUES: R15 = 0                                                09770000
*                R00 = 0                                                09780000
*                R01 = 0                                                09790000
*                                                                       09800000
*---------------------------------------------------------------------- 09810000
                                                                        09820000
GETISQE  DS    0H                                                       09830000
                                                                        09840000
         ICM   R3,15,VPLAREA              ADDRESS OF TOKEN              09850000
         BZ    ERRISQE                    BRANCH IF INVALID             09860000
                                                                        09870000
         $GETSTOR L'ISQ,                                               +09880000
               LOC=ANY,                                                +09890000
               OWNER=*IVTITASK                                          09900000
                                                                        09910000
X        USING ISQE,R4                                                  09920000
                                                                        09930000
         LR    R4,R1                      ISQE ADDRESS                  09940000
         ST    R4,RETR1                   RETURN ISQE ADDRESS IN R1     09950000
         MVC   X.ISQID,=CL8'ISQE'         SET EYECATCHER                09960000
         MVC   X.ISQSTOK,0(R3)            SET NEW SESSION TOKEN         09970000
                                                                        09980000
         BAS   R14,VTAMLOCK                                             09990000
                                                                        10000000
         LA    R14,IVTSQ1ST-(ISQNEXT-ISQ) NORMALIZED HEADER ADDRESS     10010000
                                                                        10020000
GETQRUN  DS    0H                                                       10030000
                                                                        10040000
         ICM   R14,15,ISQNEXT-ISQ(R14)    LINK TO NEXT ISQE             10050000
         BM    GETQNOW                    BRANCH IF END OF CHAIN        10060000
         CLC   X.ISQSTOK,ISQSTOK-ISQ(R14) COMPARE TOKENS                10070000
         BH    GETQRUN                    NEW TOKEN IS HI               10080000
         BNE   GETQNOW                    NEW TOKEN IS LOW              10090000
         B     ERRISQE                    SHOULD NEVER BE EQUAL         10100000
                                                                        10110000
GETQNOW  DS    0H                                                       10120000
                                                                        10130000
         L     R15,ISQPREV-ISQ(,R14)      LINK TO PREVIOUS ISQE         10140000
         ST    R4,ISQNEXT-ISQ(,R15)       LINK NEW ISQE TO PREVIOUS     10150000
         ST    R4,ISQPREV-ISQ(,R14)       LINK NEW ISQE TO NEXT         10160000
         STM   R14,R15,X.ISQNEXT          SET NEXT/PREV IN NEW ISQE     10170000
                                                                        10180000
         L     R2,IVTTKSQ                 CURRENT TOKEN                 10190000
         AL    R2,=F'1'                   NEXT TOKEN VALUE              10200000
         N     R2,=X'7FFFFFFF'            VALUES 1-7FFFFFFF ARE VALID   10210000
         ST    R2,IVTTKSQ                 SAVE UPDATED TOKEN VALUE      10220000
         BNZ   GETQSETT                   GO SET THE TOKEN              10230000
         LA    R2,1                       WRAP TOKEN VALUE TO 1         10240000
         ST    R2,IVTTKSQ                 SAVE UPDATED TOKEN VALUE      10250000
                                                                        10260000
GETQSETT DS    0H                                                       10270000
                                                                        10280000
         ST    R2,X.ISQTOKEN              SET TOKEN FOR THIS SESS INIT  10290000
         N     R2,=X'000003FF'            LOW 10-BITS INDEX 1024-WD TBL 10300000
         SLL   R2,2                       OFFSET OF ANCHOR FOR ISQE CHN 10310000
         AL    R2,IVT@SQTB                ADDR   OF ANCHOR FOR ISQE CHN 10320000
         MVC   X.ISQTKNXT,0(R2)           SET NEXT POINTER              10330000
         ST    R4,0(,R2)                  NEW ISQE IS HEAD OF CHAIN     10340000
                                                                        10350000
         L     R1,IVT#ISQE                CURRENT ISQE COUNT            10360000
         A     R1,=F'1'                   BUMP BY ONE                   10370000
         ST    R1,IVT#ISQE                                              10380000
         BNP   ERRISQE                                                  10390000
         B     RETURN                                                   10400000
                                                                        10410000
         DROP  X                                                        10420000
                                                                        10430000
*---------------------------------------------------------------------- 10440000
* REQUEST 21 - RETURN SESSION INITIATION QUEUE ELEMENT                  10450000
*                                                                       10460000
* ENTRY  VALUES: R01 = ADDRESS OF $VTAM SERVICES PARAMETER LIST         10470000
*                VPLFUNC  = 21                                          10480000
*                VPLAREA  = ADDRESS OF TOKEN FOR ISQE TO BE DELETED     10490000
*                                                                       10500000
* RETURN VALUES: R15 = 0                                                10510000
*                R00 = 0                                                10520000
*                R01 = 0                                                10530000
*                                                                       10540000
*---------------------------------------------------------------------- 10550000
                                                                        10560000
RETISQE  DS    0H                                                       10570000
                                                                        10580000
         ICM   R3,15,VPLAREA              ADDRESS OF ISQE TOKEN         10590000
         BZ    ERRISQE                    BRANCH IF INVALID             10600000
                                                                        10610000
         BAS   R14,VTAMLOCK                                             10620000
                                                                        10630000
         L     R2,0(,R3)                  ISQE TOKEN                    10640000
         LR    R1,R2                      SAVE TOKEN VALUE              10650000
         N     R2,=X'000003FF'            LOW 10-BITS INDEX 1024-WD TBL 10660000
         SLL   R2,2                       OFFSET OF ANCHOR FOR ISQE CHN 10670000
         AL    R2,IVT@SQTB                ADDR   OF ANCHOR FOR ISQE CHN 10680000
         LA    R3,0(,R2)                  COPY ANCHOR ADDRESS           10690000
         S     R3,=A(ISQTKNXT-ISQ)        NORMALIZE FOR CHAIN RUN       10700000
                                                                        10710000
RETQRUN  DS    0H                                                       10720000
                                                                        10730000
         LR    R2,R3                      PREVIOUS ISQE                 10740000
         ICM   R3,15,ISQTKNXT-ISQ(R3)     NEXT ISQE                     10750000
         BZ    ERRISQE                    BRANCH IF NOT FOUND           10760000
         C     R1,ISQTOKEN-ISQ(,R3)       IS THIS THE ISQE?             10770000
         BNE   RETQRUN                    BRANCH IF NOT                 10780000
         MVC   ISQTKNXT-ISQ(4,R2),ISQTKNXT-ISQ(R3) REMOVE FROM CHAIN    10790000
                                                                        10800000
         LM    R14,R15,ISQNEXT-ISQ(R3)    R14=NEXT R15=PREV             10810000
         ST    R15,ISQPREV-ISQ(,R14)      LINK PREV TO NEXT             10820000
         ST    R14,ISQNEXT-ISQ(,R15)      LINK NEXT TO PREV             10830000
                                                                        10840000
         L     R1,IVT#ISQE                CURRENT ISQE COUNT            10850000
         S     R1,=F'1'                   DECREMENT BY ONE              10860000
         ST    R1,IVT#ISQE                SAVE NEW CURRENT COUNT        10870000
         BM    ERRISQE                    ABEND IF COUNTING PROBLEM     10880000
                                                                        10890000
         $VTAMRET (R3)                    QUEUE ISQE FOR MAINTASK RET   10900000
                                                                        10910000
         B     RETURN                                                   10920000
                                                                        10930000
*---------------------------------------------------------------------- 10940000
* REQUEST 22 - FIND A SESSION INITIATION QUEUE ELEMENT ON THE CHAIN     10950000
*              ACCESSED BY TOKEN OF SESSION BEING INITIATED             10960000
*                                                                       10970000
* ENTRY  VALUES: R01 = ADDRESS OF $VTAM SERVICES PARAMETER LIST         10980000
*                VPLFUNC  = 22                                          10990000
*                VPLAREA  = ADDRESS OF SESSION TOKEN                    11000000
*                                                                       11010000
* RETURN VALUES: R15 = 0 FOUND                                          11020000
*                    = 4 NOT FOUND                                      11030000
*                R00 = 0                                                11040000
*                R01 = 0 NOT FOUND                                      11050000
*                    =!0 ADDRESS OF ISQE THAT WAS FOUND                 11060000
*                                                                       11070000
*---------------------------------------------------------------------- 11080000
                                                                        11090000
FINDISQE DS    0H                                                       11100000
                                                                        11110000
         ICM   R3,15,VPLAREA              ADDRESS OF TOKEN              11120000
         BZ    RETURN4                    BRANCH IF NOT PROVIDED        11130000
                                                                        11140000
         BAS   R14,VTAMLOCK                                             11150000
                                                                        11160000
         LA    R14,IVTSQ1ST-(ISQNEXT-ISQ) NORMALIZED HEADER ADDRESS     11170000
                                                                        11180000
FNDQRUN  DS    0H                                                       11190000
                                                                        11200000
         ICM   R14,15,ISQNEXT-ISQ(R14)    LINK TO NEXT ISQE             11210000
         BM    RETURN4                    BRANCH IF END OF CHAIN        11220000
         CLC   0(8,R3),ISQSTOK-ISQ(R14)   COMPARE TOKENS                11230000
         BH    FNDQRUN                    GIVEN TOKEN IS HI             11240000
         BNE   RETURN4                    GIVEN TOKEN IS LOW            11250000
         ST    R14,RETR1                  RETURN THE ISQE ADDRESS       11260000
         B     RETURN                                                   11270000
                                                                        11280000
*---------------------------------------------------------------------- 11290000
* REQUEST 23 - FIND A SESSION INITIATION QUEUE ELEMENT ON THE CHAIN     11300000
*              ACCESSED BY TOKEN OF ISQE                                11310000
*                                                                       11320000
* ENTRY  VALUES: R01 = ADDRESS OF $VTAM SERVICES PARAMETER LIST         11330000
*                VPLFUNC  = 23                                          11340000
*                VPLAREA  = ADDRESS OF ISQE TOKEN                       11350000
*                                                                       11360000
* RETURN VALUES: R15 = 0 FOUND                                          11370000
*                    = 4 NOT FOUND                                      11380000
*                R00 = 0                                                11390000
*                R01 = 0 NOT FOUND                                      11400000
*                    =!0 ADDRESS OF ISQE THAT WAS FOUND                 11410000
*                                                                       11420000
*---------------------------------------------------------------------- 11430000
                                                                        11440000
LOCISQE  DS    0H                                                       11450000
                                                                        11460000
         ICM   R3,15,VPLAREA              ADDRESS OF TOKEN              11470000
         BZ    RETURN4                    BRANCH IF NOT PROVIDED        11480000
                                                                        11490000
         BAS   R14,VTAMLOCK                                             11500000
                                                                        11510000
         L     R2,0(,R3)                  ISQE TOKEN                    11520000
         LR    R1,R2                      SAVE TOKEN VALUE              11530000
         N     R2,=X'000003FF'            LOW 10-BITS INDEX 1024-WD TBL 11540000
         SLL   R2,2                       OFFSET OF ANCHOR FOR ISQE CHN 11550000
         AL    R2,IVT@SQTB                ADDR   OF ANCHOR FOR ISQE CHN 11560000
         LA    R3,0(,R2)                  COPY ANCHOR ADDRESS           11570000
         S     R3,=A(ISQTKNXT-ISQ)        NORMALIZE FOR CHAIN RUN       11580000
                                                                        11590000
LOCQRUN  DS    0H                                                       11600000
                                                                        11610000
         ICM   R3,15,ISQTKNXT-ISQ(R3)     NEXT ISQE                     11620000
         BZ    RETURN4                    BRANCH IF NOT FOUND           11630000
         C     R1,ISQTOKEN-ISQ(,R3)       IS THIS THE ISQE?             11640000
         BNE   LOCQRUN                    BRANCH IF NOT                 11650000
         ST    R3,RETR1                   RETURN THE ISQE ADDRESS       11660000
         B     RETURN                                                   11670000
                                                                        11680000
*---------------------------------------------------------------------- 11690000
*   SET RETURN CODE OF 24                                               11700000
*---------------------------------------------------------------------- 11710000
                                                                        11720000
RETURN24 DS    0H                                                       11730000
                                                                        11740000
         MVI   RETR15+(L'RETR15-1),24                                   11750000
         B     RETURN                                                   11760000
                                                                        11770000
*---------------------------------------------------------------------- 11780000
*   SET RETURN CODE OF 20                                               11790000
*---------------------------------------------------------------------- 11800000
                                                                        11810000
RETURN20 DS    0H                                                       11820000
                                                                        11830000
         MVI   RETR15+(L'RETR15-1),20                                   11840000
         B     RETURN                                                   11850000
                                                                        11860000
*---------------------------------------------------------------------- 11870000
*   SET RETURN CODE OF 16                                               11880000
*---------------------------------------------------------------------- 11890000
                                                                        11900000
RETURN16 DS    0H                                                       11910000
                                                                        11920000
         MVI   RETR15+(L'RETR15-1),16                                   11930000
         B     RETURN                                                   11940000
                                                                        11950000
*---------------------------------------------------------------------- 11960000
*   SET RETURN CODE OF 4                                                11970000
*---------------------------------------------------------------------- 11980000
                                                                        11990000
RETURN4  DS    0H                                                       12000000
                                                                        12010000
         MVI   RETR15+(L'RETR15-1),4                                    12020000
         B     RETURN                                                   12030000
                                                                        12040000
*---------------------------------------------------------------------- 12050000
*   R E T U R N   T O   C A L L E R                                     12060000
*---------------------------------------------------------------------- 12070000
                                                                        12080000
*---------------------------------------------------------------------- 12090000
* TRACE THE MODULE EXIT                                                 12100000
*---------------------------------------------------------------------- 12110000
                                                                        12120000
RETURN   DS    0H                                                       12130000
                                                                        12140000
         $TRACE *=A(TRC_IVTMAPIX_EXIT),16 TRACE ENTRY W/ 16 USER BYTES  12150000
                                                                        12160000
         BNZ   NOXTRACE           BRANCH IF TRACING NOT AVAILABLE       12170000
                                                                        12180000
         MVC   0(4,R1),VPLFUNC    TRACE $VTAM FUNCTION CODE             12190000
         MVC   4(12,R1),RETREGS   TRACE 15,0,1 RETURN REGISTERS         12200000
                                                                        12210000
NOXTRACE DS    0H                                                       12220000
                                                                        12230000
         BAS   R14,VTAMUNLK       RELEASE SERIALIZATION IF APPROPRIATE  12240000
                                                                        12250000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 12260000
                                                                        12270000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    12280000
                                                                        12290000
*---------------------------------------------------------------------- 12300000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 12310000
*---------------------------------------------------------------------- 12320000
                                                                        12330000
VTAMLOCK DS    0H                                                       12340000
                                                                        12350000
         TM    FLAG,FLAGLOCK        WAS THE LOCK ALEADY OBTAINED?       12360000
         BOR   R14                  RETURN IF YES                       12370000
         STM   R14,R2,LV0SAVE       SAVE CALLER'S REGISTERS             12380000
                                                                        12390000
         $SER  OBTAIN,                                                 +12400000
               VTAM                                                     12410000
                                                                        12420000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              12430000
         BNE   VTAMLOEX             BRANCH IF NOT                       12440000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         12450000
                                                                        12460000
VTAMLOEX DS    0H                                                       12470000
                                                                        12480000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               12490000
         LM    R14,R2,LV0SAVE       RESTORE CALLER'S REGISTERS          12500000
         BR    R14                  RETURN                              12510000
                                                                        12520000
*---------------------------------------------------------------------- 12530000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                12540000
*---------------------------------------------------------------------- 12550000
                                                                        12560000
VTAMUNLK DS    0H                                                       12570000
                                                                        12580000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       12590000
         BNOR  R14                  BRANCH IF NOT                       12600000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             12610000
         BOR   R14                  DON'T RELEASE IF IT WAS             12620000
         STM   R14,R2,LV0SAVE       SAVE CALLER'S REGISTERS             12630000
                                                                        12640000
         $SER  RELEASE,                                                +12650000
               VTAM                                                     12660000
                                                                        12670000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  12680000
         LM    R14,R2,LV0SAVE       RESTORE CALLER'S REGISTERS          12690000
         BR    R14                  RETURN                              12700000
                                                                        12710000
*---------------------------------------------------------------------- 12720000
* SUBROUTINE QWE - QUEUE A WORK ELEMENT TO A GIVEN WORK QUEUE           12730000
*                                                                       12740000
*                  R14 = RETURN ADDRESS                                 12750000
*                  R1  = QUEUE ADDRESS                                  12760000
*                  RIWE= WORK ELEMENT                                   12770000
*---------------------------------------------------------------------- 12780000
                                                                        12790000
QWE      DS    0H                                                       12800000
                                                                        12810000
         STM   R14,R3,LV0SAVE     SAVE REGISTERS                        12820000
                                                                        12830000
         LR    R3,R1              SAVE QUEUE ADDRESS                    12840000
                                                                        12850000
         $VTAMQ (RIWE),           WORK ELEMENT                         +12860000
               (R3)               QUEUE                                 12870000
                                                                        12880000
         LM    R14,R3,LV0SAVE     RESTORE REGISTERS                     12890000
         BR    R14                AND RETURN TO CALLER                  12900000
                                                                        12910000
*---------------------------------------------------------------------- 12920000
*   E R R O R   R O U T I N E S                                         12930000
*---------------------------------------------------------------------- 12940000
                                                                        12950000
ERR$VTAM DS    0H                                                       12960000
                                                                        12970000
         $ABEND ABE_VTDIAG,                                            +12980000
               SCOPE=PCB,                                              +12990000
               TITLE='$VTAM FAILURE'                                    13000000
                                                                        13010000
ERRIRPL  DS    0H                                                       13020000
                                                                        13030000
         $ABEND ABE_VTDIAG,                                            +13040000
               SCOPE=PCB,                                              +13050000
               TITLE='INVALID IRPL DETECTED'                            13060000
                                                                        13070000
ERRUSER  DS    0H                                                       13080000
                                                                        13090000
         $ABEND ABE_VTDIAG,                                            +13100000
               SCOPE=PCB,                                              +13110000
               TITLE='INVALID IVUSER DETECTED'                          13120000
                                                                        13130000
ERRSESS  DS    0H                                                       13140000
                                                                        13150000
         $ABEND ABE_VTDIAG,                                            +13160000
               SCOPE=PCB,                                              +13170000
               TITLE='INVALID ISESS DETECTED'                           13180000
                                                                        13190000
ERRISQE  DS    0H                                                       13200000
                                                                        13210000
         $ABEND ABE_VTDIAG,                                            +13220000
               SCOPE=PCB,                                              +13230000
               TITLE='ISQE PROCESSING ERROR'                            13240000
                                                                        13250000
ERR#OPEN DS    0H                                                       13260000
                                                                        13270000
         $ABEND ABE_VTDIAG,                                            +13280000
               SCOPE=PCB,                                              +13290000
               TITLE='INVALID OPEN ACB COUNT'                           13300000
                                                                        13310000
*---------------------------------------------------------------------- 13320000
*   C O N S T A N T S   A N D   L I T E R A L S                         13330000
*---------------------------------------------------------------------- 13340000
                                                                        13350000
         LTORG ,                                                        13360000
                                                                        13370000
*---------------------------------------------------------------------- 13380000
*   D S E C T S                                                         13390000
*---------------------------------------------------------------------- 13400000
                                                                        13410000
         PRINT NOGEN                                                    13420000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                13430000
         ISTDBIND ,               VTAM BIND IMAGE                       13440000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         13450000
         ICVT  ,                  INTEGRATOR CVT                        13460000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   13470000
         ITASK ,                  INTEGRATOR TASK BLOCK                 13480000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            13490000
         IACB ,                   INTEGRATOR VTAM ACB+                  13500000
         IRPL ,                   INTEGRATOR VTAM RPL+                  13510000
         INIB ,                   INTEGRATOR VTAM NIB+                  13520000
         ISESS ,                  INTEGRATOR SESSION CONTROL            13530000
         IPOOL ,                  INTEGRATOR POOL CONTROL BLOCK         13540000
         ISQE ,                   INTEGRATOR SESSION INIT QUEUE ELEMENT 13550000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENTS         13560000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       13570000
         EVCODES ,                INTEGRATOR EVENT CODES                13580000
         ABCODES ,                INTEGRATOR $ABEND CODES               13590000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     13600000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             13610000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             13620000
         IFGEXLST ,               VTAM EXIT LIST                        13630000
         END   ,                                                        13640000

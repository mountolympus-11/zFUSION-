IL62AISL TITLE 'INTEGRATOR - LU6.2 INITIALIZE SESSION LIMIT'            00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: IL62AISL - LU6.2 INITIALIZE SESSION LIMIT                    00100000
*                                                                       00110000
* DESCRIPTION:                                                          00120000
*                                                                       00130000
*    THIS ROUTINE IS CALLED TO NEGOTIATE AN INITIAL SESSION LIMIT.      00140000
*                                                                       00150000
* ON ENTRY:                                                             00160000
*                                                                       00170000
*    R15 = ENTRY POINT ADDRESS                                          00180000
*    R14 = RETURN      ADDRESS                                          00190000
*    R13 = SAVE AREA   ADDRESS                                          00200000
*    R01 = PARM LIST   ADDRESS                                          00210000
*                                                                       00220000
*          +00 = ADDRESS OF LUCB (IACB)                                 00230000
*          +04 = ADDRESS OF PARTNER LU NAME (8 CHARACTERS, BLANK PAD)   00240000
*          +08 = ADDRESS OF MODE NAME (8 CHARACTERS, BLANK PAD)         00250000
*          +0C = ADDRESS OF SESSION LIMIT                               00260000
*          +10 = ADDRESS OF MIN_CONWINNERS_SOURCE                       00270000
*          +14 = ADDRESS OF MIN_CONWINNERS_TARGET                       00280000
*          +18 = ADDRESS OF RETURN CODE AREA                            00290000
*                                                                       00300000
* ON EXIT:                                                              00310000
*                                                                       00320000
*    R15 = 0                                                            00330000
*                                                                       00340000
*    RETURN_CODE = LU62_OK --> ACCEPTED                                 00350000
*                                                                       00360000
*                = LU62_PARAMETER_ERROR --> BAD PARAMETER               00370000
*                = LU62_OPERATION_NOT_ACCEPTED --> RACE CONDITION       00380000
*                = LU62_PRODUCT_SPECIFIC_ERROR --> INTERNAL FAILURE     00390000
*                                                                       00400000
**<DOC-OFF>************************************************************ 00410000
         EJECT ,                                                        00420000
*********************************************************************** 00430000
*                                                                       00440000
* MAINTENANCE:                                                          00450000
*                                                                       00460000
*   10/01/94 RANDY WITEK                                                00470000
*                                                                       00480000
*********************************************************************** 00490000
                                                                        00500000
         EQUS  ,                  GENERAL EQUATES                       00510000
                                                                        00520000
RICVT    EQU   R11                                                      00530000
RITASK   EQU   R10                                                      00540000
RBASE    EQU   R9                                                       00550000
RIVTAM   EQU   R8                                                       00560000
RIACB    EQU   R7                                                       00570000
RIVUSER  EQU   R6                                                       00580000
RMDE     EQU   R5                                                       00590000
RPLIST   EQU   R4                                                       00600000
                                                                        00610000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00620000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00630000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00640000
         USING IACB,RIACB         ESTABLISH ADDRESSABILITY              00650000
         USING IVUSER,RIVUSER     ESTABLISH ADDRESSABILITY              00660000
         USING MDE,RMDE           ESTABLISH ADDRESSABILITY              00670000
         USING L62LIST,RPLIST     ESTABLISH ADDRESSABILITY              00680000
                                                                        00690000
         COPY  CRAB               "C" RUNTIME ANCHOR BLOCK              00700000
         USING CRAB,R12           ADDRESSABILITY                        00710000
                                                                        00720000
         COPY  DSA                DYNAMIC SAVE AREA                     00730000
WORKAREA DS    0H                 READ/WRITE WORKAREA                   00740000
WRK256   DS    XL256              GENERAL WORKAREA                      00750000
L62MFL   L62DSPL MF=L             PLIST CONSTRUCTION                    00760000
L62RETCD DS    F                  LU6.2 RETURN CODE AREA                00770000
L62RETPB DS    A                  LU6.2 PLB ADDRESS RETURN AREA         00780000
L62RETMD DS    A                  LU6.2 MDE ADDRESS RETURN AREA         00790000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00800000
PARTNM   DS    CL8                COPY OF PARTNER LUNAME                00810000
MODENM   DS    CL8                COPY OF MODE NAME                     00820000
SESSLIM  DS    F                  COPY OF SESSION LIMIT                 00830000
MINWIN   DS    F                  COPY OF MINIMUM CONWINNERS SOURCE     00840000
MINLOSE  DS    F                  COPY OF MINIMUM CONWINNERS TARGET     00850000
RETCODE  DS    F                  TEMPORARY RETURN CODE AREA            00860000
FLAG     DS    X                                                        00870000
FLAGLOCK EQU   X'80'                                                    00880000
FLAGLCKD EQU   X'40'                                                    00890000
WORKLEN  EQU   *-WORKAREA         LENGTH OF USER DSA AREA               00900000
DSALEN   EQU   *-DSA              LENGTH OF DSA                         00910000
                                                                        00920000
         $MSGDFT PREFIX=ICTPID,                                        +00930000
               COMPID='L62',                                           +00940000
               TABLE=*#MSGS,                                           +00950000
               WORKA=0,                                                +00960000
               MF=(E,WRK256),                                          +00970000
               PRINT=NOGEN                                              00980000
                                                                        00990000
IL6AISL@ CSECT ,                                                        01000000
IL62AISL CENTRY DSA=DSALEN,BASE=RBASE,INDEP=YES                         01010000
                                                                        01020000
         USING DSA,R13            ADDRESSABILITY                        01030000
         LR    RPLIST,R1          SAVE ADDRESS OF PLIST                 01040000
                                                                        01050000
         LA    R0,WORKAREA        ADDRESS OF USER DSA SECTION           01060000
         LA    R1,WORKLEN         LENGTH  OF USER DSA SECTION           01070000
         SR    R15,R15            PREPARE FOR CLEAR                     01080000
         MVCL  R0,R14             CLEAR USER DSA SECTION                01090000
                                                                        01100000
*---------------------------------------------------------------------- 01110000
* INITIALIZATION                                                        01120000
*---------------------------------------------------------------------- 01130000
                                                                        01140000
         @RESTENV ,               ENSURE ENVIRONMENT                    01150000
                                                                        01160000
         L     RIVTAM,ICTVTCVT    ESTABLISH IVTAMCVT POINTER            01170000
         USING IVTAMCVT,RIVTAM    ADDRESSABILITY                        01180000
         L     RIACB,L62PARM1     LUCB ADDRESS                          01190000
         SR    RIVUSER,RIVUSER    NO PLB YET                            01200000
         L     R1,L62PARM2        PARTNER LU NAME ADDRESS               01210000
         MVC   PARTNM,0(R1)       COPY PARTNER LU NAME                  01220000
         L     R1,L62PARM3        MODE NAME ADDRESS                     01230000
         MVC   MODENM,0(R1)       COPY MODE NAME                        01240000
         L     R1,L62PARM4        SESSION LIMIT ADDRESS                 01250000
         MVC   SESSLIM,0(R1)      COPY SESSION LIMIT                    01260000
         L     R1,L62PARM5        MIN_CONWINNERS_SOURCE ADDRESS         01270000
         MVC   MINWIN,0(R1)       COPY                                  01280000
         L     R1,L62PARM6        MIN_CONWINNERS_TARGET ADDRESS         01290000
         MVC   MINLOSE,0(R1)      COPY                                  01300000
                                                                        01310000
INITEND  DS    0H                                                       01320000
                                                                        01330000
*---------------------------------------------------------------------- 01340000
* ENTRY TRACE                                                           01350000
*---------------------------------------------------------------------- 01360000
                                                                        01370000
         $TRACE *=A(TRC_LU62_IL62AISL),80 TRACE ENTRY W/ 80 USER BYTES  01380000
         BNZ   NOETRACE                   BRANCH IF NOT TRACING         01390000
         $APITRC IL62AISL                 TRACE COMMON STUFF            01400000
         ST    RPLIST,24(,R1)             TRACE PARMLIST ADDRESS        01410000
         ST    RIACB,28(,R1)              TRACE IACB     ADDRESS        01420000
         LTR   RIACB,RIACB                IS IACB POINTER OK?           01430000
         BZ    *+10                       BRANCH IF NOT                 01440000
         MVC   32(8,R1),IACNAME           TRACE LOCAL LU NAME           01450000
         MVC   40(8,R1),PARTNM            TRACE PARTNER LU NAME         01460000
         MVC   48(8,R1),MODENM            TRACE MODE NAME               01470000
         MVC   56(4,R1),SESSLIM           TRACE SESSION LIMIT           01480000
         MVC   60(4,R1),MINWIN            TRACE MIN_CONWINNERS          01490000
         MVC   64(4,R1),MINLOSE           TRACE MIN_CONLOSERS           01500000
NOETRACE DS    0H                                                       01510000
                                                                        01520000
*---------------------------------------------------------------------- 01530000
* LOCATE THE SPECIFIED PARTNER LU                                       01540000
*---------------------------------------------------------------------- 01550000
                                                                        01560000
         LTR   RIACB,RIACB        DO WE HAVE AN IACB POINTER?           01570000
         BNP   ERRPARM            BRANCH IF NOT                         01580000
         CLC   IACID,=CL8'IACB'   IS THE ID CORRECT?                    01590000
         BNE   ERRPARM            BRANCH IF NOT                         01600000
                                                                        01610000
         BAS   R14,VTAMLOCK       SERIALIZE                             01620000
                                                                        01630000
         L62DSPL (RIACB),         LOCAL LU ADDRESS                     +01640000
               PARTNM,            PARTNER LU NAME ADDRESS              +01650000
               =F'8',             PARTNER LU NAME LENGTH ADDRESS       +01660000
               L62RETPB,          PLB ADDRESS RETURN AREA              +01670000
               L62RETCD,          RETURN CODE AREA                     +01680000
               MF=(E,L62MFL)                                            01690000
                                                                        01700000
         OC    L62RETCD,L62RETCD   DOES PARTNER LU EXIST?               01710000
         BNZ   ERRPARM             BRANCH IF NOT                        01720000
         ICM   RIVUSER,15,L62RETPB RETURNED PLB OF PARTNER LU           01730000
         BNP   ERRPROD             BRANCH IF DOESN'T LOOK GOOD          01740000
         TM    IVUF1,IVUF1PSC      IS PARTNER PARALLEL?                 01750000
         BNO   ERROPER             BRANCH IF NOT...CAN'T DO             01760000
                                                                        01770000
*---------------------------------------------------------------------- 01780000
* LOCATE THE SPECIFIED MODE NAME                                        01790000
*---------------------------------------------------------------------- 01800000
                                                                        01810000
         CLC   MODENM,=CL8'SNASVCMG'                                    01820000
         BE    ERROPER            NOT VALID FOR THIS MODENAME           01830000
                                                                        01840000
         L62DSMD (RIVUSER),       PARTNER_LU ADDRESS                   +01850000
               MODENM,            MODE NAME ADDRESS                    +01860000
               =F'8',             MODE NAME LENGTH ADDRESS             +01870000
               L62RETMD,          MDE ADDRESS RETURN AREA              +01880000
               L62RETCD,          RETURN CODE AREA                     +01890000
               MF=(E,L62MFL)                                            01900000
                                                                        01910000
         OC    L62RETCD,L62RETCD  GOOD RETURN CODE?                     01920000
         BNZ   ERRPARM            BRANCH IF NOT, BAD MODE NAME          01930000
         ICM   RMDE,15,L62RETMD   GET MDE ADDRESS                       01940000
         BNP   ERRPROD            EXIT IF IT LOOKS BAD                  01950000
                                                                        01960000
*---------------------------------------------------------------------- 01970000
* VALIDATE THE REQUESTED LIMITS                                         01980000
*---------------------------------------------------------------------- 01990000
                                                                        02000000
         ICM   R1,15,SESSLIM      REQUESTED LIMIT                       02010000
         BNP   ERRPARM            BRANCH IF BAD                         02020000
         ICM   R2,15,MINWIN       REQUESTED MIN WINNERS                 02030000
         BM    ERRPARM            BRANCH IF BAD                         02040000
         SR    R1,R2              MAKE SURE MIN NOT GREATER THAN LIMIT  02050000
         BM    ERRPARM            BRANCH IF BAD                         02060000
         ICM   R2,15,MINLOSE      REQUESTED MIN LOSERS                  02070000
         BM    ERRPARM            BRANCH IF BAD                         02080000
         SR    R1,R2              MAKE SURE TWO MINS DON'T EXCEED LIMIT 02090000
         BM    ERRPARM            BRANCH IF BAD                         02100000
                                                                        02110000
*---------------------------------------------------------------------- 02120000
* CHECK FOR A RACE CONDITION                                            02130000
*---------------------------------------------------------------------- 02140000
                                                                        02150000
         TM    MDEF1,MDEF1WSS     WAITING FOR SNASVCMG SESSION?         02160000
         BO    ERROPER            BRANCH IF YES                         02170000
         TM    MDEF1,MDEF1CNI     NEGOTIATION IN PROGRESS?              02180000
         BO    ERROPER            BRANCH IF YES                         02190000
         OI    MDEF1,MDEF1CNI     SHOW NEGOTIATION IN PROGRESS          02200000
                                                                        02210000
*---------------------------------------------------------------------- 02220000
* QUEUE WORK TO THE IVUSER                                              02230000
*---------------------------------------------------------------------- 02240000
                                                                        02250000
         $VTAMWE L'IWEYA,         LENGTH                               +02260000
               IWECSLIM           CODE                                  02270000
                                                                        02280000
X        USING IWEVTAM,R1                                               02290000
         OI    X.IYAF1,IYAF1INI   INITIALIZE SESSION LIMIT              02300000
         MVC   X.IWEYANME,MODENM  PASS THE MODE NAME                    02310000
         MVC   X.IWEYALIM,SESSLIM PASS THE SESSION LIMIT                02320000
         MVC   X.IWEYAWIN,MINWIN  PASS THE MIN_CONWINNERS_SOURCE        02330000
         MVC   X.IWEYALOS,MINLOSE PASS THE MIN_CONWINNERS_TARGET        02340000
         DROP  X                                                        02350000
                                                                        02360000
         LA    R0,IVUWEQ          QUEUE ADDRESS                         02370000
         BAS   R14,QWE            QUEUE THE WORK ELEMENT                02380000
         B     RETURN                                                   02390000
                                                                        02400000
*---------------------------------------------------------------------- 02410000
* EXCEPTION ROUTINES                                                    02420000
*---------------------------------------------------------------------- 02430000
                                                                        02440000
ERRPROD  DS    0H                                                       02450000
                                                                        02460000
         MVC   RETCODE,=A(LU62_PRODUCT_SPECIFIC_ERROR)                  02470000
         B     RETURN                                                   02480000
                                                                        02490000
ERRPARM  DS    0H                                                       02500000
                                                                        02510000
         MVC   RETCODE,=A(LU62_PARAMETER_ERROR)                         02520000
         B     RETURN                                                   02530000
                                                                        02540000
ERROPER  DS    0H                                                       02550000
                                                                        02560000
         MVC   RETCODE,=A(LU62_OPERATION_NOT_ACCEPTED)                  02570000
         B     RETURN                                                   02580000
                                                                        02590000
*---------------------------------------------------------------------- 02600000
* EXIT TRACE AND RETURN TO CALLER                                       02610000
*---------------------------------------------------------------------- 02620000
                                                                        02630000
RETURN   DS    0H                                                       02640000
                                                                        02650000
         BAS   R14,VTAMUNLK           RELEASE THE LOCK IF NECESSARY     02660000
                                                                        02670000
         $TRACE *=A(TRC_LU62_EXIT),16 TRACE ENTRY W/ 16 USER BYTES      02680000
         BNZ   NOXTRACE               BRANCH IF TRACING NOT AVAILABLE   02690000
         MVC   0(8,R1),=CL8'IL62AISL' MODULE NAME                       02700000
         MVC   8(4,R1),RETCODE        RETURN_CODE VALUE                 02710000
NOXTRACE DS    0H                                                       02720000
                                                                        02730000
         L     R1,L62PARM7            ADDRESS OF RETURN_CODE AREA       02740000
         MVC   0(4,R1),RETCODE        SET RETURN_CODE VARIABLE          02750000
                                                                        02760000
         SR    R15,R15                FUNCTION RETURN CODE = 0          02770000
         CEXIT RC=(R15),INDEP=YES     RETURN                            02780000
                                                                        02790000
*---------------------------------------------------------------------- 02800000
* SUBROUTINE QWE - QUEUE A WORK ELEMENT TO A GIVEN WORK QUEUE           02810000
*                                                                       02820000
* ENTRY            R14 = RETURN ADDRESS                                 02830000
*                  R1  = WORK ELEMENT ADDRESS                           02840000
*                  R0  = QUEUE ADDRESS                                  02850000
*                                                                       02860000
* RETURNS          R15 = 0 --> QUEUEING WAS SUCCESSFUL                  02870000
*                      = 4 --> QUEUEING FAILED, WORK ELEMENT RELEASED   02880000
*---------------------------------------------------------------------- 02890000
                                                                        02900000
QWE      DS    0H                                                       02910000
                                                                        02920000
         STM   R14,R4,SUB0SAVE    SAVE REGISTERS                        02930000
         LR    R3,R0              SAVE QUEUE ADDRESS                    02940000
         LR    R4,R1              SAVE WORK ELEMENT ADDRESS             02950000
                                                                        02960000
         $VTAMQ (R4),             WORK ELEMENT                         +02970000
               (R3)               QUEUE                                 02980000
                                                                        02990000
         L     R14,SUB0SAVE       RESTORE REGISTERS                     03000000
         LM    R0,R4,SUB0SAVE+8   RESTORE REGISTERS                     03010000
         BR    R14                AND RETURN TO CALLER W/R15            03020000
                                                                        03030000
*---------------------------------------------------------------------- 03040000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 03050000
*---------------------------------------------------------------------- 03060000
                                                                        03070000
VTAMLOCK DS    0H                                                       03080000
                                                                        03090000
         TM    FLAG,FLAGLOCK        WAS THE LOCK ALREADY OBTAINED?      03100000
         BOR   R14                  RETURN IF YES                       03110000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             03120000
                                                                        03130000
         $SER  OBTAIN,                                                 +03140000
               VTAM                                                     03150000
                                                                        03160000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              03170000
         BNE   VTAMLOEX             BRANCH IF NOT                       03180000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         03190000
                                                                        03200000
VTAMLOEX DS    0H                                                       03210000
                                                                        03220000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               03230000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          03240000
         BR    R14                  RETURN                              03250000
                                                                        03260000
*---------------------------------------------------------------------- 03270000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                03280000
*---------------------------------------------------------------------- 03290000
                                                                        03300000
VTAMUNLK DS    0H                                                       03310000
                                                                        03320000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       03330000
         BNOR  R14                  BRANCH IF NOT                       03340000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             03350000
         BOR   R14                  DON'T RELEASE IF IT WAS             03360000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             03370000
                                                                        03380000
         $SER  RELEASE,                                                +03390000
               VTAM                                                     03400000
                                                                        03410000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  03420000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          03430000
         BR    R14                  RETURN                              03440000
                                                                        03450000
*---------------------------------------------------------------------- 03460000
* ERROR ROUTINES                                                        03470000
*---------------------------------------------------------------------- 03480000
                                                                        03490000
*---------------------------------------------------------------------- 03500000
* LITERALS AND CONSTANTS                                                03510000
*---------------------------------------------------------------------- 03520000
                                                                        03530000
         LTORG ,                                                        03540000
                                                                        03550000
         PRINT NOGEN                                                    03560000
         ISTDBIND ,               VTAM BIND IMAGE                       03570000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                03580000
         IKJTCB ,                 MVS TASK CONTROL BLOCK                03590000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         03600000
         ICVT  ,                  INTEGRATOR CVT                        03610000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   03620000
         ITASK ,                  INTEGRATOR TASK BLOCK                 03630000
         IPCB ,                   INTEGRATOR PROCESS BLOCK              03640000
         IACB ,                   INTEGRATOR VTAM ACB                   03650000
         ABCODES ,                INTEGRATOR $ABEND CODES               03660000
         EVCODES ,                INTEGRATOR EVENT CODES                03670000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            03680000
         ISESS ,                  INTEGRATOR SESSION BLOCK              03690000
         IRPL ,                   INTEGRATOR VTAM RPL                   03700000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          03710000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             03720000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             03730000
         $RESMGR DSECT=YES        INTEGRATOR $RESMGR SERVICES           03740000
         END   ,                                                        03750000

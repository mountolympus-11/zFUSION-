IVTMXDFA TITLE 'INTEGRATOR - VTAM DFASY EXIT'                           00010000
**<DOC-ON>************************************************************* 00020000
*                                                                       00030000
* ROUTINE: IVTMXDFA - INTEGRATOR VTAM DFASY EXIT                        00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THE DFASY EXIT IS USED TO RECEIVE THE FOLLOWING                    00080000
*    EXPEDITED DATA FLOW CONTROL REQUESTS:                              00090000
*                                                                       00100000
*    - SIGNAL                                                           00110000
*    - QUIESCE AT END OF CHAIN  (QEC)                                   00120000
*    - RELEASE QUIESCE (RELQ)                                           00130000
*    - REQUEST SHUTDOWN (RSHUTD)                                        00140000
*    - SHUTDOWN COMPLETE (SHUTC)                                        00150000
*    - SHUTDOWN (SHUTD)                                                 00160000
*    - STOP BRACKET INITIATION (SBI)                                    00170000
*                                                                       00180000
*    ALL OF THE ABOVE REQUESTS ARE SESSION RELATED.  IF THE ISESS       00190000
*    IS AVAILABLE A DFASY WORK ELEMENT IS BUILT AND QUEUED TO THE       00200000
*    ISESS WORK QUEUE FOR TASK-MODE PROCESSING.  IF THE ISESS           00210000
*    CANNOT BE VALIDATED, THE DFASY WORK ELEMENT IS QUEUED TO THE       00220000
*    VTAM MAIN TASK WORK QUEUE WHERE A DIAGNOSTIC DUMP IS PERFORMED.    00230000
*                                                                       00240000
* ON ENTRY:                                                             00250000
*                                                                       00260000
*    BAKR IS USED TO SAVE REGISTERS.                                    00270000
*                                                                       00280000
*    R15 = ENTRY POINT ADDRESS                                          00290000
*    R14 = RETURN ADDRESS                                               00300000
*    R01 = PARAMETER LIST ADDRESS                                       00310000
*          +00(4): ADDRESS OF ACB                                       00320000
*          +04(4): CID OF ASSOCIATED SESSION                            00330000
*          +08(4): NIB USERFLD OF ASSOCIATED SESSION                    00340000
*          +0C(4): RESERVED (UNUSED)                                    00350000
*          +10(4): ADDRESS OF VTAM READ-ONLY RPL                        00360000
*          +14(4): RESERVED (UNUSED)                                    00370000
*                                                                       00380000
* ON EXIT:                                                              00390000
*                                                                       00400000
*    R15 = 0                                                            00410000
*    R00 = 0                                                            00420000
*    R01 = 0                                                            00430000
*                                                                       00440000
*    ALL OTHER REGISTERS ARE RESTORED BY PR.                            00450000
*                                                                       00460000
**<DOC-OFF>************************************************************ 00470000
                                                                        00480000
         EJECT ,                                                        00490000
*********************************************************************** 00500000
*                                                                       00510000
* MAINTENANCE:                                                          00520000
*                                                                       00530000
*   08/01/93 RANDY WITEK                                                00540000
*                                                                       00550000
*********************************************************************** 00560000
         EQUS  ,                  GENERAL EQUATES                       00570000
                                                                        00580000
RICVT    EQU   R11                INTEGRATOR CVT POINTER                00590000
RITASK   EQU   R10                ASSOCIATED ITASK POINTER              00600000
RIVTAM   EQU   R9                 INTEGRATOR VTAM CVT POINTER           00610000
RIACB    EQU   R8                 ASSOCIATED IACB POINTER               00620000
RIRPL    EQU   R7                 ASSOCIATED RPL/IRPL POINTER           00630000
RISESS   EQU   R6                 ASSOCIATED ISESS POINTER              00640000
RIWE     EQU   R5                 WORK ELEMENT POINTER                  00650000
                                                                        00660000
         USING ICVT,RICVT         ESTABLISH ADDRESSIBILTY               00670000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSIBILTY               00680000
         USING ITASK,RITASK       ESTABLISH ADDRESSIBILTY               00690000
         USING IACB,RIACB         ESTABLISH ADDRESSIBILTY               00700000
         USING IRPL,RIRPL         ESTABLISH ADDRESSIBILTY               00710000
         USING IWEVTAM,RIWE       ESTABLISH ADDRESSIBILTY               00720000
         USING ISESS,RISESS       ESTABLISH ADDRESSIBILTY               00730000
                                                                        00740000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00750000
         DS    0D                                                       00760000
RCVPARMS DS    XL(L'IVR)          IVTAMRPA STORAGE                      00770000
ESTAEMFL DS    XL(L'ESTAEXPL)     PARMLIST CONSTRUCTION                 00780000
FRRPARM  DS    A                  RETURN AREA FOR FRR PARM ADDRESS      00790000
SAVER3   DS    F                  TEMPORARY SAVE AREA                   00800000
RETR15   DS    F                  RETURN CODE VALUE                     00810000
RETR0    DS    F                  RETURN REGISTER 0                     00820000
RETR1    DS    F                  RETURN REGISTER 1                     00830000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00840000
FLAG     DS    X                                                        00850000
FLESTAEX EQU   X'08'              ESTAEX ACTIVE                         00860000
FLFRR    EQU   X'04'              FRR    ACTIVE                         00870000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00880000
                                                                        00890000
IVTMXDFA #VTENTER BASE=R12,       VTAM EXIT ROUTINE LINKAGE            +00900000
               AMODE=31,                                               +00910000
               RMODE=ANY,                                              +00920000
               PREG=(R3),                                              +00930000
               EXITYPE=PLIST                                            00940000
                                                                        00950000
         USING IVTAMRPA,RCVPARMS  ESTABLISH ADDRESSIBILITY              00960000
                                                                        00970000
*---------------------------------------------------------------------- 00980000
* ESTABLISH RECOVERY ENVIRONMENT                                        00990000
*---------------------------------------------------------------------- 01000000
                                                                        01010000
         ST    R3,SAVER3          SAVE R3 FOR A WHILE                   01020000
         LA    R15,IVTXRTRY       RETRY ROUTINE ADDRESS                 01030000
         ST    R15,IVRRETAD       SET RETRY ROUTINE ADDRESS             01040000
         LA    R15,IVTAMRPA       PARAMETERS ADDRESS                    01050000
         ST    R15,IVRRPA@        SET ADDRESS FOR FRR                   01060000
         L     R0,=F'-1'          SHOW REGS RESTORED FROM PARM AREA     01070000
         STM   R0,R15,IVRR00      SAVE RETRY REGISTERS                  01080000
         MVC   IVRMOD,=CL8'IVTMTASK'                                    01090000
         MVC   IVRCSECT,=CL8'IVTMXDFA'                                  01100000
         MVC   IVRFRR,=CL8'IVTMXRCV'                                    01110000
         MVC   IVRTYPE,=CL8'ESTAEX'                                     01120000
         L     R3,=V(IVTMXRCV)    ADDR OF VTAM EXIT RECOVERY ROUTINE    01130000
         ICM   R0,15,PSATOLD      SRB MODE?                             01140000
         BZ    ESTFRR             BRANCH IF YES                         01150000
                                                                        01160000
         MVC   ESTAEMFL(L'ESTAEXPL),ESTAEXL                             01170000
                                                                        01180000
         ESTAEX (R3),                                                  +01190000
               CT,                                                     +01200000
               PARAM=RCVPARMS,                                         +01210000
               TERM=YES,                                               +01220000
               MF=(E,ESTAEMFL)    ESTABLISH RECOVERY                    01230000
                                                                        01240000
         OI    FLAG,FLESTAEX      RECOVERY ENVIRONMENT ESTABLISHED      01250000
         B     RECOVSET           AND CONTINUE                          01260000
                                                                        01270000
ESTFRR   DS    0H                                                       01280000
                                                                        01290000
         MVC   IVRTYPE,=CL8'FRR'                                        01300000
                                                                        01310000
         MODESET EXTKEY=ZERO,                                          +01320000
               SAVEKEY=(2)        SET KEY ZERO                          01330000
                                                                        01340000
         SETFRR A,                                                     +01350000
               FRRAD=(R3),                                             +01360000
               WRKREGS=(14,15),                                        +01370000
               PARMAD=FRRPARM     ESTABLISH RECOVERY                    01380000
                                                                        01390000
         L     R1,FRRPARM         PARM AREA FOR FRR                     01400000
         MVC   0(12,R1),RCVPARMS  SET TYPE & PARM AREA POINTER          01410000
                                                                        01420000
         MODESET KEYADDR=(2)      RESTORE PREVIOUS KEY                  01430000
                                                                        01440000
         OI    FLAG,FLFRR         RECOVERY ENVIRONMENT ESTABLISHED      01450000
         B     RECOVSET           AND CONTINUE                          01460000
                                                                        01470000
RECOVSET DS    0H                                                       01480000
                                                                        01490000
         L     R3,SAVER3          RESTORE THE PARM REG                  01500000
                                                                        01510000
*---------------------------------------------------------------------- 01520000
* ACCESS ISESS VIA NIB USERFLD AND VALIDATE USING VTAM CID.             01530000
*---------------------------------------------------------------------- 01540000
                                                                        01550000
         L     RIRPL,16(,R3)      READ-ONLY RPL ADDRESS                 01560000
         L     RISESS,8(,R3)      NIB USRFLD IS ISESS ADDRESS           01570000
         CLC   ISEID,=CL8'ISESS'  CHECK EYECATCHER?                     01580000
         BNE   QTOMAIN            BRANCH IF NOT GOOD                    01590000
         CLC   ISECID,4(R3)       DO THE CID'S MATCH?                   01600000
         BNE   QTOMAIN            BRANCH IF ISESS NO GOOD               01610000
         L     RITASK,ISEITASK    GET THE SESSION ITASK POINTER         01620000
         LA    R4,ISEWEQ          USE SESSION WORK QUEUE                01630000
         B     TRACE              CREATE WORK ELEMENT                   01640000
                                                                        01650000
*---------------------------------------------------------------------- 01660000
* ISESS WASN'T FOUND, SO QUEUE TO WORK ELEMENT TO MAIN TASK             01670000
*---------------------------------------------------------------------- 01680000
                                                                        01690000
QTOMAIN  DS    0H                                                       01700000
                                                                        01710000
         SR    RISESS,RISESS      SHOW NO ISESS                         01720000
         LA    R4,IVTWEQ          USE MAIN TASK WORK QUEUE              01730000
                                                                        01740000
*---------------------------------------------------------------------- 01750000
* TRACE THE MODULE ENTRY                                                01760000
*---------------------------------------------------------------------- 01770000
                                                                        01780000
TRACE    DS    0H                                                       01790000
                                                                        01800000
         $TRACE *=A(TRC_IVTMXDFA),32,STDENV=NO        32 USER BYTES     01810000
                                                                        01820000
         BNZ   NOMTRACE           BRANCH IF TRACING NOT AVAILABLE       01830000
                                                                        01840000
         ST    RITASK,0(,R1)      TRACE ITASK ADDRESS                   01850000
         ST    RISESS,4(,R1)      TRACE ISESS ADDRESS                   01860000
         ST    RIACB,8(,R1)       TRACE ACB ADDRESS                     01870000
         MVC   12(4,R1),4(R3)     TRACE CID                             01880000
         MVC   16(3,R1),RPLCNTRL  TRACE RPLCNTRL FOR RU-TYPE            01890000
         MVC   20(4,R1),8(R3)     TRACE PARM LIST USERFLD               01900000
                                                                        01910000
NOMTRACE DS    0H                                                       01920000
                                                                        01930000
*---------------------------------------------------------------------- 01940000
* ALLOCATE DFASY WORK ELEMENT                                           01950000
*---------------------------------------------------------------------- 01960000
                                                                        01970000
         $VTAMWE L'IWEX0,         SIZE                                 +01980000
               IWECXDFA           CODE                                  01990000
                                                                        02000000
         LR    RIWE,R1                                                  02010000
                                                                        02020000
*---------------------------------------------------------------------- 02030000
* BUILD DFASY WORK ELEMENT                                              02040000
*---------------------------------------------------------------------- 02050000
                                                                        02060000
         ST    RIACB,IWEX0ACB     SET ACB ADDRESS                       02070000
         MVC   IWEX0CID,4(R3)     SET CID                               02080000
         MVC   IWEX0USR,8(R3)     SET USERFLD                           02090000
         SR    R1,R1              CLEAR FOR IC                          02100000
         IC    R1,RPLLEN          LENGTH OF READ-ONLY RPL               02110000
         BCTR  R1,0               LENGTH CODE FOR MVC                   02120000
         EX    R1,COPYRPL         COPY RPL TO WORK ELEMENT              02130000
                                                                        02140000
*---------------------------------------------------------------------- 02150000
* QUEUE DFASY WORK ELEMENT TO VTAM MAIN/SESSION ITASK                   02160000
*---------------------------------------------------------------------- 02170000
                                                                        02180000
         $VTAMQ (RIWE),           WORK ELEMENT                         +02190000
               (R4),              QUEUE                                +02200000
               STDENV=NO          EXIT ROUTINE                          02210000
                                                                        02220000
         B     RETURN                                                   02230000
                                                                        02240000
*---------------------------------------------------------------------- 02250000
* RETRY ROUTINE SCHEDULED BY RECOVERY                                   02260000
*---------------------------------------------------------------------- 02270000
                                                                        02280000
IVTXRTRY DS    0H                                                       02290000
                                                                        02300000
         LTR   R0,R0              WERE REGISTERS RESTORED FOR RETRY?    02310000
         BM    REGSOK             BRANCH IF YES, READY TO EXIT          02320000
X        USING IVTAMRPA,R1        PARM AREA ADDRESS MUST BE IN R1       02330000
         LM    R0,R15,X.IVRR00    RESTORE ALL THE REGISTERS             02340000
         DROP  X                                                        02350000
                                                                        02360000
REGSOK   DS    0H                                                       02370000
                                                                        02380000
         ICM   R0,15,PSATOLD      SRB MODE?                             02390000
         BNZ   RETURN             BRANCH IF NOT                         02400000
         ICM   R1,B'0001',=X'80'  KEY 8 IN BITS 24-27                   02410000
         MODESET KEYREG=(R1)      SET KEY 8                             02420000
         B     RETURN             AND WE ARE READY TO EXIT              02430000
                                                                        02440000
*---------------------------------------------------------------------- 02450000
* RETURN TO VTAM FROM EXIT ROUTINE                                      02460000
*---------------------------------------------------------------------- 02470000
                                                                        02480000
RETURN   DS    0H                                                       02490000
                                                                        02500000
         TM    FLAG,FLESTAEX      IS ESTAEX ESTABLISHED?                02510000
         BNO   RETFRR             BRANCH IF NOT                         02520000
                                                                        02530000
         ESTAEX 0                 DELETE RECOVERY ENVIRONMENT           02540000
                                                                        02550000
         NI    FLAG,255-FLESTAEX  CLEAR FLAG                            02560000
         B     EXITNOW            AND EXIT                              02570000
                                                                        02580000
RETFRR   DS    0H                                                       02590000
                                                                        02600000
         TM    FLAG,FLFRR         IS FRR ESTABLISHED?                   02610000
         BNO   EXITNOW            BRANCH IF NOT                         02620000
                                                                        02630000
         MODESET EXTKEY=ZERO,                                          +02640000
               SAVEKEY=(2)        SET KEY ZERO                          02650000
                                                                        02660000
         SETFRR D,                                                     +02670000
               WRKREGS=(14,15)    DELETE RECOVERY ENVIRONMENT           02680000
                                                                        02690000
         MODESET KEYADDR=(2)      RESTORE PREVIOUS KEY                  02700000
                                                                        02710000
         NI    FLAG,255-FLFRR     CLEAR FLAG                            02720000
         B     EXITNOW            AND EXIT                              02730000
                                                                        02740000
EXITNOW  DS    0H                                                       02750000
                                                                        02760000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 02770000
                                                                        02780000
         #VTEXIT ,                RETURN                                02790000
                                                                        02800000
*---------------------------------------------------------------------- 02810000
*  CONSTANTS AND LITERALS                                               02820000
*---------------------------------------------------------------------- 02830000
                                                                        02840000
COPYRPL  MVC   IWEX0RPL(0),0(RIRPL) COPY READ-ONLY RPL TO IWE           02850000
                                                                        02860000
ESTAEXL  ESTAEX *-*,CT,MF=L       ESTAEX PLIST                          02870000
ESTAEXPL EQU   ESTAEXL,*-ESTAEXL                                        02880000
                                                                        02890000
         LTORG ,                                                        02900000
         PRINT NOGEN                                                    02910000
         IVTAMRPA ,               INTEGRATOR VTAM RECOVERY PARAMETERS   02920000
         IHAFRRS ,                MVS FRR STACK                         02930000
         IHAPSA ,                 MVS PREFIXED STORAGE AREA             02940000
         ISTDBIND ,               VTAM BIND IMAGE                       02950000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         02960000
         ICVT  ,                  INTEGRATOR CVT                        02970000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   02980000
         ITASK ,                  INTEGRATOR TASK BLOCK                 02990000
         IACB ,                   INTEGRATOR VTAM ACB+                  03000000
         IRPL ,                   INTEGRATOR VTAM RPL+                  03010000
         INIB ,                   INTEGRATOR VTAM NIB+                  03020000
         ISESS ,                  INTEGRATOR SESSION CONTROL BLOCK      03030000
         IVUSER ,                 INTEGRATOR VTAM USER CONTROL BLOCK    03040000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          03050000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       03060000
         EVCODES ,                INTEGRATOR EVENT CODES                03070000
         ABCODES ,                INTEGRATOR $ABEND CODES               03080000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     03090000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             03100000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             03110000
         IFGEXLST ,               VTAM EXIT LIST                        03120000
         END   ,                                                        03130000

IODBTYPI TITLE '- ODBC / VDB COLUMN DATA TYPE MAPPING'                  00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: IODBTYPI - ODBC / VDB column data type mapping               00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine is used to acquire an ODBC perspective on             00080000
*    data types defined in VDB columns.  It accepts SYSCOLUMNS          00090000
*    and associated SYSVARIABLES entries and updates the                00100000
*    DTQUERY request block to reflect the data type name,               00110000
*    precision, length, scale, radix, and nullability.                  00120000
*                                                                       00130000
*    VDB columns use both data types that map directly to               00140000
*    underlying STDENV table services data types, and those             00150000
*    that are composites mapped into STDENV data types via              00160000
*    additional logic.                                                  00170000
*                                                                       00180000
*    In the first case, IODBTYPS is called to acquire the               00190000
*    STDENV data type information.  The DTQUERY area passed by          00200000
*    the caller is completed with the appropriate STDENV data           00210000
*    type description.                                                  00220000
*                                                                       00230000
*    In the latter case data type information is generated              00240000
*    directly by this routine.                                          00250000
*                                                                       00260000
*    Like ODBC, STDENV table services implements both fixed and         00270000
*    varying length character and binary data types, as well as         00280000
*    a number of numeric data types.  STDENV data types                 00290000
*    generally support larger fixed length data types than does         00300000
*    ODBC.  Additionally, STDENV and ODBC each include data             00310000
*    types that do not map well into the other's.                       00320000
*                                                                       00330000
*    Consult the Microsoft Press "ODBC 2.0 Programmer's                 00340000
*    Reference and SDK Guide" for a discussion of data types            00350000
*    and the related topics of precision, length, scale and             00360000
*    radix.                                                             00370000
*                                                                       00380000
*                                                                       00390000
* ON ENTRY                                                              00400000
*                                                                       00410000
*    R1  contains the address of a parameter list constructed           00420000
*        as follows                                                     00430000
*                                                                       00440000
*        +00 - DTQUERY construction and return area address             00450000
*        +04 - address of a SYSCOLUMNS entry                            00460000
*        +08 - address of the associated SYSVARIABLES entry             00470000
*                                                                       00480000
*                                                                       00490000
* ON EXIT:                                                              00500000
*                                                                       00510000
*    R15 contains one of the following return codes.  R0 may            00520000
*        contain an associated reason code if applicable.               00530000
*        Note that return and reason code compatibility with            00540000
*        IODBTYPS is required.                                          00550000
*                                                                       00560000
*        RC00 - DTQUERY has been completed with information             00570000
*               describing the data type                                00580000
*                                                                       00590000
*        RC04 - DTQUERY failed                                          00600000
*                                                                       00610000
*               RSN04 - unrecognized data type                          00620000
*                                                                       00630000
*               RSN08 - length inconsistent with PRIMARY and/or         00640000
*                       NUMERIC data type code                          00650000
*                                                                       00660000
**<DOC-OFF>****************************************************         00670000
                                                                        00680000
         EJECT                                                          00690000
***************************************************************         00700000
*                                                                       00710000
*  MAINTENANCE:                                                         00720000
*                                                                       00730000
*    02/14/95  R. Turgeon    Int 2.0  ODCB Support                      00740000
*              Initial version                                          00750000
*                                                                       00760000
***************************************************************         00770000
                                                                        00780000
         EJECT                                                          00790000
         DTQUERY ,                REQUEST RESPONSE BLOCK                00800000
                                                                        00810000
         EJECT                                                          00820000
         ODBCSQLH ,               ODBC CONSTANTS, DEFINITIONS, ETC.     00830000
                                                                        00840000
         EJECT                                                          00850000
         @TBCOLDF ,               TABLE SERVICES COLUMN DEFINITION      00860000
                                                                        00870000
         EJECT                                                          00880000
         $ATTRIB ,                3270 ATTRIBUTE STRUCTURE / CONSTANTS  00890000
                                                                        00900000
         EJECT                                                          00910000
         TBEQUS ,                 TABLE SERVICES CONSTANTS              00920000
                                                                        00930000
         EJECT                                                          00940000
         ICATALOG COLUMNS,VARIABLES                                     00950000
                                                                        00960000
         EJECT                                                          00970000
         EQUS  ,                                                        00980000
                                                                        00990000
         EJECT                                                          01000000
         #WORK ,                                                        01010000
         #ENDWORK ,                                                     01020000
                                                                        01030000
         EJECT                                                          01040000
IODBTYPI #ENTER PREG=R8                                                 01050000
                                                                        01060000
         EJECT                                                          01070000
***************************************************************         01080000
*                                                                       01090000
*   Fetch passed parameters - initialize the DTQUERY request /          01100000
*   response area.  Then determine whether the column data type         01110000
*   is STDENV or a VDB extension.                                       01120000
*                                                                       01130000
***************************************************************         01140000
                                                                        01150000
         LM    R6,R7,4(R8)        FETCH VDB COMPONENT ENTRIES           01160000
         USING SYSCOLS,R6         SYSCOLUMNS                            01170000
         USING SVARSECT,R7        SYSVARIABLES                          01180000
         L     R8,0(,R8)          DTQUERY CONSTRUCTION/RETURN AREA      01190000
         USING DTQUERY,R8         LIFE OF FUNCTION                      01200000
                                                                        01210000
         XC    DTQUERY(DTQLN),DTQUERY                                   01220000
         MVC   DTQNULL,SCOLNULL   NULLABILITY                           01230000
                                                                        01240000
         LA    R1,NM_UNKNOWN      ASSUME DATA TYPE NOT IDENTIFIED       01250000
         ST    R1,DTQRNAME        POST IN RESPONSE AREA                 01260000
         L     R0,DTQSTGLN        STORAGE AREA LENGTH                   01270000
         ST    R0,DTQRLEN         ASSUMED AS TRUE LENGTH                01280000
                                                                        01290000
*--------------------------------------------------------------         01300000
*   Derive data length from SYSCOLUMN or backing SYSVARIABLE            01310000
*--------------------------------------------------------------         01320000
                                                                        01330000
         SR    R0,R0              PREPARE FOR INSERT                    01340000
         ICM   R0,3,SCOLLEN       VARIABLE LENGTH OVERRIDDEN?           01350000
         BNZ   LENSET             USE COLUMN VALUE                      01360000
                                                                        01370000
         LTR   R7,R7              SYSVARIABLE PROVIDED AS EXPECTED      01380000
         BZ    LENSET             TOLERATE SUSPICOUS CALL               01390000
         LH    R0,SVARLEN         ELSE DEFER TO VARIABLE DECLARATION    01400000
                                                                        01410000
LENSET   DS    0H                                                       01420000
                                                                        01430000
*--------------------------------------------------------------         01440000
*   Identify data type as either STDENV or VDB extension                01450000
*--------------------------------------------------------------         01460000
                                                                        01470000
         CLI   SCOLTYPE,SC$VDBX   DATA TYPE IS A VDB EXTENSION?         01480000
         BNL   VDBXTYPE           PROCESS VDB EXTENSION IF SO           01490000
                                                                        01500000
         EJECT                                                          01510000
***************************************************************         01520000
*                                                                       01530000
*   The column data type maps directly onto a STDENV table              01540000
*   services data type.  Complete the DTQUERY request block             01550000
*   and pass the query onto IODBTYPS for STDENV data type               01560000
*   resolution.                                                         01570000
*                                                                       01580000
*   R0 - data length extracted from SYSCOLUMN / SYSVARIABLE             01590000
*                                                                       01600000
***************************************************************         01610000
                                                                        01620000
         SR    R14,R14            PRIMARY TYPE                          01630000
         SR    R15,R15            NUMERIC TYPE                          01640000
                                                                        01650000
*--------------------------------------------------------------         01660000
*   VDB fixed length CHARACTER data type                                01670000
*--------------------------------------------------------------         01680000
                                                                        01690000
         CLI   SCOLTYPE,SC$CHAR   COLUMN IS CHARACTER                   01700000
         BNE   STD_CHAR                                                 01710000
                                                                        01720000
         LA    R14,$CHAR          STDENV CHAR                           01730000
         B     STDCALL            INHERIT LENGTH FROM DEFINITION        01740000
                                                                        01750000
STD_CHAR DS    0H                                                       01760000
                                                                        01770000
*--------------------------------------------------------------         01780000
*   VDB fixed length INTEGER data type                                  01790000
*--------------------------------------------------------------         01800000
                                                                        01810000
         CLI   SCOLTYPE,SC$INT    COLUMN IS INTEGER                     01820000
         BNE   STD_INT                                                  01830000
                                                                        01840000
         LA    R15,$NTINT         STDENV INTEGER, LENGTH IS FIXED       01850000
         LA    R0,TBC_LENGTH_INTEGER                                    01860000
         B     STDCALL                                                  01870000
                                                                        01880000
STD_INT  DS    0H                                                       01890000
         B     ERR_TYPE           TYPE NOT RECOGNIZED                   01900000
                                                                        01910000
*--------------------------------------------------------------         01920000
*   VDB fixed length INTEGER data type                                  01930000
*--------------------------------------------------------------         01940000
                                                                        01950000
STDCALL  DS    0H                                                       01960000
         STC   R14,DTQDTYPE       PRIMARY DATA TYPE                     01970000
         STC   R15,DTQNTYPE       NUMERIC DATA TYPE                     01980000
         ST    R0,DTQSTGLN        DATA LENGTH                           01990000
         ST    R0,DTQSTGMX        SAME AS MAX LENGTH                    02000000
                                                                        02010000
         @CALL IODBTYPS,MF=(E,DTQUERY)                                  02020000
                                                                        02030000
         B     RETURN             DONE                                  02040000
                                                                        02050000
         EJECT                                                          02060000
***************************************************************         02070000
*                                                                       02080000
*   The column data type map is a VDB extension.  The DTQUERY           02090000
*   response area is populated directly.                                02100000
*                                                                       02110000
*   R0 - data length extracted from SYSCOLUMN / SYSVARIABLE             02120000
*                                                                       02130000
***************************************************************         02140000
                                                                        02150000
VDBXTYPE DS    0H                                                       02160000
         CLI   SCOLTYPE,SC$ATT    COLUMN IS 3270 ATTRIBUTE STRUCTURE    02170000
         BNE   ERR_TYPE           OR INVALID                            02180000
                                                                        02190000
         LA    R0,NM_ATTRIBUTE    3270 ATTRIBUTE LABEL                  02200000
         ST    R0,DTQRNAME                                              02210000
         LA    R0,SC$ATT+100      DATA TYPE CODE                        02220000
         STH   R0,DTQRCODE                                              02230000
                                                                        02240000
         LA    R0,ATTRBLEN        STORED / TRANSMITTED STRUCTURE LENGTH 02250000
         ST    R0,DTQRLEN                                               02260000
         ST    R0,DTQRPREC                                              02270000
                                                                        02280000
         L     R14,=A(SQL_NULL_DATA)                                    02290000
         STH   R14,DTQRSCAL       SCALE IS NULL                         02300000
         STH   R14,DTQRADIX       RADIX IS NULL                         02310000
                                                                        02320000
         EJECT                                                          02330000
***************************************************************         02340000
*                                                                       02350000
*   Return result set and/or completion status to requester             02360000
*                                                                       02370000
***************************************************************         02380000
                                                                        02390000
NORMRET  DS    0H                                                       02400000
         LA    R15,RC00           RETRIEVAL COMPLETE                    02410000
         SR    R0,R0              REASON CODES NOT DEFINED              02420000
         B     RETURN                                                   02430000
                                                                        02440000
ERR_TYPE DS    0H                 DATA TYPE NOT RECOGNIZED              02450000
         LA    R15,RC04           ERROR                                 02460000
         LA    R0,RSN04                                                 02470000
         B     RETURN                                                   02480000
                                                                        02490000
ERR_LEN  DS    0H                 STG LENGTH CONFLICTS WITH TYPE        02500000
         LA    R15,RC04           ERROR                                 02510000
         LA    R0,RSN08                                                 02520000
         B     RETURN                                                   02530000
                                                                        02540000
RETURN   DS    0H                                                       02550000
         LA    R1,DTQUERY         RETURN POINTER TO REQ/RESP BLOCK      02560000
                                                                        02570000
         #EXIT ,                                                        02580000
                                                                        02590000
         EJECT                                                          02600000
***************************************************************         02610000
*                                                                       02620000
*   Local read-only working storage                                     02630000
*                                                                       02640000
***************************************************************         02650000
                                                                        02660000
NM_UNKNOWN     DCSZ  UNKNOWN                                            02670000
NM_ATTRIBUTE   DCSZ  '3270 ATTRIBUTE'                                   02680000
                                                                        02690000
*--------------------------------------------------------------         02700000
*   LITERALS, STDENV MAPPINGS, ETC                                      02710000
*--------------------------------------------------------------         02720000
                                                                        02730000
         LTORG ,                                                        02740000
                                                                        02750000
         PRINT NOGEN                                                    02760000
         ICVT ,                                                         02770000
         END   ,                                                        02780000

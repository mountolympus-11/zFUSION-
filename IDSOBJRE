IDSOBJRE TITLE 'DATASPACE SERVICES - OBJECT RENAME'                     00010000
         EJECT ,                                                        00020000
***************************************************************         00030000
*                                                                       00040000
*   READ / WRITE WORKING STORAGE AREA                                   00050000
*                                                                       00060000
***************************************************************         00070000
WORKAREA DSECT                                                          00080000
                                                                        00090000
         @WORK ,                  STANDARD WORKAREA                     00100001
                                                                        00110001
REGSAVE  DS    16F                LOCAL REG SAVEAREA                    00120000
                                                                        00130000
OIOFFSET DS    F                  OFFSET TO HASH ENTRY PTR              00140000
ONAMLEN  DS    F                  WORK AREA FOR LENGTH OF OBJECT NAME   00150000
NAMELEN  DS    F                  WORK AREA FOR LENGTH OF OBJECT NAME   00160000
POOLBASE DS    F                  WORK AREA FOR BASE OF OIE POOL        00170000
                                                                        00180000
WORKLEN  EQU   *-WORKAREA         WORKAREA LENGTH                       00190000
                                                                        00200001
         EJECT                                                          00210001
         OCRPARMS ,               OBJECT CREATE / LOCATE PLIST          00220000
                                                                        00230001
         EJECT                                                          00240001
         SPCBLOCK ,                                                     00250000
                                                                        00260001
         EJECT                                                          00270001
         OIE   ,                                                        00280000
                                                                        00290001
         EJECT                                                          00300001
         $TOKEN ,                                                       00310000
                                                                        00320001
         EJECT                                                          00330001
         EQUS  LINKAGE=VCON                                             00340000
                                                                        00350001
         EJECT                                                          00360001
**<DOC-ON>*****************************************************         00370001
*                                                                       00380000
* ROUTINE: IDSOBJRE - OBJECT RENAME                                     00390000
*                                                                       00400000
* DESCRIPTION:                                                          00410000
*                                                                       00420000
*                                                                       00430000
* ON ENTRY:                                                             00440000
*                                                                       00450000
*    R1 POINTS TO AN PARAMETER LIST DESCRIBED BY THE OCRPARMS           00460000
*       MAPPING MACRO                                                   00470000
*                                                                       00480000
*    A/R10 - AR QUALIFIED ADDRESS OF THE STORAGE SPCBLOCK               00490000
*                                                                       00500000
*                                                                       00510000
* ON EXIT:                                                              00520000
*                                                                       00530000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES                     00540000
*                                                                       00550000
*         0 - OBJECT RENAME                                             00560000
*         4 - DUPLICATE OBJECT NAME                                     00570000
*         8 - SERVICE ROUTINE FAILURE - RC=R0, R1=OFFSET                00580000
*        12 - OBJECT NOT FOUND                                          00590000
*        16 - INVALID REQUEST                                           00600000
*        20 - ALU TRANSLATION ERROR                                     00610000
*                                                                       00620000
**<DOC-OFF>****************************************************         00630001
                                                                        00640001
         EJECT                                                          00650001
IDSOBJRE @ENTER WORKA=(WORKAREA,WORKLEN)                                00660000
                                                                        00670000
         LAE   R7,0(R1,0)         FETCH PASSED PARAMETERS               00680001
         USING OCRPARMS,R7        PLIST ADDRESSABILITY                  00690000
                                                                        00700000
*--------------------------------------------------------------         00710000
*   VALIDATE PASSED PARAMETERS - OPEN OBJECT SPACE WINDOWS              00720000
*--------------------------------------------------------------         00730000
         L     R2,OCRSTOKN        SPACE TOKEN                           00740000
         LAE   R2,0(R2,0)         RESIDES IN PRIMARY                    00750001
         USING $TOKEN,R2          ADDRESSABILITY                        00760000
         CLC   $TOKTAG,=CL8'SPCTOKEN'                                   00770000
         BNE   ERR_REQ            VALIDATED                             00780000
                                                                        00790000
         L     R10,$SPCBASE       ESTAB PRINCIPLE SPACE ACCESS WINDOW   00800000
         USING SPCBLOCK,R10                                             00810000
         LAM   R10,R10,$ALET                                            00820000
         DROP  R2                 SPACE TOKEN                           00830000
                                                                        00840000
         LAE   R11,SPCBLOCK       OPEN WINDOW TO SPACE                  00850001
         LAE   R9,SPCBLOCK        OPEN WINDOW TO SPACE                  00860001
         LAE   R8,SPCBLOCK        OPEN WINDOW TO SPACE                  00870001
                                                                        00880000
         ICM   R4,15,OCRONAML     VALIDATE OLD NAME LENGTH              00890000
         BNP   ERR_REQ            INVALID REQUEST                       00900000
         CH    R4,=AL2(L'OIENAME) TOO LONG?                             00910000
         BH    ERR_REQ            FAIL IF SO                            00920000
         L     R5,OCRONAME        NAME STRING                           00930000
                                                                        00940001
         @TRIM 0(R5),0(R4),CHAR=C' '                                    00950000
                                                                        00960001
         LTR   R1,R1              VALID NAME?                           00970000
         BNP   ERR_REQ            FAIL IF NOT                           00980000
         ST    R1,ONAMLEN         PRESERVE TRUE OLD NAME LENGTH         00990000
                                                                        01000000
         ICM   R4,15,OCRNAMLN     VALIDATE NEW NAME LENGTH              01010000
         BNP   ERR_REQ            INVALID REQUEST                       01020000
         CH    R4,=AL2(L'OIENAME) TOO LONG?                             01030000
         BH    ERR_REQ            FAIL IF SO                            01040000
         L     R5,OCRNAME         NAME STRING                           01050000
                                                                        01060001
         @TRIM 0(R5),0(R4),CHAR=C' '                                    01070000
                                                                        01080001
         LTR   R1,R1              VALID NEW NAME?                       01090000
         BNP   ERR_REQ            FAIL IF NOT                           01100000
         ST    R1,NAMELEN         PRESERVE TRUE NEW NAME LENGTH         01110000
                                                                        01120000
*--------------------------------------------------------------         01130000
*   ENSURE NEW NAMED OBJECT DOES NOT ALREADY EXIST                      01140000
*--------------------------------------------------------------         01150000
OIELOCN  DS    0H                                                       01160000
         @CALL IDSOBJLU,(*NAMELEN,*OCRNAME),                           X01170000
               MF=(E,MFE_LIST)                                          01180000
                                                                        01190000
         CH    R15,=AL2(RC04)     OBJECT NOT FOUND IS DESIRED           01200000
         BL    ERR_DUPL           ERROR IF ALREADY DEFINED              01210000
         BH    ERR_SERV           PASSTHRU MORE SERIOUS ERRORS          01220000
         ST    R0,OIOFFSET        SAVE HASH TABLE ENTRY OFFSET          01230000
                                                                        01240000
*--------------------------------------------------------------         01250000
*   LOCATE OLD NAMED OBJECT                                             01260000
*--------------------------------------------------------------         01270000
OIELOCO  DS    0H                                                       01280000
         @CALL IDSOBJLU,(*ONAMLEN,*OCRONAME),                          X01290000
               MF=(E,MFE_LIST)                                          01300000
                                                                        01310000
         LTR   R15,R15            WAS OLD NAMED OBJECT FOUND?           01320000
         BNZ   ERR_NFND           ERROR IF ALREADY DEFINED              01330000
         LR    R8,R1              RETAIN OIE OFFSET TEMPORARILY         01340000
                                                                        01350000
*--------------------------------------------------------------         01360000
*   DECLARE INTENT TO UPDATE OIEPOOL                                    01370000
*--------------------------------------------------------------         01380000
         LAE   R9,SPC_POOL_OIE    OIE POOL                              01390000
         USING OIE,R9             ADDRESSABILITY                        01400000
                                                                        01410001
         OIECHG ,                 POOL WILL BE UPDATED                  01420000
                                                                        01430000
*--------------------------------------------------------------         01440000
*   MARK TARGET OIE UPDATED                                             01450001
*--------------------------------------------------------------         01460000
         L     R1,SPC_POOL_OIE+(OIESTORG-OIE)                           01470000
         @ALU  (R1)               ACQUIRE OIE POOL ORIGIN ADDR          01480000
         BNZ   ERR_ALU            ALU TRANSLATION ERROR                 01490000
         ST    R1,POOLBASE        SAVE POOL ORIGIN ADDR                 01500000
         LA    R9,0(R8,R1)        TARGET OIE                            01510000
                                                                        01520000
         OIECHG ,                 POOL WILL BE UPDATED                  01530000
         DROP  R9                 OLD OIE                               01540000
                                                                        01550000
*--------------------------------------------------------------         01560000
*   DEQUEUE OIE FROM HASH TABLE                                         01570000
*--------------------------------------------------------------         01580000
OIEDEQ   DS    0H                                                       01590000
TARG     USING OIE,R9                   DEQUEUE TARGET OIE              01600000
LINK     USING OIE,R8                   OIE'S LINKED TO TARGET          01610000
                                                                        01620000
         LA    R11,SPC_OBJ_INDEX        OBJECT INDEX HASH TABLE BASE    01630000
         A     R11,TARG.OIEHASHX        SYNONYM LIST HEAD               01640000
                                                                        01650000
         CLC   0(4,R11),TARG.OIEDISPL   IS TARGET FIRST IN CHAIN?       01660000
         BNE   *+10                     SKIP IF NOT                     01670000
         MVC   0(4,R11),TARG.OIEHASHF   ELSE MOVE TOP OF LIST           01680000
                                                                        01690000
         ICM   R8,15,TARG.OIEHASHF      OIE'S FOLLOWING TARGET?         01700000
         BZ    *+14                     SKIP IF NOT                     01710000
         A     R8,POOLBASE              ASSOCIATED OIE ADDR             01720000
         MVC   LINK.OIEHASHB,TARG.OIEHASHB                              01730000
                                                                        01740000
         ICM   R8,15,TARG.OIEHASHB      OIE'S PRECEEDING TARGET?        01750000
         BZ    *+14                     SKIP IF NOT                     01760000
         A     R8,POOLBASE              ASSOCIATED OIE ADDR             01770000
         MVC   LINK.OIEHASHF,TARG.OIEHASHF                              01780000
         DROP  TARG,LINK                OIE TARGET AND LINK             01790000
                                                                        01800000
*--------------------------------------------------------------         01810000
*   RENAME THE OIE                                                      01820000
*--------------------------------------------------------------         01830000
         USING OIE,R9                                                   01840000
                                                                        01850001
REN_OIE  DS    0H                 INITIALIZE OIE                        01860000
         MVI   OIENAME,C' '       START CLEARING THE OLD NAME           01870000
         MVC   OIENAME+1(L'OIENAME-1),OIENAME   NOW THE REST            01880000
         L     R5,OCRNAME         LOCATE OBJECT NAME                    01890000
         L     R4,NAMELEN         OBJECT NAME LENGTH                    01900000
         STH   R4,OIENAMLN        SAVE LENGTH OF OBJECT NAME            01910000
         BCTR  R4,0               PREPARE FOR EX                        01920000
         EX    R4,*+4             APPEND OBJECT NAME TO OIE             01930000
         MVC   OIENAME(*-*),0(R5) EX OBJECT                             01940000
         MVC   OIEHASHX,OIOFFSET  RESET HASH OFFSET                     01950000
                                                                        01960000
         OIECHG ,                                                       01970000
         DROP  R9                                                       01980000
                                                                        01990001
*--------------------------------------------------------------         02000000
*   ADD OIE TO OIE MASTER LIST AND HASHED OBJECT INDEX                  02010000
*--------------------------------------------------------------         02020000
NEW      USING OIE,R9             NEWLY CREATED OIE                     02030000
FIRST    USING OIE,R8             OIE AT FRONT OF LIST BEFORE INSERT    02040000
                                                                        02050000
FINMASTR DS    0H                                                       02060000
         LA    R11,SPC_OBJ_INDEX  HASH TABLE ORIGIN                     02070000
         A     R11,NEW.OIEHASHX   LOCATE DESIGNATED ENTRY               02080000
         MVC   NEW.OIEHASHF,0(R11)                                      02090000
         MVC   0(4,R11),NEW.OIEDISPL                                    02100000
         ICM   R8,15,NEW.OIEHASHF                                       02110000
         BZ    FINHASH                                                  02120000
         A     R8,POOLBASE        CONVERT OIE DISPL TO ADDR             02130000
         MVC   FIRST.OIEHASHB,NEW.OIEDISPL                              02140000
                                                                        02150000
FINHASH  DS    0H                                                       02160000
         DROP  FIRST              FIRST OIE                             02170000
                                                                        02180000
         EJECT                                                          02190001
***************************************************************         02200000
*                                                                       02210000
*   RETURN COMPLETION STATUS TO CALLER                                  02220000
*                                                                       02230000
***************************************************************         02240000
         LA    R15,RC00           NORMAL COMPLETION                     02250000
         B     RET                                                      02260000
                                                                        02270000
ERR_DUPL DS    0H                 DUPLICATE OBJECT NAME                 02280000
         LA    R15,RC04                                                 02290000
         B     RET                                                      02300000
                                                                        02310000
ERR_NFND DS    0H                 OLD NAMED OBJECT NOT FOUND            02320000
         LA    R15,RC12                                                 02330000
         B     RET                                                      02340000
                                                                        02350000
ERR_REQ  DS    0H                 INVALID REQUEST                       02360000
         LA    R15,RC16                                                 02370000
         B     RET                                                      02380000
                                                                        02390000
ERR_ALU  DS    0H                 ALU TRANSLATION ERROR                 02400000
         LA    R15,RC20                                                 02410000
         B     RET                                                      02420000
                                                                        02430000
ERR_SERV DS    0H                 SERVICE ROUTINE FAILURE               02440000
         LR    R0,R15                                                   02450000
         LR    R1,R14                                                   02460000
         SL    R1,R12                                                   02470000
         LA    R15,RC08                                                 02480000
                                                                        02490000
*--------------------------------------------------------------         02500000
*   RETURN COMPLETION STATUS TO CALLER                                  02510000
*--------------------------------------------------------------         02520000
RET      DS    0H                                                       02530000
         @EXIT ,                                                        02540000
                                                                        02550000
         EJECT ,                                                        02560000
***************************************************************         02570000
*                                                                       02580000
*   READ ONLY CONSTANTS, ETC.                                           02590001
*                                                                       02600000
***************************************************************         02610000
         LTORG ,                                                        02620000
         END   ,                                                        02630000

IPRCSERV TITLE '- PROCESS MANAGER SERVICES'                             00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE: IPRCSERV - Process manager services                          00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine provides an interface to the Process Manager          00080000
*    Services via the $PROC macro.  Each request is routed              00090000
*    to the associated routine.   Process manager services              00100000
*    provides the ability to Create/Delete/Terminate PCB                00110000
*    workunits within an ITASK.  Upon return from the                   00120000
*    associated service routine,  an internal trace entry               00130000
*    is cut to trace the request.                                       00140000
*                                                                       00150000
*                                                                       00160000
* ON ENTRY:                                                             00170000
*                                                                       00180000
*    R1 contains the address of the parameter list mapped by            00190000
*    the PROCPL dsect generated by $PROC DSECT=YES.                     00200000
*                                                                       00210000
* ON EXIT:                                                              00220000
*                                                                       00230000
*    R15 contains one of the following return codes:                    00240000
*                                                                       00250000
*        RC00 - Normal completion                                       00260000
*        RC16 - Service Failure (INTERNAL)                              00270000
*        RC20 - Request Error                                           00280000
*        RC24 - Invalid request code                                    00290000
*                                                                       00300000
*    For non-zero completion codes,  R0 will contain a reason           00310000
*    code associated with the specified function that is                00320000
*    requested.  The requested function code * 100 will be              00330000
*    added to the reason in order to assign a unique reason             00340000
*    code for the requested process manager service.  Below is          00350000
*    the range of reason codes and their associated functions.          00360000
*    Please refer to the documentation prolog in each of the            00370000
*    requested function routines for a detailed description of          00380000
*    the reason code:                                                   00390000
*                                                                       00400000
*        RSN RANGE     REQUEST      ROUTINE                             00410000
*        ---------     -----------  -------------------                 00420000
*        100 - 199     CREATE       IPRCCREA                            00430000
*        200 - 299     DELETE       IPRCDEL                             00440000
*        300 - 399     STOP         IPRCSTOP                            00450000
*        400 - 499     CHAP         IPRCCHAP                            00460000
*                                                                       00470000
* MODE:                                                                 00480000
*                                                                       00490000
*    TASK                                                               00500000
*    APF/NON-APF                                                        00510000
*    SUP/PROB                                                           00520000
*    AMODE 31, RMODE ANY                                                00530000
*                                                                       00540000
**<DOC-OFF>*****************************************************        00550000
                                                                        00560000
         EJECT ,                                                        00570000
****************************************************************        00580000
*                                                                       00590000
* MAINTENANCE:                                                          00600000
*                                                                       00610000
*   04/21/93 Ron Colmone                                                00620000
*            Initial Version                                            00630000
*                                                                       00640000
*   11/09/95 R. Turgeon           Rel 2.1                               00650000
*            Modified to suport new $TRACE requirements                 00660000
*            Reduced size of #WORK workarea.                            00670000
*                                                                       00680000
****************************************************************        00690000
                                                                        00700000
         EJECT                                                          00710000
         $PROC DSECT=YES          PROCESS MGR PLIST                     00720000
                                                                        00730000
         EJECT                                                          00740000
         EQUS  ,                  GENERAL EQUATES                       00750000
                                                                        00760000
         EJECT                                                          00770000
         TRACODES ,               TRACE EVENT CODES                     00780000
                                                                        00790000
         EJECT                                                          00800000
         #WORK LENGTH=#TSKWKLN,PLIST=NO                                 00810000
WRKPASS  DS    XL512              WAREA TO PASS TO SUPPORT RTNS         00820000
         #ENDWORK ,               LENGTH OF WORKAREA                    00830000
                                                                        00840000
         EJECT ,                                                        00850000
IPRCSERV #ENTER BASE=R12,         ENTRY LINKAGE                        +00860000
               PREG=R8,                                                +00870000
               WAPASS=YES                                               00880000
                                                                        00890000
         USING ITASK,R10          STDENV                                00900000
                                                                        00910000
         USING PROCPL,R8          ESTABLISH ADDRESSABILITY              00920000
                                                                        00930000
         EJECT ,                                                        00940000
****************************************************************        00950000
*                                                                       00960000
*  CALL APPROPRIATE FUNCTION PROCESSING RTN                             00970000
*                                                                       00980000
****************************************************************        00990000
                                                                        01000000
         SR    R2,R2              PREPARE FOR INSERT                    01010000
         ICM   R2,1,PPLFUNC       GET $PROC FUNC CODE                   01020000
         BZ    ERR_FUNC           INVALID FUNCTION SPECIFIED            01030000
                                                                        01040000
         C     R2,=A(PRCSERV#)    VALID FUNCTION REQUESTED              01050000
         BH    ERR_FUNC           INVALID FUNCTION SPECIFIED            01060000
         BCTR  R2,0               PREPARE FOR TABLE INDEX               01070000
         SLL   R2,2               MULT BY 4, TABLE INDEX                01080000
                                                                        01090000
         L     R15,PRCSERV(R2)    ADDR OF SERV ROUTINE                  01100000
         LR    R1,R8              ADDR OF PARAMETER LIST                01110000
         LA    R0,WRKPASS         ADDR OF WORKAREA                      01120000
         BASR  R14,R15            CALL SERVICE ROUTINE                  01130000
         B     RETURN             RETURN                                01140000
                                                                        01150000
*---------------------------------------------------------------        01160000
*  RETURN TO CALLER                                                     01170000
*---------------------------------------------------------------        01180000
                                                                        01190000
ERR_FUNC DS    0H                                                       01200000
         LA    R15,RC24           INVALID FUNCTION CODE                 01210000
                                                                        01220000
RETURN   DS    0H                                                       01230000
         STM   R0,R15,WRKPASS     SAVE REGISTERS                        01240000
                                                                        01250000
         SR    R2,R2              PREPARE FOR INSERT                    01260000
         IC    R2,PPLFUNC         RETRIEVE PROC FUNC CODE               01270000
         LA    R2,TRC_PROCSRV(,R2) PROC SERVICE TRACE CODE RANGE        01280000
                                                                        01290000
         $TRACE (R2),4*4,FORCE=*WRKPASS+(4*R15)                         01300000
         BNZ   TRC_END            TRACE INACTIVE                        01310000
                                                                        01320000
         SR    R2,R2              PREPARE FOR INSERT                    01330000
         IC    R2,PPLFUNC         GET PROCESS FUNCTION                  01340000
         ST    R2,0(,R1)          FUNCTION CODE                         01350000
         L     R14,4(,R13)        CALLER'S SAVE AREA                    01360000
         L     R14,12(,R14)       GET RETURN ADDRESS                    01370000
         ST    R14,4(,R1)               R14                             01380000
         MVC   8(4,R1),WRKPASS+(4*R15)  R15                             01390000
         MVC   12(4,R1),WRKPASS         R0                              01400000
                                                                        01410000
TRC_END  DS    0H                                                       01420000
         LM    R0,R15,WRKPASS     RESTORE REGISTERS                     01430000
                                                                        01440000
         LTR   R15,R15            SUCCESSFUL COMPLETION?         159456 01450000
         BZ    RET_EXIT           YES, ALL DONE                  159456 01460000
                                                                        01470000
         SR    R2,R2              PREPARE FOR INSERT             159456 01480000
         IC    R2,PPLFUNC         GET FUNCTION CODE              159456 01490000
         MH    R2,=AL2(100)       FUNCTION CODE * 100            159456 01500000
         AR    R0,R2              ADD TO REASON CODE             159456 01510000
                                                                        01520000
RET_EXIT DS    0H                                                       01530000
         #EXIT ,                  RETURN                                01540000
                                                                        01550000
         EJECT ,                                                        01560000
****************************************************************        01570000
*                                                                       01580000
*  PROCESS MANAGER SERVICE TABLE                                        01590000
*                                                                       01600000
****************************************************************        01610000
PRCSERV  DS    0F                                                       01620000
         DC    V(IPRCCREA)        1 - CREATE   PROCESS                  01630000
         DC    V(IPRCDEL)         2 - DELETE   PROCESS                  01640000
         DC    V(IPRCSTOP)        3 - STOP     PROCESS                  01650000
         DC    V(IPRCCHAP)        4 - CHANGE DISPATCH PRIORITY          01660000
PRCSERV# EQU   (*-PRCSERV)/4      SERVICE RTN FUNCTION CNT              01670000
                                                                        01680000
         LTORG ,                                                        01690000
                                                                        01700000
         PRINT NOGEN                                                    01710000
         ICVT  ,                                                        01720000
         ITASK ,                                                        01730000
         END   ,                                                        01740000

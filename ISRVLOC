ISRVLOC  TITLE '- Locate ITASK attached to Server'                      00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE: ISRVLOC - Locate ITASK attached to Server task               00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine will attempt to locate the requested task             00080000
*    by name within the current server task.  If the request            00090000
*    is being issued from within a server, a not found (RC04)           00100000
*    return code will be issued.  This service only allows              00110000
*    for the current ITASK to be queried,  thus not requiring           00120000
*    any locks to be held.  The WULOC service should be used            00130000
*    to locate an ITASK where the server is unknown.                    00140000
*                                                                       00150000
* ON ENTRY:                                                             00160000
*                                                                       00170000
*    R1 Contains the address of the parameter list mapped by            00180000
*    the SRVPL dsect generated by $SERVER DSECT=YES.                    00190000
*                                                                       00200000
* ON EXIT:                                                              00210000
*                                                                       00220000
*    R15 Contains one of the following return codes:                    00230000
*                                                                       00240000
*        RC00 - Normal completion                                       00250000
*               R1 - Address of ITASK                                   00260000
*                                                                       00270000
*        RC04 - ITASK not found                                         00280000
*                                                                       00290000
*        RC20 - Request Error                                           00300000
*               RSN04 - TASK name required for request                  00310000
*                                                                       00320000
* MODE:                                                                 00330000
*                                                                       00340000
*    TASK                                                               00350000
*    APF/NON-APF                                                        00360000
*    SUP/PROB                                                           00370000
*    AMODE 31, RMODE ANY                                                00380000
*                                                                       00390000
**<DOC-OFF>*****************************************************        00400000
                                                                        00410000
         EJECT ,                                                        00420000
****************************************************************        00430000
*                                                                       00440000
* MAINTENANCE:                                                          00450000
*                                                                       00460000
*   02/07/95 Ron Colmone          Par# 159456                           00470000
*            Initial Version                                            00480000
*                                                                       00490000
****************************************************************        00500000
                                                                        00510000
         EJECT ,                                                        00520000
         $SERVER DSECT=YES        TASKMGR SERVER PLIST                  00530000
                                                                        00540000
         EJECT ,                                                        00550000
         EQUS  ,                  GENERAL EQUATES                       00560000
*                                                                       00570000
         ABCODES ,                $ABEND CODES                          00580000
                                                                        00590000
         EJECT ,                                                        00600000
         #WORK LENGTH=512         READ/WRITE WORKAREA                   00610000
         #ENDWORK                 END OF WORKAREA                       00620000
                                                                        00630000
         EJECT ,                                                        00640000
ISRVLOC  #ENTER BASE=R12,         ENTRY LINKAGE                        +00650000
               PREG=R8,                                                +00660000
               WAPASS=YES                                               00670000
                                                                        00680000
         USING SRVPL,R8           ADDRESSABILITY                        00690000
         USING ITASK,R10          ADDRESSABILITY (current)              00700000
S        USING ITASK,R5           ADDRESSABILITY (SERVER)               00710000
                                                                        00720000
         EJECT ,                                                        00730000
*---------------------------------------------------------------        00740000
*  Validate required parameters                                         00750000
*---------------------------------------------------------------        00760000
         ICM   R4,15,SVPLNAME     ADDRESS OF ITASK TO ATTACH            00770000
         BZ    ERR_NAME           REQUIRED                              00780000
                                                                        00790000
         LR    R5,R10             ASSUME SERVER TASK IS ACTIVE          00800000
         CLI   TSKTYPE,TSKT$SRV   IS CURRENT TASK A SERVER TASK         00810000
         BE    SERVER             YES, ADDRESS OF                       00820000
         ICM   R5,15,TSKSVTSK     ADDRESS OF SERVER ITASK               00830000
         BZ    RET_RC04           NONE,  REQ NOT UNDER SERVER           00840000
                                                                        00850000
SERVER   DS    0H                                                       00860000
         ICM   R6,15,S.TSKSRV     GET ADDRESS OF SERVER EXTENSION       00870000
         BZ    RET_RC04           SERVER EXTENSION NOT AVAILABLE        00880000
         USING SERVERX,R6         ADDRESSABILITY                        00890000
                                                                        00900000
         EJECT ,                                                        00910000
*---------------------------------------------------------------        00920000
*  Scan the server attached task queue attempting to locate             00930000
*  the request task.                                                    00940000
*---------------------------------------------------------------        00950000
         LA    R7,SRVTASKF        ADDRESS OF SERVER TASK QUEUE          00960000
         SH    R7,=AL2(SATNEXT-SRVATASK)  BACKUP OFFSET TO LINK         00970000
         USING SRVATASK,R7        ADDRESSABILITY                        00980000
                                                                        00990000
LOC_NEXT DS    0H                                                       01000000
         ICM   R7,15,SATNEXT      ADDRESS OF NEXT ATTACHED TASK         01010000
         BZ    RET_RC04           ITASK NOT FOUND                       01020000
                                                                        01030000
         L     R1,SATTASK         ADDRESS OF ATTACHED TASK              01040000
T        USING ITASK,R1           ADDRESSABILITY                        01050000
                                                                        01060000
         CLC   T.TSKNAME,0(R4)    REQUESTED TASK NAME AVAILABLE         01070000
         BNE   LOC_NEXT           NOT FOUND, LOCATE NEXT ITASK          01080000
                                                                        01090000
         LA    R15,RC00           NORMAL COMPLETION                     01100000
         B     RETURN             RETURN                                01110000
                                                                        01120000
         EJECT ,                                                        01130000
****************************************************************        01140000
*                                                                       01150000
*   ERROR EXIT                                                          01160000
*                                                                       01170000
****************************************************************        01180000
                                                                        01190000
ERR_NAME DS    0H                                                       01200000
         LA    R0,RSN04           TASKNAME REQUIRED                     01210000
         B     RET_RC20           REQUEST ERROR                         01220000
                                                                        01230000
         EJECT ,                                                        01240000
****************************************************************        01250000
*                                                                       01260000
*   RETURN                                                              01270000
*                                                                       01280000
****************************************************************        01290000
                                                                        01300000
RET_RC04 DS    0H                                                       01310000
         LA    R15,RC04           TASK NOT FOUND                        01320000
         B     RETURN                                                   01330000
                                                                        01340000
RET_RC20 DS    0H                                                       01350000
         LA    R15,RC20           REQUEST ERROR                         01360000
         B     RETURN                                                   01370000
                                                                        01380000
RETURN   DS    0H                                                       01390000
         #EXIT ,                  RETURN                                01400000
                                                                        01410000
         EJECT ,                                                        01420000
****************************************************************        01430000
*                                                                       01440000
*  CONSTANTS AND LITERALS                                               01450000
*                                                                       01460000
****************************************************************        01470000
                                                                        01480000
         LTORG ,                                                        01490000
                                                                        01500000
         PRINT NOGEN                                                    01510000
         ICVT  ,                                                        01520000
         ITASK ,                                                        01530000
         SERVERX ,                                                      01540000
         SRVATASK ,                                                     01550000
                                                                        01560000
         END   ,                                                        01570000

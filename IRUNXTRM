IRUNXTRM TITLE '- PLAN EXECUTION TERMINATION / NOTIFICATION'            00010000
**<DOC-ON>*******************************************************       00020000
*                                                                       00030000
* ROUTINE:  IRUNXTRM - Plan execution termination / notification        00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine is responsible for notifying the requesting           00080000
*    process that plan execution has completed or terminated.           00090000
*    Additionally, it $RESMGR CALLs the resource manager                00100000
*    responsible for managing SQL data areas shared between this        00110000
*    process and the requesting process.  The resource manager          00120000
*    routine actually runs only if the requesting process has           00130000
*    prematurely terminated.                                            00140000
*                                                                       00150000
*                                                                       00160000
* ON ENTRY:                                                             00170000
*                                                                       00180000
*    R1  contains the address of a parameter list constructed as        00190000
*        follows                                                        00200000
*                                                                       00210000
*         +00 - addr of the SLU session handle (SLUHANDL)               00220000
*         +04 - plan end completion code                                00230000
*         +08 - plan end reason code                                    00240000
*         +12 - plan end qualifier #1                                   00250000
*         +16 - plan end qualifier #2                                   00260000
*                                                                       00270000
*                                                                       00280000
* ON EXIT:                                                              00290000
*                                                                       00300000
*    R15 - R1 contain the $TSEND requester notification status          00310000
*             $TSEND or -RC04 if that logic is not reached              00320000
*                                                                       00330000
**<DOC-OFF>******************************************************       00340000
                                                                        00350000
         EJECT                                                          00360000
*****************************************************************       00370000
*                                                                       00380000
* MAINTENANCE:                                                          00390000
*                                                                       00400000
*    12/18/95 R. Turgeon          Rel 2.1                               00410000
*             Initial version                                           00420000
*                                                                       00430000
*****************************************************************       00440000
                                                                        00450000
         EJECT                                                          00460000
         SLUHANDL ,               SLU SESSION HANDLE (COMM AREA)        00470000
                                                                        00480000
         EJECT                                                          00490000
         NAV   ,                  NAVIGATION STRUCTURES, INCLUDING AAP  00500000
                                                                        00510000
         EJECT                                                          00520000
         $RESMGR DSECT=YES        RESOURCE MANAGER PLIST                00530000
                                                                        00540000
         EJECT                                                          00550000
         $TSEND  DSECT=YES        INTERWU MESSAGING                     00560000
                                                                        00570000
         EJECT                                                          00580000
         EQUS  ,                  GENERAL EQUATES                       00590000
                                                                        00600000
         ABCODES PRINT=NOGEN      $ABEND CODES                          00610000
                                                                        00620000
         MSGCODES ,               INTERTASK MESSAGE CODES               00630000
                                                                        00640000
         EJECT                                                          00650000
         #WORK ,                                                        00660000
                                                                        00670000
ENVFLGS  DS    X                  ENVIRONMENTAL FLAGS                   00680000
ENVLOCK  EQU   X'80'                 DISP LOCK ACQUIRED                 00690000
                                                                        00700000
RSVD1    DS    XL3                RESERVED                              00710000
                                                                        00720000
PLANSTAT DS    0F                 PLAN END COMPLETION STATUS            00730000
PLNSTRC  DS    F                     RETURN CODE                        00740000
PLNSTRSN DS    F                     REASON CODE                        00750000
PLNSTQ1  DS    F                     QUALIFIER #1                       00760000
PLNSTQ2  DS    F                     QUALIFIER #2                       00770000
                                                                        00780000
STATREGS DS    3F                 R15-R1 STATUS REGS                    00790000
                                                                        00800000
$RESMFL  $RESMGR MF=(L,*)         $RESMGR PLIST CONSTRUCTION            00810000
$TSEMFL  $TSEND  MF=(L,*)         $TSEND  PLIST CONSTRUCTION            00820000
                                                                        00830000
         #ENDWORK ,               WORKAREA END                          00840000
                                                                        00850000
         EJECT                                                          00860000
***************************************************************         00870000
*                                                                       00880000
*   General initialization                                              00890000
*                                                                       00900000
***************************************************************         00910000
                                                                        00920000
IRUNXTRM #ENTER PREG=R8                                                 00930000
                                                                        00940000
         USING ITASK,R10          STDENV                                00950000
                                                                        00960000
         EJECT                                                          00970000
*--------------------------------------------------------------         00980000
*   fetch passed parameters                                             00990000
*--------------------------------------------------------------         01000000
                                                                        01010000
         LA    R15,RC04           PRESUME FAILURE                       01020000
         LNR   R15,R15            NOTIFICATION NOT REACHABLE            01030000
         ST    R15,STATREGS       PREPARED FOR RETURN                   01040000
                                                                        01050000
         MVC   PLANSTAT(4*4),4(R8)   PLAN END COMPLETION STATUS         01060000
                                                                        01070000
         L     R8,0(,R8)          SLU SESSION HANDLE                    01080000
         USING SLUHANDL,R8        SLU SESSION HANDLE                    01090000
                                                                        01100000
         ICM   R5,15,SLHAAP       AAP AVAILABLE                         01110000
         BZ    NOTIFY             PREMATURE TERM OF AAP IF NOT          01120000
         USING AAP,R5             APPLICATION ACTION BLOCK              01130000
                                                                        01140000
         EJECT                                                          01150000
***************************************************************         01160000
*                                                                       01170000
*   Call the SQL cleanup RMX to ensure that resources are               01180000
*   released even if the requesting process has terminated              01190000
*   prematurely.  If it has not, the CALL is treated as a               01200000
*   DELETE because the associated use count will not have               01210000
*   gone to zero.                                                       01220000
*                                                                       01230000
***************************************************************         01240000
                                                                        01250000
         ICM   R0,15,AAPSQLTK     SQL CLEANUP RMX PENDING?              01260000
         BZ    FSQLEND            DONE HERE IF NOT                      01270000
                                                                        01280000
         $RESMGR CALL,            RETRACT                              X01290000
               TOKEN=AAPSQLTK,    RESMGR TOKEN RETAINED IN AAP         X01300000
               OWNER=*TSKPCBC,    ASSOCIATED WITH DRIVER PROCESS       X01310000
               MF=(E,$RESMFL)     PLIST CONSTRUCTION AREA               01320000
                                                                        01330000
         XC    AAPSQLTK,AAPSQLTK  INDICATE RESMGR DELETED               01340000
                                                                        01350000
FSQLEND  DS    0H                 EXIT                                  01360000
                                                                        01370000
         EJECT                                                          01380000
***************************************************************         01390000
*                                                                       01400000
*   Send plan end notification to requester                             01410000
*                                                                       01420000
***************************************************************         01430000
                                                                        01440000
NOTIFY   DS    0H                                                       01450000
         $TSEND WUTOKEN=SLHMPTKN,                                      X01460000
               TYPE=ITM_RUN_PLANEND,                                   X01470000
               PARMS=(*PLNSTRC,*PLNSTRSN,*PLNSTQ1,*PLNSTQ2),           X01480000
               MF=(E,MFE_LIST)                                          01490000
                                                                        01500000
         STM   R15,R1,STATREGS    $TSEND INFO AS LOCAL STATUS           01510000
                                                                        01520000
         EJECT                                                          01530000
**************************************************************          01540000
*                                                                       01550000
*   Return to requester with $TSEND retcode as local status             01560000
*                                                                       01570000
**************************************************************          01580000
                                                                        01590000
RETURN   DS    0H                                                       01600000
         LM    R15,R1,STATREGS    RESTORE COMPLETION STATUS             01610000
                                                                        01620000
         #EXIT ,                                                        01630000
                                                                        01640000
         EJECT                                                          01650000
***************************************************************         01660000
*                                                                       01670000
*   Local read-only constants, etc.                                     01680000
*                                                                       01690000
***************************************************************         01700000
                                                                        01710000
         LTORG ,                                                        01720000
                                                                        01730000
         PRINT NOGEN                                                    01740000
         ICVT  ,                                                        01750000
         ITASK ,                                                        01760000
         END   ,                                                        01770000

IDSOBJHW TITLE 'DATASPACE SERVICES - SET HIGH WATER MARK'               00010000
***************************************************************         00020000
*                                                                       00030000
*   READ / WRITE WORKING STORAGE AREA                                   00040000
*                                                                       00050000
***************************************************************         00060000
WORKAREA DSECT                                                          00070000
                                                                        00080000
         @WORK ,                  STANDARD WORKAREA                     00090001
                                                                        00100001
STOKEN   DS    XL8                SPACE TOKEN                           00110000
RESOWNER DS    X                  STORAGE MAP OWNER IF TRUE             00120000
                                                                        00130000
WORKLEN  EQU   *-WORKAREA         WORKAREA LENGTH                       00140000
                                                                        00150001
         EJECT                                                          00160001
         SPCBLOCK ,                                                     00170000
                                                                        00180001
         EJECT                                                          00190001
         OIE   ,                                                        00200000
                                                                        00210001
         EJECT                                                          00220001
         $TOKEN ,                                                       00230000
                                                                        00240001
         EJECT                                                          00250001
         SPCEQUS ,                                                      00260000
                                                                        00270001
         EJECT                                                          00280001
         EQUS  LINKAGE=VCON                                             00290000
                                                                        00300001
         EJECT                                                          00310001
**<DOC-ON>*****************************************************         00320001
*                                                                       00330000
* ROUTINE: IDSOBJHW - SET HIGH WATER MARK                               00340000
*                                                                       00350000
* DESCRIPTION:                                                          00360000
*                                                                       00370000
*    OIEWRITE                                                           00380000
*                                                                       00390000
* ON ENTRY:                                                             00400000
*                                                                       00410000
*    R1 POINTS TO AN OS/VS PARAMETER LIST CONTAINING                    00420000
*                                                                       00430000
*        +00 - ADDRESS OF THE OBJECT TOKEN                              00440000
*        +04 - RESIDUAL SIZE OF OBJECT (BYTES)                          00450000
*        +08 - RELEASE EXCESS ALU'S IF TRUE (NON-ZERO)                  00460000
*                                                                       00470000
*    A/R10 - AR QUALIFIED ADDRESS OF THE STORAGE SPCBLOCK               00480000
*                                                                       00490000
*                                                                       00500000
* ON EXIT:                                                              00510000
*                                                                       00520000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES                     00530000
*                                                                       00540000
*        00 - SET HIGH WATER MARK                                       00550000
*        16 - INVALID REQUEST                                           00560000
*        20 - ALU TRANSLATION ERROR                                     00570000
*                                                                       00580000
**<DOC-OFF>****************************************************         00590001
                                                                        00600001
         EJECT                                                          00610001
IDSOBJHW @ENTER WORKA=(WORKAREA,WORKLEN)                                00620000
                                                                        00630000
         LAE   R1,0(R1,0)         TOKENS RESIDE IN PRIMARY              00640001
         LM    R3,R5,0(R1)        FETCH PASSED PARAMETERS               00650000
*                                 R3 <== OBJECT TOKEN ADDR              00660000
*                                 R4 <== HIGHWATER MARK (BYTES)         00670000
         LR    R8,R5              R5 <== ALU RELEASE FLAG               00680000
                                                                        00690000
         LAE   R9,0(R3,0)         OBJECT TOKEN                          00700001
         USING $TOKEN,R9          DECLARE INTENTIONS                    00710000
         CLC   $TOKTAG,=CL8'OBJTOKEN'                                   00720000
         BNE   ERR_REQ                                                  00730000
         ICM   R1,15,$OBJID       OBJECT HANDLE                         00740000
         BZ    ERR_REQ            INVALID                               00750000
                                                                        00760000
         L     R10,$SPCBASE       OBJECT SPACE DESCRIPTOR               00770000
         LAM   R10,R10,$ALET      OPEN WINDOW TO OBJECT SPACE           00780000
         USING SPCBLOCK,R10       ESTABLISH AR ADDRESSABILITY           00790000
                                                                        00800000
         LAE   R11,SPCBLOCK       ADDITIONAL WINDOW TO OBJECT SPACE     00810001
                                                                        00820000
*--------------------------------------------------------------         00830000
*   LOCATE OBJECT OIE                                                   00840000
*--------------------------------------------------------------         00850000
         LOCOIE ALUERR=ERR_ALU                                          00860000
                                                                        00870000
         LR    R11,R1             OIE BASE ADDRESS                      00880000
         USING OIE,R11            ADDRESSABILITY                        00890000
                                                                        00900000
*--------------------------------------------------------------         00910000
*  VALIDATE HIGH WATERMARK PROIVDED BY CALLER                           00920000
*--------------------------------------------------------------         00930000
         CL    R4,=F'-1'          REQUESTING COMPLETE CONTROL OF OBJ?   00940000
         BNE   *+12               NO, JOINT MANAGEMENT OF OBJECT SPACE  00950000
         ST    R4,OIESTHWM        SAVE SENTINEL VALUE                   00960000
         B     RETOK              DONE                                  00970000
                                                                        00980000
         LR    R5,R4              MODIFIABLE COPY OF CANDIDATE HWM      00990000
         BCTR  R5,0               PREPARE FOR ALU IDENTIFICATION        01000000
         L     R15,SPC_ALU_POWER2 ALU/BYTE CONVERSION CONSTANT          01010000
         SRL   R5,0(R15)          ZERO RELATIVE ALU OF HWM              01020000
         CL    R5,OIESTLEN        WITHIN ALLOCATED EXTENT?              01030000
         BNL   ERR_REQ            FAIL IF NOT                           01040000
         ST    R4,OIESTHWM        ELSE ACCEPT CANDIDATE HWM             01050000
                                                                        01060000
         OI    OIEFLAGS,OIEWRITE  ASSUME DATA AREA UPDATED              01070000
                                                                        01080000
*--------------------------------------------------------------         01090000
*  IDENTIFY EXTENT TO FREE                                              01100000
*--------------------------------------------------------------         01110000
         LTR   R8,R8              REQUEST RELEASES SURPLUS ALU'S?       01120000
         BZ    RETOK              DONE IF NOT                           01130000
                                                                        01140000
         L     R6,OIESTLEN        # ALU'S COMMITTED TO OBJECT           01150000
         LA    R5,1(,R5)          PREPARE FOR DIFFERENCE CALC           01160000
         SR    R6,R5              # ALU'S THAT CAN BE FREED             01170000
         BNP   RETOK              DONE IF NONE                          01180000
         AL    R5,OIESTORG        IDENTIFY ORIGIN OF FREEABLE EXTENT    01190000
                                                                        01200000
*--------------------------------------------------------------         01210000
*  OBTAIN OBJECT SPACE SERIALIZATION                                    01220000
*--------------------------------------------------------------         01230000
         MVC   STOKEN,SPC_STOKEN                                        01240000
                                                                        01250000
         @SERSPC OBTAIN,STOKEN                                          01260000
                                                                        01270000
         BNZ   *+8                SKIP IF NOT                           01280000
         MVI   RESOWNER,1         INDICATE RESOURCE OWNERSHIP           01290000
                                                                        01300000
*--------------------------------------------------------------         01310000
*  RELEASE SURPLUS ALU'S  - ALWAYS RETAIN OBJECT ALU0                   01320000
*--------------------------------------------------------------         01330000
         @CALL IDSMAPSV,(STGRLSE,(R5),(R6),0),MF=(E,MFE_LIST)           01340000
                                                                        01350000
*--------------------------------------------------------------         01360000
*  RELEASE OBJECT SPACE SERIALIZATION                                   01370000
*--------------------------------------------------------------         01380000
         CLI   RESOWNER,0         PROGRAM OWNS RESOURCE?                01390000
         BE    RELUPDTE           SKIP IF NOT                           01400000
                                                                        01410000
         @SERSPC RELEASE,STOKEN                                         01420000
                                                                        01430000
RELUPDTE DS    0H                                                       01440000
         L     R15,OIESTLEN       OLD OBJECT LENGTH (ALU'S)             01450000
         SR    R15,R6             ACCOUNT FOR ALU'S RELEASED            01460000
         ST    R15,OIESTLEN       SAVE UPDATED LENGTH                   01470000
                                                                        01480000
*--------------------------------------------------------------         01490000
*   RETURN COMPLETION STATUS TO CALLER                                  01500000
*--------------------------------------------------------------         01510000
RETOK    DS    0H                                                       01520000
         LA    R15,RC00           NORMAL COMPLETION                     01530000
         B     RET                                                      01540000
                                                                        01550000
ERR_REQ  DS    0H                 INVALID REQUEST                       01560000
         LA    R15,RC16                                                 01570000
         B     RET                                                      01580000
                                                                        01590000
ERR_ALU  DS    0H                 ALU TRANSLATION ERROR                 01600000
         LA    R15,RC20                                                 01610000
                                                                        01620000
RET      DS    0H                 EXIT                                  01630000
         @EXIT ,                                                        01640000
                                                                        01650000
         EJECT ,                                                        01660000
***************************************************************         01670000
*                                                                       01680000
*   READ ONLY CONSTANTS, ETC.                                           01690001
*                                                                       01700000
***************************************************************         01710000
         LTORG ,                                                        01720000
         END   ,                                                        01730000

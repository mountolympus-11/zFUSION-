IRECIMGI TITLE '- SYSIMAGE INBOUND DECODE'                              00010000
**************************************************************          00020000
*                                                                       00030000
* ROUTINE: IRECIMGI - SYSIMAGE INBOUND DECODE                           00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THIS ROUTINE EXTRACTS THE PRESENTATION SPACE AND ITS               00080000
*    ASSOCIATED DIMENSIONS FROM A GIVEN SYSIMAGE RECORD. IF             00090000
*    THE PRESENTATION SPACE HAS BEEN RETAINED IN SQUISHED               00100000
*    FORMAT, A BUFFER IS ALLOCATED TO HOUSE THE UNSQUISHED              00110000
*    SOURCE.                                                            00120000
*                                                                       00130000
*    THE CALLER IS RESPONSIBLE FOR THE BUFFER RETURNED BY THIS          00140000
*    ROUTINE. STANDARD $GETSTOR RECOVERY MECHANISMS APPLY.              00150000
*                                                                       00160000
*                                                                       00170000
* ON ENTRY:                                                             00180000
*                                                                       00190000
*    R1  CONTAINS THE ADDRESS OF A PARAMETER LIST DESCRIBED             00200000
*        BY THE IMGIPARM MAPPING EXPANDED BELOW. ZERO MAY BE            00210000
*        SPECIFIED FOR ANY PARAMETER EXCEPT THE SYSIMAGE ROW            00220000
*        ADDRESS.                                                       00230000
*                                                                       00240000
*                                                                       00250000
* ON EXIT:                                                              00260000
*                                                                       00270000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES:                    00280000
*                                                                       00290000
*        RC00 - BUFFER ALLOCATION NOT REQUIRED                          00300000
*                                                                       00310000
*        RC04 - PRESENTATION SPACE BUFFER ACQUIRED BY THIS RTN          00320000
*                                                                       00330000
*    R1  IN EITHER CASE THIS REGISTER CONTAINS THE ADDRESS OF           00340000
*        THE UNSQUISHED PRESENTATION SPACE.                             00350000
*                                                                       00360000
***************************************************************         00370000
         EJECT ,                                                        00380000
                                                                        00390000
         #WORK ,                                                        00400000
                                                                        00410000
         #ENDWORK ,                                                     00420000
                                                                        00430000
         EJECT                                                          00440000
***************************************************************         00450000
*                                                                       00460000
*   PARAMETER LIST                                                      00470000
*                                                                       00480000
***************************************************************         00490000
IMGIPARM DSECT                                                          00500000
IMGIMAGE DS    A                  ADDR OF SYSIMAGE ROW (STRUCT)         00510000
IMGIROWS DS    A                  ROW COUNT RETURN AREA     (F)         00520000
IMGICOLS DS    A                  COL COUNT RETURN AREA     (F)         00530000
IMGICSRP DS    A                  CSR LOCATION RETURN AREA  (F)         00540000
IMGISIZE DS    A                  IMAGE SIZE RETURN AREA    (F)         00550000
IMGIPLN  EQU   *-IMGIPARM         LENGTH OF PARAMETER LIST              00560000
                                                                        00570000
         EJECT                                                          00580000
         ICATALOG IMAGE           SYSIMAGE ROW FORMAT                   00590000
                                                                        00600000
         EJECT                                                          00610000
         EQUS  ,                                                        00620000
                                                                        00630000
         EJECT                                                          00640000
IRECIMGI #ENTER PREG=R8                                                 00650000
                                                                        00660000
         USING ICVT,R11           STDENV                                00670000
         USING ITASK,R10                                                00680000
         USING IMGIPARM,R8        LIFE OF FUNCTION                      00690000
                                                                        00700000
         EJECT ,                                                        00710000
***************************************************************         00720000
*                                                                       00730000
*   RETURN IMAGE ATTRIBUTES                                             00740000
*                                                                       00750000
***************************************************************         00760000
         L     R7,IMGIMAGE        FETCH SYSIMAGE ADDR                   00770000
         USING SYSIMAGE,R7        MAPPED                                00780000
                                                                        00790000
         ICM   R2,15,IMGIROWS     ROW COUNT                             00800000
         BZ    *+10                                                     00810000
         MVC   0(4,R2),SIMGROWS                                         00820000
                                                                        00830000
         ICM   R2,15,IMGICOLS     COL COUNT                             00840000
         BZ    *+10                                                     00850000
         MVC   0(4,R2),SIMGCOLS                                         00860000
                                                                        00870000
         ICM   R2,15,IMGICSRP     CURSOR POSITION                       00880000
         BZ    *+10                                                     00890000
         MVC   0(4,R2),SIMGCSRP                                         00900000
                                                                        00910000
         L     R5,SIMGROWS        ROWS TIMES COLUMNS GIVES ...          00920000
         M     R4,SIMGCOLS        TOTAL SIZE OF IMAGE                   00930000
         ICM   R2,15,IMGISIZE     RETURN REQUESTED?                     00940000
         BZ    *+8                                                      00950000
         ST    R5,0(,R2)                                                00960000
                                                                        00970000
         L     R4,SIMGBUFR+4      IMAGE ORIGIN                          00980000
         CLI   SIMGSQSH,TRUE      IMAGE SQUISHED?                       00990000
         BE    UNSQUISH           DECOMPRESS IN NEW BUFFER IF SO        01000000
         LA    R15,RC00           ELSE RETURN IMAGE AS IS               01010000
         LR    R1,R4              RETURN IMAGE ORIGIN                   01020000
         B     FIN                DONE                                  01030000
                                                                        01040000
*--------------------------------------------------------------         01050000
*   IMAGE IS SQUISHED - ALLOCATE A NEW BUFFER AND UNSQUISH              01060000
*--------------------------------------------------------------         01070000
UNSQUISH DS    0H                                                       01080000
         $GETSTOR (R5)            ACQUIRE NEW BUFFER OF IMAGE SIZE      01090000
                                                                        01100000
         LR    R3,R1              PRESERVE BUFFER ADDRESS               01110000
         L     R2,SIMGBUFR+0      LENGTH OF SQUISHED REPRESENTATION     01120000
                                                                        01130000
         $CLINK FUNC=USQUISH,     DECOMPRESSER                         X01140000
               (CHAR*,(R4)),(REGISTER_SHORT,(R2)),                     X01150000
               (CHAR*,(R3)),(REGISTER_SHORT,(R5))                       01160000
                                                                        01170000
         LR    R1,R3              RETURN IMAGE ORIGIN                   01180000
         LA    R15,RC04           CALLER RESPONSIBLE FOR BUFFER         01190000
                                                                        01200000
*--------------------------------------------------------------         01210000
*   RETURN SYSIMAGE TO CALLER                                           01220000
*--------------------------------------------------------------         01230000
FIN      DS    0H                                                       01240000
         SR    R0,R0              REASON CODES NOT DEFINED              01250000
                                                                        01260000
         #EXIT ,                                                        01270000
                                                                        01280000
         EJECT                                                          01290000
***************************************************************         01300000
*                                                                       01310000
*   LOCAL READ-ONLY DATA AREAS                                          01320000
*                                                                       01330000
***************************************************************         01340000
         LTORG ,                                                        01350000
                                                                        01360000
         EJECT                                                          01370000
         PRINT NOGEN                                                    01380000
         ICVT  ,                                                        01390000
         ITASK ,                                                        01400000
         END   ,                                                        01410000

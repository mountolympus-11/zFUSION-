ITSKCREA TITLE '- TASK CREATE SERVICE'                                  00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE: ITSKCREA - Task Create Service                               00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine will Initialize / create a new ITASK.                 00080000
*    There are two types of ITASKs which can be created,                00090000
*    STANDARD and SERVER.  A Standard ITASK will run the                00100000
*    ITSKPRLG routine and pass the entry point of the routine           00110000
*    to be created as the $$MAIN$$ process.  A Server ITASK             00120000
*    is created to service standard tasks that are created              00130000
*    with TCBAFF=NO.                                                    00140000
*                                                                       00150000
*    If the task being created specifies TCBAFF=YES then a              00160000
*    new task is attached for the ITASK being created.  The             00170000
*    ITASK will be own the TCB.  If TCBAFF=NO is specified,             00180000
*    then the ITASK will be added to the SERVER dispatch                00190000
*    ready queue so that the ITASK can be readied for Initial           00200000
*    dispatch.                                                          00210000
*                                                                       00220000
* ON ENTRY:                                                             00230000
*                                                                       00240000
*    R1 Contains the address of the parameter list mapped by            00250000
*    the TASKPL mapping generated by $TASK DSECT=YES.                   00260000
*                                                                       00270000
* ON EXIT:                                                              00280000
*                                                                       00290000
*    R15 contains one of the following return codes:                    00300000
*                                                                       00310000
*          RC00 - Normal Completion                                     00320000
*                 R1 - Address of newly created ITASK                   00330000
*                                                                       00340000
*          RC08 - Subtask Failure                                       00350000
*                 R0 - Subtask Initialization Cmpl Code                 00360000
*                                                                       00370000
*          RC12 - Service Failure                                       00380000
*                 R0 = RSN04 - ITASK Initialization Failure             00390000
*                      RSN08 - IDENTIFY Failure                         00400000
*                      RSN12 - ATTACH Failure                           00410000
*                      RSN16 - $SERVER Failure                          00420000
*                      RSN20 - WAIT Failure                             00430000
*                      RSN24 - EPB Initialization Error                 00440000
*                      RSN28 - WORKUNIT Locator Error                   00450000
*                                                                       00460000
*          RC16 - Internal Failure                                      00470000
*                 R0 = RSN04 - Storage Error                            00480000
*                                                                       00490000
*                                                                       00500000
*    NOTE: All reason codes are added to the requested function         00510000
*          Code * 100.  See ITSKSERV for the range of reason            00520000
*          codes for each service routine.                              00530000
*                                                                       00540000
* MODE:                                                                 00550000
*                                                                       00560000
*    TASK                                                               00570000
*    APF/NON-APF                                                        00580000
*    SUP/PROB                                                           00590000
*    AMODE 31, RMODE ANY                                                00600000
*                                                                       00610000
**<DOC-OFF>*****************************************************        00620000
                                                                        00630000
         EJECT ,                                                        00640000
****************************************************************        00650000
*                                                                       00660000
* MAINTENANCE:                                                          00670000
*                                                                       00680000
*   04/21/93 Ron Colmone                                                00690000
*            Initial Version                                            00700000
*                                                                       00710000
*   12/13/94 Ron Colmone      Par# 159456                               00720000
*            Added support for Server task management                   00730000
*                                                                       00740000
*   09/12/95 Ron Colmone      Par# 214761                               00750000
*            Dispatch Priority range limited from 0-255.                00760000
*                                                                       00770000
****************************************************************        00780000
                                                                        00790000
         EJECT ,                                                        00800000
         $TASK   DSECT=YES        TASKMGR PLIST                         00810000
         EJECT ,                                                        00820000
         $SERVER DSECT=YES        TASK SERVER MANAGER PLIST      159456 00830000
         EJECT ,                                                        00840000
         $WULOC  DSECT=YES        WORKUNIT LOCATOR                      00850000
         EJECT ,                                                        00860000
         ITASKPRM ,               TASK PROLOG PLIST                     00870000
         EJECT ,                                                        00880000
         @CB   WORKUNIT=YES       STANDARD CB HEADER                    00890000
         EJECT ,                                                        00900000
         @EPB  TYPE=DSECT         EVENT PROCESS BLOCK                   00910000
         EJECT ,                                                        00920000
         EQUS  ,                  GENERAL EQUATES                       00930000
                                                                        00940000
         EJECT ,                                                        00950000
         #WORK LENGTH=512         READ/WRITE WORKAREA                   00960000
REGSAVE  DS    16F                REGISTER SAVEAREA                     00970000
TSRVWRK  DS    A                  ADDR OF TASK WORKAREA                 00980000
CLNTASK  DS    A                  ADDR OF ITASK TO CLEANUP              00990000
TASKEPA  DS    A                  TASK ENTRY POINT ADDRESS       159456 01000000
                                                                        01010000
OPTS     DS    X                  PATMATCH OPTIONS                      01020000
                                                                        01030000
         IWUENTUD DSECT=NO        ENTITY USERDATA                       01040000
                                                                        01050000
$TASKMFL $TASK   MF=(L,*)         $TASK   PLIST                         01060000
$SRV_MFL $SERVER MF=(L,*)         $SERVER PLIST                  159456 01070000
$WUL_MFL $WULOC  MF=(L,*)         $WULOC  PLIST                         01080000
                                                                        01090000
ATT_MFL  ATTACHX EPLOC=0,SZERO=YES,ETXR=0,SF=L                          01100000
         #ENDWORK                 END OF WORKAREA                       01110000
#TSRVWLN EQU   1024               LEN  OF TASK WORKAREA                 01120000
                                                                        01130000
         EJECT ,                                                        01140000
ITSKCREA #ENTER BASE=R12,         ENTRY LINKAGE                        +01150000
               PREG=R8,                                                +01160000
               WAPASS=YES                                               01170000
                                                                        01180000
         USING TASKPL,R8          ESTABLISH ADDRESSABILITY              01190000
                                                                        01200000
         EJECT ,                                                        01210000
****************************************************************        01220000
*                                                                       01230000
*  CREATE SUBTASK                                                       01240000
*                                                                       01250000
****************************************************************        01260000
CREATE   DS    0H                                                       01270000
         ICM   R0,15,TPLTASK      PARENT TASK PROVIDED?                 01280000
         BZ    *+6                YES, CONTINUE                         01290000
         LR    R10,R0             GET PARENT ITASK ADDRESS              01300000
         USING ITASK,R10          ESTABLISH ADDRESSBILITY               01310000
                                                                        01320000
*---------------------------------------------------------------        01330000
*  OBTAIN TASK WORKAREA                                                 01340000
*---------------------------------------------------------------        01350000
         $GETSTOR #TSRVWLN,OWNER=ITASK ALLOC TASK WoRKAREA STG   159456 01360000
         ST    R1,TSRVWRK         SAVE TASKSRV WORKAREA ADDR            01370000
                                                                        01380000
*---------------------------------------------------------------        01390000
*  LOCATE WORKUNIT ENTITY USERDATA                                      01400000
*---------------------------------------------------------------        01410000
         $WULOC LOCATE,TSKNAME=*TPLNAME,USERDATA=IWUENTUD,             +01420000
               WKA=*TSRVWRK,MF=(E,$WUL_MFL)                             01430000
                                                                        01440000
*---------------------------------------------------------------        01450000
*  ALLOC/INITIALIZE ITASK BLOCK                                         01460000
*---------------------------------------------------------------        01470000
TSK_INIT DS    0H                                                       01480000
         IC    R2,TPLCFLGS        RETRIEVE TASK CREATE FLAGS     159456 01490000
         N     R2,=A(TPLC$AFF)    RESET ALL EXCEPT FOR TCBAFF=   159456 01500000
                                                                        01510000
         $TASK INIT,              ALLOCATE NEW ITASK                   +01520000
               NAME=*TPLNAME,                                          +01530000
               TASK=(R10),                                             +01540000
               TCBAFF=(R2),                                      159456+01550000
               WORKA=*TSRVWRK,                                         +01560000
               MF=(E,$TASKMFL)                                          01570000
         BNZ   ERR_INIT           INITIALIZATION ERROR                  01580000
                                                                        01590000
         LR    R5,R1              ADDR OF NEW ITASK                     01600000
N        USING ITASK,R5           ESTABLISH ADDRESSBILITY               01610000
         ST    R5,CLNTASK         SET ITASK ADDRESS FOR CLEANUP         01620000
                                                                        01630000
         MVC   N.TSKTEPB@,TPLTEPB  SET TERM EPB ADDRESS                 01640000
                                                                        01650000
         L     R0,WUDECM          ADDRESS OF ECM MASK                   01660000
         LA    R1,N.ITASK         ADDRESS OF TARGET ITASK               01670000
         @CALL ITSKECM,CTYPE=CVT  ATTACH COPY TO NEW TASK               01680000
                                                                        01690000
         L     R0,WUDMSGCL        ADDRESS OF MESSAGE CLASS TABLE        01700000
         LA    R1,N.ITASK         ADDRESS OF TARGET ITASK               01710000
         @CALL ITSKMSGC,CTYPE=CVT ATTACH COPY TO NEW TASK               01720000
                                                                        01730000
         TM    TPLCFLGS,TPLC$SRV  SERVER TASK INITIALIZATION?    159456 01740000
         BZ    TSK_WULK           NO,  CONTINUE                  159456 01750000
         MVI   N.TSKTYPE,TSKT$SRV INDICATE SERVER TASK           159456 01760000
                                                                        01770000
         $SERVER INIT,            INITIALIZE SERVER TASK         159456+01780000
               TASK=N.ITASK,                                     159456+01790000
               MF=(E,$SRV_MFL)                                   159456 01800000
         BNZ   ERR_SERV           SERVER INITIALIZATION ERROR    159456 01810000
                                                                        01820000
*---------------------------------------------------------------        01830000
*  POST ITASK ADDRESS TO WORKUNIT LOCATOR                               01840000
*---------------------------------------------------------------        01850000
TSK_WULK DS    0H                                                159456 01860000
         ICM   R2,15,WUDITASK     DUPLICATE ITASK NAME?                 01870000
         BZ    *+8                NO, CONTINUE                          01880000
         LA    R2,WLPL$ADD        YES, ADD DUPLICATE ENTITY             01890000
                                                                        01900000
         $WULOC POST,TSKNAME=*TPLNAME,USERDATA=IWUENTUD,TASK=(R5),     +01910000
               TOKEN=N.TSKENTKN,DUP=(R2),WKA=*TSRVWRK,MF=(E,$WUL_MFL)   01920000
                                                                        01930000
         BNZ   ERR_WULC           WORKUNIT LOCATOR ERROR                01940000
                                                                        01950000
         EJECT ,                                                        01960000
*---------------------------------------------------------------        01970000
*  DETERMINE IF SAS/C DEBUGGING IS ENABLED FOR THIS WORKUNIT            01980000
*  AND SET OPTIONS ACCORDINGLY.                                         01990000
*---------------------------------------------------------------        02000000
         TM    ICTSTAT2,ICT2$CDB  SAS/C DEBUGGING ENABLED               02010000
         BZ    CREA_ENT           NO, ADD ENTRY NAME FOR TASK           02020000
         LA    R4,L'TSKNAME       LENGTH OF TASK NAME                   02030000
         MVI   OPTS,X'42'         SCAN_PATTERN | SCAN_IGNORECASE        02040000
*                                 (SEE DRAW.H FOR DEFINITIONS)          02050000
                                                                        02060000
         $CLINK FUNC=*#PATMTCH,   VERIFY MATCHING PAT FOR TASK NAME    +02070000
               (CHAR*,ICTCDTSK),                                       +02080000
               (CHAR*,N.TSKNAME),                                      +02090000
               (REGISTER_INT,(R4)),                                    +02100000
               (CHAR,OPTS),                                            +02110000
               (INT,ICTZERO),                                          +02120000
               (INT,ICTZERO)                                            02130000
                                                                        02140000
         LTR   R15,R15            TASK NAME MATCH PATTERN?              02150000
         BZ    CREA_ENT           NO, SKIP C-DEBUGGING FOR WU           02160000
                                                                        02170000
         $CLINK FUNC=*#PATMTCH,   VERIFY MATCHING PAT FOR NULL PROC    +02180000
               (CHAR*,ICTCDPRC),                                       +02190000
               (CHAR*,BLANKS),                                         +02200000
               (REGISTER_INT,(R4)),                                    +02210000
               (CHAR,OPTS),                                            +02220000
               (INT,ICTZERO),                                          +02230000
               (INT,ICTZERO)                                            02240000
                                                                        02250000
         LTR   R15,R15            PATTERN MATCH FOR BLANK PROCESS       02260000
         BZ    CREA_ENT           NO, SKIP C-DEBUGGING FOR WU           02270000
                                                                        02280000
         OI    N.TSKFLGS2,TSK$CDBG SAS/C DEBUGGING ENABLE FOR WU        02290000
                                                                        02300000
         EJECT ,                                                        02310000
*---------------------------------------------------------------        02320000
*  ADD ENTRY NAME FOR TASK PROLOG                                       02330000
*---------------------------------------------------------------        02340000
CREA_ENT DS    0H                                                       02350000
         TM    TPLCFLGS,TPLC$AFF  TCB AFFINITY?                  159456 02360000
         BZ    CREA_PLS           NO, CONTINUE WITH PARM CREATE  159456 02370000
                                                                        02380000
         L     R3,#TSKPRLG        ADDR OF STD TASK PROLOG        159456 02390000
                                                                        02400000
         IDENTIFY ENTRY=(R3),     ADD ENTRY NAME                       +02410000
               EPLOC=N.TSKNAME                                          02420000
         C     R15,=A(RC08)       INDENTIFY SUCCESSFULL?                02430000
         BNL   ERR_IDNT           RETURN ERROR                          02440000
                                                                        02450000
*---------------------------------------------------------------        02460000
*  REMOVE RACF 'DIRTY' BIT   (OY45215 - MONARCH MARKING 11/23)          02470000
*---------------------------------------------------------------        02480000
ZAPZAP   B     CREA_ID                                                  02490000
                                                                        02500000
         TM    ICTSTAT2,ICT2$APF  APF AUTHORIZED?                       02510000
         BNO   CREA_ID            SKIP RACF CLEANUP LOGIC IF NOT        02520000
         TM    ICTSTAT2,ICT2$SUP  RUNNING SUP STATE AS EXPECTED?        02530000
         BNO   CREA_ID            UNEXPECTED ENVIRON OTHERWISE          02540000
                                                                        02550000
         L     R7,16              LOCATE TCB WORDS PTR                  02560000
         L     R7,0(,R7)          LOCATE TCB WORDS                      02570000
         L     R7,0(,R7)          TRACE TO TCB                          02580000
         USING TCB,R7             TASK TEMP ADDRESSABILITY              02590000
         L     R7,TCBJSTCB        JPQ OWNED BY JOBSTEP TASK             02600000
                                                                        02610000
         SR    R6,R6              PREPARE FOR INSERT                    02620000
         ICM   R6,7,TCBJPQB       LOCATE FIRST JOB PACK ENTRY           02630000
         BZ    CREA_ID            SOMETHING SERIOUSLY WRONG             02640000
         USING CDENTRY,R6         MAP THE CDE                           02650000
                                                                        02660000
*--- REMOVE ALL CDE 'DIRTY' BITS -------------------------------        02670000
                                                                        02680000
         MODESET EXTKEY=ZERO,     KEY=0 REQUIRED FOR SETLOCK           +02690000
               SAVEKEY=(2)                                              02700000
                                                                        02710000
CREA_CDE DS    0H                                                       02720000
         NI    CDATTRB,FF-CDRACDTY   RESET 'DIRTY' BIT                  02730000
         ICM   R6,15,CDCHAIN      ADVANCE TO NEXT CDE                   02740000
         BNZ   CREA_CDE           NEXT JPQ CDE                          02750000
                                                                        02760000
         MODESET KEYADDR=(2)      RESTORE TO CALLER'S KEY               02770000
                                                                        02780000
CREA_ID  DS    0H                                                       02790000
         DROP  R7,R6              TCB, CDENTRY                          02800000
                                                                        02810000
*---------------------------------------------------------------        02820000
*  BUILD SUBTASK PARAMETER LIST                                         02830000
*---------------------------------------------------------------        02840000
CREA_PLS DS    0H                                                159456 02850000
         $GETSTOR ITPLENG,OWNER=N.ITASK                          159456 02860000
         LR    R7,R1              TASK PROLOG PLIST ADDRESS             02870000
         USING ITASKPRM,R7        ESTABLISH ADDRESSABILITY              02880000
                                                                        02890000
         XC    ITASKPRM(ITPLENG),ITASKPRM   INIT PLIST                  02900000
         ST    R5,ITPITASK        ADDR OF ITASK CB                      02910000
         ST    R11,ITPICVT        ADDR OF ICVT  CB                      02920000
         MVC   ITPRTN@,TPLEP      ADDR OF SUBTASK RTN                   02930000
         MVC   ITPPARM,TPLPARM    ADDR OF SUBTASK RTN PARMS             02940000
         TM    TPLCFLGS,TPLC$SYN  TASK SYNC REQUESTED?                  02950000
         BZ    *+8                NO, CONTINUE                          02960000
         OI    ITPFLGS,ITP$SYNC   YES, SET TASK SYNC REQ                02970000
                                                                        02980000
         EJECT ,                                                        02990000
*---------------------------------------------------------------        03000000
*  INITIALIZE TASK TERMINATION EPB                                      03010000
*---------------------------------------------------------------        03020000
         $TASK SETEPB,            INITIALIZE TERM EPB                  +03030000
               EPB=N.TSKTEPB,                                          +03040000
               PCB=*TSKPCB$M,                                          +03050000
               RTN=*#TSKTERM,                                    159456+03060000
               PARM=N.ITASK,                                           +03070000
               WORKA=*TSRVWRK,                                         +03080000
               MF=(E,$TASKMFL)                                          03090000
                                                                        03100000
         EJECT ,                                                        03110000
*---------------------------------------------------------------        03120000
*  IF SYNC=YES, WAIT FOR COMPLETION OF SUBTASK INITIALIZATION           03130000
*---------------------------------------------------------------        03140000
         TM    TPLCFLGS,TPLC$SYN  TASK SYNCRONIZATION REQUESTED?        03150000
         BZ    CREA_ATT           NO, ATTACH SUBTASK                    03160000
                                                                        03170000
         $GETSTOR EPBLENG,OWNER=ITASK OBTAIN AREA FOR SYNC EPB   159456 03180000
         ST    R1,N.TSKSEPB@      SAVE TASK EPB ADDRESS                 03190000
                                                                        03200000
         $TASK SETEPB,            INITIALIZE SYNC EPB ADDRESS          +03210000
               ECODE=0,                                                +03220000
               EPB=*N.TSKSEPB@,                                        +03230000
               WORKA=*TSRVWRK,                                         +03240000
               MF=(E,$TASKMFL)                                          03250000
         BNZ   ERR_SEPB           ERROR, EPB INITIALIZATION             03260000
                                                                        03270000
         EJECT ,                                                        03280000
*---------------------------------------------------------------        03290000
*  ATTACH SUBTASK FOR TCBAFF=YES TASKS                                  03300000
*---------------------------------------------------------------        03310000
CREA_ATT DS    0H                                                       03320000
         TM    TPLCFLGS,TPLC$AFF  TCB AFFINITY?                  159456 03330000
         BZ    CREA_SAT           NO, ATTACH TASK TO SERVER      159456 03340000
                                                                        03350000
         L     R4,TPLDPMOD        DISPATCH PRIORITY MODIFIER            03360000
         LA    R1,ITASKPRM        ADDRESS OF TASK PROLOG PLIST          03370000
         LA    R3,N.TSKTEPB       ADDRESS OF TERM EVENT BLOCK           03380000
         USING EPB,R3             ADDRESSABILITY                        03390000
         LA    R3,EPBECB          ADDRESS OF TERM ECB                   03400000
         DROP  R3                 EPB                                   03410000
                                                                        03420000
         TM    ICTSTAT2,ICT2$SUP  RUNNING SUPERVISOR STATE?             03430000
         BO    CREA_SUP           YES, ATTACH IN SUP STATE              03440000
                                                                        03450000
         MVC   ATT_MFL($ATT_PLN),$ATT_PRB COPY PROB STATE PLIST         03460000
                                                                        03470000
         ATTACHX EPLOC=N.TSKNAME, CREATE NEW TASK                      +03480000
               SM=PROB,                                                +03490000
               DPMOD=(R4),                                             +03500000
               SZERO=YES,                                              +03510000
               SHSPV=78,          SAS/C RECOMMENDATION                 +03520000
               ECB=(R3),                                               +03530000
               SF=(E,ATT_MFL)                                           03540000
         B     CREA_TST           TEST ATTACH RETURN CODE               03550000
                                                                        03560000
CREA_SUP DS    0H                                                       03570000
         MVC   ATT_MFL($ATT_SLN),$ATT_SUP COPY SUP STATE PLIST          03580000
                                                                        03590000
         ATTACHX EPLOC=N.TSKNAME, CREATE NEW TASK                      +03600000
               SM=SUPV,                                                +03610000
               DPMOD=(R4),                                             +03620000
               SZERO=YES,                                              +03630000
               SHSPV=78,          SAS/C RECOMMENDATION                 +03640000
               ECB=(R3),                                               +03650000
               SF=(E,ATT_MFL)                                           03660000
                                                                        03670000
*---------------------------------------------------------------        03680000
*  DETERMINE IF ATTACH WAS SUCCESSFULL?                                 03690000
*---------------------------------------------------------------        03700000
CREA_TST DS    0H                                                       03710000
         LTR   R15,R15            ATTACH COMPLETION OK?                 03720000
         BNZ   ERR_ATT            ERROR, ATTACH                         03730000
                                                                        03740000
         ST    R1,N.TSKTCB@       ADDR OF NEW TASK TCB                  03750000
         B     CREA_SYN           DETERMINE IF SYNCRONOUS START         03760000
                                                                        03770000
         EJECT ,                                                        03780000
*--------------------------------------------------------------- 159456 03790000
*  STANDARD TASK CREATE WITH TCBAFF=NO.                          159456 03800000
*--------------------------------------------------------------- 159456 03810000
CREA_SAT DS    0H                                                159456 03820000
         SR    R2,R2              PREPARE FOR INSERT             214761 03830000
         IC    R2,TSKPRTY         GET CURRENT TASK DISP PRIOR    214761 03840000
         A     R2,TPLDPMOD        COMPUTE ITASK DISPATCH PRIO    159456 03850000
         BM    CREA_DP0           NEG DPRIO, RESET TO ZERO       214761 03860000
         C     R2,=A(255)         IS DPRIO > 255?                214761 03870000
         BNH   CREA_DP            NO, CONTINUE WITH SERVER ATTCH 214761 03880000
         LA    R2,255             RESET DPRIO TO LIMIT           214761 03890000
         B     CREA_DP            CONTINUE WITH SERVER ATTACH    214761 03900000
                                                                        03910000
CREA_DP0 DS    0H                                                214761 03920000
         SR    R2,R2              RESET PRIORITY TO ZERO         214761 03930000
                                                                        03940000
CREA_DP  DS    0H                                                214761 03950000
         STC   R2,N.TSKPRTY       SAVE NEW TASK DISPATCH PRIO    214761 03960000
                                                                        03970000
         $SERVER ATTACH,          ATTACH NEW TASK TO SERVER Q    159456+03980000
               EP=*#TSKPRLG,                                     159456+03990000
               PARM=ITASKPRM,                                    159456+04000000
               TERMEPB=N.TSKTEPB,                                159456+04010000
               TASK=N.ITASK,                                     159456+04020000
               MF=(E,$SRV_MFL)                                   159456 04030000
         BNZ   ERR_SERV           ERROR DISPATCHING ON SERVER    159456 04040000
                                                                        04050000
         DROP  R7                 ITASKPRM                              04060000
                                                                        04070000
         EJECT ,                                                        04080000
*---------------------------------------------------------------        04090000
*  IF SYNC=YES, WAIT FOR COMPLETE OF SUBTASK INITIALIZATION             04100000
*---------------------------------------------------------------        04110000
CREA_SYN DS    0H                                                       04120000
         XC    CLNTASK,CLNTASK    RESET ITASK CLEANUP ADDRESS           04130000
         TM    TPLCFLGS,TPLC$SYN  TASK SYNCRONIZATION REQUESTED?        04140000
         BZ    CREA_END           NO, TASK CREATE COMPLETE              04150000
                                                                        04160000
         $TASK WAIT,              WAIT FOR TASK INITIALIZATION         +04170000
               TASK=(R10),                                             +04180000
               EPB=*N.TSKSEPB@,                                        +04190000
               WORKA=*TSRVWRK,                                         +04200000
               MF=(E,$TASKMFL)                                          04210000
                                                                        04220000
*---------------------------------------------------------------        04230000
*  CHECK INITIALIZATION STATUS IN SYNC ECB                              04240000
*---------------------------------------------------------------        04250000
         LR    R3,R0              SAVE EVENT COMPLETION CODE            04260000
         LR    R4,R1              ADDRESS OF COMPLETED EPB              04270000
                                                                        04280000
         $RETSTOR (R4),OWNER=ITASK RETURN EPB STORAGE            159456 04290000
                                                                        04300000
         LTR   R0,R3              RETRIEVE COMPLETION STATUS            04310000
         BNZ   RET_RC08           RETURN ERROR                          04320000
                                                                        04330000
CREA_END DS    0H                                                       04340000
         LA    R1,N.ITASK         ADDR OF NEW ITASK                     04350000
         LA    R15,RC00           NORMAL COMPLETION                     04360000
         B     RETURN             RETURN                                04370000
                                                                        04380000
         EJECT ,                                                        04390000
****************************************************************        04400000
*                                                                       04410000
*   ERROR EXIT                                                          04420000
*                                                                       04430000
****************************************************************        04440000
                                                                        04450000
ERR_INIT DS    0H                                                       04460000
         LA    R0,RSN04           TASK INIT FAILURE                     04470000
         B     RET_RC12           SERVICE  ERROR                        04480000
                                                                        04490000
ERR_IDNT DS    0H                                                       04500000
         LA    R0,RSN08           IDENTIFY FAILURE                      04510000
         B     RET_RC12           SERVICE  ERROR                        04520000
                                                                        04530000
ERR_ATT  DS    0H                                                       04540000
         LA    R0,RSN12           ATTACH   FAILURE                      04550000
         B     RET_RC12           SERVICE  ERROR                        04560000
                                                                        04570000
ERR_SERV DS    0H                                                       04580000
         LA    R0,RSN16           $SERVER FAILURE                       04590000
         B     RET_RC12           SERVICE  ERROR                        04600000
                                                                        04610000
ERR_WAIT DS    0H                                                       04620000
         LA    R0,RSN20           TASK WAIT FAILURE                     04630000
         B     RET_RC12           SERVICE  ERROR                        04640000
                                                                        04650000
ERR_SEPB DS    0H                                                       04660000
         LA    R0,RSN24           EPB INITIALIZATION ERROR              04670000
         B     RET_RC12           SERVICE  ERROR                        04680000
                                                                        04690000
ERR_WULC DS    0H                                                       04700000
         LA    R0,RSN28           WORKUNIT LOCATOR FAILURE              04710000
         B     RET_RC12           SERVICE  ERROR                        04720000
                                                                        04730000
*---------------------------------------------------------------        04740000
ERR_STG  DS    0H                                                       04750000
         LA    R0,RSN04           STORAGE ALLOCATION ERROR              04760000
         B     RET_RC16           INTERNAL ERROR                        04770000
                                                                        04780000
         EJECT ,                                                        04790000
****************************************************************        04800000
*                                                                       04810000
*   RETURN                                                              04820000
*                                                                       04830000
****************************************************************        04840000
                                                                        04850000
RET_RC08 DS    0H                                                       04860000
         LA    R15,RC08           SUBTASK FAILURE                       04870000
         B     RETURN             RETURN                                04880000
                                                                        04890000
RET_RC12 DS    0H                                                       04900000
         LA    R15,RC12           ABNORMAL RETURN (SERVICE FAIL)        04910000
         B     RETURN             RETURN                                04920000
                                                                        04930000
RET_RC16 DS    0H                                                       04940000
         LA    R15,RC16           ABNORMAL RETURN (INTERNAL ERR)        04950000
         B     RETURN             RETURN                                04960000
                                                                        04970000
RETURN   DS    0H                                                       04980000
         BAS   R14,CLEANUP        CLEANUP ALLOCATE RESOURCES            04990000
         #EXIT ,                  RETURN                                05000000
                                                                        05010000
         EJECT ,                                                        05020000
****************************************************************        05030000
*                                                                       05040000
* ROUTINE: CLEANUP - RELEASE ALLOCATED RESOURCES                        05050000
*                                                                       05060000
* ON ENTRY: N/A                                                         05070000
*                                                                       05080000
* ON EXIT:  N/A                                                         05090000
*                                                                       05100000
****************************************************************        05110000
CLEANUP  DS    0H                                                       05120000
         STM   R0,R15,REGSAVE     SAVE CALLER'S REGISTERS               05130000
                                                                        05140000
         ICM   R5,15,CLNTASK      TASK CLEANUP REQUIRED                 05150000
         BZ    CLN_STG            NO, RELEASE STORAGE                   05160000
                                                                        05170000
         $TASK DELETE,            REMOVE ITASK                         +05180000
               TASK=(R5),                                              +05190000
               WORKA=*TSRVWRK,                                         +05200000
               MF=(E,$TASKMFL)                                          05210000
                                                                        05220000
CLN_STG  DS    0H                                                       05230000
         ICM   R3,15,TSRVWRK      WORKAREA ALLOCATED?                   05240000
         BZ    CLN_EXIT           NO, RETURN                            05250000
                                                                        05260000
         $RETSTOR (R3),OWNER=ITASK                               159456 05270000
                                                                        05280000
CLN_EXIT DS    0H                                                       05290000
         LM    R0,R15,REGSAVE     RESTORE CALLER'S REGISTERS            05300000
         BR    R14                RETURN                                05310000
                                                                        05320000
         EJECT ,                                                        05330000
****************************************************************        05340000
*                                                                       05350000
*  CONSTANTS AND LITERALS                                               05360000
*                                                                       05370000
****************************************************************        05380000
BLANKS   DC    CL8' '             BLANKS                                05390000
                                                                        05400000
$ATT_SUP ATTACHX EPLOC=0,SZERO=YES,ETXR=0,SM=PROB,SF=L                  05410000
$ATT_SLN EQU   *-$ATT_SUP                                               05420000
                                                                        05430000
$ATT_PRB ATTACHX EPLOC=0,SZERO=YES,ETXR=0,SM=SUPV,SF=L                  05440000
$ATT_PLN EQU   *-$ATT_PRB                                               05450000
                                                                        05460000
         LTORG ,                                                        05470000
                                                                        05480000
         PRINT NOGEN                                                    05490000
         ICVT  ,                                                        05500000
         ITASK ,                                                        05510000
         IPCB  ,                                                        05520000
                                                                        05530000
         IHAPSA ,                                                       05540000
         CVT   DSECT=YES,LIST=NO                                        05550000
         IKJTCB ,                                                       05560000
         IHACDE ,                                                       05570000
         PRINT GEN                                                      05580000
                                                                        05590000
         END   ,                                                        05600000

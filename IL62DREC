IL62DREC TITLE 'INTEGRATOR - LU6.2 DRIVER RECEIVE COMPLETION (CONV)'    00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: IL62DREC - INTEGRATOR LU6.2 DRIVER RECEIVE COMPLETION (CONV) 00100000
*                                                                       00110000
* DESCRIPTION: THIS ROUTINE IS CALLED MATCH RECEIVED LU6.2 DATA WITH    00120000
*              A CPIC RECEIVE REQUEST.                                  00130000
*                                                                       00140000
* ON ENTRY:                                                             00150000
*                                                                       00160000
*    R15 = ENTRY POINT ADDRESS                                          00170000
*    R14 = RETURN      ADDRESS                                          00180000
*    R13 = SAVE AREA   ADDRESS                                          00190000
*    R11 = ICVT        ADDRESS                                          00200000
*    R10 = ITASK       ADDRESS                                          00210000
*    R09 = IVTAMCVT    ADDRESS                                          00220000
*    R08 = ISESS       ADDRESS                                          00230000
*                                                                       00240000
* ON EXIT:                                                              00250000
*                                                                       00260000
*    R15 = 0                                                            00270000
*    R00 = 0                                                            00280000
*    R01 = 0                                                            00290000
*                                                                       00300000
*    ALL OTHER REGISTERS ARE RESTORED.                                  00310000
*                                                                       00320000
**<DOC-OFF>************************************************************ 00330000
                                                                        00340000
*********************************************************************** 00350000
*                                                                       00360000
* MAINTENANCE:                                                          00370000
*                                                                       00380000
*   07/01/94 RANDY WITEK                                                00390000
*                                                                       00400000
*********************************************************************** 00410000
                                                                        00420000
         EQUS  ,                  GENERAL EQUATES                       00430000
                                                                        00440000
RICVT    EQU   R11                                                      00450000
RITASK   EQU   R10                                                      00460000
RIVTAM   EQU   R9                                                       00470000
RISESS   EQU   R8                                                       00480000
RSPLIST  EQU   R7                                                       00490000
RRCB     EQU   R6                                                       00500000
                                                                        00510000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00520000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00530000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00540000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00550000
         USING SPLIST,RSPLIST     ESTABLISH ADDRESSABILITY              00560000
         USING RCB,RRCB           ESTABLISH ADDRESSABILITY              00570000
                                                                        00580000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00590000
WRK256   DS    XL256              GENERAL WORKAREA                      00600000
$WUMFL   $WULOC MF=L              PLIST CONSTRUCTION                    00610000
L62MFL   L62POST MF=L             PLIST CONSTRUCTION                    00620000
L62RETCD DS    F                  RETURN CODE RETURN AREA               00630000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00640000
SUB1SAVE DS    18F                SUBROUTINE SAVE AREA                  00650000
WUDATA   DS    XL16               WULOC RETURN AREA                     00660000
                                                                        00670000
DATA@    DS    A                  CURRENT ADDRESS IN RCV BUFFER         00680000
DATALEN  DS    F                  REMAINING DATA LENGTH IN RCV BUFFER   00690000
                                                                        00700000
RCV@     DS    A                  CURRENT ADDRESS IN USER DATA BUFFER   00710000
RCVLEN   DS    F                  REMAINING LENGTH IN USER DATA BUFFER  00720000
RECLEN   DS    F                  LENGTH OF CURRENT LOGICAL RECORD      00730000
                                                                        00740000
SAVESPL  DS    A                  SPLISTS DEQUEUED DURING RECEIVE PROC. 00750000
SAV62OFF DS    F                  ORIGINAL SPLIST DATA CURRENT OFFSET   00760000
                                                                        00770000
RCV62ENT DS    XL(L'PCBENTKN)     ENTITY TOKEN OF CURRENT RECEIVE       00780000
RCV62EPB DS    A                  EPB ADDRESS  OF CURRENT RECEIVE       00790000
RCV62RCB DS    A                  RCB ADDRESS  OF CURRENT RECEIVE       00800000
RCV62PLA DS    A                  PARMLIST@    OF CURRENT RECEIVE       00810000
                                                                        00820000
SAVRLL#  DS    F                  TRACKING FIELD                        00830000
SAVRLLRM DS    F                  TRACKING FIELD                        00840000
SAVRPFRM DS    F                  TRACKING FIELD                        00850000
SAVRLL1  DS    X                  TRACKING FIELD                        00860000
SAVRLL2  DS    X                  TRACKING FIELD                        00870000
SAVRLL3  DS    X                  TRACKING FIELD                        00880000
SAVRLL4  DS    X                  TRACKING FIELD                        00890000
                                                                        00900000
DESC@    DS    F                  USED FOR TRACE FUNCTION               00910000
DESCLEN  DS    F                  USED FOR TRACE FUNCTION               00920000
TRACE@   DS    F                  USED FOR TRACE FUNCTION               00930000
TRACELEN DS    F                  USED FOR TRACE FUNCTION               00940000
USERLENG DS    F                  LENGTH THAT WILL FIT IN USER BUFFER   00950000
BUFRLENG DS    F                  LENGTH THAT IS IN RECEIVE BUFFER      00960000
#DATAR   DS    F                  TEMPORARY DATA_RECEIVED AREA          00970000
#RTSR    DS    F                  TEMPORARY RTS_RECEIVED AREA           00980000
#STATR   DS    F                  TEMPORARY STATUS_RECEIVED AREA        00990000
#RETCODE DS    F                  TEMPORARY RETURN_CODE AREA            01000000
RETR15   DS    F                                                        01010000
RETR0    DS    F                                                        01020000
RETR1    DS    F                                                        01030000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      01040000
NRSPSNS  DS    XL4                SENSE FOR NEGATIVE RESPONSE           01050000
NRSPSEQ  DS    XL2                SEQ#  FOR NEGATIVE RESPONSE           01060000
FLAG     DS    X                                                        01070000
FLAGDLCK EQU   X'80'              DISP LOCK HELD                        01080000
FLAGDLKD EQU   X'40'              DISP LOCK HELD ON ENTRY               01090000
FLAGDR1  EQU   X'20'              DR1 REQUESTED FOR CURRENT RU          01100000
FLAGDR2  EQU   X'10'              DR2 REQUESTED FOR CURRENT RU          01110000
WORKLEN  #ENDWORK                 END OF WORKAREA                       01120000
                                                                        01130000
         $MSGDFT PREFIX=ICTPID,                                        +01140000
               COMPID='L62',                                           +01150000
               TABLE=*#MSGS,                                           +01160000
               WORKA=0,                                                +01170000
               MF=(E,WRK256),                                          +01180000
               PRINT=NOGEN                                              01190000
                                                                        01200000
IL62DREC #ENTER BASE=R12,                                              +01210000
               AMODE=31,                                               +01220000
               RMODE=ANY                                                01230000
                                                                        01240000
*---------------------------------------------------------------------- 01250000
* IF AN EXCEPTION CONDITION IS ACTIVE...CALL THE EXCEPTION PROCESSOR    01260000
*---------------------------------------------------------------------- 01270000
                                                                        01280000
         TM    ISE62FL1,ISE62RER+ISE62SER+ISE62NRO                      01290000
         BZ    NOEX               BRANCH IF NO EXCEPTION CONDITION      01300000
         L     R15,IL6@DREX       RECEIVE EXCEPTION ROUTINE             01310000
         BASR  R14,R15            LINK TO ROUTINE                       01320000
         STM   R15,R1,RETREGS     SAVE RETURN VALUES                    01330000
         B     RETURN             AND EXIT                              01340000
                                                                        01350000
NOEX     DS    0H                                                       01360000
                                                                        01370000
*---------------------------------------------------------------------- 01380000
* IS THERE AN ACTIVE CONVERSATION?                                      01390000
*---------------------------------------------------------------------- 01400000
                                                                        01410000
         ICM   R1,15,ISE62RCB        ASSOCIATED RCB?                    01420000
         BNZ   ACTCONV               BRANCH IF YES                      01430000
                                                                        01440000
*---------------------------------------------------------------------- 01450000
* THERE IS NO ACTIVE CONVERSATION.                                      01460000
* CALL THE RESOURCE MANAGER RECEIVE PROCESSOR.                          01470000
*---------------------------------------------------------------------- 01480000
                                                                        01490000
         TM    ISE62FL1,ISE62TPS     IS A TP BEING STARTED?             01500000
         BO    RETURN                JUST EXIT IF YES                   01510000
                                                                        01520000
         L     R15,IL6@DRRM          RM RECEIVE PROCESSOR               01530000
         BASR  R14,R15               CALL THE RM RECEIVE PROCESSOR      01540000
         STM   R15,R1,RETREGS        SAVE THE RETURN VALUES             01550000
         B     RETURN                AND EXIT                           01560000
                                                                        01570000
*---------------------------------------------------------------------- 01580000
* THERE IS AN ACTIVE CONVERSATION.                                      01590000
* IS THERE AN ACTIVE RECEIVE REQUEST?                                   01600000
*---------------------------------------------------------------------- 01610000
                                                                        01620000
ACTCONV  DS    0H                                                       01630000
                                                                        01640000
         ICM   R1,15,ISE62RRQ        ACTIVE RECEIVE?                    01650000
         BZ    RETURN                RETURN IF NOT, DATA STAYS QUEUED   01660000
                                                                        01670000
         MVC   RCV62ENT,SPL62ENT-SPLIST(R1) COPY                        01680000
         MVC   RCV62EPB,SPL62EPB-SPLIST(R1)  THE                        01690000
         MVC   RCV62RCB,SPL62RCB-SPLIST(R1)   RECEIVE                   01700000
         MVC   RCV62PLA,SPL62PLA-SPLIST(R1)    INFORMATION              01710000
                                                                        01720000
*---------------------------------------------------------------------- 01730000
* SERIALIZE AND LOCATE CPIC USER'S WORK UNIT                            01740000
*---------------------------------------------------------------------- 01750000
                                                                        01760000
LOCATRCB DS    0H                                                       01770000
                                                                        01780000
         BAS   R14,DISPLOCK       SERIALIZE                             01790000
                                                                        01800000
         $WULOC LOCATE,           FIND THE WORK UNIT                   +01810000
               TOKEN=RCV62ENT,    WORK UNIT TOKEN ADDRESS              +01820000
               USERDATA=WUDATA,   XL16 AREA TO RECEIVE USER DATA       +01830000
               LOCKED=YES,        DISP LOCK LOCALLY ACQUIRED           +01840000
               MF=(E,$WUMFL)      VALIDATE WORK UNIT                    01850000
                                                                        01860000
         LTR   R15,R15            LOCATE SUCCESS?                       01870000
         BNZ   RETURN             BRANCH IF NOT                         01880000
         LTR   R1,R1              IS WORKUNIT TERMINATING?              01890000
         BNZ   RETURN             BRANCH IF YES                         01900000
         L     RRCB,RCV62RCB      RCB SHOULD BE VALID                   01910000
                                                                        01920000
*---------------------------------------------------------------------- 01930000
* RETRIEVE THE CURRENT SETTING OF THE DATA_RECEIVED VARIABLE            01940000
* WHICH MAY HAVE BEEN UPDATED ON A PREVIOUS SPIN THRU THIS MODULE.      01950000
*---------------------------------------------------------------------- 01960000
                                                                        01970000
Y        USING CMLIST,R3                                                01980000
         L     R3,RCV62PLA        CMLIST ADDRESS                        01990000
         L     R1,Y.CMLPARM4      ADDRESS OF DATA_RECEIVED AREA         02000000
         MVC   #DATAR,0(R1)       SET THE LOCAL VARIABLE                02010000
         DROP  Y                                                        02020000
                                                                        02030000
*---------------------------------------------------------------------- 02040000
* CHECKPOINT STATUS OF ALL TRACKING FIELDS                              02050000
* IN CASE A RECEIVE_IMMEDIATE IS UNSUCCESSFUL                           02060000
*---------------------------------------------------------------------- 02070000
                                                                        02080000
         MVC   SAVRLL#,RCBRLL#               SAVE TRACKING FIELD        02090000
         MVC   SAVRPFRM,RCBRPFRM             SAVE TRACKING FIELD        02100000
         MVC   SAVRLLRM,RCBRLLRM             SAVE TRACKING FIELD        02110000
         MVC   SAVRLL1(4),RCBRLL1            SAVE TRACKING FIELD        02120000
                                                                        02130000
*---------------------------------------------------------------------- 02140000
* THERE IS AN ACTIVE CONVERSATION AND AN ACTIVE RECEIVE REQUEST.        02150000
* IF THERE IS NO DATA IN THE RECEIVE QUEUE...CHECK THE RECEIVE TYPE.    02160000
* IF CM_RECEIVE_IMMEDIATE --> POST THE REQUEST COMPLETE                 02170000
* IF CM_RECEIVE_AND_WAIT  --> JUST RETURN AND WAIT FOR DATA             02180000
*---------------------------------------------------------------------- 02190000
                                                                        02200000
RCVNEXT  DS    0H                                                       02210000
                                                                        02220000
         ICM   RSPLIST,15,ISE62RB1   FIRST BUFFER IN THE RECEIVE QUEUE  02230000
         BP    ARECDATA              GO PROCESS DATA IF PRESENT         02240000
         CLI   RCBRTYPE+(L'RCBRTYPE-1),CM_RECEIVE_AND_WAIT              02250000
         BE    RCVRELSE              LEAVE RCV Q'D & FREE PROCESSED RUS 02260000
                                                                        02270000
*---------------------------------------------------------------------- 02280000
* RECEIVE_IMMEDIATE CAN'T BE SATISFIED RIGHT NOW...                     02290000
* RESTORE TRACKING FIELDS, RE-QUEUE RU'S, AND POST                      02300000
*---------------------------------------------------------------------- 02310000
                                                                        02320000
IMMDREQ  DS    0H                                                       02330000
                                                                        02340000
         MVC   RCBRLL#,SAVRLL#               RESTORE TRACKING FIELD     02350000
         MVC   RCBRPFRM,SAVRPFRM             RESTORE TRACKING FIELD     02360000
         MVC   RCBRLLRM,SAVRLLRM             RESTORE TRACKING FIELD     02370000
         MVC   RCBRLL1(4),SAVRLL1            RESTORE TRACKING FIELD     02380000
                                                                        02390000
         ICM   RSPLIST,15,SAVESPL            IS THERE SAVED DATA?       02400000
         BZ    IMMDPOST                      BRANCH IF NOT              02410000
         MVC   SAVESPL,SPL62RBN              NEXT SPL TO RE-QUEUE       02420000
         L     R1,ISE62RB1                   HEAD OF RECEIVE QUEUE      02430000
         LM    R14,R15,SPL62RBN-SPLIST(R1)   R14=NEXT R15=PREV          02440000
         ST    RSPLIST,SPL62RBN-SPLIST(,R15) LINK TO PREV               02450000
         ST    RSPLIST,SPL62RBP-SPLIST(,R14) LINK TO NEXT               02460000
         STM   R14,R15,SPL62RBP              SET CHAIN LINKS            02470000
                                                                        02480000
         LA    R15,=CL13'SPLIST RE-Q''D'                                02490000
         ST    R15,DESC@                                                02500000
         MVI   DESCLEN+(L'DESCLEN-1),13                                 02510000
         SR    R15,R15                                                  02520000
         ST    R15,TRACE@                                               02530000
         ST    R15,TRACELEN                                             02540000
         LR    R1,RSPLIST                                               02550000
         BAS   R14,TRACESPL                                             02560000
         B     IMMDREQ                       AND CONTINUE RE-QUEUEING   02570000
                                                                        02580000
IMMDPOST DS    0H                                                       02590000
                                                                        02600000
         MVI   #DATAR+(L'#DATAR-1),CM_NO_DATA_RECEIVED                  02610000
         MVI   #STATR+(L'#STATR-1),CM_NO_STATUS_RECEIVED                02620000
         MVI   #RETCODE+(L'#RETCODE-1),CM_OK                            02630000
         B     RCVRTSR            AND COMPLETE THE RECEIVE              02640000
                                                                        02650000
*---------------------------------------------------------------------- 02660000
* BEGIN PROCESSING AN RU WITHIN A CONVERSATION                          02670000
*---------------------------------------------------------------------- 02680000
                                                                        02690000
ARECDATA DS    0H                                                       02700000
                                                                        02710000
         MVC   SAV62OFF,SPL62OFF  SAVE OFFSET IN CASE OF RE-QUEUE       02720000
                                                                        02730000
         TM    SPLRH0,RHBCI         IS THIS A BEGIN CHAIN?              02740000
         BNO   ARECNOBC             BRANCH IF NOT                       02750000
         MVI   ISE62FRC,ISE62FRC_INC                                    02760000
                                                                        02770000
ARECNOBC DS    0H                                                       02780000
                                                                        02790000
*---------------------------------------------------------------------- 02800000
* QUEUED SPLIST MAY BE AN EARLY SIGNAL.                                 02810000
*---------------------------------------------------------------------- 02820000
                                                                        02830000
         TM    SPLCNTDC,RPLSIGNL  IS IT A SIGNAL?                       02840000
         BNO   ARECNSIG           BRANCH IF NOT                         02850000
         CLC   SPLSEQNO,ISE62CBS  IS IT FOR THE CURRENT BRACKET?        02860000
         BNE   PRGSIGNL           BRANCH IF NOT                         02870000
         OI    ISE62FL1,ISE62SIG  SHOW RTS RECEIVED                     02880000
                                                                        02890000
PRGSIGNL DS    0H                                                       02900000
                                                                        02910000
         LR    R1,RSPLIST         CURRENT BUFFER                        02920000
         BAS   R14,SPLDQ          REMOVE BUFFER FROM THE QUEUE          02930000
         BAS   R14,SPLFREE        RELEASE THE BUFFER                    02940000
         B     RCVNEXT            AND CHECK FOR MORE DATA               02950000
                                                                        02960000
*---------------------------------------------------------------------- 02970000
* QUEUED SPLIST SHOULD BE DATA OR LUSTAT. REJECT ANYTHING ELSE.         02980000
*---------------------------------------------------------------------- 02990000
                                                                        03000000
ARECNSIG DS    0H                                                       03010000
                                                                        03020000
         TM    SPLCNTRL,RPLDATA       IS IT DATA?                       03030000
         BO    RECEIVE                BRANCH IF YES                     03040000
                                                                        03050000
         TM    SPLCNTDC,RPLLUS        LUSTAT RU?                        03060000
         BO    RCVLUS                 BRANCH IF YES                     03070000
                                                                        03080000
         MVC   NRSPSNS,=XL4'10010001' "NOT SUPPORTED"                   03090000
         B     KILLREQ                AND END IT ALL                    03100000
                                                                        03110000
*---------------------------------------------------------------------- 03120000
* IF A BID IS RECEIVED DURING A CONVERSATION...REJECT IT                03130000
*---------------------------------------------------------------------- 03140000
                                                                        03150000
RCVLUS   DS    0H                                                       03160000
                                                                        03170000
         TM    SPLRH2,RHBBI           IS THIS A BID LUSTAT?             03180000
         BNO   RCVLSTAT               BRANCH IF NOT, SHOULD BE EB       03190000
                                                                        03200000
         MVC   NRSPSEQ,SPLSEQNO       USE SEQ# THAT WAS IN THE RU       03210000
         MVC   NRSPSNS,=X'08130000'   SET BID REJECT SENSE              03220000
         TM    ISEF2,ISEF2SLU         ARE WE THE SLU?                   03230000
         BNO   *+8                    BRANCH IF NOT...WE ARE PLU        03240000
         OI    NRSPSEQ,X'80'          HI BIT ON FOR PLU RESPONSE        03250000
         BAS   R14,DISPUNLK           RELEASE SERIALIZATION             03260000
         LR    R1,RSPLIST             PASS SPLIST IN R1                 03270000
         BAS   R14,SPLDQ              DEQUEUE THE SPLIST                03280000
         BAS   R14,SENDNRSP           SEND THE RESPONSE                 03290000
         BAS   R14,SPLFREE            RELEASE THE SPLIST                03300000
         B     LOCATRCB               RESERIALIZE & LOCATE THE RCB      03310000
                                                                        03320000
*---------------------------------------------------------------------- 03330000
* TRY TO COMPLETE THE RECEIVE WITH ANOTHER LOGICAL RECORD               03340000
*---------------------------------------------------------------------- 03350000
                                                                        03360000
RECEIVE  DS    0H                                                       03370000
                                                                        03380000
         ICM   R1,15,SPLAREAL     IS THERE ANY DATA?                    03390000
         BNP   RCVNXTRU           BRANCH IF NOT                         03400000
         L     R1,SPL62OFF        CURRENT OFFSET                        03410000
         C     R1,SPLAREAL        HAVE WE PROCESSED ALL DATA?           03420000
         BL    RCVMORE            BRANCH IF NOT                         03430000
                                                                        03440000
RCVNXTRU DS    0H                                                       03450000
                                                                        03460000
         TM    SPLRH0,RHECI       IS THIS AN END CHAIN RU?              03470000
         BNO   RCVSAVE            BRANCH IF NOT                         03480000
                                                                        03490000
         OC    RCBRLL#,RCBRLL#    EXPECTING MORE OF THE LL?             03500000
         BNZ   RCVECERR           BRANCH IF YES                         03510000
         OC    RCBRLLRM,RCBRLLRM  EXPECTING MORE OF THE DATA?           03520000
         BNZ   RCVECERR           BRANCH IF YES                         03530000
         OC    RCBRPFRM,RCBRPFRM  EXPECTING MORE OF THE PREFIX?         03540000
         BZ    RCVSTAT            BRANCH IF NOT                         03550000
                                                                        03560000
RCVECERR DS    0H                                                       03570000
                                                                        03580000
         MVC   NRSPSNS,=XL4'10010006' "EC AND NOT A COMPLETE RECORD"    03590000
         B     KILLREQ            AND END IT ALL                        03600000
                                                                        03610000
RCVSAVE  DS    0H                                                       03620000
                                                                        03630000
         MVC   SPL62OFF,SAV62OFF  RESTORE OFFSET IN CASE OF RE-QUEUE    03640000
         LR    R1,RSPLIST         PASS PLIST ADDRESS IN R1              03650000
         BAS   R14,SPLDQ          DEQUEUE THAT SPLIST                   03660000
         L     R1,SAVESPL         SAVE IN CASE WE NEED TO RE-QUEUE      03670000
         ST    RSPLIST,SAVESPL    SAVE IN CASE WE NEED TO RE-QUEUE      03680000
         ST    R1,SPL62RBN        SAVE IN CASE WE NEED TO RE-QUEUE      03690000
         B     RCVNEXT            GO GET ANOTHER RU                     03700000
                                                                        03710000
RCVMORE  DS    0H                                                       03720000
                                                                        03730000
         LTR   R1,R1              ARE WE AT THE START OF THE BUFFER?    03740000
         BNZ   RCVDATA            BRANCH IF NOT                         03750000
         TM    SPLRH0,RHFI        IS THERE AN FMH?                      03760000
         BNO   RCVDATA            BRANCH IF NOT                         03770000
                                                                        03780000
*---------------------------------------------------------------------- 03790000
* PROCESS AN FMH-7                                                      03800000
*---------------------------------------------------------------------- 03810000
                                                                        03820000
         MVC   DATA@,SPLAREA      CURRENT DATA ADDRESS                  03830000
         MVC   DATALEN,SPLAREAL   CURRENT DATA LENGTH                   03840000
                                                                        03850000
         L     R1,DATA@           ADDRESS OF FMH7                       03860000
         SR    R2,R2              CLEAR FOR IC                          03870000
         ICM   R2,B'0001',0(R1)   GET THE FMH LENGTH                    03880000
         LR    R3,R2              COPY THE LENGTH                       03890000
                                                                        03900000
         L     R15,DATALEN        RCV BUFFER COUNT                      03910000
         SR    R15,R3             UPDATE RCV BUFFER COUNT               03920000
         BM    FMH7REJ            BRANCH IF NOT ALL IN THIS RU ???????? 03930000
         ST    R15,DATALEN        SET UPDATED RCV BUFFER COUNT          03940000
                                                                        03950000
         LA    R15,0(R3,R1)       UPDATE RCV DATA ADDRESS               03960000
         ST    R15,DATA@          SET UPDATED DATA ADDRESS              03970000
                                                                        03980000
         A     R3,SPL62OFF        UPDATE RCV BUFFER OFFSET              03990000
         ST    R3,SPL62OFF        SET UPDATED RCV BUFFER OFFSET         04000000
                                                                        04010000
         C     R2,=F'7'           7 BYTES?                              04020000
         BNE   FMH7REJ            BRANCH IF NOT                         04030000
         CLI   1(R1),X'07'        IS IT AN FMH7?                        04040000
         BNE   FMH7REJ            BRANCH IF NOT                         04050000
         TM    6(R1),X'80'        IS AN ERROR LOG GDS VARIABLE COMING?  04060000
         BNO   *+8                BRANCH IF NOT                         04070000
         OI    RCBF1,RCBF1ELG     REMEMBER ERROR LOG GDS IS COMING      04080000
         LA    R1,2(,R1)          ADDRESS OF FMH7 SENSE INFO            04090000
         L     R15,IL6@TSNS       ADDRESS OF SENSE TRANSLATION ROUTINE  04100000
         BASR  R14,R15            GET THE TRANSLATION TO RETURN CODE    04110000
         ST    R0,#RETCODE        RETURN TRANSLATION AS CPIC RC         04120000
                                                                        04130000
         TM    RCBF1,RCBF1ELG     IS THERE ERROR LOG DATA?              04140000
         BNO   NOELOG             BRANCH IF NOT                         04150000
         NI    RCBF1,255-RCBF1ELG CLEAR THE FLAG                        04160000
         ICM   R1,15,DATALEN      LENGTH REMAINING IN RU                04170000
         BNP   FMH7REJ            FOR US...LOG DATA MUST BE IN THIS RU  04180000
         C     R1,=F'4'           AT LEAST 4 BYTES IN RU?               04190000
         BL    FMH7REJ            BRANCH IF NOT                         04200000
         L     R1,DATA@           ADDRESS OF LOG DATA                   04210000
         SR    R2,R2              CLEAR FOR ICM                         04220000
         ICM   R2,B'0011',0(R1)   GET LOG DATA LENGTH                   04230000
         BNP   FMH7REJ            BRANCH IF NO LENGTH                   04240000
         N     R2,=X'00007FFF'    CLEAR CONTINUATION BIT                04250000
         C     R2,=F'4'           AT LEAST 4 BYTES?                     04260000
         BL    FMH7REJ            BRANCH IF NOT                         04270000
         CLC   2(2,R1),=X'12E1'   CORRECT ID?                           04280000
         BNE   FMH7REJ            BRANCH IF NOT                         04290000
         LR    R3,R2              COPY LENGTH                           04300000
         L     R15,DATALEN        REMAINING RU LENGTH                   04310000
         SR    R15,R3             LENGTH AFTER ERROR LOG IS REMOVED     04320000
         BM    FMH7REJ            REJECT IF NOT ALL IN THIS RU          04330000
         ST    R15,DATALEN        SAVE UPDATED DATA LENGTH              04340000
         LA    R15,0(R3,R1)       ADDRESS OF DATA PAST ERROR LOG        04350000
         ST    R15,DATA@          SAVE UPDATED DATA ADDRESS             04360000
         A     R3,SPL62OFF        COMPUTE NEW DATA OFFSET               04370000
         ST    R3,SPL62OFF        SAVE UPDATED DATA OFFSET              04380000
         LR    R3,R1              ADDRESS OF ERROR LOG DATA             04390000
                                                                        04400000
         L62LOGD (R3),                                                 +04410000
               (RISESS),                                               +04420000
               =CL8'RECEIVED',                                         +04430000
               =F'8',                                                  +04440000
               L62RETCD,                                               +04450000
               MF=(E,L62MFL)      LOG THE ERROR LOG DATA                04460000
                                                                        04470000
NOELOG   DS    0H                                                       04480000
                                                                        04490000
         XC    RCBRLL#,RCBRLL#    RESET TRACKING FIELD                  04500000
         XC    RCBRPFRM,RCBRPFRM  RESET TRACKING FIELD                  04510000
         XC    RCBRLLRM,RCBRLLRM  RESET TRACKING FIELD                  04520000
         CLC   #RETCODE,=A(CM_DEALLOCATED_ABEND)                        04530000
         BE    RCVSTAT            GO TO PROCESS THE CEB/EC              04540000
         B     RCVRTSR            AND COMPLETE THE RECEIVE              04550000
                                                                        04560000
FMH7REJ  DS    0H                                                       04570000
                                                                        04580000
         MVC   NRSPSNS,=XL4'10010007' "INVALID FMH7 OR UNEXPECTED FMH"  04590000
         B     KILLREQ            AND END IT ALL                        04600000
                                                                        04610000
*---------------------------------------------------------------------- 04620000
* PROCESS DATA TO BE RECEIVED                                           04630000
*---------------------------------------------------------------------- 04640000
                                                                        04650000
RCVDATA  DS    0H                                                       04660000
                                                                        04670000
*                                                                       04680000
* ESTABLISH CURRENT POSITION IN RECEIVED DATA BUFFER                    04690000
*---------------------------------------------------------------------- 04700000
                                                                        04710000
         L     R1,SPL62OFF        CURRENT DATA OFFSET IN BUFFER         04720000
         A     R1,SPLAREA         CURRENT DATA ADDRESS IN BUFFER        04730000
         ST    R1,DATA@           SAVE IN WORKING STORAGE               04740000
                                                                        04750000
         L     R1,SPLAREAL        TOTAL DATA BUFFER LENGTH              04760000
         S     R1,SPL62OFF        AMOUNT OF DATA LEFT TO PROCESS        04770000
         ST    R1,DATALEN         SAVE IN WORKING STORAGE               04780000
                                                                        04790000
Y        USING CMLIST,R3                                                04800000
         L     R3,RCV62PLA        CMLIST ADDRESS                        04810000
         L     R1,Y.CMLPARM2      ADDRESS OF USER DATA BUFFER           04820000
         L     R2,Y.CMLPARM5      ADDR OF CURRENT AMOUNT OF DATA RCV'D  04830000
         A     R1,0(,R2)          ADDRESS FOR ADDITIONAL DATA           04840000
         ST    R1,RCV@            SAVE IN WORKING STORAGE               04850000
         L     R1,Y.CMLPARM3      ADDR OF TOTAL USER DATA BUFFER SIZE   04860000
         L     R1,0(,R1)          TOTAL USER DATA BUFFER SIZE           04870000
         S     R1,0(,R2)          REMAINING AREA IN USER DATA BUFFER    04880000
         ST    R1,RCVLEN          SAVE IN WORKING STORAGE               04890000
         DROP  Y                                                        04900000
                                                                        04910000
*                                                                       04920000
* IF WE ARE IN THE MIDDLE OF A LOGICAL RECORD...CONTINUE THE RCV        04930000
*---------------------------------------------------------------------- 04940000
                                                                        04950000
         ICM   R1,15,RCBRPFRM     HAS THE PREFIX BEEN PARTIALLY PROC.?  04960000
         BNZ   RCVLLCNT           BRANCH IF YES                         04970000
         ICM   R1,15,RCBRLLRM     HAS A PARTIAL RECORD BEEN PROCESSED?  04980000
         BZ    RCVSTART           BRANCH IF NOT                         04990000
         ST    R1,RECLEN          SET RECORD LENGTH TO REMAINDER        05000000
         B     RCVNOGDS           AND TRY TO MOVE IT                    05010000
                                                                        05020000
*                                                                       05030000
* IF WE HAVE A PARTIAL LL OR LL-GDSID...COMPLETE IT                     05040000
*---------------------------------------------------------------------- 05050000
                                                                        05060000
RCVSTART DS    0H                                                       05070000
                                                                        05080000
         LA    R3,2               LL FOR BASIC CONV                     05090000
         CLI   RCBCTYPE+(L'RCBCTYPE-1),CM_BASIC_CONVERSATION            05100000
         BE    *+8                BRANCH IF BASIC CONV                  05110000
         LA    R3,4               LL-GDSID FOR MAPPED CONVERSATION      05120000
                                                                        05130000
         ICM   R1,15,RCBRLL#      ARE THERE BUFFERED LL BYTES?          05140000
         BZ    RCVNEW             BRANCH IF NOT                         05150000
                                                                        05160000
         SR    R3,R1              # OF REMAINING BYTES                  05170000
         LA    R1,RCBRLL1(R1)     ADDRESS FOR REMAINING BYTES           05180000
         L     R2,DATA@           ADDRESS OF BUFFER DATA                05190000
         C     R3,DATALEN         ARE REMAINING BYTES AVAILABLE?        05200000
         BH    RCVMORLL           BRANCH IF NOT                         05210000
                                                                        05220000
         BCTR  R3,0               LENGTH CODE FOR MOVE                  05230000
         MVC   0(*-*,R1),0(R2)    COMPLETE THE LL FIELD                 05240000
         EX    R3,*-6             COMPLETE THE LL FIELD                 05250000
         LA    R3,1(,R3)          LENGTH USED                           05260000
                                                                        05270000
         L     R1,DATALEN         RCV BUFFER COUNT                      05280000
         SR    R1,R3              UPDATE RCV BUFFER COUNT               05290000
         ST    R1,DATALEN         SET UPDATED RCV BUFFER COUNT          05300000
                                                                        05310000
         L     R1,DATA@           CURRENT RCV DATA ADDRESS              05320000
         LA    R1,0(R3,R1)        UPDATE RCV DATA ADDRESS               05330000
         ST    R1,DATA@           SET UPDATED DATA ADDRESS              05340000
                                                                        05350000
         A     R3,SPL62OFF        UPDATE RCV BUFFER OFFSET              05360000
         ST    R3,SPL62OFF        SET UPDATED RCV BUFFER OFFSET         05370000
         B     RCVDLL             THE LL OR LL/GDSID HAS BEEN ISOLATED  05380000
                                                                        05390000
RCVMORLL DS    0H                                                       05400000
                                                                        05410000
         L     R3,DATALEN         # OF BYTES PRESENT                    05420000
         BCTR  R3,0               LENGTH CODE FOR MOVE                  05430000
         MVC   0(*-*,R1),0(R2)    SAVE MORE OF THE LL FIELD             05440000
         EX    R3,*-6             SAVE MORE OF THE LL FIELD             05450000
                                                                        05460000
         L     R1,RCBRLL#         PREVIOUSLY BUFFERED BYTES             05470000
         A     R1,DATALEN         PLUS ADDITIONAL BYTES                 05480000
         ST    R1,RCBRLL#         TOTAL BUFFERED BYTES                  05490000
                                                                        05500000
         L     R1,SPL62OFF        CURRENT RCV BUFFER OFFSET             05510000
         A     R1,DATALEN         UPDATE OFFSET PAST THE DATA           05520000
         ST    R1,SPL62OFF        SAVE THE UPDATED OFFSET               05530000
         B     RECEIVE            & GO CHECK FOR MORE DATA              05540000
                                                                        05550000
*                                                                       05560000
* START RECEIVING A NEW LOGICAL RECORD                                  05570000
*---------------------------------------------------------------------- 05580000
                                                                        05590000
RCVNEW   DS    0H                                                       05600000
                                                                        05610000
         L     R2,DATA@           CURRENT DATA ADDRESS                  05620000
         C     R3,DATALEN         CAN WE GET THE WHOLE PREFIX?          05630000
         BNH   RCVPREFX           BRANCH IF YES, GET THE PREFIX         05640000
                                                                        05650000
*                                                                       05660000
* THE LL/LL-GDSID IS SPLIT BETWEEN TWO RU'S...SAVE THE FIRST PART       05670000
*---------------------------------------------------------------------- 05680000
                                                                        05690000
         MVC   RCBRLL#,DATALEN    SAVE COUNT OF LL BYTES BUFFERED       05700000
         L     R1,DATALEN         AMOUNT TO BUFFER                      05710000
         BCTR  R1,0               LENGTH CODE FOR MVC                   05720000
         MVC   RCBRLL1(*-*),0(R2) SAVE THE PARTIAL LL IN THE RCB        05730000
         EX    R1,*-6             PERFORM THE SAVE MVC                  05740000
         L     R1,SPL62OFF        CURRENT RCV BUFFER OFFSET             05750000
         A     R1,DATALEN         UPDATE OFFSET PAST THE DATA           05760000
         ST    R1,SPL62OFF        SAVE THE UPDATED OFFSET               05770000
         B     RECEIVE            & GO CHECK FOR MORE DATA              05780000
                                                                        05790000
*                                                                       05800000
* RECEIVE THE LL OR LL/GDSID INTO A HOLDING AREA                        05810000
*---------------------------------------------------------------------- 05820000
                                                                        05830000
RCVPREFX DS    0H                                                       05840000
                                                                        05850000
         LA    R1,RCBRLL1         ADDRESS TO HOLD PREFIX                05860000
         BCTR  R3,0               LENGTH CODE FOR MOVE                  05870000
         MVC   0(*-*,R1),0(R2)    COMPLETE THE LL FIELD                 05880000
         EX    R3,*-6             COMPLETE THE LL FIELD                 05890000
         LA    R3,1(,R3)          LENGTH OF PREFIX                      05900000
                                                                        05910000
         L     R1,DATALEN         RCV BUFFER COUNT                      05920000
         SR    R1,R3              UPDATE RCV BUFFER COUNT               05930000
         ST    R1,DATALEN         SET UPDATED RCV BUFFER COUNT          05940000
                                                                        05950000
         L     R1,DATA@           CURRENT RCV DATA ADDRESS              05960000
         LA    R1,0(R3,R1)        UPDATE RCV DATA ADDRESS               05970000
         ST    R1,DATA@           SET UPDATED DATA ADDRESS              05980000
                                                                        05990000
         A     R3,SPL62OFF        UPDATE RCV BUFFER OFFSET              06000000
         ST    R3,SPL62OFF        SET UPDATED RCV BUFFER OFFSET         06010000
         B     RCVDLL             CONTINUE                              06020000
                                                                        06030000
*                                                                       06040000
* THE COMPLETE LL OR LL/GDSID HAS BEEN RECEIVED...                      06050000
* FOR BASIC CONVERSATIONS...RECEIVE IT INTO THE USER BUFFER             06060000
*---------------------------------------------------------------------- 06070000
                                                                        06080000
RCVDLL   DS    0H                                                       06090000
                                                                        06100000
         SR    R1,R1              CLEAR TO ZERO                         06110000
         ST    R1,RCBRLL#         NO MORE PREFIX TO RECEIVE             06120000
         MVI   RCBRPFRM+(L'RCBRPFRM-1),2 TWO BYTES OF LL TO MOVE        06130000
                                                                        06140000
RCVLLCNT DS    0H                                                       06150000
                                                                        06160000
         SR    R1,R1              CLEAR FOR ICM                         06170000
         ICM   R1,B'0011',RCBRLL1 LL OF LOGICAL RECORD                  06180000
         N     R1,=X'00007FFF'    ENSURE CONTINUATION BIT IS OFF        06190000
         BCTR  R1,0               UPDATE LENGTH OF RECORD - LL          06200000
         BCTR  R1,0               UPDATE LENGTH OF RECORD - LL          06210000
         ST    R1,RECLEN          SAVE THE RECORD LENGTH W/O LL         06220000
                                                                        06230000
         CLI   RCBCTYPE+(L'RCBCTYPE-1),CM_MAPPED_CONVERSATION           06240000
         BNE   RCVBASIC           BRANCH IF NOT MAPPED                  06250000
         MVI   RCBRPFRM+(L'RCBRPFRM-1),0 NO LL REMAINS TO BE MOVED      06260000
         BCTR  R1,0               UPDATE LENGTH OF RECORD - GDSID       06270000
         BCTR  R1,0               UPDATE LENGTH OF RECORD - GDSID       06280000
         ST    R1,RECLEN          SAVE THE RECORD LENGTH W/O GDS-ID     06290000
         CLC   RCBRLL3(2),=X'12FF' IS THE GDS-ID CORRECT?               06300000
         BE    RCVNOGDS           BRANCH IF YES                         06310000
         MVC   NRSPSNS,=XL4'10010008' "UNEXPECTED GDS-ID"               06320000
         B     KILLREQ            AND END IT ALL                        06330000
                                                                        06340000
RCVBASIC DS    0H                                                       06350000
                                                                        06360000
         MVI   #DATAR+(L'#DATAR-1),CM_DATA_RECEIVED                     06370000
         LA    R15,2              SIZE OF THE LL DATA                   06380000
         L     R3,RCBRPFRM        AMOUNT LEFT TO MOVE                   06390000
         SR    R15,R3             AMOUNT ALREADY MOVED                  06400000
         L     R2,RCVLEN          USER BUFFER LENGTH                    06410000
         CR    R2,R3              ENOUGH USER BUFFER TO RECEIVE LL?     06420000
         BL    RCVBSOME           BRANCH IF NOT ENOUGH FOR FULL LL      06430000
         L     R1,RCV@            USER BUFFER ADDRESS                   06440000
         LA    R14,RCBRLL1        ADDRESS OF BUFFERED LL                06450000
         AR    R14,R15            ADDRESS OF LL BYTE(S) TO BE MOVED     06460000
         BCTR  R3,0               LENGTH CODE OF MOVE                   06470000
         MVC   0(*-*,R1),0(R14)   MOVE LL INTO USER BUFFER              06480000
         EX    R3,*-6             MOVE LL INTO USER BUFFER              06490000
         LA    R1,1(R3,R1)        UPDATE USER BUFFER ADDRESS            06500000
         ST    R1,RCV@            SET UPDATED USER BUFFER ADDRESS       06510000
         SR    R2,R3              UPDATE USER BUFFER LENGTH             06520000
         BCTR  R2,0               UPDATE USER BUFFER LENGTH             06530000
         ST    R2,RCVLEN          SET UPDATED USER BUFFER LENGTH        06540000
                                                                        06550000
Y        USING CMLIST,R15                                               06560000
         L     R15,RCV62PLA       CMLIST ADDRESS                        06570000
         L     R2,Y.CMLPARM5      ADDRESS OF RECEIVED LENGTH            06580000
         L     R1,0(,R2)          CURRENT RECEIVED LENGTH               06590000
         LA    R1,1(R3,R1)        UPDATE THE RCVD LENGTH FOR 1/2 BYTES  06600000
         ST    R1,0(,R2)          SET THE UPDATED RECEIVED LENGTH       06610000
         DROP  Y                                                        06620000
         MVI   RCBRPFRM+(L'RCBRPFRM-1),0 NO LL REMAINS TO BE MOVED      06630000
         B     RCVNOGDS           AND MOVE THE RECORD                   06640000
                                                                        06650000
RCVBSOME DS    0H                                                       06660000
                                                                        06670000
         LTR   R2,R2              IS USER BUFFER ZERO LENGTH?           06680000
         BNP   RCVBFILL           BRANCH IF YES                         06690000
         L     R1,RCV@            USER BUFFER ADDRESS                   06700000
         LA    R14,RCBRLL1        ADDRESS OF BUFFERED LL                06710000
         AR    R14,R15            ADDRESS OF LL BYTE(S) TO BE MOVED     06720000
         BCTR  R2,0               LENGTH CODE OF MOVE                   06730000
         MVC   0(*-*,R1),0(R14)   MOVE LL INTO USER BUFFER              06740000
         EX    R2,*-6             MOVE LL INTO USER BUFFER              06750000
         LA    R1,1(R2,R1)        UPDATE USER BUFFER ADDRESS            06760000
         ST    R1,RCV@            SET UPDATED USER BUFFER ADDRESS       06770000
         XC    RCVLEN,RCVLEN      UPDATE USER BUFFER LENGTH             06780000
         SR    R3,R2              UPDATE LENGTH OF LL REMAINING         06790000
         BCTR  R3,0               UPDATE LENGTH OF LL REMAINING         06800000
         ST    R3,RCBRPFRM        SET UPDATED LENGTH OF LL REMAINING    06810000
                                                                        06820000
Y        USING CMLIST,R15                                               06830000
         L     R15,RCV62PLA       CMLIST ADDRESS                        06840000
         L     R3,Y.CMLPARM5      ADDRESS OF RECEIVED LENGTH            06850000
         L     R1,0(,R3)          CURRENT RECEIVED LENGTH               06860000
         LA    R1,1(R2,R1)        UPDATE THE RECEIVED LENGTH            06870000
         ST    R1,0(,R3)          SET THE UPDATED RECEIVED LENGTH       06880000
         DROP  Y                                                        06890000
                                                                        06900000
RCVBFILL DS    0H                                                       06910000
                                                                        06920000
         CLI   RCBFILL+(L'RCBFILL-1),CM_FILL_BUFFER                     06930000
         BE    RCVSTAT            BRANCH IF BASIC(FILL_BUFFER)          06940000
         MVI   #DATAR+(L'#DATAR-1),CM_INCOMPLETE_DATA_RECEIVED          06950000
         B     RCVSTAT            AND COMPLETE THE RECEIVE              06960000
                                                                        06970000
*                                                                       06980000
* MOVE THE DATA PORTION OF THE RECORD TO THE USER BUFFER                06990000
*---------------------------------------------------------------------- 07000000
                                                                        07010000
RCVNOGDS DS    0H                                                       07020000
                                                                        07030000
         L     R15,RECLEN         LENGTH OF DATA TO BE MOVED            07040000
         C     R15,DATALEN        IS ALL THE DATA IN CURRENT RU?        07050000
         BNH   *+8                BRANCH IF YES                         07060000
         L     R15,DATALEN        MOVE ONLY WHAT IS IN THE CURRENT RU   07070000
         ST    R15,BUFRLENG       SAVE FOR LATER                        07080000
                                                                        07090000
         LR    R1,R15             AMOUNT TO BE RECEIVED IN USER BUFFER  07100000
         C     R1,RCVLEN          WILL ALL THE DATA FIT?                07110000
         BNH   *+8                BRANCH IF YES                         07120000
         L     R1,RCVLEN          MOVE ONLY WHAT WILL FIT IN BUFFER     07130000
         ST    R1,USERLENG        SAVE FOR LATER                        07140000
                                                                        07150000
         L     R0,RCV@            ADDRESS OF CURRENT USER AREA          07160000
         L     R14,DATA@          ADDRESS OF RECEIVE BUFFER DATA        07170000
         MVCL  R0,R14             MOVE DATA TO USER BUFFER              07180000
         ST    R0,RCV@            SET UPDATED USER BUFFER ADDRESS       07190000
         ST    R14,DATA@          SET UPDATED RECEIVE BUFFER ADDRESS    07200000
                                                                        07210000
         L     R1,SPL62OFF        CURRENT OFFSET TO RECEIVE DATA        07220000
         A     R1,USERLENG        SKIP THE DATA JUST MOVED              07230000
         ST    R1,SPL62OFF        SET UPDATED OFFSET                    07240000
                                                                        07250000
         L     R1,RCVLEN          USER BUFFER SIZE                      07260000
         S     R1,USERLENG        REMAINING SIZE OF USER BUFFER         07270000
         ST    R1,RCVLEN          SET UPDATED USER BUFFER SIZE          07280000
                                                                        07290000
         L     R1,DATALEN         RECEIVE BUFFER SIZE                   07300000
         S     R1,USERLENG        REMAINING SIZE OF RECEIVE BUFFER      07310000
         ST    R1,DATALEN         SET UPDATED RECEIVE BUFFER SIZE       07320000
                                                                        07330000
Y        USING CMLIST,R3                                                07340000
         L     R3,RCV62PLA        CMLIST ADDRESS                        07350000
         L     R1,USERLENG        AMOUNT OF DATA JUST MOVED             07360000
         L     R2,Y.CMLPARM5      ADDR OF CURRENT AMOUNT OF DATA RCV'D  07370000
         A     R1,0(,R2)          TOTAL AMOUNT OF USER DATA             07380000
         ST    R1,0(,R2)          SET UPDATED USER DATA COUNT           07390000
         DROP  Y                                                        07400000
                                                                        07410000
         L     R1,RECLEN          TOTAL LOGICAL RECORD LENGTH           07420000
         S     R1,USERLENG        LENGTH THAT WAS RECEIVED              07430000
         ST    R1,RCBRLLRM        LENGTH REMAINING (MAY BE ZERO)        07440000
                                                                        07450000
         MVI   #DATAR+(L'#DATAR-1),CM_DATA_RECEIVED                     07460000
                                                                        07470000
         CLI   RCBFILL+(L'RCBFILL-1),CM_FILL_BUFFER                     07480000
         BNE   RCVBLL             BRANCH IF MAPPED OR BASIC(FILL_LL)    07490000
                                                                        07500000
         OC    RCVLEN,RCVLEN      WAS THE USER BUFFER EXHAUSTED?        07510000
         BZ    RCVSTAT            BRANCH IF YES                         07520000
         B     RECEIVE            GO GET MORE DATA TO FILL BUFFER       07530000
                                                                        07540000
RCVBLL   DS    0H                                                       07550000
                                                                        07560000
         CLC   USERLENG,RECLEN    WAS THE COMPLETE DATA RECEIVED?       07570000
         BE    RCVCMPL1           BRANCH IF YES                         07580000
         OC    RCVLEN,RCVLEN      WAS THE USER BUFFER EXHAUSTED?        07590000
         BZ    RCVINCMP           BRANCH IF YES                         07600000
         B     RECEIVE            GO GET MORE DATA TO COMPLETE RECORD   07610000
                                                                        07620000
RCVCMPL1 DS    0H                                                       07630000
                                                                        07640000
         CLI   RCBCTYPE+(L'RCBCTYPE-1),CM_BASIC_CONVERSATION            07650000
         BE    RCVCMPL2           BRANCH IF BASIC CONV                  07660000
         TM    RCBRLL1,X'80'      IS THIS RECORD CONTINUED?             07670000
         BO    RCVNLAST           BRANCH IF NOT LAST SEGMENT            07680000
                                                                        07690000
RCVCMPL2 DS    0H                                                       07700000
                                                                        07710000
         MVI   #DATAR+(L'#DATAR-1),CM_COMPLETE_DATA_RECEIVED            07720000
         B     RCVSTAT            RECORD COMPLETED, CHECK FOR STATUS    07730000
                                                                        07740000
RCVNLAST DS    0H                                                       07750000
                                                                        07760000
         OC    RCVLEN,RCVLEN      WAS THE USER BUFFER EXHAUSTED?        07770000
         BZ    RCVINCMP           BRANCH IF YES TO POST                 07780000
         B     RECEIVE            GO LOOK FOR NEXT SEGMENT              07790000
                                                                        07800000
RCVINCMP DS    0H                                                       07810000
                                                                        07820000
         MVI   #DATAR+(L'#DATAR-1),CM_INCOMPLETE_DATA_RECEIVED          07830000
         B     RCVRTSR            RECORD INCOMPLETE, CHECK RTS RCV'D    07840000
                                                                        07850000
*---------------------------------------------------------------------- 07860000
* TRY TO SET STATUS BASED ON END-CHAIN INDICATORS                       07870000
*---------------------------------------------------------------------- 07880000
                                                                        07890000
RCVSTAT  DS    0H                                                       07900000
                                                                        07910000
         CLC   SPL62OFF,SPLAREAL  HAS ALL THE DATA BEEN PROCESSED?      07920000
         BL    RCVRTSR            BRANCH IF NOT, LEAVE ON QUEUE         07930000
         ICM   R15,15,RCBRPFRM    ARE WE STILL MOVING THE PREFIX?       07940000
         BNZ   RCVRTSR            BRANCH IF YES, LEAVE ON QUEUE         07950000
                                                                        07960000
RCVLSTAT DS    0H                                                       07970000
                                                                        07980000
         TM    SPLRH0,RHECI       IS THIS AN END-CHAIN RU?              07990000
         BNO   RCVSDQ             BRANCH IF NOT, DEQUEUE AND FREE       08000000
         MVI   ISE62FRC,ISE62FRC_BETC                                   08010000
                                                                        08020000
         TM    SPLRH1,RHERI       IS THIS A DRX?                        08030000
         BO    RCVSNDRX           BRANCH IF NOT                         08040000
         TM    SPLRH1,RHDR1       IS THIS A DR1?                        08050000
         BNO   *+8                BRANCH IF NOT                         08060000
         OI    FLAG,FLAGDR1       REMEMBER DR1                          08070000
         TM    SPLRH1,RHDR2       IS THIS A DR2?                        08080000
         BNO   *+8                BRANCH IF NOT                         08090000
         OI    FLAG,FLAGDR2       REMEMBER DR2                          08100000
         MVI   ISE62FRC,ISE62FRC_PR                                     08110000
                                                                        08120000
RCVSNDRX DS    0H                                                       08130000
                                                                        08140000
         TM    SPLRH2,RHCEBI      IS THIS A CEB?                        08150000
         BO    RCVSCEBI           BRANCH IF YES                         08160000
                                                                        08170000
         TM    SPLRH2,RHCDI       IS THIS A CD?                         08180000
         BO    RCVSCDI            BRANCH IF YES                         08190000
                                                                        08200000
         TM    FLAG,FLAGDR2       IS THIS A DR2?                        08210000
         BNO   RCVSDQ             BRANCH IF NOT                         08220000
         MVI   #STATR+(L'#STATR-1),CM_CONFIRM_RECEIVED                  08230000
         B     RCVRTSR            DON'T RELEASE, WAIT FOR CONFIRMED     08240000
                                                                        08250000
RCVSCDI  DS    0H                                                       08260000
                                                                        08270000
         MVI   ISE62FCD,ISE62FCD_CD                                     08280000
         MVI   #STATR+(L'#STATR-1),CM_CONFIRM_SEND_RECEIVED             08290000
         TM    FLAG,FLAGDR2       IS THIS A DR2?                        08300000
         BO    RCVRTSR            DON'T RELEASE, WAIT FOR CONFIRMED     08310000
                                                                        08320000
         MVI   #STATR+(L'#STATR-1),CM_SEND_RECEIVED                     08330000
         MVI   ISE62FRC,ISE62FRC_PSR                                    08340000
         B     RCVSDQ             GO RELEASE THE RU                     08350000
                                                                        08360000
RCVSCEBI DS    0H                                                       08370000
                                                                        08380000
         TM    FLAG,FLAGDR2       IS THIS A DR2?                        08390000
         BNO   RCVSDEAL           BRANCH IF NOT                         08400000
         MVI   #STATR+(L'#STATR-1),CM_CONFIRM_DEALLOC_RECEIVED          08410000
         B     RCVRTSR            DON'T RELEASE, WAIT FOR CONFIRMED     08420000
                                                                        08430000
RCVSDEAL DS    0H                                                       08440000
                                                                        08450000
         MVI   ISE62FBR,ISE62FBR_BETB                                   08460000
         MVI   ISE62FCD,ISE62FCD_NOCD                                   08470000
         TM    FLAG,FLAGDR1       IS THIS A DR1?                        08480000
         BNO   RCVSDLFL           BRANCH IF NOT                         08490000
         MVI   #RETCODE+(L'#RETCODE-1),CM_DEALLOCATED_ABEND             08500000
                                                                        08510000
RCVSDQ   DS    0H                                                       08520000
                                                                        08530000
         BAS   R14,DISPUNLK       RELEASE SERIALIZATION                 08540000
         LR    R1,RSPLIST         PASS SPLIST IN R1                     08550000
         BAS   R14,SPLDQ          REMOVE BUFFER FROM THE QUEUE          08560000
         BAS   R14,SENDPRSP       RESPOND TO IT                         08570000
         BAS   R14,SPLFREE        RELEASE THE SPLIST                    08580000
         BAS   R14,DISPLOCK       SERIALIZE                             08590000
                                                                        08600000
         $WULOC LOCATE,           FIND THE WORK UNIT                   +08610000
               TOKEN=RCV62ENT,    WORK UNIT TOKEN ADDRESS              +08620000
               USERDATA=WUDATA,   XL16 AREA TO RECEIVE USER DATA       +08630000
               LOCKED=YES,        DISP LOCK LOCALLY ACQUIRED           +08640000
               MF=(E,$WUMFL)      VALIDATE WORK UNIT                    08650000
                                                                        08660000
         LTR   R15,R15            LOCATE SUCCESS?                       08670000
         BNZ   RCVRELSE           BRANCH IF NOT                         08680000
         LTR   R1,R1              IS WORKUNIT TERMINATING?              08690000
         BNZ   RCVRELSE           BRANCH IF YES                         08700000
         L     RRCB,RCV62RCB      RCB SHOULD BE VALID                   08710000
         B     RCVRTSR                                                  08720000
                                                                        08730000
RCVSDLFL DS    0H                                                       08740000
                                                                        08750000
         MVI   #RETCODE+(L'#RETCODE-1),CM_DEALLOCATED_NORMAL            08760000
         B     RCVSDQ                                                   08770000
                                                                        08780000
*---------------------------------------------------------------------- 08790000
* SET THE REQUEST TO SEND RECEIVED INDICATOR                            08800000
*---------------------------------------------------------------------- 08810000
                                                                        08820000
RCVRTSR  DS    0H                                                       08830000
                                                                        08840000
         TM    ISE62FL1,ISE62SIG  WAS A SIGNAL RECEIVED?                08850000
         BNO   RCVPOST            BRANCH IF NOT                         08860000
         NI    ISE62FL1,255-ISE62SIG                                    08870000
         MVI   #RTSR+(L'#RTSR-1),CM_REQUEST_TO_SEND_RECEIVED            08880000
                                                                        08890000
*---------------------------------------------------------------------- 08900000
* COMPLETE USER'S PLIST AND POST IT                                     08910000
*---------------------------------------------------------------------- 08920000
                                                                        08930000
RCVPOST  DS    0H                                                       08940000
                                                                        08950000
Y        USING CMLIST,R3                                                08960000
         L     R3,RCV62PLA        CMLIST ADDRESS                        08970000
         L     R1,Y.CMLPARM4      ADDRESS OF DATA_RECEIVED AREA         08980000
         MVC   0(4,R1),#DATAR     SET THE VARIABLE                      08990000
         L     R1,Y.CMLPARM6      ADDRESS OF STATUS_RECEIVED AREA       09000000
         MVC   0(4,R1),#STATR     SET THE VARIABLE                      09010000
         L     R1,Y.CMLPARM7      ADDRESS OF RTS_RECEIVED AREA          09020000
         MVC   0(4,R1),#RTSR      SET THE VARIABLE                      09030000
         L     R1,Y.CMLPARM8      ADDRESS OF RETURN_CODE AREA           09040000
         MVC   0(4,R1),#RETCODE   SET THE VARIABLE                      09050000
         DROP  Y                                                        09060000
                                                                        09070000
         BAS   R14,POSTRECV       POST THE USER                         09080000
         L     R1,ISE62RRQ        RECEIVE REQUEST SPLIST                09090000
         XC    ISE62RRQ,ISE62RRQ  CLEAR QUEUED RECEIVE REQUEST          09100000
         BAS   R14,SPLFREE        RELEASE THE SPLIST                    09110000
                                                                        09120000
*---------------------------------------------------------------------- 09130000
* RELEASE DEQUEUED RECEIVE SPLISTS                                      09140000
*---------------------------------------------------------------------- 09150000
                                                                        09160000
RCVRELSE DS    0H                                                       09170000
                                                                        09180000
         ICM   R1,15,SAVESPL               DEQUEUED SPLIST              09190000
         BZ    RETURN                      BRANCH IF NO MORE LEFT       09200000
         MVC   SAVESPL,SPL62RBN-SPLIST(R1) NEXT SPLIST IS NOW THE HEAD  09210000
         BAS   R14,SPLFREE                 RELEASE THE STORAGE          09220000
         B     RCVRELSE                    AND FREE THE NEXT ONE        09230000
                                                                        09240000
*---------------------------------------------------------------------- 09250000
* KILL THE SESSION AND THE REQUEST DUE TO UNUSUAL ERROR                 09260000
* (CALLER SETS NRSPSNS TO THE APPROPRIATE SENSE CODE BEFORE BRANCHING)  09270000
*---------------------------------------------------------------------- 09280000
                                                                        09290000
KILLREQ  DS    0H                                                       09300000
                                                                        09310000
         MVC   NRSPSEQ,ISE62CBS   USE CURRENT BRACKET SEQUENCE NUMBER   09320000
         MVC   RETR15,=F'4'       SET RETURN CODE TO TRIGGER SESS END   09330000
         BAS   R14,DISPUNLK       RELEASE SERIALIZATION                 09340000
         LR    R1,RSPLIST         PASS SPLIST IN R1                     09350000
         BAS   R14,SPLDQ          DEQUEUE THE SPLIST                    09360000
         BAS   R14,SENDNRSP       SEND THE RESPONSE                     09370000
         BAS   R14,SPLFREE        RELEASE THE SPLIST                    09380000
         BAS   R14,DISPLOCK       SERIALIZE                             09390000
                                                                        09400000
         $WULOC LOCATE,           FIND THE WORK UNIT                   +09410000
               TOKEN=RCV62ENT,    WORK UNIT TOKEN ADDRESS              +09420000
               USERDATA=WUDATA,   XL16 AREA TO RECEIVE USER DATA       +09430000
               LOCKED=YES,        DISP LOCK LOCALLY ACQUIRED           +09440000
               MF=(E,$WUMFL)      VALIDATE WORK UNIT                    09450000
                                                                        09460000
         LTR   R15,R15            LOCATE SUCCESS?                       09470000
         BNZ   RCVRELSE           BRANCH IF NOT                         09480000
         LTR   R1,R1              IS WORKUNIT TERMINATING?              09490000
         BNZ   RCVRELSE           BRANCH IF YES                         09500000
         L     RRCB,RCV62RCB      RCB SHOULD BE VALID                   09510000
         MVC   #RETCODE,=A(CM_RESOURCE_FAILURE_NO_RETRY)                09520000
         B     RCVPOST            AND POST THE USER                     09530000
                                                                        09540000
*---------------------------------------------------------------------- 09550000
* RETURN TO CALLER                                                      09560000
*---------------------------------------------------------------------- 09570000
                                                                        09580000
RETURN   DS    0H                                                       09590000
                                                                        09600000
         BAS   R14,DISPUNLK       RELEASE SERIALIZATION                 09610000
                                                                        09620000
         LM    R15,R1,RETREGS     LOAD RETURN VALUES                    09630000
                                                                        09640000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    09650000
                                                                        09660000
*---------------------------------------------------------------------- 09670000
* SUBROUTINE: POSTRECV - POST THE CPIC RECEIVE OPERATION                09680000
*                                                                       09690000
*      ENTRY: RCV62ENT = WORK UNIT TOKEN                                09700000
*             RCV62EPB = EPB ADDRESS                                    09710000
*            +DISP LOCK IS HELD AND WORK UNIT WAS VERIFIED              09720000
*                                                                       09730000
*       EXIT: R15      = RETURN CODE FROM L62POST                       09740000
*---------------------------------------------------------------------- 09750000
                                                                        09760000
POSTRECV DS     0H                                                      09770000
                                                                        09780000
         STM   R14,R12,SUB0SAVE                                         09790000
                                                                        09800000
         L62POST *RCV62EPB,         ADDRESS OF EPB TO POST             +09810000
               #RETCODE,            ADDRESS OF POST CODE               +09820000
               RCV62ENT,            ADDRESS OF ENTITY TOKEN            +09830000
               L62RETCD,            ADDRESS OF RETURN CODE AREA        +09840000
               MF=(E,L62MFL)                                            09850000
                                                                        09860000
         LM    R14,R12,SUB0SAVE                                         09870000
         L     R15,L62RETCD                                             09880000
         BR    R14                                                      09890000
                                                                        09900000
*---------------------------------------------------------------------- 09910000
* SUBROUTINE: SPLDQ                                                     09920000
*      ENTRY: R1 = ADDRESS OF SPLIST TO BE DEQUEUED                     09930000
*       EXIT: ALL REGISTERS ARE RESTORED                                09940000
*---------------------------------------------------------------------- 09950000
                                                                        09960000
SPLDQ    DS     0H                                                      09970000
                                                                        09980000
         STM   R14,R1,SUB0SAVE                                          09990000
                                                                        10000000
         LM    R14,R15,SPL62RBN-SPLIST(R1) R14=NEXT BFR R15=PREV BFR    10010000
         ST    R15,SPL62RBP-SPLIST(,R14)   LINK PREV TO NEXT            10020000
         ST    R14,SPL62RBN-SPLIST(,R15)   LINK NEXT TO PREV            10030000
                                                                        10040000
         LA    R15,=CL12'SPLIST DEQ''D'                                 10050000
         ST    R15,DESC@                                                10060000
         MVI   DESCLEN+(L'DESCLEN-1),12                                 10070000
         SR    R15,R15                                                  10080000
         ST    R15,TRACE@                                               10090000
         ST    R15,TRACELEN                                             10100000
         BAS   R14,TRACESPL                                             10110000
                                                                        10120000
         LM    R14,R1,SUB0SAVE                                          10130000
         BR    R14                                                      10140000
                                                                        10150000
*---------------------------------------------------------------------- 10160000
* SUBROUTINE: SPLFREE                                                   10170000
*      ENTRY: R1 = ADDRESS OF SPLIST TO BE RELEASED                     10180000
*       EXIT: ALL REGISTERS ARE RESTORED                                10190000
*---------------------------------------------------------------------- 10200000
                                                                        10210000
SPLFREE  DS     0H                                                      10220000
                                                                        10230000
         STM   R14,R12,SUB0SAVE                                         10240000
         LR    R3,R1                     SPLIST ADDRESS                 10250000
         ICM   R2,15,SPLAREAL-SPLIST(R3) IS THERE A DATA AREA?          10260000
         BNP   SPLFLIST                  BRANCH IF NOT                  10270000
         ICM   R2,15,SPLAREA-SPLIST(R3)  IS THERE A DATA AREA ADDRESS?  10280000
         BNP   SPLFLIST                  BRANCH IF NOT                  10290000
                                                                        10300000
         $RETSTOR (R2),                                                +10310000
               OWNER=(RITASK)                                           10320000
                                                                        10330000
SPLFLIST DS    0H                                                       10340000
                                                                        10350000
         $RETSTOR (R3),                                                +10360000
               OWNER=(RITASK)                                           10370000
                                                                        10380000
         LM    R14,R12,SUB0SAVE                                         10390000
         BR    R14                                                      10400000
                                                                        10410000
*---------------------------------------------------------------------- 10420000
* SUBROUTINE: SENDPRSP                                                  10430000
*      ENTRY: R1 = ADDRESS OF SPLIST TO BE RESPONDED TO                 10440000
*       EXIT: ALL REGISTERS ARE RESTORED                                10450000
*---------------------------------------------------------------------- 10460000
                                                                        10470000
SENDPRSP DS     0H                                                      10480000
                                                                        10490000
                                                                        10500000
         STM   R14,R12,SUB0SAVE                                         10510000
         LR    RSPLIST,R1                                               10520000
         TM    SPLRH0,RHQSRSP       WAS A RESPONSE SENT ALREADY?        10530000
         BO    SENDPRET             BRANCH IF YES                       10540000
                                                                        10550000
         $SESS $SESS_SEND_POSRESP,  SEND A RESPONSE AS NEEDED          +10560000
               SESSION=ISETK,                                          +10570000
               RH=*,                                                   +10580000
               AREA=*,              PRESERVE DATA ADDRESS              +10590000
               AREALEN=*,           PRESERVE DATA LENGTH               +10600000
               SEQNO=ISE62CBS,                                         +10610000
               CNTRL=*,                                                +10620000
               SENSE=*,                                                +10630000
               MF=(E,(RSPLIST))                                         10640000
                                                                        10650000
         LA    R1,=CL9'+RSP SENT'                                       10660000
         ST    R1,DESC@                                                 10670000
         MVI   DESCLEN+(L'DESCLEN-1),9                                  10680000
         SR    R1,R1                                                    10690000
         ST    R1,TRACE@                                                10700000
         ST    R1,TRACELEN                                              10710000
         LR    R1,RSPLIST                                               10720000
         BAS   R14,TRACESPL                                             10730000
                                                                        10740000
SENDPRET DS    0H                                                       10750000
                                                                        10760000
         LM    R14,R12,SUB0SAVE                                         10770000
         BR    R14                                                      10780000
                                                                        10790000
*---------------------------------------------------------------------- 10800000
* SUBROUTINE: SENDNRSP                                                  10810000
*      ENTRY: R1 = ADDRESS OF SPLIST TO BE RESPONDED TO                 10820000
*       EXIT: ALL REGISTERS ARE RESTORED                                10830000
*---------------------------------------------------------------------- 10840000
                                                                        10850000
SENDNRSP DS     0H                                                      10860000
                                                                        10870000
         STM   R14,R12,SUB0SAVE                                         10880000
         LR    RSPLIST,R1                                               10890000
         TM    SPLRH0,RHQSRSP       WAS A RESPONSE SENT ALREADY?        10900000
         BO    SENDNRET             BRANCH IF YES                       10910000
                                                                        10920000
         $SESS $SESS_SEND_NEGRESP,  SEND A NEGATIVE RESPONSE           +10930000
               SESSION=ISETK,                                          +10940000
               RH=*,                                                   +10950000
               AREA=*,              PRESERVE DATA ADDRESS              +10960000
               AREALEN=*,           PRESERVE DATA LENGTH               +10970000
               SEQNO=NRSPSEQ,                                          +10980000
               CNTRL=*,                                                +10990000
               SENSE=NRSPSNS,                                          +11000000
               MF=(E,(RSPLIST))                                         11010000
                                                                        11020000
         LA    R1,=CL9'-RSP SENT'                                       11030000
         ST    R1,DESC@                                                 11040000
         MVI   DESCLEN+(L'DESCLEN-1),9                                  11050000
         SR    R1,R1                                                    11060000
         ST    R1,TRACE@                                                11070000
         ST    R1,TRACELEN                                              11080000
         LR    R1,RSPLIST                                               11090000
         BAS   R14,TRACESPL                                             11100000
                                                                        11110000
SENDNRET DS     0H                                                      11120000
                                                                        11130000
         LM    R14,R12,SUB0SAVE                                         11140000
         BR    R14                                                      11150000
                                                                        11160000
*---------------------------------------------------------------------- 11170000
* SUBROUTINE: TRACESPL                                                  11180000
*      ENTRY: R1 = ADDRESS OF SPLIST TO BE TRACED                       11190000
*             DESC@ = ADDRESS OF TRACE POINT DESCRIPTION                11200000
*             DESCLEN = LENGTH OF TRACE POINT DESCRIPTION               11210000
*             TRACE@ = ADDRESS OF ADDITIONAL DATA TO BE TRACED          11220000
*             TRACELEN = LENGTH OF ADDITIONAL DATA TO BE TRACED         11230000
*---------------------------------------------------------------------- 11240000
                                                                        11250000
TRACESPL DS     0H                                                      11260000
                                                                        11270000
         STM   R14,R12,SUB1SAVE                                         11280000
         LR    RSPLIST,R1               SPLIST TO BE TRACED             11290000
         L     R2,DESC@                 TRACE POINT DESC. ADDRESS       11300000
         L     R3,TRACE@                ADDITIONAL DATA   ADDRESS       11310000
                                                                        11320000
         L62TRCS (RSPLIST),                    @ SPLIST                +11330000
               (RISESS),                       @ ISESS                 +11340000
               (R2),                           @ DESCRIPTION           +11350000
               DESCLEN,                        @ DESCRIPTION LEN       +11360000
               (R3),                           @ ADDITIONAL DATA       +11370000
               TRACELEN,                       @ ADDITIONAL DATA LEN   +11380000
               L62RETCD,                       @ RETURN CODE AREA      +11390000
               MF=(E,L62MFL)                                            11400000
                                                                        11410000
         LM    R14,R12,SUB1SAVE                                         11420000
         BR    R14                                                      11430000
                                                                        11440000
*---------------------------------------------------------------------- 11450000
*   SUBROUTINE: OBTAIN DISP GLOBAL LOCK                                 11460000
*---------------------------------------------------------------------- 11470000
                                                                        11480000
DISPLOCK DS    0H                                                       11490000
                                                                        11500000
         TM    FLAG,FLAGDLCK        WAS THE LOCK ALREADY OBTAINED?      11510000
         BOR   R14                  RETURN IF YES                       11520000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             11530000
                                                                        11540000
         $SER  OBTAIN,                                                 +11550000
               DISP                                                     11560000
                                                                        11570000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              11580000
         BNE   DISPLOEX             BRANCH IF NOT                       11590000
         OI    FLAG,FLAGDLKD        REMEMBER LOCK HELD ON ENTRY         11600000
                                                                        11610000
DISPLOEX DS    0H                                                       11620000
                                                                        11630000
         OI    FLAG,FLAGDLCK        REMEMBER LOCK IS HELD               11640000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          11650000
         BR    R14                  RETURN                              11660000
                                                                        11670000
*---------------------------------------------------------------------- 11680000
*   SUBROUTINE: RELEASE DISP GLOBAL LOCK                                11690000
*---------------------------------------------------------------------- 11700000
                                                                        11710000
DISPUNLK DS    0H                                                       11720000
                                                                        11730000
         TM    FLAG,FLAGDLCK        IS LOCK HELD?                       11740000
         BNOR  R14                  BRANCH IF NOT                       11750000
         TM    FLAG,FLAGDLKD        WAS LOCK HELD ON ENTRY?             11760000
         BOR   R14                  DON'T RELEASE IF IT WAS             11770000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             11780000
                                                                        11790000
         $SER  RELEASE,                                                +11800000
               DISP                                                     11810000
                                                                        11820000
         NI    FLAG,255-FLAGDLCK    SHOW LOCK NOT HELD                  11830000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          11840000
         BR    R14                  RETURN                              11850000
                                                                        11860000
*---------------------------------------------------------------------- 11870000
* ERROR ROUTINES                                                        11880000
*---------------------------------------------------------------------- 11890000
                                                                        11900000
ERR$LOST DS    0H                                                       11910000
                                                                        11920000
         $ABEND ABE_VTDIAG,                                            +11930000
               SCOPE=PCB,                                              +11940000
               TITLE='LU6.2 LOST'                                       11950000
                                                                        11960000
*---------------------------------------------------------------------- 11970000
*  CONSTANTS AND LITERALS                                               11980000
*---------------------------------------------------------------------- 11990000
                                                                        12000000
         LTORG ,                                                        12010000
         PRINT NOGEN                                                    12020000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                12030000
         ISTRH ,                  VTAM REQUEST HEADER                   12040000
         ISTDBIND ,               VTAM BIND IMAGE                       12050000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         12060000
         ICVT  ,                  INTEGRATOR CVT                        12070000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   12080000
         ITASK ,                  INTEGRATOR TASK BLOCK                 12090000
         IPCB ,                   INTEGRATOR PROC BLOCK                 12100000
         ISESS ,                  INTEGRATOR ISESS BLOCK                12110000
         IVUSER ,                 INTEGRATOR IVUSER BLOCK               12120000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       12130000
         EVCODES ,                INTEGRATOR EVENT CODES                12140000
         ABCODES ,                INTEGRATOR $ABEND CODES               12150000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     12160000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        12170000
         IRPL ,                   INTEGRATOR ISESS BLOCK                12180000
         IWEVTAM ,                INTEGRATOR VTAM CVT                   12190000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             12200000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             12210000
         $WULOC DSECT=YES         INTEGRATOR $WULOC SERVICES            12220000
         END   ,                                                        12230000

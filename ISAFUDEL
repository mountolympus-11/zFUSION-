ISAFUDEL TITLE '- Remove Userid from user entity structure'             00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE:  ISAFUDEL - Remove Userid from User Entity Structure         00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine will remove the specified instance of a               00080000
*    userid from the user entity structure.  If the user                00090000
*    entity token in the Iuser block is non-zero,  an                   00100000
*    Entity delete by token is performed to remove the                  00110000
*    userid entry from the entity structure.  The user                  00120000
*    Entity structure is updated under control of the                   00130000
*    dispatcher lock.                                                   00140000
*                                                                       00150000
*                                                                       00160000
* Entry:  R1 contains the address of the parameter list                 00170000
*            as follows:                                                00180000
*                                                                       00190000
*            +0 A(IUSER)     - Address of IUser block                   00200000
*                                                                       00210000
* Exit:   Upon completion of the security request,  R15 will            00220000
*         contain one of the following return codes:                    00230000
*                                                                       00240000
*             RC00 - Entity entry deleted                               00250000
*                                                                       00260000
*             RC12 - Lock obtain failed                                 00270000
*                                                                       00280000
**<DOC-OFF>*****************************************************        00290000
                                                                        00300000
****************************************************************        00310000
*                                                                       00320000
* MAINTENANCE:                                                          00330000
*                                                                       00340000
*   07/27/94  R. Colmone      Par# 133649                               00350000
*      Initial Version                                                  00360000
*                                                                       00370000
****************************************************************        00380000
                                                                        00390000
         EJECT ,                                                        00400000
         $ENTITY DSECT=YES        ENTITY SERVICE PLIST                  00410000
                                                                        00420000
         EJECT ,                                                        00430000
         EQUS  ,                  GENERAL EQUATES                       00440000
                                                                        00450000
         EJECT ,                                                        00460000
         #WORK ,                  READ/WRITE WORKAREA                   00470000
FLAGS    DS    X                  FLAGS                                 00480000
$LOCKED  EQU   X'80'                DISP LOCK ACQUIRED                  00490000
                                                                        00500000
$ENT_MFL $ENTITY MF=L             Entity Plist                          00510000
                                                                        00520000
         #ENDWORK ,               END OF WORKAREA                       00530000
                                                                        00540000
         $MSGDFT PREFIX=ICTPID,COMPID='SAF',TABLE=*#MSGS,              +00550000
               PRINT=NOGEN,MF=(E,WRK256)                                00560000
                                                                        00570000
         EJECT ,                                                        00580000
ISAFUDEL #ENTER BASE=R12,PREG=R8                                        00590000
                                                                        00600000
         USING ITASK,R10          ITASK ADDRESSABILITY                  00610000
                                                                        00620000
*---------------------------------------------------------------        00630000
*  Obtain passed parameter and check if user entity token exists        00640000
*---------------------------------------------------------------        00650000
         L     R5,0(R8)           ADDRESS OF IUSER                      00660000
         USING IUSER,R5           IUSER ADDRESSABILITY                  00670000
                                                                        00680000
         LA    R15,RC00           ASSUME NORMAL COMPLETION              00690000
         OC    USRUETKN,USRUETKN  ENTITY TOKEN AVAILABLE                00700000
         BZ    RET_EXIT           NO, RETURN                            00710000
                                                                        00720000
*---------------------------------------------------------------        00730000
*  Acquire dispatcher lock                                              00740000
*---------------------------------------------------------------        00750000
         $SER  OBTAIN,DISP        OBTAIN DISPATCHER LOCK                00760000
         B     *+4(R15)           BRANCH ON RETURN CODE                 00770000
         B     LOCK_ACQ           LOCK ACQUIRED                         00780000
         B     LOCK_OWN           LOCK ALREADY OWNED                    00790000
         B     ERR_LOCK           ERROR ACQUIRING LOCK                  00800000
                                                                        00810000
LOCK_ACQ DS    0H                                                       00820000
         OI    FLAGS,$LOCKED      DISP LOCK ACQUIRED                    00830000
                                                                        00840000
LOCK_OWN DS    0H                                                       00850000
                                                                        00860000
*---------------------------------------------------------------        00870000
*  Delete userid entity entry                                           00880000
*---------------------------------------------------------------        00890000
         $ENTITY DEL,             DEL USERID TO ENTITY                 +00900000
               ANCHOR=ICTUSERE,                                        +00910000
               TOKEN=USRUETKN,                                         +00920000
               MF=(E,$ENT_MFL)                                          00930000
                                                                        00940000
         LR    R3,R15             SAVE RETURN CODE                      00950000
         XC    USRUETKN,USRUETKN  CLEAR ENTITY TOKEN                    00960000
                                                                        00970000
*---------------------------------------------------------------        00980000
*  Release Dispatcher lock if previously acquired                       00990000
*---------------------------------------------------------------        01000000
         TM    FLAGS,$LOCKED      LOCK ACQUIRED                         01010000
         BZ    RETURN             NO, RETURN                            01020000
                                                                        01030000
         $SER  RELEASE,DISP       RELEASE DISP LOCK                     01040000
                                                                        01050000
RETURN   DS    0H                                                       01060000
         LTR   R15,R3             ENTITY SUCCESSFULL?                   01070000
         BZ    RET_EXIT           YES, RETURN                           01080000
         B     ERR_ENT            NO,  ENTITY ERROR                     01090000
                                                                        01100000
*---------------------------------------------------------------        01110000
*   ERROR ROUTINES                                                      01120000
*---------------------------------------------------------------        01130000
ERR_LOCK DS    0H                                                       01140000
         LA    R15,RC12           LOCK ERROR                            01150000
         B     RET_EXIT                                                 01160000
                                                                        01170000
ERR_ENT  DS    0H                                                       01180000
         LA    R15,RC08           ENTITY ERROR                          01190000
         B     RET_EXIT                                                 01200000
                                                                        01210000
RET_EXIT DS    0H                                                       01220000
         #EXIT ,                  RETURN                                01230000
                                                                        01240000
         EJECT ,                                                        01250000
****************************************************************        01260000
*                                                                       01270000
*  CONSTANTS, LITERALS, AND MAPPINGS                                    01280000
*                                                                       01290000
****************************************************************        01300000
                                                                        01310000
         LTORG ,                                                        01320000
                                                                        01330000
         PRINT NOGEN                                                    01340000
         ICVT  ,                                                        01350000
         ITASK ,                                                        01360000
         IPCB  ,                                                        01370000
         IUSER ,                                                        01380000
         PRINT GEN                                                      01390000
                                                                        01400000
         END   ,                                                        01410000

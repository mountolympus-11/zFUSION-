IXTGINI1 TITLE '- CONSTRUCT STORAGE MANAGEMENT SUBPOOLS'                00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE:  IXTGINI1 - Construct storage management data areas          00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine constructs the principle XTG storage                  00080000
*    management data areas.  These include the subpool table            00090000
*    made up of SL1ENTRYs, and for each 'active' subpool, a             00100000
*    partition table made up of one or more SL2ENTRYs.                  00110000
*                                                                       00120000
*    Model subpool definitions reside in this routine. They             00130000
*    are generated by the STORPROF macro which translates a             00140000
*    'storage profile' expressed as a graph of subpool size             00150000
*    boundaries into a model SL1ENTRY table.  Each subpool              00160000
*    represents a range of storage sizes bounded by EXP2(m)             00170000
*    and EXP2(n) where m < n.  SL1ENTRYs are actually                   00180000
*    generated for every EXP2(n-1) - EXP2(n) sized storage              00190000
*    extent.  When m is not equal to n-1, intermediate                  00200000
*    'inactive' subpools are defined.  Responsibility for               00210000
*    their storage size range is assigned to the next larger,           00220000
*    active subpool.                                                    00230000
*                                                                       00240000
*                                                                       00250000
* NOTES:                                                                00260000
*                                                                       00270000
*    STDENV - task or process mode                                      00280000
*    BAKR linkage                                                       00290000
*                                                                       00300000
*                                                                       00310000
* ON ENTRY:  N/A                                                        00320000
*                                                                       00330000
* ON EXIT:                                                              00340000
*                                                                       00350000
*    R15 Contains one of the following return codes                     00360000
*                                                                       00370000
*        RC00 - Successful completion                                   00380000
*                                                                       00390000
*               R1 - addr of the storage management anchor              00400000
*                    area mapped by STANCHOR                            00410000
*                                                                       00420000
**<DOC-OFF>****************************************************         00430000
                                                                        00440000
         EJECT                                                          00450000
***************************************************************         00460000
*                                                                       00470000
* MAINTENANCE:                                                          00480000
*                                                                       00490000
*    11/01/94 R. TURGEON                                                00500000
*             Initial version                                           00510000
*                                                                       00520000
***************************************************************         00530000
                                                                        00540000
         EJECT                                                          00550000
         STORLVLS ,               STORAGE MANAGEMENT CONTROL INFO       00560000
                                                                        00570000
         EJECT                                                          00580000
         EQUS ,                                                         00590000
                                                                        00600000
         EJECT                                                          00610000
IXTGINI1 #ENTER SAVE=NO,LINKAGE=BAKR                                    00620000
                                                                        00630000
         EJECT                                                          00640000
***************************************************************         00650000
*                                                                       00660000
*   Compute total size of stgmgmt subpool definition data               00670000
*   including all SL1 and SL2 entries and the storage manager           00680000
*   anchor area.  Acquire the requisite storage referred to             00690000
*   hereafter as the 'stgmgmt block'.                                   00700000
*                                                                       00710000
***************************************************************         00720000
         L     R2,SPROFILE        NUMBER OF SL1 ENTRIES                 00730000
         LR    R9,R2              TIMES THE SIZE OF EACH ENTRY          00740000
         MH    R9,=AL2(SL1ENTLN)  YIELDS THE TOTAL SL1ENTRY SIZE        00750000
                                                                        00760000
*--------------------------------------------------------------         00770000
*   SL2 ENTRY(S) REQUIRED FOR EVERY ACTIVE SUBPOOL                      00780000
*--------------------------------------------------------------         00790000
         LA    R7,SPROFILE+4      LOCATE MODEL SL1ENTRY TABLE           00800000
         USING SL1ENTRY,R7        PREPARE FOR SCAN                      00810000
                                                                        00820000
         SR    R3,R3              NUMBER OF SL2 ENTRIES                 00830000
                                                                        00840000
PARTALLY DS    0H                                                       00850000
         TM    SL1ATTRS,SL1A_INACTIVE   ACTIVE SUBPOOL?                 00860000
         BO    *+8                NO PARTITIONS OTHERWISE               00870000
         AH    R3,SL1PARTS        ACCUMULATE TOTAL NUMBER OF PARTITIONS 00880000
         LA    R7,SL1ENTRY+SL1ENTLN                                     00890000
         BCT   R2,PARTALLY        NUMBER OF SL2ENTRYS                   00900000
                                                                        00910000
         MH    R3,=AL2(SL2ENTLN)  TOTAL SIZE OF PARTITION TABLES        00920000
         AR    R9,R3              AGGREGATE STORAGE REQUIREMENT         00930000
                                                                        00940000
*--------------------------------------------------------------         00950000
*   OBTAIN STORAGE FOR SL1 AND SL2 ENTRIES, AND STGMGMT ANCHOR          00960000
*--------------------------------------------------------------         00970000
         LA    R9,STANCHLN(,R9)   TOTAL STORAGE REQUIREMENT             00980000
                                                                        00990000
         STORAGE OBTAIN,LENGTH=(R9),LOC=ANY                             01000000
                                                                        01010000
         LR    R8,R1              BLOCK BEGINS WITH STGMGMT ANCHOR AREA 01020000
         USING STANCHOR,R8        LIFE OF FUNCTION ADDRESSABILITY       01030000
         LR    R14,R8             STGMGMT BLOCK ORIGIN                  01040000
         LR    R15,R9             STGMGMT BLOCK LENGTH                  01050000
         SR    R1,R1              PREPARE FOR CLEAR                     01060000
         MVCL  R14,R0             CLEAR                                 01070000
                                                                        01080000
         ST    R9,STAWASIZ        RETAIN GOTTEN STORAGE LENGTH          01090000
         MVC   STACBID,=CL8'STGMGMT'                                    01100000
                                                                        01110000
         EJECT                                                          01120000
***************************************************************         01130000
*                                                                       01140000
*   Load the model SL1ENTRY table into the stgmgmt block.               01150000
*   The last SL1ENTRY will be used to track storage requests            01160000
*   against subpools larger than those defined in the storage           01170000
*   profile.                                                            01180000
*                                                                       01190000
***************************************************************         01200000
         LA    R7,STANCHOR+STANCHLN                                     01210000
         USING SL1ENTRY,R7        LOCATE ORIGIN OF SL1ENTRY TABLE       01220000
         ST    R7,STALVL1         SAVE POINTER IN ANCHOR AREA           01230000
                                                                        01240000
         L     R15,SPROFILE       NUMBER OF SL1 ENTRIES                 01250000
         MH    R15,=AL2(SL1ENTLN) SIZE OF MODEL TABLE                   01260000
         LA    R14,SPROFILE+4     ORIGIN OF MODEL TABLE                 01270000
         LR    R0,R7              DESTINATION IN STGMGMT BLOCK          01280000
         LR    R1,R15             SOURCE LENGTH = DEST LENGTH           01290000
         MVCL  R0,R14             ACQUIRE MODIFIABLE COPY               01300000
                                                                        01310000
         L     R2,SPROFILE        NUMBER OF SL1 ENTRIES                 01320000
         STH   R2,STAHIEXP        DOUBLES AS LOG2 N OF LAST ENTRY       01330000
         BCTR  R2,0               CONVERT COUNT TO INDEX                01340000
         MH    R2,=AL2(SL1ENTLN)  DISPLACEMENT TO LAST (SPILL) ENTRY    01350000
         AR    R2,R7              CONVERT OFFSET TO ADDRESS             01360000
         ST    R2,STAHILV1        QUICK LOOKUP FOR UNMANAGED EXTENTS    01370000
                                                                        01380000
         LA    R6,SL1ENTLN(,R2)   AVAILABLE AREA IN STGMGMT BLOCK       01390000
         USING SL2ENTRY,R6        SL2ENTRY POOL                         01400000
                                                                        01410000
         EJECT                                                          01420000
***************************************************************         01430000
*                                                                       01440000
*   Now, run the SL1ENTRY table converting the subpool linkages         01450000
*   in the inactive subpools to point directly to the owning            01460000
*   (active) subpool. SL2ENTRYs are also assigned during this           01470000
*   pass.  All active subpools are represented by a single              01480000
*   SL1ENTRY and are associated with a partition table having           01490000
*   at least one SL2ENTRY.                                              01500000
*                                                                       01510000
***************************************************************         01520000
         L     R5,SPROFILE        NUMBER OF SL1 ENTRIES                 01530000
                                                                        01540000
LINKACT  DS    0H                                                       01550000
         ICM   R3,15,SL1LVL2      INACTIVE SUBPOOL MAPPED TO ACTIVE?    01560000
         BZ    LINKLVL2           SKIP IF THIS SUBPOOL IS ACTIVE        01570000
         BCTR  R3,0               CONVERT ACTIVE ENTRY NUMBER TO INDEX  01580000
         MH    R3,=AL2(SL1ENTLN)  OFFSET TO ACTIVE (OWNER) SUBPOOL      01590000
         A     R3,STALVL1         CHANGE OFFSET TO ADDRESS              01600000
         ST    R3,SL1LVL2         REPLACE ENTRY NUMBER WITH POINTER     01610000
         B     LINKADV            INACTIVE SUBPOOLS ARE NOT PARTITIONED 01620000
                                                                        01630000
*--------------------------------------------------------------         01640000
*   ALLOCATE PARTITION TABLE (SL2ENTRYS) FOR SUBPOOL (SL1ENTRY)         01650000
*--------------------------------------------------------------         01660000
LINKLVL2 DS    0H                                                       01670000
         ST    R6,SL1LVL2         ATTACH PARTITION TABLE TO SUBPOOL     01680000
         SR    R3,R3              PREPARE FOR INSERT                    01690000
         ICM   R3,3,SL1MIN        LOW SIZE BOUND OF SUBPOOL             01700000
         SR    R4,R4              PREPARE FOR INSERT                    01710000
         ICM   R4,3,SL1PSIZE      SIZE OF EACH PARTITION                01720000
         LH    R2,SL1PARTS        NUMBER OF PARTITIONS                  01730000
                                                                        01740000
DEFPARTS DS    0H                 FORMAT PARTITION ENTRIES              01750000
         AR    R3,R4              CEILING SIZE OF CURRENT PARTITION     01760000
         STH   R3,SL2MAX          POST FOR REPORTING PURPOSES, ETC.     01770000
         LA    R6,SL2ENTRY+SL2ENTLN                                     01780000
         BCT   R2,DEFPARTS        FORMAT ALL PARTITION ENTRIES          01790000
                                                                        01800000
*--------------------------------------------------------------         01810000
*   PROCESS ALL SUBPOOLS                                                01820000
*--------------------------------------------------------------         01830000
LINKADV  DS    0H                                                       01840000
         LA    R7,SL1ENTRY+SL1ENTLN   ADVANCE TO NEXT SUBPOOL ENTRY     01850000
         BCT   R5,LINKACT         PROCESS ENTIRE SL1ENTRY TABLE & SPILL 01860000
                                                                        01870000
         EJECT                                                          01880000
***************************************************************         01890000
*                                                                       01900000
*   RETURN STORAGE MANAGEMENT ANCHOR AREA TO CALLER                     01910000
*                                                                       01920000
***************************************************************         01930000
         LA    R15,RC00           SUCCESS                               01940000
         LA    R1,STANCHOR        R1 <== STORAGE MANAGEMENT ANCHOR      01950000
                                                                        01960000
         #EXIT  ,                 RETURN                                01970000
                                                                        01980000
         EJECT                                                          01990000
***************************************************************         02000000
*                                                                       02010000
*   STORAGE PROFILE / SUBPOOL & PARTITION DEFINITIONS                   02020000
*                                                                       02030000
***************************************************************         02040000
SPROFILE STORPROF 64,(2),128,(2),256,(4),512,(4),1024,(8),             X02050000
               2048,(8),4096,(16),8192,16384,32768,                    X02060000
               CELLIGIBLE=(0,4096)                                      02070000
                                                                        02080000
         EJECT                                                          02090000
***************************************************************         02100000
*                                                                       02110000
*   LOCAL READ ONLY WORKING STORAGE                                     02120000
*                                                                       02130000
***************************************************************         02140000
         LTORG ,                                                        02150000
                                                                        02160000
         PRINT NOGEN                                                    02170000
         ICVT  ,                                                        02180000
         END   ,                                                        02190000

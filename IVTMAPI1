IVTMAPI1 TITLE 'INTEGRATOR - VTAM SERVICES API (PART 1)'                00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: IVTMAPI1 - INTEGRATOR VTAM SERVICES API (PART 1)             00100000
*                                                                       00110000
* DESCRIPTION:                                                          00120000
*                                                                       00130000
*                                                                       00140000
*                                                                       00150000
*                                                                       00160000
*                                                                       00170000
* ON ENTRY:                                                             00180000
*                                                                       00190000
*    R15 = ENTRY POINT ADDRESS                                          00200000
*    R14 = RETURN ADDRESS                                               00210000
*    R13 = AVAILABLE SAVE AREA                                          00220000
*    R11 = ICVT ADDRESS                                                 00230000
*    R10 = ITASK ADDRESS                                                00240000
*    R09 = IVTAMCVT ADDRESS                                             00250000
*    R01 = $VTAM PARAMETER LIST ADDRESS                                 00260000
*          (SEE COMMENTS FOR SPECIFIC SERVICE BEING CALLED)             00270000
*                                                                       00280000
* ON EXIT:                                                              00290000
*                                                                       00300000
*    R15 = SEE COMMENTS FOR SPECIFIC SERVICE BEING CALLED               00310000
*    R00 = SEE COMMENTS FOR SPECIFIC SERVICE BEING CALLED               00320000
*    R01 = SEE COMMENTS FOR SPECIFIC SERVICE BEING CALLED               00330000
*                                                                       00340000
*    ALL OTHER REGISTERS ARE RESTORED                                   00350000
*                                                                       00360000
**<DOC-OFF>************************************************************ 00370000
                                                                        00380000
         EJECT ,                                                        00390000
*********************************************************************** 00400000
*                                                                       00410000
* MAINTENANCE:                                                          00420000
*                                                                       00430000
*   08/01/93 RANDY WITEK                                                00440000
*   07/01/94 RANDY WITEK - LU6.2 SUPPORT                                00450000
*   01/23/96 RANDY WITEK - ALLOW STARTUP WITHOUT MAIN ACB               00460000
*                                                                       00470000
*********************************************************************** 00480000
                                                                        00490000
         EQUS  ,                  GENERAL EQUATES                       00500000
                                                                        00510000
RICVT    EQU   R11                                                      00520000
RITASK   EQU   R10                                                      00530000
RIVTAM   EQU   R9                                                       00540000
RIACB    EQU   R8                                                       00550000
RIRPL    EQU   R7                                                       00560000
RINIB    EQU   R6                                                       00570000
                                                                        00580000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00590000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00600000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00610000
         USING IACB,RIACB         ESTABLISH ADDRESSABILITY              00620000
         USING IRPL,RIRPL         ESTABLISH ADDRESSABILITY              00630000
         USING ISTDNIB,RINIB      ESTABLISH ADDRESSABILITY              00640000
                                                                        00650000
*---------------------------------------------------------------------- 00660000
*   S A V E   A N D   W O R K I N G   S T O R A G E                     00670000
*---------------------------------------------------------------------- 00680000
                                                                        00690000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00700000
WRK256   DS    XL256              GENERAL WORKAREA                      00710000
CONVERSN DS    XL512              HEX TO CHAR CONVERSION AREA           00720000
LV0SAVE  DS    18F                SUBROUTINE SAVE AREA                  00730000
$TASKMFL $TASK MF=L               $TASK PLIST CONSTRUCTION              00740000
$VTAMCPY $VTAM MF=L               $VTAM PLIST COPY AREA                 00750000
RETR15   DS    F                  RETURN CODE                           00760000
RETR0    DS    F                  RETURN REGISTER 0                     00770000
RETR1    DS    F                  RETURN REGISTER 1                     00780000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00790000
NETAPPL  DS    CL8                NETWORK-APPL NAME                     00800000
NETID    DS    CL8                NETWORK-ID   NAME                     00810000
FLAG     DS    X                                                        00820000
FLAGLOCK EQU   X'80'              VTAM GLOBAL LOCK HELD                 00830000
FLAGLCKD EQU   X'40'              VTAM GLOBAL LOCK HELD ON ENTRY        00840000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00850000
                                                                        00860000
*---------------------------------------------------------------------- 00870000
*   M E S S A G E   D E F A U L T S                                     00880000
*---------------------------------------------------------------------- 00890000
                                                                        00900000
         $MSGDFT PREFIX=ICTPID,COMPID='VTM',TABLE=*#MSGS,              +00910000
               PRINT=NOGEN,WORKA=0,MF=(E,WRK256)                        00920000
                                                                        00930000
*---------------------------------------------------------------------- 00940000
*   M O D U L E   E N T R Y                                             00950000
*---------------------------------------------------------------------- 00960000
                                                                        00970000
IVTMAPI1 #ENTER BASE=R12,         R12 IS BASE REGISTER                 +00980000
               AMODE=31,                                               +00990000
               RMODE=ANY,                                              +01000000
               SAVE=YES,          ALLOCATE SAVE/WORK AREA              +01010000
               PREG=R2,           SAVE R1 PARM IN R2                   +01020000
               RESTENV=NO,        ICVT AND ITASK POINTERS ARE OK       +01030000
               WAPASS=NO,         NO WORK AREA PASSED IN R0            +01040000
               LINKAGE=STD        CALLED BY BAS/BASR                    01050000
                                                                        01060000
         L     RIVTAM,ICTVTCVT    SET IVTAMCVT BASE                     01070000
                                                                        01080000
*---------------------------------------------------------------------- 01090000
* SET BLOCK ID                                                          01100000
*---------------------------------------------------------------------- 01110000
                                                                        01120000
         MVC   VPLID-VPLIST(4,R2),=CL4'VPL '                            01130000
                                                                        01140000
*---------------------------------------------------------------------- 01150000
* COPY PARM LIST TO WORKING STORAGE                                     01160000
*---------------------------------------------------------------------- 01170000
                                                                        01180000
         MVC   $VTAMCPY(L'VPL),0(R2) COPY PARM LIST TO WORKING AREA     01190000
         USING VPLIST,$VTAMCPY                                          01200000
                                                                        01210000
*---------------------------------------------------------------------- 01220000
* TRACE THE MODULE ENTRY                                                01230000
*---------------------------------------------------------------------- 01240000
                                                                        01250000
         $TRACE *=A(TRC_IVTMAPIX_ENTER),48 TRACE ENTRY W/ 48 USER BYTES 01260000
         BNZ   NOETRACE                    BRANCH IF NOT TRACING        01270000
         $APITRC IVTMAPI1                  TRACE COMMON STUFF           01280000
         MVC   24(4,R1),VPLFUNC            TRACE FUNC & FLAGS           01290000
         L     R14,4(,R13)                 CALLER'S SAVE AREA           01300000
         MVC   28(4,R1),24(R14)            TRACE VPLIST ADDRESS         01310000
         MVC   32(4,R1),VPLTASK            TRACE PROVIDED ITASK ADDRESS 01320000
         MVC   36(4,R1),VPLAREA            TRACE PROVIDED AREA  ADDRESS 01330000
NOETRACE DS    0H                                                       01340000
                                                                        01350000
*---------------------------------------------------------------------- 01360000
* JUMP TO PROCESSING ROUTINE BASED ON REQUEST CODE                      01370000
*---------------------------------------------------------------------- 01380000
                                                                        01390000
         SR    R1,R1              CLEAR                                 01400000
         ICM   R1,B'0011',VPLFUNC LOAD REQUEST CODE                     01410000
         SLL   R1,2               MULTIPLY BY 4                         01420000
         C     R1,=A(MAXFUNC)     IS REQUEST CODE VALID?                01430000
         BNH   REQTABLE(R1)       BRANCH TO ROUTINE IF VALID            01440000
         MVC   RETR15,=F'-1'      SET RC=-1                             01450000
         B     RETURN             EXIT TO CALLER                        01460000
                                                                        01470000
REQTABLE B     GETACB           0 CREATE IACB                           01480000
         B     GETRPL           1 CREATE IRPL                           01490000
         B     GETNIB           2 CREATE INIB                           01500000
         B     RETACB           3 RELEASE IACB                          01510000
         B     RETRPL           4 RELEASE IRPL                          01520000
         B     RETNIB           5 RELEASE INIB                          01530000
         B     OPENACB          6 OPEN A VTAM IACB                      01540000
         B     DUMPRPL          7 DISPLAY AN IRPL                       01550000
MAXFUNC  EQU   (*-REQTABLE)-4                                           01560000
                                                                        01570000
*---------------------------------------------------------------------- 01580000
* REQUEST 00 - CREATE IACB                                              01590000
*                                                                       01600000
* ENTRY  VALUES: R01 = ADDRESS OF $VTAM SERVICES PARAMETER LIST         01610000
*                VPLFUNC  = 0                                           01620000
*                VPLTASK  = 0 --> CURRENT ITASK IS STORAGE OWNER        01630000
*                        != 0 --> ITASK TO ASSIGN AS STORAGE OWNER      01640000
*                VPLAREA  =   --> ADDRESS OF NAME FOR IACB              01650000
*                VPLAREAL = 0 --> IACB IS NOT ASSIGNED TO AN IPOOL      01660000
*                        != 0 --> ADDRESS OF NAME FOR OWNING IPOOL      01670000
*                                                                       01680000
* RETURN VALUES: R15 = 0 --> REQUEST COMPLETE                           01690000
*                      4 --> INVALID IPOOL NAME                         01700000
*                      8 --> INVALID IACB NAME (BLANK OR DUPLICATE)     01710000
*                R00 = 0                                                01720000
*                R01 = ADDRESS OF IACB                                  01730000
*                                                                       01740000
*---------------------------------------------------------------------- 01750000
                                                                        01760000
GETACB   DS    0H                                                       01770000
                                                                        01780000
*                                                                       01790000
* OBTAIN VTAM GLOBAL SERIALIZATION                                      01800000
*---------------------------------------------------------------------- 01810000
                                                                        01820000
         BAS   R14,VTAMLOCK       OBTAIN VTAM GLOBAL SERIALIZATION      01830000
                                                                        01840000
*                                                                       01850000
* ALLOCATE THE IACB                                                     01860000
*---------------------------------------------------------------------- 01870000
         LA    R1,IVT_IACB        LENGTH AND ADDRESS OF MODEL           01880000
         BAS   R14,GETCOPY        GO TO COMMON COPY ROUTINE             01890000
         LR    RIACB,R1           ADDRESS OF THE NEW IACB               01900000
                                                                        01910000
*                                                                       01920000
* INITIALIZE ACB NAME AND CHAIN HEADER(S)                               01930000
*---------------------------------------------------------------------- 01940000
         L     R1,VPLAREA         ADDRESS OF THE IACB NAME              01950000
         LA    R1,7(,R1)          ADDRESS OF LAST CHARACTER IN NAME     01960000
         LA    R2,8               MAXIMUM LENGTH OF THE NAME            01970000
                                                                        01980000
GETANMSZ DS    0H                                                       01990000
                                                                        02000000
         CLI   0(R1),C' '         IS LAST CHARACTER A BLANK?            02010000
         BNE   GETASTSZ           BRANCH IF NOT TO SET NAME & SIZE      02020000
         BCTR  R1,0               BACK UP ONE CHARACTER IN NAME         02030000
         BCT   R2,GETANMSZ        FIND NUMBER OF SIGNIFICANT CHARACTERS 02040000
         MVI   RETR15+(L'RETR15-1),8 RC=8 (INVALID IACB NAME)           02050000
         B     GETAFREE           FREE IACB, UNLOCK, AND EXIT           02060000
                                                                        02070000
GETASTSZ DS    0H                                                       02080000
                                                                        02090000
         STC   R2,IACNMLEN        SET THE IACB NAME LENGTH              02100000
         L     R1,VPLAREA         ADDRESS OF NAME                       02110000
         MVC   IACNAME(8),0(R1)   SET THE IACB NAME                     02120000
         LA    R1,IACACBNM        ADDR OF LENGTH/NAME THAT VTAM LIKES   02130000
         ST    R1,ACBAPID         SET THE LENGTH/NAME POINTER FOR VTAM  02140000
                                                                        02150000
         LA    R1,IACIS1ST        HEADER TO ALL ISESS'S FOR IACB        02160000
         S     R1,=A(ISEISNXT-ISE)                                      02170000
         O     R1,=X'80000000'    SET HI BIT ON                         02180000
         ST    R1,IACIS1ST        INITIALIZE POINTERS                   02190000
         ST    R1,IACISLST        INITIALIZE POINTERS                   02200000
                                                                        02210000
         LA    R1,IACPL1ST        HEADER TO PARTNER_LU BLOCKS           02220000
         S     R1,=A(IVUPLNXT-IVU)                                      02230000
         O     R1,=X'80000000'    SET HI BIT ON                         02240000
         ST    R1,IACPL1ST        INITIALIZE POINTERS                   02250000
         ST    R1,IACPLLST        INITIALIZE POINTERS                   02260000
                                                                        02270000
*                                                                       02280000
* LOCATE THE SPECIFIED IPOOL CONTROL BLOCK                              02290000
*---------------------------------------------------------------------- 02300000
                                                                        02310000
         SR    R5,R5              SHOW NO IPOOL                         02320000
         ICM   R4,15,VPLAREAL     ADDRESS OF IPOOL NAME                 02330000
         BZ    GETAGTPO           BRANCH IF NOT ASSOCIATED W/IPOOL      02340000
         LA    R5,IVTIP1ST-(IPONEXT-IPO) ADDRESS OF CHAIN HEADER        02350000
                                                                        02360000
         PUSH  USING                                                    02370000
         USING IPOOL,R5                                                 02380000
                                                                        02390000
GETAFIPO DS    0H                                                       02400000
                                                                        02410000
         ICM   R5,15,IPONEXT      NEXT IPOOL IN THE CHAIN               02420000
         BM    GETANOPO           BRANCH IF SPECIFIED IPOOL NOT FOUND   02430000
         CLC   0(L'IPONAME,R4),IPONAME COMPARE THE NAMES                02440000
         BH    GETAFIPO           FIND THE SPECIFIED IPOOL              02450000
         BE    GETAGTPO           BRANCH IF IPOOL WAS FOUND             02460000
                                                                        02470000
GETANOPO DS    0H                                                       02480000
                                                                        02490000
         MVI   RETR15+(L'RETR15-1),4 RC=4                               02500000
         B     GETAFREE           RELEASE IACB, UNLOCK, AND EXIT        02510000
                                                                        02520000
*                                                                       02530000
* LOCATE PROPER IACB POSITION IN GLOBAL CHAIN OF ALL IACB'S             02540000
*---------------------------------------------------------------------- 02550000
                                                                        02560000
GETAGTPO DS    0H                                                       02570000
                                                                        02580000
         LA    R14,IVTIA1ST                ADDRESS OF IACB CHAIN HEAD   02590000
         S     R14,=A(IACNEXT-IAC)         NORMALIZE FOR CHAIN RUN      02600000
                                                                        02610000
GETARNCH DS    0H                                                       02620000
                                                                        02630000
         ICM   R14,15,IACNEXT-IAC(R14)     LINK TO NEXT IACB            02640000
         BM    GETAINSR                    NEW IACB IS LAST IN CHAIN    02650000
         CLC   IACNAME(8),IACNAME-IAC(R14) COMPARE THE NAMES            02660000
         BH    GETARNCH                    CONTINUE IF NEW NAME IS HI   02670000
         BNE   GETAINSR                    INSERT IF NAME IS NOT DUP    02680000
         MVI   RETR15+(L'RETR15-1),8       SET RC=8 (INVALID IACB NAME) 02690000
         B     GETAFREE                    RELEASE, UNLOCK, AND EXIT    02700000
                                                                        02710000
GETAINSR DS    0H                                                       02720000
                                                                        02730000
         L     R15,IACPREV-IAC(,R14)       LINK TO PREVIOUS IACB        02740000
         ST    RIACB,IACNEXT-IAC(,R15)     LINK NEW IACB TO PREVIOUS    02750000
         ST    RIACB,IACPREV-IAC(,R14)     LINK NEW IACB TO NEXT        02760000
         STM   R14,R15,IACNEXT             SET NEXT/PREV IN NEW IACB    02770000
                                                                        02780000
*                                                                       02790000
* LOCATE PROPER IACB POSITION IN IPOOL CHAIN OF IPOOL IACB'S            02800000
*---------------------------------------------------------------------- 02810000
                                                                        02820000
         LTR   R5,R5                IS IACB ASSOCIATED WITH AN IPOOL?   02830000
         BZ    GETANOPL             BRANCH IF NOT                       02840000
         LA    R14,IPOIA1ST         ADDRESS OF IACB LIST                02850000
         S     R14,=A(IACIANXT-IAC) NORMALIZE FOR CHAIN RUN             02860000
                                                                        02870000
GETARNPL DS    0H                                                       02880000
                                                                        02890000
         ICM   R14,15,IACIANXT-IAC(R14)    LINK TO NEXT IACB            02900000
         BM    GETAINPL                    NEW IACB IS LAST IN CHAIN    02910000
         CLC   IACNAME(8),IACNAME-IAC(R14) COMPARE THE NAMES            02920000
         BH    GETARNPL                    CONTINUE IF NEW NAME IS HI   02930000
         BNE   GETAINPL                    INSERT IF NAME IS NOT DUP    02940000
                                                                        02950000
         BAS   R14,VTAMUNLK       RELEASE VTAM GLOBAL SERIALIZATION     02960000
                                                                        02970000
         B     ERR$VTAM           IACB SHOULDN'T BE THERE               02980000
                                                                        02990000
GETAINPL DS    0H                                                       03000000
                                                                        03010000
         L     R15,IACIAPRV-IAC(,R14)   ADDRESS OF PREVIOUS IACB        03020000
         ST    RIACB,IACIANXT-IAC(,R15) LINK NEW IACB TO PREVIOUS       03030000
         ST    RIACB,IACIAPRV-IAC(,R14) LINK NEW IACB TO NEXT           03040000
         STM   R14,R15,IACIANXT         SET NEXT/PREV LINKS IN NEW IACB 03050000
         L     R1,IPO#ACB               CURRENT ACB COUNT               03060000
         A     R1,=F'1'                 PLUS ONE                        03070000
         ST    R1,IPO#ACB               SAVE UPDATED COUNT              03080000
         B     GETADONE                 UNLOCK AND EXIT                 03090000
                                                                        03100000
GETANOPL DS    0H                                                       03110000
                                                                        03120000
         LR    R14,RIACB                LINK ACB TO ITSELF              03130000
         O     R14,=X'80000000'         INDICATE NULL LINK              03140000
         ST    R14,IACIANXT             SET NEXT/PREV LINKS IN NEW IACB 03150000
         ST    R14,IACIAPRV             SET NEXT/PREV LINKS IN NEW IACB 03160000
         B     GETADONE                 UNLOCK AND EXIT                 03170000
                                                                        03180000
*                                                                       03190000
* FREE THE IACB DUE TO ERROR                                            03200000
*---------------------------------------------------------------------- 03210000
                                                                        03220000
GETAFREE DS    0H                                                       03230000
                                                                        03240000
         LR    R1,RIACB           GET SET TO RELEASE NEW IACB           03250000
         BAS   R14,RETCOPY        FREE THE IACB                         03260000
         XC    RETR1,RETR1        DON'T RETURN THE IACB POINTER         03270000
                                                                        03280000
*                                                                       03290000
* DESERIALIZE AND EXIT                                                  03300000
*---------------------------------------------------------------------- 03310000
                                                                        03320000
GETADONE DS    0H                                                       03330000
                                                                        03340000
         BAS   R14,VTAMUNLK       RELEASE VTAM GLOBAL SERIALIZATION     03350000
                                                                        03360000
         B     RETURN                                                   03370000
                                                                        03380000
         POP   USING                                                    03390000
                                                                        03400000
*---------------------------------------------------------------------- 03410000
* REQUEST 01 - CREATE IRPL                                              03420000
*                                                                       03430000
* ENTRY  VALUES: R01 = ADDRESS OF $VTAM SERVICES PARAMETER LIST         03440000
*                VPLFUNC  = 1                                           03450000
*                VPLTASK  = 0 --> CURRENT ITASK IS STORAGE OWNER        03460000
*                        != 0 --> ITASK TO ASSIGN AS STORAGE OWNER      03470000
*                                                                       03480000
* RETURN VALUES: R15 = 0 --> REQUEST COMPLETE                           03490000
*                R00 = 0                                                03500000
*                R01 = ADDRESS OF IRPL                                  03510000
*                                                                       03520000
*---------------------------------------------------------------------- 03530000
                                                                        03540000
GETRPL   DS    0H                                                       03550000
                                                                        03560000
         LA    R1,IVT_IRPL        LENGTH AND ADDRESS OF MODEL           03570000
         BAS   R14,GETCOPY        GO TO COMMON COPY ROUTINE             03580000
         LR    RIRPL,R1           ADDRESS OF NEW RPL                    03590000
         ST    RITASK,IRPITASK    SET ASSOCIATED ITASK IN RPL           03600000
         MVC   IRPACCWD,VPLAREA   SET ADDR OF "ACTIVE RPL" ACCT. WORD   03610000
         B     RETURN                                                   03620000
                                                                        03630000
*---------------------------------------------------------------------- 03640000
* REQUEST 02 - CREATE INIB                                              03650000
*                                                                       03660000
* ENTRY  VALUES: R01 = ADDRESS OF $VTAM SERVICES PARAMETER LIST         03670000
*                VPLFUNC  = 1                                           03680000
*                VPLTASK  = 0 --> CURRENT ITASK IS STORAGE OWNER        03690000
*                        != 0 --> ITASK TO ASSIGN AS STORAGE OWNER      03700000
*                                                                       03710000
* RETURN VALUES: R15 = 0 --> REQUEST COMPLETE                           03720000
*                R00 = 0                                                03730000
*                R01 = ADDRESS OF INIB                                  03740000
*                                                                       03750000
*---------------------------------------------------------------------- 03760000
                                                                        03770000
GETNIB   DS    0H                                                       03780000
                                                                        03790000
         LA    R1,IVT_INIB        LENGTH AND ADDRESS OF MODEL           03800000
         BAS   R14,GETCOPY        GO TO COMMON COPY ROUTINE             03810000
         B     RETURN                                                   03820000
                                                                        03830000
*---------------------------------------------------------------------- 03840000
* REQUEST 03 - RETURN IACB                                              03850000
*                                                                       03860000
* ENTRY  VALUES: R01 = ADDRESS OF $VTAM SERVICES PARAMETER LIST         03870000
*                VPLFUNC  = 3                                           03880000
*                VPLAREA  = ADDRESS OF IACB TO BE RETURNED              03890000
*                VPLTASK  = 0 --> CURRENT ITASK IS STORAGE OWNER        03900000
*                        != 0 --> ITASK THAT OWNS STORAGE               03910000
*                                                                       03920000
* RETURN VALUES: R15 = 0 --> REQUEST COMPLETE                           03930000
*                    = 4 --> INVALID IACB ADDRESS                       03940000
*                R00 = 0                                                03950000
*                R01 = 0                                                03960000
*                                                                       03970000
*---------------------------------------------------------------------- 03980000
                                                                        03990000
RETACB   DS    0H                                                       04000000
                                                                        04010000
         ICM   RIACB,15,VPLAREA   ADDRESS OF BLOCK BEING RETURNED       04020000
         BZ    RETURN4            BRANCH IF BAD ADDRESS                 04030000
         CLC   IACID,=CL8'IACB'   IS CBID VALID?                        04040000
         BNE   RETURN4            BRANCH IF NOT                         04050000
         L     R1,VPLAREA         ADDRESS OF BLOCK TO RETURN            04060000
         BAS   R14,RETCOPY        GO TO COMMON RETURN ROUTINE           04070000
         B     RETURN                                                   04080000
                                                                        04090000
*---------------------------------------------------------------------- 04100000
* REQUEST 04 - RETURN IRPL                                              04110000
*                                                                       04120000
* ENTRY  VALUES: R01 = ADDRESS OF $VTAM SERVICES PARAMETER LIST         04130000
*                VPLFUNC  = 4                                           04140000
*                VPLAREA  = ADDRESS OF IRPL TO BE RETURNED              04150000
*                VPLTASK  = 0 --> CURRENT ITASK IS STORAGE OWNER        04160000
*                        != 0 --> ITASK THAT OWNS STORAGE               04170000
*                                                                       04180000
* RETURN VALUES: R15 = 0 --> REQUEST COMPLETE                           04190000
*                    = 4 --> INVALID IRPL ADDRESS                       04200000
*                R00 = 0                                                04210000
*                R01 = 0                                                04220000
*                                                                       04230000
*---------------------------------------------------------------------- 04240000
                                                                        04250000
RETRPL   DS    0H                                                       04260000
                                                                        04270000
         ICM   RIRPL,15,VPLAREA   ADDRESS OF BLOCK BEING RETURNED       04280000
         BZ    RETURN4            BRANCH IF BAD ADDRESS                 04290000
         CLC   IRPID,=CL8'IRPL'   IS CBID VALID?                        04300000
         BNE   RETURN4            BRANCH IF NOT                         04310000
         L     R1,VPLAREA         ADDRESS OF BLOCK TO RETURN            04320000
         BAS   R14,RETCOPY        GO TO COMMON RETURN ROUTINE           04330000
         B     RETURN                                                   04340000
                                                                        04350000
*---------------------------------------------------------------------- 04360000
* REQUEST 05 - RETURN INIB                                              04370000
*                                                                       04380000
* ENTRY  VALUES: R01 = ADDRESS OF $VTAM SERVICES PARAMETER LIST         04390000
*                VPLFUNC  = 4                                           04400000
*                VPLAREA  = ADDRESS OF INIB TO BE RETURNED              04410000
*                VPLTASK  = 0 --> CURRENT ITASK IS STORAGE OWNER        04420000
*                        != 0 --> ITASK THAT OWNS STORAGE               04430000
*                                                                       04440000
* RETURN VALUES: R15 = 0 --> REQUEST COMPLETE                           04450000
*                    = 4 --> INVALID INIB ADDRESS                       04460000
*                R00 = 0                                                04470000
*                R01 = 0                                                04480000
*                                                                       04490000
*---------------------------------------------------------------------- 04500000
                                                                        04510000
RETNIB   DS    0H                                                       04520000
                                                                        04530000
         ICM   RINIB,15,VPLAREA   ADDRESS OF BLOCK BEING RETURNED       04540000
         BZ    RETURN4            BRANCH IF BAD ADDRESS                 04550000
         CLC   INIID,=CL8'INIB'   IS CBID VALID?                        04560000
         BNE   RETURN4            BRANCH IF NOT                         04570000
         L     R1,VPLAREA         ADDRESS OF BLOCK TO RETURN            04580000
         BAS   R14,RETCOPY        GO TO COMMON RETURN ROUTINE           04590000
         B     RETURN                                                   04600000
                                                                        04610000
*---------------------------------------------------------------------- 04620000
* REQUEST 06 - OPEN ACB                                                 04630000
*                                                                       04640000
* ENTRY  VALUES: R01 = ADDRESS OF $VTAM SERVICES PARAMETER LIST         04650000
*                VPLFUNC  = 6                                           04660000
*                VPLAREA  = ADDRESS OF IACB TO BE OPENED                04670000
*                                                                       04680000
* RETURN VALUES: R15 = 0 --> REQUEST COMPLETE                           04690000
*                   != 0 --> OPEN FAILED (OPEN RETURN CODE VALUE)       04700000
*                    =-1 --> VTAM MAIN TASK TERMINATION IN PROGRESS     04710000
*                    = 1 --> VTAM DOES NOT HAVE REQUIRED SUPPORT        04720000
*                R00 = 0                                                04730000
*                R01 = 0                                                04740000
*                                                                       04750000
*---------------------------------------------------------------------- 04760000
                                                                        04770000
OPENACB  DS    0H                                                       04780000
                                                                        04790000
         L     RIACB,VPLAREA      ACB ADDRESS PASSED IN PLIST           04800000
                                                                        04810000
         TM    IACF1,IACF1OPN     IS ACB ALREADY OPEN?                  04820000
         BO    RETURN             BRANCH IF YES                         04830000
                                                                        04840000
         C     RITASK,IVTITASK    EXECUTING IN VTAM MAIN TASK?          04850000
         BE    OPENMAIN           BRANCH IF YES                         04860000
                                                                        04870000
*                                                                       04880000
* OPEN NOT ISSUED IN MAIN TASK.  ALLOCATE OPEN WORK ELEMENT             04890000
*---------------------------------------------------------------------- 04900000
                                                                        04910000
         $VTAMWE L'IWEXB,         SIZE                                 +04920000
               IWECOPEN           CODE                                  04930000
                                                                        04940000
         LR    R4,R1                                                    04950000
                                                                        04960000
         USING IWEVTAM,R4                                               04970000
                                                                        04980000
*                                                                       04990000
* OPEN NOT ISSUED IN MAIN TASK.  ALLOCATE XEPB                          05000000
*---------------------------------------------------------------------- 05010000
                                                                        05020000
         $TASK SETEPB,            INITIALIZE EPB TO WAIT FOR OPEN      +05030000
               ECODE=EC$VTOP,     OPEN ACB EVENT                       +05040000
               MF=(E,$TASKMFL)                                          05050000
                                                                        05060000
         LR    R3,R1              SAVE XEPB ADDRESS                     05070000
         ST    R3,IWEXBEPB        SET XEPB ADDRESS IN WORK ELEMENT      05080000
         MVC   IWEXBACB,VPLAREA   SET ACB ADDRESS IN WORK ELEMENT       05090000
                                                                        05100000
*                                                                       05110000
* OPEN NOT ISSUED IN MAIN TASK.  QUEUE WORK ELEMENT TO MAIN TASK        05120000
*---------------------------------------------------------------------- 05130000
                                                                        05140000
         LR    R1,R4              PASS WORK ELEMENT IN R1               05150000
         BAS   R14,QTOMAIN        GO QUEUE THE WORK ELEMENT             05160000
                                                                        05170000
*                                                                       05180000
* OPEN NOT ISSUED IN MAIN TASK.  WAIT FOR MAIN TO PERFORM OPEN          05190000
*---------------------------------------------------------------------- 05200000
                                                                        05210000
         $TASK WAIT,              WAIT FOR MAIN TO COMPLETE OPEN ACB   +05220000
               EPB=(R3),                                               +05230000
               MF=(E,$TASKMFL)                                          05240000
                                                                        05250000
         ST    R0,RETR15          POST CODE IN R0 IS OPEN RETURN CODE   05260000
         B     RETURN             RETURN TO ISSUER OF $VTAM OPENACB     05270000
                                                                        05280000
         DROP  R4                                                       05290000
                                                                        05300000
*                                                                       05310000
* PROCESS OPEN ACB IN MAIN TASK.                                        05320000
*---------------------------------------------------------------------- 05330000
                                                                        05340000
OPENMAIN DS    0H                                                       05350000
                                                                        05360000
         TM    ICTSTAT3,ICT3$P+ICT3$PX TERMINATION REQUESTED?           05370000
         BNZ   DONTOPEN           BRANCH IF YES                         05380000
         TM    IVTF1,IVTF1TRM     IS TERMINATION UNDERWAY?              05390000
         BNO   OPENIT             BRANCH IF NOT                         05400000
                                                                        05410000
DONTOPEN DS    0H                                                       05420000
                                                                        05430000
         MVC   RETR15,=F'-1'      SET SPECIAL RETURN CODE               05440000
         B     OPENSKIP           AND COMPLETE THE REQUEST              05450000
                                                                        05460000
OPENIT   DS    0H                                                       05470000
                                                                        05480000
         XC    MFE_LIST(8),MFE_LIST CLEAR OPEN LIST                     05490000
         MVI   MFE_LIST,X'80'     SET FLAG FOR LAST ENTRY               05500000
         SR    R15,R15            CLEAR RETURN REGISTER                 05510000
                                                                        05520000
         OPEN  ((RIACB)),                                              +05530000
               MF=(E,MFE_LIST),                                        +05540000
               MODE=31            ISSUE OS OPEN                         05550000
                                                                        05560000
         ST    R15,RETR15         SAVE RETURN CODE                      05570000
                                                                        05580000
OPENSKIP DS    0H                                                       05590000
                                                                        05600000
         $TRACE *=A(TRC_OPENACB),32 TRACE ENTRY W/32 USER BYTES         05610000
                                                                        05620000
         BNZ   NOOTRACE           BRANCH IF TRACING NOT AVAILABLE       05630000
                                                                        05640000
         ST    RIACB,0(R1)        TRACE IACB ADDRESS                    05650000
         MVC   4(4,R1),RETR15     TRACE OPEN RETURN CODE                05660000
         MVC   8(8,R1),IACNAME    TRACE ACBNAME                         05670000
         MVC   16(4,R1),IACF1     TRACE IACF1-IACF4                     05680000
         MVC   20(1,R1),ACBERFLG  TRACE ACBERFLG                        05690000
         MVC   21(1,R1),ACBOFLGS  TRACE ACBOFGLS                        05700000
                                                                        05710000
NOOTRACE DS    0H                                                       05720000
                                                                        05730000
         ICM   R15,15,RETR15      RESTORE OPEN RETURN CODE              05740000
         BNZ   OPENFAIL           BRANCH IF NOT                         05750000
         OI    IACF1,IACF1OPN     SHOW THAT IACB IS OPEN                05760000
         L     R1,IVT#OPEN        NUMBER OF OPEN ACB'S                  05770000
         A     R1,=F'1'           UPDATE COUNT                          05780000
         ST    R1,IVT#OPEN        SAVE UPDATED COUNT                    05790000
         BNP   ERR#OPEN           SHOULD BE GREATER THAN ZERO           05800000
                                                                        05810000
*                                                                       05820000
* EXTRACT INFORMATION FROM ACCESS METHOD SUPPORT VECTOR LIST            05830000
*---------------------------------------------------------------------- 05840000
                                                                        05850000
         OC    IVTLEVEL,IVTLEVEL  HAS AMSI BEEN LOGGED?                 05860000
         BNZ   AMSICHEK           YES - BRANCH                          05870000
         ICM   R2,15,ACBAMSVL     ANY VECTOR LIST PRESENT               05880000
         BZ    AMSICHEK           NO - BRANCH                           05890000
         SLR   R3,R3              SETUP FOR INSERTION                   05900000
         ICM   R3,B'0011',0(R2)   LENGTH OF VECTOR LIST                 05910000
         LA    R2,2(,R2)          ADDRESS OF 1ST VECTOR                 05920000
         BCTR  R3,0               LENGTH REMAINING                      05930000
         BCTR  R3,0               LENGTH REMAINING                      05940000
                                                                        05950000
AMSILOOP DS    0H                                                       05960000
                                                                        05970000
         LTR   R3,R3              ANY VECTORS REMAINING?                05980000
         BNP   AMSICHEK           BRANCH IF NOT                         05990000
         SR    R5,R5              CLEAR FOR INSERT                      06000000
         ICM   R5,B'0001',0(R2)   LENGTH OF CURRENT VECTOR              06010000
         SR    R3,R5              LENGTH REMAINING AFTER CURRENT        06020000
         LR    R4,R2              ADDRESS OF CURRENT VECTOR             06030000
         LA    R2,0(R5,R2)        ADDRESS OF NEXT VECTOR                06040000
                                                                        06050000
AMSI01   DS    0H                                                       06060000
                                                                        06070000
         CLI   1(R4),X'01'        RELEASE LEVEL?                        06080000
         BNE   AMSI04             BRANCH IF NOT                         06090000
         LA    R0,IVTLEVEL        COPY AREA IN IVTAMCVT                 06100000
         L     R1,=A(L'IVTLEVEL)  MAXIMUM COPY LENGTH                   06110000
         LR    R15,R5             ACTUAL VECTOR LENGTH                  06120000
         LR    R14,R4             CURRENT VECTOR ADDRESS                06130000
         MVCL  R0,R14             COPY THE VECTOR                       06140000
         LA    R4,2(,R4)          ADDRESS OF CHARACTER DATA             06150000
         BCTR  R5,0               LENGTH OF CHARACTER DATA              06160000
         BCTR  R5,0               LENGTH OF CHARACTER DATA              06170000
                                                                        06180000
         $MSG  002,               SHOW VTAM RELEASE LEVEL              +06190000
               FIELDS=(((R4),(R5)))                                     06200000
                                                                        06210000
         B     AMSILOOP           GO CHECK THE NEXT VECTOR              06220000
                                                                        06230000
AMSI04   DS    0H                                                       06240000
                                                                        06250000
         CLI   1(R4),X'04'        COMPONENT ID?                         06260000
         BNE   AMSI05             BRANCH IF NOT                         06270000
         LA    R0,IVTCOMP         COPY AREA IN IVTAMCVT                 06280000
         L     R1,=A(L'IVTCOMP)   MAXIMUM COPY LENGTH                   06290000
         LR    R15,R5             ACTUAL VECTOR LENGTH                  06300000
         LR    R14,R4             CURRENT VECTOR ADDRESS                06310000
         MVCL  R0,R14             COPY THE VECTOR                       06320000
         LA    R4,2(,R4)          ADDRESS OF CHARACTER DATA             06330000
         BCTR  R5,0               LENGTH OF CHARACTER DATA              06340000
         BCTR  R5,0               LENGTH OF CHARACTER DATA              06350000
                                                                        06360000
         $MSG  003,               SHOW VTAM COMPONENT ID               +06370000
               FIELDS=(((R4),(R5)))                                     06380000
                                                                        06390000
         B     AMSILOOP           GO CHECK THE NEXT VECTOR              06400000
                                                                        06410000
AMSI05   DS    0H                                                       06420000
                                                                        06430000
         CLI   1(R4),X'05'        FUNCTION LIST?                        06440000
         BNE   AMSILOOP           BRANCH IF NOT                         06450000
         LA    R0,IVTFUNCL        COPY AREA IN IVTAMCVT                 06460000
         L     R1,=A(L'IVTFUNCL)  MAXIMUM COPY LENGTH                   06470000
         LR    R15,R5             ACTUAL VECTOR LENGTH                  06480000
         LR    R14,R4             CURRENT VECTOR ADDRESS                06490000
         MVCL  R0,R14             COPY THE VECTOR                       06500000
         LA    R4,2(,R4)          ADDRESS OF HEX DATA                   06510000
         BCTR  R5,0               LENGTH OF HEX DATA+1                  06520000
         BCTR  R5,0               LENGTH OF HEX DATA                    06530000
         LTR   R0,R5              HEX LENGTH                            06540000
         BNP   AMSILOOP           SKIP IF BAD LENGTH                    06550000
         SLL   R0,1               LENGTH OF CHARACTER DISPLAY           06560000
         LA    R15,CONVERSN       AREA TO BUILD CHARACTER DISPLAY       06570000
                                                                        06580000
AMSI05LP DS    0H                                                       06590000
                                                                        06600000
         IC    R1,0(R4)           HEX BYTE                              06610000
         STC   R1,1(R15)          STORE SECOND NIBBLE                   06620000
         SRL   R1,4               MOVE 1ST NIBBLE OVER                  06630000
         STC   R1,0(R15)          STORE FIRST NIBBLE                    06640000
         OC    0(2,R15),=X'F0F0'  SET HI NIBBLES TO X'F'                06650000
         TR    0(2,R15),HEX2CHAR-240 TRANSLATE TO DISPLAY FORMAT        06660000
         LA    R15,2(,R15)        UPDATE POINTER IN RESULT STRING       06670000
         LA    R4,1(,R4)          UPDATE POINTER IS SOURCE DATA         06680000
         BCT   R5,AMSI05LP        CONVERT ALL BYTES TO DISPLAY FORMAT   06690000
         LR    R5,R0              LENGTH OF CHARACTER DISPLAY           06700000
                                                                        06710000
         $MSG  004,               SHOW VTAM FUNCTION LIST              +06720000
               FIELDS=((CONVERSN,(R5)))                                 06730000
                                                                        06740000
         B     AMSILOOP           GO CHECK THE NEXT VECTOR              06750000
                                                                        06760000
HEX2CHAR DC    CL16'0123456789ABCDEF'                                   06770000
                                                                        06780000
OPENFAIL DS    0H                                                       06790000
                                                                        06800000
         OI    IACF1,IACF1UNU     UNUSABLE DUE TO OPEN FAILURE          06810000
                                                                        06820000
         $MSG  005,               SHOW OPEN ERROR INFORMATION          +06830000
               FIELDS=(IACNAME,                                        +06840000
               RETR15,                                                 +06850000
               ACBERFLG)                                                06860000
                                                                        06870000
         B     RETURN                                                   06880000
                                                                        06890000
AMSICHEK DS    0H                                                       06900000
                                                                        06910000
         TM    IVT05DAT+1,X'50'   SUPPORT FOR LMPEO & USERRH?           06920000
         BO    AMSIDONE           BRANCH IF YES                         06930000
         MVC   RETR15,=F'1'       SET SPECIAL RETURN CODE               06940000
         B     OPENFAIL           AND COMPLETE THE REQUEST              06950000
                                                                        06960000
AMSIDONE DS    0H                                                       06970000
                                                                        06980000
*                                                                       06990000
* EXTRACT INFORMATION FROM RESOURCE IDENTIFICATION VECTOR LIST          07000000
*---------------------------------------------------------------------- 07010000
                                                                        07020000
         MVC   NETAPPL,=CL8' '    CLEAR NETWORK-APPL NAME               07030000
         MVC   NETID,=CL8' '      CLEAR NETWORK-ID   NAME               07040000
                                                                        07050000
         ICM   R2,15,ACBRIVL      ANY VECTOR LIST PRESENT               07060000
         BZ    RIVLDONE           NO - BRANCH                           07070000
         SLR   R3,R3              SETUP FOR INSERTION                   07080000
         ICM   R3,B'0011',0(R2)   LENGTH OF VECTOR LIST                 07090000
         LA    R2,2(,R2)          ADDRESS OF 1ST VECTOR                 07100000
         BCTR  R3,0               LENGTH REMAINING                      07110000
         BCTR  R3,0               LENGTH REMAINING                      07120000
                                                                        07130000
RIVLLOOP DS    0H                                                       07140000
                                                                        07150000
         LTR   R3,R3              ANY VECTORS REMAINING?                07160000
         BNP   RIVLDONE           BRANCH IF NOT                         07170000
         SR    R5,R5              CLEAR FOR INSERT                      07180000
         ICM   R5,B'0001',0(R2)   LENGTH OF CURRENT VECTOR              07190000
         SR    R3,R5              LENGTH REMAINING AFTER CURRENT        07200000
         LR    R4,R2              ADDRESS OF CURRENT VECTOR             07210000
         LA    R2,0(R5,R2)        ADDRESS OF NEXT VECTOR                07220000
                                                                        07230000
RIVL02   DS    0H                 APPL-NETWORK-NAME VECTOR              07240000
                                                                        07250000
         CLI   1(R4),X'02'        APPL-NETWORK-NAME VECTOR?             07260000
         BNE   RIVL06             BRANCH IF NOT                         07270000
         LA    R0,NETAPPL         COPY AREA IN WORKING STORAGE          07280000
         LA    R1,L'NETAPPL       MAXIMUM COPY LENGTH                   07290000
         LR    R15,R5             ACTUAL VECTOR LENGTH                  07300000
         BCTR  R15,0              GET LENGTH OF NAME                    07310000
         BCTR  R15,0              GET LENGTH OF NAME                    07320000
         LTR   R15,R15            ANYTHING TO COPY?                     07330000
         BNP   RIVLLOOP           BRANCH IF NOT                         07340000
         ICM   R15,B'1000',=C' '  USE A BLANK PAD                       07350000
         LA    R14,2(,R4)         GET ADDRESS OF NAME                   07360000
         MVCL  R0,R14             COPY THE NAME                         07370000
         B     RIVLLOOP           GO CHECK THE NEXT VECTOR              07380000
                                                                        07390000
RIVL06   DS    0H                 NETWORK-NAME VECTOR                   07400000
                                                                        07410000
         CLI   1(R4),X'06'        NETWORK-NAME VECTOR?                  07420000
         BNE   RIVL03             BRANCH IF NOT                         07430000
         LA    R0,NETID           COPY AREA IN WORKING STORAGE          07440000
         LA    R1,L'NETID         MAXIMUM COPY LENGTH                   07450000
         LR    R15,R5             ACTUAL VECTOR LENGTH                  07460000
         BCTR  R15,0              GET LENGTH OF NAME                    07470000
         BCTR  R15,0              GET LENGTH OF NAME                    07480000
         LTR   R15,R15            ANYTHING TO COPY?                     07490000
         BNP   RIVLLOOP           BRANCH IF NOT                         07500000
         ICM   R15,B'1000',=C' '  USE A BLANK PAD                       07510000
         LA    R14,2(,R4)         GET ADDRESS OF NAME                   07520000
         MVCL  R0,R14             COPY THE NAME                         07530000
         B     RIVLLOOP           GO CHECK THE NEXT VECTOR              07540000
                                                                        07550000
RIVL03   DS    0H                 APPL-ACB-NAME VECTOR                  07560000
RIVL07   DS    0H                 SSCP-NAME VECTOR                      07570000
RIVL08   DS    0H                 HOST-SUBAREA-PU-NETWORK-NAME VECTOR   07580000
RIVL09   DS    0H                 HOST-SUBAREA-PU-NETWORK-ADDRES VECTOR 07590000
RIVL0A   DS    0H                 MAXIMUM-SUBAREA VECTOR                07600000
                                                                        07610000
         B     RIVLLOOP           GO CHECK THE NEXT VECTOR              07620000
                                                                        07630000
RIVLDONE DS    0H                                                       07640000
                                                                        07650000
         CLI   NETAPPL,C' '       WAS NETWORK-APPL PRESENT?             07660000
         BNH   RIVLEND            BRANCH IF NOT                         07670000
         CLI   NETID,C' '         WAS NETWORK-ID PRESENT?               07680000
         BNH   RIVLEND            BRANCH IF NOT                         07690000
                                                                        07700000
         LA    R1,1               CONSTANT INCREMENT                    07710000
         LA    R2,IACFQNM         PLACE TO PUT FULLY-QUALIFIED NAME     07720000
         LA    R3,8               MAX APPL NAME LENGTH                  07730000
         SR    R4,R4              ACCUMULATE LENGTH OF FQ NAME          07740000
         LA    R5,NETID           START WITH THE NETWORK ID             07750000
                                                                        07760000
MOVEID   DS    0H                                                       07770000
                                                                        07780000
         CLI   0(R5),C' '         IS THIS A BLANK PAD?                  07790000
         BNH   MOVEDID            BRANCH IF YES, ALL DONE               07800000
         MVC   0(1,R2),0(R5)      MOVE A CHARACTER                      07810000
         AR    R2,R1              BUMP POINTER                          07820000
         AR    R5,R1              BUMP POINTER                          07830000
         AR    R4,R1              BUMP COUNTER                          07840000
         BCT   R3,MOVEID          MOVE UP TO 8 CHARACTERS               07850000
                                                                        07860000
MOVEDID  DS    0H                                                       07870000
                                                                        07880000
         MVI   0(R2),C'.'         SEPARATE THEM WITH A PERIOD           07890000
         AR    R2,R1              BUMP POINTER                          07900000
         AR    R4,R1              BUMP COUNTER                          07910000
         LA    R3,8               MAX APPL NAME LENGTH                  07920000
         LA    R5,NETAPPL         ADD THE NETWORK-APPL NAME             07930000
                                                                        07940000
MOVEAP   DS    0H                                                       07950000
                                                                        07960000
         CLI   0(R5),C' '         IS THIS A BLANK PAD?                  07970000
         BNH   MOVEDAP            BRANCH IF YES, ALL DONE               07980000
         MVC   0(1,R2),0(R5)      MOVE A CHARACTER                      07990000
         AR    R2,R1              BUMP POINTER                          08000000
         AR    R5,R1              BUMP POINTER                          08010000
         AR    R4,R1              BUMP COUNTER                          08020000
         BCT   R3,MOVEAP          MOVE UP TO 8 CHARACTERS               08030000
                                                                        08040000
MOVEDAP  DS    0H                                                       08050000
                                                                        08060000
         STC   R4,IACFQNML        SET THE FULL-QUALIFIED NAME LENGTH    08070000
                                                                        08080000
RIVLEND  DS    0H                                                       08090000
                                                                        08100000
*                                                                       08110000
* ISSUE SETLOGON TO ACTIVATE LOGON PROCESSING                           08120000
*---------------------------------------------------------------------- 08130000
                                                                        08140000
         $VTAM GETRPL,                                                 +08150000
               AREA=IVTRPACT,                                          +08160000
               ERRET=ERR$VTAM,                                         +08170000
               MF=(E,MFE_LIST)    ACQUIRE AN IRPL                       08180000
                                                                        08190000
         LR    RIRPL,R1           ESTABLISH ADDRESSIBILITY              08200000
         MVC   IRPWTGOK,=A(OPNEND) OK COMPLETION ROUTINE                08210000
         LA    R1,IVTWEQ          MAIN TASK WORK QUEUE                  08220000
         ST    R1,IRP@WEQ         WILL RECEIVE THE RPL COMPLETION       08230000
                                                                        08240000
         SETLOGON RPL=(RIRPL),                                         +08250000
               ACB=(RIACB),                                            +08260000
               OPTCD=(START,ASY)  START LOGON EXIT SCHEDULING           08270000
                                                                        08280000
         STM   R15,R0,IRPR15      SAVE VTAM RETURN CODES                08290000
                                                                        08300000
         $VTAM CHECKPH1,                                               +08310000
               AREA=(RIRPL),      CHECK ACCEPTANCE OF THIS RPL         +08320000
               MF=(E,MFE_LIST)                                          08330000
                                                                        08340000
         B     RETURN             OPEN IS COMPLETE, RETURN TO CALLER    08350000
                                                                        08360000
*---------------------------------------------------------------------- 08370000
* REQUEST 07 - DISPLAY AN RPL                                           08380000
*                                                                       08390000
* ENTRY  VALUES: R01 = ADDRESS OF $VTAM SERVICES PARAMETER LIST         08400000
*                VPLFUNC  = 7                                           08410000
*                VPLAREA  = ADDRESS OF RPL TO DISPLAY VIA $MSG          08420000
*                VPLAREAL = !0 ADDRESS TO DISPLAY AS THE RPL ORIGIN     08430000
*                         = 0  USE RPL ADDRESS AS ORIGIN ADDRESS        08440000
*                                                                       08450000
* RETURN VALUES: R15 = 0 --> REQUEST COMPLETE                           08460000
*                    = 4 --> INVALID RPL ADDRESS                        08470000
*                R00 = 0                                                08480000
*                R01 = 0                                                08490000
*                                                                       08500000
*---------------------------------------------------------------------- 08510000
                                                                        08520000
DUMPRPL  DS    0H                                                       08530000
                                                                        08540000
         ICM   RIRPL,15,VPLAREA   ADDRESS OF IRPL                       08550000
         BZ    RETURN4            EXIT RC=4 IF NO IRPL ADDRESS          08560000
                                                                        08570000
         LA    R3,28              28 WORDS FOR CONVERT                  08580000
         LA    R4,CONVERSN        AREA TO RECEIVE CONVERSION            08590000
         LR    R5,RIRPL           AREA TO CONVERT                       08600000
         LR    R2,R5              USE RPL ADDRESS AS "ORIGIN ADDRESS"   08610000
         OC    VPLAREAL,VPLAREAL  WAS AN "ORIGIN ADDRESS" PROVIDED?     08620000
         BZ    DUMPCONV           BRANCH IF NOT                         08630000
         L     R2,VPLAREAL        ADDRESS TO DISPLAY AS RPL ORIGIN      08640000
                                                                        08650000
DUMPCONV DS    0H                                                       08660000
                                                                        08670000
         UNPK  0(9,R4),0(5,R5)    UNPK 5 BYTES TO ZONED                 08680000
         MVI   8(R4),C' '         CLEAR THE FIFTH BYTE AREA             08690000
         TR    0(8,R4),HEX2CHAR-240 DISPLAY FORMAT                      08700000
         LA    R5,4(,R5)          NEXT WORD IN RPL                      08710000
         LA    R4,9(,R4)          NEXT AREA TO RECEIVE CONVERSION       08720000
         BCT   R3,DUMPCONV        CONVERT ALL 28 WORDS                  08730000
                                                                        08740000
         $MSG  016,                                                    +08750000
               FIELDS=((R2),      RPL ORIGIN ADDRESS                   +08760000
               (CONVERSN,72),                                          +08770000
               (CONVERSN+72,72),                                       +08780000
               (CONVERSN+144,72),                                      +08790000
               (CONVERSN+216,36))                                       08800000
                                                                        08810000
         B     RETURN             EXIT TO CALLER                        08820000
                                                                        08830000
*        $MSG  008,                                                    +08840000
               FIELDS=((R2),      RPL ORIGIN ADDRESS                   +08850000
               (RPLREQ,1),(RPLLEN,1),(RPLECB,4),(RPLRTNCD,3),          +08860000
               (RPLRH3,1),(RPLSRTYP,1),                                +08870000
               (RPLCHN,1),(RPLVTFL1,2),(RPLCNTDF,3),                   +08880000
               (RPLDACB,4),(RPLURH,3))                                  08890000
                                                                        08900000
*        $MSG  009,                                                    +08910000
               FIELDS=((R2),      RPL ORIGIN ADDRESS                   +08920000
               (RPLSONCD,1),(RPLAREA,4),(RPLARG,4),(RPLOPT1,1),        +08930000
               (RPLRLEN,4),(RPLBUFL,4),(RPLOPT5,4),                    +08940000
               (RPLOBSQV,2),(RPLIBSQV,2),                              +08950000
               (RPLOBSQ,1),(RPLIBSQ,1),(RPLSEQNO,2))                    08960000
                                                                        08970000
*        $MSG  010,                                                    +08980000
               FIELDS=((R2),      RPL ORIGIN ADDRESS                   +08990000
               (RPLEXTDS,1),                                           +09000000
               (RPLACTIV,1),(RPLAAREA,4),(RPLAARLN,4),(RPLARCLN,4),    +09010000
               (RPLSSEI,4),                                            +09020000
               (RPLUSFLD,4),(RPLOPT9,4),                               +09030000
               (RPLSSEO,4),(RPLSAV13,4),(RPLSIGDA,4))                   09040000
                                                                        09050000
*        B     RETURN             EXIT TO CALLER                        09060000
                                                                        09070000
*---------------------------------------------------------------------- 09080000
*   SET RETURN CODE OF 8                                                09090000
*---------------------------------------------------------------------- 09100000
                                                                        09110000
RETURN8  DS    0H                                                       09120000
                                                                        09130000
         MVI   RETR15+(L'RETR15-1),8                                    09140000
         B     RETURN                                                   09150000
                                                                        09160000
*---------------------------------------------------------------------- 09170000
*   SET RETURN CODE OF 4                                                09180000
*---------------------------------------------------------------------- 09190000
                                                                        09200000
RETURN4  DS    0H                                                       09210000
                                                                        09220000
         MVI   RETR15+(L'RETR15-1),4                                    09230000
         B     RETURN                                                   09240000
                                                                        09250000
*---------------------------------------------------------------------- 09260000
*   R E T U R N   T O   C A L L E R                                     09270000
*---------------------------------------------------------------------- 09280000
                                                                        09290000
*---------------------------------------------------------------------- 09300000
* TRACE THE MODULE EXIT                                                 09310000
*---------------------------------------------------------------------- 09320000
                                                                        09330000
RETURN   DS    0H                                                       09340000
                                                                        09350000
         $TRACE *=A(TRC_IVTMAPIX_EXIT),16 TRACE ENTRY W/ 16 USER BYTES  09360000
                                                                        09370000
         BNZ   NOXTRACE           BRANCH IF TRACING NOT AVAILABLE       09380000
                                                                        09390000
         MVC   0(4,R1),VPLFUNC    TRACE $VTAM FUNCTION CODE             09400000
         MVC   4(12,R1),RETREGS   TRACE 15,0,1 RETURN REGISTERS         09410000
                                                                        09420000
NOXTRACE DS    0H                                                       09430000
                                                                        09440000
         LM    R15,R1,RETREGS       LOAD RETURN REGISTERS               09450000
                                                                        09460000
         #EXIT R1=YES               RETURN W/R15,R0,R1                  09470000
                                                                        09480000
*---------------------------------------------------------------------- 09490000
* SUBROUTINE GETCOPY - ALLOCATE STORAGE AND COPY MODEL BLOCK            09500000
*---------------------------------------------------------------------- 09510000
                                                                        09520000
GETCOPY  DS    0H                                                       09530000
                                                                        09540000
         STM   R14,R5,LV0SAVE     SAVE REGISTERS                        09550000
         ICM   R3,15,VPLTASK      ITASK FOR STORAGE ASSOCIATION         09560000
         BNZ   GETSIZE            BRANCH IF ITASK PROVIDED              09570000
         LR    R3,RITASK          USE CURRENT ITASK                     09580000
                                                                        09590000
GETSIZE  DS    0H                                                       09600000
                                                                        09610000
         L     R4,4(,R1)          MODEL ADDRESS                         09620000
         L     R5,0(,R1)          MODEL LENGTH                          09630000
                                                                        09640000
         $GETSTOR (R5),           GET STORAGE FOR BLOCK                +09650000
               LOC=ANY,                                                +09660000
               OWNER=(R3)                                               09670000
                                                                        09680000
         LR    R2,R1              NEW CONTROL BLOCK ADDRESS             09690000
         ST    R1,RETR1           SET RETURN VALUE                      09700000
         LR    R3,R5              NEW CONTROL BLOCK LENGTH              09710000
         MVCL  R2,R4              CREATE A CONTROL BLOCK COPY           09720000
         LM    R14,R0,LV0SAVE     RESTORE REGISTERS                     09730000
         LM    R2,R5,LV0SAVE+16   RESTORE REGISTERS                     09740000
         BR    R14                AND RETURN TO CALLER                  09750000
                                                                        09760000
*---------------------------------------------------------------------- 09770000
* SUBROUTINE RETCOPY - RELEASE STORAGE FOR IACB, IRPL, OR INIB          09780000
*---------------------------------------------------------------------- 09790000
                                                                        09800000
RETCOPY  DS    0H                                                       09810000
                                                                        09820000
         STM   R14,R2,LV0SAVE     SAVE REGISTERS                        09830000
         ICM   R2,15,VPLTASK      ITASK FOR STORAGE ASSOCIATION         09840000
         BNZ   RETSTORE           BRANCH IF ITASK PROVIDED              09850000
         LR    R2,RITASK          USE CURRENT ITASK                     09860000
                                                                        09870000
RETSTORE DS    0H                                                       09880000
                                                                        09890000
         $RETSTOR (R1),           RELEASE THE BLOCK                    +09900000
               OWNER=(R2)                                               09910000
                                                                        09920000
         LM    R14,R2,LV0SAVE     RESTORE REGISTERS                     09930000
         BR    R14                AND RETURN TO CALLER                  09940000
                                                                        09950000
*---------------------------------------------------------------------- 09960000
* SUBROUTINE QTOMAIN - QUEUE A WORK ELEMENT TO THE MAIN TASK            09970000
*                                                                       09980000
*            R14 = RETURN ADDRESS                                       09990000
*            R1  = WORK ELEMENT                                         10000000
*---------------------------------------------------------------------- 10010000
                                                                        10020000
QTOMAIN  DS    0H                                                       10030000
                                                                        10040000
         STM   R14,R3,LV0SAVE     SAVE REGISTERS                        10050000
                                                                        10060000
         LR    R3,R1              SAVE WORK ELEMENT ADDRESS             10070000
                                                                        10080000
         $VTAMQ (R3),             WORK ELEMENT                         +10090000
               IVTWEQ             QUEUE                                 10100000
                                                                        10110000
         LM    R14,R3,LV0SAVE     RESTORE REGISTERS                     10120000
         BR    R14                AND RETURN TO CALLER                  10130000
                                                                        10140000
*---------------------------------------------------------------------- 10150000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 10160000
*---------------------------------------------------------------------- 10170000
                                                                        10180000
VTAMLOCK DS    0H                                                       10190000
                                                                        10200000
         TM    FLAG,FLAGLOCK        WAS THE LOCK ALREAY OBTAINED?       10210000
         BOR   R14                  RETURN IF YES                       10220000
         STM   R14,R2,LV0SAVE       SAVE CALLER'S REGISTERS             10230000
                                                                        10240000
         $SER  OBTAIN,                                                 +10250000
               VTAM                                                     10260000
                                                                        10270000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              10280000
         BNE   VTAMLOEX             BRANCH IF NOT                       10290000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         10300000
                                                                        10310000
VTAMLOEX DS    0H                                                       10320000
                                                                        10330000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               10340000
         LM    R14,R2,LV0SAVE       RESTORE CALLER'S REGISTERS          10350000
         BR    R14                  RETURN                              10360000
                                                                        10370000
*---------------------------------------------------------------------- 10380000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                10390000
*---------------------------------------------------------------------- 10400000
                                                                        10410000
VTAMUNLK DS    0H                                                       10420000
                                                                        10430000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       10440000
         BNOR  R14                  BRANCH IF NOT                       10450000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             10460000
         BOR   R14                  DON'T RELEASE IF IT WAS             10470000
         STM   R14,R2,LV0SAVE       SAVE CALLER'S REGISTERS             10480000
                                                                        10490000
         $SER  RELEASE,                                                +10500000
               VTAM                                                     10510000
                                                                        10520000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  10530000
         LM    R14,R2,LV0SAVE       RESTORE CALLER'S REGISTERS          10540000
         BR    R14                  RETURN                              10550000
                                                                        10560000
                                                                        10570000
*---------------------------------------------------------------------- 10580000
*   E R R O R   R O U T I N E S                                         10590000
*---------------------------------------------------------------------- 10600000
                                                                        10610000
ERR$VTAM DS    0H                                                       10620000
                                                                        10630000
         $ABEND ABE_VTDIAG,                                            +10640000
               SCOPE=PCB,                                              +10650000
               TITLE='$VTAM FAILURE'                                    10660000
                                                                        10670000
ERR#OPEN DS    0H                                                       10680000
                                                                        10690000
         $ABEND ABE_VTDIAG,                                            +10700000
               SCOPE=PCB,                                              +10710000
               TITLE='INVALID OPEN ACB COUNT'                           10720000
                                                                        10730000
*---------------------------------------------------------------------- 10740000
* THIS IS THE RPL COMPLETION ROUTINE FOR THE VTAM SETLOGON              10750000
*                                                                       10760000
* ON ENTRY:                                                             10770000
*                                                                       10780000
*    R15 = ENTRY POINT ADDRESS                                          10790000
*    R14 = RETURN ADDRESS                                               10800000
*    R13 = AVAILABLE SAVE AREA                                          10810000
*    R11 = ICVT ADDRESS                                                 10820000
*    R10 = ITASK ADDRESS                                                10830000
*    R09 = IVTAMCVT ADDRESS                                             10840000
*    R01 = ADDRESS OF COMPLETED IRPL                                    10850000
*---------------------------------------------------------------------- 10860000
                                                                        10870000
         DROP  R12                                                      10880000
                                                                        10890000
OPNEND   #ENTER BASE=R12,         ENTRY LINKAGE                        +10900000
               PREG=RIRPL,                                             +10910000
               EP=YES             THIS IS AN ENTRY POINT                10920000
                                                                        10930000
         L     RIACB,RPLDACB      ACB WHERE LOGON IS OCCURING           10940000
         CLI   RPLRTNCD,0         GOOD COMPLETION?                      10950000
         BE    RECANY             BRANCH IF YES                         10960000
                                                                        10970000
         $MSG  011,               SHOW SETLOGON ERROR                  +10980000
               FIELDS=(IACNAME,                                        +10990000
               RPLRTNCD,                                               +11000000
               RPLFDB2)                                                 11010000
                                                                        11020000
         B     FREERPL            OPEN IS COMPLETE, FREE RPL & RETURN   11030000
                                                                        11040000
RECANY   DS    0H                                                       11050000
                                                                        11060000
         LA    R3,IVTRECNM        INITIAL RECEIVE ANY COUNT             11070000
                                                                        11080000
RECALOOP DS    0H                                                       11090000
                                                                        11100000
         $VTAMWE L'IWEXC,         SIZE                                 +11110000
               IWECRECA           CODE                                  11120000
                                                                        11130000
         ST    RIACB,IWEXCACB-IWE(,R1)                                  11140000
         BAS   R14,QTOMAIN        GO QUEUE THE WORK ELEMENT             11150000
         BCT   R3,RECALOOP        START INITIAL RECEIVE ANY'S           11160000
                                                                        11170000
FREERPL  DS    0H                                                       11180000
                                                                        11190000
         $VTAM RETRPL,            FREE RPL                             +11200000
               AREA=(RIRPL),      IRPL ADDRESS                         +11210000
               ERRET=ERR$VTAM,                                         +11220000
               MF=(E,MFE_LIST)                                          11230000
                                                                        11240000
         $MSG  014,               TELL THAT OPEN IS COMPLETE           +11250000
               FIELDS=(IACNAME)                                         11260000
                                                                        11270000
         B     RETURN             AND RETURN                            11280000
                                                                        11290000
*---------------------------------------------------------------------- 11300000
*   C O N S T A N T S   A N D   L I T E R A L S                         11310000
*---------------------------------------------------------------------- 11320000
                                                                        11330000
         LTORG ,                                                        11340000
                                                                        11350000
*---------------------------------------------------------------------- 11360000
*   D S E C T S                                                         11370000
*---------------------------------------------------------------------- 11380000
                                                                        11390000
         PRINT NOGEN                                                    11400000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                11410000
         ISTDBIND ,               VTAM BIND IMAGE                       11420000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         11430000
         ICVT  ,                  INTEGRATOR CVT                        11440000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   11450000
         ITASK ,                  INTEGRATOR TASK BLOCK                 11460000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            11470000
         IACB ,                   INTEGRATOR VTAM ACB+                  11480000
         IRPL ,                   INTEGRATOR VTAM RPL+                  11490000
         INIB ,                   INTEGRATOR VTAM NIB+                  11500000
         ISESS ,                  INTEGRATOR SESSION CONTROL            11510000
         IPOOL ,                  INTEGRATOR POOL CONTROL               11520000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENTS         11530000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       11540000
         EVCODES ,                INTEGRATOR EVENT CODES                11550000
         ABCODES ,                INTEGRATOR $ABEND CODES               11560000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     11570000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             11580000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             11590000
         IFGEXLST ,               VTAM EXIT LIST                        11600000
         END   ,                                                        11610000

ICPISLD TITLE 'INTEGRATOR - CPIC CMSLD API - SET LOG DATA'              00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: ICPISLD - CPIC CMSLD API                                     00100000
*                                                                       00110000
* DESCRIPTION:                                                          00120000
*                                                                       00130000
*    THIS ROUTINE IS CALLED TO PROCESS THE CMSLD VERB.                  00140000
*                                                                       00150000
* ON ENTRY:                                                             00160000
*                                                                       00170000
*    R15 = ENTRY POINT ADDRESS                                          00180000
*    R14 = RETURN      ADDRESS                                          00190000
*    R13 = SAVE AREA   ADDRESS                                          00200000
*    R01 = PARM LIST   ADDRESS                                          00210000
*                                                                       00220000
*          +00 = ADDRESS OF CONVERSATION_ID                             00230000
*          +04 = ADDRESS OF LOG_DATA                                    00240000
*          +08 = ADDRESS OF LOG_DATA_LENGTH                             00250000
*          +0C = ADDRESS OF RETURN_CODE RETURN AREA                     00260000
*                                                                       00270000
* ON EXIT:                                                              00280000
*                                                                       00290000
*    R15 = 0                                                            00300000
*                                                                       00310000
*    RETURN_CODE = CM_OK                      --> CMSLD SUCCESSFUL      00320000
*                = CM_PROGRAM_PARAMETER_CHECK --> INVALID CONV_ID, ETC. 00330000
*                = CM_PRODUCT_SPECIFIC_ERROR  --> BAD PARM              00340000
*                = CM_OPERATION_NOT_ACCEPTED  --> N/A                   00350000
*                                                                       00360000
**<DOC-OFF>************************************************************ 00370000
         EJECT ,                                                        00380000
*********************************************************************** 00390000
*                                                                       00400000
* MAINTENANCE:                                                          00410000
*                                                                       00420000
*   07/01/94 RANDY WITEK                                                00430000
*                                                                       00440000
*********************************************************************** 00450000
                                                                        00460000
         EQUS  ,                  GENERAL EQUATES                       00470000
                                                                        00480000
RICVT    EQU   R11                                                      00490000
RITASK   EQU   R10                                                      00500000
RBASE    EQU   R9                                                       00510000
RIVTAM   EQU   R8                                                       00520000
RCMLIST  EQU   R7                                                       00530000
RTKB     EQU   R6                                                       00540000
RRCB     EQU   R5                                                       00550000
                                                                        00560000
         USING DSA,R13            ESTABLISH ADDRESSABILITY              00570000
         USING CRAB,R12           ESTABLISH ADDRESSABILITY              00580000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00590000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00600000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00610000
         USING CMLIST,RCMLIST     ESTABLISH ADDRESSABILITY              00620000
         USING TKB,RTKB           ESTABLISH ADDRESSABILITY              00630000
         USING RCB,RRCB           ESTABLISH ADDRESSABILITY              00640000
                                                                        00650000
         COPY  CRAB               "C" RUNTIME ANCHOR BLOCK              00660000
         COPY  DSA                DYNAMIC SAVE AREA                     00670000
WORKAREA DS    0H                 READ/WRITE WORKAREA                   00680000
WRK256   DS    XL256              GENERAL WORKAREA                      00690000
                                                                        00700000
CONVID   DS    XL8                TEMPORARY CONVERSATION ID AREA        00710000
LOGDATAL DS    F                  TEMPORARY LOG DATA LENGTH AREA        00720000
LOGDATA  DS    XL512              TEMPORARY LOG DATA        AREA        00730000
RETCODE  DS    F                  TEMPORARY RETURN CODE     AREA        00740000
CONVS    DS    F                  TEMPORARY CONV STATE      AREA        00750000
                                                                        00760000
FLAG     DS    X                                                        00770000
FLAGIERR EQU   X'80'              PARM ERROR DURING INIT                00780000
FLAGIER2 EQU   X'40'              PARM ERROR DURING INIT                00790000
WORKLEN  EQU   *-WORKAREA         LENGTH OF USER DSA AREA               00800000
DSALEN   EQU   *-DSA              LENGTH OF DSA                         00810000
                                                                        00820000
         $MSGDFT PREFIX=ICTPID,                                        +00830000
               COMPID='CPI',                                           +00840000
               TABLE=*#MSGS,                                           +00850000
               WORKA=0,                                                +00860000
               MF=(E,WRK256),                                          +00870000
               PRINT=NOGEN                                              00880000
                                                                        00890000
ICPSLD@  CSECT ,                                                        00900000
ICPISLD  CENTRY DSA=DSALEN,BASE=RBASE,INDEP=YES                         00910000
                                                                        00920000
*---------------------------------------------------------------------- 00930000
* ENTRY                                                                 00940000
*---------------------------------------------------------------------- 00950000
                                                                        00960000
         LR    RCMLIST,R1         SAVE ADDRESS OF PLIST                 00970000
                                                                        00980000
         LA    R0,WORKAREA        ADDRESS OF USER DSA SECTION           00990000
         LA    R1,WORKLEN         LENGTH  OF USER DSA SECTION           01000000
         SR    R15,R15            PREPARE FOR CLEAR                     01010000
         MVCL  R0,R14             CLEAR USER DSA SECTION                01020000
                                                                        01030000
*---------------------------------------------------------------------- 01040000
* INITIALIZATION                                                        01050000
*---------------------------------------------------------------------- 01060000
                                                                        01070000
         @RESTENV ,               ENSURE ENVIRONMENT                    01080000
                                                                        01090000
         L     RIVTAM,ICTVTCVT    ESTABLISH IVTAMCVT POINTER            01100000
                                                                        01110000
         MVC   CONVID,=XL8'55AA55AA55AA55AA'                            01120000
         MVC   CONVS,=XL4'55AA55AA'                                     01130000
                                                                        01140000
         L     R1,CMLPARM4        ADDRESS OF RETURN_CODE AREA           01150000
         MVC   0(4,R1),0(R1)      TEST MOVEMENT                         01160000
                                                                        01170000
         ICM   R1,15,CMLPARM1     ADDRESS OF CONVERSATION ID            01180000
         BNP   INITERR            BRANCH IF BAD                         01190000
         MVC   CONVID,0(R1)       COPY CONVID                           01200000
                                                                        01210000
         ICM   R1,15,CMLPARM3     ADDRESS OF LOG DATA LENGTH            01220000
         BNP   INITERR            BRANCH IF BAD                         01230000
         MVC   LOGDATAL,0(R1)     COPY LOGDATA LENGTH                   01240000
         ICM   R1,15,LOGDATAL     GET LOGDATA LENGTH                    01250000
         BM    INITERR            ERROR IF NEGATIVE                     01260000
         BZ    INITCOPY           SKIP LOGDATA IF ZERO LENGTH           01270000
         C     R1,=F'512'         IS LENGTH VALID                       01280000
         BH    INITERR2           BRANCH IF NOT                         01290000
                                                                        01300000
         ICM   R0,15,CMLPARM2     ADDRESS OF LOG DATA                   01310000
         BNP   INITERR            BRANCH IF BAD                         01320000
                                                                        01330000
INITCOPY DS    0H                                                       01340000
                                                                        01350000
         LA    R14,LOGDATA        LOGDATA HOLDING AREA                  01360000
         LA    R15,512            MAXIMUM LENGTH                        01370000
         MVCL  R14,R0             COPY THE LOGDATA TO HOLDING AREA      01380000
         B     INITEND                                                  01390000
                                                                        01400000
INITERR  DS    0H                                                       01410000
                                                                        01420000
         OI    FLAG,FLAGIERR      REMEMBER ERROR DETECTED               01430000
         B     INITEND                                                  01440000
                                                                        01450000
INITERR2 DS    0H                                                       01460000
                                                                        01470000
         OI    FLAG,FLAGIER2      REMEMBER ERROR DETECTED               01480000
                                                                        01490000
INITEND  DS    0H                                                       01500000
                                                                        01510000
*---------------------------------------------------------------------- 01520000
* ENTRY TRACE                                                           01530000
*---------------------------------------------------------------------- 01540000
                                                                        01550000
         $TRACE *=A(TRC_CPIC_ICPISLD),64 TRACE ENTRY W/ 64 USER BYTES   01560000
         BNZ   NOETRACE                  BRANCH IF NOT TRACING          01570000
         $APITRC ICPISLD                 TRACE COMMON STUFF             01580000
         ST    RCMLIST,24(,R1)           TRACE PARMLIST ADDRESS         01590000
         MVC   32(8,R1),CONVID           TRACE CONVERSATION ID          01600000
         MVC   28(4,R1),LOGDATAL         TRACE LOGDATA LENGTH           01610000
         MVC   40(24,R1),LOGDATA         TRACE LOGDATA (MAX. 24 BYTES)  01620000
NOETRACE DS    0H                                                       01630000
                                                                        01640000
*---------------------------------------------------------------------- 01650000
* LOCATE SPECIFIED CONVERSATION                                         01660000
*---------------------------------------------------------------------- 01670000
                                                                        01680000
         TM    FLAG,FLAGIERR             INIT ERROR?                    01690000
         BO    ERRPROD                   BRANCH IF YES                  01700000
                                                                        01710000
         TM    FLAG,FLAGIER2             INIT ERROR?                    01720000
         BO    ERRPARM                   BRANCH IF YES                  01730000
                                                                        01740000
         LA    R1,CONVID                 ADDRESS OF CONVERSATION ID     01750000
         L     R15,ICP@LOC               ENTRY POINT OF TKB/RCB LOCATE  01760000
         BASR  R14,R15                   LOCATE THE TKB/RCB             01770000
         LTR   RTKB,R1                   TKB ADDRESS                    01780000
         BNP   ERRPARM                   BRANCH IF BAD                  01790000
         LTR   RRCB,R0                   RCB ADDRESS                    01800000
         BNP   ERRPARM                   BRANCH IF BAD                  01810000
                                                                        01820000
         MVC   CONVS,RCBCONVS            COPY CONV STATE                01830000
                                                                        01840000
*---------------------------------------------------------------------- 01850000
* VALIDATE REQUESTED PARAMETER CHANGE                                   01860000
*---------------------------------------------------------------------- 01870000
                                                                        01880000
         CLC   RCBCTYPE,=A(CM_MAPPED_CONVERSATION)                      01890000
         BE    ERRPARM            LOGDATA NOT VALID FOR MAPPED          01900000
                                                                        01910000
*---------------------------------------------------------------------- 01920000
* PERFORM REQUESTED PARAMETER CHANGE                                    01930000
*---------------------------------------------------------------------- 01940000
                                                                        01950000
         LA    R14,RCBLOGD        LOGDATA AREA                          01960000
         LA    R15,512            MAXIMUM LENGTH                        01970000
         LA    R0,LOGDATA         NEW LOGDATA                           01980000
         L     R1,LOGDATAL        NEW LOGDATA LENGTH                    01990000
         ST    R1,RCBLOGDL        SET NEW LOGDATA LENGTH IN RCB         02000000
         MVCL  R14,R0             SET NEW LOGDATA IN RCB                02010000
         B     RETURN                                                   02020000
                                                                        02030000
*---------------------------------------------------------------------- 02040000
* EXCEPTION ROUTINES                                                    02050000
*---------------------------------------------------------------------- 02060000
                                                                        02070000
ERRPROD  DS    0H                                                       02080000
                                                                        02090000
         MVC   RETCODE,=A(CM_PRODUCT_SPECIFIC_ERROR)                    02100000
         B     RETURN                                                   02110000
                                                                        02120000
ERRPARM  DS    0H                                                       02130000
                                                                        02140000
         MVC   RETCODE,=A(CM_PROGRAM_PARAMETER_CHECK)                   02150000
         B     RETURN                                                   02160000
                                                                        02170000
*---------------------------------------------------------------------- 02180000
* EXIT TRACE AND RETURN TO CALLER                                       02190000
*---------------------------------------------------------------------- 02200000
                                                                        02210000
RETURN   DS    0H                                                       02220000
                                                                        02230000
         $TRACE *=A(TRC_CPIC_EXIT),48 TRACE ENTRY W/ 32 USER BYTES      02240000
         BNZ   NOXTRACE               BRANCH IF TRACING NOT AVAILABLE   02250000
         MVC   0(8,R1),=CL8'ICPISLD'  MODULE NAME                       02260000
         MVC   8(4,R1),RETCODE        RETURN_CODE VALUE                 02270000
         MVC   12(8,R1),CONVID        CONVERSATION ID                   02280000
         MVC   20(4,R1),CONVS         CONVERSATION STATE                02290000
         MVC   24(4,R1),LOGDATAL      LOG DATA LENGTH                   02300000
         CLC   RETCODE,=A(CM_OK)      SHOULD WE TRACE DATA?             02310000
         BNE   NOXTRACE               BRANCH IF NOT                     02320000
         ICM   R3,15,LOGDATAL         IS THERE DATA TO TRACE?           02330000
         BNP   NOXTRACE               BRANCH IF NOT                     02340000
         LA    R2,LOGDATA             START OF LOG DATA                 02350000
         SR    R4,R4                  STARTING OFFSET                   02360000
XTRCDATA DS    0H                                                       02370000
         $TRACE *=A(TRC_CPIC_LOG_DATA),144 LOG DATA TRACE               02380000
         BNZ   NOXTRACE               BRANCH IF TRACING NOT AVAILABLE   02390000
         MVC   0(8,R1),CONVID         CONVERSATION ID                   02400000
         MVC   8(4,R1),=F'128'        SET MAX TRACE DATA LENGTH         02410000
         C     R3,=F'128'             AT LEAST 128 TO GO?               02420000
         BNL   *+8                    BRANCH IF YES                     02430000
         ST    R3,8(,R1)              SET ACTUAL DATA LENGTH REMAINING  02440000
         ST    R4,12(,R1)             SET STARTING OFFSET IN BUFFER     02450000
         LA    R14,16(,R1)            ADDRESS OF LOG DATA AREA          02460000
         LA    R15,128                MAX OF 128 BYTES                  02470000
         MVCL  R14,R2                 TRACE THE RECEIVED DATA           02480000
         LA    R4,128(,R4)            UPDATE DATA OFFSET                02490000
         LTR   R3,R3                  MORE DATA TO TRACE?               02500000
         BP    XTRCDATA               BRANCH IF YES                     02510000
NOXTRACE DS    0H                                                       02520000
                                                                        02530000
         L     R1,CMLPARM4        ADDRESS OF RETURN_CODE AREA           02540000
         MVC   0(4,R1),RETCODE    SET RETURN_CODE VARIABLE              02550000
                                                                        02560000
         SR    R15,R15            FUNCTION RETURN CODE = 0              02570000
         CEXIT RC=(R15),INDEP=YES RETURN                                02580000
                                                                        02590000
*---------------------------------------------------------------------- 02600000
* LITERALS AND CONSTANTS                                                02610000
*---------------------------------------------------------------------- 02620000
                                                                        02630000
         LTORG ,                                                        02640000
                                                                        02650000
         PRINT NOGEN                                                    02660000
         ISTDBIND ,               VTAM BIND IMAGE                       02670000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                02680000
         IKJTCB ,                 MVS TASK CONTROL BLOCK                02690000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         02700000
         ICVT  ,                  INTEGRATOR CVT                        02710000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   02720000
         ITASK ,                  INTEGRATOR TASK BLOCK                 02730000
         IPCB ,                   INTEGRATOR PROCESS BLOCK              02740000
         ABCODES ,                INTEGRATOR $ABEND CODES               02750000
         EVCODES ,                INTEGRATOR EVENT CODES                02760000
         END   ,                                                        02770000

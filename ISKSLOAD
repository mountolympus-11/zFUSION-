ISKSLOAD TITLE 'LOAD / CONSTRUCT RUNTIME SKS'                           00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE:  ISKSLOAD - Load / Construct runtime SKS                     00040000
*                                                                       00050000
* FUNCTION:                                                             00060000
*                                                                       00070000
*   int  sksload( struct stghdrq *qh,                                   00080000
*                 struct image   *i,                                    00090000
*                 struct nvvar   *var,                                  00100000
*                 struct sksstmt **s,                                   00110000
*                 int    sksid        ) ;                               00120000
*                                                                       00130000
* DESCRIPTION:                                                          00140000
*                                                                       00150000
*   This routine will retrieve a SYSSKS table row and construct         00160000
*   a runtime sks statement structure associated with the recorded      00170000
*   SKS specified by the SKS rowid provided.  The runtime SKS is        00180000
*   retieved and constructed on demand when required by the             00190000
*   PLAN execution service.  Since runtime projects may be              00200000
*   concurrently accessed by serveral users,  updating the              00210000
*   navigation strucuture must be serialized using the project          00220000
*   multiple-instance lock (MIL).  A recovery environment is            00230000
*   also establish to provide resource cleanup of the project           00240000
*   MIL.                                                                00250000
*                                                                       00260000
*   After the SYSSKS row is retrieved,  an SKSBLD request               00270000
*   is made to constuct the runtime sks structure.  Prior               00280000
*   to issuing the sksload function, the S0 image for the STN           00290000
*   must have been previously loaded.                                   00300000
*                                                                       00310000
*                                                                       00320000
* NOTES:  This routine uses standard SASC linkage conventions,          00330000
*         provided by the CENTRY and CEXIT macros.                      00340000
*                                                                       00350000
* ENTRY:  Upon entry to this routine R1 contains the address            00360000
*         of the parameter list as follows.                             00370000
*                                                                       00380000
*             +0 - A(stghdrq)     Storage manager queue hdr             00390000
*             +4 - A(image)       Addr of assoc image structure         00400000
*             +8 - A(sksstmt@)    Addr of sksstmt pointer               00410000
*             +12- SKS row ID     Record SYSSKS RowID                   00420000
*                                                                       00430000
* EXIT:   Upon return from this routine R15 will contain one            00440000
*         of the following return codes:                                00450000
*                                                                       00460000
*             RC00 - Runtime SKS successfully loaded                    00470000
*             RC08 - Unable to retrieve SYSSKS row                      00480000
*             RC12 - Error constructing runtime SKS structure           00490000
*                                                                       00500000
**<DOC-OFF>*****************************************************        00510000
                                                                        00520000
         EJECT ,                                                        00530000
****************************************************************        00540000
*                                                                       00550000
* MAINTENANCE:                                                          00560000
*                                                                       00570000
*   10/22/93 Ron Colmone                                                00580000
*            Initial version                                            00590000
*                                                                       00600000
****************************************************************        00610000
                                                                        00620000
         EJECT ,                                                        00630000
         TBSERVIS GET             TABLE SERVICES                        00640000
                                                                        00650000
         EJECT ,                                                        00660000
         $SKS  ,                  SKS STATEMENT STRUCTURES              00670000
                                                                        00680000
         EJECT ,                                                        00690000
         NAV   ,                  NAVIGATION STRUCTURES                 00700000
                                                                        00710000
         EJECT ,                                                        00720000
         ICATALOG SKS             SYSSKS TABLE MAPPING                  00730000
                                                                        00740000
         EJECT ,                                                        00750000
         ABCODES ,                ABEND CODES                           00760000
                                                                        00770000
         EJECT ,                                                        00780000
         EQUS  ,                  GENERAL EQUATES                       00790000
                                                                        00800000
         EJECT ,                                                        00810000
         COPY  CRAB               "C"  RUNTIME ANCHOR BLOCK             00820000
         USING CRAB,R12           LIFETIME ADDRESSABILITY               00830000
                                                                        00840000
         EJECT ,                                                        00850000
         COPY  DSA                DYNAMIC SAVE AREA                     00860000
WORKDSA  DS    0D                 DSA USER SECTION                      00870000
WRK256   DS    XL256              GENERAL WORKAREA                      00880000
MFE_LIST DS    10F                PARAMETER LIST AREA                   00890000
RETCODE  DS    F                  RETURN CODE                           00900000
STATUS   DS    F                  STATUS RETURN CODE                    00910000
                                                                        00920000
FLAGS    DS    X                  FLAGS                                 00930000
$LOCKED  EQU   X'80'                PROJ MULTI-INSTANCE LOCK ACQUIRED   00940000
                                                                        00950000
SKSID    DS    F                  SYSSKS ROWID                          00960000
SKS@@    DS    A                  ADDRESS OF SKSSTMT POINTER            00970000
IMAGE@   DS    A                  ADDRESS OF IMAGE STRUCTURE            00980000
NVVAR@   DS    A                  ADDRESS OF VARIABLE LIST FOR IMAGE    00990000
STGQH@   DS    A                  ADDRESS OF STGMGR QUEUE HEADER        01000000
SYSSKS@  DS    A                  ADDRESS OF SYSSKS ROW                 01010000
SKSSTMT@ DS    A                  ADDRESS OF SKSSTMT ORIGIN             01020000
                                                                        01030000
SKSBUFF  DS    A,F                SKS BUFFER ADDR/LEN                   01040000
                                                                        01050000
WORKLEN  EQU   *-WORKDSA          LENGTH OF DSA USER SECTION            01060000
DSALEN   EQU   *-DSA              LENGTH OF DSA                         01070000
                                                                        01080000
         EJECT ,                                                        01090000
ISKSLOAD CSECT ,                                                        01100000
SKSLOAD  CENTRY DSA=DSALEN,INDEP=YES                                    01110000
         USING DSA,R13            ADDRESSABILITY                        01120000
                                                                        01130000
         LR    R8,R1              SAVE PARM ADDRESS                     01140000
                                                                        01150000
         LA    R0,WORKDSA         WORKAREA ORIGIN                       01160000
         LA    R1,WORKLEN         LENGTH OF WORKAREA                    01170000
         SR    R15,R15            PREPAREA FOR CLEAR                    01180000
         MVCL  R0,R14             CLEAR WORKAREA                        01190000
                                                                        01200000
         LM    R4,R8,0(R8)        OBTAIN PARMS                          01210000
         ST    R4,STGQH@          ADDRESS OF STORAGE QUEUE HEADER       01220000
         ST    R5,IMAGE@          ADDRESS OF IMAGE STRUCTURE            01230000
         ST    R6,NVVAR@          ADDRESS OF VARIABLE LIST FOR IMAGE    01240000
         ST    R7,SKS@@           ADDRESS OF SKSSTMT POINTER            01250000
         ST    R8,SKSID           SYSSKS ROWID                          01260000
                                                                        01270000
*---------------------------------------------------------------        01280000
*  RESTORE STANDARD ENVIRONMENT                                         01290000
*---------------------------------------------------------------        01300000
         @RESTENV ,                                                     01310000
         USING ICVT,R11           ADDRESSABILITY                        01320000
         USING ITASK,R10          ADDRESSABILITY                        01330000
                                                                        01340000
         L     R7,TSKPCBC         ADDRESS OF CURRENT PCB                01350000
         USING IPCB,R7            TEMP ADDRESSABILITY                   01360000
         L     R7,PCBUSER         ADDRESS OF CURRENT USER               01370000
         USING IUSER,R7           TEMP ADDRESSABILITY                   01380000
         L     R7,USRPROJ         ADDRESS OF PROJECT                    01390000
         USING IPROJ,R7           ADDRESSABILITY                        01400000
                                                                        01410000
         EJECT ,                                                        01420000
***************************************************************         01430000
*                                                                       01440000
*  ESTABLISH A RECOVERY ENVIRONMENT TO RELEASE PROJECT LOCK             01450000
*  SHOULD THE NAVIGATION DATA AREAS CONSTRUCTION LOGIC FAIL.            01460000
*                                                                       01470000
***************************************************************         01480000
                                                                        01490000
         $RCVRY CREATE,RECOVRTN,PARM=WORKDSA,MF=(E,MFE_LIST)            01500000
                                                                        01510000
***************************************************************         01520000
*                                                                       01530000
*  ACQUIRE PROJECT MULTIPLE INSTANCE LOCK                               01540000
*                                                                       01550000
***************************************************************         01560000
                                                                        01570000
         $SER  OBTAIN,LOCKPTR=PRJMILK                                   01580000
         CH    R15,=AL2(RC04)     LOCK ACQUIRED                         01590000
         BH    ABN_LOCK           FAILED                                01600000
         BE    LOADSKS            CONTINUE WITH IMAGE LOAD              01610000
         OI    FLAGS,$LOCKED      PROJ LOCK ACQUIRED                    01620000
                                                                        01630000
         EJECT ,                                                        01640000
***************************************************************         01650000
*                                                                       01660000
*  RETRIEVE SYSSKS ROW ASSOCIATED WITH ROWID                            01670000
*                                                                       01680000
***************************************************************         01690000
LOADSKS  DS    0H                                                       01700000
         L     R1,SKS@@           ADDRESS OF SKSSTMT POINTER            01710000
         ICM   R1,15,0(R1)        SKS ALREADY LOADED?                   01720000
         BNZ   RET_NORM           YES, RETURN                           01730000
                                                                        01740000
*--------------------------------------------------------------         01750000
*  RETRIEVE SYSSKS TABLE ROW                                            01760000
*--------------------------------------------------------------         01770000
         LA    R3,WRK256          TRIAL IMAGE BUFFER                    01780000
         LA    R4,L'WRK256        LENGTH OF TRIAL BUFFER                01790000
         ICM   R5,15,SKSID        SYSSKS KEY                            01800000
         BZ    NO_SKS             NO SKS,  ASSUME DEFAULT               01810000
                                                                        01820000
GETSKS   DS    0H                                                       01830000
         ST    R3,SYSSKS@         SAVE ADDR OF SYSSKS ROW               01840000
                                                                        01850000
         TBGET (R3),              ACQUIRE DESIGNATED SYSSKS            +01860000
               LENGTH=(R4),                                            +01870000
               POS=(R5),                                               +01880000
               TTOKEN=PRJTKSKS,                                        +01890000
               MF=(E,MFE_LIST)                                          01900000
                                                                        01910000
         C     R15,=A(RC04)       SYSSKS RETRIEVED ?                    01920000
         BH    ERR_SKS            ERROR, SKS NOT FOUND                  01930000
         BL    HAVE_SKS           OK,  CONTINUE WITH IMAGE BUILD        01940000
         LTR   R0,R0              INSUFFICIENT BUFFER SIZE?             01950000
         BZ    ERR_SKS            NO, ROW NOT FOUND                     01960000
                                                                        01970000
*--------------------------------------------------------------         01980000
*  INTERNAL TRIAL BUFFER IS NOT LARGE ENOUGH TO HOLD SKS,               01990000
*  REALLOCATE BUFFER FOR REQUIRED SIZE.                                 02000000
*--------------------------------------------------------------         02010000
         LR    R4,R0              STORAGE REQUIREMENT                   02020000
         L     R2,STGQH@          ADDRESS OF STG QUEUE HEADER           02030000
         STGGET (R4),QH=(R2)      ALLOC SKS BUFFER                      02040000
         LR    R3,R1              ADDRESS OF STORAGE                    02050000
         STM   R3,R4,SKSBUFF      SAVE SKS BUFFER INFO                  02060000
         B     GETSKS             RETRY ROW RETRIEVAL                   02070000
                                                                        02080000
         EJECT ,                                                        02090000
*--------------------------------------------------------------         02100000
*  SYSSKS HAS BEEN SUCCESSFULLY RETRIEVED, LOCATE SKS STATEMENT         02110000
*  ORIGIN.                                                              02120000
*--------------------------------------------------------------         02130000
HAVE_SKS DS    0H                                                       02140000
         L     R5,SYSSKS@         ADDRESS OF SKS RECORD                 02150000
         USING SYSSKS,R5          ADDRESSABILITY                        02160000
         L     R1,SSKSCRPT+4      ORIGIN OF SKS STATEMENT               02170000
         ST    R1,SKSSTMT@        RECORDED SKS ORIGIN                   02180000
         B     BLDSKS             BUILD RUNTIME SKS                     02190000
         DROP  R5                 SYSSKS                                02200000
                                                                        02210000
*--------------------------------------------------------------         02220000
*  NO SKS IS AVAILABLE IN RECORDING THIS NAVIGATION NODE ENRTY.         02230000
*  USE DUMMY SKS TO BUILD RUNTIME SKS.                                  02240000
*--------------------------------------------------------------         02250000
NO_SKS   DS    0H                                                       02260000
         LA    R1,DUMMYSKS        USE DUMMY SKS FOR BUILD               02270000
         ST    R1,SKSSTMT@        DUMMY SKS ORIGIN                      02280000
         B     BLDSKS             CONTINUE WITH BUILD                   02290000
                                                                        02300000
         EJECT ,                                                        02310000
***************************************************************         02320000
*                                                                       02330000
*  BUILD A RUNTIME SKS                                                  02340000
*                                                                       02350000
***************************************************************         02360000
BLDSKS   DS    0H                                                       02370000
         @CALL SKSBLD,(*STGQH@,*SKSSTMT@,*IMAGE@,*NVVAR@,STATUS),      +02380000
               MF=(E,MFE_LIST)                                          02390000
         LTR   R5,R15             SKS CONSTRUCTED?                      02400000
         BZ    ERR_SKSB           NO, SKS BUILD FAILED                  02410000
         L     R1,SKS@@           ADDRESS OF SKS POINTER                02420000
         ST    R5,0(,R1)          SAVE POINTER TO SKS                   02430000
                                                                        02440000
         EJECT ,                                                        02450000
***************************************************************         02460000
*                                                                       02470000
*  NORMAL AND ERROR COMPLETION ROUTINES                                 02480000
*                                                                       02490000
***************************************************************         02500000
RET_NORM DS    0H                                                       02510000
         LA    R15,RC00           NORMAL COMPLETION                     02520000
         ST    R15,RETCODE        SAVE RETURN CODE                      02530000
         B     FREEBUF            FREE STORAGE AND RELEASE LOCK         02540000
                                                                        02550000
ERR_SKS  DS    0H                                                       02560000
         LA    R15,RC08           SYSSKS NOT FOUND                      02570000
         ST    R15,RETCODE        SAVE RETURN CODE                      02580000
         B     FREEBUF            FREE STORAGE AND RELEASE LOCK         02590000
                                                                        02600000
ERR_SKSB DS    0H                                                       02610000
         LA    R15,RC12           SKS CONSTRUCTION FAILED               02620000
         ST    R15,RETCODE        SAVE RETURN CODE                      02630000
         B     FREEBUF            FREE STORAGE AND RELEASE LOCK         02640000
                                                                        02650000
***************************************************************         02660000
*                                                                       02670000
*  RELEASE SYSSKS BUFFER STORAGE                                        02680000
*                                                                       02690000
***************************************************************         02700000
FREEBUF  DS    0H                                                       02710000
         LM    R3,R4,SKSBUFF      ADDR/LEN OF SYSSKS BUFFER             02720000
         LTR   R3,R3              BUFFER ALLOCATED?                     02730000
         BZ    RELLOCK            NO, CONTINUE WITH LOCK RELEASE        02740000
         L     R2,STGQH@          ADDRESS OF STORAGE QUEUE HDR          02750000
                                                                        02760000
         STGRETN ADDR=(R3),LEN=(R4),QH=(R2)                             02770000
                                                                        02780000
***************************************************************         02790000
*                                                                       02800000
*  RELEASE LOCK ASSOCIATED WITH THE PROJECT IF PREV ACQUIRED            02810000
*                                                                       02820000
***************************************************************         02830000
RELLOCK  DS    0H                                                       02840000
         TM    FLAGS,$LOCKED      PROJ MULTI-INSTANCE LOCK ACQ          02850000
         BZ    DEL_RCVY           NO, DELETE RECOVERY ENVIRONMENT       02860000
                                                                        02870000
         $SER  RELEASE,LOCKPTR=PRJMILK                                  02880000
                                                                        02890000
***************************************************************         02900000
*                                                                       02910000
*  DELETE RECOVERY ENVIRONMENT                                          02920000
*                                                                       02930000
***************************************************************         02940000
DEL_RCVY DS    0H                                                       02950000
         $RCVRY DELETE,MF=(E,MFE_LIST)                                  02960000
                                                                        02970000
         EJECT ,                                                        02980000
***************************************************************         02990000
*                                                                       03000000
*  RETURN                                                               03010000
*                                                                       03020000
***************************************************************         03030000
RETURN   DS    0H                                                       03040000
         L     R15,RETCODE        RESTORE RETURN CODE                   03050000
         CEXIT RC=(R15)           RETURN                                03060000
                                                                        03070000
         EJECT ,                                                        03080000
***************************************************************         03090000
*                                                                       03100000
*   CATASTROPHIC ERRORS                                                 03110000
*                                                                       03120000
***************************************************************         03130000
                                                                        03140000
ABN_LOCK DS    0H                                                       03150000
         $ABEND ABE_PROJLOCK,TITLE='UNABLE TO ACQUIRE PROJ MI-LOCK'     03160000
                                                                        03170000
         EJECT                                                          03180000
***************************************************************         03190000
*                                                                       03200000
*   $RCVRY RECOVERY ROUTINE                                             03210000
*                                                                       03220000
***************************************************************         03230000
RECOVRTN DS    0H                                                       03240000
         PUSH  USING              PRESERVE STD ENVIRONMENT              03250000
         DROP  R13                PRECLUDE UNINTENTIONAL REFERENCES     03260000
         STM   R14,R12,12(R13)    SAVE ENTRANCE REGS                    03270000
                                                                        03280000
         LR    R3,R1              RESTORE ORIGINAL WORKAREA ADDR        03290000
         USING WORKDSA,R3         ADDRESSABILITY                        03300000
                                                                        03310000
         LA    R2,WRK256          WORKING STORAGE AREA                  03320000
         XC    0(72,R2),0(R2)     USER FOR SAVEAREA                     03330000
         ST    R2,8(,R13)         SA FWD CHAIN                          03340000
         ST    R13,4(,R2)         SA BWD CHAIN                          03350000
         LR    R13,R2             AVAIL FOR SERVICE ROUTINES            03360000
                                                                        03370000
*--------------------------------------------------------------         03380000
*   RELEASE PROJECT MIL IF HELD                                         03390000
*--------------------------------------------------------------         03400000
         TM    FLAGS,$LOCKED      PROJECT MIL HELD?                     03410000
         BNO   RECVPERC           SKIP IF NOT                           03420000
                                                                        03430000
         $SER  RELEASE,LOCKPTR=PRJMILK,COND=YES                         03440000
                                                                        03450000
         NI    FLAGS,FF-$LOCKED   INDICATE LOCK RELEASED                03460000
                                                                        03470000
*--------------------------------------------------------------         03480000
*   RETURN TO RECOVERY                                                  03490000
*--------------------------------------------------------------         03500000
RECVPERC DS    0H                 PERCOLATE                             03510000
         LA    R15,RC00                                                 03520000
                                                                        03530000
         L     R13,4(,R13)                                              03540000
         L     R14,12(,R13)                                             03550000
         LM    R0,R12,20(R13)                                           03560000
         BR    R14                                                      03570000
                                                                        03580000
         EJECT ,                                                        03590000
****************************************************************        03600000
*                                                                       03610000
*  LITERALS AND CONSTANTS                                               03620000
*                                                                       03630000
****************************************************************        03640000
         LTORG ,                                                        03650000
                                                                        03660000
DUMMYSKS DC    AL1($SKSV_END),AL3(0)       DUMMY SKS,  (END VERB)       03670000
                                                                        03680000
         PRINT NOGEN                                                    03690000
         ICVT  ,                                                        03700000
         ITASK ,                                                        03710000
         IPCB  ,                                                        03720000
         IUSER ,                                                        03730000
         IPROJ ,                                                        03740000
         IHAPSA ,                                                       03750000
         IKJTCB ,                                                       03760000
         PRINT GEN                                                      03770000
                                                                        03780000
         END   ,                                                        03790000

IRMXSRM  TITLE 'IRMXSRM - RELEASE SRM MANAGED RESOURCE'                 00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE: IRMXSRM - Release SRM managed resource                       00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*   This routine is entered as a $RESMGR resource manager rtn           00080000
*   in the event of an abend in a workunit that has used                00090000
*   the $SRM facility to acquire shared access to some                  00100000
*   resource.  If this workunit $SRM CREATEd the resource it            00110000
*   may also have established a distinct resource manager that          00120000
*   performs the same function as the $SRM DESTRUCTOR=                  00130000
*   routine.  If so, that resource manager is deleted upon              00140000
*   completion of the $SRM RELEASE request issued by this               00150000
*   routine.                                                            00160000
*                                                                       00170000
*                                                                       00180000
* ON ENTRY:                                                             00190000
*                                                                       00200000
*   R1  contains the address of the resource identifier as              00210000
*       described by the SRMRID mapping acquired from $SRM              00220000
*                                                                       00230000
*                                                                       00240000
* ON EXIT:                                                              00250000
*                                                                       00260000
*   R15 contains the $SRM RELEASE function return code                  00270000
*                                                                       00280000
**<DOC-ON>******************************************************        00290000
                                                                        00300000
         EJECT ,                                                        00310000
****************************************************************        00320000
*                                                                       00330000
* MAINTENANCE:                                                          00340000
*                                                                       00350000
*   08/16/94  R. Turgeon                                                00360000
*             Initial version                                           00370000
*                                                                       00380000
****************************************************************        00390000
                                                                        00400000
         EJECT                                                          00410000
         #WORK ,                                                        00420000
                                                                        00430000
$RESMFL  $RESMGR MF=L        $RESMGR REQUEST PLIST                      00440000
$SRMMFL  $SRM    MF=L        $SRM    REQUEST PLIST                      00450001
                                                                        00460001
         #ENDWORK ,                                                     00470000
                                                                        00480000
         EJECT                                                          00490000
         $RESMGR DSECT=YES   RESOURCE MANAGER PLIST FORMAT              00500000
                                                                        00510000
         EJECT                                                          00520000
         $SRM   DSECT=YES    REQUEST BLOCK                              00530000
                                                                        00540000
         EJECT                                                          00550000
         EQUS  ,                                                        00560000
                                                                        00570000
         EJECT ,                                                        00580000
IRMXSRM  #ENTER PREG=R8                                                 00590000
                                                                        00600000
****************************************************************        00610000
*                                                                       00620000
*   RELEASE THE INDICATED RESOURCE                                      00630000
*                                                                       00640000
****************************************************************        00650000
         USING SRMRID,R8          RESOURCE IDENTIFIER                   00660000
                                                                        00670000
         $SRM  RELEASE,RSRCID=SRMRID,MF=(E,$SRMMFL)                     00680001
                                                                        00690000
         BNZ   RETURN             SKIP DEQUEUE IF FAILS                 00700000
                                                                        00710000
****************************************************************        00720000
*                                                                       00730000
*   REMOVE THE ORIGINAL RMX IF NOT YET DELETED                          00740000
*                                                                       00750000
****************************************************************        00760000
         ICM   R2,15,SRMRMXTK     RMX POSSIBLY ACTIVE?                  00770000
         BZ    NORMRET            DONE IF NOT                           00780000
                                                                        00790000
         $RESMGR DELETE,          DELETE PREVIOUS RESOURCE MGR         X00800000
               TOKEN=(R2),        POINTER TO TOKEN IN USER STORAGE     X00810000
               OWNER=*SRMOWNER,                                        X00820000
               MF=(E,$RESMFL)                                           00830000
                                                                        00840000
****************************************************************        00850000
*                                                                       00860000
*   RETURN TO RESMGR SCHEDULER                                          00870000
*                                                                       00880000
****************************************************************        00890000
NORMRET  DS    0H                                                       00900000
         LA    R15,RC00           NOT CONCERNED ABOUT RESMGR            00910000
                                                                        00920000
RETURN   DS    0H                                                       00930000
         #EXIT ,                  RETURN                                00940000
                                                                        00950000
         EJECT                                                          00960000
****************************************************************        00970000
*                                                                       00980000
*  LITERAL, CONSTANTS  AND MAPPINGS                                     00990000
*                                                                       01000000
****************************************************************        01010000
         LTORG ,                                                        01020000
                                                                        01030000
         PRINT NOGEN                                                    01040000
         ICVT  ,                                                        01050000
         ITASK ,                                                        01060000
         END   ,                                                        01070000

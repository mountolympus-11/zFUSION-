ILU2APEU TITLE 'INTEGRATOR - LU2 SESSION IMAGE EAU COMMAND'             00010000
                                                                        00020000
**<DOC-ON>************************************************************* 00030000
*                                                                       00040000
* ROUTINE: ILU2APEU - INTEGRATOR SESSION IMAGE EAU COMMAND              00050000
*                                                                       00060000
* DESCRIPTION: THIS ROUTINE IS CALLED TO PROCESS A 3270 EAU             00070000
*              COMMAND SENT BY THE HOST APPLICATION.                    00080000
*              IT IS CALLED BY ILU2APWR OR ILU2APSF WHEN AN EAU         00090000
*              COMMAND IS ENCOUNTERED.                                  00100000
*                                                                       00110000
* ON ENTRY:                                                             00120000
*                                                                       00130000
*    R15 = ENTRY POINT ADDRESS                                          00140000
*    R14 = RETURN ADDRESS                                               00150000
*    R13 = AVAILABLE SAVE AREA                                          00160000
*    R11 = ICVT ADDRESS                                                 00170000
*    R10 = ITASK ADDRESS                                                00180000
*    R01 = SESSIMAG ADDRESS                                             00190000
*                                                                       00200000
* ON EXIT:                                                              00210000
*                                                                       00220000
*    R15 = 0 --> INPUT SUCCESSFULLY PROCESSED, SEND POSITIVE RESPONSE   00230000
*    R00 = 0                                                            00240000
*    R01 = 0                                                            00250000
*                                                                       00260000
*    ALL OTHER REGISTERS ARE RESTORED.                                  00270000
*                                                                       00280000
**<DOC-OFF>************************************************************ 00290000
                                                                        00300000
*********************************************************************** 00310000
*                                                                       00320000
* MAINTENANCE:                                                          00330000
*                                                                       00340000
*   10/01/93 RANDY WITEK                                                00350000
*                                                                       00360000
*********************************************************************** 00370000
                                                                        00380000
         EQUS  ,                  GENERAL EQUATES                       00390000
                                                                        00400000
RICVT    EQU   R11                                                      00410000
RITASK   EQU   R10                                                      00420000
RIVTAM   EQU   R9                                                       00430000
RSESSIMG EQU   R8                                                       00440000
RIMAGE   EQU   R6                                                       00450000
                                                                        00460000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00470000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00480000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00490000
         USING SESSIMAG,RSESSIMG  ESTABLISH ADDRESSABILITY              00500000
                                                                        00510000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00520000
WRK256   DS    XL256              GENERAL WORKAREA                      00530000
                                                                        00540000
RETR15   DS    F                                                        00550000
RETR0    DS    F                                                        00560000
RETR1    DS    F                                                        00570000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00580000
                                                                        00590000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00600000
                                                                        00610000
         $MSGDFT PREFIX=ICTPID,                                        +00620000
               COMPID='LU2',                                           +00630000
               TABLE=*#MSGS,                                           +00640000
               WORKA=0,                                                +00650000
               MF=(E,WRK256),                                          +00660000
               PRINT=NOGEN                                              00670000
                                                                        00680000
ILU2APEU #ENTER BASE=R12,                                              +00690000
               PREG=(RSESSIMG),         R1->RSESSIMG                   +00700000
               AMODE=31,                                               +00710000
               RMODE=ANY                                                00720000
                                                                        00730000
*---------------------------------------------------------------------- 00740000
* INITIALIZE                                                            00750000
*---------------------------------------------------------------------- 00760000
                                                                        00770000
         L     RIVTAM,ICTVTCVT     VTAM CVT                             00780000
         L     RIMAGE,SEIS1IMG     IMAGE ORIGIN                         00790000
         SR    R15,R15             MVCL 0 PAD AND 0 COPY-FROM LENGTH    00800000
         XC    SEISCSR,SEISCSR     HOME THE CURSOR                      00810000
         MVI   SEIAID,#3270NUL     AID IS RESET                         00820000
         OI    SEIFSNA,SEIF_KBR    KEYBOARD IS RESTORED                 00830000
                                                                        00840000
*---------------------------------------------------------------------- 00850000
* SHOW THAT THE IMAGE WAS MODIFIED                                      00860000
*---------------------------------------------------------------------- 00870000
                                                                        00880000
         OI    SEIONCE,SEIO_INP    IMAGE WAS MODIFIED                   00890000
                                                                        00900000
*---------------------------------------------------------------------- 00910000
* PERFORM AN ERASE-ALL-UNPROTECTED (EAU) COMMAND OPERATION ON THE IMAGE 00920000
*---------------------------------------------------------------------- 00930000
                                                                        00940000
*                                                                       00950000
* IF THERE ARE NO FIELDS, CLEAR THE IMAGE AND HOME THE CURSOR           00960000
*---------------------------------------------------------------------- 00970000
                                                                        00980000
         ICM   R2,15,SEIS1FLV      FIELD VECTORS                        00990000
         BZ    UNFORMTD            BRANCH IF NO VECTORS                 01000000
         LH    R3,0(,R2)           FIELD COUNT                          01010000
         LA    R2,2(,R2)           ADDRESS OF FIRST FIELD OFFSET        01020000
         LTR   R3,R3               ARE THERE ANY FIELDS?                01030000
         BNZ   NEXTFLD             BRANCH IF YES                        01040000
                                                                        01050000
UNFORMTD DS    0H                                                       01060000
                                                                        01070000
         L     R7,SEIS1SIZ         LENGTH OF IMAGE                      01080000
         MVCL  RIMAGE,R14          CLEAR THE IMAGE                      01090000
         B     RETURN              RETURN TO CALLER                     01100000
                                                                        01110000
*                                                                       01120000
* SCREEN IS FORMATTED.  CLEAR UNPROTECTED FIELDS & POSITION CURSOR      01130000
*---------------------------------------------------------------------- 01140000
                                                                        01150000
NEXTFLD  DS    0H                                                       01160000
                                                                        01170000
         LH    R4,0(,R2)           FIELD OFFSET                         01180000
         AR    R4,RIMAGE           ATTRIBUTE ADDRESS                    01190000
         TM    0(R4),#3270PRO      IS FIELD PROTECTED?                  01200000
         BNZ   SKIPFLD             BRANCH IF YES                        01210000
         NI    0(R4),255-#3270MDT  TURN MDT OFF                         01220000
         LH    R5,2(,R2)           OFFSET OF FOLLOWING FIELD            01230000
         SH    R5,0(,R2)           LENGTH OF CURRENT FIELD              01240000
         BCTR  R5,0                MINUS THE ATTRIBUTE BYTE             01250000
         LA    R4,1(,R4)           ADDRESS OF FIELD DATA                01260000
         LR    R1,R4               SAVE ADDRESS OF FIELD DATA           01270000
         MVCL  R4,R14              CLEAR THE UNPROTECTED FIELD          01280000
         OC    SEISCSR,SEISCSR     HAS CURSOR BEEN SET?                 01290000
         BNZ   SKIPFLD             BRANCH IF YES                        01300000
         SR    R1,RIMAGE           OFFSET OF FIELD DATA                 01310000
         C     R1,SEIS1SIZ         IS 1ST UNPROT. IN BOTTOM RIGHT?      01320000
         BNL   SKIPFLD             BRANCH IF YES, 0 IS CORRECT          01330000
         ST    R1,SEISCSR          SET FINAL CURSOR POSITION            01340000
                                                                        01350000
SKIPFLD  DS    0H                                                       01360000
                                                                        01370000
         LA    R2,2(,R2)           ADDRESS NEXT FIELD VECTOR            01380000
         BCT   R3,NEXTFLD          GO CHECK NEXT FIELD                  01390000
                                                                        01400000
         L     R1,SEIS1FLV         FIELD VECTORS                        01410000
         LH    R1,2(,R1)           OFFSET OF 1ST FIELD                  01420000
         LTR   R1,R1               IS THERE DATA AT POSITION 0?         01430000
         BZ    RETURN              BRANCH IF NOT, ALL DONE              01440000
         BCTR  R2,0                ADDRESS OF LAST FIELD VECTOR         01450000
         BCTR  R2,0                ADDRESS OF LAST FIELD VECTOR         01460000
         LH    R4,0(,R2)           OFFSET OF LAST FIELD                 01470000
         AR    R4,RIMAGE           ADDRESS OF LAST FIELD ATTRIBUTE      01480000
         TM    0(R4),#3270PRO      IS FIELD PROTECTED?                  01490000
         BNZ   RETURN              BRANCH IF YES, ALL DONE              01500000
         LR    R0,RIMAGE           ADDRESS OF POSITION 0                01510000
         MVCL  R0,R14              CLEAR THE FIELD SEGMENT AT LOC. 0    01520000
                                                                        01530000
*---------------------------------------------------------------------- 01540000
* RETURN TO CALLER                                                      01550000
*---------------------------------------------------------------------- 01560000
                                                                        01570000
RETURN   DS    0H                                                       01580000
                                                                        01590000
         LM    R15,R1,RETREGS     LOAD RETURN VALUES                    01600000
                                                                        01610000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    01620000
                                                                        01630000
*---------------------------------------------------------------------- 01640000
*  CONSTANTS AND LITERALS                                               01650000
*---------------------------------------------------------------------- 01660000
                                                                        01670000
         LTORG ,                                                        01680000
         PRINT NOGEN                                                    01690000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                01700000
         ISTDBIND ,               VTAM BIND IMAGE                       01710000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         01720000
         SESSIMAG ,               INTEGRATOR LU2 IMAGE BLOCK            01730000
         ICVT  ,                  INTEGRATOR CVT                        01740000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   01750000
         ITASK ,                  INTEGRATOR TASK BLOCK                 01760000
         ISESS ,                  INTEGRATOR ISESS BLOCK                01770000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       01780000
         EVCODES ,                INTEGRATOR EVENT CODES                01790000
         ABCODES ,                INTEGRATOR $ABEND CODES               01800000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     01810000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        01820000
         END   ,                                                        01830000

ICPIACCP TITLE 'INTEGRATOR - CPIC CMACCP API - ACCEPT CONVERSATION'     00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: ICPIACCP - CPIC CMACCP API                                   00100000
*                                                                       00110000
* DESCRIPTION:                                                          00120000
*                                                                       00130000
*    THIS ROUTINE IS CALLED TO PROCESS THE CMACCP VERB.                 00140000
*                                                                       00150000
* ON ENTRY:                                                             00160000
*                                                                       00170000
*    R15 = ENTRY POINT ADDRESS                                          00180000
*    R14 = RETURN      ADDRESS                                          00190000
*    R13 = SAVE AREA   ADDRESS                                          00200000
*    R01 = PARM LIST   ADDRESS                                          00210000
*                                                                       00220000
*          +00 = ADDRESS OF CONVERSATION_ID (RETURN AREA)               00230000
*          +04 = ADDRESS OF RETURN_CODE     (RETURN AREA)               00240000
*                                                                       00250000
* ON EXIT:                                                              00260000
*                                                                       00270000
*    R15 = 0                                                            00280000
*                                                                       00290000
*    RETURN_CODE = CM_OK                     --> CMACCP SUCCESSFUL      00300000
*                = CM_PROGRAM_STATE_CHECK    --> NO CONV AVAILABLE      00310000
*                = CM_PRODUCT_SPECIFIC_ERROR --> BAD PARM               00320000
*                                                                       00330000
**<DOC-OFF>************************************************************ 00340000
         EJECT ,                                                        00350000
*********************************************************************** 00360000
*                                                                       00370000
* MAINTENANCE:                                                          00380000
*                                                                       00390000
*   07/01/94 RANDY WITEK                                                00400000
*                                                                       00410000
*********************************************************************** 00420000
                                                                        00430000
         EQUS  ,                  GENERAL EQUATES                       00440000
                                                                        00450000
RICVT    EQU   R11                                                      00460000
RITASK   EQU   R10                                                      00470000
RBASE    EQU   R9                                                       00480000
RIVTAM   EQU   R8                                                       00490000
RCMLIST  EQU   R7                                                       00500000
RTKB     EQU   R6                                                       00510000
RRCB     EQU   R5                                                       00520000
                                                                        00530000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00540000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00550000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00560000
         USING CMLIST,RCMLIST     ESTABLISH ADDRESSABILITY              00570000
         USING TKB,RTKB           ESTABLISH ADDRESSABILITY              00580000
         USING RCB,RRCB           ESTABLISH ADDRESSABILITY              00590000
                                                                        00600000
         COPY  CRAB               "C" RUNTIME ANCHOR BLOCK              00610000
         USING CRAB,R12           ADDRESSABILITY                        00620000
                                                                        00630000
         COPY  DSA                DYNAMIC SAVE AREA                     00640000
WORKAREA DS    0H                 READ/WRITE WORKAREA                   00650000
WRK256   DS    XL256              GENERAL WORKAREA                      00660000
                                                                        00670000
CONVID   DS    XL8                TEMPORARY CONVERSATION ID AREA        00680000
RETCODE  DS    F                  TEMPORARY RETURN CODE     AREA        00690000
CONVS    DS    F                  TEMPORARY CONV STATE      AREA        00700000
                                                                        00710000
FLAG     DS    X                                                        00720000
FLAGIERR EQU   X'80'                                                    00730000
WORKLEN  EQU   *-WORKAREA         LENGTH OF USER DSA AREA               00740000
DSALEN   EQU   *-DSA              LENGTH OF DSA                         00750000
                                                                        00760000
         $MSGDFT PREFIX=ICTPID,                                        +00770000
               COMPID='CPI',                                           +00780000
               TABLE=*#MSGS,                                           +00790000
               WORKA=0,                                                +00800000
               MF=(E,WRK256),                                          +00810000
               PRINT=NOGEN                                              00820000
                                                                        00830000
ICPACCP@ CSECT ,                                                        00840000
ICPIACCP CENTRY DSA=DSALEN,BASE=RBASE,INDEP=YES                         00850000
                                                                        00860000
*---------------------------------------------------------------------- 00870000
* ENTRY                                                                 00880000
*---------------------------------------------------------------------- 00890000
                                                                        00900000
         USING DSA,R13            ADDRESSABILITY                        00910000
         LR    RCMLIST,R1         SAVE ADDRESS OF PLIST                 00920000
                                                                        00930000
         LA    R0,WORKAREA        ADDRESS OF USER DSA SECTION           00940000
         LA    R1,WORKLEN         LENGTH  OF USER DSA SECTION           00950000
         SR    R15,R15            PREPARE FOR CLEAR                     00960000
         MVCL  R0,R14             CLEAR USER DSA SECTION                00970000
                                                                        00980000
*---------------------------------------------------------------------- 00990000
* INITIALIZATION                                                        01000000
*---------------------------------------------------------------------- 01010000
                                                                        01020000
         @RESTENV ,               ENSURE ENVIRONMENT                    01030000
                                                                        01040000
         L     RIVTAM,ICTVTCVT    ESTABLISH IVTAMCVT POINTER            01050000
                                                                        01060000
         MVC   CONVID,=XL8'55AA55AA55AA55AA'                            01070000
         MVC   CONVS,=XL4'55AA55AA55AA55AA'                             01080000
                                                                        01090000
         ICM   R1,15,CMLPARM1     ADDRESS OF CONVERSATION ID            01100000
         BNP   INITERR            BRANCH IF BAD                         01110000
         MVC   0(8,R1),0(R1)      TEST MOVEMENT                         01120000
                                                                        01130000
         L     R1,CMLPARM2        ADDRESS OF RETURN_CODE AREA           01140000
         LA    R1,0(,R1)          CLEAR POSSIBLE HI BIT                 01150000
         LTR   R1,R1              TEST ADDRESS                          01160000
         BNP   INITERR            BRANCH IF BAD                         01170000
         MVC   0(4,R1),0(R1)      TEST MOVEMENT                         01180000
         B     INITEND                                                  01190000
                                                                        01200000
INITERR  DS    0H                                                       01210000
                                                                        01220000
         OI    FLAG,FLAGIERR      REMEMBER ERROR DETECTED               01230000
                                                                        01240000
INITEND  DS    0H                                                       01250000
                                                                        01260000
*---------------------------------------------------------------------- 01270000
* ENTRY TRACE                                                           01280000
*---------------------------------------------------------------------- 01290000
                                                                        01300000
         $TRACE *=A(TRC_CPIC_ICPIACCP),48 TRACE ENTRY W/ 48 USER BYTES  01310000
         BNZ   NOETRACE                   BRANCH IF NOT TRACING         01320000
         $APITRC ICPIACCP                 TRACE COMMON STUFF            01330000
         ST    RCMLIST,24(,R1)            TRACE PARMLIST ADDRESS        01340000
         MVC   32(8,R1),CONVID            TRACE CONVERSATION ID         01350000
NOETRACE DS    0H                                                       01360000
                                                                        01370000
*---------------------------------------------------------------------- 01380000
* LOCATE THE CONVERSATION WAITING FOR ACCEPTANCE                        01390000
*---------------------------------------------------------------------- 01400000
                                                                        01410000
         TM    FLAG,FLAGIERR             ERROR DETECTED ALREADY?        01420000
         BO    ERRPROD                   BRANCH IF YES                  01430000
                                                                        01440000
         ICM   R1,15,TSKPCBC             OUR IPCB                       01450000
         BZ    ERRSTATE                  BRANCH IF NO IPCB              01460000
         ICM   RTKB,15,PCBIVTAM-IPCB(R1) OUR TKB                        01470000
         BNP   ERRSTATE                  BRANCH IF NO TKB               01480000
         CLC   TKBID,=CL8'TKB'           EYECATCHER PRESENT?            01490000
         BNE   ERRSTATE                  BRANCH IF NOT                  01500000
         LA    RRCB,TKBRC1ST             FIRST RCB ANCHOR POINT         01510000
         S     RRCB,=A(RCBNEXT-RCB)      NORMALIZE FOR CHAIN RUN        01520000
                                                                        01530000
FINDCONV DS    0H                                                       01540000
                                                                        01550000
         ICM   RRCB,15,RCBNEXT            LINK TO NEXT RCB              01560000
         BNP   ERRSTATE                   BRANCH IF CONV NOT FOUND      01570000
         CLC   RCBCONVS,=A(CM_NULL_STATE) INCOMING CONVERSATION?        01580000
         BNE   FINDCONV                   BRANCH IF NOT                 01590000
                                                                        01600000
*---------------------------------------------------------------------- 01610000
* CONVERSATION LOCATED.  UPDATE STATE AND PASS CONVID BACK.             01620000
*---------------------------------------------------------------------- 01630000
                                                                        01640000
         L     R3,TSKPCBC               CURRENT PCB                     01650000
X        USING IPCB,R3                                                  01660000
                                                                        01670000
         $MSG  002,                     "CONV CMACCP...'               +01680000
               FIELDS=((RTKB),          TKB ADDRESS                    +01690000
               (RRCB),                  RCB ADDRESS                    +01700000
               (RCBHSID,4),             SESSION TOKEN                  +01710000
               (RCBHSID+4,4),           SESSION TOKEN                  +01720000
               (TSKNAME,8),             ITASK NAME                     +01730000
               (RITASK),                ITASK ADDRESS                  +01740000
               (X.PCBNAME,8),           IPCB  NAME                     +01750000
               (R3),                    IPCB  ADDRESS                  +01760000
               (RCBCNVID,4),            CONVERSATION ID                +01770000
               (RCBCNVID+4,4),          CONVERSATION ID                +01780000
               (TKBOWNLU,8),            OUR ACB NAME                   +01790000
               (RCBLUNM,17),            PARTNER LU NAME                +01800000
               (RCBMDNM,8),             MODE NAME                      +01810000
               (TKBTPN,64))             TP NAME                         01820000
                                                                        01830000
         DROP  X                                                        01840000
                                                                        01850000
         MVC   CONVID,RCBCNVID           SET TO RETURN CONVID           01860000
         MVC   RCBCONVS,=A(CM_RECEIVE_STATE)                            01870000
         MVC   CONVS,RCBCONVS                                           01880000
         B     RETURN                                                   01890000
                                                                        01900000
*---------------------------------------------------------------------- 01910000
* EXCEPTION ROUTINES                                                    01920000
*---------------------------------------------------------------------- 01930000
                                                                        01940000
ERRSTATE DS    0H                                                       01950000
                                                                        01960000
         MVC   RETCODE,=A(CM_PROGRAM_STATE_CHECK)                       01970000
         B     RETURN                                                   01980000
                                                                        01990000
ERRPROD  DS    0H                                                       02000000
                                                                        02010000
         MVC   RETCODE,=A(CM_PRODUCT_SPECIFIC_ERROR)                    02020000
         B     RETURN                                                   02030000
                                                                        02040000
*---------------------------------------------------------------------- 02050000
* EXIT TRACE AND RETURN TO CALLER                                       02060000
*---------------------------------------------------------------------- 02070000
                                                                        02080000
RETURN   DS    0H                                                       02090000
                                                                        02100000
         $TRACE *=A(TRC_CPIC_EXIT),48 TRACE ENTRY                       02110000
         BNZ   NOXTRACE               BRANCH IF TRACING NOT AVAILABLE   02120000
         MVC   0(8,R1),=CL8'ICPIACCP' MODULE NAME                       02130000
         MVC   8(4,R1),RETCODE        RETURN_CODE VALUE                 02140000
         MVC   12(8,R1),CONVID        CONVERSATION ID                   02150000
         MVC   20(4,R1),CONVS         CONVERSATION STATE                02160000
NOXTRACE DS    0H                                                       02170000
                                                                        02180000
         L     R1,CMLPARM2        ADDRESS OF RETURN_CODE AREA           02190000
         MVC   0(4,R1),RETCODE    SET RETURN_CODE VARIABLE              02200000
         CLC   RETCODE,=A(CM_OK)  GOOD RC?                              02210000
         BNE   EXIT               BRANCH IF NOT                         02220000
                                                                        02230000
         L     R1,CMLPARM1        ADDRESS OF CONV_ID RETURN AREA        02240000
         MVC   0(8,R1),CONVID     SET CONV_ID VARIABLE                  02250000
                                                                        02260000
EXIT     DS    0H                                                       02270000
                                                                        02280000
         SR    R15,R15            FUNCTION RETURN CODE = 0              02290000
         CEXIT RC=(R15),INDEP=YES RETURN                                02300000
                                                                        02310000
*---------------------------------------------------------------------- 02320000
* LITERALS AND CONSTANTS                                                02330000
*---------------------------------------------------------------------- 02340000
                                                                        02350000
         LTORG ,                                                        02360000
                                                                        02370000
         PRINT NOGEN                                                    02380000
         ISTDBIND ,               VTAM BIND IMAGE                       02390000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                02400000
         IKJTCB ,                 MVS TASK CONTROL BLOCK                02410000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         02420000
         ICVT  ,                  INTEGRATOR CVT                        02430000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   02440000
         ITASK ,                  INTEGRATOR TASK BLOCK                 02450000
         IPCB ,                   INTEGRATOR PROCESS BLOCK              02460000
         ABCODES ,                INTEGRATOR $ABEND CODES               02470000
         EVCODES ,                INTEGRATOR EVENT CODES                02480000
         END   ,                                                        02490000

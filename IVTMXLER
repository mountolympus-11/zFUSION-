IVTMXLER TITLE 'INTEGRATOR - VTAM LERAD EXIT'                           00010000
**<DOC-ON>************************************************************* 00020000
*                                                                       00030000
* ROUTINE: IVTMXLER - INTEGRATOR VTAM LERAD EXIT                        00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THE LERAD EXIT IS INVOKED SYNCHRONOUSLY WHEN A LOGICAL             00080000
*    ERROR IS DETECTED BY VTAM. A WORK ELEMENT IS CREATED TO            00090000
*    CAUSE A DIAGNOSTIC MESSAGE TO BE ISSUED FROM THE VTAM              00100000
*    MAIN TASK.                                                         00110000
*                                                                       00120000
* ON ENTRY:                                                             00130000
*                                                                       00140000
*    BAKR IS USED TO SAVE REGISTERS                                     00150000
*                                                                       00160000
*    R15 = ENTRY POINT ADDRESS                                          00170000
*    R14 = RETURN ADDRESS                                               00180000
*    R13 = SAVE AREA AT TIME OF ERROR                                   00190000
*    R01 = RPL ADDRESS ASSOCIATED WITH THE ERROR                        00200000
*    R00 = RECOVERY ACTION RETURN CODE                                  00210000
*          X'14' - LOGIC ERROR                                          00220000
*          X'18' - LOGIC ERROR & RPL (R01) NOT VALID                    00230000
*          OTHER - RPL OVERWRITTEN                                      00240000
*                                                                       00250000
* ON EXIT:                                                              00260000
*                                                                       00270000
*    R15 = 4                                                            00280000
*    R00 = RPLRTNCD                                                     00290000
*    R01 = 0                                                            00300000
*                                                                       00310000
*    ALL OTHER REGISTER CONTENTS ARE RESTORED BY PR.                    00320000
*                                                                       00330000
**<DOC-OFF>************************************************************ 00340000
                                                                        00350000
         EJECT ,                                                        00360000
*********************************************************************** 00370000
*                                                                       00380000
* MAINTENANCE:                                                          00390000
*                                                                       00400000
*   08/01/93 RANDY WITEK                                                00410000
*                                                                       00420000
*********************************************************************** 00430000
         EQUS  ,                  GENERAL EQUATES                       00440000
                                                                        00450000
RICVT    EQU   R11                INTEGRATOR CVT POINTER                00460000
RITASK   EQU   R10                ASSOCIATED ITASK POINTER              00470000
RIVTAM   EQU   R9                 INTEGRATOR VTAM CVT POINTER           00480000
RIACB    EQU   R8                 ASSOCIATED IACB POINTER               00490000
RIRPL    EQU   R7                 ASSOCIATED RPL/IRPL POINTER           00500000
RISESS   EQU   R6                 ASSOCIATED ISESS POINTER              00510000
RIWE     EQU   R5                 WORK ELEMENT POINTER                  00520000
                                                                        00530000
         USING ICVT,RICVT         ESTABLISH ADDRESSIBILTY               00540000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSIBILTY               00550000
         USING ITASK,RITASK       ESTABLISH ADDRESSIBILTY               00560000
         USING IACB,RIACB         ESTABLISH ADDRESSIBILTY               00570000
         USING IRPL,RIRPL         ESTABLISH ADDRESSIBILTY               00580000
         USING IWEVTAM,RIWE       ESTABLISH ADDRESSIBILTY               00590000
         USING ISESS,RISESS       ESTABLISH ADDRESSIBILTY               00600000
                                                                        00610000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00620000
         DS    0D                                                       00630000
RCVPARMS DS    XL(L'IVR)          IVTAMRPA STORAGE                      00640000
ESTAEMFL DS    XL(L'ESTAEXPL)     PARMLIST CONSTRUCTION                 00650000
FRRPARM  DS    A                  RETURN AREA FOR FRR PARM ADDRESS      00660000
RETR15   DS    F                  RETURN CODE VALUE                     00670000
RETR0    DS    F                  RETURN REGISTER 0                     00680000
RETR1    DS    F                  RETURN REGISTER 1                     00690000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00700000
FLAG     DS    X                                                        00710000
FLESTAEX EQU   X'08'              ESTAEX ACTIVE                         00720000
FLFRR    EQU   X'04'              FRR    ACTIVE                         00730000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00740000
                                                                        00750000
IVTMXLER #VTENTER BASE=R12,       VTAM EXIT ROUTINE LINKAGE            +00760000
               AMODE=31,                                               +00770000
               RMODE=ANY,                                              +00780000
               PREG=(R3,R4),                                           +00790000
               EXITYPE=RPL                                              00800000
                                                                        00810000
         USING IVTAMRPA,RCVPARMS  ESTABLISH ADDRESSIBILITY              00820000
                                                                        00830000
*---------------------------------------------------------------------- 00840000
* ESTABLISH RECOVERY ENVIRONMENT                                        00850000
*---------------------------------------------------------------------- 00860000
                                                                        00870000
         LA    R15,IVTXRTRY       RETRY ROUTINE ADDRESS                 00880000
         ST    R15,IVRRETAD       SET RETRY ROUTINE ADDRESS             00890000
         LA    R15,IVTAMRPA       PARAMETERS ADDRESS                    00900000
         ST    R15,IVRRPA@        SET ADDRESS FOR FRR                   00910000
         L     R0,=F'-1'          SHOW REGS RESTORED FROM PARM AREA     00920000
         STM   R0,R15,IVRR00      SAVE RETRY REGISTERS                  00930000
         MVC   IVRMOD,=CL8'IVTMTASK'                                    00940000
         MVC   IVRCSECT,=CL8'IVTMXLER'                                  00950000
         MVC   IVRFRR,=CL8'IVTMXRCV'                                    00960000
         MVC   IVRTYPE,=CL8'ESTAEX'                                     00970000
         L     R3,=V(IVTMXRCV)    ADDR OF VTAM EXIT RECOVERY ROUTINE    00980000
         ICM   R0,15,PSATOLD      SRB MODE?                             00990000
         BZ    ESTFRR             BRANCH IF YES                         01000000
                                                                        01010000
         MVC   ESTAEMFL(L'ESTAEXPL),ESTAEXL                             01020000
                                                                        01030000
         ESTAEX (R3),                                                  +01040000
               CT,                                                     +01050000
               PARAM=RCVPARMS,                                         +01060000
               TERM=YES,                                               +01070000
               MF=(E,ESTAEMFL)    ESTABLISH RECOVERY                    01080000
                                                                        01090000
         OI    FLAG,FLESTAEX      RECOVERY ENVIRONMENT ESTABLISHED      01100000
         B     RECOVSET           AND CONTINUE                          01110000
                                                                        01120000
ESTFRR   DS    0H                                                       01130000
                                                                        01140000
         MVC   IVRTYPE,=CL8'FRR'                                        01150000
                                                                        01160000
         MODESET EXTKEY=ZERO,                                          +01170000
               SAVEKEY=(2)        SET KEY ZERO                          01180000
                                                                        01190000
         SETFRR A,                                                     +01200000
               FRRAD=(R3),                                             +01210000
               WRKREGS=(14,15),                                        +01220000
               PARMAD=FRRPARM     ESTABLISH RECOVERY                    01230000
                                                                        01240000
         L     R1,FRRPARM         PARM AREA FOR FRR                     01250000
         MVC   0(12,R1),RCVPARMS  SET TYPE & PARM AREA POINTER          01260000
                                                                        01270000
         MODESET KEYADDR=(2)      RESTORE PREVIOUS KEY                  01280000
                                                                        01290000
         OI    FLAG,FLFRR         RECOVERY ENVIRONMENT ESTABLISHED      01300000
         B     RECOVSET           AND CONTINUE                          01310000
                                                                        01320000
RECOVSET DS    0H                                                       01330000
                                                                        01340000
*---------------------------------------------------------------------- 01350000
* IF THERE IS NO VALID RPL...INVOKE RECORDING/RECOVERY                  01360000
*---------------------------------------------------------------------- 01370000
                                                                        01380000
         MVI   RETR15+(L'RETR15-1),4                                    01390000
         ST    R4,RETR0           RESTORE R0 FOR MAINLINE               01400000
         C     R4,=F'20'          DO WE HAVE AN RPL?                    01410000
         BNE   BADRPL             BRANCH IF NOT                         01420000
                                                                        01430000
*---------------------------------------------------------------------- 01440000
* ESTABLISH ENVIRONMENT FROM RPL                                        01450000
*---------------------------------------------------------------------- 01460000
                                                                        01470000
         L     RIACB,RPLDACB      ASSOCIATED ACB ADDRESS                01480000
         L     RICVT,IACICVT      ICVT ADDRESSIBILITY                   01490000
         L     RIVTAM,ICTVTCVT    IVTAMCVT ADDRESSIBILITY               01500000
         L     RITASK,IVTITASK    MAIN VTAM ITASK ADDRESSIBILITY        01510000
                                                                        01520000
*---------------------------------------------------------------------- 01530000
* TRACE THE MODULE ENTRY                                                01540000
*---------------------------------------------------------------------- 01550000
                                                                        01560000
         $TRACE *=A(TRC_IVTMXLER),32,STDENV=NO        32 USER BYTES     01570000
                                                                        01580000
         BNZ   NOMTRACE           BRANCH IF TRACING NOT AVAILABLE       01590000
                                                                        01600000
         MVC   0(4,R1),IRPITASK   TRACE ITASK                           01610000
         MVC   4(4,R1),IRPISESS   TRACE ISESS                           01620000
         MVC   8(4,R1),RPLDACB    TRACE IACB                            01630000
         MVC   12(4,R1),RPLARG    TRACE THE CID                         01640000
         MVC   16(1,R1),RPLREQ    TRACE RPL REQUEST CODE                01650000
         MVC   17(3,R1),RPLFDBK   TRACE RPL FEEDBACK WORD               01660000
         MVC   20(4,R1),RPLUSFLD  TRACE RPL USERFLD                     01670000
         ST    R4,24(,R1)         TRACE RECOVERY ACTION RC              01680000
         ST    RIRPL,28(,R1)      TRACE RPL ADDRESS                     01690000
                                                                        01700000
NOMTRACE DS    0H                                                       01710000
                                                                        01720000
*---------------------------------------------------------------------- 01730000
* ALLOCATE A LERAD WORK ELEMENT                                         01740000
*---------------------------------------------------------------------- 01750000
                                                                        01760000
         $VTAMWE L'IWEX1,         SIZE                                 +01770000
               IWECXLER           CODE                                  01780000
                                                                        01790000
         LR    RIWE,R1                                                  01800000
                                                                        01810000
*---------------------------------------------------------------------- 01820000
* BUILD THE LERAD WORK ELEMENT                                          01830000
*---------------------------------------------------------------------- 01840000
                                                                        01850000
         ST    RIRPL,IWEX1RP@     SAVE ORIGINAL RPL ADDRESS             01860000
         ST    R4,IWEX1RC         SET RECOVERY ACTION RETURN CODE       01870000
         LA    R14,IWEX1RPL       COPY-TO ADDRESS                       01880000
         LR    R0,RIRPL           COPY-FROM ADDRESS                     01890000
         LA    R1,L'IRP           COPY LENGTH                           01900000
         LR    R15,R1             COPY LENGTH                           01910000
         MVCL  R14,R0             COPY THE RPL TO THE WORK ELEMENT      01920000
                                                                        01930000
*---------------------------------------------------------------------- 01940000
* QUEUE LERAD WORK ELEMENT TO VTAM MAIN ITASK                           01950000
*---------------------------------------------------------------------- 01960000
                                                                        01970000
         $VTAMQ (RIWE),           WORK ELEMENT                         +01980000
               IVTWEQ,            QUEUE                                +01990000
               STDENV=NO          EXIT ROUTINE                          02000000
                                                                        02010000
         B     RETURN                                                   02020000
                                                                        02030000
*---------------------------------------------------------------------- 02040000
* RETRY ROUTINE SCHEDULED BY RECOVERY                                   02050000
*---------------------------------------------------------------------- 02060000
                                                                        02070000
IVTXRTRY DS    0H                                                       02080000
                                                                        02090000
         LTR   R0,R0              WERE REGISTERS RESTORED FOR RETRY?    02100000
         BM    REGSOK             BRANCH IF YES, READY TO EXIT          02110000
X        USING IVTAMRPA,R1        PARM AREA ADDRESS MUST BE IN R1       02120000
         LM    R0,R15,X.IVRR00    RESTORE ALL THE REGISTERS             02130000
         DROP  X                                                        02140000
                                                                        02150000
REGSOK   DS    0H                                                       02160000
                                                                        02170000
         ICM   R0,15,PSATOLD      SRB MODE?                             02180000
         BNZ   RETURN             BRANCH IF NOT                         02190000
         ICM   R1,B'0001',=X'80'  KEY 8 IN BITS 24-27                   02200000
         MODESET KEYREG=(R1)      SET KEY 8                             02210000
         B     RETURN             AND WE ARE READY TO EXIT              02220000
                                                                        02230000
*---------------------------------------------------------------------- 02240000
* RETURN TO VTAM FROM EXIT ROUTINE                                      02250000
*---------------------------------------------------------------------- 02260000
                                                                        02270000
RETURN   DS    0H                                                       02280000
                                                                        02290000
         TM    FLAG,FLESTAEX      IS ESTAEX ESTABLISHED?                02300000
         BNO   RETFRR             BRANCH IF NOT                         02310000
                                                                        02320000
         ESTAEX 0                 DELETE RECOVERY ENVIRONMENT           02330000
                                                                        02340000
         NI    FLAG,255-FLESTAEX  CLEAR FLAG                            02350000
         B     EXITNOW            AND EXIT                              02360000
                                                                        02370000
RETFRR   DS    0H                                                       02380000
                                                                        02390000
         TM    FLAG,FLFRR         IS FRR ESTABLISHED?                   02400000
         BNO   EXITNOW            BRANCH IF NOT                         02410000
                                                                        02420000
         MODESET EXTKEY=ZERO,                                          +02430000
               SAVEKEY=(2)        SET KEY ZERO                          02440000
                                                                        02450000
         SETFRR D,                                                     +02460000
               WRKREGS=(14,15)    DELETE RECOVERY ENVIRONMENT           02470000
                                                                        02480000
         MODESET KEYADDR=(2)      RESTORE PREVIOUS KEY                  02490000
                                                                        02500000
         NI    FLAG,255-FLFRR     CLEAR FLAG                            02510000
         B     EXITNOW            AND EXIT                              02520000
                                                                        02530000
EXITNOW  DS    0H                                                       02540000
                                                                        02550000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 02560000
                                                                        02570000
         #VTEXIT ,                RETURN                                02580000
                                                                        02590000
*---------------------------------------------------------------------- 02600000
* BAD RPL DETECTED                                                      02610000
*---------------------------------------------------------------------- 02620000
                                                                        02630000
BADRPL   DS    0H                                                       02640000
                                                                        02650000
         EX    0,*                INVOKE RECORDING/RECOVERY             02660000
                                                                        02670000
*---------------------------------------------------------------------- 02680000
*  CONSTANTS AND LITERALS                                               02690000
*---------------------------------------------------------------------- 02700000
                                                                        02710000
ESTAEXL  ESTAEX *-*,CT,MF=L       ESTAEX PLIST                          02720000
ESTAEXPL EQU   ESTAEXL,*-ESTAEXL                                        02730000
                                                                        02740000
         LTORG ,                                                        02750000
         PRINT NOGEN                                                    02760000
         IVTAMRPA ,               INTEGRATOR VTAM RECOVERY PARAMETERS   02770000
         IHAFRRS ,                MVS FRR STACK                         02780000
         IHAPSA ,                 MVS PREFIXED STORAGE AREA             02790000
         ISTDBIND ,               VTAM BIND IMAGE                       02800000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         02810000
         ICVT  ,                  INTEGRATOR CVT                        02820000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   02830000
         ITASK ,                  INTEGRATOR TASK BLOCK                 02840000
         IACB ,                   INTEGRATOR VTAM ACB+                  02850000
         IRPL ,                   INTEGRATOR VTAM RPL+                  02860000
         INIB ,                   INTEGRATOR VTAM NIB+                  02870000
         ISESS ,                  INTEGRATOR SESSION BLOCK              02880000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            02890000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          02900000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       02910000
         EVCODES ,                INTEGRATOR EVENT CODES                02920000
         ABCODES ,                INTEGRATOR $ABEND CODES               02930000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     02940000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             02950000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             02960000
         IFGEXLST ,               VTAM EXIT LIST                        02970000
         END   ,                                                        02980000

IL62ADPL TITLE 'INTEGRATOR - LU6.2 DEFINE PARTNER LU'                   00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: IL62ADPL - LU6.2 DEFINE PARTNER LU                           00100000
*                                                                       00110000
* DESCRIPTION:                                                          00120000
*                                                                       00130000
*    THIS ROUTINE IS CALLED TO CREATE THE PARTNER_LU (PLB) BLOCK AND    00140000
*    TASK.                                                              00150000
*                                                                       00160000
* ON ENTRY:                                                             00170000
*                                                                       00180000
*    R15 = ENTRY POINT ADDRESS                                          00190000
*    R14 = RETURN      ADDRESS                                          00200000
*    R13 = SAVE AREA   ADDRESS                                          00210000
*    R01 = PARM LIST   ADDRESS                                          00220000
*                                                                       00230000
*          +00 = ADDRESS OF LUCB (IACB)                                 00240000
*          +04 = ADDRESS OF PARTNER LU NAME (MAX LENGTH 8 CHARACTERS)   00250000
*          +08 = ADDRESS OF PARTNER LU NAME LENGTH                      00260000
*          +0C = ADDRESS OF PLB (IVUSER) RETURN AREA                    00270000
*          +10 = ADDRESS OF RETURN CODE AREA                            00280000
*                                                                       00290000
* ON EXIT:                                                              00300000
*                                                                       00310000
*    R15 = 0                                                            00320000
*                                                                       00330000
*    RETURN_CODE = LU62_OK --> PARTNER_LU SUCCESSFULLY DEFINED          00340000
*                                                                       00350000
*                = LU62_PARAMETER_ERROR --> IACB/LUNAME ERROR           00360000
*                = LU62_PRODUCT_SPECIFIC_ERROR --> PARTNER ALREADY DEF. 00370000
*                                                                       00380000
**<DOC-OFF>************************************************************ 00390000
         EJECT ,                                                        00400000
*********************************************************************** 00410000
*                                                                       00420000
* MAINTENANCE:                                                          00430000
*                                                                       00440000
*   07/01/94 RANDY WITEK                                                00450000
*   09/07/95 RANDY WITEK - SPECIAL HANDLING FOR START-UP WORK ELEMENT   00460000
*                                                                       00470000
*********************************************************************** 00480000
                                                                        00490000
         EQUS  ,                  GENERAL EQUATES                       00500000
                                                                        00510000
RICVT    EQU   R11                                                      00520000
RITASK   EQU   R10                                                      00530000
RBASE    EQU   R9                                                       00540000
RIVTAM   EQU   R8                                                       00550000
RIACB    EQU   R7                                                       00560000
RIVUSER  EQU   R6                                                       00570000
RPLIST   EQU   R5                                                       00580000
                                                                        00590000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00600000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00610000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00620000
         USING IACB,RIACB         ESTABLISH ADDRESSABILITY              00630000
         USING IVUSER,RIVUSER     ESTABLISH ADDRESSABILITY              00640000
         USING L62LIST,RPLIST     ESTABLISH ADDRESSABILITY              00650000
                                                                        00660000
         COPY  CRAB               "C" RUNTIME ANCHOR BLOCK              00670000
         USING CRAB,R12           ADDRESSABILITY                        00680000
                                                                        00690000
         COPY  DSA                DYNAMIC SAVE AREA                     00700000
WORKAREA DS    0H                 READ/WRITE WORKAREA                   00710000
WRK256   DS    XL256              GENERAL WORKAREA                      00720000
$TASKMFL $TASK MF=L               $TASK PLIST CONSTRUCTION              00730000
$RMGRMFL $RESMGR MF=L             $RESMGR PLIST CONSTRUCTION            00740000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00750000
PARTLU@  DS    A                  ADDRESS OF PARTNER LU NAME            00760000
PARTLULN DS    F                  LENGTH OF PARTNER LU NAME             00770000
WRKLOCAL DS    CL8                WORKING COPY OF PARTNER LU NAME       00780000
RETCODE  DS    F                  TEMPORARY RETURN CODE AREA            00790000
FLAG     DS    X                                                        00800000
FLAGLOCK EQU   X'80'                                                    00810000
FLAGLCKD EQU   X'40'                                                    00820000
WORKLEN  EQU   *-WORKAREA         LENGTH OF USER DSA AREA               00830000
DSALEN   EQU   *-DSA              LENGTH OF DSA                         00840000
                                                                        00850000
         $MSGDFT PREFIX=ICTPID,                                        +00860000
               COMPID='L62',                                           +00870000
               TABLE=*#MSGS,                                           +00880000
               WORKA=0,                                                +00890000
               MF=(E,WRK256),                                          +00900000
               PRINT=NOGEN                                              00910000
                                                                        00920000
IL6ADPL@ CSECT ,                                                        00930000
IL62ADPL CENTRY DSA=DSALEN,BASE=RBASE,INDEP=YES                         00940000
                                                                        00950000
         USING DSA,R13            ADDRESSABILITY                        00960000
         LR    RPLIST,R1          SAVE ADDRESS OF PLIST                 00970000
                                                                        00980000
         LA    R0,WORKAREA        ADDRESS OF USER DSA SECTION           00990000
         LA    R1,WORKLEN         LENGTH  OF USER DSA SECTION           01000000
         SR    R15,R15            PREPARE FOR CLEAR                     01010000
         MVCL  R0,R14             CLEAR USER DSA SECTION                01020000
                                                                        01030000
*---------------------------------------------------------------------- 01040000
* INITIALIZATION                                                        01050000
*---------------------------------------------------------------------- 01060000
                                                                        01070000
         @RESTENV ,               ENSURE ENVIRONMENT                    01080000
                                                                        01090000
         L     RIVTAM,ICTVTCVT    ESTABLISH IVTAMCVT POINTER            01100000
         USING IVTAMCVT,RIVTAM    ADDRESSABILITY                        01110000
         L     RIACB,L62PARM1     LUCB ADDRESS                          01120000
         SR    RIVUSER,RIVUSER    NO PLB YET                            01130000
         L     R2,L62PARM2        PARTNER LU NAME ADDRESS               01140000
         L     R3,L62PARM3        PARTNER LU NAME LENGTH ADDRESS        01150000
         L     R3,0(,R3)          PARTNER LU NAME LENGTH                01160000
         ST    R2,PARTLU@         SAVE THE ADDRESS                      01170000
         ST    R3,PARTLULN        SAVE THE LENGTH                       01180000
         MVC   WRKLOCAL,=CL8' '   BLANK WORKING COPY OF LU NAME         01190000
         LTR   R14,R2             PARTNER LU NAME                       01200000
         BNP   INITEND            BRANCH IF NOT OK                      01210000
         LTR   R15,R3             PARTNER LU NAME LENGTH                01220000
         BNP   INITEND            BRANCH IF NOT OK                      01230000
         ICM   R15,B'1000',=C' '  PAD WITH A BLANK IF NECESSARY         01240000
         LA    R2,WRKLOCAL        COPY-TO ADDRESS                       01250000
         LA    R3,8               COPY-TO LENGTH                        01260000
         MVCL  R2,R14             TRACE PARTNER LU NAME                 01270000
                                                                        01280000
INITEND  DS    0H                                                       01290000
                                                                        01300000
*---------------------------------------------------------------------- 01310000
* ENTRY TRACE                                                           01320000
*---------------------------------------------------------------------- 01330000
                                                                        01340000
         $TRACE *=A(TRC_LU62_IL62ADPL),48 TRACE ENTRY W/ 48 USER BYTES  01350000
         BNZ   NOETRACE                   BRANCH IF NOT TRACING         01360000
         $APITRC IL62ADPL                 TRACE COMMON STUFF            01370000
         ST    RPLIST,24(,R1)             TRACE PARMLIST ADDRESS        01380000
         ST    RIACB,28(,R1)              TRACE IACB     ADDRESS        01390000
         LTR   RIACB,RIACB                IS IACB POINTER OK?           01400000
         BZ    *+10                       BRANCH IF NOT                 01410000
         MVC   32(8,R1),IACNAME           TRACE LOCAL LU NAME           01420000
         MVC   40(8,R1),WRKLOCAL          TRACE PARTNER LU NAME         01430000
NOETRACE DS    0H                                                       01440000
                                                                        01450000
*---------------------------------------------------------------------- 01460000
* DEFINE PARTNER LU NOT ISSUED BY MAIN TASK.  SHIFT WORK TO MAIN.       01470000
*---------------------------------------------------------------------- 01480000
                                                                        01490000
         C     RITASK,IVTITASK    EXECUTING IN VTAM MAIN TASK?          01500000
         BE    DFPLMAIN           BRANCH IF YES                         01510000
                                                                        01520000
         $VTAMWE L'IWEXQ,         SIZE                                 +01530000
               IWECDFPL           CODE                                  01540000
                                                                        01550000
         LR    R4,R1              SAVE WE ADDRESS                       01560000
                                                                        01570000
         USING IWEVTAM,R4                                               01580000
                                                                        01590000
         $TASK SETEPB,            INITIALIZE EPB TO WAIT FOR DEFINE    +01600000
               ECODE=EC$VTDP,     DEFINE PARTNER LU EVENT              +01610000
               ERRET=ERR$TASK,                                         +01620000
               MF=(E,$TASKMFL)                                          01630000
                                                                        01640000
         LR    R3,R1              SAVE XEPB ADDRESS                     01650000
                                                                        01660000
         ST    R3,IWEXQEPB        SET XEPB ADDRESS IN WORK ELEMENT      01670000
         L     R1,TSKPCBC         CURRENT PCB                           01680000
         MVC   IWEXQENT,PCBENTKN-IPCB(R1) CURRENT IPCB ENTITY TOKEN     01690000
         ST    RIACB,IWEXQACB     SET LOCAL LU IACB ADDRESS             01700000
         L     R1,PARTLU@         PARTNER LU NAME ADDRESS               01710000
         ST    R1,IWEXQLU         SET PARTNER LU NAME ADDRESS           01720000
         L     R1,PARTLULN        PARTNER LU NAME LENGTH                01730000
         ST    R1,IWEXQLUL        SET PARTNER LU NAME LENGTH            01740000
                                                                        01750000
         $VTAMQ (R4),             WORK ELEMENT                         +01760000
               IVTWEQ             QUEUE                                 01770000
                                                                        01780000
         $TASK WAIT,              WAIT FOR MAIN TO COMPLETE DEFINE     +01790000
               EPB=(R3),                                               +01800000
               MF=(E,$TASKMFL)                                          01810000
                                                                        01820000
         ST    R0,RETCODE         POST CODE IN R0 IS DEFINE RC          01830000
         LTR   R0,R0              TEST THE DEFINE RETURN CODE           01840000
         BNZ   RETURN             RETURN IF DEFINE WAS NOT SUCCESSFUL   01850000
                                                                        01860000
         DROP  R4                                                       01870000
                                                                        01880000
         BAS   R14,VTAMLOCK       SERIALIZE                             01890000
                                                                        01900000
         LA    R4,IACPL1ST        GET SET TO RUN PLB CHAIN              01910000
         S     R4,=A(IVUPLNXT-IVU)                                      01920000
                                                                        01930000
PLBFIND  DS    0H                                                       01940000
                                                                        01950000
         ICM   R4,15,IVUPLNXT-IVU(R4) LINK TO THE NEXT PLB              01960000
         BM    ERRPROD            BRANCH IF NOT FOUND ???               01970000
         CLC   WRKLOCAL,IVULOCAL-IVU(R4) COMPARE THE NAMES              01980000
         BH    PLBFIND            BRANCH IF NEW NAME IS HIGH            01990000
         BL    ERRPROD            BRANCH IF NOT FOUND ???               02000000
         LR    RIVUSER,R4         RETURN THE NEW IVUSER/PLB             02010000
         B     RETURN                                                   02020000
                                                                        02030000
DFPLMAIN DS    0H                                                       02040000
                                                                        02050000
*---------------------------------------------------------------------- 02060000
* SEE IF THE REQUESTED PARTNER_LU ALREADY EXISTS                        02070000
*---------------------------------------------------------------------- 02080000
                                                                        02090000
         LTR   RIACB,RIACB        DO WE HAVE AN IACB POINTER?           02100000
         BNP   ERRPARM            BRANCH IF NOT                         02110000
         CLC   IACID,=CL8'IACB'   IS THE ID CORRECT?                    02120000
         BNE   ERRPARM            BRANCH IF NOT                         02130000
         ICM   R1,15,PARTLU@      WAS A NAME POINTER PROVIDED?          02140000
         BNP   ERRPARM            BRANCH IF NOT                         02150000
         ICM   R1,15,PARTLULN     WAS A VALID LENGTH PROVIDED?          02160000
         BNP   ERRPARM            BRANCH IF NOT                         02170000
         C     R1,=F'8'           WAS A VALID LENGTH PROVIDED?          02180000
         BH    ERRPARM            BRANCH IF NOT                         02190000
                                                                        02200000
         BAS   R14,VTAMLOCK       SERIALIZE                             02210000
                                                                        02220000
         LA    R4,IACPL1ST        GET SET TO RUN PLB CHAIN              02230000
         S     R4,=A(IVUPLNXT-IVU)                                      02240000
                                                                        02250000
PLBRUN   DS    0H                                                       02260000
                                                                        02270000
         ICM   R4,15,IVUPLNXT-IVU(R4) LINK TO THE NEXT PLB              02280000
         BM    NEWPLB             BRANCH IF NOT FOUND                   02290000
         CLC   WRKLOCAL,IVULOCAL-IVU(R4) COMPARE THE NAMES              02300000
         BH    PLBRUN             BRANCH IF NEW NAME IS HIGH            02310000
         BL    NEWPLB             BRANCH IF NOT FOUND                   02320000
         B     ERRPROD            BRANCH IF PARTNER_LU ALREADY DEFINED  02330000
                                                                        02340000
*---------------------------------------------------------------------- 02350000
* CREATE AN IVUSER/PLB FOR THIS LU6.2 PARTNER                           02360000
*---------------------------------------------------------------------- 02370000
                                                                        02380000
NEWPLB   DS    0H                                                       02390000
                                                                        02400000
*                                                                       02410000
* ALLOCATE AN IVUSER/PLB BLOCK                                          02420000
*---------------------------------------------------------------------- 02430000
                                                                        02440000
         LA    R3,L'IVU           ALLOCATE AN IVUSER BLOCK              02450000
                                                                        02460000
         $GETSTOR (R3),                                                +02470000
               LOC=ANY,                                                +02480000
               OWNER=*IVTITASK                                          02490000
                                                                        02500000
         LR    RIVUSER,R1         REFERENCE TO IVUSER BLOCK             02510000
         MVC   IVUID,=CL8'IVUSER' SET EYECATCHER                        02520000
         ST    R3,IVULEN          SET THE LENGTH                        02530000
                                                                        02540000
         L     R1,IVTTKUSR        LAST IVUSER TOKEN                     02550000
         AL    R1,=F'1'           NEXT IVUSER TOKEN                     02560000
         ST    R1,IVTTKUSR        UPDATE LAST IVUSER TOKEN              02570000
         ST    R1,IVUTKUSR        SET THE IVUSER TOKEN WORD             02580000
                                                                        02590000
         LA    R1,IVUIS1ST        INITIALIZE USER SESSION CHAIN         02600000
         S     R1,=A(ISENEXT-ISE) NORMALIZE THE NULL HEADER             02610000
         O     R1,=X'80000000'    HI BIT ON FOR NULL HEADER             02620000
         ST    R1,IVUIS1ST        SET HEADER                            02630000
         ST    R1,IVUISLST        SET HEADER                            02640000
                                                                        02650000
         OI    IVUF1,IVUF1L62     IVUSER IS FOR LU6.2                   02660000
                                                                        02670000
         $VTAM ADDUSER,           ADD IVUSER TO LOOKUP TABLE           +02680000
               AREA=(RIVUSER),    PASS ADDRESS OF IVUSER BLOCK         +02690000
               ERRET=ERR$VTAM,    IF AN ERROR                          +02700000
               MF=(E,WRK256)      USE WORK AREA FOR PARM LIST           02710000
                                                                        02720000
*                                                                       02730000
* INITIALIZE THE PARTNER_LU FIELDS                                      02740000
*---------------------------------------------------------------------- 02750000
                                                                        02760000
         ST    RIACB,IVUIACB            LINK TO OWNING IACB             02770000
                                                                        02780000
         LA    R1,IVUMD1ST              INITIALIZE MODE_LIST            02790000
         S     R1,=A(MDENEXT-MDE)       NORMALIZE FOR CHAINING          02800000
         O     R1,=X'80000000'          HI BIT ON FOR NULL ELEMENT      02810000
         ST    R1,IVUMD1ST              SET NULL ELEMENT POINTER        02820000
         ST    R1,IVUMDLST              SET NULL ELEMENT POINTER        02830000
                                                                        02840000
         LR    R14,R4                     FOLLOWING PLB                 02850000
         L     R15,IVUPLPRV-IVU(,R14)     PRECEDING PLB                 02860000
         ST    RIVUSER,IVUPLNXT-IVU(,R15) LINK NEW PLB TO PRECEDING     02870000
         ST    RIVUSER,IVUPLPRV-IVU(,R14) LINK NEW PLB TO FOLLOWING     02880000
         STM   R14,R15,IVUPLNXT           SET NEXT/PREV IN NEW PLB      02890000
                                                                        02900000
         MVC   IVULOCAL,WRKLOCAL        SET THE LOCAL LU NAME           02910000
         MVC   IVUUILN,WRKLOCAL         SET THE UNINTERPRETED LU NAME   02920000
                                                                        02930000
         LA    R14,IVUFQLN              AREA FOR FQ PARTNER LU NAME     02940000
         LA    R15,L'IVUFQLN            LENGTH OF THAT AREA             02950000
         LA    R0,WRKLOCAL              UNQUALIFIED PARTNER LU NAME     02960000
         LA    R1,8                     LENGTH OF THAT NAME             02970000
         ICM   R1,B'1000',=C' '         BLANK PAD THE FQ NAME           02980000
         MVCL  R14,R0                   USE UNQUALIFIED NM TEMPORARILY  02990000
         SR    R15,R15                  DETERMINE TRUE LENGTH OF FQ NM  03000000
         LA    R14,IVUFQLN              ADDRESS OF FQ NAME              03010000
         LA    R1,8                     CHECK A MAX OF 8 CHARACTERS     03020000
                                                                        03030000
INITFQLN DS    0H                                                       03040000
                                                                        03050000
         CLI   0(R14),C' '              IS THIS A NON-BLANK?            03060000
         BNH   INITFQDN                 BRANCH IF NOT                   03070000
         LA    R15,1(,R15)              BUMP TRUE LENGTH OF FQ NAME     03080000
         LA    R14,1(,R14)              BUMP INDEX INTO NAME            03090000
         BCT   R1,INITFQLN              AND CHECK MAX OF 8 CHARACTERS   03100000
                                                                        03110000
INITFQDN DS    0H                                                       03120000
                                                                        03130000
         STC   R15,IVUFQLNL             SET TEMPORARY FQ NAME LENGTH    03140000
         OI    IVUF2,IVUF2CFM           SYNC LEVEL CONFIRM SUPPORTED    03150000
         OI    IVUF2,IVUF2SIA           SECURITY INFORMATION ACCEPTED   03160000
         OI    IVUF2,IVUF2AVA           ALREADY VERIFIED ACCEPTED       03170000
                                                                        03180000
*                                                                       03190000
* CREATE A NEW SUBTASK FOR THE IVUSER                                   03200000
*---------------------------------------------------------------------- 03210000
                                                                        03220000
         $TASK SETEPB,            INITIALIZE TASK TERMINATION EPB      +03230000
               ECODE=EC$VTUT,     USER TERMINATION IS THE CODE         +03240000
               ERRET=ERR$TASK,                                         +03250000
               MF=(E,$TASKMFL)                                          03260000
                                                                        03270000
         LR    R3,R1              TASK TERMINATION EPB ADDRESS          03280000
         L     R2,=F'-1'          DPMOD VALUE FOR $TASK CREATE          03290000
                                                                        03300000
         $TASK CREATE,            CREATE THE IVUSER SUBTASK            +03310000
               EP=*IVT@USER,      PROC MAIN CODE FOR IVUSER SUBTASK    +03320000
               NAME=WRKLOCAL,     LOGON=SLUNAME, SIRQ='INDEPUSR'       +03330000
               PARM=(RIVUSER),    PASS IVUSER AS PARM                  +03340000
               SYNC=YES,          WAIT FOR SUBTASK TO START            +03350000
               TERMEPB=(R3),      POST THIS EPB WHEN SUBTASK IS GONE   +03360000
               DPMOD=(R2),        DISPATCH AT SLIGHTLY LOWER PRIORITY  +03370000
               ERRET=ERR$TASK,                                         +03380000
               MF=(E,$TASKMFL)                                          03390000
                                                                        03400000
         LR    R3,R1              NEW ITASK ADDRESS                     03410000
                                                                        03420000
         $SER  OBTAIN,                                                 +03430000
               DISP                                                     03440000
                                                                        03450000
         $RESMGR ADD,             ADD A RESOURCE MANAGER               +03460000
               TOKEN=IVURMTOK,    PLACE RESOURCE MANAGER TOKEN HERE    +03470000
               OWNER=(R3),        FOR THE NEW ITASK                    +03480000
               ROUTINE=*IVT@UMGR, RESOURCE MANAGER CODE IS IVTMUMGR    +03490000
               PARM=(RIVUSER),    R1 WILL POINT TO THE IVUSER BLOCK    +03500000
               MF=(E,$RMGRMFL)                                          03510000
                                                                        03520000
         $SER  RELEASE,                                                +03530000
               DISP                                                     03540000
                                                                        03550000
         ST    RIVUSER,TSKIVUSR-ITASK(,R3) LINK IVUSER TO ITASK         03560000
         ST    R3,IVUITASK        SET ITASK ADDRESS IN IVUSER BLOCK     03570000
         MVC   IVUITSKN,WRKLOCAL  SET ITASK NAME    IN IVUSER BLOCK     03580000
                                                                        03590000
*                                                                       03600000
* ALLOCATE A NOP (DUMMY) WORK ELEMENT TP START IVUSER                   03610000
*---------------------------------------------------------------------- 03620000
                                                                        03630000
         $VTAMWE L'IWEXP,         SIZE                                 +03640000
               IWECNOP            CODE                                  03650000
                                                                        03660000
         ST    R1,IVUWEQ          SET WE FOR THE IVUSER TASK            03670000
         ST    R1,IVU1STWE        SET FIRST WORK ELEMENT ADDRESS 090795 03680000
                                                                        03690000
*                                                                       03700000
* POST THE NEW TASK FOR LOGON STARTUP                                   03710000
*---------------------------------------------------------------------- 03720000
                                                                        03730000
         POST  IVUSTECB,LINKAGE=SYSTEM                                  03740000
                                                                        03750000
         B     RETURN                                                   03760000
                                                                        03770000
*---------------------------------------------------------------------- 03780000
* EXCEPTION ROUTINES                                                    03790000
*---------------------------------------------------------------------- 03800000
                                                                        03810000
ERRPARM  DS    0H                                                       03820000
                                                                        03830000
         MVC   RETCODE,=A(LU62_PARAMETER_ERROR)                         03840000
         B     ERRCOMM                                                  03850000
                                                                        03860000
ERRPROD  DS    0H                                                       03870000
                                                                        03880000
         MVC   RETCODE,=A(LU62_PRODUCT_SPECIFIC_ERROR)                  03890000
         B     ERRCOMM                                                  03900000
                                                                        03910000
ERRCOMM  DS    0H                                                       03920000
                                                                        03930000
         SR    RIVUSER,RIVUSER    ENSURE NO IVUSER/PLB POINTER          03940000
         B     RETURN                                                   03950000
                                                                        03960000
*---------------------------------------------------------------------- 03970000
* EXIT TRACE AND RETURN TO CALLER                                       03980000
*---------------------------------------------------------------------- 03990000
                                                                        04000000
RETURN   DS    0H                                                       04010000
                                                                        04020000
         BAS   R14,VTAMUNLK           RELEASE THE LOCK IF NECESSARY     04030000
                                                                        04040000
         $TRACE *=A(TRC_LU62_EXIT),16 TRACE ENTRY W/ 16 USER BYTES      04050000
         BNZ   NOXTRACE               BRANCH IF TRACING NOT AVAILABLE   04060000
         MVC   0(8,R1),=CL8'IL62ADPL' MODULE NAME                       04070000
         MVC   8(4,R1),RETCODE        RETURN_CODE VALUE                 04080000
         ST    RIVUSER,12(,R1)        PLB ADDRESS                       04090000
NOXTRACE DS    0H                                                       04100000
                                                                        04110000
         L     R1,L62PARM4        ADDRESS OF PLB RETURN AREA            04120000
         ST    RIVUSER,0(,R1)     RETURN THE IVUSER/PLB ADDRESS         04130000
                                                                        04140000
         L     R1,L62PARM5        ADDRESS OF RETURN_CODE AREA           04150000
         MVC   0(4,R1),RETCODE    SET RETURN_CODE VARIABLE              04160000
                                                                        04170000
         SR    R15,R15            FUNCTION RETURN CODE = 0              04180000
         CEXIT RC=(R15),INDEP=YES RETURN                                04190000
                                                                        04200000
*---------------------------------------------------------------------- 04210000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 04220000
*---------------------------------------------------------------------- 04230000
                                                                        04240000
VTAMLOCK DS    0H                                                       04250000
                                                                        04260000
         TM    FLAG,FLAGLOCK        WAS THE LOCK ALREADY OBTAINED?      04270000
         BOR   R14                  RETURN IF YES                       04280000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             04290000
                                                                        04300000
         $SER  OBTAIN,                                                 +04310000
               VTAM                                                     04320000
                                                                        04330000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              04340000
         BNE   VTAMLOEX             BRANCH IF NOT                       04350000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         04360000
                                                                        04370000
VTAMLOEX DS    0H                                                       04380000
                                                                        04390000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               04400000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          04410000
         BR    R14                  RETURN                              04420000
                                                                        04430000
*---------------------------------------------------------------------- 04440000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                04450000
*---------------------------------------------------------------------- 04460000
                                                                        04470000
VTAMUNLK DS    0H                                                       04480000
                                                                        04490000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       04500000
         BNOR  R14                  BRANCH IF NOT                       04510000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             04520000
         BOR   R14                  DON'T RELEASE IF IT WAS             04530000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             04540000
                                                                        04550000
         $SER  RELEASE,                                                +04560000
               VTAM                                                     04570000
                                                                        04580000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  04590000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          04600000
         BR    R14                  RETURN                              04610000
                                                                        04620000
*---------------------------------------------------------------------- 04630000
* ERROR ROUTINES                                                        04640000
*---------------------------------------------------------------------- 04650000
                                                                        04660000
ERR$TASK DS    0H                                                       04670000
                                                                        04680000
         $ABEND ABE_VTDIAG,                                            +04690000
               SCOPE=PCB,                                              +04700000
               TITLE='$TASK FAILURE'                                    04710000
                                                                        04720000
ERR$VTAM DS    0H                                                       04730000
                                                                        04740000
         $ABEND ABE_VTDIAG,                                            +04750000
               SCOPE=PCB,                                              +04760000
               TITLE='$VTAM FAILURE'                                    04770000
                                                                        04780000
*---------------------------------------------------------------------- 04790000
* LITERALS AND CONSTANTS                                                04800000
*---------------------------------------------------------------------- 04810000
                                                                        04820000
         LTORG ,                                                        04830000
                                                                        04840000
         PRINT NOGEN                                                    04850000
         ISTDBIND ,               VTAM BIND IMAGE                       04860000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                04870000
         IKJTCB ,                 MVS TASK CONTROL BLOCK                04880000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         04890000
         ICVT  ,                  INTEGRATOR CVT                        04900000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   04910000
         ITASK ,                  INTEGRATOR TASK BLOCK                 04920000
         IPCB ,                   INTEGRATOR PROCESS BLOCK              04930000
         IACB ,                   INTEGRATOR VTAM ACB                   04940000
         ABCODES ,                INTEGRATOR $ABEND CODES               04950000
         EVCODES ,                INTEGRATOR EVENT CODES                04960000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            04970000
         ISESS ,                  INTEGRATOR SESSION BLOCK              04980000
         IRPL ,                   INTEGRATOR VTAM RPL                   04990000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          05000000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             05010000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             05020000
         $RESMGR DSECT=YES        INTEGRATOR $RESMGR SERVICES           05030000
         END   ,                                                        05040000

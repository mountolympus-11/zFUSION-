ICPXPCV  TITLE 'INTEGRATOR - CPIC XCPCV API - PROCESS CNOS VARIABLE'    00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: ICPXPCV - CPIC XCPCV API - PROCESS CNOS VARIABLE             00100000
*                                                                       00110000
* DESCRIPTION:                                                          00120000
*                                                                       00130000
*    THIS ROUTINE IS CALLED TO PROCESS THE XCPCV VERB.                  00140000
*                                                                       00150000
* ON ENTRY:                                                             00160000
*                                                                       00170000
*    R15 = ENTRY POINT ADDRESS                                          00180000
*    R14 = RETURN      ADDRESS                                          00190000
*    R13 = SAVE AREA   ADDRESS                                          00200000
*    R01 = PARM LIST   ADDRESS                                          00210000
*                                                                       00220000
*          +00 = ADDRESS OF CONVERSATION_ID                             00230000
*          +04 = ADDRESS OF CNOS VARIABLE                               00240000
*          +08 = ADDRESS OF CNOS VARIABLE LENGTH                        00250000
*          +0C = ADDRESS OF RETURN_CODE RETURN AREA                     00260000
*                                                                       00270000
* ON EXIT:                                                              00280000
*                                                                       00290000
*    R15 = 0                                                            00300000
*                                                                       00310000
*    RETURN_CODE = CM_OK                      --> PROCESSED OK          00320000
*                = CM_PROGRAM_PARAMETER_CHECK --> INVALID CONV_ID, ETC. 00330000
*                = CM_PARAMETER_ERROR         --> BAD CNOS VARIABLE     00340000
*                = CM_PRODUCT_SPECIFIC_ERROR  --> SERVICE FAILURE       00350000
*                = CM_OPERATION_NOT_ACCEPTED  --> RACE/UNEX. REPLY      00360000
*                                                                       00370000
**<DOC-OFF>************************************************************ 00380000
         EJECT ,                                                        00390000
*********************************************************************** 00400000
*                                                                       00410000
* MAINTENANCE:                                                          00420000
*                                                                       00430000
*   09/01/94 RANDY WITEK                                                00440000
*                                                                       00450000
*********************************************************************** 00460000
                                                                        00470000
         EQUS  ,                  GENERAL EQUATES                       00480000
                                                                        00490000
RICVT    EQU   R11                                                      00500000
RITASK   EQU   R10                                                      00510000
RBASE    EQU   R9                                                       00520000
RIVTAM   EQU   R8                                                       00530000
RCMLIST  EQU   R7                                                       00540000
RTKB     EQU   R6                                                       00550000
RRCB     EQU   R5                                                       00560000
RISESS   EQU   R4                                                       00570000
                                                                        00580000
         USING DSA,R13            ESTABLISH ADDRESSABILITY              00590000
         USING CRAB,R12           ESTABLISH ADDRESSABILITY              00600000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00610000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00620000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00630000
         USING CMLIST,RCMLIST     ESTABLISH ADDRESSABILITY              00640000
         USING TKB,RTKB           ESTABLISH ADDRESSABILITY              00650000
         USING RCB,RRCB           ESTABLISH ADDRESSABILITY              00660000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00670000
                                                                        00680000
         COPY  CRAB                  "C" RUNTIME ANCHOR BLOCK           00690000
         COPY  DSA                   DYNAMIC SAVE AREA                  00700000
WORKAREA DS    0H                    READ/WRITE WORKAREA                00710000
WRK256   DS    XL256                 GENERAL WORKAREA                   00720000
$SESSMFL $SESS MF=L                  PLIST CONSTRUCTION                 00730000
$TASKMFL $TASK MF=L                  PLIST CONSTRUCTION                 00740000
L62MFL   L62DSMD MF=L                PLIST CONSTRUCTION                 00750000
L62RETCD DS    F                     RETURN CODE AREA                   00760000
L62RETMD DS    F                     MDE ADDRESS RETURN AREA            00770000
SUB0SAVE DS    18F                   SUBROUTINE SAVE AREA               00780000
SUB1SAVE DS    18F                   SUBROUTINE SAVE AREA               00790000
SAVEEPB  DS    A                     XEPB ADDRESS                       00800000
                                                                        00810000
CONVID   DS    XL8                   TEMPORARY CONVERSATION ID AREA     00820000
RETCODE  DS    F                     TEMPORARY RETURN CODE     AREA     00830000
CONVS    DS    F                     TEMPORARY CONV STATE      AREA     00840000
BUFFER   DS    F                     TEMPORARY CNOS VAR ADDR   AREA     00850000
LENGTH   DS    F                     TEMPORARY SEND LENGTH     AREA     00860000
                                                                        00870000
MODECOPY DS    CL8                   MODENAME      COPY AREA            00880000
CNOSCOPY DS    XL25                  CNOS VARIABLE COPY AREA            00890000
                                                                        00900000
FLAG     DS    X                                                        00910000
FLAGIERR EQU   X'80'                                                    00920000
FLAGLOCK EQU   X'40'                                                    00930000
FLAGLCKD EQU   X'20'                                                    00940000
FLAGIER2 EQU   X'10'                                                    00950000
WORKLEN  EQU   *-WORKAREA            LENGTH OF USER DSA AREA            00960000
DSALEN   EQU   *-DSA                 LENGTH OF DSA                      00970000
                                                                        00980000
         USING CVAR,CNOSCOPY                                            00990000
                                                                        01000000
         $MSGDFT PREFIX=ICTPID,                                        +01010000
               COMPID='CPI',                                           +01020000
               TABLE=*#MSGS,                                           +01030000
               WORKA=0,                                                +01040000
               MF=(E,WRK256),                                          +01050000
               PRINT=NOGEN                                              01060000
                                                                        01070000
ICPPCV@  CSECT ,                                                        01080000
ICPXPCV  CENTRY DSA=DSALEN,BASE=RBASE,INDEP=YES                         01090000
                                                                        01100000
*---------------------------------------------------------------------- 01110000
* ENTRY                                                                 01120000
*---------------------------------------------------------------------- 01130000
                                                                        01140000
         LR    RCMLIST,R1            SAVE ADDRESS OF PLIST              01150000
                                                                        01160000
         LA    R0,WORKAREA           ADDRESS OF USER DSA SECTION        01170000
         LA    R1,WORKLEN            LENGTH  OF USER DSA SECTION        01180000
         SR    R15,R15               PREPARE FOR CLEAR                  01190000
         MVCL  R0,R14                CLEAR USER DSA SECTION             01200000
                                                                        01210000
*---------------------------------------------------------------------- 01220000
* INITIALIZATION                                                        01230000
*---------------------------------------------------------------------- 01240000
                                                                        01250000
         @RESTENV ,                  ENSURE ENVIRONMENT                 01260000
                                                                        01270000
         L     RIVTAM,ICTVTCVT       ESTABLISH IVTAMCVT POINTER         01280000
                                                                        01290000
         MVC   CONVID,=XL8'55AA55AA55AA55AA'                            01300000
         MVC   CONVS,=XL4'55AA55AA'                                     01310000
         MVC   BUFFER,=XL4'55AA55AA'                                    01320000
         MVC   LENGTH,=XL4'55AA55AA'                                    01330000
                                                                        01340000
         L     R1,CMLPARM4           ADDRESS OF RETURN_CODE AREA        01350000
         MVC   0(4,R1),0(R1)         TEST MOVEMENT                      01360000
                                                                        01370000
         ICM   R1,15,CMLPARM1        ADDRESS OF CONVERSATION ID         01380000
         BNP   INITERR               BRANCH IF BAD                      01390000
         MVC   CONVID,0(R1)          COPY CONVID                        01400000
                                                                        01410000
         ICM   R1,15,CMLPARM3        ADDRESS OF CNOS VARIABLE LENGTH    01420000
         BNP   INITERR               BRANCH IF BAD                      01430000
         ICM   R3,15,0(R1)           CNOS VARIABLE LENGTH               01440000
         ST    R3,LENGTH             SAVE LENGTH                        01450000
         BM    INITERR               BRANCH IF BAD                      01460000
         BZ    INITERR2              BRANCH IF ZERO LENGTH              01470000
         C     R3,=F'25'             CHECK MAXIMUM LENGTH               01480000
         BH    INITERR2              BRANCH IF BAD                      01490000
         C     R3,=F'17'             CHECK MINIMUM LENGTH               01500000
         BL    INITERR2              BRANCH IF BAD                      01510000
         ICM   R2,15,CMLPARM2        ADDRESS OF CNOS VARIABLE           01520000
         ST    R2,BUFFER             SAVE BUFFER ADDRESS                01530000
         BNP   INITERR               BRANCH IF BAD                      01540000
         LA    R14,CNOSCOPY          COPY AREA                          01550000
         LA    R15,L'CNOSCOPY        LENGTH OF COPY AREA                01560000
         MVCL  R14,R2                COPY THE CNOS VARIABLE             01570000
         B     INITEND                                                  01580000
                                                                        01590000
INITERR  DS    0H                                                       01600000
                                                                        01610000
         OI    FLAG,FLAGIERR         REMEMBER ERROR DETECTED            01620000
         B     INITEND                                                  01630000
                                                                        01640000
INITERR2 DS    0H                                                       01650000
                                                                        01660000
         OI    FLAG,FLAGIER2         REMEMBER ERROR DETECTED            01670000
                                                                        01680000
INITEND  DS    0H                                                       01690000
                                                                        01700000
*---------------------------------------------------------------------- 01710000
* ENTRY TRACE                                                           01720000
*---------------------------------------------------------------------- 01730000
                                                                        01740000
         $TRACE *=A(TRC_CPIC_ICPXPCV),80  TRACE ENTRY W/ 80 USER BYTES  01750000
         BNZ   NOETRACE              BRANCH IF NOT TRACING              01760000
         $APITRC ICPXPCV             TRACE COMMON STUFF                 01770000
         ST    RCMLIST,24(,R1)       TRACE PARMLIST ADDRESS             01780000
         MVC   32(8,R1),CONVID       TRACE CONVERSATION ID              01790000
         MVC   28(4,R1),LENGTH       TRACE CNOS VAR LENGTH              01800000
         MVC   40(4,R1),BUFFER       TRACE CNOS VAR ADDRESS             01810000
         MVC   44(25,R1),CNOSCOPY    TRACE CNOS VARIABLE                01820000
NOETRACE DS    0H                                                       01830000
                                                                        01840000
*---------------------------------------------------------------------- 01850000
* LOCATE SPECIFIED CONVERSATION                                         01860000
*---------------------------------------------------------------------- 01870000
                                                                        01880000
         TM    FLAG,FLAGIERR         ERROR DETECTED ALREADY?            01890000
         BO    ERRPROD               BRANCH IF YES                      01900000
                                                                        01910000
         TM    FLAG,FLAGIER2         ERROR DETECTED ALREADY?            01920000
         BO    ERRPARM               BRANCH IF YES                      01930000
                                                                        01940000
         LA    R1,CONVID             ADDRESS OF CONVERSATION ID         01950000
         L     R15,ICP@LOC           ENTRY POINT OF TKB/RCB LOCATE      01960000
         BASR  R14,R15               LOCATE THE TKB/RCB                 01970000
         LTR   RTKB,R1               TKB ADDRESS                        01980000
         BNP   ERRPARM               BRANCH IF BAD                      01990000
         LTR   RRCB,R0               RCB ADDRESS                        02000000
         BNP   ERRPARM               BRANCH IF BAD                      02010000
                                                                        02020000
         MVC   CONVS,RCBCONVS        COPY CONV STATE                    02030000
                                                                        02040000
*---------------------------------------------------------------------- 02050000
* VALIDATE THE CNOS VARIABLE                                            02060000
*---------------------------------------------------------------------- 02070000
                                                                        02080000
         SR    R1,R1                                                    02090000
         ICM   R1,B'0011',CVARLEN    SPECIFIED LENGTH                   02100000
         BNP   ERRPERR               BRANCH IF NEGATIVE                 02110000
         C     R1,=F'17'             AT LEAST MINIMUM?                  02120000
         BL    ERRPERR               BRANCH IF NOT                      02130000
         C     R1,=F'25'             MORE THAN MAXIMUM?                 02140000
         BH    ERRPERR               BRANCH IF YES                      02150000
         C     R1,LENGTH             IMBEDDED LENGTH = EXPLICIT LENGTH? 02160000
         BNE   ERRPERR               BRANCH IF NOT                      02170000
                                                                        02180000
         CLC   CVARID,=X'1210'       PROPER GDS ID?                     02190000
         BNE   ERRPERR               BRANCH IF NOT                      02200000
                                                                        02210000
         SR    R1,R1                 CLEAR FOR IC                       02220000
         IC    R1,CVARMLEN           MODENAME LENGTH                    02230000
         C     R1,=F'8'              MORE THAN MAXIMUM?                 02240000
         BH    ERRPERR               BRANCH IF YES                      02250000
         ICM   R1,B'1000',=C' '      PADDING CHARACTER                  02260000
         LA    R0,CVARNAME           ADDRESS OF MODE NAME               02270000
         LA    R14,MODECOPY          COPY AREA                          02280000
         LA    R15,8                 COPY AREA LENGTH                   02290000
         MVCL  R14,R0                COPY & PAD THE MODE NAME           02300000
                                                                        02310000
*---------------------------------------------------------------------- 02320000
* RESERVE THE SESSION                                                   02330000
*---------------------------------------------------------------------- 02340000
                                                                        02350000
         BAS   R14,VTAMLOCK                                             02360000
                                                                        02370000
         $SESS $SESS_FIND_SESSION,                                     +02380000
               SESSION=RCBHSID,                                        +02390000
               ERRET=ERRPROD,                                          +02400000
               MF=(E,$SESSMFL)       LOCATE ASSOCIATED ISESS, IF ANY    02410000
                                                                        02420000
X        USING SPLIST,$SESSMFL                                          02430000
         L     RISESS,X.SPLAREA      ADDRESS OF ASSOCIATED ISESS BLOCK  02440000
         DROP  X                                                        02450000
                                                                        02460000
         TM    ISEF1,ISEF1TRM        SESS TERM STARTED?                 02470000
         BO    ERRPROD               BRANCH IF YES                      02480000
         TM    ISE62FL2,ISE62DRD     IS DRIVER DOWN?                    02490000
         BO    ERRPROD               BRANCH IF YES                      02500000
                                                                        02510000
*---------------------------------------------------------------------- 02520000
* PROCESS A SET REPLY - SINGLE MODE                                     02530000
*---------------------------------------------------------------------- 02540000
                                                                        02550000
         CLI   CVARSERV,CVARSERV_REQUEST                                02560000
         BE    REQUEST               BRANCH IF NOT A CNOS REPLY         02570000
                                                                        02580000
         CLI   CVARSERV,CVARSERV_REPLY_ABNORMAL                         02590000
         BE    RPS1                  BRANCH IF CNOS REPLY               02600000
         CLI   CVARSERV,CVARSERV_REPLY_ACCEPTED                         02610000
         BNE   ERRPERR               BRANCH IF NOT A CNOS REPLY         02620000
                                                                        02630000
RPS1     DS    0H                                                       02640000
                                                                        02650000
         CLI   CVARACT,CVARACT_CLOSE                                    02660000
         BE    RPC1                  BRANCH IF THIS IS A CLOSE REPLY    02670000
         CLI   CVARACT,CVARACT_SET                                      02680000
         BNE   ERRPERR               BRANCH IF THE ACTION IS BAD        02690000
         CLI   CVARMSEL,CVARMSEL_ALL                                    02700000
         BE    ERRPERR               BRANCH IF ALL WAS SELECTED         02710000
         BAS   R14,DISPMODE          LOCATE THE MDE                     02720000
         OC    L62RETCD,L62RETCD     GOOD RETURN CODE?                  02730000
         BNZ   ERRPERR               BRANCH IF NOT, MODE SHOULD EXIST   02740000
         ICM   R3,15,L62RETMD        RETURNED MDE                       02750000
         BNP   ERRPROD               BRANCH IF DOESN'T LOOK GOOD        02760000
                                                                        02770000
X        USING MDE,R3                                                   02780000
         TM    X.MDEF1,MDEF1CNI      IS CNOS NEGOTIATION UNDERWAY?      02790000
         BNO   ERROPER               BRANCH IF NOT...SHOULD BE          02800000
                                                                        02810000
         CLI   CVARSERV,CVARSERV_REPLY_ABNORMAL                         02820000
         BE    RPS1Q                 BRANCH IF REQUEST WAS NOT ACCEPTED 02830000
         SR    R1,R1                 CLEAR FOR ICM                      02840000
         ICM   R1,B'0011',CVARSLIM   SESSION LIMIT                      02850000
         BNP   RPS1BADV              BRANCH IF BAD VALUE                02860000
         SR    R2,R2                 CLEAR FOR ICM                      02870000
         ICM   R2,B'0011',CVARSWIN   MIN_CONWINNERS_SOURCE              02880000
         SR    R1,R2                 MAKE SURE MIN'S ARE OK             02890000
         BM    RPS1BADV              BRANCH IF BAD VALUE                02900000
         ICM   R2,B'0011',CVARTWIN   MINCONWINNERS_TARGET               02910000
         SR    R1,R2                 MAKE SURE MIN'S ARE OK             02920000
         BM    RPS1BADV              BRANCH IF BAD VALUE                02930000
         CLI   CVARRESP,CVARRESP_TARGET_YES                             02940000
         BE    RPS1Q                 BRANCH IF RESPONSIBILITY IS OK     02950000
         CLI   CVARRESP,0                                               02960000
         BNE   RPS1BADV              BRANCH IF RESPONSIBILITY IS BAD    02970000
                                                                        02980000
RPS1Q    DS    0H                                                       02990000
                                                                        03000000
         LR    R1,R3                 PASS MDE IN R1                     03010000
         BAS   R14,MAKEWORK          QUEUE WORK TO IVUSER               03020000
         B     RETURN                AND EXIT                           03030000
                                                                        03040000
RPS1BADV DS    0H                                                       03050000
                                                                        03060000
         NI    X.MDEF1,255-MDEF1CNI  NO LONGER NEGOTIATING              03070000
         B     ERRPERR               AND WE ARE DONE                    03080000
                                                                        03090000
         DROP  X                                                        03100000
                                                                        03110000
*---------------------------------------------------------------------- 03120000
* PROCESS A CLOSE REPLY - SINGLE MODE                                   03130000
*---------------------------------------------------------------------- 03140000
                                                                        03150000
RPC1     DS    0H                                                       03160000
                                                                        03170000
         CLI   CVARMSEL,CVARMSEL_ALL                                    03180000
         BE    RPCA                  BRANCH IF CLOSE ALL                03190000
         BAS   R14,DISPMODE          LOCATE THE MDE                     03200000
         OC    L62RETCD,L62RETCD     GOOD RETURN CODE?                  03210000
         BNZ   ERRPERR               BRANCH IF NOT, MODE SHOULD EXIST   03220000
         ICM   R3,15,L62RETMD        RETURNED MDE                       03230000
         BNP   ERRPROD               BRANCH IF DOESN'T LOOK GOOD        03240000
                                                                        03250000
X        USING MDE,R3                                                   03260000
         TM    X.MDEF1,MDEF1CNI      IS CNOS NEGOTIATION UNDERWAY?      03270000
         BNO   ERROPER               BRANCH IF NOT...SHOULD BE          03280000
                                                                        03290000
         CLI   CVARSERV,CVARSERV_REPLY_ABNORMAL                         03300000
         BE    RPC1Q                 BRANCH IF REQUEST WAS NOT ACCEPTED 03310000
         CLI   CVARRESP,CVARRESP_TARGET_YES                             03320000
         BE    RPC1Q                 BRANCH IF RESPONSIBILITY IS OK     03330000
         CLI   CVARRESP,0                                               03340000
         BNE   RPC1BADV              BRANCH IF RESPONSIBILITY IS BAD    03350000
                                                                        03360000
RPC1Q    DS    0H                                                       03370000
                                                                        03380000
         LR    R1,R3                 PASS MDE IN R1                     03390000
         BAS   R14,MAKEWORK          QUEUE WORK TO IVUSER               03400000
         B     RETURN                AND EXIT                           03410000
                                                                        03420000
RPC1BADV DS    0H                                                       03430000
                                                                        03440000
         NI    X.MDEF1,255-MDEF1CNI  NO LONGER NEGOTIATING              03450000
         B     ERRPERR               AND WE ARE DONE                    03460000
                                                                        03470000
         DROP  X                                                        03480000
                                                                        03490000
*---------------------------------------------------------------------- 03500000
* PROCESS A CLOSE REPLY - ALL MODES                                     03510000
*---------------------------------------------------------------------- 03520000
                                                                        03530000
RPCA     DS    0H                                                       03540000
                                                                        03550000
X        USING MDE,R3                                                   03560000
         L     R3,ISEIVUSR           IVUSER ADDRESS                     03570000
         LA    R3,IVUMD1ST-IVUSER(,R3)                                  03580000
         S     R3,=A(MDENEXT-MDE)    GET SET TO RUN THE CHAIN           03590000
                                                                        03600000
RPCARUN  DS    0H                                                       03610000
                                                                        03620000
         ICM   R3,15,X.MDENEXT       LINK TO THE NEXT MDE               03630000
         BM    RPCAQ                 BRANCH IF ALL HAVE BEEN CHECKED    03640000
         CLC   X.MDENAME,=CL8'SNASVCMG'                                 03650000
         BE    RPCARUN               BRANCH IF SPECIAL MODENAME         03660000
         TM    X.MDEF1,MDEF1CNI      IS CNOS NEGOTIATION UNDERWAY?      03670000
         BO    RPCARUN               BRANCH IF YES                      03680000
         B     ERROPER               BRANCH IF NOT...SHOULD BE          03690000
                                                                        03700000
RPCAQ    DS    0H                                                       03710000
                                                                        03720000
         SR    R1,R1                 NO MDE FOR ALL MODES               03730000
         BAS   R14,MAKEWORK          QUEUE WORK TO IVUSER               03740000
         B     RETURN                AND EXIT                           03750000
                                                                        03760000
         DROP  X                                                        03770000
                                                                        03780000
*---------------------------------------------------------------------- 03790000
* PROCESS A SET REQUEST - SINGLE MODE                                   03800000
*---------------------------------------------------------------------- 03810000
                                                                        03820000
REQUEST  DS    0H                                                       03830000
                                                                        03840000
X        USING IVUSER,R3                                                03850000
         L     R3,ISEIVUSR           IVUSER ADDRESS                     03860000
         TM    X.IVUF1,IVUF1CAM      CLOSE ALL IN EFFECT?               03870000
         BO    REJZERO               BRANCH IF YES                      03880000
         DROP  X                                                        03890000
                                                                        03900000
         CLI   CVARACT,CVARACT_SET                                      03910000
         BE    RQS1                  BRANCH IF SET REQUEST              03920000
         CLI   CVARACT,CVARACT_CLOSE                                    03930000
         BE    RQC1                  BRANCH IF CLOSE REQUEST            03940000
         B     ERRPERR               IT IS UNACCEPTABLE                 03950000
                                                                        03960000
RQS1     DS    0H                                                       03970000
                                                                        03980000
         CLC   MODECOPY,=CL8'SNASVCMG'                                  03990000
         BE    REJMODE               REJECT IF SPECIAL MODENAME         04000000
                                                                        04010000
         SR    R1,R1                 CLEAR FOR ICM                      04020000
         ICM   R1,B'0011',CVARSLIM   SESSION LIMIT                      04030000
         BNP   ERRPERR               BRANCH IF BAD VALUE                04040000
         SR    R2,R2                 CLEAR FOR ICM                      04050000
         ICM   R2,B'0011',CVARSWIN   MIN_CONWINNERS_SOURCE              04060000
         SR    R1,R2                 MAKE SURE MIN'S ARE OK             04070000
         BM    ERRPERR               BRANCH IF BAD VALUE                04080000
         ICM   R2,B'0011',CVARTWIN   MINCONWINNERS_TARGET               04090000
         SR    R1,R2                 MAKE SURE MIN'S ARE OK             04100000
         BM    ERRPERR               BRANCH IF BAD VALUE                04110000
         BAS   R14,DISPMODE          LOCATE THE MDE                     04120000
         OC    L62RETCD,L62RETCD     GOOD RETURN CODE?                  04130000
         BNZ   RQS1DFMD              BRANCH IF NOT, DEFINE IT           04140000
         ICM   R3,15,L62RETMD        RETURNED MDE                       04150000
         BNP   REJMODE               BRANCH IF DOESN'T LOOK GOOD        04160000
         B     RQS1CNI               BRANCH IF MODE WAS FOUND           04170000
                                                                        04180000
RQS1DFMD DS    0H                                                       04190000
                                                                        04200000
         L62DFMD *ISEIVUSR,          @PARTNERLU                        +04210000
               MODECOPY,             @MODENAME                         +04220000
               =F'8',                @MODENAME_LENGTH                  +04230000
               L62RETMD,             @MDE RETURN AREA                  +04240000
               L62RETCD,             @RETURN CODE AREA                 +04250000
               MF=(E,L62MFL)                                            04260000
                                                                        04270000
         OC    L62RETCD,L62RETCD     GOOD RETURN CODE?                  04280000
         BNZ   REJMODE               BRANCH IF NOT...WE MUST REJECT IT  04290000
         ICM   R3,15,L62RETMD        RETURNED MDE                       04300000
         BNP   REJMODE               BRANCH IF DOESN'T LOOK GOOD        04310000
                                                                        04320000
RQS1CNI  DS    0H                                                       04330000
                                                                        04340000
X        USING MDE,R3                                                   04350000
         TM    X.MDEF1,MDEF1CNI      IS CNOS NEGOTIATION UNDERWAY?      04360000
         BO    REJRACE               BRANCH IF YES...RACE               04370000
         OI    X.MDEF1,MDEF1CNI      SHOW NEGOTIATION IN PROGRESS       04380000
         LR    R1,R3                 PASS MDE IN R1                     04390000
         BAS   R14,MAKEWORK          QUEUE WORK TO IVUSER               04400000
         B     ACCEPT                GO CONVERT REQUEST TO A RESPONSE   04410000
                                                                        04420000
         DROP  X                                                        04430000
                                                                        04440000
*---------------------------------------------------------------------- 04450000
* PROCESS A CLOSE REQUEST - SINGLE MODE                                 04460000
*---------------------------------------------------------------------- 04470000
                                                                        04480000
RQC1     DS    0H                                                       04490000
                                                                        04500000
         TM    CVARMSEL,CVARMSEL_ALL                                    04510000
         BO    RQCA                  BRANCH IF ALL MODES                04520000
                                                                        04530000
         CLC   MODECOPY,=CL8'SNASVCMG'                                  04540000
         BE    REJMODE               REJECT IF SPECIAL MODENAME         04550000
                                                                        04560000
         BAS   R14,DISPMODE          LOCATE THE MDE                     04570000
         CLC   L62RETCD,=A(LU62_RESOURCE_NOT_FOUND)                     04580000
         BE    ACCEPT                IF MODE ISN'T THERE...IT IS CLOSED 04590000
         OC    L62RETCD,L62RETCD     GOOD RETURN CODE?                  04600000
         BNZ   REJMODE               BRANCH IF NOT...WE MUST REJECT IT  04610000
         ICM   R3,15,L62RETMD        RETURNED MDE                       04620000
         BNP   REJMODE               BRANCH IF DOESN'T LOOK GOOD        04630000
                                                                        04640000
X        USING MDE,R3                                                   04650000
         TM    X.MDEF1,MDEF1CNI      IS CNOS NEGOTIATION UNDERWAY?      04660000
         BO    REJRACE               BRANCH IF YES...RACE               04670000
         OI    X.MDEF1,MDEF1CNI      SHOW NEGOTIATION IN PROGRESS       04680000
         LR    R1,R3                 PASS MDE IN R1                     04690000
         BAS   R14,MAKEWORK          QUEUE WORK TO IVUSER               04700000
         B     ACCEPT                GO CONVERT REQUEST TO A RESPONSE   04710000
                                                                        04720000
         DROP  X                                                        04730000
                                                                        04740000
*---------------------------------------------------------------------- 04750000
* PROCESS A CLOSE REQUEST - ALL MODES                                   04760000
*---------------------------------------------------------------------- 04770000
                                                                        04780000
RQCA     DS    0H                                                       04790000
                                                                        04800000
X        USING MDE,R3                                                   04810000
         L     R3,ISEIVUSR           IVUSER ADDRESS                     04820000
         LA    R3,IVUMD1ST-IVUSER(R3) ADDRESS OF MDE HEAD               04830000
         S     R3,=A(MDENEXT-MDE)    NORMALIZE FOR CHAIN RUN            04840000
                                                                        04850000
RQCARUN  DS    0H                                                       04860000
                                                                        04870000
         ICM   R3,15,X.MDENEXT       NEXT MDE IN LIST                   04880000
         BM    RQCACKD               BRANCH IF ALL DONE                 04890000
         TM    X.MDEF1,MDEF1CNI      IS NEGOTIATION IN PROGRESS?        04900000
         BNO   RQCARUN               BRANCH IF NOT...CHECK THEM ALL     04910000
         B     REJRACE               BRANCH IF NEGOTIATING ALREADY      04920000
                                                                        04930000
RQCACKD DS     0H                                                       04940000
                                                                        04950000
         L     R3,ISEIVUSR           IVUSER ADDRESS                     04960000
         LA    R3,IVUMD1ST-IVUSER(R3) ADDRESS OF MDE HEAD               04970000
         S     R3,=A(MDENEXT-MDE)    NORMALIZE FOR CHAIN RUN            04980000
                                                                        04990000
RQCARUN2 DS    0H                                                       05000000
                                                                        05010000
         ICM   R3,15,X.MDENEXT       NEXT MDE IN LIST                   05020000
         BM    RQCARAN               BRANCH IF ALL DONE                 05030000
         OI    X.MDEF1,MDEF1CNI      SHOW NEGOTIATION IN PROGRESS       05040000
         B     RQCARUN2              SET NEGOTIATION FOR ALL MODES      05050000
                                                                        05060000
RQCARAN  DS    0H                                                       05070000
                                                                        05080000
         SR    R1,R1                 NO MDE FOR ALL MODES               05090000
         BAS   R14,MAKEWORK          QUEUE WORK TO IVUSER               05100000
         B     ACCEPT                GO CONVERT REQUEST TO A RESPONSE   05110000
                                                                        05120000
         DROP  X                                                        05130000
                                                                        05140000
*---------------------------------------------------------------------- 05150000
* CHANGE THE REQUEST TO A RESPONSE                                      05160000
*---------------------------------------------------------------------- 05170000
                                                                        05180000
ACCEPT   DS    0H                                                       05190000
                                                                        05200000
         MVI   CVARSERV,CVARSERV_REPLY_ACCEPTED                         05210000
         B     COPYBACK                                                 05220000
                                                                        05230000
REJZERO  DS    0H                                                       05240000
                                                                        05250000
         MVI   CVARSERV,CVARSERV_REPLY_ABNORMAL                         05260000
         MVI   CVARRMOD,CVARRMOD_ABNORMAL_ZERO                          05270000
         B     COPYBACK                                                 05280000
                                                                        05290000
REJRACE  DS    0H                                                       05300000
                                                                        05310000
X        USING MDE,R3                                                   05320000
         OI    X.MDEF1,MDEF1LDN      MODE LOCK WAS DENIED TO REQUESTOR  05330000
         DROP  X                                                        05340000
         MVI   CVARSERV,CVARSERV_REPLY_ABNORMAL                         05350000
         MVI   CVARRMOD,CVARRMOD_ABNORMAL_RACE                          05360000
         B     COPYBACK                                                 05370000
                                                                        05380000
REJMODE  DS    0H                                                       05390000
                                                                        05400000
         MVI   CVARSERV,CVARSERV_REPLY_ABNORMAL                         05410000
         MVI   CVARRMOD,CVARRMOD_ABNORMAL_MODE                          05420000
         B     COPYBACK                                                 05430000
                                                                        05440000
COPYBACK DS    0H                                                       05450000
                                                                        05460000
         L     R0,BUFFER             ADDRESS OF INPUT CNOS VARIABLE     05470000
         L     R1,LENGTH             LENGTH  OF INPUT CNOS VARIABLE     05480000
         LR    R15,R1                COPY LENGTH                        05490000
         LA    R14,CNOSCOPY          ADDRESS OF LOCAL CNOS COPY         05500000
         MVCL  R0,R14                COPY CNOS VARIABLE BACK TO USER    05510000
         B     RETURN                ALL DONE                           05520000
                                                                        05530000
*---------------------------------------------------------------------- 05540000
* EXCEPTION ROUTINES                                                    05550000
*---------------------------------------------------------------------- 05560000
                                                                        05570000
ERROPER  DS    0H                                                       05580000
                                                                        05590000
         MVC   RETCODE,=A(CM_OPERATION_NOT_ACCEPTED)                    05600000
         B     RETURN                                                   05610000
                                                                        05620000
ERRPROD  DS    0H                                                       05630000
                                                                        05640000
         MVC   RETCODE,=A(CM_PRODUCT_SPECIFIC_ERROR)                    05650000
         B     RETURN                                                   05660000
                                                                        05670000
ERRPARM  DS    0H                                                       05680000
                                                                        05690000
         MVC   RETCODE,=A(CM_PROGRAM_PARAMETER_CHECK)                   05700000
         B     RETURN                                                   05710000
                                                                        05720000
ERRPERR  DS    0H                                                       05730000
                                                                        05740000
         MVC   RETCODE,=A(CM_PARAMETER_ERROR)                           05750000
         B     RETURN                                                   05760000
                                                                        05770000
*---------------------------------------------------------------------- 05780000
* EXIT TRACE AND RETURN TO CALLER                                       05790000
*---------------------------------------------------------------------- 05800000
                                                                        05810000
RETURN   DS    0H                                                       05820000
                                                                        05830000
         BAS   R14,VTAMUNLK          RELEASE THE LOCK IF NECESSARY      05840000
                                                                        05850000
         $TRACE *=A(TRC_CPIC_EXIT),48                                   05860000
         BNZ   NOXTRACE              BRANCH IF TRACING NOT AVAILABLE    05870000
         MVC   0(8,R1),=CL8'ICPXPCV' MODULE NAME                        05880000
         MVC   8(4,R1),RETCODE       RETURN_CODE VALUE                  05890000
         MVC   12(8,R1),CONVID       CONVERSATION ID                    05900000
         MVC   20(4,R1),CONVS        CONVERSATION STATE                 05910000
NOXTRACE DS    0H                                                       05920000
                                                                        05930000
         L     R1,CMLPARM4           ADDRESS OF RETURN_CODE AREA        05940000
         MVC   0(4,R1),RETCODE       SET RETURN_CODE VARIABLE           05950000
                                                                        05960000
         SR    R15,R15               FUNCTION RETURN CODE = 0           05970000
         CEXIT RC=(R15),INDEP=YES    RETURN                             05980000
                                                                        05990000
*---------------------------------------------------------------------- 06000000
* SUBROUTINE DISPMODE - LOCATES THE MDE FOR A GIVEN MODENAME            06010000
*                                                                       06020000
* ENTRY            R14 = RETURN ADDRESS                                 06030000
*                  RISESS = ISESS ADDRESS                               06040000
*                  MODECOPY = MODE NAME (BLANK FOR ALL MODES)           06050000
*                                                                       06060000
* RETURNS          ALL REGISTERS ARE RESTORED                           06070000
*                  L62RETCD = RETURN CODE FROM DISPLAY OPERATION        06080000
*                  L62RETMD = MDE ADDRESS FOR SUCCESSFUL DISPLAY        06090000
*---------------------------------------------------------------------- 06100000
                                                                        06110000
DISPMODE DS    0H                                                       06120000
                                                                        06130000
         STM   R14,R12,SUB0SAVE      SAVE REGISTERS                     06140000
                                                                        06150000
         L62DSMD *ISEIVUSR,          @PARTNERLU                        +06160000
               MODECOPY,             @MODENAME                         +06170000
               =F'8',                @MODENAME_LENGTH                  +06180000
               L62RETMD,             @MDE RETURN AREA                  +06190000
               L62RETCD,             @RETURN CODE AREA                 +06200000
               MF=(E,L62MFL)                                            06210000
                                                                        06220000
         LM    R14,R12,SUB0SAVE      RESTORE REGISTERS                  06230000
         BR    R14                   AND RETURN TO CALLER W/R15         06240000
                                                                        06250000
*---------------------------------------------------------------------- 06260000
* SUBROUTINE MAKEWORK - CREATE AND QUEUE A CNOS PROCESSING WORK ELEMENT 06270000
*                                                                       06280000
* ENTRY            R14 = RETURN ADDRESS                                 06290000
*                  R01 = MDE ADDRESS (0 FOR ALL MODES)                  06300000
*                  RISESS = ISESS ADDRESS                               06310000
*                  CNOSCOPY = THE CNOS VARIABLE AS RECEIVED             06320000
*                  MODECOPY = MODE NAME (BLANK FOR ALL MODES)           06330000
*                                                                       06340000
* RETURNS          ALL REGISTERS ARE RESTORED                           06350000
*---------------------------------------------------------------------- 06360000
                                                                        06370000
MAKEWORK DS    0H                                                       06380000
                                                                        06390000
         STM   R14,R12,SUB0SAVE      SAVE REGISTERS                     06400000
         LR    R3,R1                 SAVE MDE ADDRESS                   06410000
                                                                        06420000
         $VTAMWE L'IWEY7,            SIZE                              +06430000
               IWECPCV               CODE                               06440000
                                                                        06450000
Y        USING IWEVTAM,R1                                               06460000
         STCM  R3,15,Y.IWEY7MDE      SET MDE ADDRESS                    06470000
         MVC   Y.IWEY7NME,MODECOPY   SET LOGMODE NAME                   06480000
         MVC   Y.IWEY7TKN,ISETK      SET SESSION TOKEN                  06490000
         MVC   Y.IWEY7VAR,CNOSCOPY   SET THE CNOS VARIABLE              06500000
                                                                        06510000
         L     R2,ISEIVUSR           IVUSER ADDRESS                     06520000
         LA    R0,IVUWEQ-IVUSER(,R2) QUEUEING ADDRESS                   06530000
         BAS   R14,QWE               QUEUE THE WORK ELEMENT             06540000
                                                                        06550000
         LM    R14,R12,SUB0SAVE      RESTORE REGISTERS                  06560000
         BR    R14                   AND RETURN TO CALLER W/R15         06570000
                                                                        06580000
*---------------------------------------------------------------------- 06590000
* SUBROUTINE QWE - QUEUE A WORK ELEMENT TO A GIVEN WORK QUEUE           06600000
*                                                                       06610000
* ENTRY            R14 = RETURN ADDRESS                                 06620000
*                  R1  = WORK ELEMENT ADDRESS                           06630000
*                  R0  = QUEUE ADDRESS                                  06640000
*                                                                       06650000
* RETURNS          R15 = 0 --> QUEUEING WAS SUCCESSFUL                  06660000
*                      = 4 --> QUEUEING FAILED, WORK ELEMENT RELEASED   06670000
*---------------------------------------------------------------------- 06680000
                                                                        06690000
QWE      DS    0H                                                       06700000
                                                                        06710000
         STM   R14,R4,SUB1SAVE       SAVE REGISTERS                     06720000
         LR    R3,R0                 SAVE QUEUE ADDRESS                 06730000
         LR    R4,R1                 SAVE WORK ELEMENT ADDRESS          06740000
                                                                        06750000
         $VTAMQ (R4),                WORK ELEMENT                      +06760000
               (R3)                  QUEUE                              06770000
                                                                        06780000
         L     R14,SUB1SAVE          RESTORE REGISTERS                  06790000
         LM    R0,R4,SUB1SAVE+8      RESTORE REGISTERS                  06800000
         BR    R14                   AND RETURN TO CALLER W/R15         06810000
                                                                        06820000
*---------------------------------------------------------------------- 06830000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 06840000
*---------------------------------------------------------------------- 06850000
                                                                        06860000
VTAMLOCK DS    0H                                                       06870000
                                                                        06880000
         TM    FLAG,FLAGLOCK         WAS THE LOCK ALREADY OBTAINED?     06890000
         BOR   R14                   RETURN IF YES                      06900000
         STM   R14,R2,SUB0SAVE       SAVE CALLER'S REGISTERS            06910000
                                                                        06920000
         $SER  OBTAIN,                                                 +06930000
               VTAM                                                     06940000
                                                                        06950000
         C     R15,=F'4'             WAS LOCK ALREADY HELD?             06960000
         BNE   VTAMLOEX              BRANCH IF NOT                      06970000
         OI    FLAG,FLAGLCKD         REMEMBER LOCK HELD ON ENTRY        06980000
                                                                        06990000
VTAMLOEX DS    0H                                                       07000000
                                                                        07010000
         OI    FLAG,FLAGLOCK         REMEMBER LOCK IS HELD              07020000
         LM    R14,R2,SUB0SAVE       RESTORE CALLER'S REGISTERS         07030000
         BR    R14                   RETURN                             07040000
                                                                        07050000
*---------------------------------------------------------------------- 07060000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                07070000
*---------------------------------------------------------------------- 07080000
                                                                        07090000
VTAMUNLK DS    0H                                                       07100000
                                                                        07110000
         TM    FLAG,FLAGLOCK         IS LOCK HELD?                      07120000
         BNOR  R14                   BRANCH IF NOT                      07130000
         TM    FLAG,FLAGLCKD         WAS LOCK HELD ON ENTRY?            07140000
         BOR   R14                   DON'T RELEASE IF IT WAS            07150000
         STM   R14,R2,SUB0SAVE       SAVE CALLER'S REGISTERS            07160000
                                                                        07170000
         $SER  RELEASE,                                                +07180000
               VTAM                                                     07190000
                                                                        07200000
         NI    FLAG,255-FLAGLOCK     SHOW LOCK NOT HELD                 07210000
         LM    R14,R2,SUB0SAVE       RESTORE CALLER'S REGISTERS         07220000
         BR    R14                   RETURN                             07230000
                                                                        07240000
*---------------------------------------------------------------------- 07250000
* ERROR ROUTINES                                                        07260000
*---------------------------------------------------------------------- 07270000
                                                                        07280000
ERR$TASK DS    0H                                                       07290000
                                                                        07300000
         $ABEND ABE_VTDIAG,                                            +07310000
               SCOPE=PCB,                                              +07320000
               TITLE='$TASK FAILURE'                                    07330000
                                                                        07340000
*---------------------------------------------------------------------- 07350000
* LITERALS AND CONSTANTS                                                07360000
*---------------------------------------------------------------------- 07370000
                                                                        07380000
         LTORG ,                                                        07390000
                                                                        07400000
         PRINT NOGEN                                                    07410000
         ISTDBIND ,               VTAM BIND IMAGE                       07420000
         ISTRH ,                  VTAM SNA REQUEST HEADER               07430000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                07440000
         IKJTCB ,                 MVS TASK CONTROL BLOCK                07450000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         07460000
         ICVT  ,                  INTEGRATOR CVT                        07470000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   07480000
         ITASK ,                  INTEGRATOR TASK BLOCK                 07490000
         IPCB ,                   INTEGRATOR PROCESS BLOCK              07500000
         IACB ,                   INTEGRATOR VTAM ACB                   07510000
         ABCODES ,                INTEGRATOR $ABEND CODES               07520000
         EVCODES ,                INTEGRATOR EVENT CODES                07530000
         ISESS ,                  INTEGRATOR SESSION BLOCK              07540000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            07550000
         IRPL ,                   INTEGRATOR VTAM RPL                   07560000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          07570000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             07580000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             07590000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             07600000
         END   ,                                                        07610000

ITIUPDT  TITLE '- TABLE INTERFACE - TABLE UPDATE BY SARG'               00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: ITIUPDT - TABLE INTERFACE - SARG UPDATE REQUEST              00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THIS ROUTINE PROCESS REQUEST FROM THE PC TABLE INTERFACE           00080000
*    FACILITY TO UPDATE A LIST OF TABLES (MULTIPLE ROW) IN              00090000
*    A SINGLE REQUEST BLOCK.  THIS REQUEST BLOCK ALLOW TABLE            00100000
*    ROWS TO BE SELECTED VIA THE SARG LIST SPECIFICATION                00110000
*    OR A ROWID KEY.  SELECTED ROWS MAY EITHER BE UPDATED               00120000
*    OR DELETED.  TABLE ROWS WHICH ARE SELECTED TO BE UPDATED           00130000
*    ARE HAVE THE COLUMN VALUES REPLACE AS SPECIFIED BY THE             00140000
*    NEW VALUE DATA IN THE REQUEST BLOCK.  THE VALUES SPECIFIED         00150000
*    IN THE COLUMN ENTRIES OF THE REQUEST BLOCK MUST BE FIXED           00160000
*    LENGTH AND IN THE APPROPIATE TBCOLDEF FORMAT FROM THE              00170000
*    CLIENT REQUESTOR.                                                  00180000
*                                                                       00190000
*                                                                       00200000
* ON ENTRY:                                                             00210000
*                                                                       00220000
*    R1  POINTS TO A PARAMETER LIST DESCRIBED BY THE @TIUPDT            00230000
*        MAPPING                                                        00240000
*                                                                       00250000
*    R0  CONTAINS THE ADDRESS OF A WORKAREA NO SMALLER THAN             00260000
*        THE LENGTH DEFINED LENGTH= OPERAND SPECIFIED ON THE            00270000
*        #WORK MACRO.                                                   00280000
*                                                                       00290000
* ON EXIT:                                                              00300000
*                                                                       00310000
*    A RESPONSE BLOCK IS CONSTRUCTED TO CONVEY THE RESULTS OF           00320000
*    THE TABLE UPDATE REQUEST.  WHEN THE RETURN CODES IS                00330000
*    NON-ZERO, THE RESPONSE STRING APPENDED TO THE RESPONSE             00340000
*    HEADER AND ADDRESSED VIA TMRSDATA, TMRSDATL CONTAINS A             00350000
*    SUITABLE ERROR MESSAGE.                                            00360000
*                                                                       00370000
*    THE RESPONSE AREA WILL CONTAIN ONE OF THE FOLLOW RETURN            00380000
*    AND REASON CODE PAIR.  THESE ARE ALSO REFLECTED TO THE             00390000
*    CALLER VIA R15 AND R0.  R1 CONTAINS A TABLE SERVICES               00400000
*    DIAGNOSTIC IN THE COMMON ERROR SITUATIONS.                         00410000
*                                                                       00420000
*       RC00 - REQUEST COMPLETED WITHOUT ERROR                          00430000
*                                                                       00440000
*       RC04 - INSUFFICIENT RESPONSE BUFFER ALLOCATION                  00450000
*                                                                       00460000
*       RC08 - TABLE SERVICES RETURNED AN ERROR STATUS WHEN             00470000
*              PRESENTED WITH ONE OF THE SOURCE (INPUT) ROWS.           00480000
*                                                                       00490000
*              RSN04 - REQ SERVICE FAILURE                              00500000
*              RSN08 - INTERNAL TABLE SERVICE FAILURE                   00510000
*              RSN12 - PROJECT NOT OPEN                                 00520000
*                                                                       00530000
*              SUPER    - 16 BIT TBSERV RSN / 16 BIT TBSERV RC          00540000
*              INFO     - TABLE SERVICES DIAGNOSTIC INFO                00550000
*                                                                       00560000
*       RC12 - REQUEST IN ERROR, REASON CODE IN TMRSRSN                 00570000
*                                                                       00580000
*              RSN08 - INVALID REQUEST                                  00590000
*              RSN12 - ENVIRONMENT ERROR                                00600000
*                                                                       00610000
*       RC20 - RESPONSE SERVICE FAILURE                                 00620000
*                                                                       00630000
**<DOC-OFF>****************************************************         00640000
                                                                        00650000
         EJECT ,                                                        00660000
***************************************************************         00670000
*                                                                       00680000
* MAINTENANCE:                                                          00690000
*                                                                       00700000
*   01/XX/93  RON COLMONE                                               00710000
*             INITIAL VERSION                                           00720000
*                                                                       00730000
*   08/05/93  RON COLMONE                                               00740000
*             CONVERTED TO NEW ENVIRONMENT                              00750000
*                                                                       00760000
***************************************************************         00770000
                                                                        00780000
         EJECT ,                                                        00790000
         @TIUPDT ,           REQUEST BLOCK FORMAT                       00800000
         EJECT ,                                                        00810000
         @TBCOLDF ,          COLUMN DEFINITION FORMAT                   00820000
         EJECT ,                                                        00830000
         TMRESP  ,           RESPONSE HEADER                            00840000
         EJECT ,                                                        00850000
         REQHDR  ,           REQUEST  HEADER                            00860000
         EJECT ,                                                        00870000
         TBSERVIS OPEN,CLOSE,DESC,SET,GET                               00880000
         EJECT ,                                                        00890000
         EQUS  ,             GENERAL EQUATES                            00900000
                                                                        00910000
         EJECT ,                                                        00920000
         #WORK LENGTH=1024   READ /WRITE WORKAREA                       00930000
REGSAVE  DS    16F           REGISTER SAVE AREA                         00940000
WRK256   DS    XL256         GENERAL SAVE AREA                          00950000
                                                                        00960000
TBLTOKN  DS    F             TABLE TOKEN                                00970000
TFORMAT  DS    A             ADDR OF TBL DESCRIBE AREA                  00980000
TFORMATL DS    F             LEN  OF TBL DESCRIBE AREA                  00990000
ROWBUFR  DS    A             ADDR OF ROW BUFFER                         01000000
ROWBUFRL DS    F             LEN  OF ROW BUFFER                         01010000
TBLSARG  DS    A             ADDR OF SARG AREA                          01020000
TBLSARGL DS    F             LEN  OF SARG AREA                          01030000
#DFSARGL EQU   2048          DEFAULT LENGTH OF SARG AREA                01040000
                                                                        01050000
GETRTN@  DS    A             ADDRESS OF TBGET ROUTINE                   01060000
CURRTBL  DS    H             TABLE  REQUEST COUNT                       01070000
SARG$OPR DS    X             RELATIONAL OPERATOR                        01080000
CNTLFLGS DS    X             CONTROL FLAGS                              01090000
CNTL$VRF EQU   X'80'            VERIFYING UPDATES                       01100000
                                                                        01110000
ERRINFO  DS    0F            R14-R1 UPON SERVICE ROUTINE FAILURE        01120000
ERR_R14  DS    F                                                        01130000
ERR_R15  DS    F                                                        01140000
ERR_R0   DS    F                                                        01150000
ERR_R1   DS    F                                                        01160000
                                                                        01170000
TBRTYP   DS    CL8           TABLE SERV REQUEST TYPE                    01180000
RETC     DS    F             RETURN CODE                                01190000
RSNC     DS    F             REASON CODE                                01200000
DIAGNOSE DS    F             DIAGNOSTICS                                01210000
SUPER    DS    F             SUPER CODE                                 01220000
MSGA     DS    A             MSG ADDRESS                                01230000
MSGLN    DS    F             MSG LENGTH                                 01240000
MSGWORK  DS    CL128         MSG WORKAREA                               01250000
                                                                        01260000
@TMRESP  DS    A             ADDR OF RESPONSE HEADER                    01270000
#RESPHDR DS    0F,XL(TMRESPLN)                                          01280000
         #ENDWORK ,          END OF WORKAREA                            01290000
                                                                        01300000
         EJECT ,                                                        01310000
ITIUPDT  #ENTER BASE=R12,WAPASS=YES,PREG=R8                             01320000
                                                                        01330000
         USING TIUPDT,R8          ESTABLISH ADDRESSABILITY              01340000
                                                                        01350000
         USING ITASK,R10          ITASK ADDRESSABILITY                  01360000
         L     R9,TSKPCBC         ADDR OF CURRENT PCB                   01370000
         USING IPCB,R9            IPCB  ADDRESSABILITY                  01380000
                                                                        01390000
*--------------------------------------------------------------         01400000
*  GENERAL INITIALIZATION                                               01410000
*--------------------------------------------------------------         01420000
         LA    R2,#RESPHDR        RESPONSE HEADER CONSTRUCTION          01430000
         ST    R2,@TMRESP         BUILD LOCAL COPY                      01440000
                                                                        01450000
         $XPBUFR ISRT,            ALLOC RESPONSE HEADER IN BUFFER      +01460000
               NEWFUNC=(TBSV,TI$UPDT),                                 +01470000
               DATA=(R2),                                              +01480000
               DATALEN=TMRESPLN,                                       +01490000
               MF=(E,MFE_LIST)                                          01500000
         LTR   R15,R15                                                  01510000
         BNZ   ERR_ITXP                                                 01520000
         ST    R1,@TMRESP         REFRESH RESPONSE HDR PTR              01530000
         OI    CNTLFLGS,CNTL$VRF  VERIFY MODIFICATION CHANGES           01540000
                                                                        01550000
         L     R7,PCBUSER         ADDR OF IUSER                         01560000
         USING IUSER,R7           TEMP ADDRESSABILITY                   01570000
         ICM   R7,15,USRPROJ      PROJECT CONTROL AREA                  01580000
         BZ    ERR_PROJ           PROJECT NOT ACTIVE                    01590000
         USING IPROJ,R7           LIFE OF FUNCTION                      01600000
                                                                        01610000
         EJECT ,                                                        01620000
***************************************************************         01630000
*                                                                       01640000
*   GENERAL INITIALIZATION AND REQUEST VALIDATION                       01650000
*                                                                       01660000
***************************************************************         01670000
                                                                        01680000
         LH    R0,TIUPDCNT        NUMBER OF ROWS PROVIDED               01690000
         LTR   R0,R0              VALIDATE ARGUMENT                     01700000
         BNP   EINVREQ            INVALID REQUEST                       01710000
                                                                        01720000
         LA    R6,TIUPDORG        ADDR OF TABLE REQUEST ENTRY           01730000
         USING TIUPREQ,R6         ESTABLISH ADDRESSABILITY              01740000
                                                                        01750000
         EJECT ,                                                        01760000
***************************************************************         01770000
*                                                                       01780000
*   PROCESS TABLE UPDATE REQUEST                                        01790000
*                                                                       01800000
***************************************************************         01810000
TREQUEST DS    0H                                                       01820000
         LH    R1,CURRTBL         GET COUNT OF TABLE REQ PROCESSED      01830000
         LA    R1,1(,R1)          INCREMENT COUNT                       01840000
         CH    R1,TIUPDCNT        ALL TABLE REQ PROCESSED?              01850000
         BH    TREQDONE           YES, PROCESSING COMPLETE              01860000
         STH   R1,CURRTBL         SAVE COUNT OF TABLES PROCESSED        01870000
                                                                        01880000
         TM    CNTLFLGS,CNTL$VRF  VERIFICATION PASS?                    01890000
         BZ    TREQPROC           NO, CONTINUE                          01900000
         CLI   TIUPRREQ,TIUP$MOD  MODIFY ROW REQUEST?                   01910000
         BE    TREQPROC           YES, CONTINUE                         01920000
         CLI   TIUPRREQ,TIUP$DEL  DELETE ROW REQUEST?                   01930000
         BE    TREQNEXT           YES, SKIP VERIFICATION ON DELETE      01940000
         B     EINVREQ            ELSE, INVALID REQUEST                 01950000
                                                                        01960000
TREQPROC DS    0H                                                       01970000
         LH    R0,TIUPRCNT        COUNT OF COLUMNS IN REQUEST           01980000
         LTR   R0,R0              VALIDATE ARGUMENT                     01990000
         BNP   EINVREQ            INVALID REQUEST                       02000000
                                                                        02010000
***************************************************************         02020000
*                                                                       02030000
*  OPEN TABLE AND RETRIEVE TABLE FORMAT TO BE PROCESSED                 02040000
*                                                                       02050000
***************************************************************         02060000
                                                                        02070000
         MVC   TBRTYP,=CL8'TBOPEN'                                      02080000
         TBOPEN TIUPRNAM,         OPEN REQUESTED TABLE                 +02090000
               STOKEN=PRJTOKEN,                                        +02100000
               TTOKEN=TBLTOKN,                                         +02110000
               MF=(E,MFE_LIST)                                          02120000
                                                                        02130000
         LTR   R15,R15            TABLE OPEN?                           02140000
         BNZ   ETBSRV             NO, RETURN ERROR                      02150000
                                                                        02160000
         MVC   TBRTYP,=CL8'TBDESC'                                      02170000
         TBDESC TTOKEN=TBLTOKN,   OBTAIN TABLE FORMAT                  +02180000
               LINK=ACON,                                              +02190000
               MF=(E,MFE_LIST)                                          02200000
                                                                        02210000
         LTR   R15,R15            TABLE DESCRIBE OK?                    02220000
         BNZ   ETBSRV             NO, RETURN ERROR                      02230000
         ST    R1,TFORMAT         ADDRESS OF TBL FORMAT                 02240000
         ST    R0,TFORMATL        LENGTH  OF TBL FORMAT                 02250000
                                                                        02260000
         EJECT ,                                                        02270000
***************************************************************         02280000
*                                                                       02290000
*  PREPARE FOR COLUMNS TO BE PROCESSED.                                 02300000
*                                                                       02310000
***************************************************************         02320000
         LA    R5,TIUPRORG        ORIGIN OF COLUMN ENTRIES              02330000
         USING TIUPCOL,R5         ESTABLISH ADDRESSABILITY              02340000
                                                                        02350000
         TM    TIUPRARG,TIUP$POS  ROW POSITION SPECIFIED                02360000
         BO    GETRPOS            YES, RETRIEVE TABLE ROW BY POS        02370000
                                                                        02380000
***************************************************************         02390000
*                                                                       02400000
*  BUILD SARG ENTRY FOR EACH COLUMN WITH OLD VALUE SPECIFIED            02410000
*                                                                       02420000
***************************************************************         02430000
         LA    R1,TIUPRARG        ADDRESS OF SARG FLAGS                 02440000
         BAS   R14,SARGINIT       INIT SEARCH ARG CONST AREA            02450000
         BNZ   ERRENV             ENVIRONMENT ERROR                     02460000
         LH    R3,TIUPRCNT        GET COUNT OF COLUMNS                  02470000
                                                                        02480000
SARGPROC DS    0H                                                       02490000
         LA    R2,TIUPCOL         ADDR   OF COLUMN ENTRY                02500000
         LH    R0,TIUPCLEN        LENGTH OF COLUMN VALUE                02510000
         ICM   R1,15,TIUPCOLD     OFFSET TO ORIGINAL VALUE              02520000
         BZ    SARGNEXT           NONE, ADDRESS OF NEXT COLENT          02530000
         AR    R1,R8              ADD REQUEST BLOCK ORIGIN              02540000
         BAS   R14,SARGADD        ADD COLUMN TO SARG LIST               02550000
         BNZ   EINVREQ            INVALID REQUEST ERROR                 02560000
                                                                        02570000
SARGNEXT DS    0H                                                       02580000
         LA    R5,TIUPCLN(,R5)    ADDR OF NEXT COLUMN ENTRY             02590000
         BCT   R3,SARGPROC        PROCESS NEXT SARG COLUMN              02600000
                                                                        02610000
         L     R4,TBLSARG         ADDR OF TABLE SARG                    02620000
         USING TBSARGS,R4         ESTABLISH ADDRESSABILITY              02630000
         LH    R0,TBSAENTS        NUMBER OF TERMS                       02640000
         LTR   R0,R0              INVALID REQUEST IS ZERO               02650000
         BZ    EINVREQ                                                  02660000
                                                                        02670000
         EJECT ,                                                        02680000
***************************************************************         02690000
*                                                                       02700000
*  SET CURRENT POSITION TO TOP OF TABLE                                 02710000
*                                                                       02720000
***************************************************************         02730000
                                                                        02740000
         MVC   TBRTYP,=CL8'TBSET'                                       02750000
         TBSET TTOKEN=TBLTOKN,    SET TABLE POSITION TO TOP            +02760000
               POS=TOP,                                                +02770000
               MF=(E,MFE_LIST)                                          02780000
                                                                        02790000
         LTR   R15,R15            SET SUCCESSFUL?                       02800000
         BNZ   ETBSRV             NO, RETURN ERROR                      02810000
                                                                        02820000
         EJECT ,                                                        02830000
***************************************************************         02840000
*                                                                       02850000
*  SCAN TABLE FOR ROWS MATCHING SEARCH ARGUMENT                         02860000
*                                                                       02870000
***************************************************************         02880000
                                                                        02890000
         LA    R0,1024            DEFAULT BUFFER LENGTH                 02900000
         BAS   R14,GETBUFR        OBTAIN ROW BUFFER                     02910000
         BNZ   ERRENV             ENVIRONMENT ERROR                     02920000
         LA    R1,GETNEXT         ADDR OF GET ROUTINE                   02930000
         ST    R1,GETRTN@         SAVE ADDRESS OF GET ROUTINE           02940000
                                                                        02950000
GETNEXT  DS    0H                                                       02960000
         MVC   TBRTYP,=CL8'TBGET'                                       02970000
         TBGET *ROWBUFR,          RETRIVE SELECTED TABLE ROW           +02980000
               LENGTH=*ROWBUFRL,                                       +02990000
               TTOKEN=TBLTOKN,                                         +03000000
               POS=NEXT,                                               +03010000
               SARGS=(R4),                                             +03020000
               MF=(E,MFE_LIST)                                         +03030000
                                                                        03040000
         B     *+4(R15)           BRANCH ON RETURN CODE                 03050000
         B     UPDTROW            OK, GO UPDATE TABLE ROW               03060000
         B     TBLBFSZ            WARN, EOF OR SHORT BUFFER             03070000
         B     ETBSRV             TABLE SERVICE ERROR                   03080000
         B     ETBSRV             TABLE SERVICE ERROR                   03090000
         B     ETBSRV             TABLE SERVICE ERROR                   03100000
         B     ETBSRV             TABLE SERVICE ERROR                   03110000
                                                                        03120000
         EJECT ,                                                        03130000
***************************************************************         03140000
*                                                                       03150000
*  OBTAIN TABLE ROW BY ROWID, LOCATE 'ROWID' IN COL ENTRIES             03160000
*                                                                       03170000
***************************************************************         03180000
                                                                        03190000
GETRPOS  DS    0H                                                       03200000
         LH    R3,TIUPRCNT        GET COUNT OF COLUMNS                  03210000
                                                                        03220000
RIDNEXT  DS    0H                                                       03230000
         CLC   TIUPCNAM,$ROWID    ROWID COLUMN                          03240000
         BE    GETROWID           YES, RETIEVE ROWID                    03250000
         LA    R5,TIUPCLN(,R5)    ADDR OF NEXT COL ENT                  03260000
         BCT   R3,RIDNEXT         CHECK NEXT COLUMN                     03270000
         B     EINVREQ            NO MATCH...INVALID REQUEST            03280000
                                                                        03290000
GETROWID DS    0H                                                       03300000
         CLC   TIUPCLEN,=H'4'     ROWID MUST BE 4 BYTES                 03310000
         BNE   EINVREQ            REQUEST ERROR                         03320000
         ICM   R3,15,TIUPCOLD     ADDR OF ROWID KEY                     03330000
         BZ    EINVREQ            REQUEST ERROR IF NOT SPECIFIED        03340000
         AR    R3,R8              ADDR OF ROW                           03350000
         ICM   R3,15,0(R3)        GET ROW ID                            03360000
         DROP  R5                 TIUPCOL                               03370000
                                                                        03380000
***************************************************************         03390000
*                                                                       03400000
*  GET TABLE ROW                                                        03410000
*                                                                       03420000
***************************************************************         03430000
                                                                        03440000
         LA    R0,1024            DEFAULT BUFFER LENGTH                 03450000
         BAS   R14,GETBUFR        OBTAIN ROW BUFFER                     03460000
         BNZ   ERRENV             ENVIRONMENT ERROR                     03470000
         LA    R1,GETROW          ADDR OF GET ROUTINE                   03480000
         ST    R1,GETRTN@         SAVE ADDRESS OF GET ROUTINE           03490000
                                                                        03500000
GETROW   DS    0H                                                       03510000
         MVC   TBRTYP,=CL8'TBGET'                                       03520000
         TBGET *ROWBUFR,          RETRIVE SELECTED TABLE ROW           +03530000
               LENGTH=*ROWBUFRL,                                       +03540000
               TTOKEN=TBLTOKN,                                         +03550000
               POS=(R3),                                               +03560000
               SARGS=(R4),                                             +03570000
               MF=(E,MFE_LIST)                                         +03580000
                                                                        03590000
         B     *+4(R15)           BRANCH ON RETURN CODE                 03600000
         B     UPDTROW            OK, GO UPDATE TABLE ROW               03610000
         B     TBLBFSZ            WARN, EOF OR SHORT BUFFER             03620000
         B     ETBSRV             TABLE SERVICE ERROR                   03630000
         B     ETBSRV             TABLE SERVICE ERROR                   03640000
         B     ETBSRV             TABLE SERVICE ERROR                   03650000
         B     ETBSRV             TABLE SERVICE ERROR                   03660000
                                                                        03670000
         EJECT ,                                                        03680000
**************************************************************          03690000
*                                                                       03700000
*   DETERMINE IF BUFFER FAILED DUE TO BUFFER SIZE.  IF SO,              03710000
*   ALLOCATE LARGER BUFFER AND RETRY GET REQUEST.                       03720000
*                                                                       03730000
**************************************************************          03740000
                                                                        03750000
TBLBFSZ  DS    0H                                                       03760000
         LTR   R0,R0              TABLE EOF?                            03770000
         BZ    TBLEOF             YES, PROCESS NEXT TABLE REQ           03780000
         BAS   R14,GETBUFR        GET LARGER BUFFER                     03790000
         BNZ   ERRENV             ENVIRONMENT ERROR                     03800000
         L     R15,GETRTN@        ADDR OF GET ROUTINE                   03810000
         BR    R15                GOTO APPROPRIATE TBGET                03820000
                                                                        03830000
         EJECT ,                                                        03840000
**************************************************************          03850000
*                                                                       03860000
*   REPLACE COLUMNS IN TABLE ROW WITH NEW COLUMN VALUES                 03870000
*                                                                       03880000
**************************************************************          03890000
                                                                        03900000
UPDTROW  DS    0H                                                       03910000
         LA    R5,TIUPRORG        ADDRESS OF 1ST COLUMN ENTRY           03920000
         USING TIUPCOL,R5         ESTABLISH ADDRESSABILITY              03930000
         LH    R3,TIUPRCNT        COUNT OF COLUMN ENTRIES               03940000
                                                                        03950000
UPDTPROC DS    0H                                                       03960000
         LA    R2,TIUPCNAM        ADDRESS OF COLUMN NAME                03970000
         ICM   R1,15,TIUPCNEW     OFFSET TO NEW VALUE                   03980000
         BZ    UPDTNEXT           NONE,  CHECK NEXT COLUMN              03990000
         AR    R1,R8              ADDRESS OF NEW VALUE                  04000000
         LH    R0,TIUPCLEN        LENGTH OF COLUMN VALUE                04010000
         BAS   R14,COLREPL        REPLACE COLUMN VALUE IN ROW           04020000
         BNZ   EINVREQ            INVALID REQUEST ERROR                 04030000
                                                                        04040000
UPDTNEXT DS    0H                                                       04050000
         LA    R5,TIUPCLN(,R5)    ADDRESS OF NEXT COLUMN                04060000
         BCT   R3,UPDTPROC        PROCESS NEXT COLUMN VALUE             04070000
         DROP  R5                 TIUPCOL                               04080000
                                                                        04090000
         EJECT ,                                                        04100000
**************************************************************          04110000
*                                                                       04120000
*  DETERMINE PROCESS REQUEST TYPE                                       04130000
*                                                                       04140000
**************************************************************          04150000
                                                                        04160000
         TM    CNTLFLGS,CNTL$VRF  VERIFICATION PASS?                    04170000
         BO    VRFROW             YES, VERIFY ROW                       04180000
         CLI   TIUPRREQ,TIUP$MOD  MODIFY ROW REQUEST?                   04190000
         BE    MODROW             YES, MODIFY TABLE ROW                 04200000
         CLI   TIUPRREQ,TIUP$DEL  DELETE ROW REQUEST?                   04210000
         BE    DELROW             YES, DELETE TABLE ROW                 04220000
                                                                        04230000
**************************************************************          04240000
*                                                                       04250000
*  VERIFICATION PASS,  CHECK FOR DUPLICATE KEYS                         04260000
*                                                                       04270000
**************************************************************          04280000
VRFROW   DS    0H                                                       04290000
         LA    R0,WRK256          WORKAREA ADDRESS                      04300000
         @CALL ITIUPVRF,(*ROWBUFR,(R6),*TFORMAT,TBLTOKN,MSGWORK),      +04310000
               MF=(E,MFE_LIST)                                          04320000
         B     RC_TEST            TEST COMPLETION STATUS                04330000
                                                                        04340000
**************************************************************          04350000
*                                                                       04360000
*  MODIFY SELECTED TABLE ROW                                            04370000
*                                                                       04380000
**************************************************************          04390000
MODROW   DS    0H                                                       04400000
         LA    R0,WRK256          WORKAREA ADDRESS                      04410000
         @CALL ITIUPMOD,(*ROWBUFR,(R6),*TFORMAT,TBLTOKN,MSGWORK),      +04420000
               MF=(E,MFE_LIST)                                          04430000
         B     RC_TEST            TEST COMPLETION STATUS                04440000
                                                                        04450000
**************************************************************          04460000
*                                                                       04470000
*  DELETE SELECTED TABLE ROW                                            04480000
*                                                                       04490000
**************************************************************          04500000
DELROW   DS    0H                                                       04510000
         LA    R0,WRK256          WORKAREA ADDRESS                      04520000
         @CALL ITIUPDEL,(*ROWBUFR,(R6),*TFORMAT,TBLTOKN,MSGWORK),      +04530000
               MF=(E,MFE_LIST)                                          04540000
         B     RC_TEST            TEST COMPLETION STATUS                04550000
                                                                        04560000
**************************************************************          04570000
*                                                                       04580000
*  DETERMINE REQUEST SERVICE COMPLETION STATUS                          04590000
*                                                                       04600000
**************************************************************          04610000
                                                                        04620000
RC_TEST  DS    0H                                                       04630000
         LTR   R15,R15            SUCCESSFUL COMPLETION?                04640000
         BNZ   EREQSRV            NO, REQUEST SERVICE FAILED            04650000
                                                                        04660000
         EJECT ,                                                        04670000
**************************************************************          04680000
*                                                                       04690000
*  DETERMINE IF MULTIROW SARG REQUEST AND PROCESS NEXT ROW              04700000
*                                                                       04710000
**************************************************************          04720000
                                                                        04730000
NEXTROW  DS    0H                                                       04740000
         TM    TIUPRARG,TIUP$POS  EXPLICIT ROWID REQUESTED?             04750000
         BZ    GETNEXT            NO,  RETRIEVE NEXT TABLE ROW          04760000
                                                                        04770000
**************************************************************          04780000
*                                                                       04790000
*  EOF ON TABLE, CLOSE CURRENT TABLE AND GET ADDR OF NEXT REQ           04800000
*                                                                       04810000
**************************************************************          04820000
                                                                        04830000
TBLEOF   DS    0H                                                       04840000
         MVC   TBRTYP,=CL8'TBCLOSE'                                     04850000
         TBCLOSE TTOKEN=TBLTOKN,  CLOSE TABLE                          +04860000
               MF=(E,MFE_LIST)                                          04870000
                                                                        04880000
         LTR   R15,R15            CLOSE SUCESSFUL?                      04890000
         BNZ   ETBSRV             NO, RETURN ERROR                      04900000
                                                                        04910000
         $RETSTOR *TFORMAT,OWNER=ITASK                                  04920000
                                                                        04930000
         XC    TFORMAT,TFORMAT    CLEAR TBDESC FMT ADDR                 04940000
         XC    TFORMATL,TFORMATL  CLEAR TBDESC FMT LEN                  04950000
                                                                        04960000
TREQNEXT DS    0H                                                       04970000
         LH    R1,TIUPRCNT        GET COUNT OF COLUMNS                  04980000
         MH    R1,=AL2(TIUPCLN)   LENGTH OF COL ENTRIES                 04990000
         LA    R6,TIUPRLN(R1,R6)  ADDR OF NEXT TABLE REQ ENTRY          05000000
         B     TREQUEST           PROCESS NEXT TABLE REQUEST            05010000
                                                                        05020000
**************************************************************          05030000
*                                                                       05040000
*  ALL TABLES REQUEST PROCESSED FOR CURRENT PASS THROUGH                05050000
*  REQUEST,  IF VERIFICATION THEN RESET FOR UPDATE PROCESSING.          05060000
*                                                                       05070000
**************************************************************          05080000
                                                                        05090000
TREQDONE DS    0H                                                       05100000
         TM    CNTLFLGS,CNTL$VRF  VERIFICATION PASS?                    05110000
         BZ    REQ_CPT            NO,  REQUEST COMPLETE                 05120000
         NI    CNTLFLGS,FF-CNTL$VRF  RESET VERIFICATION FLAG            05130000
         XC    CURRTBL,CURRTBL    RESET PROCESSED TABLE COUNT           05140000
         LA    R6,TIUPDORG        ADDR OF FIRST REQUEST                 05150000
         B     TREQUEST           PROCESS UPDATE PASS                   05160000
         DROP  R6                 TIUPREQ                               05170000
                                                                        05180000
         EJECT ,                                                        05190000
***************************************************************         05200000
*                                                                       05210000
*   POST COMPLETION CODES                                               05220000
*                                                                       05230000
***************************************************************         05240000
REQ_CPT  DS    0H                                                       05250000
         LA    R15,RC00           REQUEST COMPLETE                      05260000
         SR    R0,R0                                                    05270000
         SR    R1,R1                                                    05280000
         SR    R2,R2              NO MSG RETURNED                       05290000
         SR    R3,R3              NO MSG RETURNED                       05300000
         B     RESPOND                                                  05310000
                                                                        05320000
ERR_PROJ DS    0H                 PROJECT NOT OPEN                      05330000
         LA    R15,RC08           FAIL THE REQUEST                      05340000
         LA    R0,RSN12                                                 05350000
         SR    R1,R1                                                    05360000
         LA    R2,MSGERPRJ                                              05370000
         LA    R3,L'MSGERPRJ                                            05380000
         B     RESPOND                                                  05390000
                                                                        05400000
EINVREQ  DS    0H                 INVALID REQUEST FORMAT                05410000
         LA    R15,RC12           FAIL THE REQUEST                      05420000
         LA    R0,RSN08                                                 05430000
         SR    R1,R1                                                    05440000
         LA    R2,MSGERREQ                                              05450000
         LA    R3,L'MSGERREQ                                            05460000
         B     RESPOND                                                  05470000
                                                                        05480000
ERRENV   DS    0H                 ENVIRONMENTAL ERROR                   05490000
         LA    R15,RC12           FAIL THE REQUEST                      05500000
         LA    R0,RSN12                                                 05510000
         SR    R1,R1                                                    05520000
         LA    R2,MSGERENV                                              05530000
         LA    R3,L'MSGERENV                                            05540000
         B     RESPOND                                                  05550000
                                                                        05560000
EREQSRV  DS    0H                                                       05570000
         STM   R14,R1,ERRINFO     SAVE TBSERV ERROR INFO                05580000
         LA    R15,RC08           ERROR FROM REQ SERVICE                05590000
         LA    R0,RSN04           FAILED IN SERVICE                     05600000
         L     R1,ERR_R1          DIAGNOSTICS FROM SERV RTN             05610000
         LH    R3,MSGWORK         GET LENGTH OF MESSAGE                 05620000
         LA    R2,MSGWORK+2       ADDR OF MESSAGE RETURNED              05630000
         B     ESUPER             SET SUPER RC                          05640000
                                                                        05650000
ETBSRV   DS    0H                 TABLE SERVICES ERROR                  05660000
         STM   R14,R1,ERRINFO     SAVE TBSERV ERROR INFO                05670000
         LA    R15,RC08           ALL ROWS NOT PROCESSED                05680000
         LA    R0,RSN08           NO REASON CODES DEFINED               05690000
         L     R1,ERR_R1          DIAGNOSTICS FROM SERV RTN             05700000
         MVC   MSGWORK(L'MSGTBSRV),MSGTBSRV                             05710000
         MVC   MSGWORK+L'MSGTBSRV(L'TBRTYP),TBRTYP                      05720000
         LA    R2,MSGWORK                                               05730000
         LA    R3,L'MSGTBSRV+L'TBRTYP                                   05740000
         B     ESUPER                                                   05750000
                                                                        05760000
ESUPER   DS    0H                 SET SUPER RETURN CODE                 05770000
         L     R14,ERR_R0         TABLE SERVICE REASON CODE             05780000
         SLL   R14,16             SHIFT TO UPPER HALFWORD               05790000
         O     R14,ERR_R15        INSERT RETURN CODE                    05800000
         ST    R14,SUPER          SAVE AS SUPER CODE                    05810000
         B     RESPOND                                                  05820000
                                                                        05830000
         EJECT ,                                                        05840000
***************************************************************         05850000
*                                                                       05860000
*   RETURN COMPLETION STATUS TO COOPERATIVE PROCESS                     05870000
*                                                                       05880000
***************************************************************         05890000
RESPOND  DS    0H                                                       05900000
         L     R6,@TMRESP         LOCATE RESPONSE HEADER                05910000
         USING TMRESP,R6          RESIDES IN RESPONSE BUFFER            05920000
         MVC   TMRSUPRC,SUPER     SUPER CODE, IF APPLICABLE             05930000
         ST    R15,TMRSRC         R15 - R1                              05940000
         ST    R0,TMRSRSN                                               05950000
         ST    R1,TMRSINFO                                              05960000
                                                                        05970000
         LTR   R3,R3              MESSAGE PROVIDED FOR RETURN?          05980000
         BZ    EXIT               DONE IF NOT                           05990000
                                                                        06000000
         $XPBUFR ISRT,            ADD MESSAGE TO BUFFER                +06010000
               DATA=(R2),                                              +06020000
               DATALEN=(R3),                                           +06030000
               MF=(E,MFE_LIST)                                          06040000
                                                                        06050000
         LTR   R15,R15                                                  06060000
         BNZ   ERR_ITXP                                                 06070000
         STH   R3,TMRSDATL        POST MSG LENGTH IN RESPONSE HDR       06080000
         B     EXIT               DONE                                  06090000
                                                                        06100000
         EJECT ,                                                        06110000
***************************************************************         06120000
*                                                                       06130000
*   ERRORS USUALLY PRECLUDING RESPONSE TO COOPERATIVE PROCESS           06140000
*                                                                       06150000
***************************************************************         06160000
ERR_ITXP DS    0H                                                       06170000
         LR    R1,R15             TXP SERVICE RETURN CODE               06180000
         LA    R15,RC04           ASSUME OUT-OF-SPACE                   06190000
         CR    R1,R15             CORRECT?                              06200000
         BE    *+8                TERMINATE WITH WARNING                06210000
         LA    R15,RC20           ELSE MORE SERIOUS PROBLEM             06220000
                                                                        06230000
         L     R6,@TMRESP         LOCATE RESPONSE HEADER                06240000
         USING TMRESP,R6          RESIDES IN RESPONSE BUFFER            06250000
         ST    R15,TMRSUPRC       LOCAL RETCODE                         06260000
         ST    R0,TMRSRSN         TXP REASON                            06270000
         ST    R1,TMRSINFO        TXP RETCODE                           06280000
         B     EXIT                                                     06290000
                                                                        06300000
         EJECT ,                                                        06310000
***************************************************************         06320000
*                                                                       06330000
*   RETURN TO CALLER                                                    06340000
*                                                                       06350000
***************************************************************         06360000
EXIT     DS    0H                                                       06370000
         BAS   R14,CLEANUP        RETURN ALLOCATE STG                   06380000
         L     R15,TMRSRC         RETURN CODE                           06390000
         L     R0,TMRSRSN         REASON CODE                           06400000
         L     R1,TMRSINFO        INFO / DIAGNOSTIC CODE                06410000
                                                                        06420000
         #EXIT ,                  RETURN                                06430000
         DROP  R8                 TIUPDT                                06440000
                                                                        06450000
         EJECT ,                                                        06460000
***************************************************************         06470000
*                                                                       06480000
*  ROUTINE: GETBUFR - ALLOC TABLE ROW BUFFER                            06490000
*                                                                       06500000
*  ENTRY:  R0 - DESIRED LENGTH OF BUFFER                                06510000
*                                                                       06520000
*  EXIT:   R15 = 0 - ROW BUFFER ALLOCATION SUCCESSFUL                   06530000
*               >0 - ROW BUFFER ALLOCATION FAILED                       06540000
*                                                                       06550000
***************************************************************         06560000
                                                                        06570000
GETBUFR  DS    0H                                                       06580000
         STM   R0,R15,REGSAVE     SAVE CALLERS REGISTERS                06590000
         LR    R7,R0              SAVE REQUIRED BUFFER LENGTH           06600000
                                                                        06610000
         LA    R15,RC00           ASSUME SUCCESS                        06620000
         C     R7,ROWBUFRL        CURRENT BUFFER SUFFICIENT?            06630000
         BNH   GETBEXIT           YES, RETURN                           06640000
                                                                        06650000
         ICM   R2,15,ROWBUFR      ADDR OF CURRENT BUFFER                06660000
         BZ    GETBFIT            NONE, GET NEW BUFFER                  06670000
         XC    ROWBUFR,ROWBUFR    CLEAR EXISTING ROW BUFFER             06680000
         L     R3,ROWBUFRL        LENGTH OF ROW BUFFER                  06690000
                                                                        06700000
         STGRETN ADDR=(R2),LEN=(R3),QH=TSKSTG                           06710000
                                                                        06720000
GETBFIT  DS    0H                                                       06730000
         STGGET  (R7),QH=TSKSTG   ALLOC ROW BUFFER                      06740000
         BNZ   GETBEXIT           RETURN                                06750000
         ST    R1,ROWBUFR         SAVE ROW BUFFER ADDRESS               06760000
         ST    R7,ROWBUFRL        SAVE ROW BUFFER LENGTH                06770000
                                                                        06780000
GETBEXIT DS    0H                                                       06790000
         LM    R0,R14,REGSAVE     RESTORE CALLER'S REGISTERS            06800000
         LTR   R15,R15            SET CONDITION CODE                    06810000
         BR    R14                RETURN                                06820000
                                                                        06830000
         EJECT ,                                                        06840000
***************************************************************         06850000
*                                                                       06860000
*  ROUTINE: SARGINIT - INITIALIZE SEARCH ARGUMENT BUFFER                06870000
*                                                                       06880000
*  ENTRY:  R1 - ADDR OF SARG FLAGS (TIUPRARG)                           06890000
*                                                                       06900000
*  EXIT:   R15 = 0 - SARG INITIALIZATION SUCCESSFUL                     06910000
*               >0 - SARG INITIALIZATION FAILED                         06920000
*                                                                       06930000
***************************************************************         06940000
                                                                        06950000
SARGINIT DS    0H                                                       06960000
         STM   R0,R15,REGSAVE     SAVE CALLER'S REGISTERS               06970000
         LR    R7,R1              ADDR OF SARG FLAGS                    06980000
                                                                        06990000
         ICM   R0,15,TBLSARG      ADDR OF SARG BUFFER                   07000000
         BNZ   SINICLR            CLEAR SARG BUFFER                     07010000
         LA    R2,#DFSARGL        USE DEFAULT SARG LENGTH               07020000
         ST    R2,TBLSARGL        SAVE SARG LENGTH                      07030000
                                                                        07040000
         STGGET (R2),QH=TSKSTG    ALLOCATE BUFFER                       07050000
         ST    R1,TBLSARG         SAVE ADDRESS OF SARG                  07060000
         LR    R0,R1              ADDRESS OF SARG AREA                  07070000
                                                                        07080000
SINICLR  DS    0H                                                       07090000
         L     R1,TBLSARGL        LEN  OF SARG                          07100000
         SR    R15,R15            PREPARE FOR CLEAR                     07110000
         MVCL  R0,R14             CLEAR SARG                            07120000
                                                                        07130000
         L     R4,TBLSARG         ADDR OF SARG                          07140000
         USING TBSARGS,R4         ESTABLISH ADDRESSABILITY              07150000
                                                                        07160000
         MVI   TBSAVER,TBSAV0     SARG VERSION ID                       07170000
                                                                        07180000
         MVI   TBSABOOL,TBSABAND  ASSUME BOOL 'AND' CONNECTOR           07190000
         TM    0(R7),TIUP$OR      BOOL OR CONNECTOR?                    07200000
         BZ    *+8                                                      07210000
         MVI   TBSABOOL,TBSABOR   SET BOOL 'OR' CONNECTOR               07220000
                                                                        07230000
         MVC   TBSALEN,=AL2(TBSAFIXL) SET SARG LENGTH                   07240000
         LA    R15,RC00           SET RETURN CODE                       07250000
                                                                        07260000
SINIEXIT DS    0H                                                       07270000
         LM    R0,R14,REGSAVE     RESTORE CALLER'S REGISTERS            07280000
         LTR   R15,R15            SET CONDITION CODE                    07290000
         BR    R14                AND RETURN                            07300000
         DROP  R4                 TBSARGS                               07310000
                                                                        07320000
         EJECT ,                                                        07330000
***************************************************************         07340000
*                                                                       07350000
*  ROUTINE: SARGADD  - ADD COLUMN TO SEARCH ARG                         07360000
*                                                                       07370000
*  ENTRY:  R0 - LENGTH  OF SARG VALUE                                   07380000
*          R1 - ADDRESS OF SARG VALUE                                   07390000
*          R2 - ADDRESS OF COLUMN NAME                                  07400000
*                                                                       07410000
*  EXIT:   R15 = 0 - SARG COLUMN ADD SUCCESSFUL                         07420000
*                4 - SARG BUFFER OVERFLOW                               07430000
*                8 - INVALID COLUMN NAME                                07440000
*               12 - INVALID COLUMN LENGTH                              07450000
*                                                                       07460000
***************************************************************         07470000
                                                                        07480000
SARGADD  DS    0H                                                       07490000
         STM   R0,R15,REGSAVE     SAVE CALLER'S REGISTERS               07500000
         LR    R7,R0              SAVE VALUE LEN                        07510000
         LR    R6,R1              SAVE VALUE ADDR                       07520000
         LR    R5,R2              ADDR OF COLUMN ENTRY                  07530000
         USING TIUPCOL,R5         ESTABLISH ADDRESSABILITY              07540000
                                                                        07550000
         LA    R1,TIUPCNAM        ADDR OF COLUMN NAME                   07560000
         BAS   R14,LOCTBCOL       LOCATE TBCOLDEF                       07570000
         BNZ   SADDEXIT           RETURN ERROR                          07580000
                                                                        07590000
         LR    R8,R1              ADDR OF TBCOLDEF                      07600000
         USING TBCOLDEF,R8        ESTABLISH ADDRESSABILITY              07610000
         L     R4,TBLSARG         ADDR OF SARG BUFFER                   07620000
         USING TBSARGS,R4         ESTABLISH ADDRESSABILITY              07630000
                                                                        07640000
         LA    R15,RC12           ASSUME COLUMN LENGTH ERROR            07650000
         C     R7,TBCLENG         LENGTH VALID                          07660000
         BNE   SADDEXIT           RETURN ERROR                          07670000
                                                                        07680000
         LA    R15,RC04           ASSUME BUFFER OVERFLOW                07690000
         LA    R0,TBSANFXL(,R7)   GET ENTRY LENGTH                      07700000
         AH    R0,TBSALEN         ADD CURRENT LENGTH                    07710000
         C     R0,TBLSARGL        BUFFER OVERFLOW?                      07720000
         BH    SADDEXIT           RETURN ERROR                          07730000
                                                                        07740000
         LR    R2,R4              ADDR OF SARG ORIGIN                   07750000
         AH    R2,TBSALEN         ADDR OF NEXT COL SLOT                 07760000
         USING TBSANTRY,R2        TEMP ADDRESSABILITY                   07770000
         STH   R0,TBSALEN         UPDATE SARG LENGTH                    07780000
                                                                        07790000
         TM    TIUPCARG,TIUP$EQ   COMPARE EQ                            07800000
         BNO   *+8                                                      07810000
         OI    TBSAOPR,TBSAO$EQ   SET EQ COMPARATOR                     07820000
         TM    TIUPCARG,TIUP$GT   COMPARE GT                            07830000
         BNO   *+8                                                      07840000
         OI    TBSAOPR,TBSAO$GT   SET GT COMPARATOR                     07850000
         TM    TIUPCARG,TIUP$LT   COMPARE LT                            07860000
         BNO   *+8                                                      07870000
         OI    TBSAOPR,TBSAO$LT   SET LT COMPARATOR                     07880000
         TM    TIUPCARG,TIUP$LT+TIUP$GT COMPARE NE                      07890000
         BNO   *+8                                                      07900000
         OI    TBSAOPR,TBSAO$NE   SET NE COMPARATOR                     07910000
                                                                        07920000
         MVC   TBSAACOL,TBCNAME   COLUMN NAME                           07930000
         LA    R2,TBSAAVAL        ADDR OF COLUMN VALUE                  07940000
         DROP  R2                 TBSANTRY                              07950000
         LR    R3,R7              LENGTH OF VALUE                       07960000
         MVCL  R2,R6              COPY VALUE TO SARG                    07970000
                                                                        07980000
         LH    R1,TBSAENTS        GET ENTRY COUNT                       07990000
         LA    R1,1(,R1)          INCREMENT ENTRY COUNT                 08000000
         STH   R1,TBSAENTS        SAVE ENTRY COUNT                      08010000
         LA    R15,RC00           SET RETURN CODE                       08020000
                                                                        08030000
SADDEXIT DS    0H                                                       08040000
         LM    R0,R14,REGSAVE     RESTORE CALLER'S REGISTERS            08050000
         LTR   R15,R15            SET CONDITION CODE                    08060000
         BR    R14                AND RETURN                            08070000
         DROP  R4,R5,R8           TBSARGS, TIUPCOL, TBCOLDEF            08080000
                                                                        08090000
         EJECT ,                                                        08100000
***************************************************************         08110000
*                                                                       08120000
*  ROUTINE: COLREPL - REPLACE COLUMN VALUE                              08130000
*                                                                       08140000
*  ENTRY:  R0 - LENGTH  OF COLUMN VALUE                                 08150000
*          R1 - ADDRESS OF COLUMN VALUE                                 08160000
*          R2 - ADDRESS OF COLUMN NAME                                  08170000
*                                                                       08180000
*  EXIT:   R15 = 0 - COLUMN REPLACE SUCCESSFUL                          08190000
*                8 - INVALID COLUMN NAME                                08200000
*               12 - INVALID COLUMN LENGTH                              08210000
*                                                                       08220000
***************************************************************         08230000
                                                                        08240000
COLREPL  DS    0H                                                       08250000
         STM   R0,R15,REGSAVE     SAVE CALLER'S REGISTERS               08260000
         LR    R4,R1              SAVE COLUMN VALUE ADDRESS             08270000
         LR    R5,R0              SAVE COLUMN VALUE LENGTH              08280000
                                                                        08290000
         LR    R1,R2              ADDR OF COLUMN NAME                   08300000
         BAS   R14,LOCTBCOL       LOCATE TBCOLDEF                       08310000
         BNZ   CREPEXIT           NF, RETURN ERROR                      08320000
                                                                        08330000
         LR    R8,R1              ADDR OF TBCOLDEF                      08340000
         USING TBCOLDEF,R8        ESTABLISH ADDRESSABILITY              08350000
                                                                        08360000
         LA    R15,RC12           ASSUME COLUMN LENGTH ERROR            08370000
         C     R5,TBCLENG         LENGTH VALID                          08380000
         BNE   CREPEXIT           RETURN ERROR                          08390000
                                                                        08400000
         L     R2,ROWBUFR         ADDR OF ROW ORIGIN                    08410000
         A     R2,TBCDISPL        ADD COLUMN DISPLACEMENT               08420000
         LR    R3,R5              LENGTH OF COLUMN                      08430000
         MVCL  R2,R4              COPY DATA TO ROW BUFFER               08440000
         LA    R15,RC00           SET RETURN CODE                       08450000
                                                                        08460000
CREPEXIT DS    0H                                                       08470000
         LM    R0,R14,REGSAVE     RESTORE CALLER'S REGISTERS            08480000
         LTR   R15,R15            SET CONDITION CODE                    08490000
         BR    R14                AND RETURN                            08500000
         DROP  R8                 TBCOLDEF                              08510000
                                                                        08520000
         EJECT ,                                                        08530000
***************************************************************         08540000
*                                                                       08550000
*  ROUTINE: LOCTBCOL - LOCATE TBCOLDEF                                  08560000
*                                                                       08570000
*  ENTRY:  R1 - ADDRESS OF COLUMN NAME                                  08580000
*                                                                       08590000
*  EXIT:   R15 = 0 - TBCOLDEF RETURNED (R1 = ADDR OF TBCOLDEF)          08600000
*                8 - COLUMN NOT FOUND                                   08610000
*                                                                       08620000
***************************************************************         08630000
                                                                        08640000
LOCTBCOL DS    0H                                                       08650000
         LR    R2,R1              SAVE ADDR OF COLNAME                  08660000
         L     R15,TFORMAT        ADDR OF TABLE FORMAT                  08670000
         USING TBFMT,R15          TEMP ADDRESSABILITY                   08680000
         L     R1,TBFCOFF         ADDR OF TBCOLDEF ORIGIN               08690000
         USING TBCOLDEF,R1        ESTABLISH ADDRESSABILITY              08700000
         LH    R15,TBF#COLS       COUNT OF COLUMNS                      08710000
         DROP  R15                TBFMT                                 08720000
                                                                        08730000
LTBCNEXT DS    0H                                                       08740000
         CLC   TBCNAME,0(R2)      TBCOLDEF MATCH?                       08750000
         BE    LTBC_FND           YES, RETURN                           08760000
         CLC   TBCSNAME,0(R2)     TBCOLDEF MATCH?                       08770000
         BE    LTBC_FND           YES, RETURN                           08780000
         LA    R1,TBCOLDFL(,R1)   ADDR OF NEXT TBCOLDEF                 08790000
         BCT   R15,LTBCNEXT       PROCESS NEXT TBC                      08800000
         LA    R15,RC08           TBC NOT FOUND                         08810000
         B     LTBCEXIT           AND RETURN                            08820000
                                                                        08830000
LTBC_FND DS    0H                                                       08840000
         LA    R15,RC00           TBCOLDEF LOCATED                      08850000
                                                                        08860000
LTBCEXIT DS    0H                                                       08870000
         LTR   R15,R15            SET CONDITION CODE                    08880000
         BR    R14                AND RETURN                            08890000
         DROP  R1                 TBCOLDEF                              08900000
                                                                        08910000
         EJECT ,                                                        08920000
***************************************************************         08930000
*                                                                       08940000
*  ROUTINE: CLEANUP - FREE STORAGE ASSOCIATED WITH REQUEST              08950000
*                                                                       08960000
*  ENTRY:  N/A                                                          08970000
*                                                                       08980000
*  EXIT:   N/A                                                          08990000
*                                                                       09000000
***************************************************************         09010000
                                                                        09020000
CLEANUP  DS    0H                                                       09030000
         STM   R0,R15,REGSAVE     SAVE CALLER'S REGISTERS               09040000
                                                                        09050000
         ICM   R1,15,TBLTOKN      TABLE OPEN?                           09060000
         BZ    CLNTBFMT           NO, FREE TBL FORMAT                   09070000
                                                                        09080000
         TBCLOSE TTOKEN=TBLTOKN,  CLOSE TABLE                          +09090000
               MF=(E,MFE_LIST)                                          09100000
                                                                        09110000
CLNTBFMT DS    0H                                                       09120000
         ICM   R2,15,TFORMAT      TBFMT AVAILABLE                       09130000
         BZ    CLNSARG            NO, FREE SARG BUFFER                  09140000
                                                                        09150000
         $RETSTOR (R2),OWNER=ITASK                                      09160000
                                                                        09170000
CLNSARG  DS    0H                                                       09180000
         ICM   R2,15,TBLSARG      ADDR OF SARG BUFFER                   09190000
         BZ    CLNBUFR            NONE, FREE ROW BUFFER                 09200000
         L     R3,TBLSARGL        LENGTH OF SARG BUFFER                 09210000
                                                                        09220000
         STGRETN ADDR=(R2),LEN=(R3),QH=TSKSTG                           09230000
                                                                        09240000
CLNBUFR  DS    0H                                                       09250000
         ICM   R2,15,ROWBUFR      ADDR OF ROW  BUFFER                   09260000
         BZ    CLNEXIT            NONE, EXIT                            09270000
         L     R3,ROWBUFRL        LENGTH OF ROW BUFFER                  09280000
                                                                        09290000
         STGRETN ADDR=(R2),LEN=(R3),QH=TSKSTG                           09300000
                                                                        09310000
CLNEXIT  DS    0H                                                       09320000
         LM    R0,R15,REGSAVE     RESTORE CALLER'S REGISTERS            09330000
         BR    R14                AND RETURN                            09340000
                                                                        09350000
         EJECT ,                                                        09360000
***************************************************************         09370000
*                                                                       09380000
*   LOCAL READ ONLY STORAGE                                             09390000
*                                                                       09400000
***************************************************************         09410000
$ROWID   DC    CL16'ROWID'        CONSTANT FOR ROW POS                  09420000
                                                                        09430000
MSGTBSRV DC    C'TABLE SERVICES REQUEST DID NOT COMPLETE: '             09440000
MSGERREQ DC    C'INVALID REQUEST BLOCK RECEIVED'                        09450000
MSGERENV DC    C'ENVIRONMENTAL ERROR PROCESSING REQUEST'                09460000
MSGERPRJ DC    C'PROJECT NOT AVAILABLE'                                 09470000
                                                                        09480000
         LTORG ,                                                        09490000
                                                                        09500000
         PRINT NOGEN                                                    09510000
         ICVT  ,                                                        09520000
         ITASK ,                                                        09530000
         IPCB  ,                                                        09540000
         IUSER ,                                                        09550000
         IPROJ ,                                                        09560000
         PRINT GEN                                                      09570000
                                                                        09580000
         END   ,                                                        09590000

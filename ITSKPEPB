ITSKPEPB TITLE '- NOTIFY TASKMGR OF EPB PROCESSOR'                      00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE: ITSKPEPB - Notify TASKMGR of EPB processor                   00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine will update an XEPB with the ITASK/IPCB Address       00080000
*    respinsible for posting an EPB.  This allows task and process      00090000
*    recovery to post the PCB complete should a failure occur           00100000
*    prior to the responible failed/term workunit posting the EPB.      00110000
*                                                                       00120000
* ON ENTRY:                                                             00130000
*                                                                       00140000
*    R1 Contains the address of the parameter list mapped by            00150000
*    the TASKPL dsect generated by $TASK DSECT=YES.                     00160000
*                                                                       00170000
* ON EXIT:                                                              00180000
*                                                                       00190000
*    Upon completion of this routine R15 will contain one               00200000
*    of the following return codes:                                     00210000
*                                                                       00220000
*      RC00 - XEPB successfully updated                                 00230000
*                                                                       00240000
*      RC04 - warning                                                   00250000
*             R0 = RSN04 - EPB must be an XEPB                          00260000
*                                                                       00270000
*      RC20 - Request Error                                             00280000
*             R0 = RSN04 - EPB required for request                     00290000
*                                                                       00300000
* MODE:                                                                 00310000
*                                                                       00320000
*    TASK                                                               00330000
*    APF/NON-APF                                                        00340000
*    SUP/PROB                                                           00350000
*    AMODE 31, RMODE ANY                                                00360000
*                                                                       00370000
**<DOC-OFF>*****************************************************        00380000
                                                                        00390000
         EJECT ,                                                        00400000
****************************************************************        00410000
*                                                                       00420000
* MAINTENANCE:                                                          00430000
*                                                                       00440000
*   09/13/93 Ron Colmone                                                00450000
*            Initial Version                                            00460000
*                                                                       00470000
*   09/15/95 Ron Colmone          Par# 215477                           00480000
*            Added support to XEPB from processing ITASK                00490000
*                                                                       00500000
****************************************************************        00510000
                                                                        00520000
         EJECT ,                                                        00530000
         $TASK DSECT=YES          TASKMGR PLIST                         00540000
                                                                        00550000
         EJECT ,                                                        00560000
         @EPB  TYPE=DSECT         EVENT PROCESS BLOCK                   00570000
                                                                        00580000
         EJECT ,                                                        00590000
         XEPB  ,                  EXTENDED EPB                          00600000
                                                                        00610000
         EJECT ,                                                        00620000
         ABCODES  ,               ABEND CODES                    215477 00630000
                                                                        00640000
         EJECT ,                                                        00650000
         EQUS  ,                  GENERAL EQUATES                       00660000
                                                                        00670000
         EJECT ,                                                        00680000
         #WORK LENGTH=512         READ/WRITE WORKAREA                   00690000
REGSAVE  DS    16F                REGISTER SAVE AREA             215477 00700000
FLAGS    DS    X                  FLAGS                          215477 00710000
$LOCKED  EQU   X'80'                DISP LOCK ACQUIRED           215477 00720000
         #ENDWORK                 END OF WORKAREA                       00730000
                                                                        00740000
         EJECT ,                                                        00750000
ITSKPEPB #ENTER BASE=R12,         ENTRY LINKAGE                        +00760000
               PREG=R8,                                                +00770000
               WAPASS=YES                                               00780000
                                                                        00790000
         USING TASKPL,R8          ESTABLISH ADDRESSABILITY              00800000
                                                                        00810000
         EJECT ,                                                        00820000
****************************************************************        00830000
*                                                                       00840000
*  UPDATE XEPB WITH PROCESSING TASK AND PCB ADDRESS                     00850000
*                                                                       00860000
****************************************************************        00870000
         ICM   R5,15,TPLTASK      TASK SPECIFIED?                       00880000
         BZ    *+6                YES, CONTINUE                         00890000
         LR    R10,R5             USE CURRENT TASK                      00900000
         USING ITASK,R10          ESTAB ADDR TO ITASK                   00910000
                                                                        00920000
         ICM   R9,15,TPLPCB       PROCESS SPECIFIED                     00930000
         BNZ   *+8                YES, CONTINUE                         00940000
         L     R9,TSKPCBC         RETRIEVE CURRENT PCB                  00950000
         USING IPCB,R9            PCB ADDRESSABILITY                    00960000
                                                                        00970000
         ICM   R6,15,TPLEPB       OBTAIN EPB TOKEN/ADDRESS              00980000
         BZ    ERR_EPB            ERROR, EPB REQUIRED                   00990000
         N     R6,=F'-2'          CONVERT TOKEN TO ADDRESS              01000000
         USING EPB,R6             EPB  ADDRESSABILITY                   01010000
X        USING XEPB,R6            XEPB ADDRESSABILITY                   01020000
                                                                        01030000
         TM    EPBFLGS,EPB$XND    IS EPB AN XEPB?                       01040000
         BZ    WRN_XEPB           NO, WARNING                           01050000
                                                                        01060000
*---------------------------------------------------------------        01070000
*  If processor ITASK is already assigned it must be the same           01080000
*  ITASK as specified on this update request. If so, continue           01090000
*  with XEPB update.                                                    01100000
*---------------------------------------------------------------        01110000
         ICM   R0,15,X.XEPBPTSK   PROCESSOR TASK ASSIGNED?       215477 01120000
         BZ    PEPB_TSK           NO, CHECK IF SAME AS REQUESTOR 215477 01130000
         CR    R10,R0             SAME AS PREVIOUSLY ASSIGNED?   215477 01140000
         BE    PEPB_UPD           YES, CONTINUE WITH UPDATE      215477 01150000
         B     ABN_PTSK           ERROR, ALT PROCESS SPECIFIED   215477 01160000
                                                                        01170000
*---------------------------------------------------------------        01180000
*  If process ITASK is not already assigned, add XEPB to ITASK          01190000
*  XEPB processor queue, unless same as requestor.                      01200000
*---------------------------------------------------------------        01210000
PEPB_TSK DS    0H                                                215477 01220000
         C     R10,X.XEPBRTSK     SAME AS REQUESTORS ITASK       215477 01230000
         BE    PEPB_UPD           YES, CONTINUE WITH UPDATE      215477 01240000
                                                                        01250000
         BAS   R14,GETLOCK        ACQUIRE DISP LOCK              215477 01260000
         BNZ   ABN_LOCK           ERROR, LOCK FAILURE            215477 01270000
                                                                        01280000
         L     R1,TSKXEPQP+4      END OF PROCESSOR XEPB QUEUE    215477 01290000
L        USING XEPB,R1            ADDRESSABILITY TO XEPB END     215477 01300000
         ST    R1,X.XEPBPPRV      PREVIOUS TO LAST ENTRY         215477 01310000
         ST    R6,L.XEPBPNXT      ADD TO END OF LIST             215477 01320000
         ST    R6,TSKXEPQP+4      UPDATE NEW END OF CHAIN        215477 01330000
         DROP  L                  XEPB                           215477 01340000
                                                                        01350000
         BAS   R14,RELLOCK        RELEASE DISP LOCK              215477 01360000
                                                                        01370000
*---------------------------------------------------------------        01380000
*  Update the XEPB with the processor PCB and ITASK                     01390000
*---------------------------------------------------------------        01400000
PEPB_UPD DS    0H                                                215477 01410000
         ST    R10,X.XEPBPTSK     SAVE PROCESSING TASK ADDRESS          01420000
         ST    R9,X.XEPBPPCB      SAVE PROCESSING PCB  ADDRESS          01430000
                                                                        01440000
         L     R1,PCBXUSEC        OBTAIN CURRENT XEPB USE COUNT         01450000
         LA    R0,1(,R1)          INCREMENT COUNT                       01460000
         CS    R1,R0,PCBXUSEC     UPDATE XEPB USE COUNT                 01470000
         BNE   *-8                RETRY                                 01480000
                                                                        01490000
         LA    R15,RC00           NORMAL COMPLETION                     01500000
         B     RETURN             RETURN                                01510000
                                                                        01520000
         EJECT ,                                                        01530000
****************************************************************        01540000
*                                                                       01550000
*  ERROR RETURN                                                         01560000
*                                                                       01570000
****************************************************************        01580000
                                                                        01590000
WRN_XEPB DS    0H                                                       01600000
         LA    R0,RSN04           XEPB REQUIRED FOR PCSEPB REQUEST      01610000
         LA    R15,RC04           WARNING                               01620000
         B     RETURN             RETURN                                01630000
                                                                        01640000
ERR_EPB  DS    0H                                                       01650000
         LA    R0,RSN04           EPB REQUIRED FOR EVENT                01660000
         LA    R15,RC20           REQUEST ERROR                         01670000
         B     RETURN             RETURN                                01680000
                                                                        01690000
RETURN   DS    0H                                                       01700000
         #EXIT ,                  RETURN                                01710000
                                                                        01720000
         EJECT ,                                                        01730000
****************************************************************        01740000
*                                                                       01750000
*  Catastrophic Errors                                                  01760000
*                                                                       01770000
****************************************************************        01780000
                                                                        01790000
ABN_LOCK DS    0H                                                215477 01800000
         $ABEND ABE_DISPLOCK,TITLE='UNABLE TO ACQUIRE DISP LOCK' 215477 01810000
                                                                        01820000
ABN_PTSK DS    0H                                                215477 01830000
         $ABEND ABE_XEPB,TITLE='INVALID XEPB PROCESSOR REASSIGNMENT'    01840000
                                                                        01850000
         EJECT ,                                                        01860000
****************************************************************        01870000
*                                                                       01880000
*  Routine: GETLOCK - Acquire DISP lock                                 01890000
*                                                                       01900000
****************************************************************        01910000
GETLOCK  DS    0H                                                215477 01920000
         STM   R0,R15,REGSAVE     SAVE CALLERS REGISTERS         215477 01930000
                                                                        01940000
         $SER  OBTAIN,DISP        REQUEST SERIALIZATION          215477 01950000
         B     *+4(R15)           BRANCH ON LOCK RETURN CODE     215477 01960000
         B     GETL_OBT           0 - LOCK OBTAINED              215477 01970000
         B     GETL_HAV           4 - LOCK ALREADY OWNED         215477 01980000
         B     GETL_ERR           8 - UNABLE TO ACQUIRE LOCK     215477 01990000
                                                                        02000000
GETL_OBT DS    0H                                                215477 02010000
         OI    FLAGS,$LOCKED      LOCK OBTAINED                  215477 02020000
                                                                        02030000
GETL_HAV DS    0H                                                215477 02040000
         LA    R15,RC00           NORMAL COMPLETION              215477 02050000
         B     GETL_RET           RETURN                         215477 02060000
                                                                        02070000
GETL_ERR DS    0H                                                215477 02080000
         LA    R15,RC08           UNABLE TO ACQUIRE LOCK         215477 02090000
                                                                        02100000
GETL_RET DS    0H                                                215477 02110000
         LM    R0,R14,REGSAVE     RESTORE CALLERS REGISTERS      215477 02120000
         LTR   R15,R15            SET CONDITION CODE             215477 02130000
         BR    R14                RETURN                         215477 02140000
                                                                        02150000
         EJECT ,                                                        02160000
****************************************************************        02170000
*                                                                       02180000
*  Routine: RELLOCK - Release DISP lock                                 02190000
*                                                                       02200000
****************************************************************        02210000
RELLOCK  DS    0H                                                215477 02220000
         STM   R0,R15,REGSAVE     SAVE CALLERS REGISTERS         215477 02230000
                                                                        02240000
         TM    FLAGS,$LOCKED      SERIALIZATION ACQUIRED?        215477 02250000
         BZ    RELL_RET           NO, RETURN                     215477 02260000
         $SER  RELEASE,DISP       RELEASE SERIALIZATION          215477 02270000
                                                                        02280000
RELL_RET DS    0H                                                215477 02290000
         LM    R0,R15,REGSAVE     RESTORE CALLERS REGISTERS      215477 02300000
         BR    R14                RETURN                         215477 02310000
                                                                        02320000
         EJECT ,                                                        02330000
****************************************************************        02340000
*                                                                       02350000
*  CONSTANTS AND LITERALS                                               02360000
*                                                                       02370000
****************************************************************        02380000
                                                                        02390000
         LTORG ,                                                        02400000
                                                                        02410000
         PRINT NOGEN                                                    02420000
         ICVT  ,                                                        02430000
         ITASK ,                                                        02440000
         IPCB  ,                                                        02450000
         PRINT GEN                                                      02460000
                                                                        02470000
         END   ,                                                        02480000

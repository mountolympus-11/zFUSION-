IRECIMGO TITLE '- SYSIMAGE OUTBOUND ENCODE'                             00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: IRECIMGO - SYSIMAGE outbound encode                          00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine creates a row / record in SYSIMAGE format             00080000
*    from a presentation space and its associated dimensions.           00090000
*    The image is squished into a buffer of size equal to that          00100000
*    of the source presentation space.  If the squish is not            00110000
*    successful, i.e. no space is saved, the original buffer is         00120000
*    stored as is.                                                      00130000
*                                                                       00140000
*    The caller may specify that the SYSIMAGE row produced is           00150000
*    to contain a lead-in area of an arbitrary number of bytes.         00160000
*    The length is rounded to a multiple of eigth bytes to              00170000
*    preserve SYSIMAGE member alignments.                               00180000
*                                                                       00190000
*    The caller is responsible for the $GETSTOR buffer returned         00200000
*    by this routine.  Standard $GETSTOR recovery mechanisms            00210000
*    apply.                                                             00220000
*                                                                       00230000
*                                                                       00240000
* ON ENTRY:                                                             00250000
*                                                                       00260000
*    R1  contains the address of a parameter list described             00270000
*        by the IMGOPARM mapping expanded below                         00280000
*                                                                       00290000
*                                                                       00300000
* ON EXIT:                                                              00310000
*                                                                       00320000
*    R1  contains the address of a $GETSTOR buffer containing           00330000
*        the lead-in area followed immediately by the SYSIMAGE          00340000
*        ready row                                                      00350000
*                                                                       00360000
*    R0  contains the address of the SYSIMAGE row origin within         00370000
*        the buffer area given in R1                                    00380000
*                                                                       00390000
**<DOC-OFF>****************************************************         00400000
                                                                        00410000
         EJECT                                                          00420000
***************************************************************         00430000
*                                                                       00440000
* MAINTENANCE:                                                          00450000
*                                                                       00460000
*    12/26/95 R. Turgeon                                                00470000
*             Update SQUISH() parameter list                            00480000
*                                                                       00490000
***************************************************************         00500000
                                                                        00510000
         EJECT                                                          00520000
                                                                        00530000
         #WORK ,                                                        00540000
                                                                        00550000
LEADIN   DS    F                  USER LEADIN SIZE ROUNDED TO DWORD     00560000
SIZE     DS    F                  SIZE OF IMAGE (ROWS * COLS)           00570000
                                                                        00580000
         #ENDWORK ,                                                     00590000
                                                                        00600000
         EJECT                                                          00610000
***************************************************************         00620000
*                                                                       00630000
*   Parameter list                                                      00640000
*                                                                       00650000
***************************************************************         00660000
IMGOPARM DSECT                                                          00670000
IMGOROWS DS    F                  PRESENTATION SPACE ROW COUNT          00680000
IMGOCOLS DS    F                  PRESENTATION SPACE COL COUNT          00690000
IMGOCSRP DS    F                  ZERO-RELATIVE CURSOR POSITION         00700000
IMGOIMAG DS    A                  ADDR OF IMAGE RECTANGLE ORIGIN        00710000
IMGOUSER DS    F                  # LEADIN BYTE TO PRECEED SYSIMAGE ROW 00720000
IMGOPLN  EQU   *-IMGOPARM         LENGTH OF PARAMETER LIST              00730000
                                                                        00740000
         EJECT                                                          00750000
         ICATALOG IMAGE           SYSIMAGE ROW FORMAT                   00760000
                                                                        00770000
         EJECT                                                          00780000
         EQUS  ,                                                        00790000
                                                                        00800000
         EJECT                                                          00810000
IRECIMGO #ENTER PREG=R8                                                 00820000
                                                                        00830000
         USING ITASK,R10          STDENV                                00840000
         USING IMGOPARM,R8        LIFE OF FUNCTION                      00850000
                                                                        00860000
         EJECT                                                          00870000
***************************************************************         00880000
*                                                                       00890000
*   Compute image size and acquire a buffer large enough for            00900000
*   the SYSIMAGE row plus the lead-in area specified                    00910000
*                                                                       00920000
***************************************************************         00930000
                                                                        00940000
         L     R2,IMGOUSER        SPECIFIED LENGTH OF LEADING AREA      00950000
         LA    R2,7(,R2)          ROUND TO DWORD MULTIPLE               00960000
         SRL   R2,3                                                     00970000
         SLL   R2,3                                                     00980000
         ST    R2,LEADIN                                                00990000
                                                                        01000000
         L     R5,IMGOROWS        NUMBER OF ROWS                        01010000
         M     R4,IMGOCOLS        TIMES NUMBER OF COLUMNS               01020000
         ST    R5,SIZE            GIVES TOTAL SIZE OF IMAGE             01030000
                                                                        01040000
         LR    R3,R5              IMAGE SIZE                            01050000
         LA    R3,SIMGLN(,R3)     PLUS SYSIMAGE FIXED PORTION           01060000
         A     R3,LEADIN          PLUS SIZE OF LEADIN AREA              01070000
                                                                        01080000
         $GETSTOR (R3)            ACQUIRE SUITABLE BUFFER               01090000
                                                                        01100000
*--------------------------------------------------------------         01110000
*   Format SYSIMAGE row from source parms                               01120000
*--------------------------------------------------------------         01130000
                                                                        01140000
         LR    R7,R1              BUFFER                                01150000
         LR    R6,R7              BYPASS LEADIN                         01160000
         A     R6,LEADIN                                                01170000
         USING SYSIMAGE,R6        CAST THE REMAINDER ACCORDINGLY        01180000
         MVC   SIMGROWS,IMGOROWS  ROW COUNT                             01190000
         MVC   SIMGCOLS,IMGOCOLS  COL COUNT                             01200000
         MVC   SIMGCSRP,IMGOCSRP  CURSOR POSITION                       01210000
                                                                        01220000
         LA    R4,SYSIMAGE+SIMGLN PRESENTATION SPACE INSERTION AREA     01230000
         ST    R4,SIMGBUFR+4      VARX FORMAT                           01240000
                                                                        01250000
*--------------------------------------------------------------         01260000
*   Attempt image squish                                                01270000
*--------------------------------------------------------------         01280000
                                                                        01290000
         L     R2,IMGOIMAG        SOURCE IMAGE                          01300000
         L     R3,SIZE            IMAGE SIZE                            01310000
                                                                        01320000
         $CLINK FUNC=SQUISH,      COMPRESSER                           X01330000
               (CHAR*,(R2)),(REGISTER_SHORT,(R3)),                     X01340000
               (CHAR*,(R4)),(REGISTER_SHORT,(R3)),                     X01350000
               (CHAR,ICTZERO)                                           01360000
                                                                        01370000
         LTR   R15,R15            TEST COMPLETION STATUS                01380000
         BM    CPYIMAGE           SQUISH NOT AFFECTIVE                  01390000
         ST    R15,SIMGBUFR+0     ELSE POST VARX IMAGE LENGTH           01400000
         MVI   SIMGSQSH,TRUE      IMAGE CARRIED IN SQUISHED FORMAT      01410000
         B     FIN                DONE                                  01420000
                                                                        01430000
*--------------------------------------------------------------         01440000
*   Revert to source image copy if the squish is not affective          01450000
*--------------------------------------------------------------         01460000
                                                                        01470000
CPYIMAGE DS    0H                                                       01480000
         L     R2,IMGOIMAG        SOURCE IMAGE                          01490000
         L     R3,SIZE            IMAGE SIZE                            01500000
         LA    R0,SYSIMAGE+SIMGLN TARGET AREA WITHIN SYSIMAGE           01510000
         LR    R1,R3              IMAGE SIZE UNMODIFIED                 01520000
         ST    R1,SIMGBUFR+0      CAPTURE VARX LENGTH                   01530000
         MVCL  R0,R2              INSERT THE IMAGE                      01540000
                                                                        01550000
*--------------------------------------------------------------         01560000
*   Return SYSIMAGE to caller                                           01570000
*--------------------------------------------------------------         01580000
                                                                        01590000
FIN      DS    0H                                                       01600000
         LR    R1,R7              BUFFER ORIGIN                         01610000
         LA    R0,SYSIMAGE        SYSIMAGE ORIGIN                       01620000
         SR    R15,R15            RETURN CODE NOT DEFINED               01630000
                                                                        01640000
         #EXIT ,                                                        01650000
                                                                        01660000
         EJECT                                                          01670000
***************************************************************         01680000
*                                                                       01690000
*   Local read-only data areas                                          01700000
*                                                                       01710000
***************************************************************         01720000
                                                                        01730000
         LTORG ,                                                        01740000
                                                                        01750000
         EJECT                                                          01760000
         PRINT NOGEN                                                    01770000
         ICVT  ,                                                        01780000
         ITASK ,                                                        01790000
         END   ,                                                        01800000

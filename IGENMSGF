IGENMSGF TITLE '- FREE COLLECTOR MESSAGE QUEUE'                         00010000
***************************************************************         00020000
*                                                                       00030000
* MAPPING:  REQPARM - REQUEST PARAMETER LIST                            00040000
*                                                                       00050000
***************************************************************         00060000
REQPARM  DSECT                                                          00070000
REQPMSGB DS    A             RESERVED                                   00080000
*                                                                       00090000
REQPANCH DS    A             ADDR OF PTR USED TO ANCHOR THE COLLECTOR   00100000
*                            MESSAGE QUEUE.                             00110000
*                                                                       00120000
REQPSTGQ DS    A             ADDR OF AN INITIALIZED STGGET QHDR         00130000
*                                                                       00140000
REQPLN   EQU   *-REQPARM     LENGTH OF PLIST                            00150000
                                                                        00160000
         EJECT                                                          00170000
**<DOC-ON>*****************************************************         00180000
*                                                                       00190000
* ROUTINE: IGENMSGF - FREE COLLECTOR MESSAGE QUEUE                      00200000
*                                                                       00210000
* DESCRIPTION:                                                          00220000
*                                                                       00230000
*    THIS ROUTINE IS USED TO FREE A COLLECTOR MESSAGE QUEUE             00240000
*    CREATED BY ONE OR MORE $ENQMSG REQUESTS.  THE MESSAGE              00250000
*    QUEUE ANCHORED IN REQUESTOR STORAGE IS RUN AND EACH                00260000
*    MESSAGE ENTRY AS WELL AS THE MESSAGE QUEUE HDR IS RELEASED         00270000
*    (STGRETN).  UPON COMPLETION, THE ANCHOR WORD IS ZEROED.            00280000
*                                                                       00290000
*    THIS ROUTINE IMPLEMENTS THE $FREMSG SERVICE.                       00300000
*                                                                       00310000
*                                                                       00320000
* ON ENTRY:                                                             00330000
*                                                                       00340000
*    R1  CONTAINS THE ADDRESS OF A PARAMETER LIST CONSTRUCTED           00350000
*        AS DESCRIBED BY THE LOCAL REQPARM MAPPING                      00360000
*                                                                       00370000
* ON EXIT:                                                              00380000
*                                                                       00390000
*    R15 CONTAINS ZERO                                                  00400000
*                                                                       00410000
**<DOC-OFF>****************************************************         00420000
                                                                        00430000
         EJECT                                                          00440000
         #WORK ,                                                        00450000
         #ENDWORK ,                                                     00460000
                                                                        00470000
         EJECT                                                          00480000
         $MSGBUF ,                                                      00490000
                                                                        00500000
         EJECT                                                          00510000
         EQUS  ,                                                        00520000
                                                                        00530000
         EJECT                                                          00540000
IGENMSGF #ENTER PREG=R8                                                 00550000
                                                                        00560000
         USING ITASK,R10          STDENV                                00570000
         USING REQPARM,R8                                               00580000
                                                                        00590000
         EJECT                                                          00600000
***************************************************************         00610000
*                                                                       00620000
*   RELEASE ALL COLLECTOR MESSAGE QUEUE STORAGE                         00630000
*                                                                       00640000
***************************************************************         00650000
         USING $MSGBUF,R5         DECLARE INTENTIONS                    00660000
         L     R6,REQPANCH        FETCH ANCHOR PTR                      00670000
         ICM   R5,15,0(R6)        MESSAGE QUEUE HDR BUILT YET?          00680000
         BZ    NORMRET            DONE IF SO                            00690000
         SR    R0,R0              CLEAR THE ANCHOR                      00700000
         ST    R0,0(,R6)                                                00710000
                                                                        00720000
*--------------------------------------------------------------         00730000
*   RUN THE MESSAGE CHAIN FREEING EACH ENTRY                            00740000
*--------------------------------------------------------------         00750000
         ICM   R3,15,$MSGQF       LOCATE FIRST MESSAGE                  00760000
         BZ    RELHDR             NO MESSAGES PROVIDED                  00770000
         USING $MSBHDR,R3         DESCRIBE REQUESTORS AREA              00780000
         LR    R7,R3              PRIME THE RELEASE PUMP                00790000
                                                                        00800000
RELMSG   DS    0H                                                       00810000
         LTR   R3,R7              MESSAGES REMAIN?                      00820000
         BZ    RELHDR             DONE HERE IF NOT                      00830000
         L     R7,$MSBLINK        NEXT MESSAGE FOR NEXT PASS            00840000
                                                                        00850000
         LH    R6,$MSBLEN         LENGTH OF MESSAGE TEXT                00860000
         LA    R6,$MSBHDRL(,R6)   TOTAL LENGTH OF FORMATTED MSG         00870000
                                                                        00880000
         L     R2,REQPSTGQ        FETCH STGGET QU ADDR                  00890000
         STGRETN ADDR=(R3),LEN=(R6),QH=(R2)                             00900000
                                                                        00910000
         B     RELMSG             RELEASE ALL MESSAGES                  00920000
         DROP  R3                 $MSBHDR                               00930000
                                                                        00940000
*--------------------------------------------------------------         00950000
*   RELEASE THE MESSAGE QUEUE HEADER                                    00960000
*--------------------------------------------------------------         00970000
RELHDR   DS    0H                                                       00980000
         L     R2,REQPSTGQ        FETCH STGGET QU ADDR                  00990000
         STGRETN ADDR=$MSGBUF,LEN=$MSBPFXL,QH=(R2)                      01000000
         DROP  R5                 $MSGBUF                               01010000
                                                                        01020000
*--------------------------------------------------------------         01030000
*   RETURN COMPLETION STATUS TO CALLER                                  01040000
*--------------------------------------------------------------         01050000
NORMRET  DS    0H                                                       01060000
         LA    R15,RC00                                                 01070000
                                                                        01080000
RETURN   DS    0H                                                       01090000
         #EXIT ,                                                        01100000
                                                                        01110000
         EJECT                                                          01120000
***************************************************************         01130000
*                                                                       01140000
*   RETURN COMPLETION STATUS TO CALLER                                  01150000
*                                                                       01160000
***************************************************************         01170000
         LTORG ,                                                        01180000
                                                                        01190000
         PRINT NOGEN                                                    01200000
         ICVT ,                                                         01210000
         ITASK ,                                                        01220000
         END   ,                                                        01230000

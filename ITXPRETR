ITXPRETR TITLE '- REMOVE ENTRIES FROM TXP BUFFER'                       00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: ITXPISRT - REMOVE ENTRIES FROM TXP BUFFER                    00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THE RETRACT FUNCTION IS USED TO COUNTERMAND A SERIES OF            00080000
*    ONE OR MORE '$XPBUFR ISRT' REQUESTS.  IT ALLOWS THE CALLER         00090000
*    TO REMOVE USER DATA PREVIOUSLY INSERTED INTO THE TXP               00100000
*    BUFFER, USUALLY BECAUSE A SERIES OF RELATED INSERT                 00110000
*    OPERATIONS COULD NOT BE COMPLETED WITHOUT EXCEEDING                00120000
*    BUFFER CAPACITY OR SOME ERROR CONDITION, ETC.  NOTE THAT           00130000
*    THE FUNCTION ACCEPTS ONLY A DATA LENGTH SIGNIFYING THE             00140000
*    TRUNCATION OF THE SPECIFIED NUMBER OF BYTES.  IT IS NOT            00150000
*    POSSIBLE TO DELETE FROM ANYWHERE OTHER THAN THE END OF             00160000
*    THE BUFFER.                                                        00170000
*                                                                       00180000
*                                                                       00190000
* ON ENTRY:                                                             00200000
*                                                                       00210000
*    R1  CONTAINS THE ADDR OF A PARAMETER LIST CONSTRUCTED AS           00220000
*        FOLLOWS:                                                       00230000
*                                                                       00240000
*        +00 - USER DATA LENGTH TO BE TRUNCATED                         00250000
*                                                                       00260000
*                                                                       00270000
* ON EXIT:                                                              00280000
*                                                                       00290000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES.                    00300000
*    R0  MAY CONTAIN A REASON CODE.                                     00310000
*                                                                       00320000
*        RC00 - USER DATA SUCCESSFULLY REMOVED                          00330000
*                                                                       00340000
*        RC04 - THE USER DATA SIZE PROVIDED EXCEEDS THE TOTAL           00350000
*               STORED CONTENT OF THE TXP BUFFER.  THE REQUEST          00360000
*               IS IGNORED.                                             00370000
*                                                                       00380000
*        RC12 - TXP BUFFER NOT ALLOCATED                                00390000
*                                                                       00400000
**<DOC-OFF>****************************************************         00410000
                                                                        00420000
         EJECT                                                          00430000
         TXPHDR ,                 TXP BUFFER                            00440000
                                                                        00450000
         EJECT                                                          00460000
         REQHDR ,                 TRANSMISSION DESCRIPTOR               00470000
                                                                        00480000
         EJECT                                                          00490000
         EQUS  ,                                                        00500000
                                                                        00510000
         EJECT                                                          00520000
ITXPRETR #ENTER SAVE=NO,PREG=R8                                         00530000
                                                                        00540000
         USING ITASK,R10          STDENV                                00550000
         L     R9,TSKPCBC         PROCESS MODE                          00560000
         USING IPCB,R9                                                  00570000
                                                                        00580000
         EJECT                                                          00590000
*--------------------------------------------------------------         00600000
*   FETCH PASSED PARAMETERS - LOCATE TXP BUFFER                         00610000
*--------------------------------------------------------------         00620000
         ICM   R4,15,0(R8)        FETCH USER DATA LENGTH                00630000
         BZ    NORMRET            NO OPERATION                          00640000
         BM    ERR_LEN            LENGTH IS UNSIGNED                    00650000
                                                                        00660000
         USING TXPHDR,R8          TXP BUFFER PREFIX                     00670000
                                                                        00680000
         ICM   R8,15,PCBXPBUF     TXP BUFFER ANCHORED IN PCB            00690000
         BNZ   REMVTEST           LOCATED IN CURRENT PCB                00700000
         ICM   R9,15,PCBMPCB      ELSE EXAMINE PARENT PCB               00710000
         BZ    ERR_REQ            INVALID REQUEST IF NOT AVAILABLE      00720000
         ICM   R8,15,PCBXPBUF     TXP BUFFER ANCHOR IN PARENT PCB       00730000
         BZ    ERR_REQ            INVALID REQUEST                       00740000
                                                                        00750000
*--------------------------------------------------------------         00760000
*   DETERMINE IF BUFFER CONTAINS THE DATA LENGTH PROVIDED               00770000
*--------------------------------------------------------------         00780000
REMVTEST DS    0H                                                       00790000
         L     R5,TXPXPH          ORIGIN OF TRANSMISSION AREA           00800000
         USING REQHDR,R5          BIGINS WITH THE XPORT REQUEST HDR     00810000
         LA    R6,REQHDR+REQHDRLN LOCATION OF USER DATA SECTION         00820000
                                                                        00830000
         LH    R1,TXPSFLIM        FUNCTION ARRAY ENTRY COUNT            00840000
         MH    R1,=AL2(TSFHDRLN)  COMPUTE SIZE OF FUNCTION ARRAY        00850000
         AR    R6,R1              ORIGIN OF INITIAL BULK STORAGE EXTENT 00860000
                                                                        00870000
         LA    R0,0(R4,R6)        LOCATE BULK + USER DATA LENGTH        00880000
         C     R0,TXPAVAIL        VS. NEXT AVAILABLE FREE STORAGE AREA  00890000
         BH    ERR_LEN            ERROR, THAT MUCH ISNT ALLOCATED       00900000
                                                                        00910000
*--------------------------------------------------------------         00920000
*   RETRACT THE GIVEN USER DATA LENGTH FROM TXP AND REQHDR              00930000
*--------------------------------------------------------------         00940000
         LH    R1,REQHLEN         REMOVE RETRACTED AREA FROM USER AREA  00950000
         SR    R1,R4                                                    00960000
         STH   R1,REQHLEN                                               00970000
                                                                        00980000
         L     R1,TXPAVAIL        NEXT AVAIL USER DATA INSERT SLOT      00990000
         SR    R1,R4              RETRACT PRIOR INSERTS                 01000000
         ST    R1,TXPAVAIL        RESET AVAIL AREA PTR                  01010000
                                                                        01020000
         L     R1,TXPAVREM        SPACE REMAINING                       01030000
         AR    R1,R4              RETRACT PRIOR INSERTS                 01040000
         ST    R1,TXPAVREM        ACCOUNT FOR REMOVAL                   01050000
                                                                        01060000
*--------------------------------------------------------------         01070000
*   RETURN COMPLETION STATUS TO REQUESTOR                               01080000
*--------------------------------------------------------------         01090000
NORMRET  DS    0H                                                       01100000
         LA    R15,RC00           NORMAL COMPLETION                     01110000
         SR    R0,R0                                                    01120000
         B     EXIT                                                     01130000
                                                                        01140000
ERR_LEN  DS    0H                 LENGTH INVALID OR EXCEEDS CONTENT     01150000
         LA    R15,RC04                                                 01160000
         SR    R0,R0                                                    01170000
         B     EXIT                                                     01180000
                                                                        01190000
ERR_REQ  DS    0H                 TXP BUFFER NOT AVAILABLE              01200000
         LA    R15,RC12                                                 01210000
         SR    R0,R0                                                    01220000
                                                                        01230000
EXIT     DS    0H                                                       01240000
         #EXIT ,                                                        01250000
                                                                        01260000
         EJECT                                                          01270000
***************************************************************         01280000
*                                                                       01290000
*   LOCAL READ/ONLY STORAGE AREAS                                       01300000
*                                                                       01310000
***************************************************************         01320000
         LTORG ,                                                        01330000
                                                                        01340000
         PRINT NOGEN                                                    01350000
         ICVT  ,                                                        01360000
         ITASK ,                                                        01370000
         IPCB  ,                                                        01380000
         END   ,                                                        01390000

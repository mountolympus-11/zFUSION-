IGENMSGD TITLE '-  '                                                    00010000
***************************************************************         00020000
*                                                                       00030000
* MAPPING:  REQPARM - REQUEST PARAMETER LIST                            00040000
*                                                                       00050000
***************************************************************         00060000
REQPARM  DSECT                                                          00070000
REQPMSGL DS    A             ADDRESS OF MSG LINE ($MSBHDR FORMAT)       00080000
*                                                                       00090000
REQPANCH DS    A             ADDR OF PTR USED TO ANCHOR THE COLLECTOR   00100000
*                            MESSAGE QUEUE.                             00110000
*                                                                       00120000
REQPSTGQ DS    A             ADDR OF AN INITIALIZED STGGET QHDR         00130000
*                                                                       00140000
REQPLN   EQU   *-REQPARM     LENGTH OF PLIST                            00150000
                                                                        00160000
         EJECT                                                          00170000
**<DOC-ON>*****************************************************         00180000
*                                                                       00190000
* ROUTINE: IGENMSGD - RELEASE MSG FROM COLLECTOR MESSAGE QUEUE          00200000
*                                                                       00210000
* DESCRIPTION:                                                          00220000
*                                                                       00230000
*    THIS ROUTINE IS USED TO FREE A MESSAGE FROM THE MESSAGE            00240000
*    QUEUE.                                                             00250000
*                                                                       00260000
*    THIS ROUTINE IMPLEMENTS THE $DEQMSG SERVICE.                       00270000
*                                                                       00280000
* ON ENTRY:                                                             00290000
*                                                                       00300000
*    R1  CONTAINS THE ADDRESS OF A PARAMETER LIST CONSTRUCTED           00310000
*        AS DESCRIBED BY THE LOCAL REQPARM MAPPING.                     00320000
*                                                                       00330000
* ON EXIT:                                                              00340000
*                                                                       00350000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES:                    00360000
*                                                                       00370000
*        RC00 - REQUESTED MESSAGE DELETED                               00380000
*                                                                       00390000
*        RC04 - REQUESTED MESSAGE NOT FOUND                             00400000
*                                                                       00410000
**<DOC-OFF>****************************************************         00420000
                                                                        00430000
         EJECT                                                          00440000
         #WORK ,                                                        00450000
         #ENDWORK ,                                                     00460000
                                                                        00470000
         EJECT                                                          00480000
         $MSGBUF ,                                                      00490000
                                                                        00500000
         EJECT                                                          00510000
         EQUS  ,                                                        00520000
                                                                        00530000
         EJECT                                                          00540000
IGENMSGD #ENTER PREG=R8                                                 00550000
                                                                        00560000
         USING ITASK,R10          STDENV                                00570000
         USING REQPARM,R8         PLIST ADDRESSABILITY                  00580000
                                                                        00590000
         EJECT                                                          00600000
***************************************************************         00610000
*                                                                       00620000
*   RELEASE SELECTIVE MESSAGE FROM COLLECTOR MESSAGE QUEUE              00630000
*                                                                       00640000
***************************************************************         00650000
         USING $MSGBUF,R5         DECLARE INTENTIONS                    00660000
         L     R6,REQPANCH        FETCH ANCHOR PTR                      00670000
         ICM   R5,15,0(R6)        MESSAGE QUEUE HDR BUILT YET?          00680000
         BZ    NOTFND             MESSAGE NOT FOUND                     00690000
                                                                        00700000
*--------------------------------------------------------------         00710000
*   RUN THE MESSAGE CHAIN SCANNING FOR ENTRY TO RELEASE                 00720000
*--------------------------------------------------------------         00730000
         LA    R3,$MSGQF          LOCATE FIRST MESSAGE POINTER          00740000
         BZ    NOTFND             NO MESSAGES PROVIDED                  00750000
P        USING $MSBHDR,R3         DESCRIBE REQUESTORS AREA              00760000
Q        USING $MSBHDR,R4         DESCRIBE REQUESTORS AREA              00770000
                                                                        00780000
MSG_NEXT DS    0H                                                       00790000
         ICM   R4,15,P.$MSBLINK   ADDRESS OF NEXT MESSAGE               00800000
         BZ    NOTFND             ENTRY NOT FOUND                       00810000
         C     R4,REQPMSGL        REQUESTED MESSAGE LINE?               00820000
         BE    MSG_RLSE           YES, RELEASE MESSAGE                  00830000
         LR    R3,R4              ADDRESS OF NEXT MESSAGE               00840000
         B     MSG_NEXT           CHECK NEXT MESSAGE                    00850000
                                                                        00860000
*--------------------------------------------------------------         00870000
*   FREE STORAGE ASSOCIATED WITH MESSAGE                                00880000
*--------------------------------------------------------------         00890000
MSG_RLSE DS    0H                                                       00900000
         MVC   P.$MSBLINK,Q.$MSBLINK COPY MESSAGE BUFFER                00910000
         LH    R6,Q.$MSBLEN       LENGTH OF MESSAGE TEXT                00920000
         LA    R6,$MSBHDRL(,R6)   TOTAL LENGTH OF FORMATTED MSG         00930000
                                                                        00940000
         C     R4,$MSGQL          LAST MESSAGE BEEING FREED             00950000
         BNE   *+8                NO, CONTINUE                          00960000
         ST    R3,$MSGQL          SET PREVIOUS AS NEW LAST              00970000
                                                                        00980000
         LH    R1,$MSGCNT         RETRIEVE CURRENT MESSAGE COUNT        00990000
         BCTR  R1,0               DECREMENT MESSAGE COUNT               01000000
         STH   R1,$MSGCNT         SAVE UPDATED MESSAGE COUNT            01010000
                                                                        01020000
         L     R1,$MSBUSED        CURRENT SPACE USED                    01030000
         SR    R1,R6              DECREMENT BY MESSAGE LENGTH           01040000
         ST    R1,$MSBUSED        UPDATE SPACE USED                     01050000
                                                                        01060000
         L     R2,REQPSTGQ        FETCH STGGET QH ADDR                  01070000
         STGRETN ADDR=(R4),LEN=(R6),QH=(R2)                             01080000
                                                                        01090000
         B     RET_NORM           RETURN NORMAL                         01100000
                                                                        01110000
         DROP  P,Q,R5             $MSBHDR (P,Q), $MSGBUF                01120000
                                                                        01130000
*--------------------------------------------------------------         01140000
*   RETURN COMPLETION STATUS TO CALLER                                  01150000
*--------------------------------------------------------------         01160000
RET_NORM DS    0H                                                       01170000
         LA    R15,RC00           NORMAL COMPLETION                     01180000
         B     RETURN             RETURN                                01190000
                                                                        01200000
NOTFND   DS    0H                                                       01210000
         LA    R15,RC04           MSG NOT FOUND IN QUEUE                01220000
         B     RETURN             RETURN                                01230000
                                                                        01240000
RETURN   DS    0H                                                       01250000
         #EXIT ,                                                        01260000
                                                                        01270000
         EJECT                                                          01280000
***************************************************************         01290000
*                                                                       01300000
*   RETURN COMPLETION STATUS TO CALLER                                  01310000
*                                                                       01320000
***************************************************************         01330000
         LTORG ,                                                        01340000
                                                                        01350000
         PRINT NOGEN                                                    01360000
         ICVT ,                                                         01370000
         ITASK ,                                                        01380000
         END   ,                                                        01390000

IGENCSTG TITLE '- STGMGR GET/FREE FROM NONSTD ENVIRONS'                 00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE:  IGENCSTG - STGMGR GET/FREE FROM NONSTD ENVIRONS             00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THIS ROUTINE MAY BE USED TO ALLOW PROGRAMS RUNNING                 00080000
*    IN NONSTD ENVIRONMENTS TO ACQUIRE OR RELEASE STORAGE               00090000
*    VIA THE STGGET AND STGRETN FACILITIES.  THE LINKAGE                00100000
*    TO THIS ROUTINE IS PARTICULARLY INTENDED TO ACCOMODATE             00110000
*    AR MODE CALLERS.                                                   00120000
*                                                                       00130000
*                                                                       00140000
* NOTES:                                                                00150000
*                                                                       00160000
*    BAKR LINKAGE IS USED, NO SAVEAREA IS REQUIRED.                     00170000
*                                                                       00180000
*                                                                       00190000
* ON ENTRY:                                                             00200000
*                                                                       00210000
*    R1  CONTAINS THE ADDRESS OF A PARAMETER LIST CONSTRUCTED           00220000
*        AS FOLLOWS:                                                    00230000
*                                                                       00240000
*        +00 - LENGTH OF THE STORAGE BLOCK                              00250000
*                                                                       00260000
*        +04 - IF ZERO, THIS IS A REQUEST FOR NEW STORAGE.              00270000
*              OTHERWISE, IT IS THE ADDR OF A BLOCK OF STORAGE          00280000
*              TO BE RELEASED                                           00290000
*                                                                       00300000
*        +08 - ADDR OF THE STGMGR POOL ANCHOR (QH), THE                 00310000
*              IDENTITY OF WHICH NEED NOT BE KNOWN TO THE               00320000
*              CALLER                                                   00330000
*                                                                       00340000
*        +12 - ADDR OF A 128-BYTE WORKAREA                              00350000
*                                                                       00360000
*                                                                       00370000
* ON EXIT:                                                              00380000
*                                                                       00390000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES                     00400000
*                                                                       00410000
*        RC00 - SUCCESS, R1 CONTAINS BLOCK ADDR IF GET                  00420000
*        RC04 - STORAGE NOT AVAILABLE                                   00430000
*                                                                       00440000
**<DOC-OFF>****************************************************         00450000
                                                                        00460000
         EJECT                                                          00470000
         EQUS  ,                                                        00480000
                                                                        00490000
         EJECT                                                          00500000
IGENCSTG #ENTER SAVE=NO,LINKAGE=BAKR,PREG=(R8)                          00510000
                                                                        00520000
*--------------------------------------------------------------         00530000
*   RESTORE STDENV                                                      00540000
*--------------------------------------------------------------         00550000
         USING PSA,R0             PSA ADDRESSABILITY                    00560000
         SAC   0                  PRIMARY SPACE MODE, PER STDENV        00570000
                                                                        00580000
         @RESTENV ,               RESTORE STANDARD ENVIRONMENT          00590000
                                                                        00600000
         USING ICVT,R11                                                 00610000
                                                                        00620000
*--------------------------------------------------------------         00630000
*   FETCH PASSED PARAMETERS                                             00640000
*--------------------------------------------------------------         00650000
         LM    R4,R7,0(R8)        FETCH PASSED PARAMETERS               00660000
*                                 R4 <== BLOCK LENGTH                   00670000
*                                 R5 <== BLOCK ADDRESS OR ZERO          00680000
*                                 R6 <== STGMGR POOL ANCHOR ADDR        00690000
*                                 R7 <== WORKAREA                       00700000
*                                                                       00710000
         LR    R0,R7              CLEAR WORKAREA PROVIDED               00720000
         LA    R1,128             FBA                                   00730000
         SR    R15,R15                                                  00740000
         MVCL  R0,R14                                                   00750000
                                                                        00760000
         LR    R13,R7             ESTABLISH A SAVEAREA                  00770000
         MVC   4(4,R13),=C'F1SA'  BAKR CONVENTION                       00780000
                                                                        00790000
         LTR   R5,R5              DETERMINE IF BLOCK PROVIDED           00800000
         BNZ   RELEASE            RELEASE REQUEST IF SO, ELSE GET       00810000
                                                                        00820000
*--------------------------------------------------------------         00830000
*   ACQUIRE STORAGE, BLOCK ADDRESS RETURNED IN R1                       00840000
*--------------------------------------------------------------         00850000
         STGGET (R4),QH=(R6),MF=                                        00860000
                                                                        00870000
         B     RETURN                                                   00880000
                                                                        00890000
*--------------------------------------------------------------         00900000
*   RELEASE STORAGE                                                     00910000
*--------------------------------------------------------------         00920000
RELEASE  DS    0H                                                       00930000
         STGRETN ADDR=(R5),LEN=(R4),QH=(R6),MF=                         00940000
                                                                        00950000
*--------------------------------------------------------------         00960000
*   RETURN COMPLETION STATUS, BLOCK PTR TO REQUESTER                    00970000
*--------------------------------------------------------------         00980000
RETURN   DS    0H                                                       00990000
         #EXIT ,                                                        01000000
                                                                        01010000
         EJECT                                                          01020000
***************************************************************         01030000
*                                                                       01040000
*   LOCAL READ ONLY WORKING STORAGE                                     01050000
*                                                                       01060000
***************************************************************         01070000
         LTORG ,                                                        01080000
                                                                        01090000
         PRINT NOGEN                                                    01100000
         ICVT  ,                                                        01110000
         IHAPSA ,                                                       01120000
         IKJTCB ,                                                       01130000
         END   ,                                                        01140000

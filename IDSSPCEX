*                                                                       00010001
* ??? SERIALIZATION DURING EXPORT INEFFECTIVE IN STDENV                 00020000
*                                                                       00030000
                                                                        00040000
IDSSPCEX TITLE 'DATASPACE SERVICES - SPACE EXPORT'                      00050000
***************************************************************         00060000
*                                                                       00070000
* DSECT: EXPCHKPT - EXPORT CHECKPOINT AREA                              00080000
*                                                                       00090000
***************************************************************         00100000
EXPCHKPT DSECT                                                          00110000
EXPALU#  DS    F                  ALU NUMBER                            00120000
$EXPINIT EQU   -1                    INITIAL VALUE                      00130000
$EXPEOA  EQU   -2                    END OF ALU'S                       00140000
                                                                        00150000
EXPMASK  DS    X                  SPACE MAP MASK: ALL ALU'S IN BYTE     00160000
EXPTEST  DS    X                  SPACE MAP SHIFTED ALU ENTRY TEST MASK 00170000
EXPRSVD  DS    X                  *** RESERVED ***                      00180000
EXPALLO  DS    X                  SPACE MAP MASK: ALL ALU'S ALLOCATED   00190000
EXPCKPLN EQU   *-EXPCHKPT                                               00200000
                                                                        00210000
         EJECT ,                                                        00220000
***************************************************************         00230000
*                                                                       00240000
*   READ / WRITE WORKING STORAGE AREA                                   00250000
*                                                                       00260000
***************************************************************         00270000
WORKAREA DSECT                                                          00280000
                                                                        00290000
         @WORK ,                  STANDARD WORKAREA                     00300001
                                                                        00310001
$MAPSEG  MAPSEG TYPE=BLOCK        MAP SEGMENT DESCRIPTOR RETURN AREA    00320000
                                                                        00330000
REGSAVE1 DS    16F                LOCAL ROUTINE REGISTER SAVEAREA       00340000
REGSAVEX DS    16F                LOCAL ROUTINE REGISTER SAVEAREA       00350000
                                                                        00360000
BYTE     DS    X                  SINGLE BYTE WORKAREA                  00370000
                                                                        00380000
WORKLEN  EQU   *-WORKAREA         WORKAREA LENGTH                       00390000
                                                                        00400000
         EJECT ,                                                        00410000
         PORTPRMS ,                                                     00420000
                                                                        00430001
         EJECT ,                                                        00440000
         SPCBLOCK ,                                                     00450000
                                                                        00460001
         EJECT ,                                                        00470000
         OIE ,                                                          00480000
                                                                        00490001
         EJECT ,                                                        00500000
         $TOKEN ,                                                       00510000
                                                                        00520001
         EJECT ,                                                        00530000
         MAPSEG ,                                                       00540000
                                                                        00550001
         EJECT ,                                                        00560000
         SPCEQUS ,                                                      00570000
                                                                        00580001
         EJECT ,                                                        00590000
         EQUS  LINKAGE=VCON                                             00600000
                                                                        00610000
         EJECT ,                                                        00620000
**<DOC-ON>*****************************************************         00630001
*                                                                       00640000
* ROUTINE: IDSSPCEX - SPACE EXPORT                                      00650000
*                                                                       00660000
* DESCRIPTION:                                                          00670000
*                                                                       00680000
*    THIS ROUTINE IMPLEMENTS THE $SPACE EXPORT FUNCTION. THE            00690000
*    START FUNCTION IS USED TO INITIATE A $SPACE EXPORT. AT             00700000
*    THAT TIME, THE REQUESTER DECLARES THE TYPE OF EXPORT               00710000
*    THAT WILL BE PEFORMED: AN IMAGE COPY (ALL ALUS), ALL               00720000
*    OBJECTS (ALL ACTIVE ALUS), OR CHANGED ALUS ONLY.                   00730000
*                                                                       00740000
*    EACH ALU MOVE CALL PRESENTS A CHECKPOINT INITIALIZED BY            00750000
*    THE START FUNCTION AND AN ALU BUFFER.  AN ALU NUMBER AND           00760000
*    THE CONTENTS OF THAT ALU ARE RETURNED ON EACH CALL UNTIL           00770000
*    END-OF-ALUS IS INDICATED.                                          00780000
*                                                                       00790000
*    UPON RECEIPT OF THE END CALL, THE OIE AND SPACE MAP                00800000
*    CHANGE AND REFERENCE FLAGS ARE RESET.                              00810000
*                                                                       00820000
*                                                                       00830000
* ON ENTRY:                                                             00840000
*                                                                       00850000
*    R1 POINTS TO A PARAMETER LIST DESCRIBED BY THE PORTPRMS            00860000
*       MAPPING MACRO                                                   00870000
*                                                                       00880000
*    A/R10 - AR QUALIFIED ADDRESS OF THE STORAGE SPCBLOCK               00890000
*                                                                       00900000
*                                                                       00910000
* ON EXIT:                                                              00920000
*                                                                       00930000
*    R15 CONTAINS ONE OF THE FOLLOWING RETURN CODES                     00940000
*                                                                       00950000
*                                                                       00960000
**<DOC-OFF>****************************************************         00970001
                                                                        00980001
         EJECT ,                                                        00990000
IDSSPCEX @ENTER WORKA=(WORKAREA,WORKLEN)                                01000000
                                                                        01010000
         LAM   R1,R5,MFE_LIST     PRIMARY SPACE                         01020000
                                                                        01030000
         @LAE  R7,0(R1,0)         PLIST RESIDES IN PRIMARY SPACE        01040000
         USING PORTPRMS,R7        FORMATTED AREA                        01050000
                                                                        01060000
         L     R6,PPSTOKEN        SPACE TOKEN                           01070000
         USING $TOKEN,R6          ADDRESSABILITY                        01080000
         CLC   $TOKTAG,=CL8'SPCTOKEN'                                   01090000
         BNE   ERR_REQ                                                  01100000
                                                                        01110000
*--------------------------------------------------------------         01120000
*   VALIDATE PASSED PARAMETERS - OPEN SPACE WINDOWS                     01130000
*--------------------------------------------------------------         01140000
         L     R10,$SPCBASE       PRINCIPLE SPACE ACCESS WINDOW         01150000
         LAM   AR10,AR10,$ALET                                          01160000
         USING SPCBLOCK,R10                                             01170000
                                                                        01180000
         @LAE  R11,SPCBLOCK       OPEN WINDOW TO SPACE                  01190000
         @LAE  R9,SPCBLOCK        OPEN WINDOW TO SPACE                  01200000
         @LAE  R8,SPCBLOCK        OPEN WINDOW TO SPACE                  01210000
                                                                        01220000
*--------------------------------------------------------------         01230000
*   IDENTIFY EXPORT PHASE                                               01240000
*--------------------------------------------------------------         01250000
         L     R2,PPFUNC          CALL FUNCTION                         01260000
         B     *+4(R2)            ANALYZE                               01270000
         B     EXP_DATA              0 - MOVE ALU                       01280000
         B     EXP_INIT              4 - INITIALIZE                     01290000
         B     EXP_TERM              8 - TERMINATE                      01300000
                                                                        01310000
         EJECT ,                                                        01320000
***************************************************************         01330000
*                                                                       01340000
* EXPORT INTIALIZATION                                                  01350000
*                                                                       01360000
***************************************************************         01370000
EXP_INIT DS    0H                                                       01380000
         ICM   R2,15,PPCHKPT@     LOCATE ALU # CHECKPOINT WORD          01390000
         BZ    ERR_REQ            CHECKPOINT AREA IS REQUIRED           01400000
                                                                        01410000
         USING EXPCHKPT,R2        CHECKPOINT AREA FORMAT                01420000
         XC    EXPCHKPT(EXPCKPLN),EXPCHKPT                              01430000
         MVC   EXPALU#,=A($EXPINIT)   INITIALIZE                        01440000
                                                                        01450000
*--------------------------------------------------------------         01460000
*   GENERATE SPACE MAP BYTE TEST / COMPARE MASK                         01470000
*--------------------------------------------------------------         01480000
         @CALL IDSMAPSG,(0,#MAP_ALUS_BYTE,$MAPSEG),                    X01490000
               MF=(E,MFE_LIST)                                          01500000
         LTR   R15,R15            INTOLERANT OF ERRORS                  01510000
         BNZ   ERR_ENV                                                  01520000
                                                                        01530000
         LA    R4,$MAPSEG         MAP SEGMENT DESCRIPTOR                01540000
         USING MAPSEG,R4          RETURNED BY IDSMAPSG                  01550000
         SR    R0,R0              PREPARE FOR MASK FETCH                01560000
         IC    R0,MSEGSET+1       MIDDLE BYTE, ACTIVE ALU'S             01570000
         CLC   PPTARGET,=A(PPF$ACT)                                     01580000
         BE    SAVEMASK                                                 01590000
         IC    R0,MSEGCHG+1       MIDDLE BYTE, MODIFIED ALU'S           01600000
         CLC   PPTARGET,=A(PPF$MOD)                                     01610000
         BE    SAVEMASK                                                 01620000
         MVC   FWORD+3(1),MSEGSET+1                                     01630000
         O     R0,FWORD           ANY ALU, CHG+SET                      01640000
                                                                        01650000
SAVEMASK DS    0H                 SAVE ALU SELECTION MASK               01660000
         STC   R0,EXPMASK         CONCURRENTLY TESTS ALL ALU'S IN BYTE  01670000
         MVC   EXPALLO,MSEGSET+1  ALLOCATED ALU MASKS ALL ALU'S IN BYTE 01680000
         DROP  R4                 MAPSEG                                01690000
                                                                        01700000
*--------------------------------------------------------------         01710000
*   SERIALIZE, THEN PROJECT ACTIVE ALU'S AS SPACE MAP UPDATES           01720000
*--------------------------------------------------------------         01730000
         @SERSPC OBTAIN,$STOKEN,COND=YES,ENQDEQ=YES                     01740000
                                                                        01750000
         LTR   R0,R15             EXCLUSIVE USE ACQUIRED?               01760000
         BNZ   ERR_SER            SERIALIZATION FAILURE                 01770000
                                                                        01780000
         OI    SPC_FLAGS,SPC_$EXPORT                                    01790000
                                                                        01800000
         BAS   R14,UPDPROJ        PROJECT UPDATED OBJECTS INTO SPC MAP  01810000
*                                 R15 IS NONZERO IF OPEN OBJECTS FOUND  01820000
                                                                        01830000
*--------------------------------------------------------------         01840000
*   RETURN ALU SIZE TO CALLER SO APPROP BUFFERS CAN BE ACQUIRED         01850000
*-------------------------------------------------------------          01860000
         L     R1,SPC_ALU_SIZE    SIZE OF EACH ALU / UNIT OF EXPORT     01870000
         B     EXP_FIN            RETURN                                01880000
         DROP  R2                 EXPCHKPT                              01890000
                                                                        01900000
         EJECT ,                                                        01910000
***************************************************************         01920000
*                                                                       01930000
* EXPORT TERMINATION                                                    01940000
*                                                                       01950000
***************************************************************         01960000
EXP_TERM DS    0H                                                       01970000
         ICM   R2,15,PPCHKPT@     LOCATE ALU # CHECKPOINT WORD          01980000
         BZ    ERR_REQ            CHECKPOINT AREA IS REQUIRED           01990000
         USING EXPCHKPT,R2        FORMATTED AREA                        02000000
                                                                        02010000
         CLC   EXPALU#,=A($EXPEOA)   EXPORTED ALL ELIGIBLE ALU'S?       02020000
         BNE   *+12               SKIP UPDATE RESET IF NOT              02030000
         BAS   R14,RESETALL       ELSE RESET MODIFIED ALU FLAGS         02040000
         BAS   R14,RESETOIE       ELSE RESET MODIFIED OIE FLAGS         02050000
                                                                        02060000
         @SERSPC RELEASE,$STOKEN,ENQDEQ=YES                             02070000
                                                                        02080000
         LA    R15,RC00           ASSUME EXPORT COMPLETE                02090000
         CLC   EXPALU#,=A($EXPEOA)   EXPORTED ALL ELIGIBLE ALU'S?       02100000
         BE    *+8                SKIP UPDATE RESET IF NOT              02110000
         LA    R15,RC04           ASSUME EXPORT WAS ABANDONED           02120000
                                                                        02130000
         NI    SPC_FLAGS,FF-SPC_$EXPORT                                 02140000
         B     EXP_FIN            RETURN                                02150000
         DROP  R2                 EXPCHKPT                              02160000
                                                                        02170000
         EJECT ,                                                        02180000
***************************************************************         02190000
*                                                                       02200000
* EXPORT NEXT ALU                                                       02210000
*                                                                       02220000
***************************************************************         02230000
EXP_DATA DS    0H                                                       02240000
         ICM   R2,15,PPCHKPT@     FETCH ALU POSITION CHECKPOINT         02250000
         BZ    ERR_REQ            REQUIRED PARAMETER                    02260000
                                                                        02270000
         USING EXPCHKPT,R2        CHECKPOINT AREA ADDRESSABILITY        02280000
         CLC   =A($EXPEOA),0(R2)  REACHED END OF SPACE ALREADY?         02290000
         BE    ERR_REQ            INVALID RECALL IF SO                  02300000
                                                                        02310000
*--------------------------------------------------------------         02320000
*   LOCATE SPACE MAP ENTRY WHERE ALU SCAN WILL START / RESUME           02330000
*--------------------------------------------------------------         02340000
         L     R1,SPC_STGMAP_OIE+(OIESTORG-OIE)                         02350000
         @ALU  (1)                CONVERT TO ADDRESS                    02360000
         BNZ   ERR_ALU            ALU TRANSLATION ERROR                 02370000
         LR    R11,R1             EXPOSE MAP THRU SPACE WINDOW          02380000
                                                                        02390000
         ICM   R3,15,EXPALU#      FETCH RESUMPTION ALU #                02400000
         BNM   CALCLOC            SKIP IF NOT FIRST PASS                02410000
         BCTR  R11,0              PRIME THE SCAN PUMP                   02420000
         B     ENT_NEXT                                                 02430000
                                                                        02440000
CALCLOC  DS    0H                                                       02450000
         LR    R1,R3              PREPARE FOR MAP OFFSET CALC           02460000
         SR    R0,R0              PREP FOR DIVIDE                       02470000
         D     R0,=A(#MAP_ALUS_BYTE)                                    02480000
         AR    R11,R1             LOCATE SPACE MAP SEGMENT ORIGIN       02490000
         B     ENT_NEXT                                                 02500000
                                                                        02510000
*--------------------------------------------------------------         02520000
*   FIND NEXT MAP BYTE DESCRIBING A RETURNABLE ALU                      02530000
*--------------------------------------------------------------         02540000
BYTESCAN DS    0H                                                       02550000
         SR    R5,R5              PREPARE FOR INSERT                    02560000
         IC    R5,EXPMASK         MULTIPLE ALU TEST MASK                02570000
                                                                        02580000
BYTENEXT DS    0H                                                       02590000
         CL    R3,SPC_ALU_COUNT   ALL ALU'S PROCSSED?                   02600000
         BNL   FIN_ALUS           DONE IF SO                            02610000
         TM    0(R11),*-*         BYTE DESCRIBES AN ELIGIBLE ALU?       02620000
         EX    R5,*-4             PERFORM BYTE TEST                     02630000
         BNZ   BYTEHIT            SCAN SUSPENDED IF SO                  02640000
         LA    R11,1(,R11)        ELSE ADVANCE TO NEXT MAP BYTE         02650000
         AL    R3,=A(#MAP_ALUS_BYTE)                                    02660000
         B     BYTENEXT                                                 02670000
                                                                        02680000
BYTEHIT  DS    0H                                                       02690000
         ST    R3,EXPALU#         SAVE BYTE ORIGIN ALU #                02700000
         SR    R5,R5              PREPARE FOR SHIFT IN                  02710000
         LA    R4,FF              ALL BITS HIGH                         02720000
         SRDL  R4,#MAP_BITS_ALU   TEST MASK IN HIGH ORDER               02730000
         STCM  R5,B'1000',EXPTEST WALK ALU'S LOW TO HIGH                02740000
                                                                        02750000
*--------------------------------------------------------------         02760000
*   EXTRACT ELIGIBLE ALU FROM MAP ENTRY                                 02770000
*--------------------------------------------------------------         02780000
ENT_TEST DS    0H                                                       02790000
         MVC   BYTE,EXPTEST       ALU ENTRY TEST MASK                   02800000
         NC    BYTE,EXPMASK       ISOLATE BITS OWNED BY ALU             02810000
         NC    BYTE,0(R11)        ENTRY SELECTED?                       02820000
         BNZ   ALUXPORT           ALU FOR EXPORT                        02830000
                                                                        02840000
ENT_NEXT DS    0H                                                       02850000
         AL    R3,=F'1'           ELSE ADVANCE TO NEXT ALU              02860000
         SR    R1,R1              PREPARE FOR INSERT                    02870000
         IC    R1,EXPTEST         TEST MASK                             02880000
         SRA   R1,#MAP_BITS_ALU   ADVANCE TO NEXT ENTRY                 02890000
         STC   R1,EXPTEST         SAVE UPDATED MASK                     02900000
         BNZ   ENT_TEST           TRY NEXT ALU                          02910000
                                                                        02920000
         LA    R11,1(,R11)        THEN ADVANCE TO NEXT MAP BYTE         02930000
         B     BYTESCAN           AND REDRIVE SCAN FOR ELIGIBLE ENTRY   02940000
                                                                        02950000
*--------------------------------------------------------------         02960000
*   RETURN SELECTED ALU TO CALLER                                       02970000
*--------------------------------------------------------------         02980000
ALUXPORT DS    0H                                                       02990000
         ST    R3,EXPALU#         CHECKPOINT # OF LAST ALU RETURNED     03000000
         L     R4,PPALU@          ALU # RETURN AREA                     03010000
         ST    R3,0(,R4)          RETURN ALU TO CALLER                  03020000
                                                                        03030000
         LA    R0,RSN04           ASSUME ALU IS NOT ALLOCATED           03040000
         MVC   BYTE,EXPTEST       ALU ENTRY TEST MASK                   03050000
         NC    BYTE,EXPALLO       ISOLATE ALLOCATION BIT                03060000
         NC    BYTE,0(R11)        ALU IS ALLOCATED?                     03070000
         BZ    RET_NORM           BYPASS DATA MOVEMENT IF NOT           03080000
                                                                        03090000
         L     R4,PPBUF@          ALU BUFFER                            03100000
         L     R5,SPC_ALU_SIZE    RETURN ENTIRE BLOCK                   03110000
         LR    R9,R5              SOURCE LENGTH = TARGET LENGTH         03120000
         @ALU  (R3)               CONVERT ALU NUMBER TO ADDRESS         03130000
         BNZ   ERR_ALU            ALU TRANSLATION ERROR                 03140000
         LR    R8,R1              ESTABLISH SOURCE ALU ADDRESS          03150000
         MVCL  R4,R8              COPY TO REQUESTORS BUFFER             03160000
         LA    R0,RSN00           INDICATE ALU RETURNED                 03170000
                                                                        03180000
RET_NORM DS    0H                                                       03190000
         LA    R15,RC00           NORMAL COMPLETION                     03200000
         B     EXP_FIN            DONE                                  03210000
                                                                        03220000
*--------------------------------------------------------------         03230000
*   END OF ALU'S                                                        03240000
*--------------------------------------------------------------         03250000
FIN_ALUS DS    0H                 END OF ALU'S ENCOUNTERED              03260000
         MVC   EXPALU#,=A($EXPEOA)    INDICATE END OF SPACE             03270000
         LA    R15,RC04           FRIENDLY REFLECTION FOR USER          03280000
         SR    R0,R0              NO REASON CODE DEFINED                03290000
         B     EXP_FIN            DONE                                  03300000
                                                                        03310000
         EJECT ,                                                        03320000
***************************************************************         03330000
*                                                                       03340000
* RETURN COMPLETION STATUS TO CALLER                                    03350000
*                                                                       03360000
***************************************************************         03370000
ERR_SER  DS    0H                 SERIALIZATION FAILURE                 03380000
         LA    R15,RC08           R0 CONTAINS ENQ RETCODE               03390000
         B     EXP_FIN                                                  03400000
                                                                        03410000
ERR_REQ  DS    0H                 INVALID REQUEST                       03420000
         LA    R15,RC12                                                 03430000
         SR    R0,R0              NO REASON CODE DEFINED                03440000
         B     EXP_FIN                                                  03450000
                                                                        03460000
ERR_ALU  DS    0H                 ALU TRANSLATION ERROR                 03470000
         LA    R15,RC20                                                 03480000
         SR    R0,R0              NO REASON CODE DEFINED                03490000
         B     EXP_FIN                                                  03500000
                                                                        03510000
ERR_ENV  DS    0H                 ENVIRONMENTAL / SERVICE FAILURE       03520000
                                                                        03530000
EXP_FIN  DS    0H                                                       03540000
         NOP   0                  SPACE FOR TRAP                        03550000
                                                                        03560000
         @EXIT ,                                                        03570000
                                                                        03580001
         EJECT ,                                                        03590000
***************************************************************         03600000
*                                                                       03610000
* ROUTINE: UPDPROJ - PROJECT OBJECT MODIFICATIONS INTO SPC MAP          03620000
*                                                                       03630000
***************************************************************         03640000
UPDPROJ  DS    0H                                                       03650000
         STM   R0,R15,REGSAVE1                                          03660000
         LA    R5,RC00            PRESUME COMPLETION STATUS             03670000
                                                                        03680000
         USING OIE,R11            LIFE OF ROUTINE                       03690000
                                                                        03700000
         @LAE  R11,SPC_SYSPFX_OIE SPACE PREFIX                          03710000
         BAS   R14,UPDFLASH       UPDATE MAP                            03720000
         BNZ   UPDERROR           ABNORMAL                              03730000
                                                                        03740000
         @LAE  R11,SPC_STGMAP_OIE STORAGE MAP                           03750000
         BAS   R14,UPDFLASH       UPDATE MAP                            03760000
         BNZ   UPDERROR           ABNORMAL                              03770000
                                                                        03780000
         @LAE  R11,SPC_POOL_OIE   OIE POOL                              03790000
         BAS   R14,UPDFLASH       UPDATE MAP                            03800000
         BNZ   UPDERROR           ABNORMAL                              03810000
                                                                        03820000
*--------------------------------------------------------------         03830000
*   LOCATE OIE POOL BASE FOR OIE TRAVERSAL                              03840000
*--------------------------------------------------------------         03850000
         L     R1,OIESTORG        ORIGIN OF OIEPOOL                     03860000
         @ALU  (1)                DERIVE ORIGIN ADDRESS                 03870000
         BNZ   ERR_ALU            ZERO TOLERANCE                        03880000
         LR    R9,R1              PRESERVE OIE POOL BASE                03890000
                                                                        03900000
*--------------------------------------------------------------         03910000
*   ACCOUNT FOR USER PROJECT UPDATES IN SPACE MAP                       03920000
*--------------------------------------------------------------         03930000
         LA    R11,SPC_OIE_LIST-(OIEMSTRF-OIE)                          03940000
                                                                        03950000
UPDPNEXT DS    0H                 PROCESS NEXT APPL OBJECT              03960000
         ICM   R11,15,OIEMSTRF    OFFLINK OF NEXT PROJECT               03970000
         BZ    UPDPEND            DONE IF END OF LIST                   03980000
         AR    R11,R9                                                   03990000
                                                                        04000000
         TM    OIEFLAGS,OIEWRITE  POSSIBLE UPDATES TO OBJECT?           04010000
         BNO   UPDPNEXT           ADVANCE IF UNLIKELY                   04020000
         TM    OIEFLAGS,OIEACCES  APPEARS THAT APPL IS STILL ACTIVE?    04030000
         BNO   *+8                SKIP IF NOT                           04040000
         LA    R5,RC04            REMARK THAT SPACE IS NOT IDLE         04050000
                                                                        04060000
         BAS   R14,UPDFLASH       UPDATE MAP                            04070000
         BNZ   UPDERROR           ABNORMAL                              04080000
         B     UPDPNEXT           ACCOUNT FOR ALL OBJECTS               04090000
                                                                        04100000
*--------------------------------------------------------------         04110000
*   RETURN COMPLETION STATUS                                            04120000
*--------------------------------------------------------------         04130000
UPDERROR DS    0H                 ABNORMAL COMPLETION                   04140000
         LR    R1,R15             PRESERVE DIAGNOSTIC INFO              04150000
         LA    R15,RC08           INDICATE ERROR                        04160000
         B     UPDPRET            DONE                                  04170000
                                                                        04180000
UPDPEND  DS    0H                 NORMAL COMPLETION                     04190000
         LR    R15,R5             BUFFERED RETCODE                      04200000
                                                                        04210000
UPDPRET  DS    0H                 RETURN TO CALLER                      04220000
         LM    R0,R14,REGSAVE1                                          04230000
         LTR   R15,R15                                                  04240000
         BR    R14                                                      04250000
                                                                        04260000
         EJECT ,                                                        04270000
***************************************************************         04280000
*                                                                       04290000
* ROUTINE: UPDFLASH - PROJECT ACTIVE PAGES INTO SPACE MAP               04300000
*                                                                       04310000
* ON ENTRY:                                                             04320000
*                                                                       04330000
*    OIE IS ADDRESSABLE                                                 04340000
*                                                                       04350000
* ON EXIT:                                                              04360000
*                                                                       04370000
*    R15-R1 CONTAIN THE IDSMAPSV SERVICE ROUTINE RETURN VALUES          04380000
*                                                                       04390000
***************************************************************         04400000
UPDFLASH DS    0H                                                       04410000
         STM   R0,R15,REGSAVEX    PRESERVE REGS                         04420000
                                                                        04430000
         LA    R15,RC00           PRESUME NORMAL COMPLETION             04440000
         CLC   OIESTHWM,=F'0'     ANY ACTIVE PAGES?                     04450000
         BE    UPDFRET            DONE IF NOT                           04460000
                                                                        04470000
         L     R3,OIESTORG        STORAGE EXTENT ORIGIN                 04480000
         L     R4,OIESTLEN        ASSUME ENTIRE EXTENT IN USE           04490000
         CLC   OIESTHWM,=F'-1'    MUST CONCLUDE SO?                     04500000
         BE    UPDFGO             PROJECT ONTO SPACE MAP                04510000
                                                                        04520000
         L     R4,OIESTHWM        ELSE GET # BYTES ACTUALLY IN USE      04530000
         BCTR  R4,0               ZERO RELATIVE NDX                     04540000
         L     R15,SPC_ALU_POWER2 ALU/BYTE CONVERSION FACTOR            04550000
         SRL   R4,0(R15)          # ALU'S SPANNED -1                    04560000
         LA    R4,1(,R4)          CONVERT TO ALU COUNT                  04570000
                                                                        04580000
*--------------------------------------------------------------         04590000
*   MARK ACTIVE PAGES AS CHANGED                                        04600000
*--------------------------------------------------------------         04610000
UPDFGO   DS    0H                                                       04620000
         @CALL IDSMAPSV,(STGCHGED,(R3),(R4),0),MF=(E,MFE_LIST)          04630000
                                                                        04640000
UPDFRET  DS    0H                                                       04650000
         LM    R2,R14,REGSAVEX+8  RESTORE MAINLINE REGS                 04660000
         LTR   R15,15             PRESENT COMPLETION CODE AS CC         04670000
         BR    R14                                                      04680000
                                                                        04690000
         EJECT ,                                                        04700000
***************************************************************         04710000
*                                                                       04720000
* ROUTINE: RESETALL                                                     04730000
*                                                                       04740000
* DESCRIPTION:                                                          04750000
*                                                                       04760000
*    FAST "RESET ENTIRE SPACE" CALL IS EASY TO IMPLEMENT IN SV          04770000
*                                                                       04780000
* ON ENTRY:                                                             04790000
*                                                                       04800000
*    OIE IS ADDRESSABLE                                                 04810000
*                                                                       04820000
* ON EXIT:                                                              04830000
*                                                                       04840000
*    R15-R1 CONTAIN THE IDSMAPSV SERVICE ROUTINE RETURN VALUES          04850000
*                                                                       04860000
***************************************************************         04870000
RESETALL DS    0H                                                       04880000
         STM   R0,R15,REGSAVEX    SAVE MAINLINE REGS                    04890000
                                                                        04900000
         @CALL IDSMAPSV,(STGRESET,0,*SPC_ALU_COUNT,0),                 X04910000
               MF=(E,MFE_LIST)                                          04920000
                                                                        04930000
         LM    R2,R14,REGSAVEX+8  RESTORE MAINLINE RGS                  04940000
         LTR   R15,15             PRESENT SERVICE RTN RETCODE           04950000
         BR    R14                                                      04960000
                                                                        04970000
         EJECT ,                                                        04980000
***************************************************************         04990000
*                                                                       05000000
* ROUTINE: RESETOIE                                                     05010000
*                                                                       05020000
* DESCRIPTION:                                                          05030000
*                                                                       05040000
*    RESET OBJECT MODIFICATION STATUS IN ALL CLOSED OBJECTS             05050000
*                                                                       05060000
* ON ENTRY:                                                             05070000
*                                                                       05080000
*    SPCBLOCK IS ADDRESSABLE VIA A/R10                                  05090000
*                                                                       05100000
* ON EXIT:                                                              05110000
*                                                                       05120000
*    R15 CONTAINS ZERO                                                  05130000
*                                                                       05140000
***************************************************************         05150000
RESETOIE DS    0H                                                       05160000
         STM   R0,R15,REGSAVEX    SAVE MAINLINE REGS                    05170000
                                                                        05180000
         NI    SPC_STGMAP_OIE+(OIEFLAGS-OIE),FF-OIEWRITE                05190000
         NI    SPC_POOL_OIE+(OIEFLAGS-OIE),FF-OIEWRITE                  05200000
                                                                        05210000
*--------------------------------------------------------------         05220000
*   LOCATE OIE POOL BASE FOR OIE TRAVERSAL                              05230000
*--------------------------------------------------------------         05240000
         @LAE  R11,SPC_POOL_OIE   OIE POOL                              05250000
         USING OIE,R11            LIFE OF ROUTINE                       05260000
         L     R1,OIESTORG        ORIGIN OF OIEPOOL                     05270000
         @ALU  (1)                DERIVE ORIGIN ADDRESS                 05280000
         BNZ   ERR_ALU            ZERO TOLERANCE                        05290000
         LR    R9,R1              PRESERVE OIE POOL BASE                05300000
                                                                        05310000
*--------------------------------------------------------------         05320000
*   RESET WRITE ACCESS FLAG IN CLOSED OIE'S                             05330000
*--------------------------------------------------------------         05340000
         LA    R11,SPC_OIE_LIST-(OIEMSTRF-OIE)                          05350000
                                                                        05360000
RSOIENXT DS    0H                 PROCESS NEXT APPL OBJECT              05370000
         ICM   R11,15,OIEMSTRF    OFFLINK OF NEXT PROJECT               05380000
         BZ    RSOIEEND           DONE IF END OF LIST                   05390000
         AR    R11,R9                                                   05400000
                                                                        05410000
         TM    OIEFLAGS,OIEACCES  APPEARS THAT APPL IS STILL ACTIVE?    05420000
         BO    *+8                NO RESET IF SO                        05430000
         NI    OIEFLAGS,FF-OIEWRITE-OIEREAD                             05440000
         B     RSOIENXT           VISIT ALL OBJECTS                     05450000
                                                                        05460000
RSOIEEND DS    0H                                                       05470000
         LM    R0,R14,REGSAVEX    RESTORE MAINLINE REGS                 05480000
         SR    R15,R15                                                  05490000
         BR    R14                                                      05500000
         DROP  R11                OIE                                   05510000
                                                                        05520000
                                                                        05530000
         EJECT ,                                                        05540000
***************************************************************         05550000
*                                                                       05560000
* READ ONLY CONSTANTS, ETC                                              05570000
*                                                                       05580000
***************************************************************         05590000
         LTORG ,                                                        05600000
         END   ,                                                        05610000

ITICLN   TITLE 'ITICLN - TABLE INTERFACE BLOCK RESOURCE MANAGER'        00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: ITICLN  - Table interface block resource manager             00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine provides resource management for the table            00080000
*    interface block (TIB, as mapped by TIBLOCK). The table             00090000
*    associated with the given TIB is closed or dropped, as             00100000
*    previously posted and associated data areas are released.          00110000
*                                                                       00120000
*    The caller is responsible for dechaining the TIB prior             00130000
*    to invoking this routine.                                          00140000
*                                                                       00150000
*                                                                       00160000
* ON ENTRY:                                                             00170000
*                                                                       00180000
*    R1 - address of the TIB (TIBLOCK)                                  00190000
*                                                                       00200000
*                                                                       00210000
* ON EXIT:                                                              00220000
*                                                                       00230000
*    R15 contains one of the following return codes                     00240000
*                                                                       00250000
*       RC00 - TBCLOSE or TBDROP attempted, TIB freed                   00260000
*                                                                       00270000
*              R0 - table service retcode                               00280000
*              R1 - table service rsncode                               00290000
*                                                                       00300000
**<DOC-OFF>****************************************************         00310000
                                                                        00320000
         EJECT ,                                                        00330000
***************************************************************         00340000
*                                                                       00350000
* MAINTENANCE:                                                          00360000
*                                                                       00370000
*   04/05/92  R. Turgeon                                                00380000
*             Initial version                                           00390000
*                                                                       00400000
*   12/06/94  R. Turgeon                                                00410000
*             Removed PAGE= / SHRPAGE= for $SPACE, $OBJECT,             00420000
*             and TB* service requests                                  00430000
*                                                                       00440000
***************************************************************         00450000
                                                                        00460000
         EJECT                                                          00470000
         #WORK ,                                                        00480000
TBRETC   DS    F                  TABLE SERVICE RETCODE                 00490000
TBRSNC   DS    F                  TABLE SERVICE RSNCODE                 00500000
         #ENDWORK ,                                                     00510000
                                                                        00520000
         EJECT                                                          00530000
         TIBLOCK ,                TABLE INTERFACE BLOCK          (TIB)  00540000
                                                                        00550000
         EJECT                                                          00560000
         TBSERVIS CLOSE,DROP                                            00570000
                                                                        00580000
         EJECT                                                          00590000
         EQUS  ,                  GENERAL EQUATES                       00600000
                                                                        00610000
         EJECT ,                                                        00620000
ITICLN   #ENTER BASE=R12,PREG=R8                                        00630000
                                                                        00640000
         USING ITASK,R10          ITASK ADDRESSABILITY                  00650000
         L     R9,TSKPCBC         ADDRESS OF CURRENT PCB                00660000
         USING IPCB,R9            ADDRESSABILTY                         00670000
                                                                        00680000
*--------------------------------------------------------------         00690000
*   Close or drop the table, as prev posted in TIB                      00700000
*--------------------------------------------------------------         00710000
                                                                        00720000
         USING TIBLOCK,R8         TIB - LIFE OF FUNCTION                00730000
                                                                        00740000
         CLC   TIBPROJ,=CL8'SYSCATLG'                                   00750000
         BE    CLOSETBL           IGNORE DROP REQUEST                   00760000
         TM    TIBFLAGS,TIB$DROP  TABLE DROP REQUESTED?                 00770000
         BO    DROPTBL            YES, REMOVE TABLE FROM PROJECT        00780000
                                                                        00790000
CLOSETBL DS    0H                                                       00800000
         TBCLOSE TTOKEN=TIBTOKN,  CLOSE THE TABLE                      +00810000
               MF=(E,MFE_LIST)                                          00820000
         B     SETRCRSN           CONTINUE WITH TIB DEALLOCATION        00830000
                                                                        00840000
DROPTBL  DS    0H                                                       00850000
         TBDROP  TTOKEN=TIBTOKN,  DROP THE TABLE                       +00860000
               MF=(E,MFE_LIST)                                          00870000
                                                                        00880000
SETRCRSN DS    0H                                                       00890000
         ST    R15,TBRETC         TABLE SERVICE RETURN CODE             00900000
         ST    R0,TBRSNC          TABLE SERVICE REASON CODE             00910000
                                                                        00920000
*--------------------------------------------------------------         00930000
*   Free the TIB and all associated data areas                          00940000
*--------------------------------------------------------------         00950000
                                                                        00960000
         ICM   R1,15,TIBDESC      TABLE DESCRIPTION?                    00970000
         BZ    FREE_ROW           NO DESCRIBE PERFORMED                 00980000
                                                                        00990000
         $RETSTOR *TIBDESC                                              01000000
                                                                        01010000
FREE_ROW DS    0H                                                       01020000
         ICM   R1,15,TIBROWBF     TABLE ROW BUFFER?                     01030000
         BZ    FREE_WKA           NO BUFFER ALLOCATED                   01040000
                                                                        01050000
         $RETSTOR *TIBROWBF,OWNER=ITASK                                 01060000
                                                                        01070000
FREE_WKA DS    0H                                                       01080000
         OC    TIBSTGP,TIBSTGP    STGMGR WORKAREA OWNED BY TABLE?       01090000
         BZ    FREE_TIB           NOT ALLOCATED                         01100000
                                                                        01110000
         STGTERM QH=TIBSTGP                                             01120000
                                                                        01130000
FREE_TIB DS    0H                                                       01140000
         L     R2,PCBUSER         ADDRESS OF IUSER                      01150000
         USING IUSER,R2           ADDRESSABILITY                        01160000
                                                                        01170000
         LA    R3,TIBLOCK         FREE THE TIB                          01180000
                                                                        01190000
         STGRETN ADDR=(R3),LEN=TIBLN,QH=USRSTG                          01200000
                                                                        01210000
         DROP  R2                 IUSER                                 01220000
                                                                        01230000
         EJECT                                                          01240000
***************************************************************         01250000
*                                                                       01260000
*   Return completion status to caller                                  01270000
*                                                                       01280000
***************************************************************         01290000
                                                                        01300000
RETURN   DS    0H                                                       01310000
         LA    R15,RC00           RETURN CODE                           01320000
         L     R0,TBRETC          TABLE SERVICE RETCODE AS RSNCODE      01330000
         L     R1,TBRSNC          TABLE SERVICE RSNCODE AS INFO CODE    01340000
                                                                        01350000
         #EXIT ,                  RETURN                                01360000
                                                                        01370000
         EJECT                                                          01380000
***************************************************************         01390000
*                                                                       01400000
*   Local read only storage                                             01410000
*                                                                       01420000
***************************************************************         01430000
                                                                        01440000
         LTORG ,                                                        01450000
                                                                        01460000
         PRINT NOGEN                                                    01470000
         ICVT  ,                                                        01480000
         ITASK ,                                                        01490000
         IPCB  ,                                                        01500000
         IUSER ,                                                        01510000
         END   ,                                                        01520000

IL62UPCV TITLE 'INTEGRATOR - IVUSER LU6.2 PROCESS CNOS VARIABLE'        00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C DEFINITIONS          00040000
         L62INCL ,                INTEGRATOR LU6.2 DEFINITIONS          00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: IL62UPCV - IVUSER LU6.2 PROCESS CNOS VARIABLE                00100000
*                                                                       00110000
* DESCRIPTION:                                                          00120000
*                                                                       00130000
* ON ENTRY:                                                             00140000
*                                                                       00150000
*    R15 = ENTRY POINT ADDRESS                                          00160000
*    R14 = RETURN ADDRESS                                               00170000
*    R13 = AVAILABLE SAVE AREA                                          00180000
*    R11 = ICVT ADDRESS                                                 00190000
*    R10 = ITASK ADDRESS                                                00200000
*    R09 = IVTAMCVT ADDRESS                                             00210000
*    R08 = IVUSER ADDRESS                                               00220000
*    R01 = ADDRESS OF LU6.2 PROCESS CNOS VARIABLE WORK ELEMENT          00230000
*                                                                       00240000
* ON EXIT:                                                              00250000
*                                                                       00260000
*    R15 = 0                                                            00270000
*    R00 = 0                                                            00280000
*    R01 = 0                                                            00290000
*                                                                       00300000
*    ALL OTHER REGISTERS ARE RESTORED.                                  00310000
*                                                                       00320000
**<DOC-OFF>************************************************************ 00330000
                                                                        00340000
         EJECT ,                                                        00350000
*********************************************************************** 00360000
*                                                                       00370000
* MAINTENANCE:                                                          00380000
*                                                                       00390000
*   09/01/94 RANDY WITEK - LU6.2 SUPPORT                                00400000
*                                                                       00410000
*********************************************************************** 00420000
                                                                        00430000
         EQUS  ,                  GENERAL EQUATES                       00440000
                                                                        00450000
RICVT    EQU   R11                                                      00460000
RITASK   EQU   R10                                                      00470000
RIVTAM   EQU   R9                                                       00480000
RIVUSER  EQU   R8                                                       00490000
RIWE     EQU   R7                                                       00500000
RAQE     EQU   R6                                                       00510000
RMDE     EQU   R5                                                       00520000
                                                                        00530000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00540000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00550000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00560000
         USING IVUSER,RIVUSER     ESTABLISH ADDRESSABILITY              00570000
         USING IWEVTAM,RIWE       ESTABLISH ADDRESSABILITY              00580000
         USING AQE,RAQE           ESTABLISH ADDRESSABILITY              00590000
         USING MDE,RMDE           ESTABLISH ADDRESSABILITY              00600000
                                                                        00610000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00620000
WRK256   DS    XL256              GENERAL WORKAREA                      00630000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00640000
L62MFL   L62POST MF=L             PLIST CONSTRUCTION                    00650000
L62RETCD DS    F                  LU6.2 RETURN CODE RETURN AREA         00660000
L62RETMD DS    F                  LU6.2 MDE ADDRESS RETURN AREA         00670000
                                                                        00680000
DELTA    DS    F                  CHANGE_SESSIONS.DELTA                 00690000
CONWIN#  DS    F                  CONWINNER_COUNT                       00700000
CONLOS#  DS    F                  CONLOSER_COUNT                        00710000
OLDLIMIT DS    F                  OLD_SESSION_LIMIT                     00720000
PLATEAU  DS    F                  PLATEAU                               00730000
CONWININ DS    F                  CONWINNER_INCREMENT                   00740000
SESSDECR DS    F                  SESSION_DECREMENT                     00750000
CONLOSIN DS    F                  CONLOSER_INCREMENT                    00760000
NEEDTOAC DS    F                  NEED_TO_ACTIVATE                      00770000
ROOMTOAC DS    F                  ROOM_FOR_ACTIVATE                     00780000
DECFORPL DS    F                  DECREMENT_FOR_POLARITY                00790000
                                                                        00800000
TEMPLIM  DS    F                                                        00810000
TEMPWIN  DS    F                                                        00820000
TEMPLOSE DS    F                                                        00830000
TEMPRESP DS    CL8                                                      00840000
TEMPDRS  DS    CL4                                                      00850000
TEMPDRT  DS    CL4                                                      00860000
                                                                        00870000
RETR15   DS    F                                                        00880000
RETR0    DS    F                                                        00890000
RETR1    DS    F                                                        00900000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00910000
FLAG     DS    X                                                        00920000
FLAGLOCK EQU   X'80'                                                    00930000
FLAGLCKD EQU   X'40'                                                    00940000
FLAGDLCK EQU   X'20'              DISP LOCK HELD                        00950000
FLAGDLKD EQU   X'10'              DISP LOCK HELD ON ENTRY               00960000
FLAGRACE EQU   X'08'              REQUEST REJECTED DUE TO RACE          00970000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00980000
                                                                        00990000
         USING CVAR,IWEY7VAR      ESTABLISH ADDRESSABILITY              01000000
                                                                        01010000
         $MSGDFT PREFIX=ICTPID,                                        +01020000
               COMPID='L62',                                           +01030000
               TABLE=*#MSGS,                                           +01040000
               WORKA=0,                                                +01050000
               MF=(E,WRK256),                                          +01060000
               PRINT=NOGEN                                              01070000
                                                                        01080000
IL62UPCV #ENTER BASE=R12,                                              +01090000
               PREG=RIWE,                                              +01100000
               AMODE=31,                                               +01110000
               RMODE=ANY                                                01120000
                                                                        01130000
*---------------------------------------------------------------------- 01140000
* ESTABLISH ENVIRONMENT                                                 01150000
*---------------------------------------------------------------------- 01160000
                                                                        01170000
         BAS   R14,VTAMLOCK         SERIALIZE                           01180000
                                                                        01190000
         CLI   CVARSERV,CVARSERV_REQUEST                                01200000
         BE    RQS1                 BRANCH IF THIS IS A REQUEST         01210000
                                                                        01220000
         CLI   CVARSERV,CVARSERV_REPLY_ACCEPTED                         01230000
         BE    RPS1                 BRANCH IF THIS IS A GOOD REPLY      01240000
                                                                        01250000
         CLI   CVARSERV,CVARSERV_REPLY_ABNORMAL                         01260000
         BE    RPABNORM             BRANCH IF THIS IS A BAD REPLY       01270000
                                                                        01280000
         B     ERRENVIR             BRANCH IF UNKNOWN VARIABLE TYPE     01290000
                                                                        01300000
*---------------------------------------------------------------------- 01310000
* PROCESS A SET REPLY - SINGLE SESSION                                  01320000
*---------------------------------------------------------------------- 01330000
                                                                        01340000
RPS1     DS    0H                                                       01350000
                                                                        01360000
         CLI   CVARACT,CVARACT_SET                                      01370000
         BNE   RPC1                 BRANCH IF THIS IS NOT A SET REPLY   01380000
         BAS   R14,DISPMODE         LOCATE THE MDE                      01390000
         OC    L62RETCD,L62RETCD    GOOD RETURN CODE?                   01400000
         BNZ   ERRENVIR             BRANCH IF NOT, IGNORE THE REPLY     01410000
         ICM   RMDE,15,L62RETMD     RETURNED MDE                        01420000
         BNP   ERRENVIR             BRANCH IF DOESN'T LOOK GOOD         01430000
         TM    MDEF1,MDEF1CNI       IS CNOS NEGOTIATION UNDERWAY?       01440000
         BNO   ERRENVIR             BRANCH IF NOT                       01450000
         NI    MDEF1,255-MDEF1CNI   CLEAR THE NEGOTIATION FLAG          01460000
         NI    MDEF1,255-MDEF1LDN   CLEAR POSSIBLE RACE FLAG            01470000
         NI    MDEF1,255-MDEF1INI   CLEAR POSSIBLE INIT FLAG            01480000
                                                                        01490000
         L     R2,MDESESSL          CURRENT SESSION LIMIT               01500000
         SR    R1,R1                CLEAR FOR INSERTS                   01510000
         ICM   R1,B'0011',CVARSLIM  THE SESSION LIMIT                   01520000
         ST    R1,MDESESSL          SET THE SESSION LIMIT               01530000
         SR    R1,R2                DELTA SESSION LIMIT                 01540000
         ST    R1,DELTA             SAVE THE DELTA                      01550000
         SR    R1,R1                CLEAR FOR INSERTS                   01560000
         ICM   R1,B'0011',CVARSWIN  THE SOURCE CON WINNER COUNT         01570000
         ST    R1,MDEMINCW          SET THE SOURCE CONWIN COUNT         01580000
         ICM   R1,B'0011',CVARTWIN  THE TARGET CON WINNER COUNT         01590000
         ST    R1,MDEMINCL          SET THE TARGET CONWIN COUNT         01600000
                                                                        01610000
         CLI   CVARRESP,CVARRESP_TARGET_YES                             01620000
         BE    RPS1NRSP             BRANCH IF WE ARE NOT RESPONSIBLE    01630000
         BAS   R14,TERMPROC         GO START TERMINATION IF APPROPRIATE 01640000
                                                                        01650000
RPS1NRSP DS    0H                                                       01660000
                                                                        01670000
         BAS   R14,ACTNEEDD         GO SEE IF WE CAN ACTIVATE NEEDED    01680000
         B     RETURN                                                   01690000
                                                                        01700000
*---------------------------------------------------------------------- 01710000
* PROCESS A CLOSE REPLY - SINGLE SESSION                                01720000
*---------------------------------------------------------------------- 01730000
                                                                        01740000
RPC1     DS    0H                                                       01750000
                                                                        01760000
         CLI   CVARACT,CVARACT_CLOSE                                    01770000
         BNE   ERRENVIR             BRANCH IF NOT A CLOSE REPLY         01780000
                                                                        01790000
         CLI   CVARMSEL,CVARMSEL_ALL                                    01800000
         BE    RPCA                 BRANCH IF CLOSE "ALL" REPLY         01810000
         BAS   R14,DISPMODE         LOCATE THE MDE                      01820000
         OC    L62RETCD,L62RETCD    GOOD RETURN CODE?                   01830000
         BNZ   ERRENVIR             BRANCH IF NOT, IGNORE THE REPLY     01840000
         ICM   RMDE,15,L62RETMD     RETURNED MDE                        01850000
         BNP   ERRENVIR             BRANCH IF DOESN'T LOOK GOOD         01860000
         TM    MDEF1,MDEF1CNI       IS CNOS NEGOTIATION UNDERWAY?       01870000
         BNO   ERRENVIR             BRANCH IF NOT                       01880000
         NI    MDEF1,255-MDEF1CNI   CLEAR THE NEGOTIATION FLAG          01890000
         NI    MDEF1,255-MDEF1LDN   CLEAR POSSIBLE RACE FLAG            01900000
         L     R2,MDESESSL          CURRENT SESSION LIMIT               01910000
         SR    R1,R1                CLEAR                               01920000
         ST    R1,MDESESSL          SESSLIM = 0                         01930000
         ST    R1,MDEMINCW          MIN_CONWINNERS_SOURCE = 0           01940000
         ST    R1,MDEMINCL          MIN_CONWINNERS_TARGET = 0           01950000
         SR    R1,R2                SESSION DELTA                       01960000
         ST    R1,DELTA             SAVE THE DELTA                      01970000
         TM    CVARDIMM,CVARDIMM_SOURCE_YES                             01980000
         BNO   RPC1STOP             BRANCH IF NOT ALLOWED TO DRAIN      01990000
         OI    MDEF1,MDEF1DRS       SHOW THAT TP'S ARE DRAINING         02000000
         B     RPC1RESP             AND CONTINUE                        02010000
                                                                        02020000
RPC1STOP DS    0H                                                       02030000
                                                                        02040000
         OI    MDEF1,MDEF1STO       SHOW THAT TP'S ARE STOPPED          02050000
                                                                        02060000
RPC1RESP DS    0H                                                       02070000
                                                                        02080000
         CLI   CVARRESP,CVARRESP_TARGET_YES                             02090000
         BE    RETURN               EXIT IF PARTNER IS RESPONSIBLE      02100000
         BAS   R14,TERMPROC         GO START TERMINATION IF APPROPRIATE 02110000
         B     RETURN                                                   02120000
                                                                        02130000
*---------------------------------------------------------------------- 02140000
* PROCESS A CLOSE REPLY - ALL MODES                                     02150000
*---------------------------------------------------------------------- 02160000
                                                                        02170000
RPCA     DS    0H                                                       02180000
                                                                        02190000
         OI    IVUF1,IVUF1CAM       CLOSE ALL MODES IN PROGRESS         02200000
         LA    RMDE,IVUMD1ST        GET SET TO RUN THE CHAIN            02210000
         S     RMDE,=A(MDENEXT-MDE) GET SET TO RUN THE CHAIN            02220000
                                                                        02230000
RPCARUN  DS    0H                                                       02240000
                                                                        02250000
         ICM   RMDE,15,MDENEXT      LINK TO THE NEXT MDE                02260000
         BM    RPCACHEK             BRANCH IF ALL PROCESSED             02270000
         CLC   MDENAME,=CL8'SNASVCMG'                                   02280000
         BE    RPCARUN              DON'T DO THIS MODE                  02290000
                                                                        02300000
*                                                                       02310000
* PROCESS THE NEXT MODE IN THE LIST                                     02320000
*---------------------------------------------------------------------- 02330000
                                                                        02340000
         TM    MDEF1,MDEF1CNI       IS CNOS NEGOTIATION UNDERWAY?       02350000
         BNO   ERRENVIR             BRANCH IF NOT...SHOULD BE           02360000
         NI    MDEF1,255-MDEF1CNI   CLEAR THE NEGOTIATION FLAG          02370000
         NI    MDEF1,255-MDEF1LDN   CLEAR POSSIBLE RACE FLAG            02380000
         L     R2,MDESESSL          CURRENT SESSION LIMIT               02390000
         SR    R1,R1                CLEAR                               02400000
         ST    R1,MDESESSL          SESSLIM = 0                         02410000
         ST    R1,MDEMINCW          MIN_CONWINNERS_SOURCE = 0           02420000
         ST    R1,MDEMINCL          MIN_CONWINNERS_TARGET = 0           02430000
         SR    R1,R2                SESSION DELTA                       02440000
         ST    R1,DELTA             SAVE THE DELTA                      02450000
         TM    CVARDIMM,CVARDIMM_SOURCE_YES                             02460000
         BNO   RPCASTOP             BRANCH IF NOT ALLOWED TO DRAIN      02470000
         OI    MDEF1,MDEF1DRS       SHOW THAT TP'S ARE DRAINING         02480000
         B     RPCARESP             AND CONTINUE                        02490000
                                                                        02500000
RPCASTOP DS    0H                                                       02510000
                                                                        02520000
         OI    MDEF1,MDEF1STO       SHOW THAT TP'S ARE STOPPED          02530000
                                                                        02540000
RPCARESP DS    0H                                                       02550000
                                                                        02560000
         CLI   CVARRESP,CVARRESP_TARGET_YES                             02570000
         BE    RPCARUN              GET NEXT MODE IF PARTNER RESP.      02580000
         BAS   R14,TERMPROC         GO START TERMINATION IF APPROPRIATE 02590000
         B     RPCARUN              GET NEXT MODE                       02600000
                                                                        02610000
*                                                                       02620000
* SPECIAL CALL TO BRING DOWN SNASVCMG SESSIONS IF ONLY THEY ARE ACTIVE  02630000
*---------------------------------------------------------------------- 02640000
                                                                        02650000
RPCACHEK DS    0H                                                       02660000
                                                                        02670000
         L     R15,IL6@USUC         STOP USER CHECK                     02680000
         BASR  R14,R15              LINK TO ROUTINE                     02690000
         B     RETURN               AND EXIT                            02700000
                                                                        02710000
*---------------------------------------------------------------------- 02720000
* PROCESS AN ABNORMAL REPLY                                             02730000
*---------------------------------------------------------------------- 02740000
                                                                        02750000
RPABNORM DS    0H                                                       02760000
                                                                        02770000
         SR    RMDE,RMDE            NO MODE YET                         02780000
         CLI   CVARMSEL,CVARMSEL_ALL WAS A RESET ALL REJECTED?          02790000
         BE    RPABNINI             BRANCH IF YES                       02800000
         BAS   R14,DISPMODE         LOCATE THE MDE                      02810000
         OC    L62RETCD,L62RETCD    GOOD RETURN CODE?                   02820000
         BNZ   ERRENVIR             BRANCH IF NOT...MDE SHOULD BE THERE 02830000
         ICM   RMDE,15,L62RETMD     RETURNED MDE                        02840000
         BNP   ERRENVIR             BRANCH IF DOESN'T LOOK GOOD         02850000
                                                                        02860000
*                                                                       02870000
* RESTORE LIMITS IF IT WAS AN INITIALIZATION                            02880000
*---------------------------------------------------------------------- 02890000
                                                                        02900000
         TM    MDEF1,MDEF1INI       WERE LIMITS BEING INITIALIZED?      02910000
         BNO   RPABNINI             BRANCH IF NOT                       02920000
         NI    MDEF1,255-MDEF1INI   CLEAR THE FLAG                      02930000
         XC    MDESESSL,MDESESSL    SESSION_LIMIT=0                     02940000
         XC    MDEMINCW,MDEMINCW    MIN_CONWINNERS=0                    02950000
         XC    MDEMINCL,MDEMINCL    MIN_CONLOSERS=0                     02960000
                                                                        02970000
RPABNINI DS    0H                                                       02980000
                                                                        02990000
*                                                                       03000000
* IF IT WAS NOT A RACE SITUATION WE ARE ALL DONE                        03010000
*---------------------------------------------------------------------- 03020000
                                                                        03030000
         CLI   CVARRMOD,CVARRMOD_ABNORMAL_RACE                          03040000
         BNE   RPABCCNI             BRANCH IF NOT...WE ARE ALL DONE     03050000
         LTR   RMDE,RMDE            ALL MODES?                          03060000
         BZ    RPABALDN             BRANCH YES TO CHECK ALL LOCK DENIED 03070000
         TM    MDEF1,MDEF1LDN       WAS THE LOCK DENIED TO PARTNER?     03080000
         BNO   RPABCCNI             BRANCH IF NOT...ALL DONE            03090000
         NI    MDEF1,255-MDEF1LDN   CLEAR THE FLAG                      03100000
         B     RPABNMCM             DO THE NAME COMPARE                 03110000
                                                                        03120000
RPABALDN DS    0H                                                       03130000
                                                                        03140000
         LA    RMDE,IVUMD1ST        GET SET TO RUN THE CHAIN            03150000
         S     RMDE,=A(MDENEXT-MDE) GET SET TO RUN THE CHAIN            03160000
                                                                        03170000
RPABMRUN DS    0H                                                       03180000
                                                                        03190000
         ICM   RMDE,15,MDENEXT      LINK TO THE NEXT MDE                03200000
         BM    RPABERUN             BRANCH IF ALL PROCESSED             03210000
         TM    MDEF1,MDEF1LDN       WAS A LOCK DENIED?                  03220000
         BNO   RPABMRUN             RUN ALL THE MODES                   03230000
         OI    FLAG,FLAGRACE        REMEMBER A RACE WAS DETECTED        03240000
         NI    MDEF1,255-MDEF1LDN   CLEAR THE FLAG                      03250000
         B     RPABMRUN             AND CONTINUE CHECKING               03260000
                                                                        03270000
RPABERUN DS    0H                                                       03280000
                                                                        03290000
         SR    RMDE,RMDE            NO MDE FOR ALL MODES                03300000
         TM    FLAG,FLAGRACE        DID A RACE OCCUR?                   03310000
         BNO   RPABCCNI             BRANCH IF NOT...ALL DONE            03320000
                                                                        03330000
RPABNMCM DS    0H                                                       03340000
                                                                        03350000
X        USING IACB,R1                                                  03360000
         L     R1,IVTACB62          MAIN 6.2 ACB                        03370000
         CLC   X.IACFQNM,IVUFQLN    COMPARE THE NAMES                   03380000
         BNH   RPABCCNI             IF WE'RE LOW...PARTNER HANDLES RACE 03390000
         B     RPABRISS             GO REISSUE REQUEST                  03400000
         DROP  X                                                        03410000
                                                                        03420000
*                                                                       03430000
* REQUEST WAS REJECTED AND THERE WILL BE NO RETRY...                    03440000
* CLEAR THE NEGOTIATION IN PROGRESS INDICATION                          03450000
*---------------------------------------------------------------------- 03460000
                                                                        03470000
RPABCCNI DS    0H                                                       03480000
                                                                        03490000
         LTR   RMDE,RMDE            REQUEST FOR ALL MODES?              03500000
         BZ    RPABCNIA             BRANCH IF YES                       03510000
         NI    MDEF1,255-MDEF1CNI   NO LONGER NEGOTIATING               03520000
         B     RETURN               ALL DONE                            03530000
                                                                        03540000
RPABCNIA DS    0H                                                       03550000
                                                                        03560000
         LA    RMDE,IVUMD1ST        GET SET TO RUN THE CHAIN            03570000
         S     RMDE,=A(MDENEXT-MDE) GET SET TO RUN THE CHAIN            03580000
                                                                        03590000
RPABCNIR DS    0H                                                       03600000
                                                                        03610000
         ICM   RMDE,15,MDENEXT      LINK TO THE NEXT MDE                03620000
         BM    RETURN               ALL DONE                            03630000
         NI    MDEF1,255-MDEF1CNI   CLEAR THE FLAG                      03640000
         B     RPABCNIR             AND CONTINUE CHECKING               03650000
                                                                        03660000
*                                                                       03670000
* REISSUE THE REQUEST THAT WAS REJECTED                                 03680000
*---------------------------------------------------------------------- 03690000
                                                                        03700000
RPABRISS DS    0H                                                       03710000
                                                                        03720000
         CLI   CVARACT,CVARACT_SET                                      03730000
         BNE   RPABRCLO             BRANCH IF NOT...REISSUE CLOSE       03740000
         SR    R1,R1                CLEAR FOR INSERTS                   03750000
         ICM   R1,B'0011',CVARSLIM  GET REQUESTED LIMIT                 03760000
         ST    R1,TEMPLIM           SAVE FOR REISSUE                    03770000
         ICM   R1,B'0011',CVARSWIN  GET REQUESTED WINNERS               03780000
         ST    R1,TEMPWIN           SAVE FOR REISSUE                    03790000
         ICM   R1,B'0011',CVARTWIN  GET REQUESTED LOSERS                03800000
         ST    R1,TEMPLOSE          SAVE FOR REISSUE                    03810000
         ICM   R1,15,MDESESSL       WAS THIS AN INIT?                   03820000
         BZ    RPABRINI             BRANCH IF YES                       03830000
         MVC   TEMPRESP,=CL8'SOURCE'                                    03840000
         CLI   CVARRESP,CVARRESP_TARGET_YES                             03850000
         BNE   *+10                 BRANCH IF NOT TARGET RESPONSIBILITY 03860000
         MVC   TEMPRESP,=CL8'TARGET'                                    03870000
                                                                        03880000
         L62CSL *IVTACB62,        IACB ADDRESS                         +03890000
               IVULOCAL,          PARTNER LUNAME                       +03900000
               MDENAME,           MODE NAME                            +03910000
               TEMPLIM,           SESSION LIMIT                        +03920000
               TEMPWIN,           MINIMUM CONWINNERS                   +03930000
               TEMPLOSE,          MINIMUM CONLOSERS                    +03940000
               TEMPRESP,          RESPONSIBILITY                       +03950000
               L62RETCD,          RETURN CODE AREA                     +03960000
               MF=(E,L62MFL)                                            03970000
                                                                        03980000
         B     RETURN             IGNORE RETURN CODE                    03990000
                                                                        04000000
RPABRINI DS    0H                                                       04010000
                                                                        04020000
         OI    MDEF1,MDEF1INI     SHOW INIT REQUEST                     04030000
         MVC   MDESESSL,TEMPLIM   SET THE LIMIT                         04040000
         MVC   MDEMINCW,TEMPWIN   SET THE WINNERS                       04050000
         MVC   MDEMINCL,TEMPLOSE  SET THE LOSERS                        04060000
                                                                        04070000
         L62ISL *IVTACB62,        IACB ADDRESS                         +04080000
               IVULOCAL,          PARTNER LUNAME                       +04090000
               MDENAME,           MODE NAME                            +04100000
               TEMPLIM,           SESSION LIMIT                        +04110000
               TEMPWIN,           MINIMUM CONWINNERS                   +04120000
               TEMPLOSE,          MINIMUM CONLOSERS                    +04130000
               L62RETCD,          RETURN CODE AREA                     +04140000
               MF=(E,L62MFL)                                            04150000
                                                                        04160000
         B     RETURN             IGNORE RETURN CODE                    04170000
                                                                        04180000
RPABRCLO DS    0H                                                       04190000
                                                                        04200000
         MVC   TEMPRESP,=CL8'SOURCE'                                    04210000
         CLI   CVARRESP,CVARRESP_TARGET_YES                             04220000
         BNE   *+10                 BRANCH IF NOT TARGET RESPONSIBILITY 04230000
         MVC   TEMPRESP,=CL8'TARGET'                                    04240000
                                                                        04250000
         MVC   TEMPDRS,=CL4'NO'                                         04260000
         TM    CVARDIMM,CVARDIMM_SOURCE_YES                             04270000
         BNO   *+10                 BRANCH IF NOT DRAIN SOURCE YES      04280000
         MVC   TEMPDRS,=CL4'YES'                                        04290000
                                                                        04300000
         MVC   TEMPDRT,=CL4'NO'                                         04310000
         TM    CVARDIMM,CVARDIMM_TARGET_YES                             04320000
         BNO   *+10                 BRANCH IF NOT DRAIN TARGET YES      04330000
         MVC   TEMPDRT,=CL4'YES'                                        04340000
                                                                        04350000
         LTR   RMDE,RMDE            ALL MODES?                          04360000
         BZ    RPABRCLA             BRANCH IF YES                       04370000
                                                                        04380000
         L62RSL  *IVTACB62,                                            +04390000
               IVULOCAL,                                               +04400000
               MDENAME,                                                +04410000
               TEMPRESP,                                               +04420000
               TEMPDRS,                                                +04430000
               TEMPDRT,                                                +04440000
               =C'SINGLE',                                             +04450000
               L62RETCD,                                               +04460000
               MF=(E,L62MFL)                                            04470000
                                                                        04480000
         B     RETURN                                                   04490000
                                                                        04500000
RPABRCLA DS    0H                                                       04510000
                                                                        04520000
         L62RSL  *IVTACB62,                                            +04530000
               IVULOCAL,                                               +04540000
               =CL8' ',                                                +04550000
               TEMPRESP,                                               +04560000
               TEMPDRS,                                                +04570000
               TEMPDRT,                                                +04580000
               =C'ALL',                                                +04590000
               L62RETCD,                                               +04600000
               MF=(E,L62MFL)                                            04610000
                                                                        04620000
         B     RETURN                                                   04630000
                                                                        04640000
*---------------------------------------------------------------------- 04650000
* PROCESS A SET REQUEST - SINGLE MODE                                   04660000
*---------------------------------------------------------------------- 04670000
                                                                        04680000
RQS1     DS    0H                                                       04690000
                                                                        04700000
         CLI   CVARACT,CVARACT_SET                                      04710000
         BNE   RQC1                 BRANCH IF NOT A SET REQUEST         04720000
         BAS   R14,DISPMODE         LOCATE THE MDE                      04730000
         OC    L62RETCD,L62RETCD    GOOD RETURN CODE?                   04740000
         BNZ   ERRENVIR             BRANCH IF NOT...MDE SHOULD BE THERE 04750000
         ICM   RMDE,15,L62RETMD     RETURNED MDE                        04760000
         BNP   ERRENVIR             BRANCH IF DOESN'T LOOK GOOD         04770000
         TM    MDEF1,MDEF1CNI       IS CNOS NEGOTIATION UNDERWAY?       04780000
         BNO   ERRENVIR             BRANCH IF NOT...IT SHOULD BE        04790000
         NI    MDEF1,255-MDEF1CNI   CLEAR THE NEGOTIATION FLAG          04800000
                                                                        04810000
         L     R2,MDESESSL          CURRENT SESSION LIMIT               04820000
         SR    R1,R1                CLEAR FOR INSERTS                   04830000
         ICM   R1,B'0011',CVARSLIM  THE SESSION LIMIT                   04840000
         ST    R1,MDESESSL          SET THE SESSION LIMIT               04850000
         SR    R1,R2                DELTA SESSION LIMIT                 04860000
         ST    R1,DELTA             SAVE THE DELTA                      04870000
         SR    R1,R1                CLEAR FOR INSERTS                   04880000
         ICM   R1,B'0011',CVARSWIN  THE SOURCE CON WINNER COUNT         04890000
         ST    R1,MDEMINCL          SET THE SOURCE CONWIN COUNT         04900000
         ICM   R1,B'0011',CVARTWIN  THE TARGET CON WINNER COUNT         04910000
         ST    R1,MDEMINCW          SET THE TARGET CONWIN COUNT         04920000
                                                                        04930000
         CLI   CVARRESP,CVARRESP_TARGET_YES                             04940000
         BNE   RQS1NRSP             BRANCH IF WE ARE NOT RESPONSIBLE    04950000
         BAS   R14,TERMPROC         GO START TERMINATION IF APPROPRIATE 04960000
                                                                        04970000
RQS1NRSP DS    0H                                                       04980000
                                                                        04990000
         BAS   R14,ACTNEEDD         GO SEE IF WE CAN ACTIVATE NEEDED    05000000
         B     RETURN                                                   05010000
                                                                        05020000
*---------------------------------------------------------------------- 05030000
* PROCESS A CLOSE REQUEST - SINGLE MODE                                 05040000
*---------------------------------------------------------------------- 05050000
                                                                        05060000
RQC1     DS    0H                                                       05070000
                                                                        05080000
         CLI   CVARACT,CVARACT_CLOSE                                    05090000
         BNE   ERRENVIR             BRANCH IF NOT A CLOSE REQUEST       05100000
                                                                        05110000
         CLI   CVARMSEL,CVARMSEL_ALL                                    05120000
         BE    RQCA                 BRANCH IF CLOSE "ALL" REQUEST       05130000
         BAS   R14,DISPMODE         LOCATE THE MDE                      05140000
         OC    L62RETCD,L62RETCD    GOOD RETURN CODE?                   05150000
         BNZ   ERRENVIR             BRANCH IF NOT...MDE SHOULD BE THERE 05160000
         ICM   RMDE,15,L62RETMD     RETURNED MDE                        05170000
         BNP   ERRENVIR             BRANCH IF DOESN'T LOOK GOOD         05180000
         TM    MDEF1,MDEF1CNI       IS CNOS NEGOTIATION UNDERWAY?       05190000
         BNO   ERRENVIR             BRANCH IF NOT...IT SHOULD BE        05200000
         NI    MDEF1,255-MDEF1CNI   CLEAR THE NEGOTIATION FLAG          05210000
         L     R2,MDESESSL          CURRENT SESSION LIMIT               05220000
         SR    R1,R1                CLEAR                               05230000
         ST    R1,MDESESSL          SESSLIM = 0                         05240000
         ST    R1,MDEMINCW          MIN_CONWINNERS_SOURCE = 0           05250000
         ST    R1,MDEMINCL          MIN_CONWINNERS_TARGET = 0           05260000
         SR    R1,R2                SESSION DELTA                       05270000
         ST    R1,DELTA             SAVE THE DELTA                      05280000
         TM    CVARDIMM,CVARDIMM_TARGET_YES                             05290000
         BNO   RQC1STOP             BRANCH IF NOT ALLOWED TO DRAIN      05300000
         OI    MDEF1,MDEF1DRS       SHOW THAT TP'S ARE DRAINING         05310000
         B     RQC1RESP             AND CONTINUE                        05320000
                                                                        05330000
RQC1STOP DS    0H                                                       05340000
                                                                        05350000
         OI    MDEF1,MDEF1STO       SHOW THAT TP'S ARE STOPPED          05360000
                                                                        05370000
RQC1RESP DS    0H                                                       05380000
                                                                        05390000
         CLI   CVARRESP,CVARRESP_TARGET_YES                             05400000
         BNE   RETURN               EXIT IF PARTNER IS RESPONSIBLE      05410000
         BAS   R14,TERMPROC         GO START TERMINATION IF APPROPRIATE 05420000
         B     RETURN                                                   05430000
                                                                        05440000
*---------------------------------------------------------------------- 05450000
* PROCESS A CLOSE REQUEST - ALL MODES                                   05460000
*---------------------------------------------------------------------- 05470000
                                                                        05480000
RQCA     DS    0H                                                       05490000
                                                                        05500000
         OI    IVUF1,IVUF1CAM       CLOSE ALL MODES IN PROGRESS         05510000
         LA    RMDE,IVUMD1ST        GET SET TO RUN THE CHAIN            05520000
         S     RMDE,=A(MDENEXT-MDE) GET SET TO RUN THE CHAIN            05530000
                                                                        05540000
RQCARUN  DS    0H                                                       05550000
                                                                        05560000
         ICM   RMDE,15,MDENEXT      LINK TO THE NEXT MDE                05570000
         BM    RETURN               BRANCH IF ALL PROCESSED             05580000
                                                                        05590000
*                                                                       05600000
* PROCESS THE NEXT MODE IN THE LIST                                     05610000
*---------------------------------------------------------------------- 05620000
                                                                        05630000
         TM    MDEF1,MDEF1CNI       IS CNOS NEGOTIATION UNDERWAY?       05640000
         BNO   ERRENVIR             BRANCH IF NOT...SHOULD BE           05650000
         NI    MDEF1,255-MDEF1CNI   CLEAR THE NEGOTIATION FLAG          05660000
         NI    MDEF1,255-MDEF1LDN   CLEAR POSSIBLE RACE FLAG            05670000
         CLC   MDENAME,=CL8'SNASVCMG'                                   05680000
         BE    RQCARUN              DON'T DO THIS MODE                  05690000
         L     R2,MDESESSL          CURRENT SESSION LIMIT               05700000
         SR    R1,R1                CLEAR                               05710000
         ST    R1,MDESESSL          SESSLIM = 0                         05720000
         ST    R1,MDEMINCW          MIN_CONWINNERS_SOURCE = 0           05730000
         ST    R1,MDEMINCL          MIN_CONWINNERS_TARGET = 0           05740000
         SR    R1,R2                SESSION DELTA                       05750000
         ST    R1,DELTA             SAVE THE DELTA                      05760000
         TM    CVARDIMM,CVARDIMM_TARGET_YES                             05770000
         BNO   RQCASTOP             BRANCH IF NOT ALLOWED TO DRAIN      05780000
         OI    MDEF1,MDEF1DRS       SHOW THAT TP'S ARE DRAINING         05790000
         B     RQCARESP             AND CONTINUE                        05800000
                                                                        05810000
RQCASTOP DS    0H                                                       05820000
                                                                        05830000
         OI    MDEF1,MDEF1STO       SHOW THAT TP'S ARE STOPPED          05840000
                                                                        05850000
RQCARESP DS    0H                                                       05860000
                                                                        05870000
         CLI   CVARRESP,CVARRESP_TARGET_YES                             05880000
         BNE   RQCARUN              GET NEXT MODE IF PARTNER RESP.      05890000
         BAS   R14,TERMPROC         GO START TERMINATION IF APPROPRIATE 05900000
         B     RQCARUN              GET NEXT MODE                       05910000
                                                                        05920000
*---------------------------------------------------------------------- 05930000
* RETURN TO CALLER                                                      05940000
*---------------------------------------------------------------------- 05950000
                                                                        05960000
RETURN   DS    0H                                                       05970000
                                                                        05980000
         BAS   R14,VTAMUNLK         SERIALIZE                           05990000
         LM    R15,R1,RETREGS       LOAD RETURN REGISTERS               06000000
                                                                        06010000
         #EXIT R1=YES               RETURN W/R15,R0,R1                  06020000
                                                                        06030000
*---------------------------------------------------------------------- 06040000
* SUBROUTINE ACTNEEDD - ACTIVATE NEEDED SESSIONS                        06050000
*                                                                       06060000
* ENTRY            RMDE = MDE ADDRESS                                   06070000
*                                                                       06080000
* RETURNS          ALL REGISTERS ARE RESTORED                           06090000
*---------------------------------------------------------------------- 06100000
                                                                        06110000
ACTNEEDD DS    0H                                                       06120000
                                                                        06130000
         STM   R14,R12,SUB0SAVE     SAVE REGISTERS                      06140000
                                                                        06150000
         LA    RAQE,MDEWR1ST        HEAD OF WAITING-REQUESTS QUEUE      06160000
         S     RAQE,=A(AQENEXT-AQE) NORMALIZE                           06170000
                                                                        06180000
ACTNRUN  DS    0H                                                       06190000
                                                                        06200000
         ICM   RAQE,15,AQENEXT      LINK TO NEXT WAITING REQUEST        06210000
         BM    ACTNEXIT             BRANCH IF ALL DONE                  06220000
         TM    AQEF1,AQEF1SRQ+AQEF1SRA SESS REQ ALREADY UNDERWAY?       06230000
         BNZ   ACTNRUN              SKIP THIS AQE IF SO                 06240000
         LR    R1,RAQE              PASS AQE IN R1                      06250000
         L     R15,IL6@USTS         START SESSION ROUTINE               06260000
         BASR  R14,R15              TRY TO START ONE                    06270000
         B     ACTNRUN              AND CONTINUE                        06280000
                                                                        06290000
ACTNEXIT DS    0H                                                       06300000
                                                                        06310000
         LM    R14,R12,SUB0SAVE     RESTORE REGISTERS                   06320000
         BR    R14                  AND RETURN TO CALLER W/R15          06330000
                                                                        06340000
*---------------------------------------------------------------------- 06350000
* SUBROUTINE TERMPROC - DETERMINE THE MODE TERMINATION COUNT            06360000
*                                                                       06370000
* ENTRY            DELTA   = SESSION LIMIT CHANGE                       06380000
*                  RMDE    = ASSOCIATED MDE                             06390000
*                                                                       06400000
* RETURNS          ALL REGISTERS ARE RESTORED                           06410000
*                  MDETERMC IS UPDATED WITH THE NEW TERMINATION COUNT   06420000
*---------------------------------------------------------------------- 06430000
                                                                        06440000
TERMPROC DS    0H                                                       06450000
                                                                        06460000
         STM   R14,R12,SUB0SAVE      SAVE REGISTERS                     06470000
                                                                        06480000
         L     R1,MDEACWC            ACTIVE CONWINNERS                  06490000
         A     R1,MDEPCWC            + PENDING CONWINNERS               06500000
         ST    R1,CONWIN#            SET CONWINNER_COUNT                06510000
                                                                        06520000
         L     R1,MDEACLC            ACTIVE CONLOSERS                   06530000
         A     R1,MDEPCLC            + PENDING CONLOSERS                06540000
         ST    R1,CONLOS#            SET CONLOSER_COUNT                 06550000
                                                                        06560000
         L     R1,MDESESSL           NEW SESSION LIMIT                  06570000
         S     R1,DELTA              OLD SESSION LIMIT                  06580000
         ST    R1,OLDLIMIT           SET OLD_SESSION_LIMIT              06590000
                                                                        06600000
         ST    R1,PLATEAU            PLATEAU = OLD_SESSION_LIMIT        06610000
         L     R1,MDEASC             ACTIVE SESSIONS                    06620000
         A     R1,MDEPSC             + PENDING SESSIONS                 06630000
         C     R1,PLATEAU            FEWER SESSIONS THAN OLD LIMIT?     06640000
         BNL   *+8                   BRANCH IF NOT                      06650000
         ST    R1,PLATEAU            PLATEAU = NUMBER OF SESSIONS       06660000
                                                                        06670000
         XC    CONWININ,CONWININ     SET CONWINNER_INCREMENT TO 0       06680000
         L     R1,MDEMINCW           MINIMUM CONWINNERS                 06690000
         S     R1,CONWIN#            - CURRENT # OF WINNERS             06700000
         BM    *+8                   BRANCH IF NO POSSIBLE INCREMENT    06710000
         ST    R1,CONWININ           SET CONWINNER_INCREMENT            06720000
                                                                        06730000
         XC    CONLOSIN,CONLOSIN     SET CONLOSER_INCREMENT TO 0        06740000
         L     R1,MDEMINCL           MINIMUM CONLOSERS                  06750000
         S     R1,CONLOS#            - CURRENT # OF LOSERS              06760000
         BM    *+8                   BRANCH IF NO POSSIBLE INCREMENT    06770000
         ST    R1,CONLOSIN           SET CONLOSER_INCREMENT             06780000
                                                                        06790000
         XC    SESSDECR,SESSDECR     SET SESSION_DECREMENT TO 0         06800000
         L     R1,PLATEAU            STARTING PLATEAU                   06810000
         S     R1,MDESESSL           - CURRENT SESSION LIMIT            06820000
         BM    *+8                   BRANCH IF WE ARE NOT OVER LIMIT    06830000
         ST    R1,SESSDECR           SET SESSION_DECREMENT              06840000
                                                                        06850000
         L     R1,CONWININ           CONWINNERS_INCREMENT               06860000
         A     R1,CONLOSIN           + CONLOSERS_INCREMENT              06870000
         ST    R1,NEEDTOAC           SET NEED_TO_ACTIVATE               06880000
                                                                        06890000
         XC    ROOMTOAC,ROOMTOAC     SET ROOM_TO_ACTIVATE TO 0          06900000
         L     R1,MDESESSL           CURRENT SESSION LIMIT              06910000
         S     R1,PLATEAU            - STARTING PLATEAU                 06920000
         BM    *+8                   BRANCH IF NONE CAN BE STARTED      06930000
         ST    R1,ROOMTOAC           SET ROOM_TO_ACTIVATE               06940000
                                                                        06950000
         XC    DECFORPL,DECFORPL     SET DECREMENT_FOR_POLARITY TO 0    06960000
         L     R1,NEEDTOAC           NEED_TO_ACTIVATE                   06970000
         S     R1,ROOMTOAC           - ROOM_TO_ACTIVATE                 06980000
         BM    *+8                   BRANCH IF NONE SHOULD BE KILLED    06990000
         ST    R1,DECFORPL           SET DECREMENT_FOR_POLARITY         07000000
                                                                        07010000
         L     R1,MDETERMC           CURRENT TERMINATION COUNT          07020000
         A     R1,SESSDECR           + THE NUMBER THAT SHOULD BE KILLED 07030000
         A     R1,DECFORPL           + THE NUMBER OF POLARITY SWITCHES  07040000
         ST    R1,MDETERMC           SET THE NEW TERMINATION COUNT      07050000
         BM    ERRENVIR              BRANCH IF BAD RESULT               07060000
         BNP   SETTRET               BRANCH IF NONE TO TERMINATE        07070000
         LR    R1,RMDE               PASS THE MDE IN R1                 07080000
         L     R15,IL6@UDFS          ROUTINE TO DEACTIVATE FREE SESS'S  07090000
         BASR  R14,R15               LINK TO ROUTINE                    07100000
                                                                        07110000
SETTRET  DS    0H                                                       07120000
                                                                        07130000
         LM    R14,R12,SUB0SAVE      RESTORE REGISTERS                  07140000
         BR    R14                   AND RETURN TO CALLER W/R15         07150000
                                                                        07160000
*---------------------------------------------------------------------- 07170000
* SUBROUTINE DISPMODE - LOCATES THE MDE FOR A GIVEN MODENAME            07180000
*                                                                       07190000
* ENTRY            R14     = RETURN ADDRESS                             07200000
*                  RIVUSER = IVUSER ADDRESS                             07210000
*                  RIWE    = IWECSLIM WORK ELEMENT ADDRESS              07220000
*                                                                       07230000
* RETURNS          ALL REGISTERS ARE RESTORED                           07240000
*                  L62RETCD = RETURN CODE FROM DISPLAY OPERATION        07250000
*                  L62RETMD = MDE ADDRESS FOR SUCCESSFUL DISPLAY        07260000
*---------------------------------------------------------------------- 07270000
                                                                        07280000
DISPMODE DS    0H                                                       07290000
                                                                        07300000
         STM   R14,R12,SUB0SAVE      SAVE REGISTERS                     07310000
                                                                        07320000
         L62DSMD (RIVUSER),          @PARTNERLU                        +07330000
               IWEY7NME,             @MODENAME                         +07340000
               =F'8',                @MODENAME_LENGTH                  +07350000
               L62RETMD,             @MDE RETURN AREA                  +07360000
               L62RETCD,             @RETURN CODE AREA                 +07370000
               MF=(E,L62MFL)                                            07380000
                                                                        07390000
         LM    R14,R12,SUB0SAVE      RESTORE REGISTERS                  07400000
         BR    R14                   AND RETURN TO CALLER W/R15         07410000
                                                                        07420000
*---------------------------------------------------------------------- 07430000
* SUBROUTINE QWE - QUEUE A WORK ELEMENT TO A GIVEN WORK QUEUE           07440000
*                                                                       07450000
* ENTRY            R14 = RETURN ADDRESS                                 07460000
*                  R1  = WORK ELEMENT ADDRESS                           07470000
*                  R0  = QUEUE ADDRESS                                  07480000
*                                                                       07490000
* RETURNS          R15 = 0 --> QUEUEING WAS SUCCESSFUL                  07500000
*                      = 4 --> QUEUEING FAILED, WORK ELEMENT RELEASED   07510000
*---------------------------------------------------------------------- 07520000
                                                                        07530000
QWE      DS    0H                                                       07540000
                                                                        07550000
         STM   R14,R4,SUB0SAVE      SAVE REGISTERS                      07560000
         LR    R3,R0                SAVE QUEUE ADDRESS                  07570000
         LR    R4,R1                SAVE WORK ELEMENT ADDRESS           07580000
                                                                        07590000
         $VTAMQ (R4),               WORK ELEMENT                       +07600000
               (R3)                 QUEUE                               07610000
                                                                        07620000
         L     R14,SUB0SAVE         RESTORE REGISTERS                   07630000
         LM    R0,R4,SUB0SAVE+8     RESTORE REGISTERS                   07640000
         BR    R14                  AND RETURN TO CALLER W/R15          07650000
                                                                        07660000
*---------------------------------------------------------------------- 07670000
*   SUBROUTINE: POST THE REQUEST (R0 CONTAINS POSTCODE)                 07680000
*---------------------------------------------------------------------- 07690000
                                                                        07700000
POSTREQ  DS    0H                                                       07710000
                                                                        07720000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             07730000
                                                                        07740000
         L62POST *AQEEPB,           @EPB TO BE POSTED                  +07750000
               SUB0SAVE+8,          @POSTCODE                          +07760000
               AQEENT,              @ENTITY TOKEN                      +07770000
               L62RETCD,            @RETURN CODE ARAE                  +07780000
               MF=(E,L62MFL)                                            07790000
                                                                        07800000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          07810000
         BR    R14                  RETURN                              07820000
                                                                        07830000
*---------------------------------------------------------------------- 07840000
*   SUBROUTINE: FREE THE AQE                                            07850000
*---------------------------------------------------------------------- 07860000
                                                                        07870000
FREEAQE  DS    0H                                                       07880000
                                                                        07890000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             07900000
                                                                        07910000
         $RETSTOR (RAQE),                                              +07920000
               OWNER=(RITASK)                                           07930000
                                                                        07940000
         SR    RAQE,RAQE            SHOW NO AQE                         07950000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          07960000
         BR    R14                  RETURN                              07970000
                                                                        07980000
*---------------------------------------------------------------------- 07990000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 08000000
*---------------------------------------------------------------------- 08010000
                                                                        08020000
VTAMLOCK DS    0H                                                       08030000
                                                                        08040000
         TM    FLAG,FLAGLOCK        WAS THE LOCK ALREADY OBTAINED?      08050000
         BOR   R14                  RETURN IF YES                       08060000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             08070000
                                                                        08080000
         $SER  OBTAIN,                                                 +08090000
               VTAM                                                     08100000
                                                                        08110000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              08120000
         BNE   VTAMLOEX             BRANCH IF NOT                       08130000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         08140000
                                                                        08150000
VTAMLOEX DS    0H                                                       08160000
                                                                        08170000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               08180000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          08190000
         BR    R14                  RETURN                              08200000
                                                                        08210000
*---------------------------------------------------------------------- 08220000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                08230000
*---------------------------------------------------------------------- 08240000
                                                                        08250000
VTAMUNLK DS    0H                                                       08260000
                                                                        08270000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       08280000
         BNOR  R14                  BRANCH IF NOT                       08290000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             08300000
         BOR   R14                  DON'T RELEASE IF IT WAS             08310000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             08320000
                                                                        08330000
         $SER  RELEASE,                                                +08340000
               VTAM                                                     08350000
                                                                        08360000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  08370000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          08380000
         BR    R14                  RETURN                              08390000
                                                                        08400000
*---------------------------------------------------------------------- 08410000
*   SUBROUTINE: OBTAIN DISP GLOBAL LOCK                                 08420000
*---------------------------------------------------------------------- 08430000
                                                                        08440000
DISPLOCK DS    0H                                                       08450000
                                                                        08460000
         TM    FLAG,FLAGDLCK        WAS THE LOCK ALREADY OBTAINED?      08470000
         BOR   R14                  RETURN IF YES                       08480000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             08490000
                                                                        08500000
         $SER  OBTAIN,                                                 +08510000
               DISP                                                     08520000
                                                                        08530000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              08540000
         BNE   DISPLOEX             BRANCH IF NOT                       08550000
         OI    FLAG,FLAGDLKD        REMEMBER LOCK HELD ON ENTRY         08560000
                                                                        08570000
DISPLOEX DS    0H                                                       08580000
                                                                        08590000
         OI    FLAG,FLAGDLCK        REMEMBER LOCK IS HELD               08600000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          08610000
         BR    R14                  RETURN                              08620000
                                                                        08630000
*---------------------------------------------------------------------- 08640000
*   SUBROUTINE: RELEASE DISP GLOBAL LOCK                                08650000
*---------------------------------------------------------------------- 08660000
                                                                        08670000
DISPUNLK DS    0H                                                       08680000
                                                                        08690000
         TM    FLAG,FLAGDLCK        IS LOCK HELD?                       08700000
         BNOR  R14                  BRANCH IF NOT                       08710000
         TM    FLAG,FLAGDLKD        WAS LOCK HELD ON ENTRY?             08720000
         BOR   R14                  DON'T RELEASE IF IT WAS             08730000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             08740000
                                                                        08750000
         $SER  RELEASE,                                                +08760000
               DISP                                                     08770000
                                                                        08780000
         NI    FLAG,255-FLAGDLCK    SHOW LOCK NOT HELD                  08790000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          08800000
         BR    R14                  RETURN                              08810000
                                                                        08820000
*---------------------------------------------------------------------- 08830000
* ERROR ROUTINES                                                        08840000
*---------------------------------------------------------------------- 08850000
                                                                        08860000
ERRENVIR DS    0H                                                       08870000
                                                                        08880000
         $ABEND ABE_VTDIAG,                                            +08890000
               SCOPE=PCB,                                              +08900000
               TITLE='ENVIRONMENT ERROR'                                08910000
                                                                        08920000
*---------------------------------------------------------------------- 08930000
*  CONSTANTS AND LITERALS                                               08940000
*---------------------------------------------------------------------- 08950000
                                                                        08960000
         LTORG ,                                                        08970000
         PRINT NOGEN                                                    08980000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                08990000
         ISTDBIND ,               VTAM BIND IMAGE                       09000000
         TRACODES ,               INTEGRATOR TRACE CODES                09010000
         ICVT  ,                  INTEGRATOR CVT                        09020000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   09030000
         IRPL ,                   INTEGRATOR VTAM RPL+                  09040000
         IACB ,                   INTEGRATOR VTAM ACB+                  09050000
         INIB ,                   INTEGRATOR VTAM NIB+                  09060000
         ISESS ,                  INTEGRATOR SESSION BLOCK              09070000
         IRQE ,                   INTEGRATOR RECEIVE QUEUE ELEMENT      09080000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            09090000
         ITASK ,                  INTEGRATOR TASK BLOCK                 09100000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          09110000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       09120000
         EVCODES ,                INTEGRATOR EVENT CODES                09130000
         ABCODES ,                INTEGRATOR $ABEND CODES               09140000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     09150000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        09160000
         END   ,                                                        09170000

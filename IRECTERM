IRECTERM TITLE '- SESSION RECORDING TERMINATION AND CLEANUP'            00010000
***************************************************************         00020000
*                                                                       00030000
* ROUTINE: IRECTERM - SESSION RECORDING TERMINATION & CLEANUP           00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THIS ROUTINE PERFORMS NORMAL AND ABNORMAL SESSION RECORDING        00080000
*    TERMINATION AND CLEANUP.  THE RECORDING TEMPORARY (AUX)            00090000
*    TABLE ANCHORED IN THE SESSIMAG IS DELETED AND ALL RELATED          00100000
*    CONTROL INFORMATION IS RESET.                                      00110000
*                                                                       00120000
*    IF THE TERMINATION IS DUE TO ERROR (ABNORMAL), THE                 00130000
*    SYSRECORDINGS CATALOG ENTRY CREATED WHEN THE RECORDING WAS         00140000
*    BEGUN IS DELETED.                                                  00150000
*                                                                       00160000
*                                                                       00170000
* ON ENTRY:                                                             00180000
*                                                                       00190000
*    R0  CONTAINS A CODE DETERMINING WHETHER THE RECORDING IS           00200000
*        TERMINATING DUE TO ERROR OR AS NORMAL SAVE & END               00210000
*        PROCESSING AS FOLLOW:                                          00220000
*                                                                       00230000
*             00 - NORMAL SAVE & END                                    00240000
*             /0 - RECORDING TERMINATION                                00250000
*                                                                       00260000
*    R1  CONTAINS THE ADDRESS OF THE SESSIMAG DEFINING THE              00270000
*        CURRENT SESSION                                                00280000
*                                                                       00290000
*                                                                       00300000
* ON EXIT:                                                              00310000
*                                                                       00320000
*    R15 CONTAINS ZERO                                                  00330000
*                                                                       00340000
***************************************************************         00350000
                                                                        00360000
         EJECT                                                          00370000
***************************************************************         00380000
*                                                                       00390000
* MAINTENANCE:                                                          00400000
*                                                                       00410000
*   12/06/94 R. Turgeon                                                 00420000
*            Removed PAGE= / SHRPAGE= for $SPACE, $OBJECT,              00430000
*            and TB* service requests                                   00440000
*                                                                       00450000
***************************************************************         00460000
                                                                        00470000
         EJECT ,                                                        00480000
         #WORK ,                                                        00490000
                                                                        00500000
$SYSREC  DS    0D,XL(SRECLN)      SYSRECORDINGS ROW CONSTRUCTION AREA   00510000
$SYSRECL EQU   *-$SYSREC                                                00520000
                                                                        00530000
WK256    DS    0D,XL256           GENERAL PURPOSE WORKAREA              00540000
                                                                        00550000
         #ENDWORK ,                                                     00560000
                                                                        00570000
         EJECT                                                          00580000
         ICATALOG RECORDING       CATALOG ACCESS                        00590000
                                                                        00600000
         EJECT                                                          00610000
         IPROJ ,                  PROJECT CONTROL BLOCK                 00620000
                                                                        00630000
         EJECT                                                          00640000
         SESSIMAG ,               EMULATOR SESS / RECORDING AREA        00650000
                                                                        00660000
         EJECT                                                          00670000
         ABCODES ,                                                      00680000
         EQUS  ,                                                        00690000
                                                                        00700000
         TBSERVIS DROP,DELETE,PRINT=NOGEN                               00710000
                                                                        00720000
         EJECT                                                          00730000
IRECTERM #ENTER PREG=(R8,R6)      SESSIMAG, TERMINATION TYPE CODE       00740000
                                                                        00750000
         USING ICVT,R11           STDENV                                00760000
         USING ITASK,R10                                                00770000
         USING IPCB,R9            PROCESS MODE                          00780000
         L     R9,TSKPCBC                                               00790000
                                                                        00800000
         EJECT ,                                                        00810000
*--------------------------------------------------------------         00820000
*   ACCEPT PASSED PARAMETERS, LOCATE ASSOCIATED DATA AREAS              00830000
*--------------------------------------------------------------         00840000
         USING SESSIMAG,R8        LIFE OF FUNCTION                      00850000
         L     R7,SEIIPROJ        LOCATE PROJECT                        00860000
         USING IPROJ,R7           MAP                                   00870000
                                                                        00880000
*--------------------------------------------------------------         00890000
*   RELEASE SESSIMAG RESOURCES MANAGED BY RECORDING COMPONENT           00900000
*--------------------------------------------------------------         00910000
         ICM   R2,15,SEISKSA      SYSSKS ROW BUFFER ALLOCATED?          00920000
         BZ    NOSKSROW           SKIP IF NOT                           00930000
         LA    R0,SEISKSRS        LOCATE DEDICATED SKS WORKAREA         00940000
         CR    R2,R0              AUX STORAGE USED?                     00950000
         BE    NOSKSROW           SKIP IF NOT                           00960000
                                                                        00970000
         $RETSTOR (R2)            RELEASE ASSOCIATED STORAGE            00980000
                                                                        00990000
NOSKSROW DS    0H                                                       01000000
         XC    SEISKSA,SEISKSA    SKS NO LONGER PENDING                 01010000
                                                                        01020000
*--------------------------------------------------------------         01030000
*   DROP THE RECORDING TEMPORARY (AUX) TABLE                            01040000
*--------------------------------------------------------------         01050000
         ICM   R0,15,SEIAUXTK     TABLE CREATED?                        01060000
         BZ    NOAUX              SKIP IF NOT                           01070000
                                                                        01080000
         TBDROP TTOKEN=SEIAUXTK,  DROP AUX TABLE                       X01090000
               MF=(E,MFE_LIST)                                          01100000
                                                                        01110000
         LTR   R15,R15            TEST COMPLETION STATUS                01120000
         BNZ   ABN_TBSV                                                 01130000
                                                                        01140000
         XC    SEIAUXTK,SEIAUXTK  RESET TABLE TOKEN                     01150000
         XC    SEIAUX#,SEIAUX#    RESET AUX ROW COUNT                   01160000
                                                                        01170000
NOAUX    DS    0H                                                       01180000
                                                                        01190000
*--------------------------------------------------------------         01200000
*   DELETE SYSRECORDING ROW IF RECORDING NOT COMPLETED & SAVED          01210000
*--------------------------------------------------------------         01220000
         LTR   R6,R6              RECORDING COMPLETED NORMALLY?         01230000
         BZ    CLEAREC            DONE IF SO                            01240000
                                                                        01250000
         LA    R5,$SYSREC         SYSRECORDINGS ROW BUFFER              01260000
         USING SRECSECT,R5        MAPPED                                01270000
         MVC   SRECNAME,SEIRECNM  RECORDING NAME IS TABLE KEY           01280000
                                                                        01290000
         TBDELETE KEYROW=$SYSREC, DELETE RECORDING ENTRY               X01300000
               INDEX='RECNAME',   LOCATE USING THIS INDEX              X01310000
               TTOKEN=PRJTKREC,                                        X01320000
               MF=(E,WK256)                                             01330000
                                                                        01340000
         LTR   R15,R15            TEST COMPLETION STATUS                01350000
         BNZ   ABN_TBSV                                                 01360000
         DROP  R5                 SRECSECT                              01370000
                                                                        01380000
CLEAREC  DS    0H                                                       01390000
         XC    SEIRECNM,SEIRECNM  CLEAR RECORDING NAME                  01400000
         NI    SEIRECFL,SEIR_EMU  RESET RECORDING STATUS                01410000
                                                                        01420000
*--------------------------------------------------------------         01430000
*   RETURN COMPLETION STATUS TO REQUESTOR                               01440000
*--------------------------------------------------------------         01450000
         LA    R15,RC00           NORMAL COMPLETION                     01460000
         #EXIT ,                                                        01470000
                                                                        01480000
         EJECT                                                          01490000
***************************************************************         01500000
*                                                                       01510000
*   CATASTROPHIC FAILURES                                               01520000
*                                                                       01530000
***************************************************************         01540000
ABN_TBSV DS    0H                 CATALOG / TABLE SERVICE FAILURE       01550000
                                                                        01560000
         $ABEND ABE_TBSERV,DUMP=YES,                                   X01570000
               TITLE='TABLE SERVICE FAILURE'                            01580000
                                                                        01590000
         EJECT                                                          01600000
***************************************************************         01610000
*                                                                       01620000
*   LOCAL READ-ONLY DATA AREAS                                          01630000
*                                                                       01640000
***************************************************************         01650000
         LTORG ,                                                        01660000
                                                                        01670000
         EJECT                                                          01680000
         PRINT NOGEN                                                    01690000
         ICVT  ,                                                        01700000
         ITASK ,                                                        01710000
         IPCB  ,                                                        01720000
         END   ,                                                        01730000

IVTMXRCV TITLE 'INTEGRATOR - VTAM EXIT ESTAE/FRR RECOVERY ROUTINE'      00010000
**<DOC-ON>************************************************************* 00020000
*                                                                       00030000
* ROUTINE: IVTMXRCV - INTEGRATOR VTAM EXIT ESTAE/FRR RECOVERY ROUTINE   00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    THIS ROUTINE RECEIVES CONTROL WHEN A VTAM EXIT ROUTINE ABENDS.     00080000
*    IT SETS UP THE RETRY REGISTERS SO THE ROUTINE CAN SAFELY EXIT.     00090000
*                                                                       00100000
* ON ENTRY:                                                             00110000
*                                                                       00120000
*    FRR:                                                               00130000
*                                                                       00140000
*    R15 = ENTRY POINT ADDRESS                                          00150000
*    R14 = RETURN ADDRESS                                               00160000
*    R02 = ADDRESS OF 24-BYTE SETFRR-PROVIDED PARM AREA                 00170000
*          +00 (8) --> CL8'FRR     '                                    00180000
*          +08 (4) --> ADDRESS OF IVTAMRPA                              00190000
*    R01 = SDWA ADDRESS                                                 00200000
*    R00 = ADDRESS OF A 304-BYTE WORK AREA                              00210000
*                                                                       00220000
*    ESTAEX ROUTINE WITH AN SDWA:                                       00230000
*                                                                       00240000
*    R15 = ENTRY POINT ADDRESS                                          00250000
*    R14 = RETURN ADDRESS                                               00260000
*    R13 = 72-BYTE SAVE AREA                                            00270000
*    R02 = ADDRESS OF IVTAMRPA                                          00280000
*          +00 (8) --> CL8'ESTAEX  '                                    00290000
*          +08 (4) --> ADDRESS OF IVTAMRPA                              00300000
*          +0C (...) --> REMAINDER OF IVTAMRPA                          00310000
*    R01 = SDWA ADDRESS                                                 00320000
*    R00 = 16 OR 8 OR 4 OR 0                                            00330000
*                                                                       00340000
*    ESTAEX ROUTINE WITHOUT AN SDWA:                                    00350000
*                                                                       00360000
*    R15 = ENTRY POINT ADDRESS                                          00370000
*    R14 = RETURN ADDRESS                                               00380000
*    R02 = ADDRESS OF IVTAMRPA                                          00390000
*          +00 (8) --> CL8'ESTAEX  '                                    00400000
*          +08 (4) --> ADDRESS OF IVTAMRPA                              00410000
*          +0C (...) --> REMAINDER OF IVTAMRPA                          00420000
*    R01 = X'00SSSUUU' COMPLETION CODE                                  00430000
*    R00 = 12                                                           00440000
*                                                                       00450000
* ON EXIT:                                                              00460000
*                                                                       00470000
*    FRR OR ESTAEX WITH AN SDWA:                                        00480000
*                                                                       00490000
*    SDWA HAS BEEN UPDATED TO EITHER RETRY OR PERCOLATE AND:            00500000
*    R13 = DESTROYED                                                    00510000
*    R10 = DESTROYED                                                    00520000
*    ALL OTHER REGISTERS ARE RESTORED                                   00530000
*                                                                       00540000
*    ESTAEX ROUTINE WITHOUT AN SDWA AND RETRY WILL BE PERFORMED:        00550000
*                                                                       00560000
*    R15 = 4 (RETURN CODE TO INDICATE RETRY)                            00570000
*    R10 = UNPREDICTABLE                                                00580000
*    R00 = ENTRY POINT ADDRESS OF RETRY ROUTINE                         00590000
*    ALL OTHER REGISTERS ARE UNCHANGED                                  00600000
*                                                                       00610000
*    ESTAEX ROUTINE WITHOUT AN SDWA AND RECOVERY WILL PERCOLATE:        00620000
*                                                                       00630000
*    R15 = 0 (RETURN CODE TO INDICATE PERCOLATION)                      00640000
*    R10 = UNPREDICTABLE                                                00650000
*    ALL OTHER REGISTERS ARE UNCHANGED                                  00660000
*                                                                       00670000
**<DOC-OFF>************************************************************ 00680000
                                                                        00690000
*********************************************************************** 00700000
*                                                                       00710000
* MAINTENANCE:                                                          00720000
*                                                                       00730000
*   11/03/94 RANDY WITEK                                                00740000
*                                                                       00750000
*********************************************************************** 00760000
                                                                        00770000
         SPLEVEL SET=3            SET MVS/SP LEVEL GLOBAL               00780000
                                                                        00790000
         EQUS  ,                  GENERAL EQUATES                       00800000
                                                                        00810000
RRPA     EQU   R10                                                      00820000
RSDWA    EQU   R9                                                       00830000
RSDWAX   EQU   R8                                                       00840000
RWORK    EQU   R7                                                       00850000
                                                                        00860000
IVTMXRCV CSECT ,                                                        00870000
IVTMXRCV AMODE 31                                                       00880000
IVTMXRCV RMODE ANY                                                      00890000
                                                                        00900000
         USING *,R15              TEMPORARY ADDRESSABILITY              00910000
         B     RCVSTART           GO GET 'EM                            00920000
                                                                        00930000
         @CPYRYT ,                COPYRIGHT                             00940000
                                                                        00950000
*---------------------------------------------------------------------- 00960000
* SET UP ACCESS TO THE IVTAMRPA                                         00970000
*---------------------------------------------------------------------- 00980000
                                                                        00990000
RCVSTART DS    0H                                                       01000000
                                                                        01010000
X        USING IVTAMRPA,R2                                              01020000
         L     RRPA,X.IVRRPA@     GET IVTAMRPA ADDRESS FOR FRR'S        01030000
         DROP  X                                                        01040000
                                                                        01050000
         USING IVTAMRPA,RRPA      ESTABLISH ADDRESSIBILTY               01060000
                                                                        01070000
*---------------------------------------------------------------------- 01080000
* IF THERE IS NO SDWA...JUST SET UP THE RETRY ROUTINE                   01090000
*---------------------------------------------------------------------- 01100000
                                                                        01110000
         C     R0,=A(RC12)        SDWA AVAILABLE?                       01120000
         BNE   STDRCVY            BRANCH IF YES                         01130000
                                                                        01140000
GETOUT   DS    0H                                                       01150000
                                                                        01160000
         SR    R15,R15            PERCOLATE TO NEXT RECOVERY ROUTINE    01170000
*                        -------> BASE REGISTER IS NOW GONE             01180000
         TM    IVRF1,IVRF1IN      HAVE WE RECOVERED ONCE ALREADY?       01190000
         BOR   R14                EXIT TO PERCOLATE IF YES              01200000
         OI    IVRF1,IVRF1IN      SHOW THAT WE HAVE RECOVERED           01210000
         L     R0,IVRRETAD        ADDRESS OF RETRY ROUTINE              01220000
         LA    R15,4              GO IMMEDIATELY TO RETRY ROUTINE       01230000
         BR    R14                DONE                                  01240000
                                                                        01250000
*---------------------------------------------------------------------- 01260000
* PROCESS FRR RECOVERY OR ESTAEX WITH AN SDWA                           01270000
*---------------------------------------------------------------------- 01280000
                                                                        01290000
STDRCVY  DS    0H                                                       01300000
                                                                        01310000
         LA    R13,IVRSA1         ADDRESS OF A SAVE AREA FOR US         01320000
         STM   R14,R12,12(R13)    SAVE CALLER'S REGISTERS               01330000
         LR    R12,R15            SET BASE REGISTER                     01340000
         DROP  R15                DROP TEMPORARY BASE                   01350000
         USING IVTMXRCV,R12       ESTABLISH STANDARD ADDRESSABILITY     01360000
                                                                        01370000
         LA    R15,IVRSA2         ADDRESS OF OUR PROVIDED SAVE AREA     01380000
         ST    R13,4(,R15)        SET BACK LINK TO SAVE AREA 1          01390000
         LR    R13,R15            WE NOW HAVE A SAVE AREA               01400000
                                                                        01410000
         LR    RWORK,R0           FRR WORK AREA                         01420000
                                                                        01430000
         LR    RSDWA,R1           SDWA                                  01440000
         USING SDWA,RSDWA         ESTABLISH ADDRESSABILITY              01450000
                                                                        01460000
         L     RSDWAX,SDWAXPAD    SDWA EXTENSION AREA                   01470000
         USING SDWAPTRS,RSDWAX    PTR EXTENSION IS ALWAYS PRESENT       01480000
                                                                        01490000
         TM    IVRF1,IVRF1IN      HAVE WE RECOVERED ONCE ALREADY?       01500000
         BO    PERCLATE           EXIT TO PERCOLATE IF YES              01510000
         OI    IVRF1,IVRF1IN      SHOW THAT WE HAVE RECOVERED           01520000
                                                                        01530000
         CLC   IVRTYPE,=CL8'FRR'  FRR RECOVERY?                         01540000
         BE    STDFRR             BRANCH IF YES                         01550000
         CLC   IVRTYPE,=CL8'ESTAEX'                                     01560000
         BE    STDESTAE           BRANCH IF YES                         01570000
         B     RECOVER            JUST TRIGGER RETRY ???                01580000
                                                                        01590000
*---------------------------------------------------------------------- 01600000
* PROCESS FRR RECOVERY                                                  01610000
*---------------------------------------------------------------------- 01620000
                                                                        01630000
STDFRR   DS    0H                                                       01640000
                                                                        01650000
         TM    SDWAERRC,SDWAEAS   HAS SOME OTHER ROUTINE RECORDED?      01660000
         BO    STDFRRGO           BRANCH IF YES                         01670000
                                                                        01680000
         TM    IVRF1,IVRF1IVI     ISESS VALIDATION FAILED?              01690000
         BO    STDFRRGO           BRANCH IF YES, SKIP DUMP              01700000
                                                                        01710000
         LR    R0,RWORK           AREA TO BUILD PLIST                   01720000
         LA    R1,L'SDPLIST       LENGTH OF PLIST                       01730000
         C     R1,=F'304'         LARGER THAN WORK AREA?                01740000
         BH    STDFRRGO           SKIP SDUMP IF TOO LARGE               01750000
         LA    R14,SDUMPMFL       PLIST SKELETON                        01760000
         LR    R15,R1             LENGTH OF PLIST                       01770000
         MVCL  R0,R14             SET UP PLIST                          01780000
                                                                        01790000
         SR    R3,R3              CLEAR                                 01800000
         USING PSA,0                                                    01810000
         L     R15,PSAAOLD        CURRENT ASCB                          01820000
         ICM   R3,B'0011',ASCBASID-ASCB(R15)                            01830000
                                                                        01840000
         SDUMPX HDR='INFOSESSION VTAM EXIT RECOVERY',                  +01850000
               SDATA=(ALLPSA,LPA,LSQA,RGN,SUMDUMP,TRT),                +01860000
               BRANCH=YES,                                             +01870000
               ASID=(R3),                                              +01880000
               TYPE=FAILRC,                                            +01890000
               MF=(E,(RWORK))                                           01900000
                                                                        01910000
STDFRRGO DS    0H                                                       01920000
                                                                        01930000
         TM    SDWAERRD,SDWACLUP  IS THIS CLEANUP ONLY? (NO RETRY?)     01940000
         BO    PERCLATE           EXIT TO PERCOLATE IF YES              01950000
                                                                        01960000
         MVC   SDWASRSV,IVRR00    SET THE RETRY REGISTERS               01970000
         L     R2,IVRRETAD        RETRY ROUTINE ADDRESS                 01980000
                                                                        01990000
         SETRP RC=4,              4 --> RETRY                          +02000000
               WKAREA=(RSDWA),    SDWA                                 +02010000
               RETADDR=(R2),      RETRY ROUTINE ENTRY POINT            +02020000
               RECORD=YES,        RECORD SDWA IN SYS1.LOGREC           +02030000
               RECPARM=IVRMOD,    MODULE/CSECT/FRR NAMES               +02040000
               RETREGS=YES        RESTORE THE REGISTERS FROM SDWA       02050000
                                                                        02060000
         B     RECOVER                                                  02070000
                                                                        02080000
*---------------------------------------------------------------------- 02090000
* PROCESS ESTAEX RECOVERY                                               02100000
*---------------------------------------------------------------------- 02110000
                                                                        02120000
STDESTAE DS    0H                                                       02130000
                                                                        02140000
         TM    SDWAERRC,SDWAEAS   HAS SOME OTHER ROUTINE RECORDED?      02150000
         BO    STDESTGO           BRANCH IF YES                         02160000
                                                                        02170000
         TM    IVRF1,IVRF1IVI     ISESS VALIDATION FAILED?              02180000
         BO    STDESTGO           BRANCH IF YES, SKIP DUMP              02190000
                                                                        02200000
         SETRP DUMP=YES,          GET A DUMP                           +02210000
               WKAREA=(RSDWA),    SDWA                                 +02220000
               DUMPOPX=SNAPLIST   DUMP OPTIONS                          02230000
                                                                        02240000
STDESTGO DS    0H                                                       02250000
                                                                        02260000
         TM    SDWAERRD,SDWACLUP  IS THIS CLEANUP ONLY? (NO RETRY?)     02270000
         BO    PERCLATE           EXIT TO PERCOLATE IF YES              02280000
                                                                        02290000
         MVC   SDWASRSV,IVRR00    SET THE RETRY REGISTERS               02300000
         L     R2,IVRRETAD        RETRY ROUTINE ADDRESS                 02310000
                                                                        02320000
         SETRP RC=4,              4 --> RETRY                          +02330000
               WKAREA=(RSDWA),    SDWA                                 +02340000
               RETADDR=(R2),      RETRY ROUTINE ENTRY POINT            +02350000
               FRESDWA=YES,       RELEASE THE SDWA NOW                 +02360000
               RECORD=YES,        RECORD SDWA IN SYS1.LOGREC           +02370000
               RECPARM=IVRMOD,    MODULE/CSECT/FRR NAMES               +02380000
               RETREGS=YES        RESTORE THE REGISTERS FROM SDWA       02390000
                                                                        02400000
         B     RECOVER                                                  02410000
                                                                        02420000
*---------------------------------------------------------------------- 02430000
* RETURN TO ALLOW RETRY ROUTINE TO RUN                                  02440000
*---------------------------------------------------------------------- 02450000
                                                                        02460000
RECOVER  DS    0H                                                       02470000
                                                                        02480000
         L     R13,4(,R13)        PREVIOUS SAVE AREA                    02490000
         LM    R14,R12,12(R13)    RESTORE THE REGISTERS                 02500000
         BR    R14                AND RETURN                            02510000
                                                                        02520000
*---------------------------------------------------------------------- 02530000
* RETURN TO PERCOLATE TO NEXT RECOVERY ROUTINE                          02540000
*---------------------------------------------------------------------- 02550000
                                                                        02560000
PERCLATE DS    0H                                                       02570000
                                                                        02580000
         SETRP RC=0,              0 --> PERCOLATE                      +02590000
               WKAREA=(RSDWA),    SDWA                                 +02600000
               RECORD=YES,        RECORD SDWA IN SYS1.LOGREC           +02610000
               RECPARM=IVRMOD     MODULE/CSECT/FRR NAMES                02620000
                                                                        02630000
         L     R13,4(,R13)        PREVIOUS SAVE AREA                    02640000
         LM    R14,R12,12(R13)    RESTORE THE REGISTERS                 02650000
         BR    R14                AND RETURN                            02660000
                                                                        02670000
*---------------------------------------------------------------------- 02680000
*  CONSTANTS AND LITERALS                                               02690000
*---------------------------------------------------------------------- 02700000
                                                                        02710000
SDUMPMFL SDUMPX PLISTVER=2,MF=L                                         02720000
SDPLIST  EQU SDUMPMFL,*-SDUMPMFL                                        02730000
                                                                        02740000
SNAPXMFL SNAPX SDATA=(SUM),PDATA=ALL,MF=L                               02750000
SNAPLIST EQU SNAPXMFL,*-SNAPXMFL                                        02760000
                                                                        02770000
         LTORG ,                                                        02780000
         IHASDWA ,                                                      02790000
         PRINT NOGEN                                                    02800000
         CVT DSECT=YES                                                  02810000
         ICVT  ,                                                        02820000
         IVTAMRPA ,                                                     02830000
         IHAPSA ,                                                       02840000
         IHAASCB ,                                                      02850000
         IKJTCB ,                                                       02860000
         END   ,                                                        02870000

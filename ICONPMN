ICONPMN  TITLE '- TERMINATE AUTOMATED COMMAND SUBMISSION'               00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: ICONPMN - TERMINATE AUTOMATED COMMAND SUBMISSION             00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This service is used to terminate an automated command             00080000
*    subission process.  ISSUE commands create a long running           00090000
*    processes to submit commands for a given time interval.            00100000
*    These processes are stop by posting the EPB specified              00110000
*    their associated AMNREC.  $PMON requests may be issued             00120000
*    with a specific MONITOR ID name or a process unique                00130000
*    monitor ID number.  Since multiple ISSUE processes can             00140000
*    be submitting commands for a single MONITOR ID,  a unique          00150000
*    monitor IDNUM is carried through the command request               00160000
*    block to uniquely indentify the associated submitting              00170000
*    process and terminate that process if $CONTASK encounters          00180000
*    any problems with the command, such as command syntax              00190000
*    or output delivery.                                                00200000
*                                                                       00210000
*                                                                       00220000
* ON ENTRY:                                                             00230000
*                                                                       00240000
*    R1  contains the address of the auto command submission            00250000
*        parameter list mapped by PMNREQ ($PMON DSECT=YES).             00260000
*                                                                       00270000
*                                                                       00280000
* ON EXIT:                                                              00290000
*                                                                       00300000
*    R15 contains one of the following return codes:                    00310000
*                                                                       00320000
*        RC00 - Specified ISSUE command TERMINATED                      00330000
*        RC04 - Specified ISSUE command not found                       00340000
*        RC08 - CMDREQ required for request                             00350000
*                                                                       00360000
**<DOC-OFF>****************************************************         00370000
                                                                        00380000
                                                                        00390000
***************************************************************         00400000
*                                                                       00410000
* MAINTENANCE:                                                          00420000
*                                                                       00430000
*    09/30/94 R. Turgeon                                                00440000
*             Initial Version                                           00450000
*                                                                       00460000
*    05/11/95 R. Colmone                                                00470000
*             Modified auto command submission stop routine             00480000
*             to process process AMNREC queue and post                  00490000
*             required processes.  This service is implemented          00500000
*             using the $PMON macro.                                    00510000
*                                                                       00520000
***************************************************************         00530000
         EJECT                                                          00540000
         $PMON   DSECT=YES        $PMON PARAMETER LIST                  00550000
                                                                        00560000
         EJECT                                                          00570000
         CMDREQ  DSECT=YES        COMMAND REQUEST BLOCK                 00580000
                                                                        00590000
         EJECT                                                          00600000
         AMNREC  ,                AUTO CMD SUBMISSION RECORD            00610000
                                                                        00620000
         EJECT                                                          00630000
         $TASK   DSECT=YES        $PMON PARAMETER LIST                  00640000
                                                                        00650000
         EJECT ,                                                        00660000
         EQUS  ,                  GENERAL EQUATES                       00670000
                                                                        00680000
         $MSGDFT PREFIX=ICTPID,COMPID='CMD',TABLE=*#MSGS,              X00690000
               CONID=*CMRQCNID,CONNAME=CMRQCNAM,CART=CMRQCART,         X00700000
               DESTADD=*CMRQDMSK,                                      X00710000
               MSGQA=*CMRQMQA,STGQH=*CMRQSTGQ,                         X00720000
               MF=(E,$MSGMFL),                                         X00730000
               PRINT=NOGEN                                              00740000
                                                                        00750000
         EJECT                                                          00760000
         #WORK ,                  BEGIN WORKAREA                        00770000
FLAGS    DS    X                  FLAGS                                 00780000
FDEL     EQU   X'80'                ISSUE PROCESS POSTED                00790000
                                                                        00800000
$MSGMFL  $MSG  FIELDS=(,,,),MF=(L,*)                                    00810000
$TASKMFL $TASK MF=(L,*)                                                 00820000
                                                                        00830000
         #ENDWORK ,               END OF WORKAREA                       00840000
                                                                        00850000
         EJECT                                                          00860000
ICONPMN  #ENTER PREG=R8                                                 00870000
                                                                        00880000
         USING ITASK,R10          STDENV                                00890000
         USING PMNREQ,R8          PARAMETER LIST                        00900000
                                                                        00910000
         ICM   R7,15,PMNCMRQ      ADDRESS OF COMMAND REQUEST BLOCK      00920000
         BZ    ERR_REQ            REQUEST IN ERROR                      00930000
         USING CMDREQ,R7          COMMAND REQUEST BLOCK                 00940000
                                                                        00950000
         EJECT                                                          00960000
***************************************************************         00970000
*                                                                       00980000
*   NOTIFY ALL/IDENTIFIED MONITORS OF TERMINATION REQUEST               00990000
*                                                                       01000000
***************************************************************         01010000
         L     R4,CMRQAMNQ        AMNREC QUEUE ANCHOR ADDRESS           01020000
         SH    R4,=AL2(AMNNEXT-AMNREC)   CAST ANCHOR AS AMNREC ENTRY    01030000
P        USING AMNREC,R4          P (PREV) RECORD                       01040000
Q        USING AMNREC,R5          Q (CURR) RECORD                       01050000
                                                                        01060000
*--------------------------------------------------------------         01070000
*   POST ALL MATCHING MONITORS FOR TERMINATION                          01080000
*--------------------------------------------------------------         01090000
STOPSCAN DS    0H                 LOCATE DELETABLE AMNREC               01100000
         ICM   R5,15,P.AMNNEXT    TARGET AMNREC FOUND?                  01110000
         BZ    STOPFIN            DONE AT END OF LIST                   01120000
                                                                        01130000
         ICM   R2,15,PMNAMNM      MONITOR NAME SPECIFIED                01140000
         BZ    STOPAMN#           NO, CHECK FOR MONITOR IDNUM           01150000
         CLC   Q.AMNMONID,0(R2)   REQUESTED MONITOR NAME?               01160000
         BNE   STOPADV            CONTINUE SCAN IF NOT                  01170000
                                                                        01180000
STOPAMN# DS    0H                                                       01190000
         ICM   R2,15,PMNAMN#      MONITOR PROCESS IDNUM SPECIFIED?      01200000
         BZ    STOPMON            NO, NOTIFY THIS PROCESS TO STOP       01210000
         C     R2,Q.AMNMNID#      REQUESTED MONITOR IDNUM               01220000
         BNE   STOPADV            CONTINUE SCAN IF NOT                  01230000
                                                                        01240000
STOPMON  DS    0H                                                       01250000
         OI    FLAGS,FDEL         ISSUE PROC POSTED FOR TERMINATION     01260000
                                                                        01270000
         $TASK POST,              NOTIFY ISSUE PROCESS                 X01280000
               EPB=*Q.AMNEPB,                                          X01290000
               PCODE=0,                                                X01300000
               MF=(E,$TASKMFL)                                          01310000
                                                                        01320000
         $MSG  390,FIELDS=(Q.AMNMONID)                                  01330000
                                                                        01340000
STOPADV  DS    0H                 ADVANCE TO NEXT ENTRY                 01350000
         LR    R4,R5              INCH ALONG THE LIST                   01360000
         B     STOPSCAN           CONTINUE MATCH SCAN                   01370000
         DROP  P,Q                PREV, CURR AMNREC'S                   01380000
                                                                        01390000
*--------------------------------------------------------------         01400000
*   APPROPRIATE WARNING IF NO ENTRIES MATCHED / DELETED                 01410000
*--------------------------------------------------------------         01420000
STOPFIN  DS    0H                 ALL AMNREC'S EXAMINED                 01430000
         LA    R15,RC00           ASSUME NORMAL COMPLETION              01440000
         TM    FLAGS,FDEL         ANY DELETED?                          01450000
         BO    RETURN             DONE IF SO                            01460000
         LA    R15,RC04           NO MONITORS DELETED                   01470000
         B     RETURN             RETURN                                01480000
                                                                        01490000
***************************************************************         01500000
*                                                                       01510000
*   RETURN TO CALLER, $COMMAND COMPLETION CODE RETURNED                 01520000
*                                                                       01530000
***************************************************************         01540000
ERR_REQ  DS    0H                                                       01550000
         LA    R15,RC08           CMDREQ REQUEST FOR REQUEST            01560000
                                                                        01570000
RETURN   DS    0H                                                       01580000
         #EXIT  ,                                                       01590000
                                                                        01600000
         EJECT                                                          01610000
***************************************************************         01620000
*                                                                       01630000
*   LOCAL READ ONLY DATA AREAS, ETC.                                    01640000
*                                                                       01650000
***************************************************************         01660000
                                                                        01670000
         LTORG ,                                                        01680000
                                                                        01690000
         PRINT NOGEN                                                    01700000
         ICVT  ,                                                        01710000
         ITASK ,                                                        01720000
         END   ,                                                        01730000

IVTMSSIP TITLE 'INTEGRATOR - SEND INITIAL PROTOCOL CHECKS'              00010000
**<DOC-ON>************************************************************* 00020000
*                                                                       00030000
* ROUTINE: IVTMSSIP - SEND INITIAL PROTOCOL CHECKS                      00040000
*                                                                       00050000
* DESCRIPTION: THIS ROUTINE IS CALLED BY IVTMSREQ TO PERFORM            00060000
*              PROTOCOL CHECKS BEFORE A SEND OPERATION.                 00070000
*                                                                       00080000
* ON ENTRY:                                                             00090000
*                                                                       00100000
*    R15 = ENTRY POINT ADDRESS                                          00110000
*    R14 = RETURN ADDRESS                                               00120000
*    R13 = AVAILABLE SAVE AREA                                          00130000
*    R11 = ICVT ADDRESS                                                 00140000
*    R10 = ITASK ADDRESS                                                00150000
*    R09 = IVTAMCVT ADDRESS                                             00160000
*    R08 = ISESS ADDRESS                                                00170000
*    R07 = IACB ADDRESS                                                 00180000
*    R06 = IRPL ADDRESS                                                 00190000
*    R06 = SPLIST ADDRESS                                               00200000
*                                                                       00210000
* ON EXIT:                                                              00220000
*                                                                       00230000
*    R15 = 0 --> PROCEED WITH SEND                                      00240000
*          4 --> PROTOCOL ERROR DETECTED                                00250000
*    R00 = 0                                                            00260000
*    R01 = 0                                                            00270000
*                                                                       00280000
*    ALL OTHER REGISTERS ARE RESTORED.                                  00290000
*                                                                       00300000
**<DOC-OFF>************************************************************ 00310000
                                                                        00320000
         EJECT ,                                                        00330000
*********************************************************************** 00340000
*                                                                       00350000
* MAINTENANCE:                                                          00360000
*                                                                       00370000
*   08/01/93 RANDY WITEK                                                00380000
*   07/01/94 RANDY WITEK - LU6.2 SUPPORT                                00390000
*                                                                       00400000
*********************************************************************** 00410000
                                                                        00420000
         EQUS  ,                  GENERAL EQUATES                       00430000
                                                                        00440000
RICVT    EQU   R11                                                      00450000
RITASK   EQU   R10                                                      00460000
RIVTAM   EQU   R9                                                       00470000
RISESS   EQU   R8                                                       00480000
RIACB    EQU   R7                                                       00490000
RSPLIST  EQU   R6                                                       00500000
                                                                        00510000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00520000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00530000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00540000
         USING ISESS,RISESS       ESTABLISH ADDRESSABILITY              00550000
         USING IACB,RIACB         ESTABLISH ADDRESSABILITY              00560000
         USING ISTDBIND,ISEBIND   ESTABLISH ADDRESSABILITY              00570000
         USING SPLIST,RSPLIST     ESTABLISH ADDRESSABILITY              00580000
                                                                        00590000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00600000
WRK256   DS    XL256              GENERAL WORKAREA                      00610000
SAVSTATE DS    F                  STATE FLAGS ON ENTRY                  00620000
LV0SAVE  DS    18F                SUBROUTINE SAVE AREA                  00630000
RETR15   DS    F                                                        00640000
RETR0    DS    F                                                        00650000
RETR1    DS    F                                                        00660000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00670000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00680000
                                                                        00690000
         $MSGDFT PREFIX=ICTPID,                                        +00700000
               COMPID='VTM',                                           +00710000
               TABLE=*#MSGS,                                           +00720000
               WORKA=0,                                                +00730000
               MF=(E,WRK256),                                          +00740000
               PRINT=NOGEN                                              00750000
                                                                        00760000
IVTMSSIP #ENTER BASE=R12,         ENTRY LINKAGE                        +00770000
               AMODE=31,                                               +00780000
               RMODE=ANY                                                00790000
                                                                        00800000
*---------------------------------------------------------------------- 00810000
* SAVE CURRENT SESSION STATE FLAGS                                      00820000
*---------------------------------------------------------------------- 00830000
                                                                        00840000
         MVC   SAVSTATE,ISESTATE  SAVE THE STATE FLAGS                  00850000
                                                                        00860000
*---------------------------------------------------------------------- 00870000
* LOOKUP $SESS FUNCTION IN TABLE AND JUMP TO PROTOCOL CHECK ROUTINE     00880000
*---------------------------------------------------------------------- 00890000
                                                                        00900000
         LA    R1,FTABLE          BEGINNING OF TABLE                    00910000
         LA    R2,L'FTABNTRY      LENGTH OF AN ENTRY                    00920000
         LA    R3,FTABLAST        ADDRESS OF LAST ENTRY                 00930000
                                                                        00940000
FUNCLOOK DS    0H                                                       00950000
                                                                        00960000
         CLC   SPLFUNC,0(R1)      FOUND TABLE ENTRY?                    00970000
         BE    FUNCFIND           BRANCH IF YES                         00980000
         BXLE  R1,R2,FUNCLOOK     CHECK THE NEXT ENTRY                  00990000
         B     RETURN             FUNCTION CODE NOT FOUND               01000000
                                                                        01010000
FTABLE   DS    0F                                                       01020000
         DC    A($SESS_RECEIVE,RETURN)                                  01030000
FTABNTRY EQU   FTABLE,*-FTABLE                                          01040000
         DC    A($SESS_SEND_DATA,SENDDATA)                              01050000
         DC    A($SESS_SEND_POSRESP,SENDPRSP)                           01060000
         DC    A($SESS_SEND_NEGRESP,SENDNRSP)                           01070000
         DC    A($SESS_SEND_SIGNAL,SENDSIG)                             01080000
         DC    A($SESS_SEND_BID,SENDBID)                                01090000
         DC    A($SESS_SEND_LUSTAT,SENDLUS)                             01100000
         DC    A($SESS_SEND_CANCEL,SENDCAN)                             01110000
         DC    A($SESS_SEND_RTR,SENDRTR)                                01120000
         DC    A($SESS_SEND_CHASE,SENDCHA)                              01130000
         DC    A($SESS_SEND_SDT,SENDSDT)                                01140000
         DC    A($SESS_SEND_CLEAR,SENDCLR)                              01150000
         DC    A($SESS_SEND_SHUTD,SENDSHTD)                             01160000
         DC    A($SESS_SEND_SHUTC,SENDSHTC)                             01170000
         DC    A($SESS_SEND_RSHUTD,SENDRSHT)                            01180000
         DC    A($SESS_SEND_RELQ,SENDRELQ)                              01190000
         DC    A($SESS_SEND_QEC,SENDQEC)                                01200000
         DC    A($SESS_SEND_QC,SENDQC)                                  01210000
         DC    A($SESS_SEND_SBI,SENDSBI)                                01220000
         DC    A($SESS_SEND_STSN,SENDSTSN)                              01230000
         DC    A($SESS_SEND_RQR,SENDRQR)                                01240000
         DC    A($SESS_START_SESSION,RETURN)                            01250000
         DC    A($SESS_END_SESSION,RETURN)                              01260000
FTABLAST EQU   *-L'FTABNTRY                                             01270000
                                                                        01280000
FUNCFIND DS    0H                                                       01290000
                                                                        01300000
         L     R15,4(,R1)         PROCESSING ROUTINE ADDRESS            01310000
         BASR  R14,R15            JUMP TO PROCESSING ROUTINE            01320000
                                                                        01330000
*---------------------------------------------------------------------- 01340000
* $SESS_SEND_DATA                                                       01350000
*---------------------------------------------------------------------- 01360000
                                                                        01370000
SENDDATA DS    0H                                                       01380000
                                                                        01390000
         TM    ISES1,ISES1DTR     DATA TRAFFIC RESET?                   01400000
         BO    PROTER01           BRANCH IF YES                         01410000
                                                                        01420000
         TM    ISES2,ISES2QC      SESSION QUIESCED?                     01430000
         BO    PROTER02           BRANCH IF YES                         01440000
                                                                        01450000
         TM    ISEF2,ISEF2SLU     ARE WE SLU?                           01460000
         BNO   SDNOSHD            BRANCH IF NOT                         01470000
         TM    ISES2,ISES2SHD     SESSION SHUTDOWN?                     01480000
         BO    PROTER03           BRANCH IF YES                         01490000
                                                                        01500000
SDNOSHD  DS    0H                                                       01510000
                                                                        01520000
         BAS   R14,BRACKETS       DO BRACKET CHECKS                     01530000
         BAS   R14,DIRECTN        DO DIRECTION CHECKS                   01540000
         BAS   R14,CHAINING       DO CHAINING  CHECKS                   01550000
                                                                        01560000
*                                                                       01570000
* RESPONSE CHECKS                                                       01580000
*---------------------------------------------------------------------- 01590000
                                                                        01600000
         B     RETURN                                                   01610000
                                                                        01620000
*---------------------------------------------------------------------- 01630000
* $SESS_SEND_POSRESP                                                    01640000
*---------------------------------------------------------------------- 01650000
                                                                        01660000
SENDPRSP DS    0H                                                       01670000
                                                                        01680000
         B     RETURN                                                   01690000
                                                                        01700000
*---------------------------------------------------------------------- 01710000
* $SESS_SEND_NEGRESP                                                    01720000
*---------------------------------------------------------------------- 01730000
                                                                        01740000
SENDNRSP DS    0H                                                       01750000
                                                                        01760000
         B     RETURN                                                   01770000
                                                                        01780000
*---------------------------------------------------------------------- 01790000
* $SESS_SEND_SIGNAL                                                     01800000
*---------------------------------------------------------------------- 01810000
                                                                        01820000
SENDSIG  DS    0H                                                       01830000
                                                                        01840000
         TM    ISES1,ISES1DTR     DATA TRAFFIC RESET?                   01850000
         BO    PROTER01           BRANCH IF YES                         01860000
                                                                        01870000
         TM    ISER2,ISER2SIG     SIGNAL OK?                            01880000
         BNO   PROTER06           BRANCH IF NOT                         01890000
         B     RETURN                                                   01900000
                                                                        01910000
*---------------------------------------------------------------------- 01920000
* $SESS_SEND_BID                                                        01930000
*---------------------------------------------------------------------- 01940000
                                                                        01950000
SENDBID  DS    0H                                                       01960000
                                                                        01970000
         B     RETURN                                                   01980000
                                                                        01990000
*---------------------------------------------------------------------- 02000000
* $SESS_SEND_LUSTAT                                                     02010000
*---------------------------------------------------------------------- 02020000
                                                                        02030000
SENDLUS  DS    0H                                                       02040000
                                                                        02050000
         TM    SPLF1,SPLF1ORH     WAS RH= OMITTED?                      02060000
         BO    RETURN             BRANCH IF NO USERRH                   02070000
                                                                        02080000
         BAS   R14,BRACKETS       DO BRACKET   CHECKS                   02090000
         BAS   R14,DIRECTN        DO DIRECTION CHECKS                   02100000
         BAS   R14,CHAINING       DO CHAINING  CHECKS                   02110000
                                                                        02120000
         B     RETURN                                                   02130000
                                                                        02140000
*---------------------------------------------------------------------- 02150000
* $SESS_SEND_CANCEL                                                     02160000
*---------------------------------------------------------------------- 02170000
                                                                        02180000
SENDCAN  DS    0H                                                       02190000
                                                                        02200000
         B     RETURN                                                   02210000
                                                                        02220000
*---------------------------------------------------------------------- 02230000
* $SESS_SEND_RTR                                                        02240000
*---------------------------------------------------------------------- 02250000
                                                                        02260000
SENDRTR  DS    0H                                                       02270000
                                                                        02280000
         B     RETURN                                                   02290000
                                                                        02300000
*---------------------------------------------------------------------- 02310000
* $SESS_SEND_CHASE                                                      02320000
*---------------------------------------------------------------------- 02330000
                                                                        02340000
SENDCHA  DS    0H                                                       02350000
                                                                        02360000
         B     RETURN                                                   02370000
                                                                        02380000
*---------------------------------------------------------------------- 02390000
* $SESS_SEND_SDT                                                        02400000
*---------------------------------------------------------------------- 02410000
                                                                        02420000
SENDSDT  DS    0H                                                       02430000
                                                                        02440000
         TM    ISES1,ISES1DTR     DATA TRAFFIC RESET?                   02450000
         BNO   PROTER01           BRANCH IF YES                         02460000
         TM    ISER1,ISER1SDT     RU ALLOWED?                           02470000
         BNO   PROTER06           BRANCH IF NOT                         02480000
         NI    ISES1,255-ISES1DTR SHOW DATA TRAFFIC ACTIVE              02490000
         B     RETURN                                                   02500000
                                                                        02510000
*---------------------------------------------------------------------- 02520000
* $SESS_SEND_CLEAR                                                      02530000
*---------------------------------------------------------------------- 02540000
                                                                        02550000
SENDCLR  DS    0H                                                       02560000
                                                                        02570000
         TM    ISER1,ISER1CLR     RU ALLOWED?                           02580000
         BNO   PROTER06           BRANCH IF NOT                         02590000
         MVC   ISESTATE,ISERESET  RESET THE SESSION STATE               02600000
         B     RETURN                                                   02610000
                                                                        02620000
*---------------------------------------------------------------------- 02630000
* $SESS_SEND_SHUTD                                                      02640000
*---------------------------------------------------------------------- 02650000
                                                                        02660000
SENDSHTD DS    0H                                                       02670000
                                                                        02680000
         TM    ISES1,ISES1DTR     DATA TRAFFIC RESET?                   02690000
         BO    PROTER01           BRANCH IF YES                         02700000
                                                                        02710000
         TM    ISER2,ISER2SHU     RU ALLOWED?                           02720000
         BNO   PROTER06           BRANCH IF NOT                         02730000
         OI    ISES2,ISES2SHS     SHOW RU SENT                          02740000
         B     RETURN                                                   02750000
                                                                        02760000
*---------------------------------------------------------------------- 02770000
* $SESS_SEND_SHUTC                                                      02780000
*---------------------------------------------------------------------- 02790000
                                                                        02800000
SENDSHTC DS    0H                                                       02810000
                                                                        02820000
         TM    ISES1,ISES1DTR     DATA TRAFFIC RESET?                   02830000
         BO    PROTER01           BRANCH IF YES                         02840000
                                                                        02850000
         TM    ISER2,ISER2SHC     RU ALLOWED?                           02860000
         BNO   PROTER06           BRANCH IF NOT                         02870000
         OI    ISES2,ISES2SHD     SHOW SESSION SHUTDOWN                 02880000
         B     RETURN                                                   02890000
                                                                        02900000
*---------------------------------------------------------------------- 02910000
* $SESS_SEND_RSHUT                                                      02920000
*---------------------------------------------------------------------- 02930000
                                                                        02940000
SENDRSHT DS    0H                                                       02950000
                                                                        02960000
         TM    ISES1,ISES1DTR     DATA TRAFFIC RESET?                   02970000
         BO    PROTER01           BRANCH IF YES                         02980000
                                                                        02990000
         TM    ISER2,ISER2SHC     RU ALLOWED?                           03000000
         BNO   PROTER06           BRANCH IF NOT                         03010000
         OI    ISES2,ISES2RSS     SHOW RU SENT                          03020000
         B     RETURN                                                   03030000
                                                                        03040000
*---------------------------------------------------------------------- 03050000
* $SESS_SEND_RELQ                                                       03060000
*---------------------------------------------------------------------- 03070000
                                                                        03080000
SENDRELQ DS    0H                                                       03090000
                                                                        03100000
         TM    ISES1,ISES1DTR     DATA TRAFFIC RESET?                   03110000
         BO    PROTER01           BRANCH IF YES                         03120000
                                                                        03130000
         TM    ISER3,ISER3REQ     RU ALLOWED?                           03140000
         BNO   PROTER06           BRANCH IF NOT                         03150000
         NI    ISES2,255-ISES2QES-ISES2QER-ISES2QC-ISES2RSS-ISES2RSR-IS+03160000
               ES2SHS-ISES2SHR-ISES2SHD                                 03170000
         B     RETURN                                                   03180000
                                                                        03190000
*---------------------------------------------------------------------- 03200000
* $SESS_SEND_QEC                                                        03210000
*---------------------------------------------------------------------- 03220000
                                                                        03230000
SENDQEC  DS    0H                                                       03240000
                                                                        03250000
         TM    ISES1,ISES1DTR     DATA TRAFFIC RESET?                   03260000
         BO    PROTER01           BRANCH IF YES                         03270000
                                                                        03280000
         TM    ISER3,ISER3QEC     RU ALLOWED?                           03290000
         BNO   PROTER06           BRANCH IF NOT                         03300000
         OI    ISES2,ISES2QES     SHOW RU SENT                          03310000
         B     RETURN                                                   03320000
                                                                        03330000
*---------------------------------------------------------------------- 03340000
* $SESS_SEND_QC                                                         03350000
*---------------------------------------------------------------------- 03360000
                                                                        03370000
SENDQC   DS    0H                                                       03380000
                                                                        03390000
         TM    ISES1,ISES1DTR     DATA TRAFFIC RESET?                   03400000
         BO    PROTER01           BRANCH IF YES                         03410000
                                                                        03420000
         TM    ISER3,ISER3QC      RU ALLOWED?                           03430000
         BNO   PROTER06           BRANCH IF NOT                         03440000
         OI    ISES2,ISES2QC      SHOW QUIESCED                         03450000
         B     RETURN                                                   03460000
                                                                        03470000
*---------------------------------------------------------------------- 03480000
* $SESS_SEND_SBI                                                        03490000
*---------------------------------------------------------------------- 03500000
                                                                        03510000
SENDSBI  DS    0H                                                       03520000
                                                                        03530000
         TM    ISES1,ISES1DTR     DATA TRAFFIC RESET?                   03540000
         BO    PROTER01           BRANCH IF YES                         03550000
                                                                        03560000
         TM    ISER3,ISER3SBI     RU ALLOWED?                           03570000
         BNO   PROTER06           BRANCH IF NOT                         03580000
         OI    ISES3,ISES3SBS     SHOW RU SENT                          03590000
         B     RETURN                                                   03600000
                                                                        03610000
*---------------------------------------------------------------------- 03620000
* $SESS_SEND_BIS                                                        03630000
*---------------------------------------------------------------------- 03640000
                                                                        03650000
SENDBIS  DS    0H                                                       03660000
                                                                        03670000
         TM    ISES1,ISES1DTR     DATA TRAFFIC RESET?                   03680000
         BO    PROTER01           BRANCH IF YES                         03690000
                                                                        03700000
         TM    ISER3,ISER3BIS     RU ALLOWED?                           03710000
         BNO   PROTER06           BRANCH IF NOT                         03720000
         OI    ISES3,ISES3BIS     SHOW NOBB STATE                       03730000
         B     RETURN                                                   03740000
                                                                        03750000
*---------------------------------------------------------------------- 03760000
* $SESS_SEND_RQR                                                        03770000
*---------------------------------------------------------------------- 03780000
                                                                        03790000
SENDRQR  DS    0H                                                       03800000
                                                                        03810000
         B     RETURN                                                   03820000
                                                                        03830000
*---------------------------------------------------------------------- 03840000
* $SESS_SEND_STSN                                                       03850000
*---------------------------------------------------------------------- 03860000
                                                                        03870000
SENDSTSN DS    0H                                                       03880000
                                                                        03890000
         B     RETURN                                                   03900000
                                                                        03910000
*---------------------------------------------------------------------- 03920000
* SUBROUTINE: CHAINING CHECKS                                           03930000
*---------------------------------------------------------------------- 03940000
                                                                        03950000
CHAINING DS    0H                                                       03960000
                                                                        03970000
         TM    ISES1,ISES1INC     ARE WE IN-CHAIN?                      03980000
         BO    SDINC              BRANCH IF YES                         03990000
         TM    SPLRH0,RHBCI       IS BC SET?                            04000000
         BNO   PROTER07           BRANCH IF NOT                         04010000
         OI    ISES1,ISES1INC     SHOW IN-CHAIN                         04020000
         B     SDECCHK                                                  04030000
                                                                        04040000
SDINC    DS    0H                                                       04050000
                                                                        04060000
         TM    SPLRH0,RHBCI       TRYING TO SEND BC?                    04070000
         BO    PROTER07           BRANCH IF YES                         04080000
                                                                        04090000
SDECCHK  DS    0H                                                       04100000
                                                                        04110000
         TM    SPLRH0,RHECI       SENDING EC?                           04120000
         BNO   SDNOCHN            BRANCH IF NOT                         04130000
         NI    ISES1,255-ISES1INC CLEAR IN-CHAIN                        04140000
                                                                        04150000
SDNOCHN  DS    0H                                                       04160000
                                                                        04170000
         BR    R14                                                      04180000
                                                                        04190000
*---------------------------------------------------------------------- 04200000
* SUBROUTINE: DIRECTION CHECKS                                          04210000
*---------------------------------------------------------------------- 04220000
                                                                        04230000
DIRECTN  DS    0H                                                       04240000
                                                                        04250000
         TM    SPLF4,SPLF4BID     IS THIS A BRACKET BID?                04260000
         BO    SDNODIR            BRANCH IF YES                         04270000
                                                                        04280000
         TM    ISEF3,ISEF3CD      IS CD USED?                           04290000
         BNO   SDNODIR            BRANCH IF NOT                         04300000
         TM    ISES1,ISES1DIR     DO WE HAVE DIRECTION?                 04310000
         BNO   PROTER05           BRANCH IF NOT                         04320000
         TM    SPLRH2,RHCDI       GIVING UP DIRECTION?                  04330000
         BO    SDGIVDIR           BRANCH IF YES                         04340000
         TM    SPLRH2,RHEBI       SENDING EB?                           04350000
         BO    SDGIVDIR           BRANCH IF YES                         04360000
         TM    SPLRH2,RHCEBI      SENDING COND-EB?                      04370000
         BNO   SDNODIR            BRANCH IF NOT                         04380000
                                                                        04390000
SDGIVDIR DS    0H                                                       04400000
                                                                        04410000
         NI    ISES1,255-ISES1DIR CLEAR DIR                             04420000
                                                                        04430000
SDNODIR  DS    0H                                                       04440000
                                                                        04450000
         BR    R14                                                      04460000
                                                                        04470000
*---------------------------------------------------------------------- 04480000
* SUBROUTINE: BRACKET CHECKS                                            04490000
*---------------------------------------------------------------------- 04500000
                                                                        04510000
BRACKETS DS    0H                                                       04520000
                                                                        04530000
         TM    ISEF3,ISEF3BRK     ARE BRACKETS USED?                    04540000
         BZ    SDNOBRK            BRANCH IF NOT                         04550000
         TM    ISES1,ISES1INB     ARE WE IN-BRACKETS?                   04560000
         BO    SDINB              BRANCH IF YES                         04570000
         TM    SPLRH2,RHBBI       IS BB SET?                            04580000
         BNO   PROTER04           BRANCH IF NOT                         04590000
         TM    ISEF3,ISEF3BB      CAN WE SEND BB?                       04600000
         BNO   PROTER04           BRANCH IF NOT                         04610000
         TM    ISES1,ISES1BBP     ARE WE BEGIN BRACKET PENDING?         04620000
         BO    PROTER04           BRANCH IF YES                         04630000
                                                                        04640000
         TM    ISEF2,ISEF2WIN      ARE WE THE CONTENTION WINNER?        04650000
         BO    SDBBCD              BRANCH IF YES                        04660000
         TM    SPLRH2,RHEBI+RHCEBI IS THIS EB ALSO?                     04670000
         BNZ   SDBBCD              BRANCH IF YES                        04680000
         TM    ISES1,ISES1BAC      HAS OUR BID BEEN ACCEPTED?           04690000
         BO    SDBBCD              BRANCH IF YES                        04700000
         TM    SPLRH1,RHDR1+RHDR2  WAS SOME DRX REQUESTED?              04710000
         BZ    PROTER04            BRANCH IF NOT                        04720000
         TM    SPLRH1,RHERI        IS IT REALLY AN EX-RSP REQUEST?      04730000
         BO    PROTER04            BRANCH IF YES                        04740000
                                                                        04750000
         OI    SPLF4,SPLF4BID      REMEMBER THAT THIS IS A BRACKET BID  04760000
         B     SDNOBRK             AND WE ARE DONE                      04770000
                                                                        04780000
SDBBCD   DS    0H                                                       04790000
                                                                        04800000
         NI    ISES1,255-ISES1BAC CLEAR THE BID ACCEPTED FLAG           04810000
         TM    ISEF3,ISEF3CD      IS CD USED?                           04820000
         BNO   SDBBNODR           BRANCH IF NOT                         04830000
         OI    ISES1,ISES1DIR     WE WILL TAKE DIRECTION                04840000
                                                                        04850000
SDBBNODR DS    0H                                                       04860000
                                                                        04870000
         TM    SPLRH2,RHEBI       IS EB SET?                            04880000
         BO    SDEBCHEK           BRANCH IF YES                         04890000
         TM    SPLRH2,RHCEBI      IS COND-EB SET?                       04900000
         BNO   SDSETINB           BRANCH IF NOT                         04910000
         B     SDNOBRK                                                  04920000
                                                                        04930000
SDEBCHEK DS    0H                                                       04940000
                                                                        04950000
         TM    ISEF3,ISEF3EB      CAN WE SEND EB?                       04960000
         BNO   PROTER04           BRANCH IF NOT                         04970000
         B     SDNOBRK                                                  04980000
                                                                        04990000
SDSETINB DS    0H                                                       05000000
                                                                        05010000
         OI    ISES1,ISES1INB     SHOW INB                              05020000
         B     SDNOBRK                                                  05030000
                                                                        05040000
SDINB    DS    0H                                                       05050000
                                                                        05060000
         TM    SPLRH2,RHBBI       TRYING TO SEND BB?                    05070000
         BO    PROTER04           BRANCH IF YES                         05080000
         TM    SPLRH2,RHEBI       SENDING EB?                           05090000
         BO    SDEBCHK2           BRANCH IF YES                         05100000
         TM    SPLRH2,RHCEBI      SENDING COND-EB?                      05110000
         BNO   SDNOBRK            BRANCH IF NOT                         05120000
         B     SDCEBOK            BRANCH IF YES                         05130000
                                                                        05140000
SDEBCHK2 DS    0H                                                       05150000
                                                                        05160000
         TM    ISEF3,ISEF3EB      CAN WE SEND EB?                       05170000
         BNO   PROTER04           BRANCH IF NOT                         05180000
                                                                        05190000
SDCEBOK  DS    0H                                                       05200000
                                                                        05210000
         NI    ISES1,255-ISES1INB CLEAR INB                             05220000
                                                                        05230000
SDNOBRK  DS    0H                                                       05240000
                                                                        05250000
         BR    R14                                                      05260000
                                                                        05270000
*---------------------------------------------------------------------- 05280000
* A PROTOCOL ERROR WAS DETECTED.  SET REASON CODE AND RETURN ERROR.     05290000
*---------------------------------------------------------------------- 05300000
                                                                        05310000
PROTER01 MVI   SPLRSNCD+3,$SESS_RSN_SDTSTATE   DATA TRAFFIC STATE ERROR 05320000
         B     PROTERR                                                  05330000
PROTER02 MVI   SPLRSNCD+3,$SESS_RSN_QUIESCED   SESSION IS QUIESCED      05340000
         B     PROTERR                                                  05350000
PROTER03 MVI   SPLRSNCD+3,$SESS_RSN_SHUTDOWN   SESSION IS SHUTDOWN      05360000
         B     PROTERR                                                  05370000
PROTER04 MVI   SPLRSNCD+3,$SESS_RSN_BRACKET    BRACKET VIOLATION        05380000
         B     PROTERR                                                  05390000
PROTER05 MVI   SPLRSNCD+3,$SESS_RSN_DIRECTION  DIRECTION VIOLATION      05400000
         B     PROTERR                                                  05410000
PROTER06 MVI   SPLRSNCD+3,$SESS_RSN_RUTYPE     RU NOT SUPPORTED         05420000
         B     PROTERR                                                  05430000
PROTER07 MVI   SPLRSNCD+3,$SESS_RSN_CHAINING   CHAINING VIOLATION       05440000
         B     PROTERR                                                  05450000
                                                                        05460000
PROTERR  DS    0H                                                       05470000
                                                                        05480000
         MVC   RETR15,=F'4'       SET RC=4                              05490000
         MVC   SPLRETCD,=A($SESS_RC_PROTOCOL)                           05500000
         MVC   ISESTATE,SAVSTATE  RESTORE THE STATE FLAGS               05510000
         B     RETURN                                                   05520000
                                                                        05530000
*---------------------------------------------------------------------- 05540000
* RETURN TO CALLER                                                      05550000
*---------------------------------------------------------------------- 05560000
                                                                        05570000
RETURN   DS    0H                                                       05580000
                                                                        05590000
         LM    R15,R1,RETREGS     LOAD RETURN VALUES                    05600000
                                                                        05610000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    05620000
                                                                        05630000
*---------------------------------------------------------------------- 05640000
* ERROR ROUTINES                                                        05650000
*---------------------------------------------------------------------- 05660000
                                                                        05670000
ERRSESS  DS    0H                                                       05680000
                                                                        05690000
         $ABEND ABE_VTDIAG,                                            +05700000
               SCOPE=PCB,                                              +05710000
               TITLE='SESSION FAILURE'                                  05720000
                                                                        05730000
*---------------------------------------------------------------------- 05740000
*  CONSTANTS AND LITERALS                                               05750000
*---------------------------------------------------------------------- 05760000
                                                                        05770000
         LTORG ,                                                        05780000
         PRINT NOGEN                                                    05790000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                05800000
         ISTDBIND ,               VTAM BIND IMAGE                       05810000
         ISTRH ,                  VTAM SNA REQUEST HEADER               05820000
         ICVT  ,                  INTEGRATOR CVT                        05830000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   05840000
         IRPL ,                   INTEGRATOR VTAM RPL+                  05850000
         IACB ,                   INTEGRATOR VTAM ACB+                  05860000
         INIB ,                   INTEGRATOR VTAM NIB+                  05870000
         ISESS ,                  INTEGRATOR SESSION BLOCK              05880000
         IRQE ,                   INTEGRATOR RECEIVE QUEUE ELEMENT      05890000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            05900000
         ITASK ,                  INTEGRATOR TASK BLOCK                 05910000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          05920000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       05930000
         EVCODES ,                INTEGRATOR EVENT CODES                05940000
         ABCODES ,                INTEGRATOR $ABEND CODES               05950000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     05960000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        05970000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             05980000
         $PROC DSECT=YES          INTEGRATOR $PROC SERVICES             05990000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             06000000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             06010000
         IFGEXLST ,               VTAM EXIT LIST                        06020000
         END   ,                                                        06030000

L$UEPIL  TITLE 'SAS/C Function Exit'                                    00010000
*---------------------------------------------------------------------- 00020000
*                                                                       00030000
*  Pre-L$UEPIL logic:                                                   00040000
*                                                                       00050000
*      í L     1,4(,R13)      ù   (when needed) return ...              00060000
*      í ST    ?,16(0,1)      ù   (when needed) ... result (if any)     00070000
*                                                                       00080000
*        L     14,8(0,12)         CRABEPLG - epilog routine             00090000
*        BR    14                                                       00100000
*                                                                       00110000
*  Post-L$UEPIL logic:                                                  00120000
*        LR    13,1                                                     00130000
*        LM    14,5,12(13)                                              00140000
*        BR    14                                                       00150000
*                                                                       00160000
*  Post-L$UEPIL requirements:                                           00170000
*                                                                       00180000
*        R1 = prior save area address                                   00190000
*                                                                       00200000
*---------------------------------------------------------------------- 00210000
                                                                        00220000
         EQUS  ,                                                        00230000
                                                                        00240000
R_BASE   EQU   R2                      local base register              00250000
R_PRIOR  EQU   R3                      prior save area                  00260000
R_CPRLG  EQU   R4                      CPROLOG address                  00270000
                                                                        00280000
L$UEPIL  CSECT ,                       C function exit                  00290000
L$UEPIL  RMODE ANY                                                      00300000
L$UEPIL  AMODE ANY                                                      00310000
                                                                        00320000
         USING L$UEPIL,R14             R14 --> L$UEPIL (temporary)      00330000
         USING DSA,R13                 R13 --> "C" DSA                  00340000
         USING CRAB,R12                R12 --> CRAB                     00350000
                                                                        00360000
*---------------------------------------------------------------------- 00370000
* Pop stack and update the CRAB                                         00380000
*---------------------------------------------------------------------- 00390000
         L     R_PRIOR,4(,R13)         prior save area                  00400000
         L     R_CPRLG,DSAPRBSV        function's prolog address        00410000
         MVC   CRABCDSA,DSAPDSA        update CRAB to prior "C" DSA     00420000
         TM    DSAUSER_FLAG,DF$FRAME   first save area in the frame ?   00430000
         BO    FREEFRAM                yes, free the frame              00440000
*        MVC   0(4,R13),=C'SAVE'       set end-of-stack eyecatch        00450000
         B     EXIT                                                     00460000
                                                                        00470000
*---------------------------------------------------------------------- 00480000
* Free the frame                                                        00490000
*---------------------------------------------------------------------- 00500000
FREEFRAM DS    0H                                                       00510000
         L     R11,CRABUSR1                                             00520000
         USING ICVT,R11                R11 --> ICVT                     00530000
                                                                        00540000
         LR    R1,R13                                                   00550000
         @CALL IGENFSAV,CTYPE=CVT      free stack frame                 00560000
                                                                        00570000
         DROP  R14                     BASE REGISTER LOST               00580000
                                                                        00590000
*---------------------------------------------------------------------- 00600000
* Execute C-function exit                                               00610000
*---------------------------------------------------------------------- 00620000
EXIT     DS    0H                                                       00630000
         LR    R1,R_PRIOR              prior save area                  00640000
         LR    R14,R_CPRLG             prolog base address              00650000
         LM    R6,R12,DSAR6-DSA(R1)    restore registers                00660000
         B     CPROEXIT-CPROLOG(,R14)  execute function exit            00670000
                                                                        00680000
*---------------------------------------------------------------------- 00690000
* Constants                                                             00700000
*---------------------------------------------------------------------- 00710000
         LTORG                                                          00720000
                                                                        00730000
*---------------------------------------------------------------------- 00740000
* Data areas                                                            00750000
*---------------------------------------------------------------------- 00760000
         COPY  CPROLOG                 SAS/C PROLOG CODE                00770000
                                                                        00780000
         COPY  DSA                     SAS/C DYNAMIC SAVE AREA          00790000
DSAUSER_CSA  EQU DSAUSER,3                                              00800000
DSAUSER_FLAG EQU DSAUSER+3,1                                            00810000
DF$FRAME     EQU X'80'                 FIRST ALLOCATION OF FRAME        00820000
                                                                        00830000
         COPY  CRAB                    SAS/C RUNTIME ANCHOR BLOCK       00840000
                                                                        00850000
         PRINT NOGEN                                                    00860000
         ICVT  ,                                                        00870000
         PRINT GEN                                                      00880000
                                                                        00890000
         END                                                            00900000

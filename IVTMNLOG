IVTMNLOG TITLE 'INTEGRATOR - LOGON MAIN TASK EXTENSION'                 00010000
                                                                        00020000
         PRINT NOGEN                                                    00030000
         CMINCL ,                 INTEGRATOR CPI-C SERVICES             00040000
         L62INCL ,                INTEGRATOR LU6.2 SERVICES             00050000
         PRINT GEN                                                      00060000
                                                                        00070000
**<DOC-ON>************************************************************* 00080000
*                                                                       00090000
* ROUTINE: IVTMNLOG - INTEGRATOR LOGON MAIN TASK EXTENSION              00100000
*                                                                       00110000
* DESCRIPTION:                                                          00120000
*                                                                       00130000
* ON ENTRY:                                                             00140000
*                                                                       00150000
*    R15 = ENTRY POINT ADDRESS                                          00160000
*    R14 = RETURN ADDRESS                                               00170000
*    R13 = AVAILABLE SAVE AREA                                          00180000
*    R11 = ICVT ADDRESS                                                 00190000
*    R10 = ITASK ADDRESS                                                00200000
*    R01 = IWE ADDRESS (WORK ELEMENT)                                   00210000
*                                                                       00220000
* ON EXIT:                                                              00230000
*                                                                       00240000
*    R15 = 0                                                            00250000
*    R00 = 0                                                            00260000
*    R01 = 0                                                            00270000
*                                                                       00280000
*    ALL OTHER REGISTERS ARE RESTORED                                   00290000
*                                                                       00300000
**<DOC-OFF>************************************************************ 00310000
                                                                        00320000
         EJECT ,                                                        00330000
*********************************************************************** 00340000
*                                                                       00350000
* MAINTENANCE:                                                          00360000
*                                                                       00370000
*   08/01/93 RANDY WITEK                                                00380000
*   07/01/94 RANDY WITEK - LU6.2 SUPPORT                                00390000
*   09/07/95 RANDY WITEK - SPECIAL HANDLING FOR START-UP WORK ELEMENT   00400000
*                                                                       00410000
*********************************************************************** 00420000
                                                                        00430000
         EQUS  ,                  GENERAL EQUATES                       00440000
                                                                        00450000
RICVT    EQU   R11                                                      00460000
RITASK   EQU   R10                                                      00470000
RIVTAM   EQU   R9                                                       00480000
RIACB    EQU   R8                                                       00490000
RIRPL    EQU   R7                                                       00500000
RIVUSER  EQU   R6                                                       00510000
RISESS   EQU   R6              -- REDEFINITION OF R6                    00520000
RIWE     EQU   R5                                                       00530000
RISQE    EQU   R4                                                       00540000
                                                                        00550000
         USING ICVT,RICVT         ESTABLISH ADDRESSABILITY              00560000
         USING ITASK,RITASK       ESTABLISH ADDRESSABILITY              00570000
         USING IVTAMCVT,RIVTAM    ESTABLISH ADDRESSABILITY              00580000
         USING IACB,RIACB         ESTABLISH ADDRESSABILITY              00590000
         USING IRPL,RIRPL         ESTABLISH ADDRESSABILITY              00600000
         USING IVUSER,RIVUSER     ESTABLISH ADDRESSABILITY              00610000
         USING IWEVTAM,RIWE       ESTABLISH ADDRESSABILITY              00620000
         USING ISQE,RISQE         ESTABLISH ADDRESSABILITY              00630000
                                                                        00640000
WORKAREA #WORK ,                  READ/WRITE WORKAREA                   00650000
SUB0SAVE DS    18F                SUBROUTINE SAVE AREA                  00660000
SAVISESS DS    A                  ISESS ASSOCIATED W/SOLICITED SESSION  00670000
SAVEATOK DS    CL8                TOKEN OF SESSION REQUESTOR            00680000
SAVEENT  DS    XL8                ENTITY TOKEN OF SESSION REQUESTOR     00690000
SAVESPL  DS    A                  SPL ADDRESS OF SESSION REQUESTOR      00700000
SAVEQTOK DS    F                  VALIDATED ISQE TOKEN                  00710000
$TASKMFL $TASK MF=L               PLIST CONSTRUCTION                    00720000
$RMGRMFL $RESMGR MF=L             PLIST CONSTRUCTION                    00730000
$SESSMFL $SESS MF=L               PLIST CONSTRUCTION                    00740000
$WUMFL   $WULOC MF=L              PLIST CONSTRUCTION                    00750000
L62MFL   L62DFMD MF=L             PLIST CONSTRUCTION                    00760000
L62RETRC DS    F                  LU6.2 RETURN CODE RETURN AREA         00770000
WRK256   DS    XL256              GENERAL WORKAREA                      00780000
WUDATA   DS    XL16               $WULOC USERDATA RETURN AREA           00790000
NEWTSKNM DS    A                  ADDRESS OF NAME FOR NEW ITASK         00800000
RETPLB   DS    F                  LU6.2 PLB ADDRESS RETURN AREA         00810000
RETCODE  DS    F                  LU6.2 RETURN_CODE RETURN AREA         00820000
RETR15   DS    F                  RETURN CODE VALUE                     00830000
RETR0    DS    F                  RETURN REGISTER 0                     00840000
RETR1    DS    F                  RETURN REGISTER 1                     00850000
RETREGS  EQU   RETR15,*-RETR15    INCLUSIVE SYMBOL                      00860000
FLAG     DS    X                                                        00870000
FLAGLOCK EQU   X'80'              VTAM GLOBAL LOCK HELD                 00880000
FLAGLCKD EQU   X'40'              VTAM GLOBAL LOCK HELD ON ENTRY        00890000
FLAG62LG EQU   X'20'              PROCESSING LU6.2 LOGON                00900000
FLAGDLCK EQU   X'10'              DISP LOCK HELD                        00910000
FLAGDLKD EQU   X'08'              DISP LOCK WAS HELD ON ENTRY           00920000
WORKLEN  #ENDWORK                 END OF WORKAREA                       00930000
                                                                        00940000
         $MSGDFT PREFIX=ICTPID,                                        +00950000
               COMPID='VTM',                                           +00960000
               TABLE=*#MSGS,                                           +00970000
               WORKA=0,                                                +00980000
               MF=(E,WRK256),                                          +00990000
               PRINT=NOGEN                                              01000000
                                                                        01010000
IVTMNLOG #ENTER BASE=R12,         ENTRY LINKAGE                        +01020000
               AMODE=31,                                               +01030000
               PREG=(RIWE),                                            +01040000
               RMODE=ANY                                                01050000
                                                                        01060000
         SR    RIACB,RIACB           NO IACB YET                        01070000
                                                                        01080000
         CLC   IWELCODE,=A(IWECXLOG) IS IT A USER+SESSION INITIATION    01090000
         BE    LOGON                 BRANCH IF YES                      01100000
         CLC   IWELCODE,=A(IWECSIRQ) IS IT A USER+SESSION INITIATION    01110000
         BNE   ERRWORK               BRANCH IF NOT, ERROR               01120000
                                                                        01130000
*---------------------------------------------------------------------- 01140000
* SESSION INITIATION REQUEST WORK ELEMENT                               01150000
*---------------------------------------------------------------------- 01160000
                                                                        01170000
         LA    R1,IWEXKLU         TASK NAME WILL BE PARTNER LU NAME     01180000
         ST    R1,NEWTSKNM        THIS NAME USED FOR $TASK CREATE       01190000
         TM    ICTSTAT3,ICT3$P+ICT3$PX SYSTEM SHUTDOWN?                 01200000
         BNZ   SESSFAIL           BRANCH IF YES                         01210000
         TM    IVTF1,IVTF1TRM     IS TERMINATION UNDERWAY?              01220000
         BNO   ALLOCIVU           BRANCH IF NOT                         01230000
                                                                        01240000
SESSFAIL DS    0H                                                       01250000
                                                                        01260000
         OC    IWEXKTOK,IWEXKTOK  IS THERE AN ASSOCIATED REQUESTOR?     01270000
         BZ    SFNOASSC           CHECK FOR ENTITY/SPL IF NO TOKEN      01280000
         MVC   SAVEATOK,IWEXKTOK  SAVE REQUESTOR'S TOKEN                01290000
         BAS   R14,VTAMLOCK       SERIALIZE                             01300000
         B     REJPOST            AND FLUSH THE REQUESTOR               01310000
                                                                        01320000
SFNOASSC DS    0H                                                       01330000
                                                                        01340000
         OC    IWEXKENT,IWEXKENT  IS THERE AN ENTITY TOKEN?             01350000
         BZ    RETURN             JUST IGNORE IF NOT                    01360000
         MVC   SAVEENT,IWEXKENT   SAVE REQUESTOR'S ENTITY TOKEN         01370000
         MVC   SAVESPL,IWEXKSPL   SAVE REQUESTOR'S SPL ADDRESS          01380000
         B     REJPOST            AND FLUSH THE REQUESTOR               01390000
                                                                        01400000
*---------------------------------------------------------------------- 01410000
* LOGON EXIT WORK ELEMENT.  DETERMINE IF THIS IS A SOLICITED LOGON.     01420000
*---------------------------------------------------------------------- 01430000
                                                                        01440000
LOGON    DS    0H                                                       01450000
                                                                        01460000
         L     RIACB,IWEX2ACB     REFERENCE TO ACB                      01470000
         ICM   RISQE,15,IWEX2USR  IS THIS A SOLICITED LOGON?            01480000
         BM    SOLLOGON           BRANCH IF YES                         01490000
                                                                        01500000
*---------------------------------------------------------------------- 01510000
* PROCESS UNSOLICITED LOGON (E.G. NORMAL END-USER LOGON)                01520000
*---------------------------------------------------------------------- 01530000
                                                                        01540000
         LA    R1,IWEX2LU         TASK NAME IS THE SLU NAME             01550000
         ST    R1,NEWTSKNM        THIS NAME USED FOR $TASK CREATE       01560000
                                                                        01570000
         $MSG  999,                                                    +01580000
               FIELDS=((IWEX2LU,8),                                    +01590000
               (IACNAME,8),                                            +01600000
               (IWEX2CID,4),                                           +01610000
               (IWEX2USR,4))      "VTAM LOGON EXIT FOR..."              01620000
                                                                        01630000
         TM    ICTSTAT3,ICT3$P+ICT3$PX SYSTEM SHUTDOWN?                 01640000
         BNZ   REJECT             BRANCH IF YES                         01650000
         TM    IVTF1,IVTF1TRM     IS TERMINATION UNDERWAY?              01660000
         BO    REJECT             BRANCH IF YES                         01670000
                                                                        01680000
*                                                                       01690000
* SPECIAL HANDLING FOR LU6.2 UNSOLICITED LOGONS                         01700000
*---------------------------------------------------------------------- 01710000
                                                                        01720000
X        USING ISTDBIND,IWEX2RU+12                                      01730000
                                                                        01740000
         CLI   X.BINLUP,X'06'     LU TYPE 6?                            01750000
         BNE   ALLOCIVU           BRANCH IF NOT                         01760000
         CLI   X.BINPSCHR,X'02'   TYPE 6.2?                             01770000
         BNE   ALLOCIVU           BRANCH IF NOT                         01780000
                                                                        01790000
         DROP  X                                                        01800000
                                                                        01810000
         TM    IACF1,IACF162      IS THIS ACB FOR LU6.2 SESSIONS?       01820000
         BNO   REJECT             BRANCH IF NOT                         01830000
                                                                        01840000
         L62DSPL (RIACB),                                              +01850000
               IWEX2LU,                                                +01860000
               =F'8',                                                  +01870000
               RETPLB,                                                 +01880000
               RETCODE,                                                +01890000
               MF=(E,MFE_LIST)    SEE IF THERE IS A PLB ALREADY         01900000
                                                                        01910000
         OC    RETCODE,RETCODE    GOOD RETURN CODE (I.E. FOUND?)?       01920000
         BZ    GOTPLB             BRANCH IF YES                         01930000
                                                                        01940000
         L62DFPL (RIACB),                                              +01950000
               IWEX2LU,                                                +01960000
               =F'8',                                                  +01970000
               RETPLB,                                                 +01980000
               RETCODE,                                                +01990000
               MF=(E,MFE_LIST)    CREATE PLB/TASK FOR LU6.2 PARTNER     02000000
                                                                        02010000
         OC    RETCODE,RETCODE    GOOD RETURN CODE?                     02020000
         BZ    GOTPLB             BRANCH IF YES                         02030000
         CLC   RETCODE,=A(LU62_PRODUCT_SPECIFIC_ERROR) MAYBE A RACE?    02040000
         BNE   REJECT             BRANCH IF NOT A POSSIBLE RACE         02050000
                                                                        02060000
         L62DSPL (RIACB),                                              +02070000
               IWEX2LU,                                                +02080000
               =F'8',                                                  +02090000
               RETPLB,                                                 +02100000
               RETCODE,                                                +02110000
               MF=(E,MFE_LIST)    SEE IF THERE IS A PLB ALREADY         02120000
                                                                        02130000
         OC    RETCODE,RETCODE    DID WE FIND IT THIS TIME?             02140000
         BNZ   REJECT             BRANCH IF NOT                         02150000
                                                                        02160000
GOTPLB   DS    0H                                                       02170000
                                                                        02180000
         OI    FLAG,FLAG62LG      SHOW WE ARE PROCESSING LU6.2 LOGON    02190000
         L     RIVUSER,RETPLB     PLB ADDRESS                           02200000
         B     LOGNWORK           AND CONTINUE                          02210000
                                                                        02220000
*                                                                       02230000
* ALLOCATE THE IVUSER BLOCK FOR NON-LU                                  02240000
*---------------------------------------------------------------------- 02250000
                                                                        02260000
ALLOCIVU DS    0H                                                       02270000
                                                                        02280000
         LTR   RIACB,RIACB        SESSION INITIATION?                   02290000
         BZ    AIVUCONT           BRANCH IF YES                         02300000
         TM    IACF1,IACF162      IS THIS ACB FOR LU6.2 SESSIONS?       02310000
         BO    REJECT             BRANCH IF YES, DON'T ALLOW IT         02320000
                                                                        02330000
AIVUCONT DS    0H                                                       02340000
                                                                        02350000
         LA    R3,L'IVU           ALLOCATE AN IVUSER BLOCK              02360000
                                                                        02370000
         $GETSTOR (R3),                                                +02380000
               LOC=ANY,                                                +02390000
               OWNER=(RITASK)                                           02400000
                                                                        02410000
         LR    RIVUSER,R1         REFERENCE TO IVUSER BLOCK             02420000
         MVC   IVUID,=CL8'IVUSER' SET EYECATCHER                        02430000
         ST    R3,IVULEN          SET THE LENGTH                        02440000
                                                                        02450000
         L     R1,IVTTKUSR        LAST IVUSER TOKEN                     02460000
         AL    R1,=F'1'           NEXT IVUSER TOKEN                     02470000
         ST    R1,IVTTKUSR        UPDATE LAST IVUSER TOKEN              02480000
         ST    R1,IVUTKUSR        SET THE IVUSER TOKEN WORD             02490000
                                                                        02500000
         LA    R1,IVUIS1ST        INITIALIZE USER SESSION CHAIN         02510000
         S     R1,=A(ISENEXT-ISE) NORMALIZE THE NULL HEADER             02520000
         O     R1,=X'80000000'    HI BIT ON FOR NULL HEADER             02530000
         ST    R1,IVUIS1ST        SET HEADER                            02540000
         ST    R1,IVUISLST        SET HEADER                            02550000
                                                                        02560000
         $VTAM ADDUSER,           ADD IVUSER TO LOOKUP TABLE           +02570000
               AREA=(RIVUSER),    PASS ADDRESS OF IVUSER BLOCK         +02580000
               ERRET=ERR$VTAM,    IF AN ERROR                          +02590000
               MF=(E,MFE_LIST)    USE STANDARD PARMLIST AREA            02600000
                                                                        02610000
*                                                                       02620000
* CREATE A NEW SUBTASK FOR THE IVUSER                                   02630000
*---------------------------------------------------------------------- 02640000
                                                                        02650000
         $TASK SETEPB,            INITIALIZE TASK TERMINATION EPB      +02660000
               ECODE=EC$VTUT,     USER TERMINATION IS THE CODE         +02670000
               ERRET=ERR$TASK,                                         +02680000
               MF=(E,$TASKMFL)                                          02690000
                                                                        02700000
         LR    R3,R1              TASK TERMINATION EPB ADDRESS          02710000
         L     R2,=F'-1'          DPMOD VALUE FOR $TASK CREATE          02720000
                                                                        02730000
         $TASK CREATE,            CREATE THE IVUSER SUBTASK            +02740000
               EP=*IVT@USER,      PROC MAIN CODE FOR IVUSER SUBTASK    +02750000
               NAME=*NEWTSKNM,    LOGON=SLUNAME, SIRQ='INDEPUSR'       +02760000
               PARM=(RIVUSER),    PASS IVUSER AS PARM                  +02770000
               SYNC=YES,          WAIT FOR SUBTASK TO START            +02780000
               TERMEPB=(R3),      POST THIS EPB WHEN SUBTASK IS GONE   +02790000
               DPMOD=(R2),        DISPATCH AT SLIGHTLY LOWER PRIORITY  +02800000
               ERRET=ERR$TASK,                                         +02810000
               MF=(E,$TASKMFL)                                          02820000
                                                                        02830000
         LR    R3,R1              NEW ITASK ADDRESS                     02840000
                                                                        02850000
         $SER  OBTAIN,                                                 +02860000
               DISP                                                     02870000
                                                                        02880000
         $RESMGR ADD,             ADD A RESOURCE MANAGER               +02890000
               TOKEN=IVURMTOK,    PLACE RESOURCE MANAGER TOKEN HERE    +02900000
               OWNER=(R3),        FOR THE NEW ITASK                    +02910000
               ROUTINE=*IVT@UMGR, RESOURCE MANAGER CODE IS IVTMUMGR    +02920000
               PARM=(RIVUSER),    R1 WILL POINT TO THE IVUSER BLOCK    +02930000
               MF=(E,$RMGRMFL)                                          02940000
                                                                        02950000
         $SER  RELEASE,                                                +02960000
               DISP                                                     02970000
                                                                        02980000
         ST    RIVUSER,TSKIVUSR-ITASK(,R3) LINK IVUSER TO ITASK         02990000
         ST    R3,IVUITASK        SET ITASK ADDRESS IN IVUSER BLOCK     03000000
         L     R1,NEWTSKNM        NAME USED FOR $TASK CREATE            03010000
         MVC   IVUITSKN,0(R1)     SET ITASK NAME    IN IVUSER BLOCK     03020000
                                                                        03030000
         CLC   IWELCODE,=A(IWECXLOG) WAS THIS A LOGON?                  03040000
         BE    LOGNWORK              BRANCH IF YES                      03050000
                                                                        03060000
*                                                                       03070000
* ALLOCATE THE SESSION INITIATION REQUEST WORK ELEMENT FOR IVUSER WORK  03080000
*---------------------------------------------------------------------- 03090000
                                                                        03100000
         $VTAMWE *IWELEN,         SIZE                                 +03110000
               IWECSIRQ           CODE                                  03120000
                                                                        03130000
L        USING IWE,R3             REFERENCE TO SIRQ IWE                 03140000
                                                                        03150000
         LR    R3,R1              ESTABLISH ADDRESSIBILITY              03160000
         LR    R0,R1              COPY-TO   ADDRESS                     03170000
         L     R1,IWELEN          COPY-TO   LENGTH                      03180000
         LR    R14,RIWE           COPY-FROM ADDRESS                     03190000
         LR    R15,R1             COPY-FROM LENGTH                      03200000
         MVCL  R0,R14             COPY THE WORK ELEMENT                 03210000
         XC    L.IWELINK,L.IWELINK NO WE'S LINKED TO THE NEW COPY       03220000
         XC    L.IWEECB,L.IWEECB  ENSURE ECB CLEAR IN NEW COPY          03230000
                                                                        03240000
         DROP  L                  REFERENCE TO STAGING & LOGON IWE'S    03250000
                                                                        03260000
         B     POSTUSER           GET THE IVUSER TASK RUNNING           03270000
                                                                        03280000
*                                                                       03290000
* ALLOCATE THE LOGON WORK ELEMENT FOR IVUSER WORK                       03300000
*---------------------------------------------------------------------- 03310000
                                                                        03320000
LOGNWORK DS    0H                                                       03330000
                                                                        03340000
         L     R2,IWELEN          SIZE OF THIS LOGON WORK ELEMENT       03350000
                                                                        03360000
         $VTAMWE (R2),            SIZE                                 +03370000
               IWECXLOG           CODE                                  03380000
                                                                        03390000
L        USING IWE,R3             REFERENCE TO LOGON IWE                03400000
                                                                        03410000
         LR    R3,R1              ESTABLISH ADDRESSIBILITY              03420000
         LR    R0,R1              COPY-TO   ADDRESS                     03430000
         L     R1,IWELEN          COPY-TO   LENGTH                      03440000
         LR    R14,RIWE           COPY-FROM ADDRESS                     03450000
         LR    R15,R1             COPY-FROM LENGTH                      03460000
         MVCL  R0,R14             COPY THE LOGON WORK ELEMENT           03470000
         XC    L.IWELINK,L.IWELINK NO WE'S LINKED TO THE NEW COPY       03480000
         XC    L.IWEECB,L.IWEECB  ENSURE ECB CLEAR IN NEW COPY          03490000
                                                                        03500000
         LA    RIRPL,IWEX2RPL     ADDRESS OF ORIGINAL RPL COPY AREA     03510000
         L     R2,RPLAAREA        ADDRESS OF CV'S                       03520000
         S     R2,RPLAREA         OFFSET  OF CV'S                       03530000
                                                                        03540000
         LA    RIRPL,L.IWEX2RPL   ADDRESS OF NEW RPL COPY AREA          03550000
         LA    R1,L.IWEX2RU       ADDRESS OF NEW CINIT COPY AREA        03560000
         ST    R1,RPLAREA         SET CINIT ADDRESS IN NEW RPL COPY     03570000
         AR    R1,R2              ADDRESS OF CV'S IN NEW RPL COPY       03580000
         ST    R1,RPLAAREA        SET CV'S ADDRESS IN NEW RPL COPY      03590000
                                                                        03600000
         DROP  L                  REFERENCE TO STAGING & LOGON IWE'S    03610000
                                                                        03620000
         B     POSTUSER           GET THE IVUSER TASK RUNNING           03630000
                                                                        03640000
*                                                                       03650000
* POST THE NEW TASK FOR LOGON STARTUP (OR QUEUE WE FOR LU6.2 LOGON)     03660000
*---------------------------------------------------------------------- 03670000
                                                                        03680000
POSTUSER DS    0H                                                       03690000
                                                                        03700000
         TM    FLAG,FLAG62LG      IS THIS LU6.2 LOGON?                  03710000
         BO    QLOGON             BRANCH IF YES                         03720000
                                                                        03730000
         ST    R3,IVUWEQ          SET WE FOR THE IVUSER TASK            03740000
         ST    R3,IVU1STWE        SET FIRST WORK ELEMENT ADDRESS 090795 03750000
                                                                        03760000
         POST  IVUSTECB,LINKAGE=SYSTEM                                  03770000
                                                                        03780000
         B     RETURN                                                   03790000
                                                                        03800000
QLOGON   DS    0H                                                       03810000
                                                                        03820000
         LR    R1,R3              WORK ELEMENT ADDRESS                  03830000
         LA    R0,IVUWEQ          IVUSER WORK QUEUE                     03840000
         BAS   R14,QWE            GO QUEUE THE LOGON WORK ELEMENT       03850000
         B     RETURN             AND RETURN                            03860000
                                                                        03870000
*---------------------------------------------------------------------- 03880000
* A SOLICITED LOGON IS BEING PROCESSED.                                 03890000
* QUEUE LOGON WORK ELEMENT TO EXISTING ISESS.                           03900000
*---------------------------------------------------------------------- 03910000
                                                                        03920000
         DROP  RIVUSER                                                  03930000
                                                                        03940000
         USING ISESS,RISESS                                             03950000
                                                                        03960000
SOLLOGON DS    0H                                                       03970000
                                                                        03980000
         BAS   R14,VTAMLOCK          SERIALIZE                          03990000
                                                                        04000000
         LA    RISQE,0(,RISQE)       CLEAR THE HI-ORDER BIT             04010000
         ST    RISQE,SAVEQTOK        SAVE THE ISQE TOKEN                04020000
                                                                        04030000
         $VTAM LOCISQE,                                                +04040000
               AREA=SAVEQTOK,                                          +04050000
               ERRET=NOISQE,                                           +04060000
               MF=(E,MFE_LIST)       LOCATE THE ISQE                    04070000
                                                                        04080000
         LR    RISQE,R1              ISQE ADDRESS RETURNED              04090000
         MVC   SAVEATOK,ISQATOK      SAVE SESSION TOKEN OF REQUESTOR    04100000
         MVC   SAVEENT,ISQENT        SAVE ENTITY TOKEN OF REQUESTOR     04110000
         MVC   SAVESPL,ISQSPL        SAVE SPL ADDRESS OF REQUESTOR      04120000
                                                                        04130000
         $SESS $SESS_FIND_SESSION,                                     +04140000
               SESSION=ISQSTOK,                                        +04150000
               ERRET=REJECT,                                           +04160000
               MF=(E,$SESSMFL)       RETRIEVE THE ISESS BLOCK           04170000
                                                                        04180000
X        USING SPLIST,$SESSMFL                                          04190000
         L     RISESS,X.SPLAREA      ADDRESS OF ISESS BLOCK             04200000
         DROP  X                                                        04210000
                                                                        04220000
         ST    RISESS,SAVISESS       SAVE ISESS OF SOLICITED SESSION    04230000
         B     GOTISESS              PASS PENDING BIND TO ISESS         04240000
                                                                        04250000
NOISQE   DS    0H                                                       04260000
                                                                        04270000
         XC    SAVEQTOK,SAVEQTOK     NO VALIDATED ISQE TOKEN            04280000
         B     REJECT                KILL THE PENDING LOGON             04290000
                                                                        04300000
*---------------------------------------------------------------------- 04310000
* THE RECIPIENT ISESS WAS LOCATED.  QUEUE THE LOGON WORK ELEMENT.       04320000
*---------------------------------------------------------------------- 04330000
                                                                        04340000
GOTISESS DS    0H                                                       04350000
                                                                        04360000
*                                                                       04370000
* ALLOCATE THE LOGON WORK ELEMENT TO KICK-START THE ISESS WORK          04380000
*---------------------------------------------------------------------- 04390000
                                                                        04400000
         $VTAMWE *IWELEN,               SIZE                           +04410000
               IWECXLOG                 CODE                            04420000
                                                                        04430000
L        USING IWE,R3                   REFERENCE TO LOGON IWE          04440000
                                                                        04450000
         LR    R3,R1                    ESTABLISH ADDRESSIBILITY        04460000
         LR    R0,R3                    COPY-TO   ADDRESS               04470000
         L     R1,IWELEN                COPY-TO   LENGTH                04480000
         LR    R14,RIWE                 COPY-FROM ADDRESS               04490000
         LR    R15,R1                   COPY-FROM LENGTH                04500000
         MVCL  R0,R14                   COPY THE LOGON WORK ELEMENT     04510000
         XC    L.IWELINK,L.IWELINK      NO WE'S LINKED TO NEW COPY      04520000
         XC    L.IWEECB,L.IWEECB        ENSURE ECB CLEAR IN NEW COPY    04530000
                                                                        04540000
         LA    RIRPL,IWEX2RPL           ADDR OF ORIGINAL RPL COPY AREA  04550000
         L     R2,RPLAAREA              ADDRESS OF CV'S                 04560000
         S     R2,RPLAREA               OFFSET  OF CV'S                 04570000
                                                                        04580000
         LA    RIRPL,L.IWEX2RPL         ADDR OF NEW RPL COPY AREA       04590000
         LA    R1,L.IWEX2RU             ADDR OF NEW CINIT COPY AREA     04600000
         ST    R1,RPLAREA               SET CINIT ADDR IN NEW RPL COPY  04610000
         AR    R1,R2                    ADDR OF CV'S IN NEW RPL COPY    04620000
         ST    R1,RPLAAREA              SET CV'S ADDR IN NEW RPL COPY   04630000
                                                                        04640000
         DROP  L                        REF. TO LOGON IWE               04650000
                                                                        04660000
*                                                                       04670000
* QUEUE THE LOGON WORK ELEMENT TO THE ISESS.                            04680000
* IF QUEUEING FAILS, TRIGGER THE DESTRUCTION OF THE ISESS INSTANCE.     04690000
*---------------------------------------------------------------------- 04700000
                                                                        04710000
         LR    R1,R3                    WORK ELEMENT ADDRESS            04720000
         LA    R0,ISEWEQ                QUEUE ADDRESS                   04730000
         BAS   R14,QWE                  GO TRY TO QUEUE THE WE          04740000
         LTR   R15,R15                  WAS QUEUEING SUCCESSFUL?        04750000
         BNZ   REJECT                   BRANCH IF NOT                   04760000
         B     RETURN                   ALL DONE                        04770000
                                                                        04780000
*---------------------------------------------------------------------- 04790000
* THE RECIPIENT ISESS COULD NOT BE LOCATED.  KILL THE PENDING LOGON.    04800000
*---------------------------------------------------------------------- 04810000
                                                                        04820000
REJECT   DS    0H                                                       04830000
                                                                        04840000
         $VTAMWE L'IWEXL,                                              +04850000
               IWECKILL             ALLOCATE "KILL SESSION" WE          04860000
                                                                        04870000
X        USING IWE,R1                                                   04880000
         MVC   X.IWEXLCID,IWEX2CID  PASS THE SESSION CID TO KILL        04890000
         ST    RIACB,X.IWEXLACB     PASS THE SESSION ACB ADDRESS        04900000
         MVC   X.IWEXLSNM,IWEX2LU   PASS SLU NAME                       04910000
         MVC   X.IWEXLPNM,IACNAME   PASS PLU NAME                       04920000
         LA    R0,IVTWEQ            WORK QUEUE ADDRESS                  04930000
         BAS   R14,QWE              QUEUE KILL SESSION ELEMENT TO MAIN  04940000
         DROP  X                                                        04950000
                                                                        04960000
*                                                                       04970000
* PENDING LOGON WAS REJECTED.  IF THERE IS AN ASSOCIATED REQUESTOR      04980000
* SESSION, QUEUE A SESS INIT COMPLETION WORK ELEMENT TO THAT ISESS      04990000
* -OR- POST THE SPL IF AN ASSOCIATED ENTITY TOKEN IS PRESENT.           05000000
*---------------------------------------------------------------------- 05010000
                                                                        05020000
REJPOST  DS    0H                                                       05030000
                                                                        05040000
         OC    SAVEATOK,SAVEATOK    ASSOCIATED REQUESTOR SESSION TOKEN? 05050000
         BZ    REJNOSTK             BRANCH IF NOT                       05060000
                                                                        05070000
         $SESS $SESS_FIND_SESSION,                                     +05080000
               SESSION=SAVEATOK,                                       +05090000
               ERRET=NOASSOC,                                          +05100000
               MF=(E,$SESSMFL)      LOCATE ASSOCIATED ISESS             05110000
                                                                        05120000
X        USING SPLIST,$SESSMFL                                          05130000
         L     R3,X.SPLAREA         ADDRESS OF ASSOCIATED ISESS BLOCK   05140000
         DROP  X                                                        05150000
                                                                        05160000
         LA    R3,ISEWEQ-ISE(,R3)   ADDRESS OF ASSOCIATED WORK QUEUE    05170000
                                                                        05180000
         $VTAMWE L'IWEXM,           SIZE                               +05190000
               IWECSICM             CODE (SESS INIT COMPLETION)         05200000
                                                                        05210000
X        USING IWEVTAM,R1                                               05220000
         MVC   X.IWEXMRET,=A($SESS_RC_CANCELED)                         05230000
         MVC   X.IWEXMATK,SAVEATOK  SET ASSOCIATED SESSION TOKEN        05240000
         DROP  X                                                        05250000
                                                                        05260000
         LR    R0,R3                QUEUE ADDRESS                       05270000
         BAS   R14,QWE              GO QUEUE THE WORK ELEMENT           05280000
         B     NOASSOC                                                  05290000
                                                                        05300000
REJNOSTK DS    0H                                                       05310000
                                                                        05320000
         OC    SAVEENT,SAVEENT    REQUESTOR ENTITY TOKEN?               05330000
         BZ    NOASSOC            BRANCH IF NOT                         05340000
                                                                        05350000
         BAS   R14,DISPLOCK       SERIALIZE                             05360000
                                                                        05370000
         $WULOC LOCATE,           FIND THE WORK UNIT                   +05380000
               TOKEN=SAVEENT,     WORK UNIT TOKEN ADDRESS              +05390000
               USERDATA=WUDATA,   XL16 AREA TO RECEIVE USER DATA       +05400000
               MF=(E,$WUMFL)      VALIDATE WORK UNIT                    05410000
                                                                        05420000
         LTR   R15,R15            LOCATE SUCCESS?                       05430000
         BNZ   L62POST            BRANCH IF NOT                         05440000
                                                                        05450000
         L     R1,SAVESPL         REQUESTOR'S SPL ADDRESS               05460000
X        USING SPLIST,R1                                                05470000
         MVC   X.SPLRETCD,=A($SESS_RC_CANCELED)                         05480000
         L     R2,X.SPLEPB        REQUESTOR'S EPB ADDRESS               05490000
         L     R15,IVT@ATSP       $SESS TRACE ROUTINE                   05500000
         BASR  R14,R15            TRACE THE SPLIST                      05510000
         DROP  X                                                        05520000
                                                                        05530000
L62POST  DS    0H                                                       05540000
                                                                        05550000
         L62POST (R2),            ADDRESS OF EPB TO BE POSTED          +05560000
               =F'0',             ADDRESS OF POST CODE                 +05570000
               SAVEENT,           ADDRESS OF ENTITY TOKEN              +05580000
               L62RETRC,          RETURN CODE AREA                     +05590000
               MF=(E,L62MFL)                                            05600000
                                                                        05610000
         BAS   R14,DISPUNLK           RELEASE THE LOCK IF NECESSARY     05620000
                                                                        05630000
NOASSOC  DS    0H                                                       05640000
                                                                        05650000
*                                                                       05660000
* PENDING LOGON WAS REJECTED.                                           05670000
* QUEUE AN END SESSION WORK ELEMENT TO THE ISESS WORK QUEUE.            05680000
*---------------------------------------------------------------------- 05690000
                                                                        05700000
         ICM   RISESS,15,SAVISESS ISESS FOR SOLICITED SESSION?          05710000
         BZ    NOSOLISE           BRANCH IF NOT                         05720000
                                                                        05730000
         $VTAMWE L'IWEXH,         SIZE                                 +05740000
               IWECENDS           CODE                                  05750000
                                                                        05760000
         LA    R0,ISEWEQ          QUEUE ADDRESS                         05770000
         BAS   R14,QWE            GO QUEUE THE WORK ELEMENT             05780000
                                                                        05790000
NOSOLISE DS    0H                                                       05800000
                                                                        05810000
*                                                                       05820000
* PENDING LOGON WAS REJECTED.                                           05830000
* DELETE THE ISQE FROM THE CHAIN AND RELEASE THE STORAGE.               05840000
*---------------------------------------------------------------------- 05850000
                                                                        05860000
         OC    SAVEQTOK,SAVEQTOK  VALIDATED ISQE TOKEN?                 05870000
         BZ    RETNISQE           BRANCH IF NO ISQE                     05880000
                                                                        05890000
         $VTAM RETISQE,                                                +05900000
               AREA=SAVEQTOK,     ADDRESS OF ISQE TOKEN                +05910000
               MF=(E,MFE_LIST)    DELETE THE ISQE                       05920000
                                                                        05930000
RETNISQE DS    0H                                                       05940000
                                                                        05950000
*---------------------------------------------------------------------- 05960000
* RETURN TO MAIN TASK MAINLINE                                          05970000
*---------------------------------------------------------------------- 05980000
                                                                        05990000
RETURN   DS    0H                                                       06000000
                                                                        06010000
         BAS   R14,VTAMUNLK       RELEASE THE LOCK IF NECESSARY         06020000
                                                                        06030000
         LM    R15,R1,RETREGS     LOAD RETURN REGISTERS                 06040000
                                                                        06050000
         #EXIT R1=YES             RETURN W/R15,R0,R1                    06060000
                                                                        06070000
*---------------------------------------------------------------------- 06080000
* SUBROUTINE QWE - QUEUE A WORK ELEMENT TO A GIVEN WORK QUEUE           06090000
*                                                                       06100000
* ENTRY            R14 = RETURN ADDRESS                                 06110000
*                  R1  = WORK ELEMENT ADDRESS                           06120000
*                  R0  = QUEUE ADDRESS                                  06130000
*                                                                       06140000
* RETURNS          R15 = 0 --> QUEUEING WAS SUCCESSFUL                  06150000
*                      = 4 --> QUEUEING FAILED, WORK ELEMENT RELEASED   06160000
*---------------------------------------------------------------------- 06170000
                                                                        06180000
QWE      DS    0H                                                       06190000
                                                                        06200000
         STM   R14,R4,SUB0SAVE    SAVE REGISTERS                        06210000
         LR    R3,R0              SAVE QUEUE ADDRESS                    06220000
         LR    R4,R1              SAVE WORK ELEMENT ADDRESS             06230000
                                                                        06240000
         $VTAMQ (R4),             WORK ELEMENT                         +06250000
               (R3)               QUEUE                                 06260000
                                                                        06270000
         L     R14,SUB0SAVE       RESTORE REGISTERS                     06280000
         LM    R0,R4,SUB0SAVE+8   RESTORE REGISTERS                     06290000
         BR    R14                AND RETURN TO CALLER W/R15            06300000
                                                                        06310000
*---------------------------------------------------------------------- 06320000
*   SUBROUTINE: OBTAIN VTAM GLOBAL LOCK                                 06330000
*---------------------------------------------------------------------- 06340000
                                                                        06350000
VTAMLOCK DS    0H                                                       06360000
                                                                        06370000
         TM    FLAG,FLAGLOCK        WAS THE LOCK ALREADY OBTAINED?      06380000
         BOR   R14                  RETURN IF YES                       06390000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             06400000
                                                                        06410000
         $SER  OBTAIN,                                                 +06420000
               VTAM                                                     06430000
                                                                        06440000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              06450000
         BNE   VTAMLOEX             BRANCH IF NOT                       06460000
         OI    FLAG,FLAGLCKD        REMEMBER LOCK HELD ON ENTRY         06470000
                                                                        06480000
VTAMLOEX DS    0H                                                       06490000
                                                                        06500000
         OI    FLAG,FLAGLOCK        REMEMBER LOCK IS HELD               06510000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          06520000
         BR    R14                  RETURN                              06530000
                                                                        06540000
*---------------------------------------------------------------------- 06550000
*   SUBROUTINE: RELEASE VTAM GLOBAL LOCK                                06560000
*---------------------------------------------------------------------- 06570000
                                                                        06580000
VTAMUNLK DS    0H                                                       06590000
                                                                        06600000
         TM    FLAG,FLAGLOCK        IS LOCK HELD?                       06610000
         BNOR  R14                  BRANCH IF NOT                       06620000
         TM    FLAG,FLAGLCKD        WAS LOCK HELD ON ENTRY?             06630000
         BOR   R14                  DON'T RELEASE IF IT WAS             06640000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             06650000
                                                                        06660000
         $SER  RELEASE,                                                +06670000
               VTAM                                                     06680000
                                                                        06690000
         NI    FLAG,255-FLAGLOCK    SHOW LOCK NOT HELD                  06700000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          06710000
         BR    R14                  RETURN                              06720000
                                                                        06730000
*---------------------------------------------------------------------- 06740000
*   SUBROUTINE: OBTAIN DISP GLOBAL LOCK                                 06750000
*---------------------------------------------------------------------- 06760000
                                                                        06770000
DISPLOCK DS    0H                                                       06780000
                                                                        06790000
         TM    FLAG,FLAGDLCK        WAS THE LOCK ALREADY OBTAINED?      06800000
         BOR   R14                  RETURN IF YES                       06810000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             06820000
                                                                        06830000
         $SER  OBTAIN,                                                 +06840000
               DISP                                                     06850000
                                                                        06860000
         C     R15,=F'4'            WAS LOCK ALREADY HELD?              06870000
         BNE   DISPLOEX             BRANCH IF NOT                       06880000
         OI    FLAG,FLAGDLKD        REMEMBER LOCK HELD ON ENTRY         06890000
                                                                        06900000
DISPLOEX DS    0H                                                       06910000
                                                                        06920000
         OI    FLAG,FLAGDLCK        REMEMBER LOCK IS HELD               06930000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          06940000
         BR    R14                  RETURN                              06950000
                                                                        06960000
*---------------------------------------------------------------------- 06970000
*   SUBROUTINE: RELEASE DISP GLOBAL LOCK                                06980000
*---------------------------------------------------------------------- 06990000
                                                                        07000000
DISPUNLK DS    0H                                                       07010000
                                                                        07020000
         TM    FLAG,FLAGDLCK        IS LOCK HELD?                       07030000
         BNOR  R14                  BRANCH IF NOT                       07040000
         TM    FLAG,FLAGDLKD        WAS LOCK HELD ON ENTRY?             07050000
         BOR   R14                  DON'T RELEASE IF IT WAS             07060000
         STM   R14,R2,SUB0SAVE      SAVE CALLER'S REGISTERS             07070000
                                                                        07080000
         $SER  RELEASE,                                                +07090000
               DISP                                                     07100000
                                                                        07110000
         NI    FLAG,255-FLAGDLCK    SHOW LOCK NOT HELD                  07120000
         LM    R14,R2,SUB0SAVE      RESTORE CALLER'S REGISTERS          07130000
         BR    R14                  RETURN                              07140000
                                                                        07150000
*---------------------------------------------------------------------- 07160000
* ERROR ROUTINES                                                        07170000
*---------------------------------------------------------------------- 07180000
                                                                        07190000
ERR$TASK DS    0H                                                       07200000
                                                                        07210000
         $ABEND ABE_VTDIAG,                                            +07220000
               SCOPE=PCB,                                              +07230000
               TITLE='$TASK FAILURE'                                    07240000
                                                                        07250000
ERR$VTAM DS    0H                                                       07260000
                                                                        07270000
         $ABEND ABE_VTDIAG,                                            +07280000
               SCOPE=PCB,                                              +07290000
               TITLE='$VTAM FAILURE'                                    07300000
                                                                        07310000
ERRWORK  DS    0H                                                       07320000
                                                                        07330000
         $ABEND ABE_VTDIAG,                                            +07340000
               SCOPE=PCB,                                              +07350000
               TITLE='UNKNOWN WORK ELEMENT'                             07360000
                                                                        07370000
*---------------------------------------------------------------------- 07380000
*  CONSTANTS AND LITERALS                                               07390000
*---------------------------------------------------------------------- 07400000
                                                                        07410000
         LTORG ,                                                        07420000
         PRINT NOGEN                                                    07430000
         IHAPSA ,                 MVS PREFIXED SAVE AREA                07440000
         ISTDBIND ,               VTAM BIND IMAGE                       07450000
         TRACODES ,               INTEGRATOR TRACE CODE EQUATES         07460000
         ICVT  ,                  INTEGRATOR CVT                        07470000
         IVTAMCVT ,               INTEGRATOR VTAM CVT                   07480000
         IRPL ,                   INTEGRATOR VTAM RPL+                  07490000
         IACB ,                   INTEGRATOR VTAM ACB+                  07500000
         INIB ,                   INTEGRATOR VTAM NIB+                  07510000
         ISESS ,                  INTEGRATOR SESSION BLOCK              07520000
         ISQE ,                   INTEGRATOR SESS INIT QUEUE ELEMENT    07530000
         IVUSER ,                 INTEGRATOR VTAM USER BLOCK            07540000
         ITASK ,                  INTEGRATOR TASK BLOCK                 07550000
         IWEVTAM ,                INTEGRATOR VTAM WORK ELEMENT          07560000
         TMSG  ,                  INTEGRATOR INTERTASK MSG FORMAT       07570000
         EVCODES ,                INTEGRATOR EVENT CODES                07580000
         ABCODES ,                INTEGRATOR $ABEND CODES               07590000
         MSGCODES ,               INTEGRATOR INTERTASK MSGING CODES     07600000
         @EPB ,                   INTEGRATOR EVENT PROCESS BLOCK        07610000
         $TASK DSECT=YES          INTEGRATOR $TASK SERVICES             07620000
         $PROC DSECT=YES          INTEGRATOR $PROC SERVICES             07630000
         $VTAM DSECT=YES          INTEGRATOR $VTAM SERVICES             07640000
         $SESS DSECT=YES          INTEGRATOR $SESS SERVICES             07650000
         $RESMGR DSECT=YES        INTEGRATOR $RESMGR SERVICES           07660000
         $WULOC DSECT=YES         INTEGRATOR $WULOC SERVICES            07670000
         IFGEXLST ,               VTAM EXIT LIST                        07680000
         END   ,                                                        07690000

ISRVSUSP TITLE '- Suspend ITASK / Call Server Dispatcher'               00010000
**<DOC-ON>******************************************************        00020000
*                                                                       00030000
* ROUTINE: ISRVSUSP - Suspend ITASK / Call Server Dispatcher            00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine is entered from the task manager dispatch             00080000
*    facility for ITASK running under a server ITASK.  $SERVER          00090000
*    SUSPEND will save the current environment (registers) for          00100000
*    the current ITASK to enable the ITASK to resume at the             00110000
*    instruction following the SUSPEND when the task is                 00120000
*    redispatched.  The routine will set up the task restart            00130000
*    routine address and call the server dispatcher.  The               00140000
*    server dispatcher will not return code via standard return         00150000
*    logic.                                                             00160000
*                                                                       00170000
*                                                                       00180000
* ON ENTRY:                                                             00190000
*                                                                       00200000
*    R1 Contains the address of the parameter list mapped by            00210000
*    the SRVPL dsect generated by $SERVER DSECT=YES.                    00220000
*                                                                       00230000
* ON EXIT:                                                              00240000
*                                                                       00250000
*    Control is relinguished to the Task Server Dispatcher              00260000
*                                                                       00270000
* MODE:                                                                 00280000
*                                                                       00290000
*    TASK                                                               00300000
*    APF/NON-APF                                                        00310000
*    SUP/PROB                                                           00320000
*    AMODE 31, RMODE ANY                                                00330000
*                                                                       00340000
**<DOC-OFF>*****************************************************        00350000
                                                                        00360000
         EJECT ,                                                        00370000
****************************************************************        00380000
*                                                                       00390000
* MAINTENANCE:                                                          00400000
*                                                                       00410000
*   01/21/95 Ron Colmone          Par# 159456                           00420000
*            Initial Version                                            00430000
*                                                                       00440000
****************************************************************        00450000
                                                                        00460000
         EJECT ,                                                        00470000
         $SERVER DSECT=YES        TASKMGR SERVER PLIST                  00480000
                                                                        00490000
         EJECT ,                                                        00500000
         EQUS  ,                  GENERAL EQUATES                       00510000
*                                                                       00520000
         TRACODES ,               TRACE CODES                           00530000
                                                                        00540000
         EJECT ,                                                        00550000
         #WORK LENGTH=512                                               00560000
WRKPASS  DS    0D                 WORKAREA TO PASS                      00570000
         #ENDWORK                                                       00580000
                                                                        00590000
         EJECT ,                                                        00600000
ISRVSUSP #ENTER BASE=(R12),       ENTRY LINKAGE                        +00610000
               PREG=R8,                                                +00620000
               WAPASS=YES                                               00630000
                                                                        00640000
         USING SRVPL,R8           ESTABLISH ADDRESSABILITY              00650000
         USING ITASK,R10          ESTABLISH ADDRESSABILITY              00660000
                                                                        00670000
*---------------------------------------------------------------        00680000
*  Allocate save area to retain caller's suspend registers              00690000
*---------------------------------------------------------------        00700000
         $GETSTOR 16*4,OWNER=ITASK                                      00710000
         LR    R3,R1              SAVEAREA ADDRESS                      00720000
         ST    R3,TSKSUSPR        SAVE ADDRESS OF SUSPEND REGS          00730000
                                                                        00740000
         L     R1,4(,R13)         ADDR OF ISRVSERV SAVE AREA            00750000
         L     R1,4(,R1)          ADDR OF CALLER'S SAVE AREA            00760000
         ST    R1,(13*4)(,R3)          COPY R13                         00770000
         MVC   (14*4)((4*2),R3),12(R1) COPY R14-R15                     00780000
         MVC   0((13*4),R3),20(R1)     COPY R0-R12                      00790000
                                                                        00800000
*---------------------------------------------------------------        00810000
*  Set task restart address to resume                                   00820000
*---------------------------------------------------------------        00830000
         L     R0,=V(ISRVTRES)    RESTART TASK ENTRY USING RESUME       00840000
         ST    R0,TSKRSRTN        ADDRESS OF TASK RESTART ROUTINE       00850000
                                                                        00860000
*---------------------------------------------------------------        00870000
*  Cut trace record for ITASK issuing suspend                           00880000
*---------------------------------------------------------------        00890000
         $TRACE TRC_DISPSVSUSP,8  ALLOC TRACE ENTRY                     00900000
         BNZ   NO_TRACE           TRACE NOT ACTIVE                      00910000
         MVC   0(4,R1),(14*4)(R2) COPY RETURN ADDRESS                   00920000
NO_TRACE DS    0H                                                       00930000
                                                                        00940000
*---------------------------------------------------------------        00950000
*  Enter Server CALLDSP service to swap ITASKs. (No return)             00960000
*---------------------------------------------------------------        00970000
         @CALL ISRVDISP,WKA=WRKPASS  Call server dispatcher             00980000
                                                                        00990000
         EJECT ,                                                        01000000
****************************************************************        01010000
*                                                                       01020000
*  CONSTANTS AND LITERALS                                               01030000
*                                                                       01040000
****************************************************************        01050000
                                                                        01060000
         LTORG ,                                                        01070000
                                                                        01080000
         PRINT NOGEN                                                    01090000
         ICVT  ,                                                        01100000
         ITASK ,                                                        01110000
                                                                        01120000
         END   ,                                                        01130000

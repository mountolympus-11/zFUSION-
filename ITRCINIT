ITRCINIT TITLE '- CONSTRUCT TRACE TABLE'                                00010000
**<DOC-ON>*****************************************************         00020000
*                                                                       00030000
* ROUTINE: ITRCINIT - Construct trace table                             00040000
*                                                                       00050000
* DESCRIPTION:                                                          00060000
*                                                                       00070000
*    This routine constructs the trace table header, a trace            00080000
*    table definition for each of n trace tables, and allocates         00090000
*    the storage for each trace table.  The trace table header          00100000
*    is anchored in ICVT.ICTRTPTR.  Additionally, a 32 byte             00110000
*    trace event class bit mask (ECM) is acquired from global           00120000
*    (ICVT) storage and anchored in ICVT.ICTRTECM.  Each bit            00130000
*    corresponds to one of the 0-255 trace event classes                00140000
*    defined in TRACODES.  ITRCDFLT is called to enable                 00150000
*    selected trace event classes by default.                           00160000
*                                                                       00170000
*                                                                       00180000
* ON ENTRY:                                                             00190000
*                                                                       00200000
*    R1 - number of trace tables to maintain                            00210000
*                                                                       00220000
*    ICVT.ICTRTBSZ contains the size of each trace table                00230000
*    expressed in Kbytes                                                00240000
*                                                                       00250000
*                                                                       00260000
* ON EXIT:                                                              00270000
*                                                                       00280000
*    N/A                                                                00290000
*                                                                       00300000
**<DOC-OFF>****************************************************         00310000
*                                                                       00320000
         EJECT                                                          00330000
***************************************************************         00340000
*                                                                       00350000
* MAINTENANCE:                                                          00360000
*                                                                       00370000
*    11/28/95 R. Turgeon                                                00380000
*             Initial system trace defaults via ITRCDFLT                00390000
*                                                                       00400000
***************************************************************         00410000
                                                                        00420000
         EJECT                                                          00430000
         #WORK ,                                                        00440000
         #ENDWORK ,                                                     00450000
                                                                        00460000
         EJECT                                                          00470000
         TRTABLE ,                TRACE TABLE MAPPINGS                  00480000
                                                                        00490000
         EJECT                                                          00500000
         EQUS  ,                                                        00510000
                                                                        00520000
         EJECT                                                          00530000
ITRCINIT #ENTER PREG=R8                                                 00540000
                                                                        00550000
         USING ITASK,R10                                                00560000
                                                                        00570000
         EJECT                                                          00580000
***************************************************************         00590000
*                                                                       00600000
*   Acquire and initialize the global trace event mask                  00610000
*                                                                       00620000
***************************************************************         00630000
                                                                        00640000
         STGGET 32,QH=ICTSTG      ACQUIRE LONG TERM, GLOBAL STORAGE     00650000
         BZ    *+8                SUCCESS                               00660000
         EX    R0,*               ASSERT STORAGE AVAILABILITY           00670000
                                                                        00680000
         ST    R1,ICTRTECM        ESTABLISH GLOBAL TRACE EVENT REF      00690000
                                                                        00700000
         @CALL ITRCDFLT,CTYPE=CVT SET SYSTEM TRACE DEFAULTS             00710000
                                                                        00720000
***************************************************************         00730000
*                                                                       00740000
*   Trace table size specified in kbytes                                00750000
*                                                                       00760000
***************************************************************         00770000
                                                                        00780000
         LTR   R8,R8              # OF TRACE TABLES                     00790000
         BNZ   *+8                PROVIDED                              00800000
         LA    R8,1               ELSE A SINGLE TABLE                   00810000
         C     R8,=A(TRTH$MAX)    MAXIMUM EXCEEDED?                     00820000
         BNH   *+8                SKIP IF NOT                           00830000
         LA    R8,TRTH$MAX        ELSE DROP SURPLUS                     00840000
                                                                        00850000
         ICM   R9,15,ICTRTBSZ     DESIRED SIZE OF EACH TABLE            00860000
         BZ    RETURN             DONE IF DISABLED                      00870000
         C     R9,=F'1024'        REASONABLE MAX                        00880000
         BNH   *+8                SKIP IF ACCEPTABLE                    00890000
         LA    R9,1024            ESTABLISH MAX                         00900000
         SLL   R9,10              CONVERT TO KBYTES                     00910000
                                                                        00920000
*--------------------------------------------------------------         00930000
*   Acquire table header and descriptor array                           00940000
*--------------------------------------------------------------         00950000
                                                                        00960000
         LA    R5,TRTBDEFL        LENGTH OF SINGLE TABLE DESCRIPTOR     00970000
         MR    R4,R8              ONE PER TABLE                         00980000
         LA    R5,TRTHLN(,R5)     PLUS LENGTH OF HEADER                 00990000
                                                                        01000000
         $GETSTOR (R5)                                                  01010000
                                                                        01020000
         LR    R7,R1              ACQUIRED STORAGE                      01030000
         USING TRTHDR,R7          PREPARE FOR INIT                      01040000
         XC    TRTHDR(TRTHLN),TRTHDR                                    01050000
         MVC   TRTHEYE(L'TRTHEYE),=CL8'TRACEHDR'                        01060000
         ST    R5,TRTHTSIZ        TOTAL SIZE OF HDR & DEF ARRAY         01070000
         ST    R8,TRTHNTAB        NUMBER OF TABLES                      01080000
         LA    R0,TRTHVECT        ACTIVE TABLE WILL BE FIRST TABLE      01090000
         ST    R0,TRTHCP                                                01100000
         LA    R1,TRENUNIT        ENTRY ALLOCATION UNIT SIZE            01110000
         ST    R1,TRTHUNIT                                              01120000
                                                                        01130000
*--------------------------------------------------------------         01140000
*   Acquire tables and initialize descriptor array                      01150000
*--------------------------------------------------------------         01160000
                                                                        01170000
         LA    R6,TRTHVECT        TABLE DEFINITION PTR ARRAY            01180000
         LA    R5,TRTHDR+TRTHLN   FIRST ENTRY                           01190000
         USING TRTBDEF,R5         PREPARE FOR FORMATTING                01200000
                                                                        01210000
VECINIT  DS    0H                                                       01220000
         XC    TRTBDEF(TRTBDEFL),TRTBDEF                                01230000
         MVC   TRTBEYE(L'TRTBEYE),=CL8'TRACEDEF'                        01240000
                                                                        01250000
         $GETSTOR (R9)                                                  01260000
                                                                        01270000
         ST    R1,TRTBORG         TABLE ORIGIN                          01280000
         ST    R1,TRTBCURR        CURRENT POSITION IS ORIGIN            01290000
         ST    R9,TRTBSIZE        TABLE SIZE (BYTES)                    01300000
         LA    R0,0(R9,R1)        END OF EXTENT                         01310000
         ST    R0,TRTBEND                                               01320000
         ST    R5,0(,R6)          PTR VECTOR ENTRY                      01330000
                                                                        01340000
         LA    R6,4(,R6)          NEXT VECTOR PTR ENTRY                 01350000
         LA    R5,TRTBDEFL(,R5)   ADVANCE TO NEXT DEFINITION            01360000
         BCT   R8,VECINIT         ONCE FOR EACH TABLE                   01370000
         ST    R7,ICTRTPTR        TRACE TABLES READY                    01380000
         DROP  R5                 TRTBDEF                               01390000
                                                                        01400000
*--------------------------------------------------------------         01410000
*   Return to caller                                                    01420000
*--------------------------------------------------------------         01430000
                                                                        01440000
RETURN   DS    0H                                                       01450000
         LA    R15,RC00           COMPLETE                              01460000
         #EXIT ,                  RETURN                                01470000
                                                                        01480000
         EJECT                                                          01490000
***************************************************************         01500000
*                                                                       01510000
*   Local read only working storage                                     01520000
*                                                                       01530000
***************************************************************         01540000
                                                                        01550000
         LTORG ,                                                        01560000
                                                                        01570000
         PRINT NOGEN                                                    01580000
         ICVT  ,                                                        01590000
         ITASK ,                                                        01600000
         END   ,                                                        01610000
